<!DOCTYPE html>
<html>
  <head>
    <title>Plist HTML Viewer</title>

    <meta charset="UTF-8">

    <style type="text/css">
      .CodeMirror{font-family:monospace;height:300px;color:#000;direction:ltr}.CodeMirror-lines{padding:4px 0}.CodeMirror pre{padding:0 4px}.CodeMirror-gutter-filler,.CodeMirror-scrollbar-filler{background-color:#fff}.CodeMirror-gutters{border-right:1px solid #ddd;background-color:#f7f7f7;white-space:nowrap}.CodeMirror-linenumber{padding:0 3px 0 5px;min-width:20px;text-align:right;color:#999;white-space:nowrap}.CodeMirror-guttermarker{color:#000}.CodeMirror-guttermarker-subtle{color:#999}.CodeMirror-cursor{border-left:1px solid #000;border-right:none;width:0}.CodeMirror div.CodeMirror-secondarycursor{border-left:1px solid silver}.cm-fat-cursor .CodeMirror-cursor{width:auto;border:0!important;background:#7e7}.cm-fat-cursor div.CodeMirror-cursors{z-index:1}.cm-animate-fat-cursor{width:auto;border:0;-webkit-animation:blink 1.06s steps(1) infinite;-moz-animation:blink 1.06s steps(1) infinite;animation:blink 1.06s steps(1) infinite;background-color:#7e7}@-moz-keyframes blink{50%{background-color:transparent}}@-webkit-keyframes blink{50%{background-color:transparent}}@keyframes blink{50%{background-color:transparent}}.cm-tab{display:inline-block;text-decoration:inherit}.CodeMirror-rulers{position:absolute;left:0;right:0;top:-50px;bottom:-20px;overflow:hidden}.CodeMirror-ruler{border-left:1px solid #ccc;top:0;bottom:0;position:absolute}.cm-s-default .cm-header{color:#00f}.cm-s-default .cm-quote{color:#090}.cm-negative{color:#d44}.cm-positive{color:#292}.cm-header,.cm-strong{font-weight:700}.cm-em{font-style:italic}.cm-link{text-decoration:underline}.cm-strikethrough{text-decoration:line-through}.cm-s-default .cm-keyword{color:#708}.cm-s-default .cm-atom{color:#219}.cm-s-default .cm-number{color:#164}.cm-s-default .cm-def{color:#00f}.cm-s-default .cm-variable-2{color:#05a}.cm-s-default .cm-type,.cm-s-default .cm-variable-3{color:#085}.cm-s-default .cm-comment{color:#a50}.cm-s-default .cm-string{color:#a11}.cm-s-default .cm-string-2{color:#f50}.cm-s-default .cm-meta{color:#555}.cm-s-default .cm-qualifier{color:#555}.cm-s-default .cm-builtin{color:#30a}.cm-s-default .cm-bracket{color:#997}.cm-s-default .cm-tag{color:#170}.cm-s-default .cm-attribute{color:#00c}.cm-s-default .cm-hr{color:#999}.cm-s-default .cm-link{color:#00c}.cm-s-default .cm-error{color:red}.cm-invalidchar{color:red}.CodeMirror-composing{border-bottom:2px solid}div.CodeMirror span.CodeMirror-matchingbracket{color:#0f0}div.CodeMirror span.CodeMirror-nonmatchingbracket{color:#f22}.CodeMirror-matchingtag{background:rgba(255,150,0,.3)}.CodeMirror-activeline-background{background:#e8f2ff}.CodeMirror{position:relative;overflow:hidden;background:#fff}.CodeMirror-scroll{overflow:scroll!important;margin-bottom:-30px;margin-right:-30px;padding-bottom:30px;height:100%;outline:0;position:relative}.CodeMirror-sizer{position:relative;border-right:30px solid transparent}.CodeMirror-gutter-filler,.CodeMirror-hscrollbar,.CodeMirror-scrollbar-filler,.CodeMirror-vscrollbar{position:absolute;z-index:6;display:none}.CodeMirror-vscrollbar{right:0;top:0;overflow-x:hidden;overflow-y:scroll}.CodeMirror-hscrollbar{bottom:0;left:0;overflow-y:hidden;overflow-x:scroll}.CodeMirror-scrollbar-filler{right:0;bottom:0}.CodeMirror-gutter-filler{left:0;bottom:0}.CodeMirror-gutters{position:absolute;left:0;top:0;min-height:100%;z-index:3}.CodeMirror-gutter{white-space:normal;height:100%;display:inline-block;vertical-align:top;margin-bottom:-30px}.CodeMirror-gutter-wrapper{position:absolute;z-index:4;background:0 0!important;border:none!important}.CodeMirror-gutter-background{position:absolute;top:0;bottom:0;z-index:4}.CodeMirror-gutter-elt{position:absolute;cursor:default;z-index:4}.CodeMirror-gutter-wrapper ::selection{background-color:transparent}.CodeMirror-gutter-wrapper ::-moz-selection{background-color:transparent}.CodeMirror-lines{cursor:text;min-height:1px}.CodeMirror pre{-moz-border-radius:0;-webkit-border-radius:0;border-radius:0;border-width:0;background:0 0;font-family:inherit;font-size:inherit;margin:0;white-space:pre;word-wrap:normal;line-height:inherit;color:inherit;z-index:2;position:relative;overflow:visible;-webkit-tap-highlight-color:transparent;-webkit-font-variant-ligatures:contextual;font-variant-ligatures:contextual}.CodeMirror-wrap pre{word-wrap:break-word;white-space:pre-wrap;word-break:normal}.CodeMirror-linebackground{position:absolute;left:0;right:0;top:0;bottom:0;z-index:0}.CodeMirror-linewidget{position:relative;z-index:2;overflow:auto}.CodeMirror-rtl pre{direction:rtl}.CodeMirror-code{outline:0}.CodeMirror-gutter,.CodeMirror-gutters,.CodeMirror-linenumber,.CodeMirror-scroll,.CodeMirror-sizer{-moz-box-sizing:content-box;box-sizing:content-box}.CodeMirror-measure{position:absolute;width:100%;height:0;overflow:hidden;visibility:hidden}.CodeMirror-cursor{position:absolute;pointer-events:none}.CodeMirror-measure pre{position:static}div.CodeMirror-cursors{visibility:hidden;position:relative;z-index:3}div.CodeMirror-dragcursors{visibility:visible}.CodeMirror-focused div.CodeMirror-cursors{visibility:visible}.CodeMirror-selected{background:#d9d9d9}.CodeMirror-focused .CodeMirror-selected{background:#d7d4f0}.CodeMirror-crosshair{cursor:crosshair}.CodeMirror-line::selection,.CodeMirror-line>span::selection,.CodeMirror-line>span>span::selection{background:#d7d4f0}.CodeMirror-line::-moz-selection,.CodeMirror-line>span::-moz-selection,.CodeMirror-line>span>span::-moz-selection{background:#d7d4f0}.cm-searching{background-color:#ffa;background-color:rgba(255,255,0,.4)}.cm-force-border{padding-right:.1px}@media print{.CodeMirror div.CodeMirror-cursors{visibility:hidden}}.cm-tab-wrap-hack:after{content:''}span.CodeMirror-selectedtext{background:0 0}
/*# sourceMappingURL=codemirror.min.css.map */

      .severity-low {
  background-color: #669603;
}

.severity-low:after {
  content : 'L';
}

.severity-unspecified {
  background-color: #666666;
}

.severity-unspecified:after {
  content : 'U';
}

.severity-style {
  background-color: #9932cc;
}

.severity-style:after {
  content : 'S';
}

.severity-medium {
  background-color: #a9d323;
  color: black;
}

.severity-medium:after {
  content : 'M';
}

.severity-high {
  background-color: #ffa800;
}

.severity-high:after {
  content : 'H';
}

.severity-critical {
  background-color: #e92625;
}

.severity-critical:after {
  content : 'C';
}

i[class*="severity-"] {
  line-height: normal;
  text-transform: capitalize;
  font-size: 0.8em;
  font-weight: bold;
  color: white;
  display: inline-block;
  width: 16px;
  height: 16px;
  text-align: center;
  font-family: sans-serif;
}

      html, body {
  width: 100%;
  height: 100%;
  padding: 0px;
  margin: 0px;
}

div.container {
  padding: 10px;
}

#content {
  height: 100%;
  display: block;
  overflow: hidden;
}

#content > div {
  margin: 10px;
  overflow: hidden;
  border: 1px solid #ddd;
  border-radius: 3px;
  overflow: hidden;
  height: 97%;
}

.button {
  background-color: #f1f1f1;
  text-decoration: none;
  display: inline-block;
  padding: 8px 16px;
  color: black;
  cursor: pointer;
}

.button:hover {
  background-color: #ddd;
  color: black;
}

.review-status {
  color: white;
  text-align: center;
}

.review-status-confirmed {
  background-color: #e92625;
}

.review-status-false-positive {
  background-color: grey;
}

.review-status-intentional {
  background-color: #669603;
}

      div.container {
  width: 100%;
  height: 100%;
  padding: 0px;
}

#editor-wrapper {
  margin: 10px;
}

#side-bar {
  float: left;
  width: 260px;
  margin: 0px;
}

#report-nav ul {
  list-style-type: none;
  padding: 0;
  margin: 0;
  overflow-y: auto;
  height: 100%;
}

#report-nav ul > li {
  padding: .4em;
  background-color: #fff;
  border-bottom: 1px solid rgba(0,0,0,.125);
  text-align: left;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

#report-nav ul > li.active {
  background-color: #427ea9;
  color: white;
}

#report-nav ul > li:hover {
  background-color: #427ea9;
  color: white;
  cursor: pointer;
}

#report-nav ul a {
  text-decoration: none;
}

#report-nav i[class*="severity-"] {
  margin-right: 5px;
}

.header {
  border-bottom: 1px solid lightgrey;
  font-family: monospace;
  padding: 10px;
  background-color: #fafbfc;
  border-bottom: 1px solid #e1e4e8;
  border-top-left-radius: 2px;
  border-top-right-radius: 2px;
}

#report-nav .header {
  font-weight: bold;
}

#editor-wrapper .header > div {
  padding-top: 2px;
}

#file-path,
#checker-name {
  color: #195ea2;
}

#review-status {
  padding: 0px 5px;
}

#file-path {
  font-family: monospace;
}

.check-msg {
  display: inline-block;
  padding: 3px 6px;
  margin: 1px;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
  border-radius: 5px;
}

.check-msg.info {
  color: #00546f;
  background-color: #bfdfe9;
  border: 1px solid #87a8b3;
}

.check-msg.error {
  background-color: #f2dede;
  color: #a94442;
  border: 1px solid #ebcccc;
}

.check-msg.macro {
  background-color: #d7dac2;
  color: #4f5c6d;
  border: 1px solid #d7dac2;
}

.check-msg.note {
  background-color: #d7d7d7;
  color: #4f5c6d;
  border: 1px solid #bfbfbf;
}

.check-msg.current {
  border: 2px dashed #3692ff;
}

.check-msg .tag {
  padding: 1px 5px;
  text-align: center;
  border-radius: 2px;
  margin-right: 5px;
  text-decoration: inherit;
}

.check-msg .tag.macro {
  background-color: #83876a;
  color: white;
  text-transform: capitalize;
}

.check-msg .tag.note {
  background-color: #9299a1;
  color: white;
  text-transform: capitalize;
}

.checker-enum {
  color: white;
  padding: 1px 5px;
  text-align: center;
  border-radius: 25px;
  margin-right: 5px;
  text-decoration: inherit;
}

.checker-enum.info {
  background-color: #427ea9;
}

.checker-enum.error {
  background-color: #a94442;
}

.arrow {
  border: solid black;
  border-width: 0 3px 3px 0;
  display: inline-block;
  padding: 3px;
  cursor: pointer;
  margin: 0px 5px;
}

.arrow:hover {
  border: solid #437ea8;
  border-width: 0 3px 3px 0;
}

.left-arrow {
  transform: rotate(135deg);
  -webkit-transform: rotate(135deg);
}

.right-arrow {
  transform: rotate(-45deg);
  -webkit-transform: rotate(-45deg);
}

    </style>

    <script type="text/javascript">
      function setNonCompatibleBrowserMessage() {
  document.body.innerHTML =
    '<h2 style="margin-left: 20px;">Your browser is not compatible with CodeChecker Viewer!</h2> \
     <p style="margin-left: 20px;">The version required for the following browsers are:</p> \
     <ul style="margin-left: 20px;"> \
     <li>Internet Explorer: version 9 or newer</li> \
     <li>Firefox: version 22.0 or newer</li> \
     </ul>';
}

// http://stackoverflow.com/questions/5916900/how-can-you-detect-the-version-of-a-browser
var browserVersion = (function(){
  var ua = navigator.userAgent, tem,
    M = ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];

  if (/trident/i.test(M[1])) {
    tem = /\brv[ :]+(\d+)/g.exec(ua) || [];
    return 'IE ' + (tem[1] || '');
  }

  if (M[1] === 'Chrome') {
    tem = ua.match(/\b(OPR|Edge)\/(\d+)/);
    if (tem != null) return tem.slice(1).join(' ').replace('OPR', 'Opera');
  }

  M = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, '-?'];
  if ((tem = ua.match(/version\/(\d+)/i)) != null) M.splice(1, 1, tem[1]);
    return M.join(' ');
})();

var pos = browserVersion.indexOf(' ');
var browser = browserVersion.substr(0, pos);
var version = parseInt(browserVersion.substr(pos + 1));

var browserCompatible
  = browser === 'Firefox'
  ? version >= 22
  : browser === 'IE'
  ? version >= 9
  : true;


      /* MIT License

Copyright (C) 2017 by Marijn Haverbeke <marijnh@gmail.com> and others

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
 */
      !function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.CodeMirror=t()}(this,function(){"use strict";function e(e){return new RegExp("(^|\\s)"+e+"(?:$|\\s)\\s*")}function t(e){for(var t=e.childNodes.length;t>0;--t)e.removeChild(e.firstChild);return e}function r(e,r){return t(e).appendChild(r)}function n(e,t,r,n){var i=document.createElement(e);if(r&&(i.className=r),n&&(i.style.cssText=n),"string"==typeof t)i.appendChild(document.createTextNode(t));else if(t)for(var o=0;o<t.length;++o)i.appendChild(t[o]);return i}function i(e,t,r,i){var o=n(e,t,r,i);return o.setAttribute("role","presentation"),o}function o(e,t){if(3==t.nodeType&&(t=t.parentNode),e.contains)return e.contains(t);do{if(11==t.nodeType&&(t=t.host),t==e)return!0}while(t=t.parentNode)}function l(){var e;try{e=document.activeElement}catch(t){e=document.body||null}for(;e&&e.shadowRoot&&e.shadowRoot.activeElement;)e=e.shadowRoot.activeElement;return e}function s(t,r){var n=t.className;e(r).test(n)||(t.className+=(n?" ":"")+r)}function a(t,r){for(var n=t.split(" "),i=0;i<n.length;i++)n[i]&&!e(n[i]).test(r)&&(r+=" "+n[i]);return r}function u(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t)}}function c(e,t,r){t||(t={});for(var n in e)!e.hasOwnProperty(n)||!1===r&&t.hasOwnProperty(n)||(t[n]=e[n]);return t}function f(e,t,r,n,i){null==t&&-1==(t=e.search(/[^\s\u00a0]/))&&(t=e.length);for(var o=n||0,l=i||0;;){var s=e.indexOf("\t",o);if(s<0||s>=t)return l+(t-o);l+=s-o,l+=r-l%r,o=s+1}}function h(e,t){for(var r=0;r<e.length;++r)if(e[r]==t)return r;return-1}function d(e,t,r){for(var n=0,i=0;;){var o=e.indexOf("\t",n);-1==o&&(o=e.length);var l=o-n;if(o==e.length||i+l>=t)return n+Math.min(l,t-i);if(i+=o-n,i+=r-i%r,n=o+1,i>=t)return n}}function p(e){for(;Kl.length<=e;)Kl.push(g(Kl)+" ");return Kl[e]}function g(e){return e[e.length-1]}function v(e,t){for(var r=[],n=0;n<e.length;n++)r[n]=t(e[n],n);return r}function m(e,t,r){for(var n=0,i=r(t);n<e.length&&r(e[n])<=i;)n++;e.splice(n,0,t)}function y(){}function b(e,t){var r;return Object.create?r=Object.create(e):(y.prototype=e,r=new y),t&&c(t,r),r}function w(e){return/\w/.test(e)||e>""&&(e.toUpperCase()!=e.toLowerCase()||jl.test(e))}function x(e,t){return t?!!(t.source.indexOf("\\w")>-1&&w(e))||t.test(e):w(e)}function C(e){for(var t in e)if(e.hasOwnProperty(t)&&e[t])return!1;return!0}function S(e){return e.charCodeAt(0)>=768&&Xl.test(e)}function L(e,t,r){for(;(r<0?t>0:t<e.length)&&S(e.charAt(t));)t+=r;return t}function k(e,t,r){for(var n=t>r?-1:1;;){if(t==r)return t;var i=(t+r)/2,o=n<0?Math.ceil(i):Math.floor(i);if(o==t)return e(o)?t:r;e(o)?r=o:t=o+n}}function T(e,t,r){var o=this;this.input=r,o.scrollbarFiller=n("div",null,"CodeMirror-scrollbar-filler"),o.scrollbarFiller.setAttribute("cm-not-content","true"),o.gutterFiller=n("div",null,"CodeMirror-gutter-filler"),o.gutterFiller.setAttribute("cm-not-content","true"),o.lineDiv=i("div",null,"CodeMirror-code"),o.selectionDiv=n("div",null,null,"position: relative; z-index: 1"),o.cursorDiv=n("div",null,"CodeMirror-cursors"),o.measure=n("div",null,"CodeMirror-measure"),o.lineMeasure=n("div",null,"CodeMirror-measure"),o.lineSpace=i("div",[o.measure,o.lineMeasure,o.selectionDiv,o.cursorDiv,o.lineDiv],null,"position: relative; outline: none");var l=i("div",[o.lineSpace],"CodeMirror-lines");o.mover=n("div",[l],null,"position: relative"),o.sizer=n("div",[o.mover],"CodeMirror-sizer"),o.sizerWidth=null,o.heightForcer=n("div",null,null,"position: absolute; height: "+Rl+"px; width: 1px;"),o.gutters=n("div",null,"CodeMirror-gutters"),o.lineGutter=null,o.scroller=n("div",[o.sizer,o.heightForcer,o.gutters],"CodeMirror-scroll"),o.scroller.setAttribute("tabIndex","-1"),o.wrapper=n("div",[o.scrollbarFiller,o.gutterFiller,o.scroller],"CodeMirror"),gl&&vl<8&&(o.gutters.style.zIndex=-1,o.scroller.style.paddingRight=0),ml||fl&&Tl||(o.scroller.draggable=!0),e&&(e.appendChild?e.appendChild(o.wrapper):e(o.wrapper)),o.viewFrom=o.viewTo=t.first,o.reportedViewFrom=o.reportedViewTo=t.first,o.view=[],o.renderedView=null,o.externalMeasured=null,o.viewOffset=0,o.lastWrapHeight=o.lastWrapWidth=0,o.updateLineNumbers=null,o.nativeBarWidth=o.barHeight=o.barWidth=0,o.scrollbarsClipped=!1,o.lineNumWidth=o.lineNumInnerWidth=o.lineNumChars=null,o.alignWidgets=!1,o.cachedCharWidth=o.cachedTextHeight=o.cachedPaddingH=null,o.maxLine=null,o.maxLineLength=0,o.maxLineChanged=!1,o.wheelDX=o.wheelDY=o.wheelStartX=o.wheelStartY=null,o.shift=!1,o.selForContextMenu=null,o.activeTouch=null,r.init(o)}function M(e,t){if((t-=e.first)<0||t>=e.size)throw new Error("There is no line "+(t+e.first)+" in the document.");for(var r=e;!r.lines;)for(var n=0;;++n){var i=r.children[n],o=i.chunkSize();if(t<o){r=i;break}t-=o}return r.lines[t]}function N(e,t,r){var n=[],i=t.line;return e.iter(t.line,r.line+1,function(e){var o=e.text;i==r.line&&(o=o.slice(0,r.ch)),i==t.line&&(o=o.slice(t.ch)),n.push(o),++i}),n}function O(e,t,r){var n=[];return e.iter(t,r,function(e){n.push(e.text)}),n}function A(e,t){var r=t-e.height;if(r)for(var n=e;n;n=n.parent)n.height+=r}function W(e){if(null==e.parent)return null;for(var t=e.parent,r=h(t.lines,e),n=t.parent;n;t=n,n=n.parent)for(var i=0;n.children[i]!=t;++i)r+=n.children[i].chunkSize();return r+t.first}function D(e,t){var r=e.first;e:do{for(var n=0;n<e.children.length;++n){var i=e.children[n],o=i.height;if(t<o){e=i;continue e}t-=o,r+=i.chunkSize()}return r}while(!e.lines);for(var l=0;l<e.lines.length;++l){var s=e.lines[l].height;if(t<s)break;t-=s}return r+l}function H(e,t){return t>=e.first&&t<e.first+e.size}function F(e,t){return String(e.lineNumberFormatter(t+e.firstLineNumber))}function E(e,t,r){if(void 0===r&&(r=null),!(this instanceof E))return new E(e,t,r);this.line=e,this.ch=t,this.sticky=r}function P(e,t){return e.line-t.line||e.ch-t.ch}function I(e,t){return e.sticky==t.sticky&&0==P(e,t)}function z(e){return E(e.line,e.ch)}function R(e,t){return P(e,t)<0?t:e}function B(e,t){return P(e,t)<0?e:t}function G(e,t){return Math.max(e.first,Math.min(t,e.first+e.size-1))}function U(e,t){if(t.line<e.first)return E(e.first,0);var r=e.first+e.size-1;return t.line>r?E(r,M(e,r).text.length):V(t,M(e,t.line).text.length)}function V(e,t){var r=e.ch;return null==r||r>t?E(e.line,t):r<0?E(e.line,0):e}function K(e,t){for(var r=[],n=0;n<t.length;n++)r[n]=U(e,t[n]);return r}function j(){Yl=!0}function X(){_l=!0}function Y(e,t,r){this.marker=e,this.from=t,this.to=r}function _(e,t){if(e)for(var r=0;r<e.length;++r){var n=e[r];if(n.marker==t)return n}}function $(e,t){for(var r,n=0;n<e.length;++n)e[n]!=t&&(r||(r=[])).push(e[n]);return r}function q(e,t){e.markedSpans=e.markedSpans?e.markedSpans.concat([t]):[t],t.marker.attachLine(e)}function Z(e,t,r){var n;if(e)for(var i=0;i<e.length;++i){var o=e[i],l=o.marker;if(null==o.from||(l.inclusiveLeft?o.from<=t:o.from<t)||o.from==t&&"bookmark"==l.type&&(!r||!o.marker.insertLeft)){var s=null==o.to||(l.inclusiveRight?o.to>=t:o.to>t);(n||(n=[])).push(new Y(l,o.from,s?null:o.to))}}return n}function Q(e,t,r){var n;if(e)for(var i=0;i<e.length;++i){var o=e[i],l=o.marker;if(null==o.to||(l.inclusiveRight?o.to>=t:o.to>t)||o.from==t&&"bookmark"==l.type&&(!r||o.marker.insertLeft)){var s=null==o.from||(l.inclusiveLeft?o.from<=t:o.from<t);(n||(n=[])).push(new Y(l,s?null:o.from-t,null==o.to?null:o.to-t))}}return n}function J(e,t){if(t.full)return null;var r=H(e,t.from.line)&&M(e,t.from.line).markedSpans,n=H(e,t.to.line)&&M(e,t.to.line).markedSpans;if(!r&&!n)return null;var i=t.from.ch,o=t.to.ch,l=0==P(t.from,t.to),s=Z(r,i,l),a=Q(n,o,l),u=1==t.text.length,c=g(t.text).length+(u?i:0);if(s)for(var f=0;f<s.length;++f){var h=s[f];if(null==h.to){var d=_(a,h.marker);d?u&&(h.to=null==d.to?null:d.to+c):h.to=i}}if(a)for(var p=0;p<a.length;++p){var v=a[p];null!=v.to&&(v.to+=c),null==v.from?_(s,v.marker)||(v.from=c,u&&(s||(s=[])).push(v)):(v.from+=c,u&&(s||(s=[])).push(v))}s&&(s=ee(s)),a&&a!=s&&(a=ee(a));var m=[s];if(!u){var y,b=t.text.length-2;if(b>0&&s)for(var w=0;w<s.length;++w)null==s[w].to&&(y||(y=[])).push(new Y(s[w].marker,null,null));for(var x=0;x<b;++x)m.push(y);m.push(a)}return m}function ee(e){for(var t=0;t<e.length;++t){var r=e[t];null!=r.from&&r.from==r.to&&!1!==r.marker.clearWhenEmpty&&e.splice(t--,1)}return e.length?e:null}function te(e,t,r){var n=null;if(e.iter(t.line,r.line+1,function(e){if(e.markedSpans)for(var t=0;t<e.markedSpans.length;++t){var r=e.markedSpans[t].marker;!r.readOnly||n&&-1!=h(n,r)||(n||(n=[])).push(r)}}),!n)return null;for(var i=[{from:t,to:r}],o=0;o<n.length;++o)for(var l=n[o],s=l.find(0),a=0;a<i.length;++a){var u=i[a];if(!(P(u.to,s.from)<0||P(u.from,s.to)>0)){var c=[a,1],f=P(u.from,s.from),d=P(u.to,s.to);(f<0||!l.inclusiveLeft&&!f)&&c.push({from:u.from,to:s.from}),(d>0||!l.inclusiveRight&&!d)&&c.push({from:s.to,to:u.to}),i.splice.apply(i,c),a+=c.length-3}}return i}function re(e){var t=e.markedSpans;if(t){for(var r=0;r<t.length;++r)t[r].marker.detachLine(e);e.markedSpans=null}}function ne(e,t){if(t){for(var r=0;r<t.length;++r)t[r].marker.attachLine(e);e.markedSpans=t}}function ie(e){return e.inclusiveLeft?-1:0}function oe(e){return e.inclusiveRight?1:0}function le(e,t){var r=e.lines.length-t.lines.length;if(0!=r)return r;var n=e.find(),i=t.find(),o=P(n.from,i.from)||ie(e)-ie(t);if(o)return-o;var l=P(n.to,i.to)||oe(e)-oe(t);return l||t.id-e.id}function se(e,t){var r,n=_l&&e.markedSpans;if(n)for(var i=void 0,o=0;o<n.length;++o)(i=n[o]).marker.collapsed&&null==(t?i.from:i.to)&&(!r||le(r,i.marker)<0)&&(r=i.marker);return r}function ae(e){return se(e,!0)}function ue(e){return se(e,!1)}function ce(e,t,r,n,i){var o=M(e,t),l=_l&&o.markedSpans;if(l)for(var s=0;s<l.length;++s){var a=l[s];if(a.marker.collapsed){var u=a.marker.find(0),c=P(u.from,r)||ie(a.marker)-ie(i),f=P(u.to,n)||oe(a.marker)-oe(i);if(!(c>=0&&f<=0||c<=0&&f>=0)&&(c<=0&&(a.marker.inclusiveRight&&i.inclusiveLeft?P(u.to,r)>=0:P(u.to,r)>0)||c>=0&&(a.marker.inclusiveRight&&i.inclusiveLeft?P(u.from,n)<=0:P(u.from,n)<0)))return!0}}}function fe(e){for(var t;t=ae(e);)e=t.find(-1,!0).line;return e}function he(e){for(var t;t=ue(e);)e=t.find(1,!0).line;return e}function de(e){for(var t,r;t=ue(e);)e=t.find(1,!0).line,(r||(r=[])).push(e);return r}function pe(e,t){var r=M(e,t),n=fe(r);return r==n?t:W(n)}function ge(e,t){if(t>e.lastLine())return t;var r,n=M(e,t);if(!ve(e,n))return t;for(;r=ue(n);)n=r.find(1,!0).line;return W(n)+1}function ve(e,t){var r=_l&&t.markedSpans;if(r)for(var n=void 0,i=0;i<r.length;++i)if((n=r[i]).marker.collapsed){if(null==n.from)return!0;if(!n.marker.widgetNode&&0==n.from&&n.marker.inclusiveLeft&&me(e,t,n))return!0}}function me(e,t,r){if(null==r.to){var n=r.marker.find(1,!0);return me(e,n.line,_(n.line.markedSpans,r.marker))}if(r.marker.inclusiveRight&&r.to==t.text.length)return!0;for(var i=void 0,o=0;o<t.markedSpans.length;++o)if((i=t.markedSpans[o]).marker.collapsed&&!i.marker.widgetNode&&i.from==r.to&&(null==i.to||i.to!=r.from)&&(i.marker.inclusiveLeft||r.marker.inclusiveRight)&&me(e,t,i))return!0}function ye(e){for(var t=0,r=(e=fe(e)).parent,n=0;n<r.lines.length;++n){var i=r.lines[n];if(i==e)break;t+=i.height}for(var o=r.parent;o;r=o,o=r.parent)for(var l=0;l<o.children.length;++l){var s=o.children[l];if(s==r)break;t+=s.height}return t}function be(e){if(0==e.height)return 0;for(var t,r=e.text.length,n=e;t=ae(n);){var i=t.find(0,!0);n=i.from.line,r+=i.from.ch-i.to.ch}for(n=e;t=ue(n);){var o=t.find(0,!0);r-=n.text.length-o.from.ch,r+=(n=o.to.line).text.length-o.to.ch}return r}function we(e){var t=e.display,r=e.doc;t.maxLine=M(r,r.first),t.maxLineLength=be(t.maxLine),t.maxLineChanged=!0,r.iter(function(e){var r=be(e);r>t.maxLineLength&&(t.maxLineLength=r,t.maxLine=e)})}function xe(e,t,r,n){if(!e)return n(t,r,"ltr",0);for(var i=!1,o=0;o<e.length;++o){var l=e[o];(l.from<r&&l.to>t||t==r&&l.to==t)&&(n(Math.max(l.from,t),Math.min(l.to,r),1==l.level?"rtl":"ltr",o),i=!0)}i||n(t,r,"ltr")}function Ce(e,t,r){var n;$l=null;for(var i=0;i<e.length;++i){var o=e[i];if(o.from<t&&o.to>t)return i;o.to==t&&(o.from!=o.to&&"before"==r?n=i:$l=i),o.from==t&&(o.from!=o.to&&"before"!=r?n=i:$l=i)}return null!=n?n:$l}function Se(e,t){var r=e.order;return null==r&&(r=e.order=ql(e.text,t)),r}function Le(e,t){return e._handlers&&e._handlers[t]||Zl}function ke(e,t,r){if(e.removeEventListener)e.removeEventListener(t,r,!1);else if(e.detachEvent)e.detachEvent("on"+t,r);else{var n=e._handlers,i=n&&n[t];if(i){var o=h(i,r);o>-1&&(n[t]=i.slice(0,o).concat(i.slice(o+1)))}}}function Te(e,t){var r=Le(e,t);if(r.length)for(var n=Array.prototype.slice.call(arguments,2),i=0;i<r.length;++i)r[i].apply(null,n)}function Me(e,t,r){return"string"==typeof t&&(t={type:t,preventDefault:function(){this.defaultPrevented=!0}}),Te(e,r||t.type,e,t),He(t)||t.codemirrorIgnore}function Ne(e){var t=e._handlers&&e._handlers.cursorActivity;if(t)for(var r=e.curOp.cursorActivityHandlers||(e.curOp.cursorActivityHandlers=[]),n=0;n<t.length;++n)-1==h(r,t[n])&&r.push(t[n])}function Oe(e,t){return Le(e,t).length>0}function Ae(e){e.prototype.on=function(e,t){Ql(this,e,t)},e.prototype.off=function(e,t){ke(this,e,t)}}function We(e){e.preventDefault?e.preventDefault():e.returnValue=!1}function De(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}function He(e){return null!=e.defaultPrevented?e.defaultPrevented:0==e.returnValue}function Fe(e){We(e),De(e)}function Ee(e){return e.target||e.srcElement}function Pe(e){var t=e.which;return null==t&&(1&e.button?t=1:2&e.button?t=3:4&e.button&&(t=2)),Ml&&e.ctrlKey&&1==t&&(t=3),t}function Ie(e){if(null==Il){var t=n("span","​");r(e,n("span",[t,document.createTextNode("x")])),0!=e.firstChild.offsetHeight&&(Il=t.offsetWidth<=1&&t.offsetHeight>2&&!(gl&&vl<8))}var i=Il?n("span","​"):n("span"," ",null,"display: inline-block; width: 1px; margin-right: -1px");return i.setAttribute("cm-text",""),i}function ze(e){if(null!=zl)return zl;var n=r(e,document.createTextNode("AخA")),i=Wl(n,0,1).getBoundingClientRect(),o=Wl(n,1,2).getBoundingClientRect();return t(e),!(!i||i.left==i.right)&&(zl=o.right-i.right<3)}function Re(e){if(null!=ns)return ns;var t=r(e,n("span","x")),i=t.getBoundingClientRect(),o=Wl(t,0,1).getBoundingClientRect();return ns=Math.abs(i.left-o.left)>1}function Be(e,t){arguments.length>2&&(t.dependencies=Array.prototype.slice.call(arguments,2)),is[e]=t}function Ge(e){if("string"==typeof e&&os.hasOwnProperty(e))e=os[e];else if(e&&"string"==typeof e.name&&os.hasOwnProperty(e.name)){var t=os[e.name];"string"==typeof t&&(t={name:t}),(e=b(t,e)).name=t.name}else{if("string"==typeof e&&/^[\w\-]+\/[\w\-]+\+xml$/.test(e))return Ge("application/xml");if("string"==typeof e&&/^[\w\-]+\/[\w\-]+\+json$/.test(e))return Ge("application/json")}return"string"==typeof e?{name:e}:e||{name:"null"}}function Ue(e,t){t=Ge(t);var r=is[t.name];if(!r)return Ue(e,"text/plain");var n=r(e,t);if(ls.hasOwnProperty(t.name)){var i=ls[t.name];for(var o in i)i.hasOwnProperty(o)&&(n.hasOwnProperty(o)&&(n["_"+o]=n[o]),n[o]=i[o])}if(n.name=t.name,t.helperType&&(n.helperType=t.helperType),t.modeProps)for(var l in t.modeProps)n[l]=t.modeProps[l];return n}function Ve(e,t){c(t,ls.hasOwnProperty(e)?ls[e]:ls[e]={})}function Ke(e,t){if(!0===t)return t;if(e.copyState)return e.copyState(t);var r={};for(var n in t){var i=t[n];i instanceof Array&&(i=i.concat([])),r[n]=i}return r}function je(e,t){for(var r;e.innerMode&&(r=e.innerMode(t))&&r.mode!=e;)t=r.state,e=r.mode;return r||{mode:e,state:t}}function Xe(e,t,r){return!e.startState||e.startState(t,r)}function Ye(e,t,r,n){var i=[e.state.modeGen],o={};tt(e,t.text,e.doc.mode,r,function(e,t){return i.push(e,t)},o,n);for(var l=r.state,s=0;s<e.state.overlays.length;++s)!function(n){var l=e.state.overlays[n],s=1,a=0;r.state=!0,tt(e,t.text,l.mode,r,function(e,t){for(var r=s;a<e;){var n=i[s];n>e&&i.splice(s,1,e,i[s+1],n),s+=2,a=Math.min(e,n)}if(t)if(l.opaque)i.splice(r,s-r,e,"overlay "+t),s=r+2;else for(;r<s;r+=2){var o=i[r+1];i[r+1]=(o?o+" ":"")+"overlay "+t}},o)}(s);return r.state=l,{styles:i,classes:o.bgClass||o.textClass?o:null}}function _e(e,t,r){if(!t.styles||t.styles[0]!=e.state.modeGen){var n=$e(e,W(t)),i=t.text.length>e.options.maxHighlightLength&&Ke(e.doc.mode,n.state),o=Ye(e,t,n);i&&(n.state=i),t.stateAfter=n.save(!i),t.styles=o.styles,o.classes?t.styleClasses=o.classes:t.styleClasses&&(t.styleClasses=null),r===e.doc.highlightFrontier&&(e.doc.modeFrontier=Math.max(e.doc.modeFrontier,++e.doc.highlightFrontier))}return t.styles}function $e(e,t,r){var n=e.doc,i=e.display;if(!n.mode.startState)return new us(n,!0,t);var o=rt(e,t,r),l=o>n.first&&M(n,o-1).stateAfter,s=l?us.fromSaved(n,l,o):new us(n,Xe(n.mode),o);return n.iter(o,t,function(r){qe(e,r.text,s);var n=s.line;r.stateAfter=n==t-1||n%5==0||n>=i.viewFrom&&n<i.viewTo?s.save():null,s.nextLine()}),r&&(n.modeFrontier=s.line),s}function qe(e,t,r,n){var i=e.doc.mode,o=new ss(t,e.options.tabSize,r);for(o.start=o.pos=n||0,""==t&&Ze(i,r.state);!o.eol();)Qe(i,o,r.state),o.start=o.pos}function Ze(e,t){if(e.blankLine)return e.blankLine(t);if(e.innerMode){var r=je(e,t);return r.mode.blankLine?r.mode.blankLine(r.state):void 0}}function Qe(e,t,r,n){for(var i=0;i<10;i++){n&&(n[0]=je(e,r).mode);var o=e.token(t,r);if(t.pos>t.start)return o}throw new Error("Mode "+e.name+" failed to advance stream.")}function Je(e,t,r,n){var i,o,l=e.doc,s=l.mode,a=M(l,(t=U(l,t)).line),u=$e(e,t.line,r),c=new ss(a.text,e.options.tabSize,u);for(n&&(o=[]);(n||c.pos<t.ch)&&!c.eol();)c.start=c.pos,i=Qe(s,c,u.state),n&&o.push(new cs(c,i,Ke(l.mode,u.state)));return n?o:new cs(c,i,u.state)}function et(e,t){if(e)for(;;){var r=e.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!r)break;e=e.slice(0,r.index)+e.slice(r.index+r[0].length);var n=r[1]?"bgClass":"textClass";null==t[n]?t[n]=r[2]:new RegExp("(?:^|s)"+r[2]+"(?:$|s)").test(t[n])||(t[n]+=" "+r[2])}return e}function tt(e,t,r,n,i,o,l){var s=r.flattenSpans;null==s&&(s=e.options.flattenSpans);var a,u=0,c=null,f=new ss(t,e.options.tabSize,n),h=e.options.addModeClass&&[null];for(""==t&&et(Ze(r,n.state),o);!f.eol();){if(f.pos>e.options.maxHighlightLength?(s=!1,l&&qe(e,t,n,f.pos),f.pos=t.length,a=null):a=et(Qe(r,f,n.state,h),o),h){var d=h[0].name;d&&(a="m-"+(a?d+" "+a:d))}if(!s||c!=a){for(;u<f.start;)i(u=Math.min(f.start,u+5e3),c);c=a}f.start=f.pos}for(;u<f.pos;){var p=Math.min(f.pos,u+5e3);i(p,c),u=p}}function rt(e,t,r){for(var n,i,o=e.doc,l=r?-1:t-(e.doc.mode.innerMode?1e3:100),s=t;s>l;--s){if(s<=o.first)return o.first;var a=M(o,s-1),u=a.stateAfter;if(u&&(!r||s+(u instanceof as?u.lookAhead:0)<=o.modeFrontier))return s;var c=f(a.text,null,e.options.tabSize);(null==i||n>c)&&(i=s-1,n=c)}return i}function nt(e,t){if(e.modeFrontier=Math.min(e.modeFrontier,t),!(e.highlightFrontier<t-10)){for(var r=e.first,n=t-1;n>r;n--){var i=M(e,n).stateAfter;if(i&&(!(i instanceof as)||n+i.lookAhead<t)){r=n+1;break}}e.highlightFrontier=Math.min(e.highlightFrontier,r)}}function it(e,t,r,n){e.text=t,e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null),null!=e.order&&(e.order=null),re(e),ne(e,r);var i=n?n(e):1;i!=e.height&&A(e,i)}function ot(e){e.parent=null,re(e)}function lt(e,t){if(!e||/^\s*$/.test(e))return null;var r=t.addModeClass?ps:ds;return r[e]||(r[e]=e.replace(/\S+/g,"cm-$&"))}function st(e,t){var r=i("span",null,null,ml?"padding-right: .1px":null),n={pre:i("pre",[r],"CodeMirror-line"),content:r,col:0,pos:0,cm:e,trailingSpace:!1,splitSpaces:(gl||ml)&&e.getOption("lineWrapping")};t.measure={};for(var o=0;o<=(t.rest?t.rest.length:0);o++){var l=o?t.rest[o-1]:t.line,s=void 0;n.pos=0,n.addToken=ut,ze(e.display.measure)&&(s=Se(l,e.doc.direction))&&(n.addToken=ft(n.addToken,s)),n.map=[],dt(l,n,_e(e,l,t!=e.display.externalMeasured&&W(l))),l.styleClasses&&(l.styleClasses.bgClass&&(n.bgClass=a(l.styleClasses.bgClass,n.bgClass||"")),l.styleClasses.textClass&&(n.textClass=a(l.styleClasses.textClass,n.textClass||""))),0==n.map.length&&n.map.push(0,0,n.content.appendChild(Ie(e.display.measure))),0==o?(t.measure.map=n.map,t.measure.cache={}):((t.measure.maps||(t.measure.maps=[])).push(n.map),(t.measure.caches||(t.measure.caches=[])).push({}))}if(ml){var u=n.content.lastChild;(/\bcm-tab\b/.test(u.className)||u.querySelector&&u.querySelector(".cm-tab"))&&(n.content.className="cm-tab-wrap-hack")}return Te(e,"renderLine",e,t.line,n.pre),n.pre.className&&(n.textClass=a(n.pre.className,n.textClass||"")),n}function at(e){var t=n("span","•","cm-invalidchar");return t.title="\\u"+e.charCodeAt(0).toString(16),t.setAttribute("aria-label",t.title),t}function ut(e,t,r,i,o,l,s){if(t){var a,u=e.splitSpaces?ct(t,e.trailingSpace):t,c=e.cm.state.specialChars,f=!1;if(c.test(t)){a=document.createDocumentFragment();for(var h=0;;){c.lastIndex=h;var d=c.exec(t),g=d?d.index-h:t.length-h;if(g){var v=document.createTextNode(u.slice(h,h+g));gl&&vl<9?a.appendChild(n("span",[v])):a.appendChild(v),e.map.push(e.pos,e.pos+g,v),e.col+=g,e.pos+=g}if(!d)break;h+=g+1;var m=void 0;if("\t"==d[0]){var y=e.cm.options.tabSize,b=y-e.col%y;(m=a.appendChild(n("span",p(b),"cm-tab"))).setAttribute("role","presentation"),m.setAttribute("cm-text","\t"),e.col+=b}else"\r"==d[0]||"\n"==d[0]?((m=a.appendChild(n("span","\r"==d[0]?"␍":"␤","cm-invalidchar"))).setAttribute("cm-text",d[0]),e.col+=1):((m=e.cm.options.specialCharPlaceholder(d[0])).setAttribute("cm-text",d[0]),gl&&vl<9?a.appendChild(n("span",[m])):a.appendChild(m),e.col+=1);e.map.push(e.pos,e.pos+1,m),e.pos++}}else e.col+=t.length,a=document.createTextNode(u),e.map.push(e.pos,e.pos+t.length,a),gl&&vl<9&&(f=!0),e.pos+=t.length;if(e.trailingSpace=32==u.charCodeAt(t.length-1),r||i||o||f||s){var w=r||"";i&&(w+=i),o&&(w+=o);var x=n("span",[a],w,s);return l&&(x.title=l),e.content.appendChild(x)}e.content.appendChild(a)}}function ct(e,t){if(e.length>1&&!/  /.test(e))return e;for(var r=t,n="",i=0;i<e.length;i++){var o=e.charAt(i);" "!=o||!r||i!=e.length-1&&32!=e.charCodeAt(i+1)||(o=" "),n+=o,r=" "==o}return n}function ft(e,t){return function(r,n,i,o,l,s,a){i=i?i+" cm-force-border":"cm-force-border";for(var u=r.pos,c=u+n.length;;){for(var f=void 0,h=0;h<t.length&&!((f=t[h]).to>u&&f.from<=u);h++);if(f.to>=c)return e(r,n,i,o,l,s,a);e(r,n.slice(0,f.to-u),i,o,null,s,a),o=null,n=n.slice(f.to-u),u=f.to}}}function ht(e,t,r,n){var i=!n&&r.widgetNode;i&&e.map.push(e.pos,e.pos+t,i),!n&&e.cm.display.input.needsContentAttribute&&(i||(i=e.content.appendChild(document.createElement("span"))),i.setAttribute("cm-marker",r.id)),i&&(e.cm.display.input.setUneditable(i),e.content.appendChild(i)),e.pos+=t,e.trailingSpace=!1}function dt(e,t,r){var n=e.markedSpans,i=e.text,o=0;if(n)for(var l,s,a,u,c,f,h,d=i.length,p=0,g=1,v="",m=0;;){if(m==p){a=u=c=f=s="",h=null,m=1/0;for(var y=[],b=void 0,w=0;w<n.length;++w){var x=n[w],C=x.marker;"bookmark"==C.type&&x.from==p&&C.widgetNode?y.push(C):x.from<=p&&(null==x.to||x.to>p||C.collapsed&&x.to==p&&x.from==p)?(null!=x.to&&x.to!=p&&m>x.to&&(m=x.to,u=""),C.className&&(a+=" "+C.className),C.css&&(s=(s?s+";":"")+C.css),C.startStyle&&x.from==p&&(c+=" "+C.startStyle),C.endStyle&&x.to==m&&(b||(b=[])).push(C.endStyle,x.to),C.title&&!f&&(f=C.title),C.collapsed&&(!h||le(h.marker,C)<0)&&(h=x)):x.from>p&&m>x.from&&(m=x.from)}if(b)for(var S=0;S<b.length;S+=2)b[S+1]==m&&(u+=" "+b[S]);if(!h||h.from==p)for(var L=0;L<y.length;++L)ht(t,0,y[L]);if(h&&(h.from||0)==p){if(ht(t,(null==h.to?d+1:h.to)-p,h.marker,null==h.from),null==h.to)return;h.to==p&&(h=!1)}}if(p>=d)break;for(var k=Math.min(d,m);;){if(v){var T=p+v.length;if(!h){var M=T>k?v.slice(0,k-p):v;t.addToken(t,M,l?l+a:a,c,p+M.length==m?u:"",f,s)}if(T>=k){v=v.slice(k-p),p=k;break}p=T,c=""}v=i.slice(o,o=r[g++]),l=lt(r[g++],t.cm.options)}}else for(var N=1;N<r.length;N+=2)t.addToken(t,i.slice(o,o=r[N]),lt(r[N+1],t.cm.options))}function pt(e,t,r){this.line=t,this.rest=de(t),this.size=this.rest?W(g(this.rest))-r+1:1,this.node=this.text=null,this.hidden=ve(e,t)}function gt(e,t,r){for(var n,i=[],o=t;o<r;o=n){var l=new pt(e.doc,M(e.doc,o),o);n=o+l.size,i.push(l)}return i}function vt(e){gs?gs.ops.push(e):e.ownsGroup=gs={ops:[e],delayedCallbacks:[]}}function mt(e){var t=e.delayedCallbacks,r=0;do{for(;r<t.length;r++)t[r].call(null);for(var n=0;n<e.ops.length;n++){var i=e.ops[n];if(i.cursorActivityHandlers)for(;i.cursorActivityCalled<i.cursorActivityHandlers.length;)i.cursorActivityHandlers[i.cursorActivityCalled++].call(null,i.cm)}}while(r<t.length)}function yt(e,t){var r=e.ownsGroup;if(r)try{mt(r)}finally{gs=null,t(r)}}function bt(e,t){var r=Le(e,t);if(r.length){var n,i=Array.prototype.slice.call(arguments,2);gs?n=gs.delayedCallbacks:vs?n=vs:(n=vs=[],setTimeout(wt,0));for(var o=0;o<r.length;++o)!function(e){n.push(function(){return r[e].apply(null,i)})}(o)}}function wt(){var e=vs;vs=null;for(var t=0;t<e.length;++t)e[t]()}function xt(e,t,r,n){for(var i=0;i<t.changes.length;i++){var o=t.changes[i];"text"==o?kt(e,t):"gutter"==o?Mt(e,t,r,n):"class"==o?Tt(e,t):"widget"==o&&Nt(e,t,n)}t.changes=null}function Ct(e){return e.node==e.text&&(e.node=n("div",null,null,"position: relative"),e.text.parentNode&&e.text.parentNode.replaceChild(e.node,e.text),e.node.appendChild(e.text),gl&&vl<8&&(e.node.style.zIndex=2)),e.node}function St(e,t){var r=t.bgClass?t.bgClass+" "+(t.line.bgClass||""):t.line.bgClass;if(r&&(r+=" CodeMirror-linebackground"),t.background)r?t.background.className=r:(t.background.parentNode.removeChild(t.background),t.background=null);else if(r){var i=Ct(t);t.background=i.insertBefore(n("div",null,r),i.firstChild),e.display.input.setUneditable(t.background)}}function Lt(e,t){var r=e.display.externalMeasured;return r&&r.line==t.line?(e.display.externalMeasured=null,t.measure=r.measure,r.built):st(e,t)}function kt(e,t){var r=t.text.className,n=Lt(e,t);t.text==t.node&&(t.node=n.pre),t.text.parentNode.replaceChild(n.pre,t.text),t.text=n.pre,n.bgClass!=t.bgClass||n.textClass!=t.textClass?(t.bgClass=n.bgClass,t.textClass=n.textClass,Tt(e,t)):r&&(t.text.className=r)}function Tt(e,t){St(e,t),t.line.wrapClass?Ct(t).className=t.line.wrapClass:t.node!=t.text&&(t.node.className="");var r=t.textClass?t.textClass+" "+(t.line.textClass||""):t.line.textClass;t.text.className=r||""}function Mt(e,t,r,i){if(t.gutter&&(t.node.removeChild(t.gutter),t.gutter=null),t.gutterBackground&&(t.node.removeChild(t.gutterBackground),t.gutterBackground=null),t.line.gutterClass){var o=Ct(t);t.gutterBackground=n("div",null,"CodeMirror-gutter-background "+t.line.gutterClass,"left: "+(e.options.fixedGutter?i.fixedPos:-i.gutterTotalWidth)+"px; width: "+i.gutterTotalWidth+"px"),e.display.input.setUneditable(t.gutterBackground),o.insertBefore(t.gutterBackground,t.text)}var l=t.line.gutterMarkers;if(e.options.lineNumbers||l){var s=Ct(t),a=t.gutter=n("div",null,"CodeMirror-gutter-wrapper","left: "+(e.options.fixedGutter?i.fixedPos:-i.gutterTotalWidth)+"px");if(e.display.input.setUneditable(a),s.insertBefore(a,t.text),t.line.gutterClass&&(a.className+=" "+t.line.gutterClass),!e.options.lineNumbers||l&&l["CodeMirror-linenumbers"]||(t.lineNumber=a.appendChild(n("div",F(e.options,r),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+i.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+e.display.lineNumInnerWidth+"px"))),l)for(var u=0;u<e.options.gutters.length;++u){var c=e.options.gutters[u],f=l.hasOwnProperty(c)&&l[c];f&&a.appendChild(n("div",[f],"CodeMirror-gutter-elt","left: "+i.gutterLeft[c]+"px; width: "+i.gutterWidth[c]+"px"))}}}function Nt(e,t,r){t.alignable&&(t.alignable=null);for(var n=t.node.firstChild,i=void 0;n;n=i)i=n.nextSibling,"CodeMirror-linewidget"==n.className&&t.node.removeChild(n);At(e,t,r)}function Ot(e,t,r,n){var i=Lt(e,t);return t.text=t.node=i.pre,i.bgClass&&(t.bgClass=i.bgClass),i.textClass&&(t.textClass=i.textClass),Tt(e,t),Mt(e,t,r,n),At(e,t,n),t.node}function At(e,t,r){if(Wt(e,t.line,t,r,!0),t.rest)for(var n=0;n<t.rest.length;n++)Wt(e,t.rest[n],t,r,!1)}function Wt(e,t,r,i,o){if(t.widgets)for(var l=Ct(r),s=0,a=t.widgets;s<a.length;++s){var u=a[s],c=n("div",[u.node],"CodeMirror-linewidget");u.handleMouseEvents||c.setAttribute("cm-ignore-events","true"),Dt(u,c,r,i),e.display.input.setUneditable(c),o&&u.above?l.insertBefore(c,r.gutter||r.text):l.appendChild(c),bt(u,"redraw")}}function Dt(e,t,r,n){if(e.noHScroll){(r.alignable||(r.alignable=[])).push(t);var i=n.wrapperWidth;t.style.left=n.fixedPos+"px",e.coverGutter||(i-=n.gutterTotalWidth,t.style.paddingLeft=n.gutterTotalWidth+"px"),t.style.width=i+"px"}e.coverGutter&&(t.style.zIndex=5,t.style.position="relative",e.noHScroll||(t.style.marginLeft=-n.gutterTotalWidth+"px"))}function Ht(e){if(null!=e.height)return e.height;var t=e.doc.cm;if(!t)return 0;if(!o(document.body,e.node)){var i="position: relative;";e.coverGutter&&(i+="margin-left: -"+t.display.gutters.offsetWidth+"px;"),e.noHScroll&&(i+="width: "+t.display.wrapper.clientWidth+"px;"),r(t.display.measure,n("div",[e.node],null,i))}return e.height=e.node.parentNode.offsetHeight}function Ft(e,t){for(var r=Ee(t);r!=e.wrapper;r=r.parentNode)if(!r||1==r.nodeType&&"true"==r.getAttribute("cm-ignore-events")||r.parentNode==e.sizer&&r!=e.mover)return!0}function Et(e){return e.lineSpace.offsetTop}function Pt(e){return e.mover.offsetHeight-e.lineSpace.offsetHeight}function It(e){if(e.cachedPaddingH)return e.cachedPaddingH;var t=r(e.measure,n("pre","x")),i=window.getComputedStyle?window.getComputedStyle(t):t.currentStyle,o={left:parseInt(i.paddingLeft),right:parseInt(i.paddingRight)};return isNaN(o.left)||isNaN(o.right)||(e.cachedPaddingH=o),o}function zt(e){return Rl-e.display.nativeBarWidth}function Rt(e){return e.display.scroller.clientWidth-zt(e)-e.display.barWidth}function Bt(e){return e.display.scroller.clientHeight-zt(e)-e.display.barHeight}function Gt(e,t,r){var n=e.options.lineWrapping,i=n&&Rt(e);if(!t.measure.heights||n&&t.measure.width!=i){var o=t.measure.heights=[];if(n){t.measure.width=i;for(var l=t.text.firstChild.getClientRects(),s=0;s<l.length-1;s++){var a=l[s],u=l[s+1];Math.abs(a.bottom-u.bottom)>2&&o.push((a.bottom+u.top)/2-r.top)}}o.push(r.bottom-r.top)}}function Ut(e,t,r){if(e.line==t)return{map:e.measure.map,cache:e.measure.cache};for(var n=0;n<e.rest.length;n++)if(e.rest[n]==t)return{map:e.measure.maps[n],cache:e.measure.caches[n]};for(var i=0;i<e.rest.length;i++)if(W(e.rest[i])>r)return{map:e.measure.maps[i],cache:e.measure.caches[i],before:!0}}function Vt(e,t){var n=W(t=fe(t)),i=e.display.externalMeasured=new pt(e.doc,t,n);i.lineN=n;var o=i.built=st(e,i);return i.text=o.pre,r(e.display.lineMeasure,o.pre),i}function Kt(e,t,r,n){return Yt(e,Xt(e,t),r,n)}function jt(e,t){if(t>=e.display.viewFrom&&t<e.display.viewTo)return e.display.view[Lr(e,t)];var r=e.display.externalMeasured;return r&&t>=r.lineN&&t<r.lineN+r.size?r:void 0}function Xt(e,t){var r=W(t),n=jt(e,r);n&&!n.text?n=null:n&&n.changes&&(xt(e,n,r,br(e)),e.curOp.forceUpdate=!0),n||(n=Vt(e,t));var i=Ut(n,t,r);return{line:t,view:n,rect:null,map:i.map,cache:i.cache,before:i.before,hasHeights:!1}}function Yt(e,t,r,n,i){t.before&&(r=-1);var o,l=r+(n||"");return t.cache.hasOwnProperty(l)?o=t.cache[l]:(t.rect||(t.rect=t.view.text.getBoundingClientRect()),t.hasHeights||(Gt(e,t.view,t.rect),t.hasHeights=!0),(o=qt(e,t,r,n)).bogus||(t.cache[l]=o)),{left:o.left,right:o.right,top:i?o.rtop:o.top,bottom:i?o.rbottom:o.bottom}}function _t(e,t,r){for(var n,i,o,l,s,a,u=0;u<e.length;u+=3)if(s=e[u],a=e[u+1],t<s?(i=0,o=1,l="left"):t<a?o=(i=t-s)+1:(u==e.length-3||t==a&&e[u+3]>t)&&(i=(o=a-s)-1,t>=a&&(l="right")),null!=i){if(n=e[u+2],s==a&&r==(n.insertLeft?"left":"right")&&(l=r),"left"==r&&0==i)for(;u&&e[u-2]==e[u-3]&&e[u-1].insertLeft;)n=e[2+(u-=3)],l="left";if("right"==r&&i==a-s)for(;u<e.length-3&&e[u+3]==e[u+4]&&!e[u+5].insertLeft;)n=e[(u+=3)+2],l="right";break}return{node:n,start:i,end:o,collapse:l,coverStart:s,coverEnd:a}}function $t(e,t){var r=ms;if("left"==t)for(var n=0;n<e.length&&(r=e[n]).left==r.right;n++);else for(var i=e.length-1;i>=0&&(r=e[i]).left==r.right;i--);return r}function qt(e,t,r,n){var i,o=_t(t.map,r,n),l=o.node,s=o.start,a=o.end,u=o.collapse;if(3==l.nodeType){for(var c=0;c<4;c++){for(;s&&S(t.line.text.charAt(o.coverStart+s));)--s;for(;o.coverStart+a<o.coverEnd&&S(t.line.text.charAt(o.coverStart+a));)++a;if((i=gl&&vl<9&&0==s&&a==o.coverEnd-o.coverStart?l.parentNode.getBoundingClientRect():$t(Wl(l,s,a).getClientRects(),n)).left||i.right||0==s)break;a=s,s-=1,u="right"}gl&&vl<11&&(i=Zt(e.display.measure,i))}else{s>0&&(u=n="right");var f;i=e.options.lineWrapping&&(f=l.getClientRects()).length>1?f["right"==n?f.length-1:0]:l.getBoundingClientRect()}if(gl&&vl<9&&!s&&(!i||!i.left&&!i.right)){var h=l.parentNode.getClientRects()[0];i=h?{left:h.left,right:h.left+yr(e.display),top:h.top,bottom:h.bottom}:ms}for(var d=i.top-t.rect.top,p=i.bottom-t.rect.top,g=(d+p)/2,v=t.view.measure.heights,m=0;m<v.length-1&&!(g<v[m]);m++);var y=m?v[m-1]:0,b=v[m],w={left:("right"==u?i.right:i.left)-t.rect.left,right:("left"==u?i.left:i.right)-t.rect.left,top:y,bottom:b};return i.left||i.right||(w.bogus=!0),e.options.singleCursorHeightPerLine||(w.rtop=d,w.rbottom=p),w}function Zt(e,t){if(!window.screen||null==screen.logicalXDPI||screen.logicalXDPI==screen.deviceXDPI||!Re(e))return t;var r=screen.logicalXDPI/screen.deviceXDPI,n=screen.logicalYDPI/screen.deviceYDPI;return{left:t.left*r,right:t.right*r,top:t.top*n,bottom:t.bottom*n}}function Qt(e){if(e.measure&&(e.measure.cache={},e.measure.heights=null,e.rest))for(var t=0;t<e.rest.length;t++)e.measure.caches[t]={}}function Jt(e){e.display.externalMeasure=null,t(e.display.lineMeasure);for(var r=0;r<e.display.view.length;r++)Qt(e.display.view[r])}function er(e){Jt(e),e.display.cachedCharWidth=e.display.cachedTextHeight=e.display.cachedPaddingH=null,e.options.lineWrapping||(e.display.maxLineChanged=!0),e.display.lineNumChars=null}function tr(){return bl&&kl?-(document.body.getBoundingClientRect().left-parseInt(getComputedStyle(document.body).marginLeft)):window.pageXOffset||(document.documentElement||document.body).scrollLeft}function rr(){return bl&&kl?-(document.body.getBoundingClientRect().top-parseInt(getComputedStyle(document.body).marginTop)):window.pageYOffset||(document.documentElement||document.body).scrollTop}function nr(e){var t=0;if(e.widgets)for(var r=0;r<e.widgets.length;++r)e.widgets[r].above&&(t+=Ht(e.widgets[r]));return t}function ir(e,t,r,n,i){if(!i){var o=nr(t);r.top+=o,r.bottom+=o}if("line"==n)return r;n||(n="local");var l=ye(t);if("local"==n?l+=Et(e.display):l-=e.display.viewOffset,"page"==n||"window"==n){var s=e.display.lineSpace.getBoundingClientRect();l+=s.top+("window"==n?0:rr());var a=s.left+("window"==n?0:tr());r.left+=a,r.right+=a}return r.top+=l,r.bottom+=l,r}function or(e,t,r){if("div"==r)return t;var n=t.left,i=t.top;if("page"==r)n-=tr(),i-=rr();else if("local"==r||!r){var o=e.display.sizer.getBoundingClientRect();n+=o.left,i+=o.top}var l=e.display.lineSpace.getBoundingClientRect();return{left:n-l.left,top:i-l.top}}function lr(e,t,r,n,i){return n||(n=M(e.doc,t.line)),ir(e,n,Kt(e,n,t.ch,i),r)}function sr(e,t,r,n,i,o){function l(t,l){var s=Yt(e,i,t,l?"right":"left",o);return l?s.left=s.right:s.right=s.left,ir(e,n,s,r)}function s(e,t,r){var n=1==a[t].level;return l(r?e-1:e,n!=r)}n=n||M(e.doc,t.line),i||(i=Xt(e,n));var a=Se(n,e.doc.direction),u=t.ch,c=t.sticky;if(u>=n.text.length?(u=n.text.length,c="before"):u<=0&&(u=0,c="after"),!a)return l("before"==c?u-1:u,"before"==c);var f=Ce(a,u,c),h=$l,d=s(u,f,"before"==c);return null!=h&&(d.other=s(u,h,"before"!=c)),d}function ar(e,t){var r=0;t=U(e.doc,t),e.options.lineWrapping||(r=yr(e.display)*t.ch);var n=M(e.doc,t.line),i=ye(n)+Et(e.display);return{left:r,right:r,top:i,bottom:i+n.height}}function ur(e,t,r,n,i){var o=E(e,t,r);return o.xRel=i,n&&(o.outside=!0),o}function cr(e,t,r){var n=e.doc;if((r+=e.display.viewOffset)<0)return ur(n.first,0,null,!0,-1);var i=D(n,r),o=n.first+n.size-1;if(i>o)return ur(n.first+n.size-1,M(n,o).text.length,null,!0,1);t<0&&(t=0);for(var l=M(n,i);;){var s=pr(e,l,i,t,r),a=ue(l),u=a&&a.find(0,!0);if(!a||!(s.ch>u.from.ch||s.ch==u.from.ch&&s.xRel>0))return s;i=W(l=u.to.line)}}function fr(e,t,r,n){n-=nr(t);var i=t.text.length,o=k(function(t){return Yt(e,r,t-1).bottom<=n},i,0);return i=k(function(t){return Yt(e,r,t).top>n},o,i),{begin:o,end:i}}function hr(e,t,r,n){return r||(r=Xt(e,t)),fr(e,t,r,ir(e,t,Yt(e,r,n),"line").top)}function dr(e,t,r,n){return!(e.bottom<=r)&&(e.top>r||(n?e.left:e.right)>t)}function pr(e,t,r,n,i){i-=ye(t);var o=Xt(e,t),l=nr(t),s=0,a=t.text.length,u=!0,c=Se(t,e.doc.direction);if(c){var f=(e.options.lineWrapping?vr:gr)(e,t,r,o,c,n,i);s=(u=1!=f.level)?f.from:f.to-1,a=u?f.to:f.from-1}var h,d,p=null,g=null,v=k(function(t){var r=Yt(e,o,t);return r.top+=l,r.bottom+=l,!!dr(r,n,i,!1)&&(r.top<=i&&r.left<=n&&(p=t,g=r),!0)},s,a),m=!1;if(g){var y=n-g.left<g.right-n,b=y==u;v=p+(b?0:1),d=b?"after":"before",h=y?g.left:g.right}else{u||v!=a&&v!=s||v++,d=0==v?"after":v==t.text.length?"before":Yt(e,o,v-(u?1:0)).bottom+l<=i==u?"after":"before";var w=sr(e,E(r,v,d),"line",t,o);h=w.left,m=i<w.top||i>=w.bottom}return v=L(t.text,v,1),ur(r,v,d,m,n-h)}function gr(e,t,r,n,i,o,l){var s=k(function(s){var a=i[s],u=1!=a.level;return dr(sr(e,E(r,u?a.to:a.from,u?"before":"after"),"line",t,n),o,l,!0)},0,i.length-1),a=i[s];if(s>0){var u=1!=a.level,c=sr(e,E(r,u?a.from:a.to,u?"after":"before"),"line",t,n);dr(c,o,l,!0)&&c.top>l&&(a=i[s-1])}return a}function vr(e,t,r,n,i,o,l){for(var s=fr(e,t,n,l),a=s.begin,u=s.end,c=null,f=null,h=0;h<i.length;h++){var d=i[h];if(!(d.from>=u||d.to<=a)){var p=Yt(e,n,1!=d.level?Math.min(u,d.to)-1:Math.max(a,d.from)).right,g=p<o?o-p+1e9:p-o;(!c||f>g)&&(c=d,f=g)}}return c||(c=i[i.length-1]),c.from<a&&(c={from:a,to:c.to,level:c.level}),c.to>u&&(c={from:c.from,to:u,level:c.level}),c}function mr(e){if(null!=e.cachedTextHeight)return e.cachedTextHeight;if(null==hs){hs=n("pre");for(var i=0;i<49;++i)hs.appendChild(document.createTextNode("x")),hs.appendChild(n("br"));hs.appendChild(document.createTextNode("x"))}r(e.measure,hs);var o=hs.offsetHeight/50;return o>3&&(e.cachedTextHeight=o),t(e.measure),o||1}function yr(e){if(null!=e.cachedCharWidth)return e.cachedCharWidth;var t=n("span","xxxxxxxxxx"),i=n("pre",[t]);r(e.measure,i);var o=t.getBoundingClientRect(),l=(o.right-o.left)/10;return l>2&&(e.cachedCharWidth=l),l||10}function br(e){for(var t=e.display,r={},n={},i=t.gutters.clientLeft,o=t.gutters.firstChild,l=0;o;o=o.nextSibling,++l)r[e.options.gutters[l]]=o.offsetLeft+o.clientLeft+i,n[e.options.gutters[l]]=o.clientWidth;return{fixedPos:wr(t),gutterTotalWidth:t.gutters.offsetWidth,gutterLeft:r,gutterWidth:n,wrapperWidth:t.wrapper.clientWidth}}function wr(e){return e.scroller.getBoundingClientRect().left-e.sizer.getBoundingClientRect().left}function xr(e){var t=mr(e.display),r=e.options.lineWrapping,n=r&&Math.max(5,e.display.scroller.clientWidth/yr(e.display)-3);return function(i){if(ve(e.doc,i))return 0;var o=0;if(i.widgets)for(var l=0;l<i.widgets.length;l++)i.widgets[l].height&&(o+=i.widgets[l].height);return r?o+(Math.ceil(i.text.length/n)||1)*t:o+t}}function Cr(e){var t=e.doc,r=xr(e);t.iter(function(e){var t=r(e);t!=e.height&&A(e,t)})}function Sr(e,t,r,n){var i=e.display;if(!r&&"true"==Ee(t).getAttribute("cm-not-content"))return null;var o,l,s=i.lineSpace.getBoundingClientRect();try{o=t.clientX-s.left,l=t.clientY-s.top}catch(t){return null}var a,u=cr(e,o,l);if(n&&1==u.xRel&&(a=M(e.doc,u.line).text).length==u.ch){var c=f(a,a.length,e.options.tabSize)-a.length;u=E(u.line,Math.max(0,Math.round((o-It(e.display).left)/yr(e.display))-c))}return u}function Lr(e,t){if(t>=e.display.viewTo)return null;if((t-=e.display.viewFrom)<0)return null;for(var r=e.display.view,n=0;n<r.length;n++)if((t-=r[n].size)<0)return n}function kr(e){e.display.input.showSelection(e.display.input.prepareSelection())}function Tr(e,t){void 0===t&&(t=!0);for(var r=e.doc,n={},i=n.cursors=document.createDocumentFragment(),o=n.selection=document.createDocumentFragment(),l=0;l<r.sel.ranges.length;l++)if(t||l!=r.sel.primIndex){var s=r.sel.ranges[l];if(!(s.from().line>=e.display.viewTo||s.to().line<e.display.viewFrom)){var a=s.empty();(a||e.options.showCursorWhenSelecting)&&Mr(e,s.head,i),a||Or(e,s,o)}}return n}function Mr(e,t,r){var i=sr(e,t,"div",null,null,!e.options.singleCursorHeightPerLine),o=r.appendChild(n("div"," ","CodeMirror-cursor"));if(o.style.left=i.left+"px",o.style.top=i.top+"px",o.style.height=Math.max(0,i.bottom-i.top)*e.options.cursorHeight+"px",i.other){var l=r.appendChild(n("div"," ","CodeMirror-cursor CodeMirror-secondarycursor"));l.style.display="",l.style.left=i.other.left+"px",l.style.top=i.other.top+"px",l.style.height=.85*(i.other.bottom-i.other.top)+"px"}}function Nr(e,t){return e.top-t.top||e.left-t.left}function Or(e,t,r){function i(e,t,r,i){t<0&&(t=0),t=Math.round(t),i=Math.round(i),a.appendChild(n("div",null,"CodeMirror-selected","position: absolute; left: "+e+"px;\n                             top: "+t+"px; width: "+(null==r?f-e:r)+"px;\n                             height: "+(i-t)+"px"))}function o(t,r,n){function o(r,n){return lr(e,E(t,r),"div",u,n)}var l,a,u=M(s,t),h=u.text.length,d=Se(u,s.direction);return xe(d,r||0,null==n?h:n,function(t,s,p,g){var v=o(t,"ltr"==p?"left":"right"),m=o(s-1,"ltr"==p?"right":"left");if("ltr"==p){var y=null==r&&0==t?c:v.left,b=null==n&&s==h?f:m.right;m.top-v.top<=3?i(y,m.top,b-y,m.bottom):(i(y,v.top,null,v.bottom),v.bottom<m.top&&i(c,v.bottom,null,m.top),i(c,m.top,m.right,m.bottom))}else if(t<s){var w=null==r&&0==t?f:v.right,x=null==n&&s==h?c:m.left;if(m.top-v.top<=3)i(x,m.top,w-x,m.bottom);else{var C=c;if(g){var S=hr(e,u,null,t).end;C=o(S-(/\s/.test(u.text.charAt(S-1))?2:1),"left").left}i(C,v.top,w-C,v.bottom),v.bottom<m.top&&i(c,v.bottom,null,m.top);var L=null;d.length,L=o(hr(e,u,null,s).begin,"right").right-x,i(x,m.top,L,m.bottom)}}(!l||Nr(v,l)<0)&&(l=v),Nr(m,l)<0&&(l=m),(!a||Nr(v,a)<0)&&(a=v),Nr(m,a)<0&&(a=m)}),{start:l,end:a}}var l=e.display,s=e.doc,a=document.createDocumentFragment(),u=It(e.display),c=u.left,f=Math.max(l.sizerWidth,Rt(e)-l.sizer.offsetLeft)-u.right,h=t.from(),d=t.to();if(h.line==d.line)o(h.line,h.ch,d.ch);else{var p=M(s,h.line),g=M(s,d.line),v=fe(p)==fe(g),m=o(h.line,h.ch,v?p.text.length+1:null).end,y=o(d.line,v?0:null,d.ch).start;v&&(m.top<y.top-2?(i(m.right,m.top,null,m.bottom),i(c,y.top,y.left,y.bottom)):i(m.right,m.top,y.left-m.right,m.bottom)),m.bottom<y.top&&i(c,m.bottom,null,y.top)}r.appendChild(a)}function Ar(e){if(e.state.focused){var t=e.display;clearInterval(t.blinker);var r=!0;t.cursorDiv.style.visibility="",e.options.cursorBlinkRate>0?t.blinker=setInterval(function(){return t.cursorDiv.style.visibility=(r=!r)?"":"hidden"},e.options.cursorBlinkRate):e.options.cursorBlinkRate<0&&(t.cursorDiv.style.visibility="hidden")}}function Wr(e){e.state.focused||(e.display.input.focus(),Hr(e))}function Dr(e){e.state.delayingBlurEvent=!0,setTimeout(function(){e.state.delayingBlurEvent&&(e.state.delayingBlurEvent=!1,Fr(e))},100)}function Hr(e,t){e.state.delayingBlurEvent&&(e.state.delayingBlurEvent=!1),"nocursor"!=e.options.readOnly&&(e.state.focused||(Te(e,"focus",e,t),e.state.focused=!0,s(e.display.wrapper,"CodeMirror-focused"),e.curOp||e.display.selForContextMenu==e.doc.sel||(e.display.input.reset(),ml&&setTimeout(function(){return e.display.input.reset(!0)},20)),e.display.input.receivedFocus()),Ar(e))}function Fr(e,t){e.state.delayingBlurEvent||(e.state.focused&&(Te(e,"blur",e,t),e.state.focused=!1,Fl(e.display.wrapper,"CodeMirror-focused")),clearInterval(e.display.blinker),setTimeout(function(){e.state.focused||(e.display.shift=!1)},150))}function Er(e){for(var t=e.display,r=t.lineDiv.offsetTop,n=0;n<t.view.length;n++){var i=t.view[n],o=void 0;if(!i.hidden){if(gl&&vl<8){var l=i.node.offsetTop+i.node.offsetHeight;o=l-r,r=l}else{var s=i.node.getBoundingClientRect();o=s.bottom-s.top}var a=i.line.height-o;if(o<2&&(o=mr(t)),(a>.005||a<-.005)&&(A(i.line,o),Pr(i.line),i.rest))for(var u=0;u<i.rest.length;u++)Pr(i.rest[u])}}}function Pr(e){if(e.widgets)for(var t=0;t<e.widgets.length;++t)e.widgets[t].height=e.widgets[t].node.parentNode.offsetHeight}function Ir(e,t,r){var n=r&&null!=r.top?Math.max(0,r.top):e.scroller.scrollTop;n=Math.floor(n-Et(e));var i=r&&null!=r.bottom?r.bottom:n+e.wrapper.clientHeight,o=D(t,n),l=D(t,i);if(r&&r.ensure){var s=r.ensure.from.line,a=r.ensure.to.line;s<o?(o=s,l=D(t,ye(M(t,s))+e.wrapper.clientHeight)):Math.min(a,t.lastLine())>=l&&(o=D(t,ye(M(t,a))-e.wrapper.clientHeight),l=a)}return{from:o,to:Math.max(l,o+1)}}function zr(e){var t=e.display,r=t.view;if(t.alignWidgets||t.gutters.firstChild&&e.options.fixedGutter){for(var n=wr(t)-t.scroller.scrollLeft+e.doc.scrollLeft,i=t.gutters.offsetWidth,o=n+"px",l=0;l<r.length;l++)if(!r[l].hidden){e.options.fixedGutter&&(r[l].gutter&&(r[l].gutter.style.left=o),r[l].gutterBackground&&(r[l].gutterBackground.style.left=o));var s=r[l].alignable;if(s)for(var a=0;a<s.length;a++)s[a].style.left=o}e.options.fixedGutter&&(t.gutters.style.left=n+i+"px")}}function Rr(e){if(!e.options.lineNumbers)return!1;var t=e.doc,r=F(e.options,t.first+t.size-1),i=e.display;if(r.length!=i.lineNumChars){var o=i.measure.appendChild(n("div",[n("div",r)],"CodeMirror-linenumber CodeMirror-gutter-elt")),l=o.firstChild.offsetWidth,s=o.offsetWidth-l;return i.lineGutter.style.width="",i.lineNumInnerWidth=Math.max(l,i.lineGutter.offsetWidth-s)+1,i.lineNumWidth=i.lineNumInnerWidth+s,i.lineNumChars=i.lineNumInnerWidth?r.length:-1,i.lineGutter.style.width=i.lineNumWidth+"px",Wn(e),!0}return!1}function Br(e,t){if(!Me(e,"scrollCursorIntoView")){var r=e.display,i=r.sizer.getBoundingClientRect(),o=null;if(t.top+i.top<0?o=!0:t.bottom+i.top>(window.innerHeight||document.documentElement.clientHeight)&&(o=!1),null!=o&&!Sl){var l=n("div","​",null,"position: absolute;\n                         top: "+(t.top-r.viewOffset-Et(e.display))+"px;\n                         height: "+(t.bottom-t.top+zt(e)+r.barHeight)+"px;\n                         left: "+t.left+"px; width: "+Math.max(2,t.right-t.left)+"px;");e.display.lineSpace.appendChild(l),l.scrollIntoView(o),e.display.lineSpace.removeChild(l)}}}function Gr(e,t,r,n){null==n&&(n=0);var i;e.options.lineWrapping||t!=r||(r="before"==(t=t.ch?E(t.line,"before"==t.sticky?t.ch-1:t.ch,"after"):t).sticky?E(t.line,t.ch+1,"before"):t);for(var o=0;o<5;o++){var l=!1,s=sr(e,t),a=r&&r!=t?sr(e,r):s,u=Vr(e,i={left:Math.min(s.left,a.left),top:Math.min(s.top,a.top)-n,right:Math.max(s.left,a.left),bottom:Math.max(s.bottom,a.bottom)+n}),c=e.doc.scrollTop,f=e.doc.scrollLeft;if(null!=u.scrollTop&&(qr(e,u.scrollTop),Math.abs(e.doc.scrollTop-c)>1&&(l=!0)),null!=u.scrollLeft&&(Qr(e,u.scrollLeft),Math.abs(e.doc.scrollLeft-f)>1&&(l=!0)),!l)break}return i}function Ur(e,t){var r=Vr(e,t);null!=r.scrollTop&&qr(e,r.scrollTop),null!=r.scrollLeft&&Qr(e,r.scrollLeft)}function Vr(e,t){var r=e.display,n=mr(e.display);t.top<0&&(t.top=0);var i=e.curOp&&null!=e.curOp.scrollTop?e.curOp.scrollTop:r.scroller.scrollTop,o=Bt(e),l={};t.bottom-t.top>o&&(t.bottom=t.top+o);var s=e.doc.height+Pt(r),a=t.top<n,u=t.bottom>s-n;if(t.top<i)l.scrollTop=a?0:t.top;else if(t.bottom>i+o){var c=Math.min(t.top,(u?s:t.bottom)-o);c!=i&&(l.scrollTop=c)}var f=e.curOp&&null!=e.curOp.scrollLeft?e.curOp.scrollLeft:r.scroller.scrollLeft,h=Rt(e)-(e.options.fixedGutter?r.gutters.offsetWidth:0),d=t.right-t.left>h;return d&&(t.right=t.left+h),t.left<10?l.scrollLeft=0:t.left<f?l.scrollLeft=Math.max(0,t.left-(d?0:10)):t.right>h+f-3&&(l.scrollLeft=t.right+(d?0:10)-h),l}function Kr(e,t){null!=t&&(_r(e),e.curOp.scrollTop=(null==e.curOp.scrollTop?e.doc.scrollTop:e.curOp.scrollTop)+t)}function jr(e){_r(e);var t=e.getCursor();e.curOp.scrollToPos={from:t,to:t,margin:e.options.cursorScrollMargin}}function Xr(e,t,r){null==t&&null==r||_r(e),null!=t&&(e.curOp.scrollLeft=t),null!=r&&(e.curOp.scrollTop=r)}function Yr(e,t){_r(e),e.curOp.scrollToPos=t}function _r(e){var t=e.curOp.scrollToPos;t&&(e.curOp.scrollToPos=null,$r(e,ar(e,t.from),ar(e,t.to),t.margin))}function $r(e,t,r,n){var i=Vr(e,{left:Math.min(t.left,r.left),top:Math.min(t.top,r.top)-n,right:Math.max(t.right,r.right),bottom:Math.max(t.bottom,r.bottom)+n});Xr(e,i.scrollLeft,i.scrollTop)}function qr(e,t){Math.abs(e.doc.scrollTop-t)<2||(fl||On(e,{top:t}),Zr(e,t,!0),fl&&On(e),Cn(e,100))}function Zr(e,t,r){t=Math.min(e.display.scroller.scrollHeight-e.display.scroller.clientHeight,t),(e.display.scroller.scrollTop!=t||r)&&(e.doc.scrollTop=t,e.display.scrollbars.setScrollTop(t),e.display.scroller.scrollTop!=t&&(e.display.scroller.scrollTop=t))}function Qr(e,t,r,n){t=Math.min(t,e.display.scroller.scrollWidth-e.display.scroller.clientWidth),(r?t==e.doc.scrollLeft:Math.abs(e.doc.scrollLeft-t)<2)&&!n||(e.doc.scrollLeft=t,zr(e),e.display.scroller.scrollLeft!=t&&(e.display.scroller.scrollLeft=t),e.display.scrollbars.setScrollLeft(t))}function Jr(e){var t=e.display,r=t.gutters.offsetWidth,n=Math.round(e.doc.height+Pt(e.display));return{clientHeight:t.scroller.clientHeight,viewHeight:t.wrapper.clientHeight,scrollWidth:t.scroller.scrollWidth,clientWidth:t.scroller.clientWidth,viewWidth:t.wrapper.clientWidth,barLeft:e.options.fixedGutter?r:0,docHeight:n,scrollHeight:n+zt(e)+t.barHeight,nativeBarWidth:t.nativeBarWidth,gutterWidth:r}}function en(e,t){t||(t=Jr(e));var r=e.display.barWidth,n=e.display.barHeight;tn(e,t);for(var i=0;i<4&&r!=e.display.barWidth||n!=e.display.barHeight;i++)r!=e.display.barWidth&&e.options.lineWrapping&&Er(e),tn(e,Jr(e)),r=e.display.barWidth,n=e.display.barHeight}function tn(e,t){var r=e.display,n=r.scrollbars.update(t);r.sizer.style.paddingRight=(r.barWidth=n.right)+"px",r.sizer.style.paddingBottom=(r.barHeight=n.bottom)+"px",r.heightForcer.style.borderBottom=n.bottom+"px solid transparent",n.right&&n.bottom?(r.scrollbarFiller.style.display="block",r.scrollbarFiller.style.height=n.bottom+"px",r.scrollbarFiller.style.width=n.right+"px"):r.scrollbarFiller.style.display="",n.bottom&&e.options.coverGutterNextToScrollbar&&e.options.fixedGutter?(r.gutterFiller.style.display="block",r.gutterFiller.style.height=n.bottom+"px",r.gutterFiller.style.width=t.gutterWidth+"px"):r.gutterFiller.style.display=""}function rn(e){e.display.scrollbars&&(e.display.scrollbars.clear(),e.display.scrollbars.addClass&&Fl(e.display.wrapper,e.display.scrollbars.addClass)),e.display.scrollbars=new ws[e.options.scrollbarStyle](function(t){e.display.wrapper.insertBefore(t,e.display.scrollbarFiller),Ql(t,"mousedown",function(){e.state.focused&&setTimeout(function(){return e.display.input.focus()},0)}),t.setAttribute("cm-not-content","true")},function(t,r){"horizontal"==r?Qr(e,t):qr(e,t)},e),e.display.scrollbars.addClass&&s(e.display.wrapper,e.display.scrollbars.addClass)}function nn(e){e.curOp={cm:e,viewChanged:!1,startHeight:e.doc.height,forceUpdate:!1,updateInput:null,typing:!1,changeObjs:null,cursorActivityHandlers:null,cursorActivityCalled:0,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,focus:!1,id:++xs},vt(e.curOp)}function on(e){yt(e.curOp,function(e){for(var t=0;t<e.ops.length;t++)e.ops[t].cm.curOp=null;ln(e)})}function ln(e){for(var t=e.ops,r=0;r<t.length;r++)sn(t[r]);for(var n=0;n<t.length;n++)an(t[n]);for(var i=0;i<t.length;i++)un(t[i]);for(var o=0;o<t.length;o++)cn(t[o]);for(var l=0;l<t.length;l++)fn(t[l])}function sn(e){var t=e.cm,r=t.display;Ln(t),e.updateMaxLine&&we(t),e.mustUpdate=e.viewChanged||e.forceUpdate||null!=e.scrollTop||e.scrollToPos&&(e.scrollToPos.from.line<r.viewFrom||e.scrollToPos.to.line>=r.viewTo)||r.maxLineChanged&&t.options.lineWrapping,e.update=e.mustUpdate&&new Cs(t,e.mustUpdate&&{top:e.scrollTop,ensure:e.scrollToPos},e.forceUpdate)}function an(e){e.updatedDisplay=e.mustUpdate&&Mn(e.cm,e.update)}function un(e){var t=e.cm,r=t.display;e.updatedDisplay&&Er(t),e.barMeasure=Jr(t),r.maxLineChanged&&!t.options.lineWrapping&&(e.adjustWidthTo=Kt(t,r.maxLine,r.maxLine.text.length).left+3,t.display.sizerWidth=e.adjustWidthTo,e.barMeasure.scrollWidth=Math.max(r.scroller.clientWidth,r.sizer.offsetLeft+e.adjustWidthTo+zt(t)+t.display.barWidth),e.maxScrollLeft=Math.max(0,r.sizer.offsetLeft+e.adjustWidthTo-Rt(t))),(e.updatedDisplay||e.selectionChanged)&&(e.preparedSelection=r.input.prepareSelection())}function cn(e){var t=e.cm;null!=e.adjustWidthTo&&(t.display.sizer.style.minWidth=e.adjustWidthTo+"px",e.maxScrollLeft<t.doc.scrollLeft&&Qr(t,Math.min(t.display.scroller.scrollLeft,e.maxScrollLeft),!0),t.display.maxLineChanged=!1);var r=e.focus&&e.focus==l();e.preparedSelection&&t.display.input.showSelection(e.preparedSelection,r),(e.updatedDisplay||e.startHeight!=t.doc.height)&&en(t,e.barMeasure),e.updatedDisplay&&Dn(t,e.barMeasure),e.selectionChanged&&Ar(t),t.state.focused&&e.updateInput&&t.display.input.reset(e.typing),r&&Wr(e.cm)}function fn(e){var t=e.cm,r=t.display,n=t.doc;e.updatedDisplay&&Nn(t,e.update),null==r.wheelStartX||null==e.scrollTop&&null==e.scrollLeft&&!e.scrollToPos||(r.wheelStartX=r.wheelStartY=null),null!=e.scrollTop&&Zr(t,e.scrollTop,e.forceScroll),null!=e.scrollLeft&&Qr(t,e.scrollLeft,!0,!0),e.scrollToPos&&Br(t,Gr(t,U(n,e.scrollToPos.from),U(n,e.scrollToPos.to),e.scrollToPos.margin));var i=e.maybeHiddenMarkers,o=e.maybeUnhiddenMarkers;if(i)for(var l=0;l<i.length;++l)i[l].lines.length||Te(i[l],"hide");if(o)for(var s=0;s<o.length;++s)o[s].lines.length&&Te(o[s],"unhide");r.wrapper.offsetHeight&&(n.scrollTop=t.display.scroller.scrollTop),e.changeObjs&&Te(t,"changes",t,e.changeObjs),e.update&&e.update.finish()}function hn(e,t){if(e.curOp)return t();nn(e);try{return t()}finally{on(e)}}function dn(e,t){return function(){if(e.curOp)return t.apply(e,arguments);nn(e);try{return t.apply(e,arguments)}finally{on(e)}}}function pn(e){return function(){if(this.curOp)return e.apply(this,arguments);nn(this);try{return e.apply(this,arguments)}finally{on(this)}}}function gn(e){return function(){var t=this.cm;if(!t||t.curOp)return e.apply(this,arguments);nn(t);try{return e.apply(this,arguments)}finally{on(t)}}}function vn(e,t,r,n){null==t&&(t=e.doc.first),null==r&&(r=e.doc.first+e.doc.size),n||(n=0);var i=e.display;if(n&&r<i.viewTo&&(null==i.updateLineNumbers||i.updateLineNumbers>t)&&(i.updateLineNumbers=t),e.curOp.viewChanged=!0,t>=i.viewTo)_l&&pe(e.doc,t)<i.viewTo&&yn(e);else if(r<=i.viewFrom)_l&&ge(e.doc,r+n)>i.viewFrom?yn(e):(i.viewFrom+=n,i.viewTo+=n);else if(t<=i.viewFrom&&r>=i.viewTo)yn(e);else if(t<=i.viewFrom){var o=bn(e,r,r+n,1);o?(i.view=i.view.slice(o.index),i.viewFrom=o.lineN,i.viewTo+=n):yn(e)}else if(r>=i.viewTo){var l=bn(e,t,t,-1);l?(i.view=i.view.slice(0,l.index),i.viewTo=l.lineN):yn(e)}else{var s=bn(e,t,t,-1),a=bn(e,r,r+n,1);s&&a?(i.view=i.view.slice(0,s.index).concat(gt(e,s.lineN,a.lineN)).concat(i.view.slice(a.index)),i.viewTo+=n):yn(e)}var u=i.externalMeasured;u&&(r<u.lineN?u.lineN+=n:t<u.lineN+u.size&&(i.externalMeasured=null))}function mn(e,t,r){e.curOp.viewChanged=!0;var n=e.display,i=e.display.externalMeasured;if(i&&t>=i.lineN&&t<i.lineN+i.size&&(n.externalMeasured=null),!(t<n.viewFrom||t>=n.viewTo)){var o=n.view[Lr(e,t)];if(null!=o.node){var l=o.changes||(o.changes=[]);-1==h(l,r)&&l.push(r)}}}function yn(e){e.display.viewFrom=e.display.viewTo=e.doc.first,e.display.view=[],e.display.viewOffset=0}function bn(e,t,r,n){var i,o=Lr(e,t),l=e.display.view;if(!_l||r==e.doc.first+e.doc.size)return{index:o,lineN:r};for(var s=e.display.viewFrom,a=0;a<o;a++)s+=l[a].size;if(s!=t){if(n>0){if(o==l.length-1)return null;i=s+l[o].size-t,o++}else i=s-t;t+=i,r+=i}for(;pe(e.doc,r)!=r;){if(o==(n<0?0:l.length-1))return null;r+=n*l[o-(n<0?1:0)].size,o+=n}return{index:o,lineN:r}}function wn(e,t,r){var n=e.display;0==n.view.length||t>=n.viewTo||r<=n.viewFrom?(n.view=gt(e,t,r),n.viewFrom=t):(n.viewFrom>t?n.view=gt(e,t,n.viewFrom).concat(n.view):n.viewFrom<t&&(n.view=n.view.slice(Lr(e,t))),n.viewFrom=t,n.viewTo<r?n.view=n.view.concat(gt(e,n.viewTo,r)):n.viewTo>r&&(n.view=n.view.slice(0,Lr(e,r)))),n.viewTo=r}function xn(e){for(var t=e.display.view,r=0,n=0;n<t.length;n++){var i=t[n];i.hidden||i.node&&!i.changes||++r}return r}function Cn(e,t){e.doc.highlightFrontier<e.display.viewTo&&e.state.highlight.set(t,u(Sn,e))}function Sn(e){var t=e.doc;if(!(t.highlightFrontier>=e.display.viewTo)){var r=+new Date+e.options.workTime,n=$e(e,t.highlightFrontier),i=[];t.iter(n.line,Math.min(t.first+t.size,e.display.viewTo+500),function(o){if(n.line>=e.display.viewFrom){var l=o.styles,s=o.text.length>e.options.maxHighlightLength?Ke(t.mode,n.state):null,a=Ye(e,o,n,!0);s&&(n.state=s),o.styles=a.styles;var u=o.styleClasses,c=a.classes;c?o.styleClasses=c:u&&(o.styleClasses=null);for(var f=!l||l.length!=o.styles.length||u!=c&&(!u||!c||u.bgClass!=c.bgClass||u.textClass!=c.textClass),h=0;!f&&h<l.length;++h)f=l[h]!=o.styles[h];f&&i.push(n.line),o.stateAfter=n.save(),n.nextLine()}else o.text.length<=e.options.maxHighlightLength&&qe(e,o.text,n),o.stateAfter=n.line%5==0?n.save():null,n.nextLine();if(+new Date>r)return Cn(e,e.options.workDelay),!0}),t.highlightFrontier=n.line,t.modeFrontier=Math.max(t.modeFrontier,n.line),i.length&&hn(e,function(){for(var t=0;t<i.length;t++)mn(e,i[t],"text")})}}function Ln(e){var t=e.display;!t.scrollbarsClipped&&t.scroller.offsetWidth&&(t.nativeBarWidth=t.scroller.offsetWidth-t.scroller.clientWidth,t.heightForcer.style.height=zt(e)+"px",t.sizer.style.marginBottom=-t.nativeBarWidth+"px",t.sizer.style.borderRightWidth=zt(e)+"px",t.scrollbarsClipped=!0)}function kn(e){if(e.hasFocus())return null;var t=l();if(!t||!o(e.display.lineDiv,t))return null;var r={activeElt:t};if(window.getSelection){var n=window.getSelection();n.anchorNode&&n.extend&&o(e.display.lineDiv,n.anchorNode)&&(r.anchorNode=n.anchorNode,r.anchorOffset=n.anchorOffset,r.focusNode=n.focusNode,r.focusOffset=n.focusOffset)}return r}function Tn(e){if(e&&e.activeElt&&e.activeElt!=l()&&(e.activeElt.focus(),e.anchorNode&&o(document.body,e.anchorNode)&&o(document.body,e.focusNode))){var t=window.getSelection(),r=document.createRange();r.setEnd(e.anchorNode,e.anchorOffset),r.collapse(!1),t.removeAllRanges(),t.addRange(r),t.extend(e.focusNode,e.focusOffset)}}function Mn(e,r){var n=e.display,i=e.doc;if(r.editorIsHidden)return yn(e),!1;if(!r.force&&r.visible.from>=n.viewFrom&&r.visible.to<=n.viewTo&&(null==n.updateLineNumbers||n.updateLineNumbers>=n.viewTo)&&n.renderedView==n.view&&0==xn(e))return!1;Rr(e)&&(yn(e),r.dims=br(e));var o=i.first+i.size,l=Math.max(r.visible.from-e.options.viewportMargin,i.first),s=Math.min(o,r.visible.to+e.options.viewportMargin);n.viewFrom<l&&l-n.viewFrom<20&&(l=Math.max(i.first,n.viewFrom)),n.viewTo>s&&n.viewTo-s<20&&(s=Math.min(o,n.viewTo)),_l&&(l=pe(e.doc,l),s=ge(e.doc,s));var a=l!=n.viewFrom||s!=n.viewTo||n.lastWrapHeight!=r.wrapperHeight||n.lastWrapWidth!=r.wrapperWidth;wn(e,l,s),n.viewOffset=ye(M(e.doc,n.viewFrom)),e.display.mover.style.top=n.viewOffset+"px";var u=xn(e);if(!a&&0==u&&!r.force&&n.renderedView==n.view&&(null==n.updateLineNumbers||n.updateLineNumbers>=n.viewTo))return!1;var c=kn(e);return u>4&&(n.lineDiv.style.display="none"),An(e,n.updateLineNumbers,r.dims),u>4&&(n.lineDiv.style.display=""),n.renderedView=n.view,Tn(c),t(n.cursorDiv),t(n.selectionDiv),n.gutters.style.height=n.sizer.style.minHeight=0,a&&(n.lastWrapHeight=r.wrapperHeight,n.lastWrapWidth=r.wrapperWidth,Cn(e,400)),n.updateLineNumbers=null,!0}function Nn(e,t){for(var r=t.viewport,n=!0;(n&&e.options.lineWrapping&&t.oldDisplayWidth!=Rt(e)||(r&&null!=r.top&&(r={top:Math.min(e.doc.height+Pt(e.display)-Bt(e),r.top)}),t.visible=Ir(e.display,e.doc,r),!(t.visible.from>=e.display.viewFrom&&t.visible.to<=e.display.viewTo)))&&Mn(e,t);n=!1){Er(e);var i=Jr(e);kr(e),en(e,i),Dn(e,i),t.force=!1}t.signal(e,"update",e),e.display.viewFrom==e.display.reportedViewFrom&&e.display.viewTo==e.display.reportedViewTo||(t.signal(e,"viewportChange",e,e.display.viewFrom,e.display.viewTo),e.display.reportedViewFrom=e.display.viewFrom,e.display.reportedViewTo=e.display.viewTo)}function On(e,t){var r=new Cs(e,t);if(Mn(e,r)){Er(e),Nn(e,r);var n=Jr(e);kr(e),en(e,n),Dn(e,n),r.finish()}}function An(e,r,n){function i(t){var r=t.nextSibling;return ml&&Ml&&e.display.currentWheelTarget==t?t.style.display="none":t.parentNode.removeChild(t),r}for(var o=e.display,l=e.options.lineNumbers,s=o.lineDiv,a=s.firstChild,u=o.view,c=o.viewFrom,f=0;f<u.length;f++){var d=u[f];if(d.hidden);else if(d.node&&d.node.parentNode==s){for(;a!=d.node;)a=i(a);var p=l&&null!=r&&r<=c&&d.lineNumber;d.changes&&(h(d.changes,"gutter")>-1&&(p=!1),xt(e,d,c,n)),p&&(t(d.lineNumber),d.lineNumber.appendChild(document.createTextNode(F(e.options,c)))),a=d.node.nextSibling}else{var g=Ot(e,d,c,n);s.insertBefore(g,a)}c+=d.size}for(;a;)a=i(a)}function Wn(e){var t=e.display.gutters.offsetWidth;e.display.sizer.style.marginLeft=t+"px"}function Dn(e,t){e.display.sizer.style.minHeight=t.docHeight+"px",e.display.heightForcer.style.top=t.docHeight+"px",e.display.gutters.style.height=t.docHeight+e.display.barHeight+zt(e)+"px"}function Hn(e){var r=e.display.gutters,i=e.options.gutters;t(r);for(var o=0;o<i.length;++o){var l=i[o],s=r.appendChild(n("div",null,"CodeMirror-gutter "+l));"CodeMirror-linenumbers"==l&&(e.display.lineGutter=s,s.style.width=(e.display.lineNumWidth||1)+"px")}r.style.display=o?"":"none",Wn(e)}function Fn(e){var t=h(e.gutters,"CodeMirror-linenumbers");-1==t&&e.lineNumbers?e.gutters=e.gutters.concat(["CodeMirror-linenumbers"]):t>-1&&!e.lineNumbers&&(e.gutters=e.gutters.slice(0),e.gutters.splice(t,1))}function En(e){var t=e.wheelDeltaX,r=e.wheelDeltaY;return null==t&&e.detail&&e.axis==e.HORIZONTAL_AXIS&&(t=e.detail),null==r&&e.detail&&e.axis==e.VERTICAL_AXIS?r=e.detail:null==r&&(r=e.wheelDelta),{x:t,y:r}}function Pn(e){var t=En(e);return t.x*=Ls,t.y*=Ls,t}function In(e,t){var r=En(t),n=r.x,i=r.y,o=e.display,l=o.scroller,s=l.scrollWidth>l.clientWidth,a=l.scrollHeight>l.clientHeight;if(n&&s||i&&a){if(i&&Ml&&ml)e:for(var u=t.target,c=o.view;u!=l;u=u.parentNode)for(var f=0;f<c.length;f++)if(c[f].node==u){e.display.currentWheelTarget=u;break e}if(n&&!fl&&!wl&&null!=Ls)return i&&a&&qr(e,Math.max(0,l.scrollTop+i*Ls)),Qr(e,Math.max(0,l.scrollLeft+n*Ls)),(!i||i&&a)&&We(t),void(o.wheelStartX=null);if(i&&null!=Ls){var h=i*Ls,d=e.doc.scrollTop,p=d+o.wrapper.clientHeight;h<0?d=Math.max(0,d+h-50):p=Math.min(e.doc.height,p+h+50),On(e,{top:d,bottom:p})}Ss<20&&(null==o.wheelStartX?(o.wheelStartX=l.scrollLeft,o.wheelStartY=l.scrollTop,o.wheelDX=n,o.wheelDY=i,setTimeout(function(){if(null!=o.wheelStartX){var e=l.scrollLeft-o.wheelStartX,t=l.scrollTop-o.wheelStartY,r=t&&o.wheelDY&&t/o.wheelDY||e&&o.wheelDX&&e/o.wheelDX;o.wheelStartX=o.wheelStartY=null,r&&(Ls=(Ls*Ss+r)/(Ss+1),++Ss)}},200)):(o.wheelDX+=n,o.wheelDY+=i))}}function zn(e,t){var r=e[t];e.sort(function(e,t){return P(e.from(),t.from())}),t=h(e,r);for(var n=1;n<e.length;n++){var i=e[n],o=e[n-1];if(P(o.to(),i.from())>=0){var l=B(o.from(),i.from()),s=R(o.to(),i.to()),a=o.empty()?i.from()==i.head:o.from()==o.head;n<=t&&--t,e.splice(--n,2,new Ts(a?s:l,a?l:s))}}return new ks(e,t)}function Rn(e,t){return new ks([new Ts(e,t||e)],0)}function Bn(e){return e.text?E(e.from.line+e.text.length-1,g(e.text).length+(1==e.text.length?e.from.ch:0)):e.to}function Gn(e,t){if(P(e,t.from)<0)return e;if(P(e,t.to)<=0)return Bn(t);var r=e.line+t.text.length-(t.to.line-t.from.line)-1,n=e.ch;return e.line==t.to.line&&(n+=Bn(t).ch-t.to.ch),E(r,n)}function Un(e,t){for(var r=[],n=0;n<e.sel.ranges.length;n++){var i=e.sel.ranges[n];r.push(new Ts(Gn(i.anchor,t),Gn(i.head,t)))}return zn(r,e.sel.primIndex)}function Vn(e,t,r){return e.line==t.line?E(r.line,e.ch-t.ch+r.ch):E(r.line+(e.line-t.line),e.ch)}function Kn(e,t,r){for(var n=[],i=E(e.first,0),o=i,l=0;l<t.length;l++){var s=t[l],a=Vn(s.from,i,o),u=Vn(Bn(s),i,o);if(i=s.to,o=u,"around"==r){var c=e.sel.ranges[l],f=P(c.head,c.anchor)<0;n[l]=new Ts(f?u:a,f?a:u)}else n[l]=new Ts(a,a)}return new ks(n,e.sel.primIndex)}function jn(e){e.doc.mode=Ue(e.options,e.doc.modeOption),Xn(e)}function Xn(e){e.doc.iter(function(e){e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null)}),e.doc.modeFrontier=e.doc.highlightFrontier=e.doc.first,Cn(e,100),e.state.modeGen++,e.curOp&&vn(e)}function Yn(e,t){return 0==t.from.ch&&0==t.to.ch&&""==g(t.text)&&(!e.cm||e.cm.options.wholeLineUpdateBefore)}function _n(e,t,r,n){function i(e){return r?r[e]:null}function o(e,r,i){it(e,r,i,n),bt(e,"change",e,t)}function l(e,t){for(var r=[],o=e;o<t;++o)r.push(new fs(u[o],i(o),n));return r}var s=t.from,a=t.to,u=t.text,c=M(e,s.line),f=M(e,a.line),h=g(u),d=i(u.length-1),p=a.line-s.line;if(t.full)e.insert(0,l(0,u.length)),e.remove(u.length,e.size-u.length);else if(Yn(e,t)){var v=l(0,u.length-1);o(f,f.text,d),p&&e.remove(s.line,p),v.length&&e.insert(s.line,v)}else if(c==f)if(1==u.length)o(c,c.text.slice(0,s.ch)+h+c.text.slice(a.ch),d);else{var m=l(1,u.length-1);m.push(new fs(h+c.text.slice(a.ch),d,n)),o(c,c.text.slice(0,s.ch)+u[0],i(0)),e.insert(s.line+1,m)}else if(1==u.length)o(c,c.text.slice(0,s.ch)+u[0]+f.text.slice(a.ch),i(0)),e.remove(s.line+1,p);else{o(c,c.text.slice(0,s.ch)+u[0],i(0)),o(f,h+f.text.slice(a.ch),d);var y=l(1,u.length-1);p>1&&e.remove(s.line+1,p-1),e.insert(s.line+1,y)}bt(e,"change",e,t)}function $n(e,t,r){function n(e,i,o){if(e.linked)for(var l=0;l<e.linked.length;++l){var s=e.linked[l];if(s.doc!=i){var a=o&&s.sharedHist;r&&!a||(t(s.doc,a),n(s.doc,e,a))}}}n(e,null,!0)}function qn(e,t){if(t.cm)throw new Error("This document is already in use.");e.doc=t,t.cm=e,Cr(e),jn(e),Zn(e),e.options.lineWrapping||we(e),e.options.mode=t.modeOption,vn(e)}function Zn(e){("rtl"==e.doc.direction?s:Fl)(e.display.lineDiv,"CodeMirror-rtl")}function Qn(e){hn(e,function(){Zn(e),vn(e)})}function Jn(e){this.done=[],this.undone=[],this.undoDepth=1/0,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=e||1}function ei(e,t){var r={from:z(t.from),to:Bn(t),text:N(e,t.from,t.to)};return si(e,r,t.from.line,t.to.line+1),$n(e,function(e){return si(e,r,t.from.line,t.to.line+1)},!0),r}function ti(e){for(;e.length&&g(e).ranges;)e.pop()}function ri(e,t){return t?(ti(e.done),g(e.done)):e.done.length&&!g(e.done).ranges?g(e.done):e.done.length>1&&!e.done[e.done.length-2].ranges?(e.done.pop(),g(e.done)):void 0}function ni(e,t,r,n){var i=e.history;i.undone.length=0;var o,l,s=+new Date;if((i.lastOp==n||i.lastOrigin==t.origin&&t.origin&&("+"==t.origin.charAt(0)&&e.cm&&i.lastModTime>s-e.cm.options.historyEventDelay||"*"==t.origin.charAt(0)))&&(o=ri(i,i.lastOp==n)))l=g(o.changes),0==P(t.from,t.to)&&0==P(t.from,l.to)?l.to=Bn(t):o.changes.push(ei(e,t));else{var a=g(i.done);for(a&&a.ranges||li(e.sel,i.done),o={changes:[ei(e,t)],generation:i.generation},i.done.push(o);i.done.length>i.undoDepth;)i.done.shift(),i.done[0].ranges||i.done.shift()}i.done.push(r),i.generation=++i.maxGeneration,i.lastModTime=i.lastSelTime=s,i.lastOp=i.lastSelOp=n,i.lastOrigin=i.lastSelOrigin=t.origin,l||Te(e,"historyAdded")}function ii(e,t,r,n){var i=t.charAt(0);return"*"==i||"+"==i&&r.ranges.length==n.ranges.length&&r.somethingSelected()==n.somethingSelected()&&new Date-e.history.lastSelTime<=(e.cm?e.cm.options.historyEventDelay:500)}function oi(e,t,r,n){var i=e.history,o=n&&n.origin;r==i.lastSelOp||o&&i.lastSelOrigin==o&&(i.lastModTime==i.lastSelTime&&i.lastOrigin==o||ii(e,o,g(i.done),t))?i.done[i.done.length-1]=t:li(t,i.done),i.lastSelTime=+new Date,i.lastSelOrigin=o,i.lastSelOp=r,n&&!1!==n.clearRedo&&ti(i.undone)}function li(e,t){var r=g(t);r&&r.ranges&&r.equals(e)||t.push(e)}function si(e,t,r,n){var i=t["spans_"+e.id],o=0;e.iter(Math.max(e.first,r),Math.min(e.first+e.size,n),function(r){r.markedSpans&&((i||(i=t["spans_"+e.id]={}))[o]=r.markedSpans),++o})}function ai(e){if(!e)return null;for(var t,r=0;r<e.length;++r)e[r].marker.explicitlyCleared?t||(t=e.slice(0,r)):t&&t.push(e[r]);return t?t.length?t:null:e}function ui(e,t){var r=t["spans_"+e.id];if(!r)return null;for(var n=[],i=0;i<t.text.length;++i)n.push(ai(r[i]));return n}function ci(e,t){var r=ui(e,t),n=J(e,t);if(!r)return n;if(!n)return r;for(var i=0;i<r.length;++i){var o=r[i],l=n[i];if(o&&l)e:for(var s=0;s<l.length;++s){for(var a=l[s],u=0;u<o.length;++u)if(o[u].marker==a.marker)continue e;o.push(a)}else l&&(r[i]=l)}return r}function fi(e,t,r){for(var n=[],i=0;i<e.length;++i){var o=e[i];if(o.ranges)n.push(r?ks.prototype.deepCopy.call(o):o);else{var l=o.changes,s=[];n.push({changes:s});for(var a=0;a<l.length;++a){var u=l[a],c=void 0;if(s.push({from:u.from,to:u.to,text:u.text}),t)for(var f in u)(c=f.match(/^spans_(\d+)$/))&&h(t,Number(c[1]))>-1&&(g(s)[f]=u[f],delete u[f])}}}return n}function hi(e,t,r,n){if(n){var i=e.anchor;if(r){var o=P(t,i)<0;o!=P(r,i)<0?(i=t,t=r):o!=P(t,r)<0&&(t=r)}return new Ts(i,t)}return new Ts(r||t,t)}function di(e,t,r,n,i){null==i&&(i=e.cm&&(e.cm.display.shift||e.extend)),bi(e,new ks([hi(e.sel.primary(),t,r,i)],0),n)}function pi(e,t,r){for(var n=[],i=e.cm&&(e.cm.display.shift||e.extend),o=0;o<e.sel.ranges.length;o++)n[o]=hi(e.sel.ranges[o],t[o],null,i);bi(e,zn(n,e.sel.primIndex),r)}function gi(e,t,r,n){var i=e.sel.ranges.slice(0);i[t]=r,bi(e,zn(i,e.sel.primIndex),n)}function vi(e,t,r,n){bi(e,Rn(t,r),n)}function mi(e,t,r){var n={ranges:t.ranges,update:function(t){var r=this;this.ranges=[];for(var n=0;n<t.length;n++)r.ranges[n]=new Ts(U(e,t[n].anchor),U(e,t[n].head))},origin:r&&r.origin};return Te(e,"beforeSelectionChange",e,n),e.cm&&Te(e.cm,"beforeSelectionChange",e.cm,n),n.ranges!=t.ranges?zn(n.ranges,n.ranges.length-1):t}function yi(e,t,r){var n=e.history.done,i=g(n);i&&i.ranges?(n[n.length-1]=t,wi(e,t,r)):bi(e,t,r)}function bi(e,t,r){wi(e,t,r),oi(e,e.sel,e.cm?e.cm.curOp.id:NaN,r)}function wi(e,t,r){(Oe(e,"beforeSelectionChange")||e.cm&&Oe(e.cm,"beforeSelectionChange"))&&(t=mi(e,t,r)),xi(e,Si(e,t,r&&r.bias||(P(t.primary().head,e.sel.primary().head)<0?-1:1),!0)),r&&!1===r.scroll||!e.cm||jr(e.cm)}function xi(e,t){t.equals(e.sel)||(e.sel=t,e.cm&&(e.cm.curOp.updateInput=e.cm.curOp.selectionChanged=!0,Ne(e.cm)),bt(e,"cursorActivity",e))}function Ci(e){xi(e,Si(e,e.sel,null,!1))}function Si(e,t,r,n){for(var i,o=0;o<t.ranges.length;o++){var l=t.ranges[o],s=t.ranges.length==e.sel.ranges.length&&e.sel.ranges[o],a=ki(e,l.anchor,s&&s.anchor,r,n),u=ki(e,l.head,s&&s.head,r,n);(i||a!=l.anchor||u!=l.head)&&(i||(i=t.ranges.slice(0,o)),i[o]=new Ts(a,u))}return i?zn(i,t.primIndex):t}function Li(e,t,r,n,i){var o=M(e,t.line);if(o.markedSpans)for(var l=0;l<o.markedSpans.length;++l){var s=o.markedSpans[l],a=s.marker;if((null==s.from||(a.inclusiveLeft?s.from<=t.ch:s.from<t.ch))&&(null==s.to||(a.inclusiveRight?s.to>=t.ch:s.to>t.ch))){if(i&&(Te(a,"beforeCursorEnter"),a.explicitlyCleared)){if(o.markedSpans){--l;continue}break}if(!a.atomic)continue;if(r){var u=a.find(n<0?1:-1),c=void 0;if((n<0?a.inclusiveRight:a.inclusiveLeft)&&(u=Ti(e,u,-n,u&&u.line==t.line?o:null)),u&&u.line==t.line&&(c=P(u,r))&&(n<0?c<0:c>0))return Li(e,u,t,n,i)}var f=a.find(n<0?-1:1);return(n<0?a.inclusiveLeft:a.inclusiveRight)&&(f=Ti(e,f,n,f.line==t.line?o:null)),f?Li(e,f,t,n,i):null}}return t}function ki(e,t,r,n,i){var o=n||1,l=Li(e,t,r,o,i)||!i&&Li(e,t,r,o,!0)||Li(e,t,r,-o,i)||!i&&Li(e,t,r,-o,!0);return l||(e.cantEdit=!0,E(e.first,0))}function Ti(e,t,r,n){return r<0&&0==t.ch?t.line>e.first?U(e,E(t.line-1)):null:r>0&&t.ch==(n||M(e,t.line)).text.length?t.line<e.first+e.size-1?E(t.line+1,0):null:new E(t.line,t.ch+r)}function Mi(e){e.setSelection(E(e.firstLine(),0),E(e.lastLine()),Gl)}function Ni(e,t,r){var n={canceled:!1,from:t.from,to:t.to,text:t.text,origin:t.origin,cancel:function(){return n.canceled=!0}};return r&&(n.update=function(t,r,i,o){t&&(n.from=U(e,t)),r&&(n.to=U(e,r)),i&&(n.text=i),void 0!==o&&(n.origin=o)}),Te(e,"beforeChange",e,n),e.cm&&Te(e.cm,"beforeChange",e.cm,n),n.canceled?null:{from:n.from,to:n.to,text:n.text,origin:n.origin}}function Oi(e,t,r){if(e.cm){if(!e.cm.curOp)return dn(e.cm,Oi)(e,t,r);if(e.cm.state.suppressEdits)return}if(!(Oe(e,"beforeChange")||e.cm&&Oe(e.cm,"beforeChange"))||(t=Ni(e,t,!0))){var n=Yl&&!r&&te(e,t.from,t.to);if(n)for(var i=n.length-1;i>=0;--i)Ai(e,{from:n[i].from,to:n[i].to,text:i?[""]:t.text,origin:t.origin});else Ai(e,t)}}function Ai(e,t){if(1!=t.text.length||""!=t.text[0]||0!=P(t.from,t.to)){var r=Un(e,t);ni(e,t,r,e.cm?e.cm.curOp.id:NaN),Hi(e,t,r,J(e,t));var n=[];$n(e,function(e,r){r||-1!=h(n,e.history)||(zi(e.history,t),n.push(e.history)),Hi(e,t,null,J(e,t))})}}function Wi(e,t,r){if(!e.cm||!e.cm.state.suppressEdits||r){for(var n,i=e.history,o=e.sel,l="undo"==t?i.done:i.undone,s="undo"==t?i.undone:i.done,a=0;a<l.length&&(n=l[a],r?!n.ranges||n.equals(e.sel):n.ranges);a++);if(a!=l.length){for(i.lastOrigin=i.lastSelOrigin=null;(n=l.pop()).ranges;){if(li(n,s),r&&!n.equals(e.sel))return void bi(e,n,{clearRedo:!1});o=n}var u=[];li(o,s),s.push({changes:u,generation:i.generation}),i.generation=n.generation||++i.maxGeneration;for(var c=Oe(e,"beforeChange")||e.cm&&Oe(e.cm,"beforeChange"),f=n.changes.length-1;f>=0;--f){var d=function(r){var i=n.changes[r];if(i.origin=t,c&&!Ni(e,i,!1))return l.length=0,{};u.push(ei(e,i));var o=r?Un(e,i):g(l);Hi(e,i,o,ci(e,i)),!r&&e.cm&&e.cm.scrollIntoView({from:i.from,to:Bn(i)});var s=[];$n(e,function(e,t){t||-1!=h(s,e.history)||(zi(e.history,i),s.push(e.history)),Hi(e,i,null,ci(e,i))})}(f);if(d)return d.v}}}}function Di(e,t){if(0!=t&&(e.first+=t,e.sel=new ks(v(e.sel.ranges,function(e){return new Ts(E(e.anchor.line+t,e.anchor.ch),E(e.head.line+t,e.head.ch))}),e.sel.primIndex),e.cm)){vn(e.cm,e.first,e.first-t,t);for(var r=e.cm.display,n=r.viewFrom;n<r.viewTo;n++)mn(e.cm,n,"gutter")}}function Hi(e,t,r,n){if(e.cm&&!e.cm.curOp)return dn(e.cm,Hi)(e,t,r,n);if(t.to.line<e.first)Di(e,t.text.length-1-(t.to.line-t.from.line));else if(!(t.from.line>e.lastLine())){if(t.from.line<e.first){var i=t.text.length-1-(e.first-t.from.line);Di(e,i),t={from:E(e.first,0),to:E(t.to.line+i,t.to.ch),text:[g(t.text)],origin:t.origin}}var o=e.lastLine();t.to.line>o&&(t={from:t.from,to:E(o,M(e,o).text.length),text:[t.text[0]],origin:t.origin}),t.removed=N(e,t.from,t.to),r||(r=Un(e,t)),e.cm?Fi(e.cm,t,n):_n(e,t,n),wi(e,r,Gl)}}function Fi(e,t,r){var n=e.doc,i=e.display,o=t.from,l=t.to,s=!1,a=o.line;e.options.lineWrapping||(a=W(fe(M(n,o.line))),n.iter(a,l.line+1,function(e){if(e==i.maxLine)return s=!0,!0})),n.sel.contains(t.from,t.to)>-1&&Ne(e),_n(n,t,r,xr(e)),e.options.lineWrapping||(n.iter(a,o.line+t.text.length,function(e){var t=be(e);t>i.maxLineLength&&(i.maxLine=e,i.maxLineLength=t,i.maxLineChanged=!0,s=!1)}),s&&(e.curOp.updateMaxLine=!0)),nt(n,o.line),Cn(e,400);var u=t.text.length-(l.line-o.line)-1;t.full?vn(e):o.line!=l.line||1!=t.text.length||Yn(e.doc,t)?vn(e,o.line,l.line+1,u):mn(e,o.line,"text");var c=Oe(e,"changes"),f=Oe(e,"change");if(f||c){var h={from:o,to:l,text:t.text,removed:t.removed,origin:t.origin};f&&bt(e,"change",e,h),c&&(e.curOp.changeObjs||(e.curOp.changeObjs=[])).push(h)}e.display.selForContextMenu=null}function Ei(e,t,r,n,i){if(n||(n=r),P(n,r)<0){var o;r=(o=[n,r])[0],n=o[1]}"string"==typeof t&&(t=e.splitLines(t)),Oi(e,{from:r,to:n,text:t,origin:i})}function Pi(e,t,r,n){r<e.line?e.line+=n:t<e.line&&(e.line=t,e.ch=0)}function Ii(e,t,r,n){for(var i=0;i<e.length;++i){var o=e[i],l=!0;if(o.ranges){o.copied||((o=e[i]=o.deepCopy()).copied=!0);for(var s=0;s<o.ranges.length;s++)Pi(o.ranges[s].anchor,t,r,n),Pi(o.ranges[s].head,t,r,n)}else{for(var a=0;a<o.changes.length;++a){var u=o.changes[a];if(r<u.from.line)u.from=E(u.from.line+n,u.from.ch),u.to=E(u.to.line+n,u.to.ch);else if(t<=u.to.line){l=!1;break}}l||(e.splice(0,i+1),i=0)}}}function zi(e,t){var r=t.from.line,n=t.to.line,i=t.text.length-(n-r)-1;Ii(e.done,r,n,i),Ii(e.undone,r,n,i)}function Ri(e,t,r,n){var i=t,o=t;return"number"==typeof t?o=M(e,G(e,t)):i=W(t),null==i?null:(n(o,i)&&e.cm&&mn(e.cm,i,r),o)}function Bi(e){var t=this;this.lines=e,this.parent=null;for(var r=0,n=0;n<e.length;++n)e[n].parent=t,r+=e[n].height;this.height=r}function Gi(e){var t=this;this.children=e;for(var r=0,n=0,i=0;i<e.length;++i){var o=e[i];r+=o.chunkSize(),n+=o.height,o.parent=t}this.size=r,this.height=n,this.parent=null}function Ui(e,t,r){ye(t)<(e.curOp&&e.curOp.scrollTop||e.doc.scrollTop)&&Kr(e,r)}function Vi(e,t,r,n){var i=new Ms(e,r,n),o=e.cm;return o&&i.noHScroll&&(o.display.alignWidgets=!0),Ri(e,t,"widget",function(t){var r=t.widgets||(t.widgets=[]);if(null==i.insertAt?r.push(i):r.splice(Math.min(r.length-1,Math.max(0,i.insertAt)),0,i),i.line=t,o&&!ve(e,t)){var n=ye(t)<e.scrollTop;A(t,t.height+Ht(i)),n&&Kr(o,i.height),o.curOp.forceUpdate=!0}return!0}),bt(o,"lineWidgetAdded",o,i,"number"==typeof t?t:W(t)),i}function Ki(e,t,r,n,o){if(n&&n.shared)return ji(e,t,r,n,o);if(e.cm&&!e.cm.curOp)return dn(e.cm,Ki)(e,t,r,n,o);var l=new Os(e,o),s=P(t,r);if(n&&c(n,l,!1),s>0||0==s&&!1!==l.clearWhenEmpty)return l;if(l.replacedWith&&(l.collapsed=!0,l.widgetNode=i("span",[l.replacedWith],"CodeMirror-widget"),n.handleMouseEvents||l.widgetNode.setAttribute("cm-ignore-events","true"),n.insertLeft&&(l.widgetNode.insertLeft=!0)),l.collapsed){if(ce(e,t.line,t,r,l)||t.line!=r.line&&ce(e,r.line,t,r,l))throw new Error("Inserting collapsed marker partially overlapping an existing one");X()}l.addToHistory&&ni(e,{from:t,to:r,origin:"markText"},e.sel,NaN);var a,u=t.line,f=e.cm;if(e.iter(u,r.line+1,function(e){f&&l.collapsed&&!f.options.lineWrapping&&fe(e)==f.display.maxLine&&(a=!0),l.collapsed&&u!=t.line&&A(e,0),q(e,new Y(l,u==t.line?t.ch:null,u==r.line?r.ch:null)),++u}),l.collapsed&&e.iter(t.line,r.line+1,function(t){ve(e,t)&&A(t,0)}),l.clearOnEnter&&Ql(l,"beforeCursorEnter",function(){return l.clear()}),l.readOnly&&(j(),(e.history.done.length||e.history.undone.length)&&e.clearHistory()),l.collapsed&&(l.id=++Ns,l.atomic=!0),f){if(a&&(f.curOp.updateMaxLine=!0),l.collapsed)vn(f,t.line,r.line+1);else if(l.className||l.title||l.startStyle||l.endStyle||l.css)for(var h=t.line;h<=r.line;h++)mn(f,h,"text");l.atomic&&Ci(f.doc),bt(f,"markerAdded",f,l)}return l}function ji(e,t,r,n,i){(n=c(n)).shared=!1;var o=[Ki(e,t,r,n,i)],l=o[0],s=n.widgetNode;return $n(e,function(e){s&&(n.widgetNode=s.cloneNode(!0)),o.push(Ki(e,U(e,t),U(e,r),n,i));for(var a=0;a<e.linked.length;++a)if(e.linked[a].isParent)return;l=g(o)}),new As(o,l)}function Xi(e){return e.findMarks(E(e.first,0),e.clipPos(E(e.lastLine())),function(e){return e.parent})}function Yi(e,t){for(var r=0;r<t.length;r++){var n=t[r],i=n.find(),o=e.clipPos(i.from),l=e.clipPos(i.to);if(P(o,l)){var s=Ki(e,o,l,n.primary,n.primary.type);n.markers.push(s),s.parent=n}}}function _i(e){for(var t=0;t<e.length;t++)!function(t){var r=e[t],n=[r.primary.doc];$n(r.primary.doc,function(e){return n.push(e)});for(var i=0;i<r.markers.length;i++){var o=r.markers[i];-1==h(n,o.doc)&&(o.parent=null,r.markers.splice(i--,1))}}(t)}function $i(e){var t=this;if(Qi(t),!Me(t,e)&&!Ft(t.display,e)){We(e),gl&&(Hs=+new Date);var r=Sr(t,e,!0),n=e.dataTransfer.files;if(r&&!t.isReadOnly())if(n&&n.length&&window.FileReader&&window.File)for(var i=n.length,o=Array(i),l=0,s=0;s<i;++s)!function(e,n){if(!t.options.allowDropFileTypes||-1!=h(t.options.allowDropFileTypes,e.type)){var s=new FileReader;s.onload=dn(t,function(){var e=s.result;if(/[\x00-\x08\x0e-\x1f]{2}/.test(e)&&(e=""),o[n]=e,++l==i){var a={from:r=U(t.doc,r),to:r,text:t.doc.splitLines(o.join(t.doc.lineSeparator())),origin:"paste"};Oi(t.doc,a),yi(t.doc,Rn(r,Bn(a)))}}),s.readAsText(e)}}(n[s],s);else{if(t.state.draggingText&&t.doc.sel.contains(r)>-1)return t.state.draggingText(e),void setTimeout(function(){return t.display.input.focus()},20);try{var a=e.dataTransfer.getData("Text");if(a){var u;if(t.state.draggingText&&!t.state.draggingText.copy&&(u=t.listSelections()),wi(t.doc,Rn(r,r)),u)for(var c=0;c<u.length;++c)Ei(t.doc,"",u[c].anchor,u[c].head,"drag");t.replaceSelection(a,"around","paste"),t.display.input.focus()}}catch(e){}}}}function qi(e,t){if(gl&&(!e.state.draggingText||+new Date-Hs<100))Fe(t);else if(!Me(e,t)&&!Ft(e.display,t)&&(t.dataTransfer.setData("Text",e.getSelection()),t.dataTransfer.effectAllowed="copyMove",t.dataTransfer.setDragImage&&!xl)){var r=n("img",null,null,"position: fixed; left: 0; top: 0;");r.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",wl&&(r.width=r.height=1,e.display.wrapper.appendChild(r),r._top=r.offsetTop),t.dataTransfer.setDragImage(r,0,0),wl&&r.parentNode.removeChild(r)}}function Zi(e,t){var i=Sr(e,t);if(i){var o=document.createDocumentFragment();Mr(e,i,o),e.display.dragCursor||(e.display.dragCursor=n("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),e.display.lineSpace.insertBefore(e.display.dragCursor,e.display.cursorDiv)),r(e.display.dragCursor,o)}}function Qi(e){e.display.dragCursor&&(e.display.lineSpace.removeChild(e.display.dragCursor),e.display.dragCursor=null)}function Ji(e){if(document.getElementsByClassName)for(var t=document.getElementsByClassName("CodeMirror"),r=0;r<t.length;r++){var n=t[r].CodeMirror;n&&e(n)}}function eo(){Fs||(to(),Fs=!0)}function to(){var e;Ql(window,"resize",function(){null==e&&(e=setTimeout(function(){e=null,Ji(ro)},100))}),Ql(window,"blur",function(){return Ji(Fr)})}function ro(e){var t=e.display;t.lastWrapHeight==t.wrapper.clientHeight&&t.lastWrapWidth==t.wrapper.clientWidth||(t.cachedCharWidth=t.cachedTextHeight=t.cachedPaddingH=null,t.scrollbarsClipped=!1,e.setSize())}function no(e){var t=e.split(/-(?!$)/);e=t[t.length-1];for(var r,n,i,o,l=0;l<t.length-1;l++){var s=t[l];if(/^(cmd|meta|m)$/i.test(s))o=!0;else if(/^a(lt)?$/i.test(s))r=!0;else if(/^(c|ctrl|control)$/i.test(s))n=!0;else{if(!/^s(hift)?$/i.test(s))throw new Error("Unrecognized modifier name: "+s);i=!0}}return r&&(e="Alt-"+e),n&&(e="Ctrl-"+e),o&&(e="Cmd-"+e),i&&(e="Shift-"+e),e}function io(e){var t={};for(var r in e)if(e.hasOwnProperty(r)){var n=e[r];if(/^(name|fallthrough|(de|at)tach)$/.test(r))continue;if("..."==n){delete e[r];continue}for(var i=v(r.split(" "),no),o=0;o<i.length;o++){var l=void 0,s=void 0;o==i.length-1?(s=i.join(" "),l=n):(s=i.slice(0,o+1).join(" "),l="...");var a=t[s];if(a){if(a!=l)throw new Error("Inconsistent bindings for "+s)}else t[s]=l}delete e[r]}for(var u in t)e[u]=t[u];return e}function oo(e,t,r,n){var i=(t=uo(t)).call?t.call(e,n):t[e];if(!1===i)return"nothing";if("..."===i)return"multi";if(null!=i&&r(i))return"handled";if(t.fallthrough){if("[object Array]"!=Object.prototype.toString.call(t.fallthrough))return oo(e,t.fallthrough,r,n);for(var o=0;o<t.fallthrough.length;o++){var l=oo(e,t.fallthrough[o],r,n);if(l)return l}}}function lo(e){var t="string"==typeof e?e:Es[e.keyCode];return"Ctrl"==t||"Alt"==t||"Shift"==t||"Mod"==t}function so(e,t,r){var n=e;return t.altKey&&"Alt"!=n&&(e="Alt-"+e),(Dl?t.metaKey:t.ctrlKey)&&"Ctrl"!=n&&(e="Ctrl-"+e),(Dl?t.ctrlKey:t.metaKey)&&"Cmd"!=n&&(e="Cmd-"+e),!r&&t.shiftKey&&"Shift"!=n&&(e="Shift-"+e),e}function ao(e,t){if(wl&&34==e.keyCode&&e.char)return!1;var r=Es[e.keyCode];return null!=r&&!e.altGraphKey&&so(r,e,t)}function uo(e){return"string"==typeof e?Rs[e]:e}function co(e,t){for(var r=e.doc.sel.ranges,n=[],i=0;i<r.length;i++){for(var o=t(r[i]);n.length&&P(o.from,g(n).to)<=0;){var l=n.pop();if(P(l.from,o.from)<0){o.from=l.from;break}}n.push(o)}hn(e,function(){for(var t=n.length-1;t>=0;t--)Ei(e.doc,"",n[t].from,n[t].to,"+delete");jr(e)})}function fo(e,t,r){var n=L(e.text,t+r,r);return n<0||n>e.text.length?null:n}function ho(e,t,r){var n=fo(e,t.ch,r);return null==n?null:new E(t.line,n,r<0?"after":"before")}function po(e,t,r,n,i){if(e){var o=Se(r,t.doc.direction);if(o){var l,s=i<0?g(o):o[0],a=i<0==(1==s.level)?"after":"before";if(s.level>0){var u=Xt(t,r);l=i<0?r.text.length-1:0;var c=Yt(t,u,l).top;l=k(function(e){return Yt(t,u,e).top==c},i<0==(1==s.level)?s.from:s.to-1,l),"before"==a&&(l=fo(r,l,1))}else l=i<0?s.to:s.from;return new E(n,l,a)}}return new E(n,i<0?r.text.length:0,i<0?"before":"after")}function go(e,t,r,n){var i=Se(t,e.doc.direction);if(!i)return ho(t,r,n);r.ch>=t.text.length?(r.ch=t.text.length,r.sticky="before"):r.ch<=0&&(r.ch=0,r.sticky="after");var o=Ce(i,r.ch,r.sticky),l=i[o];if("ltr"==e.doc.direction&&l.level%2==0&&(n>0?l.to>r.ch:l.from<r.ch))return ho(t,r,n);var s,a=function(e,r){return fo(t,e instanceof E?e.ch:e,r)},u=function(r){return e.options.lineWrapping?(s=s||Xt(e,t),hr(e,t,s,r)):{begin:0,end:t.text.length}},c=u("before"==r.sticky?a(r,-1):r.ch);if("rtl"==e.doc.direction||1==l.level){var f=1==l.level==n<0,h=a(r,f?1:-1);if(null!=h&&(f?h<=l.to&&h<=c.end:h>=l.from&&h>=c.begin)){var d=f?"before":"after";return new E(r.line,h,d)}}var p=function(e,t,n){for(var o=function(e,t){return t?new E(r.line,a(e,1),"before"):new E(r.line,e,"after")};e>=0&&e<i.length;e+=t){var l=i[e],s=t>0==(1!=l.level),u=s?n.begin:a(n.end,-1);if(l.from<=u&&u<l.to)return o(u,s);if(u=s?l.from:a(l.to,-1),n.begin<=u&&u<n.end)return o(u,s)}},g=p(o+n,n,c);if(g)return g;var v=n>0?c.end:a(c.begin,-1);return null==v||n>0&&v==t.text.length||!(g=p(n>0?0:i.length-1,n,u(v)))?null:g}function vo(e,t){var r=M(e.doc,t),n=fe(r);return n!=r&&(t=W(n)),po(!0,e,n,t,1)}function mo(e,t){var r=M(e.doc,t),n=he(r);return n!=r&&(t=W(n)),po(!0,e,r,t,-1)}function yo(e,t){var r=vo(e,t.line),n=M(e.doc,r.line),i=Se(n,e.doc.direction);if(!i||0==i[0].level){var o=Math.max(0,n.text.search(/\S/)),l=t.line==r.line&&t.ch<=o&&t.ch;return E(r.line,l?0:o,r.sticky)}return r}function bo(e,t,r){if("string"==typeof t&&!(t=Bs[t]))return!1;e.display.input.ensurePolled();var n=e.display.shift,i=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),r&&(e.display.shift=!1),i=t(e)!=Bl}finally{e.display.shift=n,e.state.suppressEdits=!1}return i}function wo(e,t,r){for(var n=0;n<e.state.keyMaps.length;n++){var i=oo(t,e.state.keyMaps[n],r,e);if(i)return i}return e.options.extraKeys&&oo(t,e.options.extraKeys,r,e)||oo(t,e.options.keyMap,r,e)}function xo(e,t,r,n){var i=e.state.keySeq;if(i){if(lo(t))return"handled";Gs.set(50,function(){e.state.keySeq==i&&(e.state.keySeq=null,e.display.input.reset())}),t=i+" "+t}var o=wo(e,t,n);return"multi"==o&&(e.state.keySeq=t),"handled"==o&&bt(e,"keyHandled",e,t,r),"handled"!=o&&"multi"!=o||(We(r),Ar(e)),i&&!o&&/\'$/.test(t)?(We(r),!0):!!o}function Co(e,t){var r=ao(t,!0);return!!r&&(t.shiftKey&&!e.state.keySeq?xo(e,"Shift-"+r,t,function(t){return bo(e,t,!0)})||xo(e,r,t,function(t){if("string"==typeof t?/^go[A-Z]/.test(t):t.motion)return bo(e,t)}):xo(e,r,t,function(t){return bo(e,t)}))}function So(e,t,r){return xo(e,"'"+r+"'",t,function(t){return bo(e,t,!0)})}function Lo(e){var t=this;if(t.curOp.focus=l(),!Me(t,e)){gl&&vl<11&&27==e.keyCode&&(e.returnValue=!1);var r=e.keyCode;t.display.shift=16==r||e.shiftKey;var n=Co(t,e);wl&&(Us=n?r:null,!n&&88==r&&!rs&&(Ml?e.metaKey:e.ctrlKey)&&t.replaceSelection("",null,"cut")),18!=r||/\bCodeMirror-crosshair\b/.test(t.display.lineDiv.className)||ko(t)}}function ko(e){function t(e){18!=e.keyCode&&e.altKey||(Fl(r,"CodeMirror-crosshair"),ke(document,"keyup",t),ke(document,"mouseover",t))}var r=e.display.lineDiv;s(r,"CodeMirror-crosshair"),Ql(document,"keyup",t),Ql(document,"mouseover",t)}function To(e){16==e.keyCode&&(this.doc.sel.shift=!1),Me(this,e)}function Mo(e){var t=this;if(!(Ft(t.display,e)||Me(t,e)||e.ctrlKey&&!e.altKey||Ml&&e.metaKey)){var r=e.keyCode,n=e.charCode;if(wl&&r==Us)return Us=null,void We(e);if(!wl||e.which&&!(e.which<10)||!Co(t,e)){var i=String.fromCharCode(null==n?r:n);"\b"!=i&&(So(t,e,i)||t.display.input.onKeyPress(e))}}}function No(e,t){var r=+new Date;return js&&js.compare(r,e,t)?(Ks=js=null,"triple"):Ks&&Ks.compare(r,e,t)?(js=new Vs(r,e,t),Ks=null,"double"):(Ks=new Vs(r,e,t),js=null,"single")}function Oo(e){var t=this,r=t.display;if(!(Me(t,e)||r.activeTouch&&r.input.supportsTouch()))if(r.input.ensurePolled(),r.shift=e.shiftKey,Ft(r,e))ml||(r.scroller.draggable=!1,setTimeout(function(){return r.scroller.draggable=!0},100));else if(!zo(t,e)){var n=Sr(t,e),i=Pe(e),o=n?No(n,i):"single";window.focus(),1==i&&t.state.selectingText&&t.state.selectingText(e),n&&Ao(t,i,n,o,e)||(1==i?n?Do(t,n,o,e):Ee(e)==r.scroller&&We(e):2==i?(n&&di(t.doc,n),setTimeout(function(){return r.input.focus()},20)):3==i&&(Hl?Ro(t,e):Dr(t)))}}function Ao(e,t,r,n,i){var o="Click";return"double"==n?o="Double"+o:"triple"==n&&(o="Triple"+o),o=(1==t?"Left":2==t?"Middle":"Right")+o,xo(e,so(o,i),i,function(t){if("string"==typeof t&&(t=Bs[t]),!t)return!1;var n=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),n=t(e,r)!=Bl}finally{e.state.suppressEdits=!1}return n})}function Wo(e,t,r){var n=e.getOption("configureMouse"),i=n?n(e,t,r):{};if(null==i.unit){var o=Nl?r.shiftKey&&r.metaKey:r.altKey;i.unit=o?"rectangle":"single"==t?"char":"double"==t?"word":"line"}return(null==i.extend||e.doc.extend)&&(i.extend=e.doc.extend||r.shiftKey),null==i.addNew&&(i.addNew=Ml?r.metaKey:r.ctrlKey),null==i.moveOnDrag&&(i.moveOnDrag=!(Ml?r.altKey:r.ctrlKey)),i}function Do(e,t,r,n){gl?setTimeout(u(Wr,e),0):e.curOp.focus=l();var i,o=Wo(e,r,n),s=e.doc.sel;e.options.dragDrop&&Jl&&!e.isReadOnly()&&"single"==r&&(i=s.contains(t))>-1&&(P((i=s.ranges[i]).from(),t)<0||t.xRel>0)&&(P(i.to(),t)>0||t.xRel<0)?Ho(e,n,t,o):Eo(e,n,t,o)}function Ho(e,t,r,n){var i=e.display,o=!1,l=dn(e,function(t){ml&&(i.scroller.draggable=!1),e.state.draggingText=!1,ke(document,"mouseup",l),ke(document,"mousemove",s),ke(i.scroller,"dragstart",a),ke(i.scroller,"drop",l),o||(We(t),n.addNew||di(e.doc,r,null,null,n.extend),ml||gl&&9==vl?setTimeout(function(){document.body.focus(),i.input.focus()},20):i.input.focus())}),s=function(e){o=o||Math.abs(t.clientX-e.clientX)+Math.abs(t.clientY-e.clientY)>=10},a=function(){return o=!0};ml&&(i.scroller.draggable=!0),e.state.draggingText=l,l.copy=!n.moveOnDrag,i.scroller.dragDrop&&i.scroller.dragDrop(),Ql(document,"mouseup",l),Ql(document,"mousemove",s),Ql(i.scroller,"dragstart",a),Ql(i.scroller,"drop",l),Dr(e),setTimeout(function(){return i.input.focus()},20)}function Fo(e,t,r){if("char"==r)return new Ts(t,t);if("word"==r)return e.findWordAt(t);if("line"==r)return new Ts(E(t.line,0),U(e.doc,E(t.line+1,0)));var n=r(e,t);return new Ts(n.from,n.to)}function Eo(e,t,r,n){function i(t){if(0!=P(m,t))if(m=t,"rectangle"==n.unit){for(var i=[],o=e.options.tabSize,l=f(M(u,r.line).text,r.ch,o),s=f(M(u,t.line).text,t.ch,o),a=Math.min(l,s),g=Math.max(l,s),v=Math.min(r.line,t.line),y=Math.min(e.lastLine(),Math.max(r.line,t.line));v<=y;v++){var b=M(u,v).text,w=d(b,a,o);a==g?i.push(new Ts(E(v,w),E(v,w))):b.length>w&&i.push(new Ts(E(v,w),E(v,d(b,g,o))))}i.length||i.push(new Ts(r,r)),bi(u,zn(p.ranges.slice(0,h).concat(i),h),{origin:"*mouse",scroll:!1}),e.scrollIntoView(t)}else{var x,C=c,S=Fo(e,t,n.unit),L=C.anchor;P(S.anchor,L)>0?(x=S.head,L=B(C.from(),S.anchor)):(x=S.anchor,L=R(C.to(),S.head));var k=p.ranges.slice(0);k[h]=Po(e,new Ts(U(u,L),x)),bi(u,zn(k,h),Ul)}}function o(t){var r=++b,s=Sr(e,t,!0,"rectangle"==n.unit);if(s)if(0!=P(s,m)){e.curOp.focus=l(),i(s);var c=Ir(a,u);(s.line>=c.to||s.line<c.from)&&setTimeout(dn(e,function(){b==r&&o(t)}),150)}else{var f=t.clientY<y.top?-20:t.clientY>y.bottom?20:0;f&&setTimeout(dn(e,function(){b==r&&(a.scroller.scrollTop+=f,o(t))}),50)}}function s(t){e.state.selectingText=!1,b=1/0,We(t),a.input.focus(),ke(document,"mousemove",w),ke(document,"mouseup",x),u.history.lastSelOrigin=null}var a=e.display,u=e.doc;We(t);var c,h,p=u.sel,g=p.ranges;if(n.addNew&&!n.extend?(h=u.sel.contains(r),c=h>-1?g[h]:new Ts(r,r)):(c=u.sel.primary(),h=u.sel.primIndex),"rectangle"==n.unit)n.addNew||(c=new Ts(r,r)),r=Sr(e,t,!0,!0),h=-1;else{var v=Fo(e,r,n.unit);c=n.extend?hi(c,v.anchor,v.head,n.extend):v}n.addNew?-1==h?(h=g.length,bi(u,zn(g.concat([c]),h),{scroll:!1,origin:"*mouse"})):g.length>1&&g[h].empty()&&"char"==n.unit&&!n.extend?(bi(u,zn(g.slice(0,h).concat(g.slice(h+1)),0),{scroll:!1,origin:"*mouse"}),p=u.sel):gi(u,h,c,Ul):(h=0,bi(u,new ks([c],0),Ul),p=u.sel);var m=r,y=a.wrapper.getBoundingClientRect(),b=0,w=dn(e,function(e){Pe(e)?o(e):s(e)}),x=dn(e,s);e.state.selectingText=x,Ql(document,"mousemove",w),Ql(document,"mouseup",x)}function Po(e,t){var r=t.anchor,n=t.head,i=M(e.doc,r.line);if(0==P(r,n)&&r.sticky==n.sticky)return t;var o=Se(i);if(!o)return t;var l=Ce(o,r.ch,r.sticky),s=o[l];if(s.from!=r.ch&&s.to!=r.ch)return t;var a=l+(s.from==r.ch==(1!=s.level)?0:1);if(0==a||a==o.length)return t;var u;if(n.line!=r.line)u=(n.line-r.line)*("ltr"==e.doc.direction?1:-1)>0;else{var c=Ce(o,n.ch,n.sticky),f=c-l||(n.ch-r.ch)*(1==s.level?-1:1);u=c==a-1||c==a?f<0:f>0}var h=o[a+(u?-1:0)],d=u==(1==h.level),p=d?h.from:h.to,g=d?"after":"before";return r.ch==p&&r.sticky==g?t:new Ts(new E(r.line,p,g),n)}function Io(e,t,r,n){var i,o;if(t.touches)i=t.touches[0].clientX,o=t.touches[0].clientY;else try{i=t.clientX,o=t.clientY}catch(t){return!1}if(i>=Math.floor(e.display.gutters.getBoundingClientRect().right))return!1;n&&We(t);var l=e.display,s=l.lineDiv.getBoundingClientRect();if(o>s.bottom||!Oe(e,r))return He(t);o-=s.top-l.viewOffset;for(var a=0;a<e.options.gutters.length;++a){var u=l.gutters.childNodes[a];if(u&&u.getBoundingClientRect().right>=i)return Te(e,r,e,D(e.doc,o),e.options.gutters[a],t),He(t)}}function zo(e,t){return Io(e,t,"gutterClick",!0)}function Ro(e,t){Ft(e.display,t)||Bo(e,t)||Me(e,t,"contextmenu")||e.display.input.onContextMenu(t)}function Bo(e,t){return!!Oe(e,"gutterContextMenu")&&Io(e,t,"gutterContextMenu",!1)}function Go(e){e.display.wrapper.className=e.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+e.options.theme.replace(/(^|\s)\s*/g," cm-s-"),er(e)}function Uo(e){Hn(e),vn(e),zr(e)}function Vo(e,t,r){if(!t!=!(r&&r!=Xs)){var n=e.display.dragFunctions,i=t?Ql:ke;i(e.display.scroller,"dragstart",n.start),i(e.display.scroller,"dragenter",n.enter),i(e.display.scroller,"dragover",n.over),i(e.display.scroller,"dragleave",n.leave),i(e.display.scroller,"drop",n.drop)}}function Ko(e){e.options.lineWrapping?(s(e.display.wrapper,"CodeMirror-wrap"),e.display.sizer.style.minWidth="",e.display.sizerWidth=null):(Fl(e.display.wrapper,"CodeMirror-wrap"),we(e)),Cr(e),vn(e),er(e),setTimeout(function(){return en(e)},100)}function jo(e,t){var r=this;if(!(this instanceof jo))return new jo(e,t);this.options=t=t?c(t):{},c(Ys,t,!1),Fn(t);var n=t.value;"string"==typeof n&&(n=new Ds(n,t.mode,null,t.lineSeparator,t.direction)),this.doc=n;var i=new jo.inputStyles[t.inputStyle](this),o=this.display=new T(e,n,i);o.wrapper.CodeMirror=this,Hn(this),Go(this),t.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),rn(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,delayingBlurEvent:!1,focused:!1,suppressEdits:!1,pasteIncoming:!1,cutIncoming:!1,selectingText:!1,draggingText:!1,highlight:new Pl,keySeq:null,specialChars:null},t.autofocus&&!Tl&&o.input.focus(),gl&&vl<11&&setTimeout(function(){return r.display.input.reset(!0)},20),Xo(this),eo(),nn(this),this.curOp.forceUpdate=!0,qn(this,n),t.autofocus&&!Tl||this.hasFocus()?setTimeout(u(Hr,this),20):Fr(this);for(var l in _s)_s.hasOwnProperty(l)&&_s[l](r,t[l],Xs);Rr(this),t.finishInit&&t.finishInit(this);for(var s=0;s<$s.length;++s)$s[s](r);on(this),ml&&t.lineWrapping&&"optimizelegibility"==getComputedStyle(o.lineDiv).textRendering&&(o.lineDiv.style.textRendering="auto")}function Xo(e){function t(){i.activeTouch&&(o=setTimeout(function(){return i.activeTouch=null},1e3),(l=i.activeTouch).end=+new Date)}function r(e){if(1!=e.touches.length)return!1;var t=e.touches[0];return t.radiusX<=1&&t.radiusY<=1}function n(e,t){if(null==t.left)return!0;var r=t.left-e.left,n=t.top-e.top;return r*r+n*n>400}var i=e.display;Ql(i.scroller,"mousedown",dn(e,Oo)),gl&&vl<11?Ql(i.scroller,"dblclick",dn(e,function(t){if(!Me(e,t)){var r=Sr(e,t);if(r&&!zo(e,t)&&!Ft(e.display,t)){We(t);var n=e.findWordAt(r);di(e.doc,n.anchor,n.head)}}})):Ql(i.scroller,"dblclick",function(t){return Me(e,t)||We(t)}),Hl||Ql(i.scroller,"contextmenu",function(t){return Ro(e,t)});var o,l={end:0};Ql(i.scroller,"touchstart",function(t){if(!Me(e,t)&&!r(t)&&!zo(e,t)){i.input.ensurePolled(),clearTimeout(o);var n=+new Date;i.activeTouch={start:n,moved:!1,prev:n-l.end<=300?l:null},1==t.touches.length&&(i.activeTouch.left=t.touches[0].pageX,i.activeTouch.top=t.touches[0].pageY)}}),Ql(i.scroller,"touchmove",function(){i.activeTouch&&(i.activeTouch.moved=!0)}),Ql(i.scroller,"touchend",function(r){var o=i.activeTouch;if(o&&!Ft(i,r)&&null!=o.left&&!o.moved&&new Date-o.start<300){var l,s=e.coordsChar(i.activeTouch,"page");l=!o.prev||n(o,o.prev)?new Ts(s,s):!o.prev.prev||n(o,o.prev.prev)?e.findWordAt(s):new Ts(E(s.line,0),U(e.doc,E(s.line+1,0))),e.setSelection(l.anchor,l.head),e.focus(),We(r)}t()}),Ql(i.scroller,"touchcancel",t),Ql(i.scroller,"scroll",function(){i.scroller.clientHeight&&(qr(e,i.scroller.scrollTop),Qr(e,i.scroller.scrollLeft,!0),Te(e,"scroll",e))}),Ql(i.scroller,"mousewheel",function(t){return In(e,t)}),Ql(i.scroller,"DOMMouseScroll",function(t){return In(e,t)}),Ql(i.wrapper,"scroll",function(){return i.wrapper.scrollTop=i.wrapper.scrollLeft=0}),i.dragFunctions={enter:function(t){Me(e,t)||Fe(t)},over:function(t){Me(e,t)||(Zi(e,t),Fe(t))},start:function(t){return qi(e,t)},drop:dn(e,$i),leave:function(t){Me(e,t)||Qi(e)}};var s=i.input.getField();Ql(s,"keyup",function(t){return To.call(e,t)}),Ql(s,"keydown",dn(e,Lo)),Ql(s,"keypress",dn(e,Mo)),Ql(s,"focus",function(t){return Hr(e,t)}),Ql(s,"blur",function(t){return Fr(e,t)})}function Yo(e,t,r,n){var i,o=e.doc;null==r&&(r="add"),"smart"==r&&(o.mode.indent?i=$e(e,t).state:r="prev");var l=e.options.tabSize,s=M(o,t),a=f(s.text,null,l);s.stateAfter&&(s.stateAfter=null);var u,c=s.text.match(/^\s*/)[0];if(n||/\S/.test(s.text)){if("smart"==r&&((u=o.mode.indent(i,s.text.slice(c.length),s.text))==Bl||u>150)){if(!n)return;r="prev"}}else u=0,r="not";"prev"==r?u=t>o.first?f(M(o,t-1).text,null,l):0:"add"==r?u=a+e.options.indentUnit:"subtract"==r?u=a-e.options.indentUnit:"number"==typeof r&&(u=a+r),u=Math.max(0,u);var h="",d=0;if(e.options.indentWithTabs)for(var g=Math.floor(u/l);g;--g)d+=l,h+="\t";if(d<u&&(h+=p(u-d)),h!=c)return Ei(o,h,E(t,0),E(t,c.length),"+input"),s.stateAfter=null,!0;for(var v=0;v<o.sel.ranges.length;v++){var m=o.sel.ranges[v];if(m.head.line==t&&m.head.ch<c.length){var y=E(t,c.length);gi(o,v,new Ts(y,y));break}}}function _o(e){qs=e}function $o(e,t,r,n,i){var o=e.doc;e.display.shift=!1,n||(n=o.sel);var l=e.state.pasteIncoming||"paste"==i,s=es(t),a=null;if(l&&n.ranges.length>1)if(qs&&qs.text.join("\n")==t){if(n.ranges.length%qs.text.length==0){a=[];for(var u=0;u<qs.text.length;u++)a.push(o.splitLines(qs.text[u]))}}else s.length==n.ranges.length&&e.options.pasteLinesPerSelection&&(a=v(s,function(e){return[e]}));for(var c,f=n.ranges.length-1;f>=0;f--){var h=n.ranges[f],d=h.from(),p=h.to();h.empty()&&(r&&r>0?d=E(d.line,d.ch-r):e.state.overwrite&&!l?p=E(p.line,Math.min(M(o,p.line).text.length,p.ch+g(s).length)):qs&&qs.lineWise&&qs.text.join("\n")==t&&(d=p=E(d.line,0))),c=e.curOp.updateInput;var m={from:d,to:p,text:a?a[f%a.length]:s,origin:i||(l?"paste":e.state.cutIncoming?"cut":"+input")};Oi(e.doc,m),bt(e,"inputRead",e,m)}t&&!l&&Zo(e,t),jr(e),e.curOp.updateInput=c,e.curOp.typing=!0,e.state.pasteIncoming=e.state.cutIncoming=!1}function qo(e,t){var r=e.clipboardData&&e.clipboardData.getData("Text");if(r)return e.preventDefault(),t.isReadOnly()||t.options.disableInput||hn(t,function(){return $o(t,r,0,null,"paste")}),!0}function Zo(e,t){if(e.options.electricChars&&e.options.smartIndent)for(var r=e.doc.sel,n=r.ranges.length-1;n>=0;n--){var i=r.ranges[n];if(!(i.head.ch>100||n&&r.ranges[n-1].head.line==i.head.line)){var o=e.getModeAt(i.head),l=!1;if(o.electricChars){for(var s=0;s<o.electricChars.length;s++)if(t.indexOf(o.electricChars.charAt(s))>-1){l=Yo(e,i.head.line,"smart");break}}else o.electricInput&&o.electricInput.test(M(e.doc,i.head.line).text.slice(0,i.head.ch))&&(l=Yo(e,i.head.line,"smart"));l&&bt(e,"electricInput",e,i.head.line)}}}function Qo(e){for(var t=[],r=[],n=0;n<e.doc.sel.ranges.length;n++){var i=e.doc.sel.ranges[n].head.line,o={anchor:E(i,0),head:E(i+1,0)};r.push(o),t.push(e.getRange(o.anchor,o.head))}return{text:t,ranges:r}}function Jo(e,t){e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!!t)}function el(){var e=n("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; outline: none"),t=n("div",[e],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return ml?e.style.width="1000px":e.setAttribute("wrap","off"),Ll&&(e.style.border="1px solid black"),Jo(e),t}function tl(e,t,r,n,i){function o(){var n=t.line+r;return!(n<e.first||n>=e.first+e.size)&&(t=new E(n,t.ch,t.sticky),u=M(e,n))}function l(n){var l;if(null==(l=i?go(e.cm,u,t,r):ho(u,t,r))){if(n||!o())return!1;t=po(i,e.cm,u,t.line,r)}else t=l;return!0}var s=t,a=r,u=M(e,t.line);if("char"==n)l();else if("column"==n)l(!0);else if("word"==n||"group"==n)for(var c=null,f="group"==n,h=e.cm&&e.cm.getHelper(t,"wordChars"),d=!0;!(r<0)||l(!d);d=!1){var p=u.text.charAt(t.ch)||"\n",g=x(p,h)?"w":f&&"\n"==p?"n":!f||/\s/.test(p)?null:"p";if(!f||d||g||(g="s"),c&&c!=g){r<0&&(r=1,l(),t.sticky="after");break}if(g&&(c=g),r>0&&!l(!d))break}var v=ki(e,t,s,a,!0);return I(s,v)&&(v.hitSide=!0),v}function rl(e,t,r,n){var i,o=e.doc,l=t.left;if("page"==n){var s=Math.min(e.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight),a=Math.max(s-.5*mr(e.display),3);i=(r>0?t.bottom:t.top)+r*a}else"line"==n&&(i=r>0?t.bottom+3:t.top-3);for(var u;(u=cr(e,l,i)).outside;){if(r<0?i<=0:i>=o.height){u.hitSide=!0;break}i+=5*r}return u}function nl(e,t){var r=jt(e,t.line);if(!r||r.hidden)return null;var n=M(e.doc,t.line),i=Ut(r,n,t.line),o=Se(n,e.doc.direction),l="left";o&&(l=Ce(o,t.ch)%2?"right":"left");var s=_t(i.map,t.ch,l);return s.offset="right"==s.collapse?s.end:s.start,s}function il(e){for(var t=e;t;t=t.parentNode)if(/CodeMirror-gutter-wrapper/.test(t.className))return!0;return!1}function ol(e,t){return t&&(e.bad=!0),e}function ll(e,t,r,n,i){function o(e){return function(t){return t.id==e}}function l(){c&&(u+=f,c=!1)}function s(e){e&&(l(),u+=e)}function a(t){if(1==t.nodeType){var r=t.getAttribute("cm-text");if(null!=r)return void s(r||t.textContent.replace(/\u200b/g,""));var u,h=t.getAttribute("cm-marker");if(h){var d=e.findMarks(E(n,0),E(i+1,0),o(+h));return void(d.length&&(u=d[0].find(0))&&s(N(e.doc,u.from,u.to).join(f)))}if("false"==t.getAttribute("contenteditable"))return;var p=/^(pre|div|p)$/i.test(t.nodeName);p&&l();for(var g=0;g<t.childNodes.length;g++)a(t.childNodes[g]);p&&(c=!0)}else 3==t.nodeType&&s(t.nodeValue)}for(var u="",c=!1,f=e.doc.lineSeparator();a(t),t!=r;)t=t.nextSibling;return u}function sl(e,t,r){var n;if(t==e.display.lineDiv){if(!(n=e.display.lineDiv.childNodes[r]))return ol(e.clipPos(E(e.display.viewTo-1)),!0);t=null,r=0}else for(n=t;;n=n.parentNode){if(!n||n==e.display.lineDiv)return null;if(n.parentNode&&n.parentNode==e.display.lineDiv)break}for(var i=0;i<e.display.view.length;i++){var o=e.display.view[i];if(o.node==n)return al(o,t,r)}}function al(e,t,r){function n(t,r,n){for(var i=-1;i<(f?f.length:0);i++)for(var o=i<0?c.map:f[i],l=0;l<o.length;l+=3){var s=o[l+2];if(s==t||s==r){var a=W(i<0?e.line:e.rest[i]),u=o[l]+n;return(n<0||s!=t)&&(u=o[l+(n?1:0)]),E(a,u)}}}var i=e.text.firstChild,l=!1;if(!t||!o(i,t))return ol(E(W(e.line),0),!0);if(t==i&&(l=!0,t=i.childNodes[r],r=0,!t)){var s=e.rest?g(e.rest):e.line;return ol(E(W(s),s.text.length),l)}var a=3==t.nodeType?t:null,u=t;for(a||1!=t.childNodes.length||3!=t.firstChild.nodeType||(a=t.firstChild,r&&(r=a.nodeValue.length));u.parentNode!=i;)u=u.parentNode;var c=e.measure,f=c.maps,h=n(a,u,r);if(h)return ol(h,l);for(var d=u.nextSibling,p=a?a.nodeValue.length-r:0;d;d=d.nextSibling){if(h=n(d,d.firstChild,0))return ol(E(h.line,h.ch-p),l);p+=d.textContent.length}for(var v=u.previousSibling,m=r;v;v=v.previousSibling){if(h=n(v,v.firstChild,-1))return ol(E(h.line,h.ch+m),l);m+=v.textContent.length}}var ul=navigator.userAgent,cl=navigator.platform,fl=/gecko\/\d/i.test(ul),hl=/MSIE \d/.test(ul),dl=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(ul),pl=/Edge\/(\d+)/.exec(ul),gl=hl||dl||pl,vl=gl&&(hl?document.documentMode||6:+(pl||dl)[1]),ml=!pl&&/WebKit\//.test(ul),yl=ml&&/Qt\/\d+\.\d+/.test(ul),bl=!pl&&/Chrome\//.test(ul),wl=/Opera\//.test(ul),xl=/Apple Computer/.test(navigator.vendor),Cl=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(ul),Sl=/PhantomJS/.test(ul),Ll=!pl&&/AppleWebKit/.test(ul)&&/Mobile\/\w+/.test(ul),kl=/Android/.test(ul),Tl=Ll||kl||/webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(ul),Ml=Ll||/Mac/.test(cl),Nl=/\bCrOS\b/.test(ul),Ol=/win/i.test(cl),Al=wl&&ul.match(/Version\/(\d*\.\d*)/);Al&&(Al=Number(Al[1])),Al&&Al>=15&&(wl=!1,ml=!0);var Wl,Dl=Ml&&(yl||wl&&(null==Al||Al<12.11)),Hl=fl||gl&&vl>=9,Fl=function(t,r){var n=t.className,i=e(r).exec(n);if(i){var o=n.slice(i.index+i[0].length);t.className=n.slice(0,i.index)+(o?i[1]+o:"")}};Wl=document.createRange?function(e,t,r,n){var i=document.createRange();return i.setEnd(n||e,r),i.setStart(e,t),i}:function(e,t,r){var n=document.body.createTextRange();try{n.moveToElementText(e.parentNode)}catch(e){return n}return n.collapse(!0),n.moveEnd("character",r),n.moveStart("character",t),n};var El=function(e){e.select()};Ll?El=function(e){e.selectionStart=0,e.selectionEnd=e.value.length}:gl&&(El=function(e){try{e.select()}catch(e){}});var Pl=function(){this.id=null};Pl.prototype.set=function(e,t){clearTimeout(this.id),this.id=setTimeout(t,e)};var Il,zl,Rl=30,Bl={toString:function(){return"CodeMirror.Pass"}},Gl={scroll:!1},Ul={origin:"*mouse"},Vl={origin:"+move"},Kl=[""],jl=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/,Xl=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/,Yl=!1,_l=!1,$l=null,ql=function(){function e(e){return e<=247?r.charAt(e):1424<=e&&e<=1524?"R":1536<=e&&e<=1785?n.charAt(e-1536):1774<=e&&e<=2220?"r":8192<=e&&e<=8203?"w":8204==e?"b":"L"}function t(e,t,r){this.level=e,this.from=t,this.to=r}var r="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",n="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111",i=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,o=/[stwN]/,l=/[LRr]/,s=/[Lb1n]/,a=/[1n]/;return function(r,n){var u="ltr"==n?"L":"R";if(0==r.length||"ltr"==n&&!i.test(r))return!1;for(var c=r.length,f=[],h=0;h<c;++h)f.push(e(r.charCodeAt(h)));for(var d=0,p=u;d<c;++d){var v=f[d];"m"==v?f[d]=p:p=v}for(var m=0,y=u;m<c;++m){var b=f[m];"1"==b&&"r"==y?f[m]="n":l.test(b)&&(y=b,"r"==b&&(f[m]="R"))}for(var w=1,x=f[0];w<c-1;++w){var C=f[w];"+"==C&&"1"==x&&"1"==f[w+1]?f[w]="1":","!=C||x!=f[w+1]||"1"!=x&&"n"!=x||(f[w]=x),x=C}for(var S=0;S<c;++S){var L=f[S];if(","==L)f[S]="N";else if("%"==L){var k=void 0;for(k=S+1;k<c&&"%"==f[k];++k);for(var T=S&&"!"==f[S-1]||k<c&&"1"==f[k]?"1":"N",M=S;M<k;++M)f[M]=T;S=k-1}}for(var N=0,O=u;N<c;++N){var A=f[N];"L"==O&&"1"==A?f[N]="L":l.test(A)&&(O=A)}for(var W=0;W<c;++W)if(o.test(f[W])){var D=void 0;for(D=W+1;D<c&&o.test(f[D]);++D);for(var H="L"==(W?f[W-1]:u),F=H==("L"==(D<c?f[D]:u))?H?"L":"R":u,E=W;E<D;++E)f[E]=F;W=D-1}for(var P,I=[],z=0;z<c;)if(s.test(f[z])){var R=z;for(++z;z<c&&s.test(f[z]);++z);I.push(new t(0,R,z))}else{var B=z,G=I.length;for(++z;z<c&&"L"!=f[z];++z);for(var U=B;U<z;)if(a.test(f[U])){B<U&&I.splice(G,0,new t(1,B,U));var V=U;for(++U;U<z&&a.test(f[U]);++U);I.splice(G,0,new t(2,V,U)),B=U}else++U;B<z&&I.splice(G,0,new t(1,B,z))}return 1==I[0].level&&(P=r.match(/^\s+/))&&(I[0].from=P[0].length,I.unshift(new t(0,0,P[0].length))),1==g(I).level&&(P=r.match(/\s+$/))&&(g(I).to-=P[0].length,I.push(new t(0,c-P[0].length,c))),"rtl"==n?I.reverse():I}}(),Zl=[],Ql=function(e,t,r){if(e.addEventListener)e.addEventListener(t,r,!1);else if(e.attachEvent)e.attachEvent("on"+t,r);else{var n=e._handlers||(e._handlers={});n[t]=(n[t]||Zl).concat(r)}},Jl=function(){if(gl&&vl<9)return!1;var e=n("div");return"draggable"in e||"dragDrop"in e}(),es=3!="\n\nb".split(/\n/).length?function(e){for(var t=0,r=[],n=e.length;t<=n;){var i=e.indexOf("\n",t);-1==i&&(i=e.length);var o=e.slice(t,"\r"==e.charAt(i-1)?i-1:i),l=o.indexOf("\r");-1!=l?(r.push(o.slice(0,l)),t+=l+1):(r.push(o),t=i+1)}return r}:function(e){return e.split(/\r\n?|\n/)},ts=window.getSelection?function(e){try{return e.selectionStart!=e.selectionEnd}catch(e){return!1}}:function(e){var t;try{t=e.ownerDocument.selection.createRange()}catch(e){}return!(!t||t.parentElement()!=e)&&0!=t.compareEndPoints("StartToEnd",t)},rs=function(){var e=n("div");return"oncopy"in e||(e.setAttribute("oncopy","return;"),"function"==typeof e.oncopy)}(),ns=null,is={},os={},ls={},ss=function(e,t,r){this.pos=this.start=0,this.string=e,this.tabSize=t||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0,this.lineOracle=r};ss.prototype.eol=function(){return this.pos>=this.string.length},ss.prototype.sol=function(){return this.pos==this.lineStart},ss.prototype.peek=function(){return this.string.charAt(this.pos)||void 0},ss.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},ss.prototype.eat=function(e){var t=this.string.charAt(this.pos);if("string"==typeof e?t==e:t&&(e.test?e.test(t):e(t)))return++this.pos,t},ss.prototype.eatWhile=function(e){for(var t=this.pos;this.eat(e););return this.pos>t},ss.prototype.eatSpace=function(){for(var e=this,t=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++e.pos;return this.pos>t},ss.prototype.skipToEnd=function(){this.pos=this.string.length},ss.prototype.skipTo=function(e){var t=this.string.indexOf(e,this.pos);if(t>-1)return this.pos=t,!0},ss.prototype.backUp=function(e){this.pos-=e},ss.prototype.column=function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=f(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?f(this.string,this.lineStart,this.tabSize):0)},ss.prototype.indentation=function(){return f(this.string,null,this.tabSize)-(this.lineStart?f(this.string,this.lineStart,this.tabSize):0)},ss.prototype.match=function(e,t,r){if("string"!=typeof e){var n=this.string.slice(this.pos).match(e);return n&&n.index>0?null:(n&&!1!==t&&(this.pos+=n[0].length),n)}var i=function(e){return r?e.toLowerCase():e};if(i(this.string.substr(this.pos,e.length))==i(e))return!1!==t&&(this.pos+=e.length),!0},ss.prototype.current=function(){return this.string.slice(this.start,this.pos)},ss.prototype.hideFirstChars=function(e,t){this.lineStart+=e;try{return t()}finally{this.lineStart-=e}},ss.prototype.lookAhead=function(e){var t=this.lineOracle;return t&&t.lookAhead(e)};var as=function(e,t){this.state=e,this.lookAhead=t},us=function(e,t,r,n){this.state=t,this.doc=e,this.line=r,this.maxLookAhead=n||0};us.prototype.lookAhead=function(e){var t=this.doc.getLine(this.line+e);return null!=t&&e>this.maxLookAhead&&(this.maxLookAhead=e),t},us.prototype.nextLine=function(){this.line++,this.maxLookAhead>0&&this.maxLookAhead--},us.fromSaved=function(e,t,r){return t instanceof as?new us(e,Ke(e.mode,t.state),r,t.lookAhead):new us(e,Ke(e.mode,t),r)},us.prototype.save=function(e){var t=!1!==e?Ke(this.doc.mode,this.state):this.state;return this.maxLookAhead>0?new as(t,this.maxLookAhead):t};var cs=function(e,t,r){this.start=e.start,this.end=e.pos,this.string=e.current(),this.type=t||null,this.state=r},fs=function(e,t,r){this.text=e,ne(this,t),this.height=r?r(this):1};fs.prototype.lineNo=function(){return W(this)},Ae(fs);var hs,ds={},ps={},gs=null,vs=null,ms={left:0,right:0,top:0,bottom:0},ys=function(e,t,r){this.cm=r;var i=this.vert=n("div",[n("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),o=this.horiz=n("div",[n("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");e(i),e(o),Ql(i,"scroll",function(){i.clientHeight&&t(i.scrollTop,"vertical")}),Ql(o,"scroll",function(){o.clientWidth&&t(o.scrollLeft,"horizontal")}),this.checkedZeroWidth=!1,gl&&vl<8&&(this.horiz.style.minHeight=this.vert.style.minWidth="18px")};ys.prototype.update=function(e){var t=e.scrollWidth>e.clientWidth+1,r=e.scrollHeight>e.clientHeight+1,n=e.nativeBarWidth;if(r){this.vert.style.display="block",this.vert.style.bottom=t?n+"px":"0";var i=e.viewHeight-(t?n:0);this.vert.firstChild.style.height=Math.max(0,e.scrollHeight-e.clientHeight+i)+"px"}else this.vert.style.display="",this.vert.firstChild.style.height="0";if(t){this.horiz.style.display="block",this.horiz.style.right=r?n+"px":"0",this.horiz.style.left=e.barLeft+"px";var o=e.viewWidth-e.barLeft-(r?n:0);this.horiz.firstChild.style.width=Math.max(0,e.scrollWidth-e.clientWidth+o)+"px"}else this.horiz.style.display="",this.horiz.firstChild.style.width="0";return!this.checkedZeroWidth&&e.clientHeight>0&&(0==n&&this.zeroWidthHack(),this.checkedZeroWidth=!0),{right:r?n:0,bottom:t?n:0}},ys.prototype.setScrollLeft=function(e){this.horiz.scrollLeft!=e&&(this.horiz.scrollLeft=e),this.disableHoriz&&this.enableZeroWidthBar(this.horiz,this.disableHoriz,"horiz")},ys.prototype.setScrollTop=function(e){this.vert.scrollTop!=e&&(this.vert.scrollTop=e),this.disableVert&&this.enableZeroWidthBar(this.vert,this.disableVert,"vert")},ys.prototype.zeroWidthHack=function(){var e=Ml&&!Cl?"12px":"18px";this.horiz.style.height=this.vert.style.width=e,this.horiz.style.pointerEvents=this.vert.style.pointerEvents="none",this.disableHoriz=new Pl,this.disableVert=new Pl},ys.prototype.enableZeroWidthBar=function(e,t,r){function n(){var i=e.getBoundingClientRect();("vert"==r?document.elementFromPoint(i.right-1,(i.top+i.bottom)/2):document.elementFromPoint((i.right+i.left)/2,i.bottom-1))!=e?e.style.pointerEvents="none":t.set(1e3,n)}e.style.pointerEvents="auto",t.set(1e3,n)},ys.prototype.clear=function(){var e=this.horiz.parentNode;e.removeChild(this.horiz),e.removeChild(this.vert)};var bs=function(){};bs.prototype.update=function(){return{bottom:0,right:0}},bs.prototype.setScrollLeft=function(){},bs.prototype.setScrollTop=function(){},bs.prototype.clear=function(){};var ws={native:ys,null:bs},xs=0,Cs=function(e,t,r){var n=e.display;this.viewport=t,this.visible=Ir(n,e.doc,t),this.editorIsHidden=!n.wrapper.offsetWidth,this.wrapperHeight=n.wrapper.clientHeight,this.wrapperWidth=n.wrapper.clientWidth,this.oldDisplayWidth=Rt(e),this.force=r,this.dims=br(e),this.events=[]};Cs.prototype.signal=function(e,t){Oe(e,t)&&this.events.push(arguments)},Cs.prototype.finish=function(){for(var e=this,t=0;t<this.events.length;t++)Te.apply(null,e.events[t])};var Ss=0,Ls=null;gl?Ls=-.53:fl?Ls=15:bl?Ls=-.7:xl&&(Ls=-1/3);var ks=function(e,t){this.ranges=e,this.primIndex=t};ks.prototype.primary=function(){return this.ranges[this.primIndex]},ks.prototype.equals=function(e){var t=this;if(e==this)return!0;if(e.primIndex!=this.primIndex||e.ranges.length!=this.ranges.length)return!1;for(var r=0;r<this.ranges.length;r++){var n=t.ranges[r],i=e.ranges[r];if(!I(n.anchor,i.anchor)||!I(n.head,i.head))return!1}return!0},ks.prototype.deepCopy=function(){for(var e=this,t=[],r=0;r<this.ranges.length;r++)t[r]=new Ts(z(e.ranges[r].anchor),z(e.ranges[r].head));return new ks(t,this.primIndex)},ks.prototype.somethingSelected=function(){for(var e=this,t=0;t<this.ranges.length;t++)if(!e.ranges[t].empty())return!0;return!1},ks.prototype.contains=function(e,t){var r=this;t||(t=e);for(var n=0;n<this.ranges.length;n++){var i=r.ranges[n];if(P(t,i.from())>=0&&P(e,i.to())<=0)return n}return-1};var Ts=function(e,t){this.anchor=e,this.head=t};Ts.prototype.from=function(){return B(this.anchor,this.head)},Ts.prototype.to=function(){return R(this.anchor,this.head)},Ts.prototype.empty=function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch},Bi.prototype={chunkSize:function(){return this.lines.length},removeInner:function(e,t){for(var r=this,n=e,i=e+t;n<i;++n){var o=r.lines[n];r.height-=o.height,ot(o),bt(o,"delete")}this.lines.splice(e,t)},collapse:function(e){e.push.apply(e,this.lines)},insertInner:function(e,t,r){var n=this;this.height+=r,this.lines=this.lines.slice(0,e).concat(t).concat(this.lines.slice(e));for(var i=0;i<t.length;++i)t[i].parent=n},iterN:function(e,t,r){for(var n=this,i=e+t;e<i;++e)if(r(n.lines[e]))return!0}},Gi.prototype={chunkSize:function(){return this.size},removeInner:function(e,t){var r=this;this.size-=t;for(var n=0;n<this.children.length;++n){var i=r.children[n],o=i.chunkSize();if(e<o){var l=Math.min(t,o-e),s=i.height;if(i.removeInner(e,l),r.height-=s-i.height,o==l&&(r.children.splice(n--,1),i.parent=null),0==(t-=l))break;e=0}else e-=o}if(this.size-t<25&&(this.children.length>1||!(this.children[0]instanceof Bi))){var a=[];this.collapse(a),this.children=[new Bi(a)],this.children[0].parent=this}},collapse:function(e){for(var t=this,r=0;r<this.children.length;++r)t.children[r].collapse(e)},insertInner:function(e,t,r){var n=this;this.size+=t.length,this.height+=r;for(var i=0;i<this.children.length;++i){var o=n.children[i],l=o.chunkSize();if(e<=l){if(o.insertInner(e,t,r),o.lines&&o.lines.length>50){for(var s=o.lines.length%25+25,a=s;a<o.lines.length;){var u=new Bi(o.lines.slice(a,a+=25));o.height-=u.height,n.children.splice(++i,0,u),u.parent=n}o.lines=o.lines.slice(0,s),n.maybeSpill()}break}e-=l}},maybeSpill:function(){if(!(this.children.length<=10)){var e=this;do{var t=new Gi(e.children.splice(e.children.length-5,5));if(e.parent){e.size-=t.size,e.height-=t.height;var r=h(e.parent.children,e);e.parent.children.splice(r+1,0,t)}else{var n=new Gi(e.children);n.parent=e,e.children=[n,t],e=n}t.parent=e.parent}while(e.children.length>10);e.parent.maybeSpill()}},iterN:function(e,t,r){for(var n=this,i=0;i<this.children.length;++i){var o=n.children[i],l=o.chunkSize();if(e<l){var s=Math.min(t,l-e);if(o.iterN(e,s,r))return!0;if(0==(t-=s))break;e=0}else e-=l}}};var Ms=function(e,t,r){var n=this;if(r)for(var i in r)r.hasOwnProperty(i)&&(n[i]=r[i]);this.doc=e,this.node=t};Ms.prototype.clear=function(){var e=this,t=this.doc.cm,r=this.line.widgets,n=this.line,i=W(n);if(null!=i&&r){for(var o=0;o<r.length;++o)r[o]==e&&r.splice(o--,1);r.length||(n.widgets=null);var l=Ht(this);A(n,Math.max(0,n.height-l)),t&&(hn(t,function(){Ui(t,n,-l),mn(t,i,"widget")}),bt(t,"lineWidgetCleared",t,this,i))}},Ms.prototype.changed=function(){var e=this,t=this.height,r=this.doc.cm,n=this.line;this.height=null;var i=Ht(this)-t;i&&(A(n,n.height+i),r&&hn(r,function(){r.curOp.forceUpdate=!0,Ui(r,n,i),bt(r,"lineWidgetChanged",r,e,W(n))}))},Ae(Ms);var Ns=0,Os=function(e,t){this.lines=[],this.type=t,this.doc=e,this.id=++Ns};Os.prototype.clear=function(){var e=this;if(!this.explicitlyCleared){var t=this.doc.cm,r=t&&!t.curOp;if(r&&nn(t),Oe(this,"clear")){var n=this.find();n&&bt(this,"clear",n.from,n.to)}for(var i=null,o=null,l=0;l<this.lines.length;++l){var s=e.lines[l],a=_(s.markedSpans,e);t&&!e.collapsed?mn(t,W(s),"text"):t&&(null!=a.to&&(o=W(s)),null!=a.from&&(i=W(s))),s.markedSpans=$(s.markedSpans,a),null==a.from&&e.collapsed&&!ve(e.doc,s)&&t&&A(s,mr(t.display))}if(t&&this.collapsed&&!t.options.lineWrapping)for(var u=0;u<this.lines.length;++u){var c=fe(e.lines[u]),f=be(c);f>t.display.maxLineLength&&(t.display.maxLine=c,t.display.maxLineLength=f,t.display.maxLineChanged=!0)}null!=i&&t&&this.collapsed&&vn(t,i,o+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,t&&Ci(t.doc)),t&&bt(t,"markerCleared",t,this,i,o),r&&on(t),this.parent&&this.parent.clear()}},Os.prototype.find=function(e,t){var r=this;null==e&&"bookmark"==this.type&&(e=1);for(var n,i,o=0;o<this.lines.length;++o){var l=r.lines[o],s=_(l.markedSpans,r);if(null!=s.from&&(n=E(t?l:W(l),s.from),-1==e))return n;if(null!=s.to&&(i=E(t?l:W(l),s.to),1==e))return i}return n&&{from:n,to:i}},Os.prototype.changed=function(){var e=this,t=this.find(-1,!0),r=this,n=this.doc.cm;t&&n&&hn(n,function(){var i=t.line,o=W(t.line),l=jt(n,o);if(l&&(Qt(l),n.curOp.selectionChanged=n.curOp.forceUpdate=!0),n.curOp.updateMaxLine=!0,!ve(r.doc,i)&&null!=r.height){var s=r.height;r.height=null;var a=Ht(r)-s;a&&A(i,i.height+a)}bt(n,"markerChanged",n,e)})},Os.prototype.attachLine=function(e){if(!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;t.maybeHiddenMarkers&&-1!=h(t.maybeHiddenMarkers,this)||(t.maybeUnhiddenMarkers||(t.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(e)},Os.prototype.detachLine=function(e){if(this.lines.splice(h(this.lines,e),1),!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;(t.maybeHiddenMarkers||(t.maybeHiddenMarkers=[])).push(this)}},Ae(Os);var As=function(e,t){var r=this;this.markers=e,this.primary=t;for(var n=0;n<e.length;++n)e[n].parent=r};As.prototype.clear=function(){var e=this;if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var t=0;t<this.markers.length;++t)e.markers[t].clear();bt(this,"clear")}},As.prototype.find=function(e,t){return this.primary.find(e,t)},Ae(As);var Ws=0,Ds=function(e,t,r,n,i){if(!(this instanceof Ds))return new Ds(e,t,r,n,i);null==r&&(r=0),Gi.call(this,[new Bi([new fs("",null)])]),this.first=r,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=r;var o=E(r,0);this.sel=Rn(o),this.history=new Jn(null),this.id=++Ws,this.modeOption=t,this.lineSep=n,this.direction="rtl"==i?"rtl":"ltr",this.extend=!1,"string"==typeof e&&(e=this.splitLines(e)),_n(this,{from:o,to:o,text:e}),bi(this,Rn(o),Gl)};Ds.prototype=b(Gi.prototype,{constructor:Ds,iter:function(e,t,r){r?this.iterN(e-this.first,t-e,r):this.iterN(this.first,this.first+this.size,e)},insert:function(e,t){for(var r=0,n=0;n<t.length;++n)r+=t[n].height;this.insertInner(e-this.first,t,r)},remove:function(e,t){this.removeInner(e-this.first,t)},getValue:function(e){var t=O(this,this.first,this.first+this.size);return!1===e?t:t.join(e||this.lineSeparator())},setValue:gn(function(e){var t=E(this.first,0),r=this.first+this.size-1;Oi(this,{from:t,to:E(r,M(this,r).text.length),text:this.splitLines(e),origin:"setValue",full:!0},!0),this.cm&&Xr(this.cm,0,0),bi(this,Rn(t),Gl)}),replaceRange:function(e,t,r,n){Ei(this,e,t=U(this,t),r=r?U(this,r):t,n)},getRange:function(e,t,r){var n=N(this,U(this,e),U(this,t));return!1===r?n:n.join(r||this.lineSeparator())},getLine:function(e){var t=this.getLineHandle(e);return t&&t.text},getLineHandle:function(e){if(H(this,e))return M(this,e)},getLineNumber:function(e){return W(e)},getLineHandleVisualStart:function(e){return"number"==typeof e&&(e=M(this,e)),fe(e)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(e){return U(this,e)},getCursor:function(e){var t=this.sel.primary();return null==e||"head"==e?t.head:"anchor"==e?t.anchor:"end"==e||"to"==e||!1===e?t.to():t.from()},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:gn(function(e,t,r){vi(this,U(this,"number"==typeof e?E(e,t||0):e),null,r)}),setSelection:gn(function(e,t,r){vi(this,U(this,e),U(this,t||e),r)}),extendSelection:gn(function(e,t,r){di(this,U(this,e),t&&U(this,t),r)}),extendSelections:gn(function(e,t){pi(this,K(this,e),t)}),extendSelectionsBy:gn(function(e,t){pi(this,K(this,v(this.sel.ranges,e)),t)}),setSelections:gn(function(e,t,r){var n=this;if(e.length){for(var i=[],o=0;o<e.length;o++)i[o]=new Ts(U(n,e[o].anchor),U(n,e[o].head));null==t&&(t=Math.min(e.length-1,this.sel.primIndex)),bi(this,zn(i,t),r)}}),addSelection:gn(function(e,t,r){var n=this.sel.ranges.slice(0);n.push(new Ts(U(this,e),U(this,t||e))),bi(this,zn(n,n.length-1),r)}),getSelection:function(e){for(var t,r=this,n=this.sel.ranges,i=0;i<n.length;i++){var o=N(r,n[i].from(),n[i].to());t=t?t.concat(o):o}return!1===e?t:t.join(e||this.lineSeparator())},getSelections:function(e){for(var t=this,r=[],n=this.sel.ranges,i=0;i<n.length;i++){var o=N(t,n[i].from(),n[i].to());!1!==e&&(o=o.join(e||t.lineSeparator())),r[i]=o}return r},replaceSelection:function(e,t,r){for(var n=[],i=0;i<this.sel.ranges.length;i++)n[i]=e;this.replaceSelections(n,t,r||"+input")},replaceSelections:gn(function(e,t,r){for(var n=this,i=[],o=this.sel,l=0;l<o.ranges.length;l++){var s=o.ranges[l];i[l]={from:s.from(),to:s.to(),text:n.splitLines(e[l]),origin:r}}for(var a=t&&"end"!=t&&Kn(this,i,t),u=i.length-1;u>=0;u--)Oi(n,i[u]);a?yi(this,a):this.cm&&jr(this.cm)}),undo:gn(function(){Wi(this,"undo")}),redo:gn(function(){Wi(this,"redo")}),undoSelection:gn(function(){Wi(this,"undo",!0)}),redoSelection:gn(function(){Wi(this,"redo",!0)}),setExtending:function(e){this.extend=e},getExtending:function(){return this.extend},historySize:function(){for(var e=this.history,t=0,r=0,n=0;n<e.done.length;n++)e.done[n].ranges||++t;for(var i=0;i<e.undone.length;i++)e.undone[i].ranges||++r;return{undo:t,redo:r}},clearHistory:function(){this.history=new Jn(this.history.maxGeneration)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(e){return e&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(e){return this.history.generation==(e||this.cleanGeneration)},getHistory:function(){return{done:fi(this.history.done),undone:fi(this.history.undone)}},setHistory:function(e){var t=this.history=new Jn(this.history.maxGeneration);t.done=fi(e.done.slice(0),null,!0),t.undone=fi(e.undone.slice(0),null,!0)},setGutterMarker:gn(function(e,t,r){return Ri(this,e,"gutter",function(e){var n=e.gutterMarkers||(e.gutterMarkers={});return n[t]=r,!r&&C(n)&&(e.gutterMarkers=null),!0})}),clearGutter:gn(function(e){var t=this;this.iter(function(r){r.gutterMarkers&&r.gutterMarkers[e]&&Ri(t,r,"gutter",function(){return r.gutterMarkers[e]=null,C(r.gutterMarkers)&&(r.gutterMarkers=null),!0})})}),lineInfo:function(e){var t;if("number"==typeof e){if(!H(this,e))return null;if(t=e,!(e=M(this,e)))return null}else if(null==(t=W(e)))return null;return{line:t,handle:e,text:e.text,gutterMarkers:e.gutterMarkers,textClass:e.textClass,bgClass:e.bgClass,wrapClass:e.wrapClass,widgets:e.widgets}},addLineClass:gn(function(t,r,n){return Ri(this,t,"gutter"==r?"gutter":"class",function(t){var i="text"==r?"textClass":"background"==r?"bgClass":"gutter"==r?"gutterClass":"wrapClass";if(t[i]){if(e(n).test(t[i]))return!1;t[i]+=" "+n}else t[i]=n;return!0})}),removeLineClass:gn(function(t,r,n){return Ri(this,t,"gutter"==r?"gutter":"class",function(t){var i="text"==r?"textClass":"background"==r?"bgClass":"gutter"==r?"gutterClass":"wrapClass",o=t[i];if(!o)return!1;if(null==n)t[i]=null;else{var l=o.match(e(n));if(!l)return!1;var s=l.index+l[0].length;t[i]=o.slice(0,l.index)+(l.index&&s!=o.length?" ":"")+o.slice(s)||null}return!0})}),addLineWidget:gn(function(e,t,r){return Vi(this,e,t,r)}),removeLineWidget:function(e){e.clear()},markText:function(e,t,r){return Ki(this,U(this,e),U(this,t),r,r&&r.type||"range")},setBookmark:function(e,t){var r={replacedWith:t&&(null==t.nodeType?t.widget:t),insertLeft:t&&t.insertLeft,clearWhenEmpty:!1,shared:t&&t.shared,handleMouseEvents:t&&t.handleMouseEvents};return e=U(this,e),Ki(this,e,e,r,"bookmark")},findMarksAt:function(e){var t=[],r=M(this,(e=U(this,e)).line).markedSpans;if(r)for(var n=0;n<r.length;++n){var i=r[n];(null==i.from||i.from<=e.ch)&&(null==i.to||i.to>=e.ch)&&t.push(i.marker.parent||i.marker)}return t},findMarks:function(e,t,r){e=U(this,e),t=U(this,t);var n=[],i=e.line;return this.iter(e.line,t.line+1,function(o){var l=o.markedSpans;if(l)for(var s=0;s<l.length;s++){var a=l[s];null!=a.to&&i==e.line&&e.ch>=a.to||null==a.from&&i!=e.line||null!=a.from&&i==t.line&&a.from>=t.ch||r&&!r(a.marker)||n.push(a.marker.parent||a.marker)}++i}),n},getAllMarks:function(){var e=[];return this.iter(function(t){var r=t.markedSpans;if(r)for(var n=0;n<r.length;++n)null!=r[n].from&&e.push(r[n].marker)}),e},posFromIndex:function(e){var t,r=this.first,n=this.lineSeparator().length;return this.iter(function(i){var o=i.text.length+n;if(o>e)return t=e,!0;e-=o,++r}),U(this,E(r,t))},indexFromPos:function(e){var t=(e=U(this,e)).ch;if(e.line<this.first||e.ch<0)return 0;var r=this.lineSeparator().length;return this.iter(this.first,e.line,function(e){t+=e.text.length+r}),t},copy:function(e){var t=new Ds(O(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return t.scrollTop=this.scrollTop,t.scrollLeft=this.scrollLeft,t.sel=this.sel,t.extend=!1,e&&(t.history.undoDepth=this.history.undoDepth,t.setHistory(this.getHistory())),t},linkedDoc:function(e){e||(e={});var t=this.first,r=this.first+this.size;null!=e.from&&e.from>t&&(t=e.from),null!=e.to&&e.to<r&&(r=e.to);var n=new Ds(O(this,t,r),e.mode||this.modeOption,t,this.lineSep,this.direction);return e.sharedHist&&(n.history=this.history),(this.linked||(this.linked=[])).push({doc:n,sharedHist:e.sharedHist}),n.linked=[{doc:this,isParent:!0,sharedHist:e.sharedHist}],Yi(n,Xi(this)),n},unlinkDoc:function(e){var t=this;if(e instanceof jo&&(e=e.doc),this.linked)for(var r=0;r<this.linked.length;++r)if(t.linked[r].doc==e){t.linked.splice(r,1),e.unlinkDoc(t),_i(Xi(t));break}if(e.history==this.history){var n=[e.id];$n(e,function(e){return n.push(e.id)},!0),e.history=new Jn(null),e.history.done=fi(this.history.done,n),e.history.undone=fi(this.history.undone,n)}},iterLinkedDocs:function(e){$n(this,e)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(e){return this.lineSep?e.split(this.lineSep):es(e)},lineSeparator:function(){return this.lineSep||"\n"},setDirection:gn(function(e){"rtl"!=e&&(e="ltr"),e!=this.direction&&(this.direction=e,this.iter(function(e){return e.order=null}),this.cm&&Qn(this.cm))})}),Ds.prototype.eachLine=Ds.prototype.iter;for(var Hs=0,Fs=!1,Es={3:"Enter",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",106:"*",107:"=",109:"-",110:".",111:"/",127:"Delete",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},Ps=0;Ps<10;Ps++)Es[Ps+48]=Es[Ps+96]=String(Ps);for(var Is=65;Is<=90;Is++)Es[Is]=String.fromCharCode(Is);for(var zs=1;zs<=12;zs++)Es[zs+111]=Es[zs+63235]="F"+zs;var Rs={};Rs.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},Rs.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Up":"goLineUp","Ctrl-Down":"goLineDown","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},Rs.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Alt-F":"goWordRight","Alt-B":"goWordLeft","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-D":"delWordAfter","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars","Ctrl-O":"openLine"},Rs.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Home":"goDocStart","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineLeft","Cmd-Right":"goLineRight","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delWrappedLineLeft","Cmd-Delete":"delWrappedLineRight","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd",fallthrough:["basic","emacsy"]},Rs.default=Ml?Rs.macDefault:Rs.pcDefault;var Bs={selectAll:Mi,singleSelection:function(e){return e.setSelection(e.getCursor("anchor"),e.getCursor("head"),Gl)},killLine:function(e){return co(e,function(t){if(t.empty()){var r=M(e.doc,t.head.line).text.length;return t.head.ch==r&&t.head.line<e.lastLine()?{from:t.head,to:E(t.head.line+1,0)}:{from:t.head,to:E(t.head.line,r)}}return{from:t.from(),to:t.to()}})},deleteLine:function(e){return co(e,function(t){return{from:E(t.from().line,0),to:U(e.doc,E(t.to().line+1,0))}})},delLineLeft:function(e){return co(e,function(e){return{from:E(e.from().line,0),to:e.from()}})},delWrappedLineLeft:function(e){return co(e,function(t){var r=e.charCoords(t.head,"div").top+5;return{from:e.coordsChar({left:0,top:r},"div"),to:t.from()}})},delWrappedLineRight:function(e){return co(e,function(t){var r=e.charCoords(t.head,"div").top+5,n=e.coordsChar({left:e.display.lineDiv.offsetWidth+100,top:r},"div");return{from:t.from(),to:n}})},undo:function(e){return e.undo()},redo:function(e){return e.redo()},undoSelection:function(e){return e.undoSelection()},redoSelection:function(e){return e.redoSelection()},goDocStart:function(e){return e.extendSelection(E(e.firstLine(),0))},goDocEnd:function(e){return e.extendSelection(E(e.lastLine()))},goLineStart:function(e){return e.extendSelectionsBy(function(t){return vo(e,t.head.line)},{origin:"+move",bias:1})},goLineStartSmart:function(e){return e.extendSelectionsBy(function(t){return yo(e,t.head)},{origin:"+move",bias:1})},goLineEnd:function(e){return e.extendSelectionsBy(function(t){return mo(e,t.head.line)},{origin:"+move",bias:-1})},goLineRight:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5;return e.coordsChar({left:e.display.lineDiv.offsetWidth+100,top:r},"div")},Vl)},goLineLeft:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5;return e.coordsChar({left:0,top:r},"div")},Vl)},goLineLeftSmart:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5,n=e.coordsChar({left:0,top:r},"div");return n.ch<e.getLine(n.line).search(/\S/)?yo(e,t.head):n},Vl)},goLineUp:function(e){return e.moveV(-1,"line")},goLineDown:function(e){return e.moveV(1,"line")},goPageUp:function(e){return e.moveV(-1,"page")},goPageDown:function(e){return e.moveV(1,"page")},goCharLeft:function(e){return e.moveH(-1,"char")},goCharRight:function(e){return e.moveH(1,"char")},goColumnLeft:function(e){return e.moveH(-1,"column")},goColumnRight:function(e){return e.moveH(1,"column")},goWordLeft:function(e){return e.moveH(-1,"word")},goGroupRight:function(e){return e.moveH(1,"group")},goGroupLeft:function(e){return e.moveH(-1,"group")},goWordRight:function(e){return e.moveH(1,"word")},delCharBefore:function(e){return e.deleteH(-1,"char")},delCharAfter:function(e){return e.deleteH(1,"char")},delWordBefore:function(e){return e.deleteH(-1,"word")},delWordAfter:function(e){return e.deleteH(1,"word")},delGroupBefore:function(e){return e.deleteH(-1,"group")},delGroupAfter:function(e){return e.deleteH(1,"group")},indentAuto:function(e){return e.indentSelection("smart")},indentMore:function(e){return e.indentSelection("add")},indentLess:function(e){return e.indentSelection("subtract")},insertTab:function(e){return e.replaceSelection("\t")},insertSoftTab:function(e){for(var t=[],r=e.listSelections(),n=e.options.tabSize,i=0;i<r.length;i++){var o=r[i].from(),l=f(e.getLine(o.line),o.ch,n);t.push(p(n-l%n))}e.replaceSelections(t)},defaultTab:function(e){e.somethingSelected()?e.indentSelection("add"):e.execCommand("insertTab")},transposeChars:function(e){return hn(e,function(){for(var t=e.listSelections(),r=[],n=0;n<t.length;n++)if(t[n].empty()){var i=t[n].head,o=M(e.doc,i.line).text;if(o)if(i.ch==o.length&&(i=new E(i.line,i.ch-1)),i.ch>0)i=new E(i.line,i.ch+1),e.replaceRange(o.charAt(i.ch-1)+o.charAt(i.ch-2),E(i.line,i.ch-2),i,"+transpose");else if(i.line>e.doc.first){var l=M(e.doc,i.line-1).text;l&&(i=new E(i.line,1),e.replaceRange(o.charAt(0)+e.doc.lineSeparator()+l.charAt(l.length-1),E(i.line-1,l.length-1),i,"+transpose"))}r.push(new Ts(i,i))}e.setSelections(r)})},newlineAndIndent:function(e){return hn(e,function(){for(var t=e.listSelections(),r=t.length-1;r>=0;r--)e.replaceRange(e.doc.lineSeparator(),t[r].anchor,t[r].head,"+input");t=e.listSelections();for(var n=0;n<t.length;n++)e.indentLine(t[n].from().line,null,!0);jr(e)})},openLine:function(e){return e.replaceSelection("\n","start")},toggleOverwrite:function(e){return e.toggleOverwrite()}},Gs=new Pl,Us=null,Vs=function(e,t,r){this.time=e,this.pos=t,this.button=r};Vs.prototype.compare=function(e,t,r){return this.time+400>e&&0==P(t,this.pos)&&r==this.button};var Ks,js,Xs={toString:function(){return"CodeMirror.Init"}},Ys={},_s={};jo.defaults=Ys,jo.optionHandlers=_s;var $s=[];jo.defineInitHook=function(e){return $s.push(e)};var qs=null,Zs=function(e){this.cm=e,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new Pl,this.composing=null,this.gracePeriod=!1,this.readDOMTimeout=null};Zs.prototype.init=function(e){function t(e){if(!Me(i,e)){if(i.somethingSelected())_o({lineWise:!1,text:i.getSelections()}),"cut"==e.type&&i.replaceSelection("",null,"cut");else{if(!i.options.lineWiseCopyCut)return;var t=Qo(i);_o({lineWise:!0,text:t.text}),"cut"==e.type&&i.operation(function(){i.setSelections(t.ranges,0,Gl),i.replaceSelection("",null,"cut")})}if(e.clipboardData){e.clipboardData.clearData();var r=qs.text.join("\n");if(e.clipboardData.setData("Text",r),e.clipboardData.getData("Text")==r)return void e.preventDefault()}var l=el(),s=l.firstChild;i.display.lineSpace.insertBefore(l,i.display.lineSpace.firstChild),s.value=qs.text.join("\n");var a=document.activeElement;El(s),setTimeout(function(){i.display.lineSpace.removeChild(l),a.focus(),a==o&&n.showPrimarySelection()},50)}}var r=this,n=this,i=n.cm,o=n.div=e.lineDiv;Jo(o,i.options.spellcheck),Ql(o,"paste",function(e){Me(i,e)||qo(e,i)||vl<=11&&setTimeout(dn(i,function(){return r.updateFromDOM()}),20)}),Ql(o,"compositionstart",function(e){r.composing={data:e.data,done:!1}}),Ql(o,"compositionupdate",function(e){r.composing||(r.composing={data:e.data,done:!1})}),Ql(o,"compositionend",function(e){r.composing&&(e.data!=r.composing.data&&r.readFromDOMSoon(),r.composing.done=!0)}),Ql(o,"touchstart",function(){return n.forceCompositionEnd()}),Ql(o,"input",function(){r.composing||r.readFromDOMSoon()}),Ql(o,"copy",t),Ql(o,"cut",t)},Zs.prototype.prepareSelection=function(){var e=Tr(this.cm,!1);return e.focus=this.cm.state.focused,e},Zs.prototype.showSelection=function(e,t){e&&this.cm.display.view.length&&((e.focus||t)&&this.showPrimarySelection(),this.showMultipleSelections(e))},Zs.prototype.showPrimarySelection=function(){var e=window.getSelection(),t=this.cm,r=t.doc.sel.primary(),n=r.from(),i=r.to();if(t.display.viewTo==t.display.viewFrom||n.line>=t.display.viewTo||i.line<t.display.viewFrom)e.removeAllRanges();else{var o=sl(t,e.anchorNode,e.anchorOffset),l=sl(t,e.focusNode,e.focusOffset);if(!o||o.bad||!l||l.bad||0!=P(B(o,l),n)||0!=P(R(o,l),i)){var s=t.display.view,a=n.line>=t.display.viewFrom&&nl(t,n)||{node:s[0].measure.map[2],offset:0},u=i.line<t.display.viewTo&&nl(t,i);if(!u){var c=s[s.length-1].measure,f=c.maps?c.maps[c.maps.length-1]:c.map;u={node:f[f.length-1],offset:f[f.length-2]-f[f.length-3]}}if(a&&u){var h,d=e.rangeCount&&e.getRangeAt(0);try{h=Wl(a.node,a.offset,u.offset,u.node)}catch(e){}h&&(!fl&&t.state.focused?(e.collapse(a.node,a.offset),h.collapsed||(e.removeAllRanges(),e.addRange(h))):(e.removeAllRanges(),e.addRange(h)),d&&null==e.anchorNode?e.addRange(d):fl&&this.startGracePeriod()),this.rememberSelection()}else e.removeAllRanges()}}},Zs.prototype.startGracePeriod=function(){var e=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout(function(){e.gracePeriod=!1,e.selectionChanged()&&e.cm.operation(function(){return e.cm.curOp.selectionChanged=!0})},20)},Zs.prototype.showMultipleSelections=function(e){r(this.cm.display.cursorDiv,e.cursors),r(this.cm.display.selectionDiv,e.selection)},Zs.prototype.rememberSelection=function(){var e=window.getSelection();this.lastAnchorNode=e.anchorNode,this.lastAnchorOffset=e.anchorOffset,this.lastFocusNode=e.focusNode,this.lastFocusOffset=e.focusOffset},Zs.prototype.selectionInEditor=function(){var e=window.getSelection();if(!e.rangeCount)return!1;var t=e.getRangeAt(0).commonAncestorContainer;return o(this.div,t)},Zs.prototype.focus=function(){"nocursor"!=this.cm.options.readOnly&&(this.selectionInEditor()||this.showSelection(this.prepareSelection(),!0),this.div.focus())},Zs.prototype.blur=function(){this.div.blur()},Zs.prototype.getField=function(){return this.div},Zs.prototype.supportsTouch=function(){return!0},Zs.prototype.receivedFocus=function(){function e(){t.cm.state.focused&&(t.pollSelection(),t.polling.set(t.cm.options.pollInterval,e))}var t=this;this.selectionInEditor()?this.pollSelection():hn(this.cm,function(){return t.cm.curOp.selectionChanged=!0}),this.polling.set(this.cm.options.pollInterval,e)},Zs.prototype.selectionChanged=function(){var e=window.getSelection();return e.anchorNode!=this.lastAnchorNode||e.anchorOffset!=this.lastAnchorOffset||e.focusNode!=this.lastFocusNode||e.focusOffset!=this.lastFocusOffset},Zs.prototype.pollSelection=function(){if(null==this.readDOMTimeout&&!this.gracePeriod&&this.selectionChanged()){var e=window.getSelection(),t=this.cm;if(kl&&bl&&this.cm.options.gutters.length&&il(e.anchorNode))return this.cm.triggerOnKeyDown({type:"keydown",keyCode:8,preventDefault:Math.abs}),this.blur(),void this.focus();if(!this.composing){this.rememberSelection();var r=sl(t,e.anchorNode,e.anchorOffset),n=sl(t,e.focusNode,e.focusOffset);r&&n&&hn(t,function(){bi(t.doc,Rn(r,n),Gl),(r.bad||n.bad)&&(t.curOp.selectionChanged=!0)})}}},Zs.prototype.pollContent=function(){null!=this.readDOMTimeout&&(clearTimeout(this.readDOMTimeout),this.readDOMTimeout=null);var e=this.cm,t=e.display,r=e.doc.sel.primary(),n=r.from(),i=r.to();if(0==n.ch&&n.line>e.firstLine()&&(n=E(n.line-1,M(e.doc,n.line-1).length)),i.ch==M(e.doc,i.line).text.length&&i.line<e.lastLine()&&(i=E(i.line+1,0)),n.line<t.viewFrom||i.line>t.viewTo-1)return!1;var o,l,s;n.line==t.viewFrom||0==(o=Lr(e,n.line))?(l=W(t.view[0].line),s=t.view[0].node):(l=W(t.view[o].line),s=t.view[o-1].node.nextSibling);var a,u,c=Lr(e,i.line);if(c==t.view.length-1?(a=t.viewTo-1,u=t.lineDiv.lastChild):(a=W(t.view[c+1].line)-1,u=t.view[c+1].node.previousSibling),!s)return!1;for(var f=e.doc.splitLines(ll(e,s,u,l,a)),h=N(e.doc,E(l,0),E(a,M(e.doc,a).text.length));f.length>1&&h.length>1;)if(g(f)==g(h))f.pop(),h.pop(),a--;else{if(f[0]!=h[0])break;f.shift(),h.shift(),l++}for(var d=0,p=0,v=f[0],m=h[0],y=Math.min(v.length,m.length);d<y&&v.charCodeAt(d)==m.charCodeAt(d);)++d;for(var b=g(f),w=g(h),x=Math.min(b.length-(1==f.length?d:0),w.length-(1==h.length?d:0));p<x&&b.charCodeAt(b.length-p-1)==w.charCodeAt(w.length-p-1);)++p;if(1==f.length&&1==h.length&&l==n.line)for(;d&&d>n.ch&&b.charCodeAt(b.length-p-1)==w.charCodeAt(w.length-p-1);)d--,p++;f[f.length-1]=b.slice(0,b.length-p).replace(/^\u200b+/,""),f[0]=f[0].slice(d).replace(/\u200b+$/,"");var C=E(l,d),S=E(a,h.length?g(h).length-p:0);return f.length>1||f[0]||P(C,S)?(Ei(e.doc,f,C,S,"+input"),!0):void 0},Zs.prototype.ensurePolled=function(){this.forceCompositionEnd()},Zs.prototype.reset=function(){this.forceCompositionEnd()},Zs.prototype.forceCompositionEnd=function(){this.composing&&(clearTimeout(this.readDOMTimeout),this.composing=null,this.updateFromDOM(),this.div.blur(),this.div.focus())},Zs.prototype.readFromDOMSoon=function(){var e=this;null==this.readDOMTimeout&&(this.readDOMTimeout=setTimeout(function(){if(e.readDOMTimeout=null,e.composing){if(!e.composing.done)return;e.composing=null}e.updateFromDOM()},80))},Zs.prototype.updateFromDOM=function(){var e=this;!this.cm.isReadOnly()&&this.pollContent()||hn(this.cm,function(){return vn(e.cm)})},Zs.prototype.setUneditable=function(e){e.contentEditable="false"},Zs.prototype.onKeyPress=function(e){0!=e.charCode&&(e.preventDefault(),this.cm.isReadOnly()||dn(this.cm,$o)(this.cm,String.fromCharCode(null==e.charCode?e.keyCode:e.charCode),0))},Zs.prototype.readOnlyChanged=function(e){this.div.contentEditable=String("nocursor"!=e)},Zs.prototype.onContextMenu=function(){},Zs.prototype.resetPosition=function(){},Zs.prototype.needsContentAttribute=!0;var Qs=function(e){this.cm=e,this.prevInput="",this.pollingFast=!1,this.polling=new Pl,this.hasSelection=!1,this.composing=null};Qs.prototype.init=function(e){function t(e){if(!Me(i,e)){if(i.somethingSelected())_o({lineWise:!1,text:i.getSelections()});else{if(!i.options.lineWiseCopyCut)return;var t=Qo(i);_o({lineWise:!0,text:t.text}),"cut"==e.type?i.setSelections(t.ranges,null,Gl):(n.prevInput="",l.value=t.text.join("\n"),El(l))}"cut"==e.type&&(i.state.cutIncoming=!0)}}var r=this,n=this,i=this.cm,o=this.wrapper=el(),l=this.textarea=o.firstChild;e.wrapper.insertBefore(o,e.wrapper.firstChild),Ll&&(l.style.width="0px"),Ql(l,"input",function(){gl&&vl>=9&&r.hasSelection&&(r.hasSelection=null),n.poll()}),Ql(l,"paste",function(e){Me(i,e)||qo(e,i)||(i.state.pasteIncoming=!0,n.fastPoll())}),Ql(l,"cut",t),Ql(l,"copy",t),Ql(e.scroller,"paste",function(t){Ft(e,t)||Me(i,t)||(i.state.pasteIncoming=!0,n.focus())}),Ql(e.lineSpace,"selectstart",function(t){Ft(e,t)||We(t)}),Ql(l,"compositionstart",function(){var e=i.getCursor("from");n.composing&&n.composing.range.clear(),n.composing={start:e,range:i.markText(e,i.getCursor("to"),{className:"CodeMirror-composing"})}}),Ql(l,"compositionend",function(){n.composing&&(n.poll(),n.composing.range.clear(),n.composing=null)})},Qs.prototype.prepareSelection=function(){var e=this.cm,t=e.display,r=e.doc,n=Tr(e);if(e.options.moveInputWithCursor){var i=sr(e,r.sel.primary().head,"div"),o=t.wrapper.getBoundingClientRect(),l=t.lineDiv.getBoundingClientRect();n.teTop=Math.max(0,Math.min(t.wrapper.clientHeight-10,i.top+l.top-o.top)),n.teLeft=Math.max(0,Math.min(t.wrapper.clientWidth-10,i.left+l.left-o.left))}return n},Qs.prototype.showSelection=function(e){var t=this.cm.display;r(t.cursorDiv,e.cursors),r(t.selectionDiv,e.selection),null!=e.teTop&&(this.wrapper.style.top=e.teTop+"px",this.wrapper.style.left=e.teLeft+"px")},Qs.prototype.reset=function(e){if(!this.contextMenuPending&&!this.composing){var t=this.cm;if(t.somethingSelected()){this.prevInput="";var r=t.getSelection();this.textarea.value=r,t.state.focused&&El(this.textarea),gl&&vl>=9&&(this.hasSelection=r)}else e||(this.prevInput=this.textarea.value="",gl&&vl>=9&&(this.hasSelection=null))}},Qs.prototype.getField=function(){return this.textarea},Qs.prototype.supportsTouch=function(){return!1},Qs.prototype.focus=function(){if("nocursor"!=this.cm.options.readOnly&&(!Tl||l()!=this.textarea))try{this.textarea.focus()}catch(e){}},Qs.prototype.blur=function(){this.textarea.blur()},Qs.prototype.resetPosition=function(){this.wrapper.style.top=this.wrapper.style.left=0},Qs.prototype.receivedFocus=function(){this.slowPoll()},Qs.prototype.slowPoll=function(){var e=this;this.pollingFast||this.polling.set(this.cm.options.pollInterval,function(){e.poll(),e.cm.state.focused&&e.slowPoll()})},Qs.prototype.fastPoll=function(){function e(){r.poll()||t?(r.pollingFast=!1,r.slowPoll()):(t=!0,r.polling.set(60,e))}var t=!1,r=this;r.pollingFast=!0,r.polling.set(20,e)},Qs.prototype.poll=function(){var e=this,t=this.cm,r=this.textarea,n=this.prevInput;if(this.contextMenuPending||!t.state.focused||ts(r)&&!n&&!this.composing||t.isReadOnly()||t.options.disableInput||t.state.keySeq)return!1;var i=r.value;if(i==n&&!t.somethingSelected())return!1;if(gl&&vl>=9&&this.hasSelection===i||Ml&&/[\uf700-\uf7ff]/.test(i))return t.display.input.reset(),!1;if(t.doc.sel==t.display.selForContextMenu){var o=i.charCodeAt(0);if(8203!=o||n||(n="​"),8666==o)return this.reset(),this.cm.execCommand("undo")}for(var l=0,s=Math.min(n.length,i.length);l<s&&n.charCodeAt(l)==i.charCodeAt(l);)++l;return hn(t,function(){$o(t,i.slice(l),n.length-l,null,e.composing?"*compose":null),i.length>1e3||i.indexOf("\n")>-1?r.value=e.prevInput="":e.prevInput=i,e.composing&&(e.composing.range.clear(),e.composing.range=t.markText(e.composing.start,t.getCursor("to"),{className:"CodeMirror-composing"}))}),!0},Qs.prototype.ensurePolled=function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},Qs.prototype.onKeyPress=function(){gl&&vl>=9&&(this.hasSelection=null),this.fastPoll()},Qs.prototype.onContextMenu=function(e){function t(){if(null!=l.selectionStart){var e=i.somethingSelected(),t="​"+(e?l.value:"");l.value="⇚",l.value=t,n.prevInput=e?"":"​",l.selectionStart=1,l.selectionEnd=t.length,o.selForContextMenu=i.doc.sel}}function r(){if(n.contextMenuPending=!1,n.wrapper.style.cssText=c,l.style.cssText=u,gl&&vl<9&&o.scrollbars.setScrollTop(o.scroller.scrollTop=a),null!=l.selectionStart){(!gl||gl&&vl<9)&&t();var e=0,r=function(){o.selForContextMenu==i.doc.sel&&0==l.selectionStart&&l.selectionEnd>0&&"​"==n.prevInput?dn(i,Mi)(i):e++<10?o.detectingSelectAll=setTimeout(r,500):(o.selForContextMenu=null,o.input.reset())};o.detectingSelectAll=setTimeout(r,200)}}var n=this,i=n.cm,o=i.display,l=n.textarea,s=Sr(i,e),a=o.scroller.scrollTop;if(s&&!wl){i.options.resetSelectionOnContextMenu&&-1==i.doc.sel.contains(s)&&dn(i,bi)(i.doc,Rn(s),Gl);var u=l.style.cssText,c=n.wrapper.style.cssText;n.wrapper.style.cssText="position: absolute";var f=n.wrapper.getBoundingClientRect();l.style.cssText="position: absolute; width: 30px; height: 30px;\n      top: "+(e.clientY-f.top-5)+"px; left: "+(e.clientX-f.left-5)+"px;\n      z-index: 1000; background: "+(gl?"rgba(255, 255, 255, .05)":"transparent")+";\n      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);";var h;if(ml&&(h=window.scrollY),o.input.focus(),ml&&window.scrollTo(null,h),o.input.reset(),i.somethingSelected()||(l.value=n.prevInput=" "),n.contextMenuPending=!0,o.selForContextMenu=i.doc.sel,clearTimeout(o.detectingSelectAll),gl&&vl>=9&&t(),Hl){Fe(e);var d=function(){ke(window,"mouseup",d),setTimeout(r,20)};Ql(window,"mouseup",d)}else setTimeout(r,50)}},Qs.prototype.readOnlyChanged=function(e){e||this.reset(),this.textarea.disabled="nocursor"==e},Qs.prototype.setUneditable=function(){},Qs.prototype.needsContentAttribute=!1,function(e){function t(t,n,i,o){e.defaults[t]=n,i&&(r[t]=o?function(e,t,r){r!=Xs&&i(e,t,r)}:i)}var r=e.optionHandlers;e.defineOption=t,e.Init=Xs,t("value","",function(e,t){return e.setValue(t)},!0),t("mode",null,function(e,t){e.doc.modeOption=t,jn(e)},!0),t("indentUnit",2,jn,!0),t("indentWithTabs",!1),t("smartIndent",!0),t("tabSize",4,function(e){Xn(e),er(e),vn(e)},!0),t("lineSeparator",null,function(e,t){if(e.doc.lineSep=t,t){var r=[],n=e.doc.first;e.doc.iter(function(e){for(var i=0;;){var o=e.text.indexOf(t,i);if(-1==o)break;i=o+t.length,r.push(E(n,o))}n++});for(var i=r.length-1;i>=0;i--)Ei(e.doc,t,r[i],E(r[i].line,r[i].ch+t.length))}}),t("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b-\u200f\u2028\u2029\ufeff]/g,function(e,t,r){e.state.specialChars=new RegExp(t.source+(t.test("\t")?"":"|\t"),"g"),r!=Xs&&e.refresh()}),t("specialCharPlaceholder",at,function(e){return e.refresh()},!0),t("electricChars",!0),t("inputStyle",Tl?"contenteditable":"textarea",function(){throw new Error("inputStyle can not (yet) be changed in a running editor")},!0),t("spellcheck",!1,function(e,t){return e.getInputField().spellcheck=t},!0),t("rtlMoveVisually",!Ol),t("wholeLineUpdateBefore",!0),t("theme","default",function(e){Go(e),Uo(e)},!0),t("keyMap","default",function(e,t,r){var n=uo(t),i=r!=Xs&&uo(r);i&&i.detach&&i.detach(e,n),n.attach&&n.attach(e,i||null)}),t("extraKeys",null),t("configureMouse",null),t("lineWrapping",!1,Ko,!0),t("gutters",[],function(e){Fn(e.options),Uo(e)},!0),t("fixedGutter",!0,function(e,t){e.display.gutters.style.left=t?wr(e.display)+"px":"0",e.refresh()},!0),t("coverGutterNextToScrollbar",!1,function(e){return en(e)},!0),t("scrollbarStyle","native",function(e){rn(e),en(e),e.display.scrollbars.setScrollTop(e.doc.scrollTop),e.display.scrollbars.setScrollLeft(e.doc.scrollLeft)},!0),t("lineNumbers",!1,function(e){Fn(e.options),Uo(e)},!0),t("firstLineNumber",1,Uo,!0),t("lineNumberFormatter",function(e){return e},Uo,!0),t("showCursorWhenSelecting",!1,kr,!0),t("resetSelectionOnContextMenu",!0),t("lineWiseCopyCut",!0),t("pasteLinesPerSelection",!0),t("readOnly",!1,function(e,t){"nocursor"==t&&(Fr(e),e.display.input.blur()),e.display.input.readOnlyChanged(t)}),t("disableInput",!1,function(e,t){t||e.display.input.reset()},!0),t("dragDrop",!0,Vo),t("allowDropFileTypes",null),t("cursorBlinkRate",530),t("cursorScrollMargin",0),t("cursorHeight",1,kr,!0),t("singleCursorHeightPerLine",!0,kr,!0),t("workTime",100),t("workDelay",100),t("flattenSpans",!0,Xn,!0),t("addModeClass",!1,Xn,!0),t("pollInterval",100),t("undoDepth",200,function(e,t){return e.doc.history.undoDepth=t}),t("historyEventDelay",1250),t("viewportMargin",10,function(e){return e.refresh()},!0),t("maxHighlightLength",1e4,Xn,!0),t("moveInputWithCursor",!0,function(e,t){t||e.display.input.resetPosition()}),t("tabindex",null,function(e,t){return e.display.input.getField().tabIndex=t||""}),t("autofocus",null),t("direction","ltr",function(e,t){return e.doc.setDirection(t)},!0)}(jo),function(e){var t=e.optionHandlers,r=e.helpers={};e.prototype={constructor:e,focus:function(){window.focus(),this.display.input.focus()},setOption:function(e,r){var n=this.options,i=n[e];n[e]==r&&"mode"!=e||(n[e]=r,t.hasOwnProperty(e)&&dn(this,t[e])(this,r,i),Te(this,"optionChange",this,e))},getOption:function(e){return this.options[e]},getDoc:function(){return this.doc},addKeyMap:function(e,t){this.state.keyMaps[t?"push":"unshift"](uo(e))},removeKeyMap:function(e){for(var t=this.state.keyMaps,r=0;r<t.length;++r)if(t[r]==e||t[r].name==e)return t.splice(r,1),!0},addOverlay:pn(function(t,r){var n=t.token?t:e.getMode(this.options,t);if(n.startState)throw new Error("Overlays may not be stateful.");m(this.state.overlays,{mode:n,modeSpec:t,opaque:r&&r.opaque,priority:r&&r.priority||0},function(e){return e.priority}),this.state.modeGen++,vn(this)}),removeOverlay:pn(function(e){for(var t=this,r=this.state.overlays,n=0;n<r.length;++n){var i=r[n].modeSpec;if(i==e||"string"==typeof e&&i.name==e)return r.splice(n,1),t.state.modeGen++,void vn(t)}}),indentLine:pn(function(e,t,r){"string"!=typeof t&&"number"!=typeof t&&(t=null==t?this.options.smartIndent?"smart":"prev":t?"add":"subtract"),H(this.doc,e)&&Yo(this,e,t,r)}),indentSelection:pn(function(e){for(var t=this,r=this.doc.sel.ranges,n=-1,i=0;i<r.length;i++){var o=r[i];if(o.empty())o.head.line>n&&(Yo(t,o.head.line,e,!0),n=o.head.line,i==t.doc.sel.primIndex&&jr(t));else{var l=o.from(),s=o.to(),a=Math.max(n,l.line);n=Math.min(t.lastLine(),s.line-(s.ch?0:1))+1;for(var u=a;u<n;++u)Yo(t,u,e);var c=t.doc.sel.ranges;0==l.ch&&r.length==c.length&&c[i].from().ch>0&&gi(t.doc,i,new Ts(l,c[i].to()),Gl)}}}),getTokenAt:function(e,t){return Je(this,e,t)},getLineTokens:function(e,t){return Je(this,E(e),t,!0)},getTokenTypeAt:function(e){e=U(this.doc,e);var t,r=_e(this,M(this.doc,e.line)),n=0,i=(r.length-1)/2,o=e.ch;if(0==o)t=r[2];else for(;;){var l=n+i>>1;if((l?r[2*l-1]:0)>=o)i=l;else{if(!(r[2*l+1]<o)){t=r[2*l+2];break}n=l+1}}var s=t?t.indexOf("overlay "):-1;return s<0?t:0==s?null:t.slice(0,s-1)},getModeAt:function(t){var r=this.doc.mode;return r.innerMode?e.innerMode(r,this.getTokenAt(t).state).mode:r},getHelper:function(e,t){return this.getHelpers(e,t)[0]},getHelpers:function(e,t){var n=this,i=[];if(!r.hasOwnProperty(t))return i;var o=r[t],l=this.getModeAt(e);if("string"==typeof l[t])o[l[t]]&&i.push(o[l[t]]);else if(l[t])for(var s=0;s<l[t].length;s++){var a=o[l[t][s]];a&&i.push(a)}else l.helperType&&o[l.helperType]?i.push(o[l.helperType]):o[l.name]&&i.push(o[l.name]);for(var u=0;u<o._global.length;u++){var c=o._global[u];c.pred(l,n)&&-1==h(i,c.val)&&i.push(c.val)}return i},getStateAfter:function(e,t){var r=this.doc;return e=G(r,null==e?r.first+r.size-1:e),$e(this,e+1,t).state},cursorCoords:function(e,t){var r,n=this.doc.sel.primary();return r=null==e?n.head:"object"==typeof e?U(this.doc,e):e?n.from():n.to(),sr(this,r,t||"page")},charCoords:function(e,t){return lr(this,U(this.doc,e),t||"page")},coordsChar:function(e,t){return e=or(this,e,t||"page"),cr(this,e.left,e.top)},lineAtHeight:function(e,t){return e=or(this,{top:e,left:0},t||"page").top,D(this.doc,e+this.display.viewOffset)},heightAtLine:function(e,t,r){var n,i=!1;if("number"==typeof e){var o=this.doc.first+this.doc.size-1;e<this.doc.first?e=this.doc.first:e>o&&(e=o,i=!0),n=M(this.doc,e)}else n=e;return ir(this,n,{top:0,left:0},t||"page",r||i).top+(i?this.doc.height-ye(n):0)},defaultTextHeight:function(){return mr(this.display)},defaultCharWidth:function(){return yr(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(e,t,r,n,i){var o=this.display,l=(e=sr(this,U(this.doc,e))).bottom,s=e.left;if(t.style.position="absolute",t.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(t),o.sizer.appendChild(t),"over"==n)l=e.top;else if("above"==n||"near"==n){var a=Math.max(o.wrapper.clientHeight,this.doc.height),u=Math.max(o.sizer.clientWidth,o.lineSpace.clientWidth);("above"==n||e.bottom+t.offsetHeight>a)&&e.top>t.offsetHeight?l=e.top-t.offsetHeight:e.bottom+t.offsetHeight<=a&&(l=e.bottom),s+t.offsetWidth>u&&(s=u-t.offsetWidth)}t.style.top=l+"px",t.style.left=t.style.right="","right"==i?(s=o.sizer.clientWidth-t.offsetWidth,t.style.right="0px"):("left"==i?s=0:"middle"==i&&(s=(o.sizer.clientWidth-t.offsetWidth)/2),t.style.left=s+"px"),r&&Ur(this,{left:s,top:l,right:s+t.offsetWidth,bottom:l+t.offsetHeight})},triggerOnKeyDown:pn(Lo),triggerOnKeyPress:pn(Mo),triggerOnKeyUp:To,triggerOnMouseDown:pn(Oo),execCommand:function(e){if(Bs.hasOwnProperty(e))return Bs[e].call(null,this)},triggerElectric:pn(function(e){Zo(this,e)}),findPosH:function(e,t,r,n){var i=this,o=1;t<0&&(o=-1,t=-t);for(var l=U(this.doc,e),s=0;s<t&&!(l=tl(i.doc,l,o,r,n)).hitSide;++s);return l},moveH:pn(function(e,t){var r=this;this.extendSelectionsBy(function(n){return r.display.shift||r.doc.extend||n.empty()?tl(r.doc,n.head,e,t,r.options.rtlMoveVisually):e<0?n.from():n.to()},Vl)}),deleteH:pn(function(e,t){var r=this.doc.sel,n=this.doc;r.somethingSelected()?n.replaceSelection("",null,"+delete"):co(this,function(r){var i=tl(n,r.head,e,t,!1);return e<0?{from:i,to:r.head}:{from:r.head,to:i}})}),findPosV:function(e,t,r,n){var i=this,o=1,l=n;t<0&&(o=-1,t=-t);for(var s=U(this.doc,e),a=0;a<t;++a){var u=sr(i,s,"div");if(null==l?l=u.left:u.left=l,(s=rl(i,u,o,r)).hitSide)break}return s},moveV:pn(function(e,t){var r=this,n=this.doc,i=[],o=!this.display.shift&&!n.extend&&n.sel.somethingSelected();if(n.extendSelectionsBy(function(l){if(o)return e<0?l.from():l.to();var s=sr(r,l.head,"div");null!=l.goalColumn&&(s.left=l.goalColumn),i.push(s.left);var a=rl(r,s,e,t);return"page"==t&&l==n.sel.primary()&&Kr(r,lr(r,a,"div").top-s.top),a},Vl),i.length)for(var l=0;l<n.sel.ranges.length;l++)n.sel.ranges[l].goalColumn=i[l]}),findWordAt:function(e){var t=M(this.doc,e.line).text,r=e.ch,n=e.ch;if(t){var i=this.getHelper(e,"wordChars");"before"!=e.sticky&&n!=t.length||!r?++n:--r;for(var o=t.charAt(r),l=x(o,i)?function(e){return x(e,i)}:/\s/.test(o)?function(e){return/\s/.test(e)}:function(e){return!/\s/.test(e)&&!x(e)};r>0&&l(t.charAt(r-1));)--r;for(;n<t.length&&l(t.charAt(n));)++n}return new Ts(E(e.line,r),E(e.line,n))},toggleOverwrite:function(e){null!=e&&e==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?s(this.display.cursorDiv,"CodeMirror-overwrite"):Fl(this.display.cursorDiv,"CodeMirror-overwrite"),Te(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==l()},isReadOnly:function(){return!(!this.options.readOnly&&!this.doc.cantEdit)},scrollTo:pn(function(e,t){Xr(this,e,t)}),getScrollInfo:function(){var e=this.display.scroller;return{left:e.scrollLeft,top:e.scrollTop,height:e.scrollHeight-zt(this)-this.display.barHeight,width:e.scrollWidth-zt(this)-this.display.barWidth,clientHeight:Bt(this),clientWidth:Rt(this)}},scrollIntoView:pn(function(e,t){null==e?(e={from:this.doc.sel.primary().head,to:null},null==t&&(t=this.options.cursorScrollMargin)):"number"==typeof e?e={from:E(e,0),to:null}:null==e.from&&(e={from:e,to:null}),e.to||(e.to=e.from),e.margin=t||0,null!=e.from.line?Yr(this,e):$r(this,e.from,e.to,e.margin)}),setSize:pn(function(e,t){var r=this,n=function(e){return"number"==typeof e||/^\d+$/.test(String(e))?e+"px":e};null!=e&&(this.display.wrapper.style.width=n(e)),null!=t&&(this.display.wrapper.style.height=n(t)),this.options.lineWrapping&&Jt(this);var i=this.display.viewFrom;this.doc.iter(i,this.display.viewTo,function(e){if(e.widgets)for(var t=0;t<e.widgets.length;t++)if(e.widgets[t].noHScroll){mn(r,i,"widget");break}++i}),this.curOp.forceUpdate=!0,Te(this,"refresh",this)}),operation:function(e){return hn(this,e)},startOperation:function(){return nn(this)},endOperation:function(){return on(this)},refresh:pn(function(){var e=this.display.cachedTextHeight;vn(this),this.curOp.forceUpdate=!0,er(this),Xr(this,this.doc.scrollLeft,this.doc.scrollTop),Wn(this),(null==e||Math.abs(e-mr(this.display))>.5)&&Cr(this),Te(this,"refresh",this)}),swapDoc:pn(function(e){var t=this.doc;return t.cm=null,qn(this,e),er(this),this.display.input.reset(),Xr(this,e.scrollLeft,e.scrollTop),this.curOp.forceScroll=!0,bt(this,"swapDoc",this,t),t}),getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},Ae(e),e.registerHelper=function(t,n,i){r.hasOwnProperty(t)||(r[t]=e[t]={_global:[]}),r[t][n]=i},e.registerGlobalHelper=function(t,n,i,o){e.registerHelper(t,n,o),r[t]._global.push({pred:i,val:o})}}(jo);var Js="iter insert remove copy getEditor constructor".split(" ");for(var ea in Ds.prototype)Ds.prototype.hasOwnProperty(ea)&&h(Js,ea)<0&&(jo.prototype[ea]=function(e){return function(){return e.apply(this.doc,arguments)}}(Ds.prototype[ea]));return Ae(Ds),jo.inputStyles={textarea:Qs,contenteditable:Zs},jo.defineMode=function(e){jo.defaults.mode||"null"==e||(jo.defaults.mode=e),Be.apply(this,arguments)},jo.defineMIME=function(e,t){os[e]=t},jo.defineMode("null",function(){return{token:function(e){return e.skipToEnd()}}}),jo.defineMIME("text/plain","null"),jo.defineExtension=function(e,t){jo.prototype[e]=t},jo.defineDocExtension=function(e,t){Ds.prototype[e]=t},jo.fromTextArea=function(e,t){function r(){e.value=a.getValue()}if(t=t?c(t):{},t.value=e.value,!t.tabindex&&e.tabIndex&&(t.tabindex=e.tabIndex),!t.placeholder&&e.placeholder&&(t.placeholder=e.placeholder),null==t.autofocus){var n=l();t.autofocus=n==e||null!=e.getAttribute("autofocus")&&n==document.body}var i;if(e.form&&(Ql(e.form,"submit",r),!t.leaveSubmitMethodAlone)){var o=e.form;i=o.submit;try{var s=o.submit=function(){r(),o.submit=i,o.submit(),o.submit=s}}catch(e){}}t.finishInit=function(t){t.save=r,t.getTextArea=function(){return e},t.toTextArea=function(){t.toTextArea=isNaN,r(),e.parentNode.removeChild(t.getWrapperElement()),e.style.display="",e.form&&(ke(e.form,"submit",r),"function"==typeof e.form.submit&&(e.form.submit=i))}},e.style.display="none";var a=jo(function(t){return e.parentNode.insertBefore(t,e.nextSibling)},t);return a},function(e){e.off=ke,e.on=Ql,e.wheelEventPixels=Pn,e.Doc=Ds,e.splitLines=es,e.countColumn=f,e.findColumn=d,e.isWordChar=w,e.Pass=Bl,e.signal=Te,e.Line=fs,e.changeEnd=Bn,e.scrollbarModel=ws,e.Pos=E,e.cmpPos=P,e.modes=is,e.mimeModes=os,e.resolveMode=Ge,e.getMode=Ue,e.modeExtensions=ls,e.extendMode=Ve,e.copyState=Ke,e.startState=Xe,e.innerMode=je,e.commands=Bs,e.keyMap=Rs,e.keyName=ao,e.isModifierKey=lo,e.lookupKey=oo,e.normalizeKeyMap=io,e.StringStream=ss,e.SharedTextMarker=As,e.TextMarker=Os,e.LineWidget=Ms,e.e_preventDefault=We,e.e_stopPropagation=De,e.e_stop=Fe,e.addClass=s,e.contains=o,e.rmClass=Fl,e.keyNames=Es}(jo),jo.version="5.30.0",jo});
      !function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){"use strict";function t(e,t,n,r,o,a){this.indented=e,this.column=t,this.type=n,this.info=r,this.align=o,this.prev=a}function n(e,n,r,o){var a=e.indented;return e.context&&"statement"==e.context.type&&"statement"!=r&&(a=e.context.indented),e.context=new t(a,n,r,o,null,e.context)}function r(e){var t=e.context.type;return")"!=t&&"]"!=t&&"}"!=t||(e.indented=e.context.indented),e.context=e.context.prev}function o(e,t,n){return"variable"==t.prevToken||"type"==t.prevToken||(!!/\S(?:[^- ]>|[*\]])\s*$|\*$/.test(e.string.slice(0,n))||(!(!t.typeAtEndOfLine||e.column()!=e.indentation())||void 0))}function a(e){for(;;){if(!e||"top"==e.type)return!0;if("}"==e.type&&"namespace"!=e.prev.info)return!1;e=e.prev}}function i(e){for(var t={},n=e.split(" "),r=0;r<n.length;++r)t[n[r]]=!0;return t}function l(e,t){return"function"==typeof e?e(t):e.propertyIsEnumerable(t)}function s(e,t){if(!t.startOfLine)return!1;for(var n,r=null;n=e.peek();){if("\\"==n&&e.match(/^.$/)){r=s;break}if("/"==n&&e.match(/^\/[\/\*]/,!1))break;e.next()}return t.tokenize=r,"meta"}function c(e,t){return"type"==t.prevToken&&"type"}function u(e){return e.eatWhile(/[\w\.']/),"number"}function d(e,t){if(e.backUp(1),e.match(/(R|u8R|uR|UR|LR)/)){var n=e.match(/"([^\s\\()]{0,16})\(/);return!!n&&(t.cpp11RawStringDelim=n[1],t.tokenize=m,m(e,t))}return e.match(/(u8|u|U|L)/)?!!e.match(/["']/,!1)&&"string":(e.next(),!1)}function f(e){var t=/(\w+)::~?(\w+)$/.exec(e);return t&&t[1]==t[2]}function p(e,t){for(var n;null!=(n=e.next());)if('"'==n&&!e.eat('"')){t.tokenize=null;break}return"string"}function m(e,t){var n=t.cpp11RawStringDelim.replace(/[^\w\s]/g,"\\$&");return e.match(new RegExp(".*?\\)"+n+'"'))?t.tokenize=null:e.skipToEnd(),"string"}function h(t,n){function r(e){if(e)for(var t in e)e.hasOwnProperty(t)&&o.push(t)}"string"==typeof t&&(t=[t]);var o=[];r(n.keywords),r(n.types),r(n.builtin),r(n.atoms),o.length&&(n.helperType=t[0],e.registerHelper("hintWords",t[0],o));for(var a=0;a<t.length;++a)e.defineMIME(t[a],n)}function g(e,t){for(var n=!1;!e.eol();){if(!n&&e.match('"""')){t.tokenize=null;break}n="\\"==e.next()&&!n}return"string"}function y(e){return function(t,n){for(var r,o=!1,a=!1;!t.eol();){if(!e&&!o&&t.match('"')){a=!0;break}if(e&&t.match('"""')){a=!0;break}r=t.next(),!o&&"$"==r&&t.match("{")&&t.skipTo("}"),o=!o&&"\\"==r&&!e}return!a&&e||(n.tokenize=null),"string"}}function x(e){return function(t,n){for(var r,o=!1,a=!1;!t.eol();){if(!o&&t.match('"')&&("single"==e||t.match('""'))){a=!0;break}if(!o&&t.match("``")){w=x(e),a=!0;break}r=t.next(),o="single"==e&&!o&&"\\"==r}return a&&(n.tokenize=null),"string"}}e.defineMode("clike",function(i,s){function c(e,t){var n=e.next();if(S[n]){var r=S[n](e,t);if(!1!==r)return r}if('"'==n||"'"==n)return t.tokenize=u(n),t.tokenize(e,t);if(D.test(n))return p=n,null;if(L.test(n)){if(e.backUp(1),e.match(I))return"number";e.next()}if("/"==n){if(e.eat("*"))return t.tokenize=d,d(e,t);if(e.eat("/"))return e.skipToEnd(),"comment"}if(F.test(n)){for(;!e.match(/^\/[\/*]/,!1)&&e.eat(F););return"operator"}if(e.eatWhile(z),P)for(;e.match(P);)e.eatWhile(z);var o=e.current();return l(x,o)?(l(w,o)&&(p="newstatement"),l(v,o)&&(m=!0),"keyword"):l(b,o)?"type":l(k,o)?(l(w,o)&&(p="newstatement"),"builtin"):l(_,o)?"atom":"variable"}function u(e){return function(t,n){for(var r,o=!1,a=!1;null!=(r=t.next());){if(r==e&&!o){a=!0;break}o=!o&&"\\"==r}return(a||!o&&!C)&&(n.tokenize=null),"string"}}function d(e,t){for(var n,r=!1;n=e.next();){if("/"==n&&r){t.tokenize=null;break}r="*"==n}return"comment"}function f(e,t){s.typeFirstDefinitions&&e.eol()&&a(t.context)&&(t.typeAtEndOfLine=o(e,t,e.pos))}var p,m,h=i.indentUnit,g=s.statementIndentUnit||h,y=s.dontAlignCalls,x=s.keywords||{},b=s.types||{},k=s.builtin||{},w=s.blockKeywords||{},v=s.defKeywords||{},_=s.atoms||{},S=s.hooks||{},C=s.multiLineStrings,T=!1!==s.indentStatements,M=!1!==s.indentSwitch,P=s.namespaceSeparator,D=s.isPunctuationChar||/[\[\]{}\(\),;\:\.]/,L=s.numberStart||/[\d\.]/,I=s.number||/^(?:0x[a-f\d]+|0b[01]+|(?:\d+\.?\d*|\.\d+)(?:e[-+]?\d+)?)(u|ll?|l|f)?/i,F=s.isOperatorChar||/[+\-*&%=<>!?|\/]/,z=s.isIdentifierChar||/[\w\$_\xa1-\uffff]/;return{startState:function(e){return{tokenize:null,context:new t((e||0)-h,0,"top",null,!1),indented:0,startOfLine:!0,prevToken:null}},token:function(e,t){var i=t.context;if(e.sol()&&(null==i.align&&(i.align=!1),t.indented=e.indentation(),t.startOfLine=!0),e.eatSpace())return f(e,t),null;p=m=null;var l=(t.tokenize||c)(e,t);if("comment"==l||"meta"==l)return l;if(null==i.align&&(i.align=!0),";"==p||":"==p||","==p&&e.match(/^\s*(?:\/\/.*)?$/,!1))for(;"statement"==t.context.type;)r(t);else if("{"==p)n(t,e.column(),"}");else if("["==p)n(t,e.column(),"]");else if("("==p)n(t,e.column(),")");else if("}"==p){for(;"statement"==i.type;)i=r(t);for("}"==i.type&&(i=r(t));"statement"==i.type;)i=r(t)}else p==i.type?r(t):T&&(("}"==i.type||"top"==i.type)&&";"!=p||"statement"==i.type&&"newstatement"==p)&&n(t,e.column(),"statement",e.current());if("variable"==l&&("def"==t.prevToken||s.typeFirstDefinitions&&o(e,t,e.start)&&a(t.context)&&e.match(/^\s*\(/,!1))&&(l="def"),S.token){var u=S.token(e,t,l);void 0!==u&&(l=u)}return"def"==l&&!1===s.styleDefs&&(l="variable"),t.startOfLine=!1,t.prevToken=m?"def":l||p,f(e,t),l},indent:function(t,n){if(t.tokenize!=c&&null!=t.tokenize||t.typeAtEndOfLine)return e.Pass;var r=t.context,o=n&&n.charAt(0);if("statement"==r.type&&"}"==o&&(r=r.prev),s.dontIndentStatements)for(;"statement"==r.type&&s.dontIndentStatements.test(r.info);)r=r.prev;if(S.indent){var a=S.indent(t,r,n);if("number"==typeof a)return a}var i=o==r.type,l=r.prev&&"switch"==r.prev.info;if(s.allmanIndentation&&/[{(]/.test(o)){for(;"top"!=r.type&&"}"!=r.type;)r=r.prev;return r.indented}return"statement"==r.type?r.indented+("{"==o?0:g):!r.align||y&&")"==r.type?")"!=r.type||i?r.indented+(i?0:h)+(i||!l||/^(?:case|default)\b/.test(n)?0:h):r.indented+g:r.column+(i?0:1)},electricInput:M?/^\s*(?:case .*?:|default:|\{\}?|\})$/:/^\s*[{}]$/,blockCommentStart:"/*",blockCommentEnd:"*/",lineComment:"//",fold:"brace"}});var b="auto if break case register continue return default do sizeof static else struct switch extern typedef union for goto while enum const volatile",k="int long char short double float unsigned signed void size_t ptrdiff_t";h(["text/x-csrc","text/x-c","text/x-chdr"],{name:"clike",keywords:i(b),types:i(k+" bool _Complex _Bool float_t double_t intptr_t intmax_t int8_t int16_t int32_t int64_t uintptr_t uintmax_t uint8_t uint16_t uint32_t uint64_t"),blockKeywords:i("case do else for if switch while struct"),defKeywords:i("struct"),typeFirstDefinitions:!0,atoms:i("null true false"),hooks:{"#":s,"*":c},modeProps:{fold:["brace","include"]}}),h(["text/x-c++src","text/x-c++hdr"],{name:"clike",keywords:i(b+" asm dynamic_cast namespace reinterpret_cast try explicit new static_cast typeid catch operator template typename class friend private this using const_cast inline public throw virtual delete mutable protected alignas alignof constexpr decltype nullptr noexcept thread_local final static_assert override"),types:i(k+" bool wchar_t"),blockKeywords:i("catch class do else finally for if struct switch try while"),defKeywords:i("class namespace struct enum union"),typeFirstDefinitions:!0,atoms:i("true false null"),dontIndentStatements:/^template$/,isIdentifierChar:/[\w\$_~\xa1-\uffff]/,hooks:{"#":s,"*":c,u:d,U:d,L:d,R:d,0:u,1:u,2:u,3:u,4:u,5:u,6:u,7:u,8:u,9:u,token:function(e,t,n){if("variable"==n&&"("==e.peek()&&(";"==t.prevToken||null==t.prevToken||"}"==t.prevToken)&&f(e.current()))return"def"}},namespaceSeparator:"::",modeProps:{fold:["brace","include"]}}),h("text/x-java",{name:"clike",keywords:i("abstract assert break case catch class const continue default do else enum extends final finally float for goto if implements import instanceof interface native new package private protected public return static strictfp super switch synchronized this throw throws transient try volatile while @interface"),types:i("byte short int long float double boolean char void Boolean Byte Character Double Float Integer Long Number Object Short String StringBuffer StringBuilder Void"),blockKeywords:i("catch class do else finally for if switch try while"),defKeywords:i("class interface package enum @interface"),typeFirstDefinitions:!0,atoms:i("true false null"),number:/^(?:0x[a-f\d_]+|0b[01_]+|(?:[\d_]+\.?\d*|\.\d+)(?:e[-+]?[\d_]+)?)(u|ll?|l|f)?/i,hooks:{"@":function(e){return!e.match("interface",!1)&&(e.eatWhile(/[\w\$_]/),"meta")}},modeProps:{fold:["brace","import"]}}),h("text/x-csharp",{name:"clike",keywords:i("abstract as async await base break case catch checked class const continue default delegate do else enum event explicit extern finally fixed for foreach goto if implicit in interface internal is lock namespace new operator out override params private protected public readonly ref return sealed sizeof stackalloc static struct switch this throw try typeof unchecked unsafe using virtual void volatile while add alias ascending descending dynamic from get global group into join let orderby partial remove select set value var yield"),types:i("Action Boolean Byte Char DateTime DateTimeOffset Decimal Double Func Guid Int16 Int32 Int64 Object SByte Single String Task TimeSpan UInt16 UInt32 UInt64 bool byte char decimal double short int long object sbyte float string ushort uint ulong"),blockKeywords:i("catch class do else finally for foreach if struct switch try while"),defKeywords:i("class interface namespace struct var"),typeFirstDefinitions:!0,atoms:i("true false null"),hooks:{"@":function(e,t){return e.eat('"')?(t.tokenize=p,p(e,t)):(e.eatWhile(/[\w\$_]/),"meta")}}}),h("text/x-scala",{name:"clike",keywords:i("abstract case catch class def do else extends final finally for forSome if implicit import lazy match new null object override package private protected return sealed super this throw trait try type val var while with yield _ assert assume require print println printf readLine readBoolean readByte readShort readChar readInt readLong readFloat readDouble"),types:i("AnyVal App Application Array BufferedIterator BigDecimal BigInt Char Console Either Enumeration Equiv Error Exception Fractional Function IndexedSeq Int Integral Iterable Iterator List Map Numeric Nil NotNull Option Ordered Ordering PartialFunction PartialOrdering Product Proxy Range Responder Seq Serializable Set Specializable Stream StringBuilder StringContext Symbol Throwable Traversable TraversableOnce Tuple Unit Vector Boolean Byte Character CharSequence Class ClassLoader Cloneable Comparable Compiler Double Exception Float Integer Long Math Number Object Package Pair Process Runtime Runnable SecurityManager Short StackTraceElement StrictMath String StringBuffer System Thread ThreadGroup ThreadLocal Throwable Triple Void"),multiLineStrings:!0,blockKeywords:i("catch class enum do else finally for forSome if match switch try while"),defKeywords:i("class enum def object package trait type val var"),atoms:i("true false null"),indentStatements:!1,indentSwitch:!1,isOperatorChar:/[+\-*&%=<>!?|\/#:@]/,hooks:{"@":function(e){return e.eatWhile(/[\w\$_]/),"meta"},'"':function(e,t){return!!e.match('""')&&(t.tokenize=g,t.tokenize(e,t))},"'":function(e){return e.eatWhile(/[\w\$_\xa1-\uffff]/),"atom"},"=":function(e,n){var r=n.context;return!("}"!=r.type||!r.align||!e.eat(">"))&&(n.context=new t(r.indented,r.column,r.type,r.info,null,r.prev),"operator")}},modeProps:{closeBrackets:{triples:'"'}}}),h("text/x-kotlin",{name:"clike",keywords:i("package as typealias class interface this super val var fun for is in This throw return break continue object if else while do try when !in !is as? file import where by get set abstract enum open inner override private public internal protected catch finally out final vararg reified dynamic companion constructor init sealed field property receiver param sparam lateinit data inline noinline tailrec external annotation crossinline const operator infix suspend"),types:i("Boolean Byte Character CharSequence Class ClassLoader Cloneable Comparable Compiler Double Exception Float Integer Long Math Number Object Package Pair Process Runtime Runnable SecurityManager Short StackTraceElement StrictMath String StringBuffer System Thread ThreadGroup ThreadLocal Throwable Triple Void"),intendSwitch:!1,indentStatements:!1,multiLineStrings:!0,number:/^(?:0x[a-f\d_]+|0b[01_]+|(?:[\d_]+\.?\d*|\.\d+)(?:e[-+]?[\d_]+)?)(u|ll?|l|f)?/i,blockKeywords:i("catch class do else finally for if where try while enum"),defKeywords:i("class val var object package interface fun"),atoms:i("true false null this"),hooks:{'"':function(e,t){return t.tokenize=y(e.match('""')),t.tokenize(e,t)}},modeProps:{closeBrackets:{triples:'"'}}}),h(["x-shader/x-vertex","x-shader/x-fragment"],{name:"clike",keywords:i("sampler1D sampler2D sampler3D samplerCube sampler1DShadow sampler2DShadow const attribute uniform varying break continue discard return for while do if else struct in out inout"),types:i("float int bool void vec2 vec3 vec4 ivec2 ivec3 ivec4 bvec2 bvec3 bvec4 mat2 mat3 mat4"),blockKeywords:i("for while do if else struct"),builtin:i("radians degrees sin cos tan asin acos atan pow exp log exp2 sqrt inversesqrt abs sign floor ceil fract mod min max clamp mix step smoothstep length distance dot cross normalize ftransform faceforward reflect refract matrixCompMult lessThan lessThanEqual greaterThan greaterThanEqual equal notEqual any all not texture1D texture1DProj texture1DLod texture1DProjLod texture2D texture2DProj texture2DLod texture2DProjLod texture3D texture3DProj texture3DLod texture3DProjLod textureCube textureCubeLod shadow1D shadow2D shadow1DProj shadow2DProj shadow1DLod shadow2DLod shadow1DProjLod shadow2DProjLod dFdx dFdy fwidth noise1 noise2 noise3 noise4"),atoms:i("true false gl_FragColor gl_SecondaryColor gl_Normal gl_Vertex gl_MultiTexCoord0 gl_MultiTexCoord1 gl_MultiTexCoord2 gl_MultiTexCoord3 gl_MultiTexCoord4 gl_MultiTexCoord5 gl_MultiTexCoord6 gl_MultiTexCoord7 gl_FogCoord gl_PointCoord gl_Position gl_PointSize gl_ClipVertex gl_FrontColor gl_BackColor gl_FrontSecondaryColor gl_BackSecondaryColor gl_TexCoord gl_FogFragCoord gl_FragCoord gl_FrontFacing gl_FragData gl_FragDepth gl_ModelViewMatrix gl_ProjectionMatrix gl_ModelViewProjectionMatrix gl_TextureMatrix gl_NormalMatrix gl_ModelViewMatrixInverse gl_ProjectionMatrixInverse gl_ModelViewProjectionMatrixInverse gl_TexureMatrixTranspose gl_ModelViewMatrixInverseTranspose gl_ProjectionMatrixInverseTranspose gl_ModelViewProjectionMatrixInverseTranspose gl_TextureMatrixInverseTranspose gl_NormalScale gl_DepthRange gl_ClipPlane gl_Point gl_FrontMaterial gl_BackMaterial gl_LightSource gl_LightModel gl_FrontLightModelProduct gl_BackLightModelProduct gl_TextureColor gl_EyePlaneS gl_EyePlaneT gl_EyePlaneR gl_EyePlaneQ gl_FogParameters gl_MaxLights gl_MaxClipPlanes gl_MaxTextureUnits gl_MaxTextureCoords gl_MaxVertexAttribs gl_MaxVertexUniformComponents gl_MaxVaryingFloats gl_MaxVertexTextureImageUnits gl_MaxTextureImageUnits gl_MaxFragmentUniformComponents gl_MaxCombineTextureImageUnits gl_MaxDrawBuffers"),indentSwitch:!1,hooks:{"#":s},modeProps:{fold:["brace","include"]}}),h("text/x-nesc",{name:"clike",keywords:i(b+"as atomic async call command component components configuration event generic implementation includes interface module new norace nx_struct nx_union post provides signal task uses abstract extends"),types:i(k),blockKeywords:i("case do else for if switch while struct"),atoms:i("null true false"),hooks:{"#":s},modeProps:{fold:["brace","include"]}}),h("text/x-objectivec",{name:"clike",keywords:i(b+"inline restrict _Bool _Complex _Imaginary BOOL Class bycopy byref id IMP in inout nil oneway out Protocol SEL self super atomic nonatomic retain copy readwrite readonly"),types:i(k),atoms:i("YES NO NULL NILL ON OFF true false"),hooks:{"@":function(e){return e.eatWhile(/[\w\$]/),"keyword"},"#":s,indent:function(e,t,n){if("statement"==t.type&&/^@\w/.test(n))return t.indented}},modeProps:{fold:"brace"}}),h("text/x-squirrel",{name:"clike",keywords:i("base break clone continue const default delete enum extends function in class foreach local resume return this throw typeof yield constructor instanceof static"),types:i(k),blockKeywords:i("case catch class else for foreach if switch try while"),defKeywords:i("function local class"),typeFirstDefinitions:!0,atoms:i("true false null"),hooks:{"#":s},modeProps:{fold:["brace","include"]}});var w=null;h("text/x-ceylon",{name:"clike",keywords:i("abstracts alias assembly assert assign break case catch class continue dynamic else exists extends finally for function given if import in interface is let module new nonempty object of out outer package return satisfies super switch then this throw try value void while"),types:function(e){var t=e.charAt(0);return t===t.toUpperCase()&&t!==t.toLowerCase()},blockKeywords:i("case catch class dynamic else finally for function if interface module new object switch try while"),defKeywords:i("class dynamic function interface module object package value"),builtin:i("abstract actual aliased annotation by default deprecated doc final formal late license native optional sealed see serializable shared suppressWarnings tagged throws variable"),isPunctuationChar:/[\[\]{}\(\),;\:\.`]/,isOperatorChar:/[+\-*&%=<>!?|^~:\/]/,numberStart:/[\d#$]/,number:/^(?:#[\da-fA-F_]+|\$[01_]+|[\d_]+[kMGTPmunpf]?|[\d_]+\.[\d_]+(?:[eE][-+]?\d+|[kMGTPmunpf]|)|)/i,multiLineStrings:!0,typeFirstDefinitions:!0,atoms:i("true false null larger smaller equal empty finished"),indentSwitch:!1,styleDefs:!1,hooks:{"@":function(e){return e.eatWhile(/[\w\$_]/),"meta"},'"':function(e,t){return t.tokenize=x(e.match('""')?"triple":"single"),t.tokenize(e,t)},"`":function(e,t){return!(!w||!e.match("`"))&&(t.tokenize=w,w=null,t.tokenize(e,t))},"'":function(e){return e.eatWhile(/[\w\$_\xa1-\uffff]/),"atom"},token:function(e,t,n){if(("variable"==n||"type"==n)&&"."==t.prevToken)return"variable-2"}},modeProps:{fold:["brace","import"],closeBrackets:{triples:'"'}}})});
      // -------------------------------------------------------------------------
//  Part of the CodeChecker project, under the Apache License v2.0 with
//  LLVM Exceptions. See LICENSE for license information.
//  SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
// -------------------------------------------------------------------------

var BugViewer = {
  _files : [],
  _reports : [],
  _lineWidgets : [],
  _navigationMenuItems : [],
  _sourceFileData : null,
  _currentReport : null,
  _lastBugEvent  : null,

  init : function (files, reports) {
    this._files = files;
    this._reports = reports;

    this.initEscapeChars();
  },

  initEscapeChars : function () {
    this.escapeChars = {
      ' ' : 'nbsp',
      '<' : 'lt',
      '>' : 'gt',
      '"' : 'quot',
      '&' : 'amp'
    };

    var regexString = '[';
    for (var key in this.escapeChars) {
      regexString += key;
    }
    regexString += ']';

    this.escapeRegExp = new RegExp( regexString, 'g');
  },

  escapeHTML : function (str) {
    var that = this;

    return str.replace(this.escapeRegExp, function (m) {
      return '&' + that.escapeChars[m] + ';';
    });
  },

  initByUrl : function () {
    if (!this._reports) return;

    var state = {};
    window.location.hash.substr(1).split('&').forEach(function (s) {
      var parts = s.split('=');
      state[parts[0]] = parts[1];
    });

    for (var key in this._reports) {
      var report = this._reports[key];
      if (report.reportHash === state['reportHash']) {
        this.navigate(report);
        return;
      }
    }

    this.navigate(this._reports[0]);
  },

  create : function () {
    this._content = document.getElementById('editor-wrapper');
    this._filepath = document.getElementById('file-path');
    this._checkerName = document.getElementById('checker-name');
    this._reviewStatusWrapper =
      document.getElementById('review-status-wrapper');
    this._reviewStatus = document.getElementById('review-status');
    this._editor = document.getElementById('editor');

    this._codeMirror = CodeMirror(this._editor, {
      mode: 'text/x-c++src',
      matchBrackets : true,
      lineNumbers : true,
      readOnly : true,
      foldGutter : true,
      extraKeys : {},
      viewportMargin : 100
    });

    this._createNavigationMenu();
  },

  navigate : function (report, item) {
    if (!item) {
      var items = this._navigationMenuItems.filter(function (navItem) {
        return navItem.report.reportHash === report.reportHash;
      });

      if (!items.length) return;

      item = items[0].widget;
    }

    this._selectedReport.classList.remove('active');
    this._selectedReport = item;
    this._selectedReport.classList.add('active');
    this.setReport(report);
  },

  _createNavigationMenu : function () {
    var that = this;

    var nav = document.getElementById('report-nav');
    var list = document.createElement('ul');
    this._reports.forEach(function (report) {
      var events = report['events'];
      var lastBugEvent = events[events.length - 1];
      var item = document.createElement('li');

      var severity = document.createElement('i');
      severity.className = 'severity-' + report.severity.toLowerCase();

      item.appendChild(severity);
      item.appendChild(document.createTextNode(lastBugEvent.message));

      item.addEventListener('click', function () {
        that.navigate(report, item);
      })
      list.appendChild(item);
      that._navigationMenuItems.push({ report : report, widget : item });
    });

    if (!this._selectedReport && list.childNodes.length) {
      this._selectedReport = list.childNodes[0];
      this._selectedReport.classList.add('active');
    }

    nav.appendChild(list);
  },

  setReport : function (report) {
    this._currentReport = report;
    var events = report['events'];
    var lastBugEvent = events[events.length - 1];
    this.setCurrentBugEvent(lastBugEvent, events.length - 1);
    this.setCheckerName(report.checkerName);
    this.setReviewStatus(report.reviewStatus);

    window.location.hash = '#reportHash=' + report.reportHash;
  },

  setCurrentBugEvent : function (event, idx) {
    this._currentBugEvent = event;
    this.setSourceFileData(this._files[event.location.file]);
    this.drawBugPath();

    this.jumpTo(event.location.line, 0);
    this.highlightBugEvent(event, idx);
  },

  highlightBugEvent : function (event, idx) {
    this._lineWidgets.forEach(function (widget) {
      var lineIdx = widget.node.getAttribute('idx');
      if (parseInt(lineIdx) === idx) {
        widget.node.classList.add('current');
      }
    });
  },

  setCheckerName : function (checkerName) {
    this._checkerName.innerHTML = checkerName;
  },

  setReviewStatus : function (status) {
    if (status) {
      var className =
        'review-status-' + status.toLowerCase().split(' ').join('-');
      this._reviewStatus.className = "review-status " + className;

      this._reviewStatus.innerHTML = status;
      this._reviewStatusWrapper.style.display = 'block';
    } else {
      this._reviewStatusWrapper.style.display = 'none';
    }
  },

  setSourceFileData : function (file) {
    if (this._sourceFileData && file.id === this._sourceFileData.id) {
      return;
    }

    this._sourceFileData = file;
    this._filepath.innerHTML = file.path;
    this._codeMirror.doc.setValue(file.content);
    this._refresh();
  },

  _refresh : function () {
    var that = this;
    setTimeout(function () {
      var fullHeight = parseInt(that._content.clientHeight);
      var headerHeight = that._filepath.clientHeight;

      that._codeMirror.setSize('auto', fullHeight - headerHeight);
      that._codeMirror.refresh();
    }, 200);
  },

  clearBubbles : function () {
    this._lineWidgets.forEach(function (widget) { widget.clear(); });
    this._lineWidgets = [];
  },

  getMessage : function (event, kind) {
    if (kind === 'macro') {
      var name = 'macro expansion' + (event.name ? ': ' + event.name : '');

      return '<span class="tag macro">' + name + '</span>'
        + this.escapeHTML(event.expansion).replace(/(?:\r\n|\r|\n)/g, '<br>');
    } else if (kind === 'note') {
      return '<span class="tag note">note</span>'
        +  this.escapeHTML(event.message).replace(/(?:\r\n|\r|\n)/g, '<br>');
    }
  },

  addExtraPathEvents : function (events, kind) {
    var that = this;

    if (!events) {
      return;
    }

    events.forEach(function (event) {
      if (event.location.file !== that._currentBugEvent.location.file) {
        return;
      }

      var left =
        that._codeMirror.defaultCharWidth() * event.location.col + 'px';

      var element = document.createElement('div');
      element.setAttribute('style', 'margin-left: ' + left);
      element.setAttribute('class', 'check-msg ' + kind);

      var msg = document.createElement('span');
      msg.innerHTML = that.getMessage(event, kind);
      element.appendChild(msg);

      that._lineWidgets.push(that._codeMirror.addLineWidget(
        event.location.line - 1, element));
    });
  },

  drawBugPath : function () {
    var that = this;

    this.clearBubbles();

    this.addExtraPathEvents(this._currentReport.macros, 'macro');
    this.addExtraPathEvents(this._currentReport.notes, 'note');

    // Processing bug path events.
    var currentEvents = this._currentReport.events;
    currentEvents.forEach(function (event, step) {
      if (event.location.file !== that._currentBugEvent.location.file)
        return;

      var left =
        that._codeMirror.defaultCharWidth() * event.location.col + 'px';
      var type = step === currentEvents.length - 1 ? 'error' : 'info';

      var element = document.createElement('div');
      element.setAttribute('style', 'margin-left: ' + left);
      element.setAttribute('class', 'check-msg ' + type);
      element.setAttribute('idx', step);

      var enumeration = document.createElement('span');
      enumeration.setAttribute('class', 'checker-enum ' + type);
      enumeration.innerHTML = step + 1;

      if (currentEvents.length > 1)
        element.appendChild(enumeration);

      var prevBugEvent = step - 1;
      if (step > 0) {
        var prevBug = document.createElement('span');
        prevBug.setAttribute('class', 'arrow left-arrow');
        prevBug.addEventListener('click', function () {
          var event = currentEvents[prevBugEvent];
          that.setCurrentBugEvent(event, prevBugEvent);
        });
        element.appendChild(prevBug);
      }

      var msg = document.createElement('span');
      msg.innerHTML = that.escapeHTML(event.message)
        .replace(/(?:\r\n|\r|\n)/g, '<br>');

      element.appendChild(msg);

      var nextBugEvent = step + 1;
      if (nextBugEvent < currentEvents.length) {
        var nextBug = document.createElement('span');
        nextBug.setAttribute('class', 'arrow right-arrow');
        nextBug.addEventListener('click', function () {
          var event = currentEvents[nextBugEvent];
          that.setCurrentBugEvent(event, nextBugEvent);
        });
        element.appendChild(nextBug);
      }


      that._lineWidgets.push(that._codeMirror.addLineWidget(
        event.location.line - 1, element));
    });
  },

  jumpTo : function (line, column) {
    var that = this;

    setTimeout(function () {
      var selPosPixel
        = that._codeMirror.charCoords({ line : line, ch : column }, 'local');
      var editorSize = {
        width  : that._editor.clientWidth,
        height : that._editor.clientHeight
      };

      that._codeMirror.scrollIntoView({
        top    : selPosPixel.top - 100,
        bottom : selPosPixel.top + editorSize.height - 150,
        left   : selPosPixel.left < editorSize.width - 100
               ? 0
               : selPosPixel.left - 50,
        right  : selPosPixel.left < editorSize.width - 100
               ? 10
               : selPosPixel.left + editorSize.width - 100
      });
    }, 0);
  }
}


      var data = {"files": {"0": {"id": 0, "path": "/src/drivers/scsi/qla2xxx/qla_os.c", "content": "// SPDX-License-Identifier: GPL-2.0-only\n/*\n * QLogic Fibre Channel HBA Driver\n * Copyright (c)  2003-2014 QLogic Corporation\n */\n#include \"qla_def.h\"\n\n#include <linux/moduleparam.h>\n#include <linux/vmalloc.h>\n#include <linux/delay.h>\n#include <linux/kthread.h>\n#include <linux/mutex.h>\n#include <linux/kobject.h>\n#include <linux/slab.h>\n#include <linux/blk-mq-pci.h>\n#include <linux/refcount.h>\n\n#include <scsi/scsi_tcq.h>\n#include <scsi/scsicam.h>\n#include <scsi/scsi_transport.h>\n#include <scsi/scsi_transport_fc.h>\n\n#include \"qla_target.h\"\n\n/*\n * Driver version\n */\nchar qla2x00_version_str[40];\n\nstatic int apidev_major;\n\n/*\n * SRB allocation cache\n */\nstruct kmem_cache *srb_cachep;\n\nint ql2xfulldump_on_mpifail;\nmodule_param(ql2xfulldump_on_mpifail, int, S_IRUGO | S_IWUSR);\nMODULE_PARM_DESC(ql2xfulldump_on_mpifail,\n\t\t \"Set this to take full dump on MPI hang.\");\n\nint ql2xenforce_iocb_limit = 1;\nmodule_param(ql2xenforce_iocb_limit, int, S_IRUGO | S_IWUSR);\nMODULE_PARM_DESC(ql2xenforce_iocb_limit,\n\t\t \"Enforce IOCB throttling, to avoid FW congestion. (default: 0)\");\n\n/*\n * CT6 CTX allocation cache\n */\nstatic struct kmem_cache *ctx_cachep;\n/*\n * error level for logging\n */\nuint ql_errlev = 0x8001;\n\nstatic int ql2xenableclass2;\nmodule_param(ql2xenableclass2, int, S_IRUGO|S_IRUSR);\nMODULE_PARM_DESC(ql2xenableclass2,\n\t\t\"Specify if Class 2 operations are supported from the very \"\n\t\t\"beginning. Default is 0 - class 2 not supported.\");\n\n\nint ql2xlogintimeout = 20;\nmodule_param(ql2xlogintimeout, int, S_IRUGO);\nMODULE_PARM_DESC(ql2xlogintimeout,\n\t\t\"Login timeout value in seconds.\");\n\nint qlport_down_retry;\nmodule_param(qlport_down_retry, int, S_IRUGO);\nMODULE_PARM_DESC(qlport_down_retry,\n\t\t\"Maximum number of command retries to a port that returns \"\n\t\t\"a PORT-DOWN status.\");\n\nint ql2xplogiabsentdevice;\nmodule_param(ql2xplogiabsentdevice, int, S_IRUGO|S_IWUSR);\nMODULE_PARM_DESC(ql2xplogiabsentdevice,\n\t\t\"Option to enable PLOGI to devices that are not present after \"\n\t\t\"a Fabric scan.  This is needed for several broken switches. \"\n\t\t\"Default is 0 - no PLOGI. 1 - perform PLOGI.\");\n\nint ql2xloginretrycount;\nmodule_param(ql2xloginretrycount, int, S_IRUGO);\nMODULE_PARM_DESC(ql2xloginretrycount,\n\t\t\"Specify an alternate value for the NVRAM login retry count.\");\n\nint ql2xallocfwdump = 1;\nmodule_param(ql2xallocfwdump, int, S_IRUGO);\nMODULE_PARM_DESC(ql2xallocfwdump,\n\t\t\"Option to enable allocation of memory for a firmware dump \"\n\t\t\"during HBA initialization.  Memory allocation requirements \"\n\t\t\"vary by ISP type.  Default is 1 - allocate memory.\");\n\nint ql2xextended_error_logging;\nmodule_param(ql2xextended_error_logging, int, S_IRUGO|S_IWUSR);\nmodule_param_named(logging, ql2xextended_error_logging, int, S_IRUGO|S_IWUSR);\nMODULE_PARM_DESC(ql2xextended_error_logging,\n\t\t\"Option to enable extended error logging,\\n\"\n\t\t\"\\t\\tDefault is 0 - no logging.  0x40000000 - Module Init & Probe.\\n\"\n\t\t\"\\t\\t0x20000000 - Mailbox Cmnds. 0x10000000 - Device Discovery.\\n\"\n\t\t\"\\t\\t0x08000000 - IO tracing.    0x04000000 - DPC Thread.\\n\"\n\t\t\"\\t\\t0x02000000 - Async events.  0x01000000 - Timer routines.\\n\"\n\t\t\"\\t\\t0x00800000 - User space.    0x00400000 - Task Management.\\n\"\n\t\t\"\\t\\t0x00200000 - AER/EEH.       0x00100000 - Multi Q.\\n\"\n\t\t\"\\t\\t0x00080000 - P3P Specific.  0x00040000 - Virtual Port.\\n\"\n\t\t\"\\t\\t0x00020000 - Buffer Dump.   0x00010000 - Misc.\\n\"\n\t\t\"\\t\\t0x00008000 - Verbose.       0x00004000 - Target.\\n\"\n\t\t\"\\t\\t0x00002000 - Target Mgmt.   0x00001000 - Target TMF.\\n\"\n\t\t\"\\t\\t0x7fffffff - For enabling all logs, can be too many logs.\\n\"\n\t\t\"\\t\\t0x1e400000 - Preferred value for capturing essential \"\n\t\t\"debug information (equivalent to old \"\n\t\t\"ql2xextended_error_logging=1).\\n\"\n\t\t\"\\t\\tDo LOGICAL OR of the value to enable more than one level\");\n\nint ql2xshiftctondsd = 6;\nmodule_param(ql2xshiftctondsd, int, S_IRUGO);\nMODULE_PARM_DESC(ql2xshiftctondsd,\n\t\t\"Set to control shifting of command type processing \"\n\t\t\"based on total number of SG elements.\");\n\nint ql2xfdmienable = 1;\nmodule_param(ql2xfdmienable, int, S_IRUGO|S_IWUSR);\nmodule_param_named(fdmi, ql2xfdmienable, int, S_IRUGO|S_IWUSR);\nMODULE_PARM_DESC(ql2xfdmienable,\n\t\t\"Enables FDMI registrations. \"\n\t\t\"0 - no FDMI registrations. \"\n\t\t\"1 - provide FDMI registrations (default).\");\n\n#define MAX_Q_DEPTH\t64\nstatic int ql2xmaxqdepth = MAX_Q_DEPTH;\nmodule_param(ql2xmaxqdepth, int, S_IRUGO|S_IWUSR);\nMODULE_PARM_DESC(ql2xmaxqdepth,\n\t\t\"Maximum queue depth to set for each LUN. \"\n\t\t\"Default is 64.\");\n\nint ql2xenabledif = 2;\nmodule_param(ql2xenabledif, int, S_IRUGO);\nMODULE_PARM_DESC(ql2xenabledif,\n\t\t\" Enable T10-CRC-DIF:\\n\"\n\t\t\" Default is 2.\\n\"\n\t\t\"  0 -- No DIF Support\\n\"\n\t\t\"  1 -- Enable DIF for all types\\n\"\n\t\t\"  2 -- Enable DIF for all types, except Type 0.\\n\");\n\n#if (IS_ENABLED(CONFIG_NVME_FC))\nint ql2xnvmeenable = 1;\n#else\nint ql2xnvmeenable;\n#endif\nmodule_param(ql2xnvmeenable, int, 0644);\nMODULE_PARM_DESC(ql2xnvmeenable,\n    \"Enables NVME support. \"\n    \"0 - no NVMe.  Default is Y\");\n\nint ql2xenablehba_err_chk = 2;\nmodule_param(ql2xenablehba_err_chk, int, S_IRUGO|S_IWUSR);\nMODULE_PARM_DESC(ql2xenablehba_err_chk,\n\t\t\" Enable T10-CRC-DIF Error isolation by HBA:\\n\"\n\t\t\" Default is 2.\\n\"\n\t\t\"  0 -- Error isolation disabled\\n\"\n\t\t\"  1 -- Error isolation enabled only for DIX Type 0\\n\"\n\t\t\"  2 -- Error isolation enabled for all Types\\n\");\n\nint ql2xiidmaenable = 1;\nmodule_param(ql2xiidmaenable, int, S_IRUGO);\nMODULE_PARM_DESC(ql2xiidmaenable,\n\t\t\"Enables iIDMA settings \"\n\t\t\"Default is 1 - perform iIDMA. 0 - no iIDMA.\");\n\nint ql2xmqsupport = 1;\nmodule_param(ql2xmqsupport, int, S_IRUGO);\nMODULE_PARM_DESC(ql2xmqsupport,\n\t\t\"Enable on demand multiple queue pairs support \"\n\t\t\"Default is 1 for supported. \"\n\t\t\"Set it to 0 to turn off mq qpair support.\");\n\nint ql2xfwloadbin;\nmodule_param(ql2xfwloadbin, int, S_IRUGO|S_IWUSR);\nmodule_param_named(fwload, ql2xfwloadbin, int, S_IRUGO|S_IWUSR);\nMODULE_PARM_DESC(ql2xfwloadbin,\n\t\t\"Option to specify location from which to load ISP firmware:.\\n\"\n\t\t\" 2 -- load firmware via the request_firmware() (hotplug).\\n\"\n\t\t\"      interface.\\n\"\n\t\t\" 1 -- load firmware from flash.\\n\"\n\t\t\" 0 -- use default semantics.\\n\");\n\nint ql2xetsenable;\nmodule_param(ql2xetsenable, int, S_IRUGO);\nMODULE_PARM_DESC(ql2xetsenable,\n\t\t\"Enables firmware ETS burst.\"\n\t\t\"Default is 0 - skip ETS enablement.\");\n\nint ql2xdbwr = 1;\nmodule_param(ql2xdbwr, int, S_IRUGO|S_IWUSR);\nMODULE_PARM_DESC(ql2xdbwr,\n\t\t\"Option to specify scheme for request queue posting.\\n\"\n\t\t\" 0 -- Regular doorbell.\\n\"\n\t\t\" 1 -- CAMRAM doorbell (faster).\\n\");\n\nint ql2xtargetreset = 1;\nmodule_param(ql2xtargetreset, int, S_IRUGO);\nMODULE_PARM_DESC(ql2xtargetreset,\n\t\t \"Enable target reset.\"\n\t\t \"Default is 1 - use hw defaults.\");\n\nint ql2xgffidenable;\nmodule_param(ql2xgffidenable, int, S_IRUGO);\nMODULE_PARM_DESC(ql2xgffidenable,\n\t\t\"Enables GFF_ID checks of port type. \"\n\t\t\"Default is 0 - Do not use GFF_ID information.\");\n\nint ql2xasynctmfenable = 1;\nmodule_param(ql2xasynctmfenable, int, S_IRUGO);\nMODULE_PARM_DESC(ql2xasynctmfenable,\n\t\t\"Enables issue of TM IOCBs asynchronously via IOCB mechanism\"\n\t\t\"Default is 1 - Issue TM IOCBs via mailbox mechanism.\");\n\nint ql2xdontresethba;\nmodule_param(ql2xdontresethba, int, S_IRUGO|S_IWUSR);\nMODULE_PARM_DESC(ql2xdontresethba,\n\t\t\"Option to specify reset behaviour.\\n\"\n\t\t\" 0 (Default) -- Reset on failure.\\n\"\n\t\t\" 1 -- Do not reset on failure.\\n\");\n\nuint64_t ql2xmaxlun = MAX_LUNS;\nmodule_param(ql2xmaxlun, ullong, S_IRUGO);\nMODULE_PARM_DESC(ql2xmaxlun,\n\t\t\"Defines the maximum LU number to register with the SCSI \"\n\t\t\"midlayer. Default is 65535.\");\n\nint ql2xmdcapmask = 0x1F;\nmodule_param(ql2xmdcapmask, int, S_IRUGO);\nMODULE_PARM_DESC(ql2xmdcapmask,\n\t\t\"Set the Minidump driver capture mask level. \"\n\t\t\"Default is 0x1F - Can be set to 0x3, 0x7, 0xF, 0x1F, 0x7F.\");\n\nint ql2xmdenable = 1;\nmodule_param(ql2xmdenable, int, S_IRUGO);\nMODULE_PARM_DESC(ql2xmdenable,\n\t\t\"Enable/disable MiniDump. \"\n\t\t\"0 - MiniDump disabled. \"\n\t\t\"1 (Default) - MiniDump enabled.\");\n\nint ql2xexlogins;\nmodule_param(ql2xexlogins, uint, S_IRUGO|S_IWUSR);\nMODULE_PARM_DESC(ql2xexlogins,\n\t\t \"Number of extended Logins. \"\n\t\t \"0 (Default)- Disabled.\");\n\nint ql2xexchoffld = 1024;\nmodule_param(ql2xexchoffld, uint, 0644);\nMODULE_PARM_DESC(ql2xexchoffld,\n\t\"Number of target exchanges.\");\n\nint ql2xiniexchg = 1024;\nmodule_param(ql2xiniexchg, uint, 0644);\nMODULE_PARM_DESC(ql2xiniexchg,\n\t\"Number of initiator exchanges.\");\n\nint ql2xfwholdabts;\nmodule_param(ql2xfwholdabts, int, S_IRUGO);\nMODULE_PARM_DESC(ql2xfwholdabts,\n\t\t\"Allow FW to hold status IOCB until ABTS rsp received. \"\n\t\t\"0 (Default) Do not set fw option. \"\n\t\t\"1 - Set fw option to hold ABTS.\");\n\nint ql2xmvasynctoatio = 1;\nmodule_param(ql2xmvasynctoatio, int, S_IRUGO|S_IWUSR);\nMODULE_PARM_DESC(ql2xmvasynctoatio,\n\t\t\"Move PUREX, ABTS RX and RIDA IOCBs to ATIOQ\"\n\t\t\"0 (Default). Do not move IOCBs\"\n\t\t\"1 - Move IOCBs.\");\n\nint ql2xautodetectsfp = 1;\nmodule_param(ql2xautodetectsfp, int, 0444);\nMODULE_PARM_DESC(ql2xautodetectsfp,\n\t\t \"Detect SFP range and set appropriate distance.\\n\"\n\t\t \"1 (Default): Enable\\n\");\n\nint ql2xenablemsix = 1;\nmodule_param(ql2xenablemsix, int, 0444);\nMODULE_PARM_DESC(ql2xenablemsix,\n\t\t \"Set to enable MSI or MSI-X interrupt mechanism.\\n\"\n\t\t \" Default is 1, enable MSI-X interrupt mechanism.\\n\"\n\t\t \" 0 -- enable traditional pin-based mechanism.\\n\"\n\t\t \" 1 -- enable MSI-X interrupt mechanism.\\n\"\n\t\t \" 2 -- enable MSI interrupt mechanism.\\n\");\n\nint qla2xuseresexchforels;\nmodule_param(qla2xuseresexchforels, int, 0444);\nMODULE_PARM_DESC(qla2xuseresexchforels,\n\t\t \"Reserve 1/2 of emergency exchanges for ELS.\\n\"\n\t\t \" 0 (default): disabled\");\n\nstatic int ql2xprotmask;\nmodule_param(ql2xprotmask, int, 0644);\nMODULE_PARM_DESC(ql2xprotmask,\n\t\t \"Override DIF/DIX protection capabilities mask\\n\"\n\t\t \"Default is 0 which sets protection mask based on \"\n\t\t \"capabilities reported by HBA firmware.\\n\");\n\nstatic int ql2xprotguard;\nmodule_param(ql2xprotguard, int, 0644);\nMODULE_PARM_DESC(ql2xprotguard, \"Override choice of DIX checksum\\n\"\n\t\t \"  0 -- Let HBA firmware decide\\n\"\n\t\t \"  1 -- Force T10 CRC\\n\"\n\t\t \"  2 -- Force IP checksum\\n\");\n\nint ql2xdifbundlinginternalbuffers;\nmodule_param(ql2xdifbundlinginternalbuffers, int, 0644);\nMODULE_PARM_DESC(ql2xdifbundlinginternalbuffers,\n    \"Force using internal buffers for DIF information\\n\"\n    \"0 (Default). Based on check.\\n\"\n    \"1 Force using internal buffers\\n\");\n\nint ql2xsmartsan;\nmodule_param(ql2xsmartsan, int, 0444);\nmodule_param_named(smartsan, ql2xsmartsan, int, 0444);\nMODULE_PARM_DESC(ql2xsmartsan,\n\t\t\"Send SmartSAN Management Attributes for FDMI Registration.\"\n\t\t\" Default is 0 - No SmartSAN registration,\"\n\t\t\" 1 - Register SmartSAN Management Attributes.\");\n\nint ql2xrdpenable;\nmodule_param(ql2xrdpenable, int, 0444);\nmodule_param_named(rdpenable, ql2xrdpenable, int, 0444);\nMODULE_PARM_DESC(ql2xrdpenable,\n\t\t\"Enables RDP responses. \"\n\t\t\"0 - no RDP responses (default). \"\n\t\t\"1 - provide RDP responses.\");\n\nstatic void qla2x00_clear_drv_active(struct qla_hw_data *);\nstatic void qla2x00_free_device(scsi_qla_host_t *);\nstatic int qla2xxx_map_queues(struct Scsi_Host *shost);\nstatic void qla2x00_destroy_deferred_work(struct qla_hw_data *);\n\n\nstatic struct scsi_transport_template *qla2xxx_transport_template = NULL;\nstruct scsi_transport_template *qla2xxx_transport_vport_template = NULL;\n\n/* TODO Convert to inlines\n *\n * Timer routines\n */\n\n__inline__ void\nqla2x00_start_timer(scsi_qla_host_t *vha, unsigned long interval)\n{\n\ttimer_setup(&vha->timer, qla2x00_timer, 0);\n\tvha->timer.expires = jiffies + interval * HZ;\n\tadd_timer(&vha->timer);\n\tvha->timer_active = 1;\n}\n\nstatic inline void\nqla2x00_restart_timer(scsi_qla_host_t *vha, unsigned long interval)\n{\n\t/* Currently used for 82XX only. */\n\tif (vha->device_flags & DFLG_DEV_FAILED) {\n\t\tql_dbg(ql_dbg_timer, vha, 0x600d,\n\t\t    \"Device in a failed state, returning.\\n\");\n\t\treturn;\n\t}\n\n\tmod_timer(&vha->timer, jiffies + interval * HZ);\n}\n\nstatic __inline__ void\nqla2x00_stop_timer(scsi_qla_host_t *vha)\n{\n\tdel_timer_sync(&vha->timer);\n\tvha->timer_active = 0;\n}\n\nstatic int qla2x00_do_dpc(void *data);\n\nstatic void qla2x00_rst_aen(scsi_qla_host_t *);\n\nstatic int qla2x00_mem_alloc(struct qla_hw_data *, uint16_t, uint16_t,\n\tstruct req_que **, struct rsp_que **);\nstatic void qla2x00_free_fw_dump(struct qla_hw_data *);\nstatic void qla2x00_mem_free(struct qla_hw_data *);\nint qla2xxx_mqueuecommand(struct Scsi_Host *host, struct scsi_cmnd *cmd,\n\tstruct qla_qpair *qpair);\n\n/* -------------------------------------------------------------------------- */\nstatic void qla_init_base_qpair(struct scsi_qla_host *vha, struct req_que *req,\n    struct rsp_que *rsp)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\n\trsp->qpair = ha->base_qpair;\n\trsp->req = req;\n\tha->base_qpair->hw = ha;\n\tha->base_qpair->req = req;\n\tha->base_qpair->rsp = rsp;\n\tha->base_qpair->vha = vha;\n\tha->base_qpair->qp_lock_ptr = &ha->hardware_lock;\n\tha->base_qpair->use_shadow_reg = IS_SHADOW_REG_CAPABLE(ha) ? 1 : 0;\n\tha->base_qpair->msix = &ha->msix_entries[QLA_MSIX_RSP_Q];\n\tha->base_qpair->srb_mempool = ha->srb_mempool;\n\tINIT_LIST_HEAD(&ha->base_qpair->hints_list);\n\tha->base_qpair->enable_class_2 = ql2xenableclass2;\n\t/* init qpair to this cpu. Will adjust at run time. */\n\tqla_cpu_update(rsp->qpair, raw_smp_processor_id());\n\tha->base_qpair->pdev = ha->pdev;\n\n\tif (IS_QLA27XX(ha) || IS_QLA83XX(ha) || IS_QLA28XX(ha))\n\t\tha->base_qpair->reqq_start_iocbs = qla_83xx_start_iocbs;\n}\n\nstatic int qla2x00_alloc_queues(struct qla_hw_data *ha, struct req_que *req,\n\t\t\t\tstruct rsp_que *rsp)\n{\n\tscsi_qla_host_t *vha = pci_get_drvdata(ha->pdev);\n\n\tha->req_q_map = kcalloc(ha->max_req_queues, sizeof(struct req_que *),\n\t\t\t\tGFP_KERNEL);\n\tif (!ha->req_q_map) {\n\t\tql_log(ql_log_fatal, vha, 0x003b,\n\t\t    \"Unable to allocate memory for request queue ptrs.\\n\");\n\t\tgoto fail_req_map;\n\t}\n\n\tha->rsp_q_map = kcalloc(ha->max_rsp_queues, sizeof(struct rsp_que *),\n\t\t\t\tGFP_KERNEL);\n\tif (!ha->rsp_q_map) {\n\t\tql_log(ql_log_fatal, vha, 0x003c,\n\t\t    \"Unable to allocate memory for response queue ptrs.\\n\");\n\t\tgoto fail_rsp_map;\n\t}\n\n\tha->base_qpair = kzalloc(sizeof(struct qla_qpair), GFP_KERNEL);\n\tif (ha->base_qpair == NULL) {\n\t\tql_log(ql_log_warn, vha, 0x00e0,\n\t\t    \"Failed to allocate base queue pair memory.\\n\");\n\t\tgoto fail_base_qpair;\n\t}\n\n\tqla_init_base_qpair(vha, req, rsp);\n\n\tif ((ql2xmqsupport || ql2xnvmeenable) && ha->max_qpairs) {\n\t\tha->queue_pair_map = kcalloc(ha->max_qpairs, sizeof(struct qla_qpair *),\n\t\t\tGFP_KERNEL);\n\t\tif (!ha->queue_pair_map) {\n\t\t\tql_log(ql_log_fatal, vha, 0x0180,\n\t\t\t    \"Unable to allocate memory for queue pair ptrs.\\n\");\n\t\t\tgoto fail_qpair_map;\n\t\t}\n\t}\n\n\t/*\n\t * Make sure we record at least the request and response queue zero in\n\t * case we need to free them if part of the probe fails.\n\t */\n\tha->rsp_q_map[0] = rsp;\n\tha->req_q_map[0] = req;\n\tset_bit(0, ha->rsp_qid_map);\n\tset_bit(0, ha->req_qid_map);\n\treturn 0;\n\nfail_qpair_map:\n\tkfree(ha->base_qpair);\n\tha->base_qpair = NULL;\nfail_base_qpair:\n\tkfree(ha->rsp_q_map);\n\tha->rsp_q_map = NULL;\nfail_rsp_map:\n\tkfree(ha->req_q_map);\n\tha->req_q_map = NULL;\nfail_req_map:\n\treturn -ENOMEM;\n}\n\nstatic void qla2x00_free_req_que(struct qla_hw_data *ha, struct req_que *req)\n{\n\tif (IS_QLAFX00(ha)) {\n\t\tif (req && req->ring_fx00)\n\t\t\tdma_free_coherent(&ha->pdev->dev,\n\t\t\t    (req->length_fx00 + 1) * sizeof(request_t),\n\t\t\t    req->ring_fx00, req->dma_fx00);\n\t} else if (req && req->ring)\n\t\tdma_free_coherent(&ha->pdev->dev,\n\t\t(req->length + 1) * sizeof(request_t),\n\t\treq->ring, req->dma);\n\n\tif (req)\n\t\tkfree(req->outstanding_cmds);\n\n\tkfree(req);\n}\n\nstatic void qla2x00_free_rsp_que(struct qla_hw_data *ha, struct rsp_que *rsp)\n{\n\tif (IS_QLAFX00(ha)) {\n\t\tif (rsp && rsp->ring_fx00)\n\t\t\tdma_free_coherent(&ha->pdev->dev,\n\t\t\t    (rsp->length_fx00 + 1) * sizeof(request_t),\n\t\t\t    rsp->ring_fx00, rsp->dma_fx00);\n\t} else if (rsp && rsp->ring) {\n\t\tdma_free_coherent(&ha->pdev->dev,\n\t\t(rsp->length + 1) * sizeof(response_t),\n\t\trsp->ring, rsp->dma);\n\t}\n\tkfree(rsp);\n}\n\nstatic void qla2x00_free_queues(struct qla_hw_data *ha)\n{\n\tstruct req_que *req;\n\tstruct rsp_que *rsp;\n\tint cnt;\n\tunsigned long flags;\n\n\tif (ha->queue_pair_map) {\n\t\tkfree(ha->queue_pair_map);\n\t\tha->queue_pair_map = NULL;\n\t}\n\tif (ha->base_qpair) {\n\t\tkfree(ha->base_qpair);\n\t\tha->base_qpair = NULL;\n\t}\n\n\tspin_lock_irqsave(&ha->hardware_lock, flags);\n\tfor (cnt = 0; cnt < ha->max_req_queues; cnt++) {\n\t\tif (!test_bit(cnt, ha->req_qid_map))\n\t\t\tcontinue;\n\n\t\treq = ha->req_q_map[cnt];\n\t\tclear_bit(cnt, ha->req_qid_map);\n\t\tha->req_q_map[cnt] = NULL;\n\n\t\tspin_unlock_irqrestore(&ha->hardware_lock, flags);\n\t\tqla2x00_free_req_que(ha, req);\n\t\tspin_lock_irqsave(&ha->hardware_lock, flags);\n\t}\n\tspin_unlock_irqrestore(&ha->hardware_lock, flags);\n\n\tkfree(ha->req_q_map);\n\tha->req_q_map = NULL;\n\n\n\tspin_lock_irqsave(&ha->hardware_lock, flags);\n\tfor (cnt = 0; cnt < ha->max_rsp_queues; cnt++) {\n\t\tif (!test_bit(cnt, ha->rsp_qid_map))\n\t\t\tcontinue;\n\n\t\trsp = ha->rsp_q_map[cnt];\n\t\tclear_bit(cnt, ha->rsp_qid_map);\n\t\tha->rsp_q_map[cnt] =  NULL;\n\t\tspin_unlock_irqrestore(&ha->hardware_lock, flags);\n\t\tqla2x00_free_rsp_que(ha, rsp);\n\t\tspin_lock_irqsave(&ha->hardware_lock, flags);\n\t}\n\tspin_unlock_irqrestore(&ha->hardware_lock, flags);\n\n\tkfree(ha->rsp_q_map);\n\tha->rsp_q_map = NULL;\n}\n\nstatic char *\nqla2x00_pci_info_str(struct scsi_qla_host *vha, char *str, size_t str_len)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tstatic const char *const pci_bus_modes[] = {\n\t\t\"33\", \"66\", \"100\", \"133\",\n\t};\n\tuint16_t pci_bus;\n\n\tpci_bus = (ha->pci_attr & (BIT_9 | BIT_10)) >> 9;\n\tif (pci_bus) {\n\t\tsnprintf(str, str_len, \"PCI-X (%s MHz)\",\n\t\t\t pci_bus_modes[pci_bus]);\n\t} else {\n\t\tpci_bus = (ha->pci_attr & BIT_8) >> 8;\n\t\tsnprintf(str, str_len, \"PCI (%s MHz)\", pci_bus_modes[pci_bus]);\n\t}\n\n\treturn str;\n}\n\nstatic char *\nqla24xx_pci_info_str(struct scsi_qla_host *vha, char *str, size_t str_len)\n{\n\tstatic const char *const pci_bus_modes[] = {\n\t\t\"33\", \"66\", \"100\", \"133\",\n\t};\n\tstruct qla_hw_data *ha = vha->hw;\n\tuint32_t pci_bus;\n\n\tif (pci_is_pcie(ha->pdev)) {\n\t\tuint32_t lstat, lspeed, lwidth;\n\t\tconst char *speed_str;\n\n\t\tpcie_capability_read_dword(ha->pdev, PCI_EXP_LNKCAP, &lstat);\n\t\tlspeed = lstat & PCI_EXP_LNKCAP_SLS;\n\t\tlwidth = (lstat & PCI_EXP_LNKCAP_MLW) >> 4;\n\n\t\tswitch (lspeed) {\n\t\tcase 1:\n\t\t\tspeed_str = \"2.5GT/s\";\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\tspeed_str = \"5.0GT/s\";\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\tspeed_str = \"8.0GT/s\";\n\t\t\tbreak;\n\t\tcase 4:\n\t\t\tspeed_str = \"16.0GT/s\";\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tspeed_str = \"<unknown>\";\n\t\t\tbreak;\n\t\t}\n\t\tsnprintf(str, str_len, \"PCIe (%s x%d)\", speed_str, lwidth);\n\n\t\treturn str;\n\t}\n\n\tpci_bus = (ha->pci_attr & CSRX_PCIX_BUS_MODE_MASK) >> 8;\n\tif (pci_bus == 0 || pci_bus == 8)\n\t\tsnprintf(str, str_len, \"PCI (%s MHz)\",\n\t\t\t pci_bus_modes[pci_bus >> 3]);\n\telse\n\t\tsnprintf(str, str_len, \"PCI-X Mode %d (%s MHz)\",\n\t\t\t pci_bus & 4 ? 2 : 1,\n\t\t\t pci_bus_modes[pci_bus & 3]);\n\n\treturn str;\n}\n\nstatic char *\nqla2x00_fw_version_str(struct scsi_qla_host *vha, char *str, size_t size)\n{\n\tchar un_str[10];\n\tstruct qla_hw_data *ha = vha->hw;\n\n\tsnprintf(str, size, \"%d.%02d.%02d \", ha->fw_major_version,\n\t    ha->fw_minor_version, ha->fw_subminor_version);\n\n\tif (ha->fw_attributes & BIT_9) {\n\t\tstrcat(str, \"FLX\");\n\t\treturn (str);\n\t}\n\n\tswitch (ha->fw_attributes & 0xFF) {\n\tcase 0x7:\n\t\tstrcat(str, \"EF\");\n\t\tbreak;\n\tcase 0x17:\n\t\tstrcat(str, \"TP\");\n\t\tbreak;\n\tcase 0x37:\n\t\tstrcat(str, \"IP\");\n\t\tbreak;\n\tcase 0x77:\n\t\tstrcat(str, \"VI\");\n\t\tbreak;\n\tdefault:\n\t\tsprintf(un_str, \"(%x)\", ha->fw_attributes);\n\t\tstrcat(str, un_str);\n\t\tbreak;\n\t}\n\tif (ha->fw_attributes & 0x100)\n\t\tstrcat(str, \"X\");\n\n\treturn (str);\n}\n\nstatic char *\nqla24xx_fw_version_str(struct scsi_qla_host *vha, char *str, size_t size)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\n\tsnprintf(str, size, \"%d.%02d.%02d (%x)\", ha->fw_major_version,\n\t    ha->fw_minor_version, ha->fw_subminor_version, ha->fw_attributes);\n\treturn str;\n}\n\nvoid qla2x00_sp_free_dma(srb_t *sp)\n{\n\tstruct qla_hw_data *ha = sp->vha->hw;\n\tstruct scsi_cmnd *cmd = GET_CMD_SP(sp);\n\n\tif (sp->flags & SRB_DMA_VALID) {\n\t\tscsi_dma_unmap(cmd);\n\t\tsp->flags &= ~SRB_DMA_VALID;\n\t}\n\n\tif (sp->flags & SRB_CRC_PROT_DMA_VALID) {\n\t\tdma_unmap_sg(&ha->pdev->dev, scsi_prot_sglist(cmd),\n\t\t    scsi_prot_sg_count(cmd), cmd->sc_data_direction);\n\t\tsp->flags &= ~SRB_CRC_PROT_DMA_VALID;\n\t}\n\n\tif (sp->flags & SRB_CRC_CTX_DSD_VALID) {\n\t\t/* List assured to be having elements */\n\t\tqla2x00_clean_dsd_pool(ha, sp->u.scmd.crc_ctx);\n\t\tsp->flags &= ~SRB_CRC_CTX_DSD_VALID;\n\t}\n\n\tif (sp->flags & SRB_CRC_CTX_DMA_VALID) {\n\t\tstruct crc_context *ctx0 = sp->u.scmd.crc_ctx;\n\n\t\tdma_pool_free(ha->dl_dma_pool, ctx0, ctx0->crc_ctx_dma);\n\t\tsp->flags &= ~SRB_CRC_CTX_DMA_VALID;\n\t}\n\n\tif (sp->flags & SRB_FCP_CMND_DMA_VALID) {\n\t\tstruct ct6_dsd *ctx1 = sp->u.scmd.ct6_ctx;\n\n\t\tdma_pool_free(ha->fcp_cmnd_dma_pool, ctx1->fcp_cmnd,\n\t\t    ctx1->fcp_cmnd_dma);\n\t\tlist_splice(&ctx1->dsd_list, &ha->gbl_dsd_list);\n\t\tha->gbl_dsd_inuse -= ctx1->dsd_use_cnt;\n\t\tha->gbl_dsd_avail += ctx1->dsd_use_cnt;\n\t\tmempool_free(ctx1, ha->ctx_mempool);\n\t}\n}\n\nvoid qla2x00_sp_compl(srb_t *sp, int res)\n{\n\tstruct scsi_cmnd *cmd = GET_CMD_SP(sp);\n\tstruct completion *comp = sp->comp;\n\n\tsp->free(sp);\n\tcmd->result = res;\n\tCMD_SP(cmd) = NULL;\n\tcmd->scsi_done(cmd);\n\tif (comp)\n\t\tcomplete(comp);\n}\n\nvoid qla2xxx_qpair_sp_free_dma(srb_t *sp)\n{\n\tstruct scsi_cmnd *cmd = GET_CMD_SP(sp);\n\tstruct qla_hw_data *ha = sp->fcport->vha->hw;\n\n\tif (sp->flags & SRB_DMA_VALID) {\n\t\tscsi_dma_unmap(cmd);\n\t\tsp->flags &= ~SRB_DMA_VALID;\n\t}\n\n\tif (sp->flags & SRB_CRC_PROT_DMA_VALID) {\n\t\tdma_unmap_sg(&ha->pdev->dev, scsi_prot_sglist(cmd),\n\t\t    scsi_prot_sg_count(cmd), cmd->sc_data_direction);\n\t\tsp->flags &= ~SRB_CRC_PROT_DMA_VALID;\n\t}\n\n\tif (sp->flags & SRB_CRC_CTX_DSD_VALID) {\n\t\t/* List assured to be having elements */\n\t\tqla2x00_clean_dsd_pool(ha, sp->u.scmd.crc_ctx);\n\t\tsp->flags &= ~SRB_CRC_CTX_DSD_VALID;\n\t}\n\n\tif (sp->flags & SRB_DIF_BUNDL_DMA_VALID) {\n\t\tstruct crc_context *difctx = sp->u.scmd.crc_ctx;\n\t\tstruct dsd_dma *dif_dsd, *nxt_dsd;\n\n\t\tlist_for_each_entry_safe(dif_dsd, nxt_dsd,\n\t\t    &difctx->ldif_dma_hndl_list, list) {\n\t\t\tlist_del(&dif_dsd->list);\n\t\t\tdma_pool_free(ha->dif_bundl_pool, dif_dsd->dsd_addr,\n\t\t\t    dif_dsd->dsd_list_dma);\n\t\t\tkfree(dif_dsd);\n\t\t\tdifctx->no_dif_bundl--;\n\t\t}\n\n\t\tlist_for_each_entry_safe(dif_dsd, nxt_dsd,\n\t\t    &difctx->ldif_dsd_list, list) {\n\t\t\tlist_del(&dif_dsd->list);\n\t\t\tdma_pool_free(ha->dl_dma_pool, dif_dsd->dsd_addr,\n\t\t\t    dif_dsd->dsd_list_dma);\n\t\t\tkfree(dif_dsd);\n\t\t\tdifctx->no_ldif_dsd--;\n\t\t}\n\n\t\tif (difctx->no_ldif_dsd) {\n\t\t\tql_dbg(ql_dbg_tgt+ql_dbg_verbose, sp->vha, 0xe022,\n\t\t\t    \"%s: difctx->no_ldif_dsd=%x\\n\",\n\t\t\t    __func__, difctx->no_ldif_dsd);\n\t\t}\n\n\t\tif (difctx->no_dif_bundl) {\n\t\t\tql_dbg(ql_dbg_tgt+ql_dbg_verbose, sp->vha, 0xe022,\n\t\t\t    \"%s: difctx->no_dif_bundl=%x\\n\",\n\t\t\t    __func__, difctx->no_dif_bundl);\n\t\t}\n\t\tsp->flags &= ~SRB_DIF_BUNDL_DMA_VALID;\n\t}\n\n\tif (sp->flags & SRB_FCP_CMND_DMA_VALID) {\n\t\tstruct ct6_dsd *ctx1 = sp->u.scmd.ct6_ctx;\n\n\t\tdma_pool_free(ha->fcp_cmnd_dma_pool, ctx1->fcp_cmnd,\n\t\t    ctx1->fcp_cmnd_dma);\n\t\tlist_splice(&ctx1->dsd_list, &ha->gbl_dsd_list);\n\t\tha->gbl_dsd_inuse -= ctx1->dsd_use_cnt;\n\t\tha->gbl_dsd_avail += ctx1->dsd_use_cnt;\n\t\tmempool_free(ctx1, ha->ctx_mempool);\n\t\tsp->flags &= ~SRB_FCP_CMND_DMA_VALID;\n\t}\n\n\tif (sp->flags & SRB_CRC_CTX_DMA_VALID) {\n\t\tstruct crc_context *ctx0 = sp->u.scmd.crc_ctx;\n\n\t\tdma_pool_free(ha->dl_dma_pool, ctx0, ctx0->crc_ctx_dma);\n\t\tsp->flags &= ~SRB_CRC_CTX_DMA_VALID;\n\t}\n}\n\nvoid qla2xxx_qpair_sp_compl(srb_t *sp, int res)\n{\n\tstruct scsi_cmnd *cmd = GET_CMD_SP(sp);\n\tstruct completion *comp = sp->comp;\n\n\tsp->free(sp);\n\tcmd->result = res;\n\tCMD_SP(cmd) = NULL;\n\tcmd->scsi_done(cmd);\n\tif (comp)\n\t\tcomplete(comp);\n}\n\nstatic int\nqla2xxx_queuecommand(struct Scsi_Host *host, struct scsi_cmnd *cmd)\n{\n\tscsi_qla_host_t *vha = shost_priv(host);\n\tfc_port_t *fcport = (struct fc_port *) cmd->device->hostdata;\n\tstruct fc_rport *rport = starget_to_rport(scsi_target(cmd->device));\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct scsi_qla_host *base_vha = pci_get_drvdata(ha->pdev);\n\tsrb_t *sp;\n\tint rval;\n\n\tif (unlikely(test_bit(UNLOADING, &base_vha->dpc_flags)) ||\n\t    WARN_ON_ONCE(!rport)) {\n\t\tcmd->result = DID_NO_CONNECT << 16;\n\t\tgoto qc24_fail_command;\n\t}\n\n\tif (ha->mqenable) {\n\t\tuint32_t tag;\n\t\tuint16_t hwq;\n\t\tstruct qla_qpair *qpair = NULL;\n\n\t\ttag = blk_mq_unique_tag(cmd->request);\n\t\thwq = blk_mq_unique_tag_to_hwq(tag);\n\t\tqpair = ha->queue_pair_map[hwq];\n\n\t\tif (qpair)\n\t\t\treturn qla2xxx_mqueuecommand(host, cmd, qpair);\n\t}\n\n\tif (ha->flags.eeh_busy) {\n\t\tif (ha->flags.pci_channel_io_perm_failure) {\n\t\t\tql_dbg(ql_dbg_aer, vha, 0x9010,\n\t\t\t    \"PCI Channel IO permanent failure, exiting \"\n\t\t\t    \"cmd=%p.\\n\", cmd);\n\t\t\tcmd->result = DID_NO_CONNECT << 16;\n\t\t} else {\n\t\t\tql_dbg(ql_dbg_aer, vha, 0x9011,\n\t\t\t    \"EEH_Busy, Requeuing the cmd=%p.\\n\", cmd);\n\t\t\tcmd->result = DID_REQUEUE << 16;\n\t\t}\n\t\tgoto qc24_fail_command;\n\t}\n\n\trval = fc_remote_port_chkready(rport);\n\tif (rval) {\n\t\tcmd->result = rval;\n\t\tql_dbg(ql_dbg_io + ql_dbg_verbose, vha, 0x3003,\n\t\t    \"fc_remote_port_chkready failed for cmd=%p, rval=0x%x.\\n\",\n\t\t    cmd, rval);\n\t\tgoto qc24_fail_command;\n\t}\n\n\tif (!vha->flags.difdix_supported &&\n\t\tscsi_get_prot_op(cmd) != SCSI_PROT_NORMAL) {\n\t\t\tql_dbg(ql_dbg_io, vha, 0x3004,\n\t\t\t    \"DIF Cap not reg, fail DIF capable cmd's:%p.\\n\",\n\t\t\t    cmd);\n\t\t\tcmd->result = DID_NO_CONNECT << 16;\n\t\t\tgoto qc24_fail_command;\n\t}\n\n\tif (!fcport) {\n\t\tcmd->result = DID_NO_CONNECT << 16;\n\t\tgoto qc24_fail_command;\n\t}\n\n\tif (atomic_read(&fcport->state) != FCS_ONLINE || fcport->deleted) {\n\t\tif (atomic_read(&fcport->state) == FCS_DEVICE_DEAD ||\n\t\t\tatomic_read(&base_vha->loop_state) == LOOP_DEAD) {\n\t\t\tql_dbg(ql_dbg_io, vha, 0x3005,\n\t\t\t    \"Returning DNC, fcport_state=%d loop_state=%d.\\n\",\n\t\t\t    atomic_read(&fcport->state),\n\t\t\t    atomic_read(&base_vha->loop_state));\n\t\t\tcmd->result = DID_NO_CONNECT << 16;\n\t\t\tgoto qc24_fail_command;\n\t\t}\n\t\tgoto qc24_target_busy;\n\t}\n\n\t/*\n\t * Return target busy if we've received a non-zero retry_delay_timer\n\t * in a FCP_RSP.\n\t */\n\tif (fcport->retry_delay_timestamp == 0) {\n\t\t/* retry delay not set */\n\t} else if (time_after(jiffies, fcport->retry_delay_timestamp))\n\t\tfcport->retry_delay_timestamp = 0;\n\telse\n\t\tgoto qc24_target_busy;\n\n\tsp = scsi_cmd_priv(cmd);\n\tqla2xxx_init_sp(sp, vha, vha->hw->base_qpair, fcport);\n\n\tsp->u.scmd.cmd = cmd;\n\tsp->type = SRB_SCSI_CMD;\n\n\tCMD_SP(cmd) = (void *)sp;\n\tsp->free = qla2x00_sp_free_dma;\n\tsp->done = qla2x00_sp_compl;\n\n\trval = ha->isp_ops->start_scsi(sp);\n\tif (rval != QLA_SUCCESS) {\n\t\tql_dbg(ql_dbg_io + ql_dbg_verbose, vha, 0x3013,\n\t\t    \"Start scsi failed rval=%d for cmd=%p.\\n\", rval, cmd);\n\t\tgoto qc24_host_busy_free_sp;\n\t}\n\n\treturn 0;\n\nqc24_host_busy_free_sp:\n\tsp->free(sp);\n\nqc24_target_busy:\n\treturn SCSI_MLQUEUE_TARGET_BUSY;\n\nqc24_fail_command:\n\tcmd->scsi_done(cmd);\n\n\treturn 0;\n}\n\n/* For MQ supported I/O */\nint\nqla2xxx_mqueuecommand(struct Scsi_Host *host, struct scsi_cmnd *cmd,\n    struct qla_qpair *qpair)\n{\n\tscsi_qla_host_t *vha = shost_priv(host);\n\tfc_port_t *fcport = (struct fc_port *) cmd->device->hostdata;\n\tstruct fc_rport *rport = starget_to_rport(scsi_target(cmd->device));\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct scsi_qla_host *base_vha = pci_get_drvdata(ha->pdev);\n\tsrb_t *sp;\n\tint rval;\n\n\trval = rport ? fc_remote_port_chkready(rport) : FC_PORTSTATE_OFFLINE;\n\tif (rval) {\n\t\tcmd->result = rval;\n\t\tql_dbg(ql_dbg_io + ql_dbg_verbose, vha, 0x3076,\n\t\t    \"fc_remote_port_chkready failed for cmd=%p, rval=0x%x.\\n\",\n\t\t    cmd, rval);\n\t\tgoto qc24_fail_command;\n\t}\n\n\tif (!fcport) {\n\t\tcmd->result = DID_NO_CONNECT << 16;\n\t\tgoto qc24_fail_command;\n\t}\n\n\tif (atomic_read(&fcport->state) != FCS_ONLINE || fcport->deleted) {\n\t\tif (atomic_read(&fcport->state) == FCS_DEVICE_DEAD ||\n\t\t\tatomic_read(&base_vha->loop_state) == LOOP_DEAD) {\n\t\t\tql_dbg(ql_dbg_io, vha, 0x3077,\n\t\t\t    \"Returning DNC, fcport_state=%d loop_state=%d.\\n\",\n\t\t\t    atomic_read(&fcport->state),\n\t\t\t    atomic_read(&base_vha->loop_state));\n\t\t\tcmd->result = DID_NO_CONNECT << 16;\n\t\t\tgoto qc24_fail_command;\n\t\t}\n\t\tgoto qc24_target_busy;\n\t}\n\n\t/*\n\t * Return target busy if we've received a non-zero retry_delay_timer\n\t * in a FCP_RSP.\n\t */\n\tif (fcport->retry_delay_timestamp == 0) {\n\t\t/* retry delay not set */\n\t} else if (time_after(jiffies, fcport->retry_delay_timestamp))\n\t\tfcport->retry_delay_timestamp = 0;\n\telse\n\t\tgoto qc24_target_busy;\n\n\tsp = scsi_cmd_priv(cmd);\n\tqla2xxx_init_sp(sp, vha, qpair, fcport);\n\n\tsp->u.scmd.cmd = cmd;\n\tsp->type = SRB_SCSI_CMD;\n\tCMD_SP(cmd) = (void *)sp;\n\tsp->free = qla2xxx_qpair_sp_free_dma;\n\tsp->done = qla2xxx_qpair_sp_compl;\n\n\trval = ha->isp_ops->start_scsi_mq(sp);\n\tif (rval != QLA_SUCCESS) {\n\t\tql_dbg(ql_dbg_io + ql_dbg_verbose, vha, 0x3078,\n\t\t    \"Start scsi failed rval=%d for cmd=%p.\\n\", rval, cmd);\n\t\tif (rval == QLA_INTERFACE_ERROR)\n\t\t\tgoto qc24_free_sp_fail_command;\n\t\tgoto qc24_host_busy_free_sp;\n\t}\n\n\treturn 0;\n\nqc24_host_busy_free_sp:\n\tsp->free(sp);\n\nqc24_target_busy:\n\treturn SCSI_MLQUEUE_TARGET_BUSY;\n\nqc24_free_sp_fail_command:\n\tsp->free(sp);\n\tCMD_SP(cmd) = NULL;\n\tqla2xxx_rel_qpair_sp(sp->qpair, sp);\n\nqc24_fail_command:\n\tcmd->scsi_done(cmd);\n\n\treturn 0;\n}\n\n/*\n * qla2x00_eh_wait_on_command\n *    Waits for the command to be returned by the Firmware for some\n *    max time.\n *\n * Input:\n *    cmd = Scsi Command to wait on.\n *\n * Return:\n *    Completed in time : QLA_SUCCESS\n *    Did not complete in time : QLA_FUNCTION_FAILED\n */\nstatic int\nqla2x00_eh_wait_on_command(struct scsi_cmnd *cmd)\n{\n#define ABORT_POLLING_PERIOD\t1000\n#define ABORT_WAIT_ITER\t\t((2 * 1000) / (ABORT_POLLING_PERIOD))\n\tunsigned long wait_iter = ABORT_WAIT_ITER;\n\tscsi_qla_host_t *vha = shost_priv(cmd->device->host);\n\tstruct qla_hw_data *ha = vha->hw;\n\tint ret = QLA_SUCCESS;\n\n\tif (unlikely(pci_channel_offline(ha->pdev)) || ha->flags.eeh_busy) {\n\t\tql_dbg(ql_dbg_taskm, vha, 0x8005,\n\t\t    \"Return:eh_wait.\\n\");\n\t\treturn ret;\n\t}\n\n\twhile (CMD_SP(cmd) && wait_iter--) {\n\t\tmsleep(ABORT_POLLING_PERIOD);\n\t}\n\tif (CMD_SP(cmd))\n\t\tret = QLA_FUNCTION_FAILED;\n\n\treturn ret;\n}\n\n/*\n * qla2x00_wait_for_hba_online\n *    Wait till the HBA is online after going through\n *    <= MAX_RETRIES_OF_ISP_ABORT  or\n *    finally HBA is disabled ie marked offline\n *\n * Input:\n *     ha - pointer to host adapter structure\n *\n * Note:\n *    Does context switching-Release SPIN_LOCK\n *    (if any) before calling this routine.\n *\n * Return:\n *    Success (Adapter is online) : 0\n *    Failed  (Adapter is offline/disabled) : 1\n */\nint\nqla2x00_wait_for_hba_online(scsi_qla_host_t *vha)\n{\n\tint\t\treturn_status;\n\tunsigned long\twait_online;\n\tstruct qla_hw_data *ha = vha->hw;\n\tscsi_qla_host_t *base_vha = pci_get_drvdata(ha->pdev);\n\n\twait_online = jiffies + (MAX_LOOP_TIMEOUT * HZ);\n\twhile (((test_bit(ISP_ABORT_NEEDED, &base_vha->dpc_flags)) ||\n\t    test_bit(ABORT_ISP_ACTIVE, &base_vha->dpc_flags) ||\n\t    test_bit(ISP_ABORT_RETRY, &base_vha->dpc_flags) ||\n\t    ha->dpc_active) && time_before(jiffies, wait_online)) {\n\n\t\tmsleep(1000);\n\t}\n\tif (base_vha->flags.online)\n\t\treturn_status = QLA_SUCCESS;\n\telse\n\t\treturn_status = QLA_FUNCTION_FAILED;\n\n\treturn (return_status);\n}\n\nstatic inline int test_fcport_count(scsi_qla_host_t *vha)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tunsigned long flags;\n\tint res;\n\n\tspin_lock_irqsave(&ha->tgt.sess_lock, flags);\n\tql_dbg(ql_dbg_init, vha, 0x00ec,\n\t    \"tgt %p, fcport_count=%d\\n\",\n\t    vha, vha->fcport_count);\n\tres = (vha->fcport_count == 0);\n\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\n\n\treturn res;\n}\n\n/*\n * qla2x00_wait_for_sess_deletion can only be called from remove_one.\n * it has dependency on UNLOADING flag to stop device discovery\n */\nvoid\nqla2x00_wait_for_sess_deletion(scsi_qla_host_t *vha)\n{\n\tu8 i;\n\n\tqla2x00_mark_all_devices_lost(vha);\n\n\tfor (i = 0; i < 10; i++) {\n\t\tif (wait_event_timeout(vha->fcport_waitQ,\n\t\t    test_fcport_count(vha), HZ) > 0)\n\t\t\tbreak;\n\t}\n\n\tflush_workqueue(vha->hw->wq);\n}\n\n/*\n * qla2x00_wait_for_hba_ready\n * Wait till the HBA is ready before doing driver unload\n *\n * Input:\n *     ha - pointer to host adapter structure\n *\n * Note:\n *    Does context switching-Release SPIN_LOCK\n *    (if any) before calling this routine.\n *\n */\nstatic void\nqla2x00_wait_for_hba_ready(scsi_qla_host_t *vha)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tscsi_qla_host_t *base_vha = pci_get_drvdata(ha->pdev);\n\n\twhile ((qla2x00_reset_active(vha) || ha->dpc_active ||\n\t\tha->flags.mbox_busy) ||\n\t       test_bit(FX00_RESET_RECOVERY, &vha->dpc_flags) ||\n\t       test_bit(FX00_TARGET_SCAN, &vha->dpc_flags)) {\n\t\tif (test_bit(UNLOADING, &base_vha->dpc_flags))\n\t\t\tbreak;\n\t\tmsleep(1000);\n\t}\n}\n\nint\nqla2x00_wait_for_chip_reset(scsi_qla_host_t *vha)\n{\n\tint\t\treturn_status;\n\tunsigned long\twait_reset;\n\tstruct qla_hw_data *ha = vha->hw;\n\tscsi_qla_host_t *base_vha = pci_get_drvdata(ha->pdev);\n\n\twait_reset = jiffies + (MAX_LOOP_TIMEOUT * HZ);\n\twhile (((test_bit(ISP_ABORT_NEEDED, &base_vha->dpc_flags)) ||\n\t    test_bit(ABORT_ISP_ACTIVE, &base_vha->dpc_flags) ||\n\t    test_bit(ISP_ABORT_RETRY, &base_vha->dpc_flags) ||\n\t    ha->dpc_active) && time_before(jiffies, wait_reset)) {\n\n\t\tmsleep(1000);\n\n\t\tif (!test_bit(ISP_ABORT_NEEDED, &base_vha->dpc_flags) &&\n\t\t    ha->flags.chip_reset_done)\n\t\t\tbreak;\n\t}\n\tif (ha->flags.chip_reset_done)\n\t\treturn_status = QLA_SUCCESS;\n\telse\n\t\treturn_status = QLA_FUNCTION_FAILED;\n\n\treturn return_status;\n}\n\n#define ISP_REG_DISCONNECT 0xffffffffU\n/**************************************************************************\n* qla2x00_isp_reg_stat\n*\n* Description:\n*\tRead the host status register of ISP before aborting the command.\n*\n* Input:\n*\tha = pointer to host adapter structure.\n*\n*\n* Returns:\n*\tEither true or false.\n*\n* Note:\tReturn true if there is register disconnect.\n**************************************************************************/\nstatic inline\nuint32_t qla2x00_isp_reg_stat(struct qla_hw_data *ha)\n{\n\tstruct device_reg_24xx __iomem *reg = &ha->iobase->isp24;\n\tstruct device_reg_82xx __iomem *reg82 = &ha->iobase->isp82;\n\n\tif (IS_P3P_TYPE(ha))\n\t\treturn ((rd_reg_dword(&reg82->host_int)) == ISP_REG_DISCONNECT);\n\telse\n\t\treturn ((rd_reg_dword(&reg->host_status)) ==\n\t\t\tISP_REG_DISCONNECT);\n}\n\n/**************************************************************************\n* qla2xxx_eh_abort\n*\n* Description:\n*    The abort function will abort the specified command.\n*\n* Input:\n*    cmd = Linux SCSI command packet to be aborted.\n*\n* Returns:\n*    Either SUCCESS or FAILED.\n*\n* Note:\n*    Only return FAILED if command not returned by firmware.\n**************************************************************************/\nstatic int\nqla2xxx_eh_abort(struct scsi_cmnd *cmd)\n{\n\tscsi_qla_host_t *vha = shost_priv(cmd->device->host);\n\tDECLARE_COMPLETION_ONSTACK(comp);\n\tsrb_t *sp;\n\tint ret;\n\tunsigned int id;\n\tuint64_t lun;\n\tint rval;\n\tstruct qla_hw_data *ha = vha->hw;\n\tuint32_t ratov_j;\n\tstruct qla_qpair *qpair;\n\tunsigned long flags;\n\n\tif (qla2x00_isp_reg_stat(ha)) {\n\t\tql_log(ql_log_info, vha, 0x8042,\n\t\t    \"PCI/Register disconnect, exiting.\\n\");\n\t\treturn FAILED;\n\t}\n\n\tret = fc_block_scsi_eh(cmd);\n\tif (ret != 0)\n\t\treturn ret;\n\n\tsp = scsi_cmd_priv(cmd);\n\tqpair = sp->qpair;\n\n\tif ((sp->fcport && sp->fcport->deleted) || !qpair)\n\t\treturn SUCCESS;\n\n\tspin_lock_irqsave(qpair->qp_lock_ptr, flags);\n\tsp->comp = &comp;\n\tspin_unlock_irqrestore(qpair->qp_lock_ptr, flags);\n\n\n\tid = cmd->device->id;\n\tlun = cmd->device->lun;\n\n\tql_dbg(ql_dbg_taskm, vha, 0x8002,\n\t    \"Aborting from RISC nexus=%ld:%d:%llu sp=%p cmd=%p handle=%x\\n\",\n\t    vha->host_no, id, lun, sp, cmd, sp->handle);\n\n\t/*\n\t * Abort will release the original Command/sp from FW. Let the\n\t * original command call scsi_done. In return, he will wakeup\n\t * this sleeping thread.\n\t */\n\trval = ha->isp_ops->abort_command(sp);\n\n\tql_dbg(ql_dbg_taskm, vha, 0x8003,\n\t       \"Abort command mbx cmd=%p, rval=%x.\\n\", cmd, rval);\n\n\t/* Wait for the command completion. */\n\tratov_j = ha->r_a_tov/10 * 4 * 1000;\n\tratov_j = msecs_to_jiffies(ratov_j);\n\tswitch (rval) {\n\tcase QLA_SUCCESS:\n\t\tif (!wait_for_completion_timeout(&comp, ratov_j)) {\n\t\t\tql_dbg(ql_dbg_taskm, vha, 0xffff,\n\t\t\t    \"%s: Abort wait timer (4 * R_A_TOV[%d]) expired\\n\",\n\t\t\t    __func__, ha->r_a_tov/10);\n\t\t\tret = FAILED;\n\t\t} else {\n\t\t\tret = SUCCESS;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tret = FAILED;\n\t\tbreak;\n\t}\n\n\tsp->comp = NULL;\n\n\tql_log(ql_log_info, vha, 0x801c,\n\t    \"Abort command issued nexus=%ld:%d:%llu -- %x.\\n\",\n\t    vha->host_no, id, lun, ret);\n\n\treturn ret;\n}\n\n/*\n * Returns: QLA_SUCCESS or QLA_FUNCTION_FAILED.\n */\nint\nqla2x00_eh_wait_for_pending_commands(scsi_qla_host_t *vha, unsigned int t,\n\tuint64_t l, enum nexus_wait_type type)\n{\n\tint cnt, match, status;\n\tunsigned long flags;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct req_que *req;\n\tsrb_t *sp;\n\tstruct scsi_cmnd *cmd;\n\n\tstatus = QLA_SUCCESS;\n\n\tspin_lock_irqsave(&ha->hardware_lock, flags);\n\treq = vha->req;\n\tfor (cnt = 1; status == QLA_SUCCESS &&\n\t\tcnt < req->num_outstanding_cmds; cnt++) {\n\t\tsp = req->outstanding_cmds[cnt];\n\t\tif (!sp)\n\t\t\tcontinue;\n\t\tif (sp->type != SRB_SCSI_CMD)\n\t\t\tcontinue;\n\t\tif (vha->vp_idx != sp->vha->vp_idx)\n\t\t\tcontinue;\n\t\tmatch = 0;\n\t\tcmd = GET_CMD_SP(sp);\n\t\tswitch (type) {\n\t\tcase WAIT_HOST:\n\t\t\tmatch = 1;\n\t\t\tbreak;\n\t\tcase WAIT_TARGET:\n\t\t\tmatch = cmd->device->id == t;\n\t\t\tbreak;\n\t\tcase WAIT_LUN:\n\t\t\tmatch = (cmd->device->id == t &&\n\t\t\t\tcmd->device->lun == l);\n\t\t\tbreak;\n\t\t}\n\t\tif (!match)\n\t\t\tcontinue;\n\n\t\tspin_unlock_irqrestore(&ha->hardware_lock, flags);\n\t\tstatus = qla2x00_eh_wait_on_command(cmd);\n\t\tspin_lock_irqsave(&ha->hardware_lock, flags);\n\t}\n\tspin_unlock_irqrestore(&ha->hardware_lock, flags);\n\n\treturn status;\n}\n\nstatic char *reset_errors[] = {\n\t\"HBA not online\",\n\t\"HBA not ready\",\n\t\"Task management failed\",\n\t\"Waiting for command completions\",\n};\n\nstatic int\n__qla2xxx_eh_generic_reset(char *name, enum nexus_wait_type type,\n    struct scsi_cmnd *cmd, int (*do_reset)(struct fc_port *, uint64_t, int))\n{\n\tscsi_qla_host_t *vha = shost_priv(cmd->device->host);\n\tfc_port_t *fcport = (struct fc_port *) cmd->device->hostdata;\n\tint err;\n\n\tif (!fcport) {\n\t\treturn FAILED;\n\t}\n\n\terr = fc_block_scsi_eh(cmd);\n\tif (err != 0)\n\t\treturn err;\n\n\tif (fcport->deleted)\n\t\treturn SUCCESS;\n\n\tql_log(ql_log_info, vha, 0x8009,\n\t    \"%s RESET ISSUED nexus=%ld:%d:%llu cmd=%p.\\n\", name, vha->host_no,\n\t    cmd->device->id, cmd->device->lun, cmd);\n\n\terr = 0;\n\tif (qla2x00_wait_for_hba_online(vha) != QLA_SUCCESS) {\n\t\tql_log(ql_log_warn, vha, 0x800a,\n\t\t    \"Wait for hba online failed for cmd=%p.\\n\", cmd);\n\t\tgoto eh_reset_failed;\n\t}\n\terr = 2;\n\tif (do_reset(fcport, cmd->device->lun, 1)\n\t\t!= QLA_SUCCESS) {\n\t\tql_log(ql_log_warn, vha, 0x800c,\n\t\t    \"do_reset failed for cmd=%p.\\n\", cmd);\n\t\tgoto eh_reset_failed;\n\t}\n\terr = 3;\n\tif (qla2x00_eh_wait_for_pending_commands(vha, cmd->device->id,\n\t    cmd->device->lun, type) != QLA_SUCCESS) {\n\t\tql_log(ql_log_warn, vha, 0x800d,\n\t\t    \"wait for pending cmds failed for cmd=%p.\\n\", cmd);\n\t\tgoto eh_reset_failed;\n\t}\n\n\tql_log(ql_log_info, vha, 0x800e,\n\t    \"%s RESET SUCCEEDED nexus:%ld:%d:%llu cmd=%p.\\n\", name,\n\t    vha->host_no, cmd->device->id, cmd->device->lun, cmd);\n\n\treturn SUCCESS;\n\neh_reset_failed:\n\tql_log(ql_log_info, vha, 0x800f,\n\t    \"%s RESET FAILED: %s nexus=%ld:%d:%llu cmd=%p.\\n\", name,\n\t    reset_errors[err], vha->host_no, cmd->device->id, cmd->device->lun,\n\t    cmd);\n\treturn FAILED;\n}\n\nstatic int\nqla2xxx_eh_device_reset(struct scsi_cmnd *cmd)\n{\n\tscsi_qla_host_t *vha = shost_priv(cmd->device->host);\n\tstruct qla_hw_data *ha = vha->hw;\n\n\tif (qla2x00_isp_reg_stat(ha)) {\n\t\tql_log(ql_log_info, vha, 0x803e,\n\t\t    \"PCI/Register disconnect, exiting.\\n\");\n\t\treturn FAILED;\n\t}\n\n\treturn __qla2xxx_eh_generic_reset(\"DEVICE\", WAIT_LUN, cmd,\n\t    ha->isp_ops->lun_reset);\n}\n\nstatic int\nqla2xxx_eh_target_reset(struct scsi_cmnd *cmd)\n{\n\tscsi_qla_host_t *vha = shost_priv(cmd->device->host);\n\tstruct qla_hw_data *ha = vha->hw;\n\n\tif (qla2x00_isp_reg_stat(ha)) {\n\t\tql_log(ql_log_info, vha, 0x803f,\n\t\t    \"PCI/Register disconnect, exiting.\\n\");\n\t\treturn FAILED;\n\t}\n\n\treturn __qla2xxx_eh_generic_reset(\"TARGET\", WAIT_TARGET, cmd,\n\t    ha->isp_ops->target_reset);\n}\n\n/**************************************************************************\n* qla2xxx_eh_bus_reset\n*\n* Description:\n*    The bus reset function will reset the bus and abort any executing\n*    commands.\n*\n* Input:\n*    cmd = Linux SCSI command packet of the command that cause the\n*          bus reset.\n*\n* Returns:\n*    SUCCESS/FAILURE (defined as macro in scsi.h).\n*\n**************************************************************************/\nstatic int\nqla2xxx_eh_bus_reset(struct scsi_cmnd *cmd)\n{\n\tscsi_qla_host_t *vha = shost_priv(cmd->device->host);\n\tfc_port_t *fcport = (struct fc_port *) cmd->device->hostdata;\n\tint ret = FAILED;\n\tunsigned int id;\n\tuint64_t lun;\n\tstruct qla_hw_data *ha = vha->hw;\n\n\tif (qla2x00_isp_reg_stat(ha)) {\n\t\tql_log(ql_log_info, vha, 0x8040,\n\t\t    \"PCI/Register disconnect, exiting.\\n\");\n\t\treturn FAILED;\n\t}\n\n\tid = cmd->device->id;\n\tlun = cmd->device->lun;\n\n\tif (!fcport) {\n\t\treturn ret;\n\t}\n\n\tret = fc_block_scsi_eh(cmd);\n\tif (ret != 0)\n\t\treturn ret;\n\tret = FAILED;\n\n\tif (qla2x00_chip_is_down(vha))\n\t\treturn ret;\n\n\tql_log(ql_log_info, vha, 0x8012,\n\t    \"BUS RESET ISSUED nexus=%ld:%d:%llu.\\n\", vha->host_no, id, lun);\n\n\tif (qla2x00_wait_for_hba_online(vha) != QLA_SUCCESS) {\n\t\tql_log(ql_log_fatal, vha, 0x8013,\n\t\t    \"Wait for hba online failed board disabled.\\n\");\n\t\tgoto eh_bus_reset_done;\n\t}\n\n\tif (qla2x00_loop_reset(vha) == QLA_SUCCESS)\n\t\tret = SUCCESS;\n\n\tif (ret == FAILED)\n\t\tgoto eh_bus_reset_done;\n\n\t/* Flush outstanding commands. */\n\tif (qla2x00_eh_wait_for_pending_commands(vha, 0, 0, WAIT_HOST) !=\n\t    QLA_SUCCESS) {\n\t\tql_log(ql_log_warn, vha, 0x8014,\n\t\t    \"Wait for pending commands failed.\\n\");\n\t\tret = FAILED;\n\t}\n\neh_bus_reset_done:\n\tql_log(ql_log_warn, vha, 0x802b,\n\t    \"BUS RESET %s nexus=%ld:%d:%llu.\\n\",\n\t    (ret == FAILED) ? \"FAILED\" : \"SUCCEEDED\", vha->host_no, id, lun);\n\n\treturn ret;\n}\n\n/**************************************************************************\n* qla2xxx_eh_host_reset\n*\n* Description:\n*    The reset function will reset the Adapter.\n*\n* Input:\n*      cmd = Linux SCSI command packet of the command that cause the\n*            adapter reset.\n*\n* Returns:\n*      Either SUCCESS or FAILED.\n*\n* Note:\n**************************************************************************/\nstatic int\nqla2xxx_eh_host_reset(struct scsi_cmnd *cmd)\n{\n\tscsi_qla_host_t *vha = shost_priv(cmd->device->host);\n\tstruct qla_hw_data *ha = vha->hw;\n\tint ret = FAILED;\n\tunsigned int id;\n\tuint64_t lun;\n\tscsi_qla_host_t *base_vha = pci_get_drvdata(ha->pdev);\n\n\tif (qla2x00_isp_reg_stat(ha)) {\n\t\tql_log(ql_log_info, vha, 0x8041,\n\t\t    \"PCI/Register disconnect, exiting.\\n\");\n\t\tschedule_work(&ha->board_disable);\n\t\treturn SUCCESS;\n\t}\n\n\tid = cmd->device->id;\n\tlun = cmd->device->lun;\n\n\tql_log(ql_log_info, vha, 0x8018,\n\t    \"ADAPTER RESET ISSUED nexus=%ld:%d:%llu.\\n\", vha->host_no, id, lun);\n\n\t/*\n\t * No point in issuing another reset if one is active.  Also do not\n\t * attempt a reset if we are updating flash.\n\t */\n\tif (qla2x00_reset_active(vha) || ha->optrom_state != QLA_SWAITING)\n\t\tgoto eh_host_reset_lock;\n\n\tif (vha != base_vha) {\n\t\tif (qla2x00_vp_abort_isp(vha))\n\t\t\tgoto eh_host_reset_lock;\n\t} else {\n\t\tif (IS_P3P_TYPE(vha->hw)) {\n\t\t\tif (!qla82xx_fcoe_ctx_reset(vha)) {\n\t\t\t\t/* Ctx reset success */\n\t\t\t\tret = SUCCESS;\n\t\t\t\tgoto eh_host_reset_lock;\n\t\t\t}\n\t\t\t/* fall thru if ctx reset failed */\n\t\t}\n\t\tif (ha->wq)\n\t\t\tflush_workqueue(ha->wq);\n\n\t\tset_bit(ABORT_ISP_ACTIVE, &base_vha->dpc_flags);\n\t\tif (ha->isp_ops->abort_isp(base_vha)) {\n\t\t\tclear_bit(ABORT_ISP_ACTIVE, &base_vha->dpc_flags);\n\t\t\t/* failed. schedule dpc to try */\n\t\t\tset_bit(ISP_ABORT_NEEDED, &base_vha->dpc_flags);\n\n\t\t\tif (qla2x00_wait_for_hba_online(vha) != QLA_SUCCESS) {\n\t\t\t\tql_log(ql_log_warn, vha, 0x802a,\n\t\t\t\t    \"wait for hba online failed.\\n\");\n\t\t\t\tgoto eh_host_reset_lock;\n\t\t\t}\n\t\t}\n\t\tclear_bit(ABORT_ISP_ACTIVE, &base_vha->dpc_flags);\n\t}\n\n\t/* Waiting for command to be returned to OS.*/\n\tif (qla2x00_eh_wait_for_pending_commands(vha, 0, 0, WAIT_HOST) ==\n\t\tQLA_SUCCESS)\n\t\tret = SUCCESS;\n\neh_host_reset_lock:\n\tql_log(ql_log_info, vha, 0x8017,\n\t    \"ADAPTER RESET %s nexus=%ld:%d:%llu.\\n\",\n\t    (ret == FAILED) ? \"FAILED\" : \"SUCCEEDED\", vha->host_no, id, lun);\n\n\treturn ret;\n}\n\n/*\n* qla2x00_loop_reset\n*      Issue loop reset.\n*\n* Input:\n*      ha = adapter block pointer.\n*\n* Returns:\n*      0 = success\n*/\nint\nqla2x00_loop_reset(scsi_qla_host_t *vha)\n{\n\tint ret;\n\tstruct fc_port *fcport;\n\tstruct qla_hw_data *ha = vha->hw;\n\n\tif (IS_QLAFX00(ha)) {\n\t\treturn qlafx00_loop_reset(vha);\n\t}\n\n\tif (ql2xtargetreset == 1 && ha->flags.enable_target_reset) {\n\t\tlist_for_each_entry(fcport, &vha->vp_fcports, list) {\n\t\t\tif (fcport->port_type != FCT_TARGET)\n\t\t\t\tcontinue;\n\n\t\t\tret = ha->isp_ops->target_reset(fcport, 0, 0);\n\t\t\tif (ret != QLA_SUCCESS) {\n\t\t\t\tql_dbg(ql_dbg_taskm, vha, 0x802c,\n\t\t\t\t    \"Bus Reset failed: Reset=%d \"\n\t\t\t\t    \"d_id=%x.\\n\", ret, fcport->d_id.b24);\n\t\t\t}\n\t\t}\n\t}\n\n\n\tif (ha->flags.enable_lip_full_login && !IS_CNA_CAPABLE(ha)) {\n\t\tatomic_set(&vha->loop_state, LOOP_DOWN);\n\t\tatomic_set(&vha->loop_down_timer, LOOP_DOWN_TIME);\n\t\tqla2x00_mark_all_devices_lost(vha);\n\t\tret = qla2x00_full_login_lip(vha);\n\t\tif (ret != QLA_SUCCESS) {\n\t\t\tql_dbg(ql_dbg_taskm, vha, 0x802d,\n\t\t\t    \"full_login_lip=%d.\\n\", ret);\n\t\t}\n\t}\n\n\tif (ha->flags.enable_lip_reset) {\n\t\tret = qla2x00_lip_reset(vha);\n\t\tif (ret != QLA_SUCCESS)\n\t\t\tql_dbg(ql_dbg_taskm, vha, 0x802e,\n\t\t\t    \"lip_reset failed (%d).\\n\", ret);\n\t}\n\n\t/* Issue marker command only when we are going to start the I/O */\n\tvha->marker_needed = 1;\n\n\treturn QLA_SUCCESS;\n}\n\n/*\n * The caller must ensure that no completion interrupts will happen\n * while this function is in progress.\n */\nstatic void qla2x00_abort_srb(struct qla_qpair *qp, srb_t *sp, const int res,\n\t\t\t      unsigned long *flags)\n\t__releases(qp->qp_lock_ptr)\n\t__acquires(qp->qp_lock_ptr)\n{\n\tDECLARE_COMPLETION_ONSTACK(comp);\n\tscsi_qla_host_t *vha = qp->vha;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct scsi_cmnd *cmd = GET_CMD_SP(sp);\n\tint rval;\n\tbool ret_cmd;\n\tuint32_t ratov_j;\n\n\tlockdep_assert_held(qp->qp_lock_ptr);\n\n\tif (qla2x00_chip_is_down(vha)) {\n\t\tsp->done(sp, res);\n\t\treturn;\n\t}\n\n\tif (sp->type == SRB_NVME_CMD || sp->type == SRB_NVME_LS ||\n\t    (sp->type == SRB_SCSI_CMD && !ha->flags.eeh_busy &&\n\t     !test_bit(ABORT_ISP_ACTIVE, &vha->dpc_flags) &&\n\t     !qla2x00_isp_reg_stat(ha))) {\n\t\tif (sp->comp) {\n\t\t\tsp->done(sp, res);\n\t\t\treturn;\n\t\t}\n\n\t\tsp->comp = &comp;\n\t\tspin_unlock_irqrestore(qp->qp_lock_ptr, *flags);\n\n\t\trval = ha->isp_ops->abort_command(sp);\n\t\t/* Wait for command completion. */\n\t\tret_cmd = false;\n\t\tratov_j = ha->r_a_tov/10 * 4 * 1000;\n\t\tratov_j = msecs_to_jiffies(ratov_j);\n\t\tswitch (rval) {\n\t\tcase QLA_SUCCESS:\n\t\t\tif (wait_for_completion_timeout(&comp, ratov_j)) {\n\t\t\t\tql_dbg(ql_dbg_taskm, vha, 0xffff,\n\t\t\t\t    \"%s: Abort wait timer (4 * R_A_TOV[%d]) expired\\n\",\n\t\t\t\t    __func__, ha->r_a_tov/10);\n\t\t\t\tret_cmd = true;\n\t\t\t}\n\t\t\t/* else FW return SP to driver */\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tret_cmd = true;\n\t\t\tbreak;\n\t\t}\n\n\t\tspin_lock_irqsave(qp->qp_lock_ptr, *flags);\n\t\tif (ret_cmd && blk_mq_request_started(cmd->request))\n\t\t\tsp->done(sp, res);\n\t} else {\n\t\tsp->done(sp, res);\n\t}\n}\n\n/*\n * The caller must ensure that no completion interrupts will happen\n * while this function is in progress.\n */\nstatic void\n__qla2x00_abort_all_cmds(struct qla_qpair *qp, int res)\n{\n\tint cnt;\n\tunsigned long flags;\n\tsrb_t *sp;\n\tscsi_qla_host_t *vha = qp->vha;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct req_que *req;\n\tstruct qla_tgt *tgt = vha->vha_tgt.qla_tgt;\n\tstruct qla_tgt_cmd *cmd;\n\n\tif (!ha->req_q_map)\n\t\treturn;\n\tspin_lock_irqsave(qp->qp_lock_ptr, flags);\n\treq = qp->req;\n\tfor (cnt = 1; cnt < req->num_outstanding_cmds; cnt++) {\n\t\tsp = req->outstanding_cmds[cnt];\n\t\tif (sp) {\n\t\t\tswitch (sp->cmd_type) {\n\t\t\tcase TYPE_SRB:\n\t\t\t\tqla2x00_abort_srb(qp, sp, res, &flags);\n\t\t\t\tbreak;\n\t\t\tcase TYPE_TGT_CMD:\n\t\t\t\tif (!vha->hw->tgt.tgt_ops || !tgt ||\n\t\t\t\t    qla_ini_mode_enabled(vha)) {\n\t\t\t\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf003,\n\t\t\t\t\t    \"HOST-ABORT-HNDLR: dpc_flags=%lx. Target mode disabled\\n\",\n\t\t\t\t\t    vha->dpc_flags);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tcmd = (struct qla_tgt_cmd *)sp;\n\t\t\t\tcmd->aborted = 1;\n\t\t\t\tbreak;\n\t\t\tcase TYPE_TGT_TMCMD:\n\t\t\t\t/* Skip task management functions. */\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\treq->outstanding_cmds[cnt] = NULL;\n\t\t}\n\t}\n\tspin_unlock_irqrestore(qp->qp_lock_ptr, flags);\n}\n\n/*\n * The caller must ensure that no completion interrupts will happen\n * while this function is in progress.\n */\nvoid\nqla2x00_abort_all_cmds(scsi_qla_host_t *vha, int res)\n{\n\tint que;\n\tstruct qla_hw_data *ha = vha->hw;\n\n\t/* Continue only if initialization complete. */\n\tif (!ha->base_qpair)\n\t\treturn;\n\t__qla2x00_abort_all_cmds(ha->base_qpair, res);\n\n\tif (!ha->queue_pair_map)\n\t\treturn;\n\tfor (que = 0; que < ha->max_qpairs; que++) {\n\t\tif (!ha->queue_pair_map[que])\n\t\t\tcontinue;\n\n\t\t__qla2x00_abort_all_cmds(ha->queue_pair_map[que], res);\n\t}\n}\n\nstatic int\nqla2xxx_slave_alloc(struct scsi_device *sdev)\n{\n\tstruct fc_rport *rport = starget_to_rport(scsi_target(sdev));\n\n\tif (!rport || fc_remote_port_chkready(rport))\n\t\treturn -ENXIO;\n\n\tsdev->hostdata = *(fc_port_t **)rport->dd_data;\n\n\treturn 0;\n}\n\nstatic int\nqla2xxx_slave_configure(struct scsi_device *sdev)\n{\n\tscsi_qla_host_t *vha = shost_priv(sdev->host);\n\tstruct req_que *req = vha->req;\n\n\tif (IS_T10_PI_CAPABLE(vha->hw))\n\t\tblk_queue_update_dma_alignment(sdev->request_queue, 0x7);\n\n\tscsi_change_queue_depth(sdev, req->max_q_depth);\n\treturn 0;\n}\n\nstatic void\nqla2xxx_slave_destroy(struct scsi_device *sdev)\n{\n\tsdev->hostdata = NULL;\n}\n\n/**\n * qla2x00_config_dma_addressing() - Configure OS DMA addressing method.\n * @ha: HA context\n *\n * At exit, the @ha's flags.enable_64bit_addressing set to indicated\n * supported addressing method.\n */\nstatic void\nqla2x00_config_dma_addressing(struct qla_hw_data *ha)\n{\n\t/* Assume a 32bit DMA mask. */\n\tha->flags.enable_64bit_addressing = 0;\n\n\tif (!dma_set_mask(&ha->pdev->dev, DMA_BIT_MASK(64))) {\n\t\t/* Any upper-dword bits set? */\n\t\tif (MSD(dma_get_required_mask(&ha->pdev->dev)) &&\n\t\t    !dma_set_coherent_mask(&ha->pdev->dev, DMA_BIT_MASK(64))) {\n\t\t\t/* Ok, a 64bit DMA mask is applicable. */\n\t\t\tha->flags.enable_64bit_addressing = 1;\n\t\t\tha->isp_ops->calc_req_entries = qla2x00_calc_iocbs_64;\n\t\t\tha->isp_ops->build_iocbs = qla2x00_build_scsi_iocbs_64;\n\t\t\treturn;\n\t\t}\n\t}\n\n\tdma_set_mask(&ha->pdev->dev, DMA_BIT_MASK(32));\n\tdma_set_coherent_mask(&ha->pdev->dev, DMA_BIT_MASK(32));\n}\n\nstatic void\nqla2x00_enable_intrs(struct qla_hw_data *ha)\n{\n\tunsigned long flags = 0;\n\tstruct device_reg_2xxx __iomem *reg = &ha->iobase->isp;\n\n\tspin_lock_irqsave(&ha->hardware_lock, flags);\n\tha->interrupts_on = 1;\n\t/* enable risc and host interrupts */\n\twrt_reg_word(&reg->ictrl, ICR_EN_INT | ICR_EN_RISC);\n\trd_reg_word(&reg->ictrl);\n\tspin_unlock_irqrestore(&ha->hardware_lock, flags);\n\n}\n\nstatic void\nqla2x00_disable_intrs(struct qla_hw_data *ha)\n{\n\tunsigned long flags = 0;\n\tstruct device_reg_2xxx __iomem *reg = &ha->iobase->isp;\n\n\tspin_lock_irqsave(&ha->hardware_lock, flags);\n\tha->interrupts_on = 0;\n\t/* disable risc and host interrupts */\n\twrt_reg_word(&reg->ictrl, 0);\n\trd_reg_word(&reg->ictrl);\n\tspin_unlock_irqrestore(&ha->hardware_lock, flags);\n}\n\nstatic void\nqla24xx_enable_intrs(struct qla_hw_data *ha)\n{\n\tunsigned long flags = 0;\n\tstruct device_reg_24xx __iomem *reg = &ha->iobase->isp24;\n\n\tspin_lock_irqsave(&ha->hardware_lock, flags);\n\tha->interrupts_on = 1;\n\twrt_reg_dword(&reg->ictrl, ICRX_EN_RISC_INT);\n\trd_reg_dword(&reg->ictrl);\n\tspin_unlock_irqrestore(&ha->hardware_lock, flags);\n}\n\nstatic void\nqla24xx_disable_intrs(struct qla_hw_data *ha)\n{\n\tunsigned long flags = 0;\n\tstruct device_reg_24xx __iomem *reg = &ha->iobase->isp24;\n\n\tif (IS_NOPOLLING_TYPE(ha))\n\t\treturn;\n\tspin_lock_irqsave(&ha->hardware_lock, flags);\n\tha->interrupts_on = 0;\n\twrt_reg_dword(&reg->ictrl, 0);\n\trd_reg_dword(&reg->ictrl);\n\tspin_unlock_irqrestore(&ha->hardware_lock, flags);\n}\n\nstatic int\nqla2x00_iospace_config(struct qla_hw_data *ha)\n{\n\tresource_size_t pio;\n\tuint16_t msix;\n\n\tif (pci_request_selected_regions(ha->pdev, ha->bars,\n\t    QLA2XXX_DRIVER_NAME)) {\n\t\tql_log_pci(ql_log_fatal, ha->pdev, 0x0011,\n\t\t    \"Failed to reserve PIO/MMIO regions (%s), aborting.\\n\",\n\t\t    pci_name(ha->pdev));\n\t\tgoto iospace_error_exit;\n\t}\n\tif (!(ha->bars & 1))\n\t\tgoto skip_pio;\n\n\t/* We only need PIO for Flash operations on ISP2312 v2 chips. */\n\tpio = pci_resource_start(ha->pdev, 0);\n\tif (pci_resource_flags(ha->pdev, 0) & IORESOURCE_IO) {\n\t\tif (pci_resource_len(ha->pdev, 0) < MIN_IOBASE_LEN) {\n\t\t\tql_log_pci(ql_log_warn, ha->pdev, 0x0012,\n\t\t\t    \"Invalid pci I/O region size (%s).\\n\",\n\t\t\t    pci_name(ha->pdev));\n\t\t\tpio = 0;\n\t\t}\n\t} else {\n\t\tql_log_pci(ql_log_warn, ha->pdev, 0x0013,\n\t\t    \"Region #0 no a PIO resource (%s).\\n\",\n\t\t    pci_name(ha->pdev));\n\t\tpio = 0;\n\t}\n\tha->pio_address = pio;\n\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x0014,\n\t    \"PIO address=%llu.\\n\",\n\t    (unsigned long long)ha->pio_address);\n\nskip_pio:\n\t/* Use MMIO operations for all accesses. */\n\tif (!(pci_resource_flags(ha->pdev, 1) & IORESOURCE_MEM)) {\n\t\tql_log_pci(ql_log_fatal, ha->pdev, 0x0015,\n\t\t    \"Region #1 not an MMIO resource (%s), aborting.\\n\",\n\t\t    pci_name(ha->pdev));\n\t\tgoto iospace_error_exit;\n\t}\n\tif (pci_resource_len(ha->pdev, 1) < MIN_IOBASE_LEN) {\n\t\tql_log_pci(ql_log_fatal, ha->pdev, 0x0016,\n\t\t    \"Invalid PCI mem region size (%s), aborting.\\n\",\n\t\t    pci_name(ha->pdev));\n\t\tgoto iospace_error_exit;\n\t}\n\n\tha->iobase = ioremap(pci_resource_start(ha->pdev, 1), MIN_IOBASE_LEN);\n\tif (!ha->iobase) {\n\t\tql_log_pci(ql_log_fatal, ha->pdev, 0x0017,\n\t\t    \"Cannot remap MMIO (%s), aborting.\\n\",\n\t\t    pci_name(ha->pdev));\n\t\tgoto iospace_error_exit;\n\t}\n\n\t/* Determine queue resources */\n\tha->max_req_queues = ha->max_rsp_queues = 1;\n\tha->msix_count = QLA_BASE_VECTORS;\n\n\t/* Check if FW supports MQ or not */\n\tif (!(ha->fw_attributes & BIT_6))\n\t\tgoto mqiobase_exit;\n\n\tif (!ql2xmqsupport || !ql2xnvmeenable ||\n\t    (!IS_QLA25XX(ha) && !IS_QLA81XX(ha)))\n\t\tgoto mqiobase_exit;\n\n\tha->mqiobase = ioremap(pci_resource_start(ha->pdev, 3),\n\t\t\tpci_resource_len(ha->pdev, 3));\n\tif (ha->mqiobase) {\n\t\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x0018,\n\t\t    \"MQIO Base=%p.\\n\", ha->mqiobase);\n\t\t/* Read MSIX vector size of the board */\n\t\tpci_read_config_word(ha->pdev, QLA_PCI_MSIX_CONTROL, &msix);\n\t\tha->msix_count = msix + 1;\n\t\t/* Max queues are bounded by available msix vectors */\n\t\t/* MB interrupt uses 1 vector */\n\t\tha->max_req_queues = ha->msix_count - 1;\n\t\tha->max_rsp_queues = ha->max_req_queues;\n\t\t/* Queue pairs is the max value minus the base queue pair */\n\t\tha->max_qpairs = ha->max_rsp_queues - 1;\n\t\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x0188,\n\t\t    \"Max no of queues pairs: %d.\\n\", ha->max_qpairs);\n\n\t\tql_log_pci(ql_log_info, ha->pdev, 0x001a,\n\t\t    \"MSI-X vector count: %d.\\n\", ha->msix_count);\n\t} else\n\t\tql_log_pci(ql_log_info, ha->pdev, 0x001b,\n\t\t    \"BAR 3 not enabled.\\n\");\n\nmqiobase_exit:\n\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x001c,\n\t    \"MSIX Count: %d.\\n\", ha->msix_count);\n\treturn (0);\n\niospace_error_exit:\n\treturn (-ENOMEM);\n}\n\n\nstatic int\nqla83xx_iospace_config(struct qla_hw_data *ha)\n{\n\tuint16_t msix;\n\n\tif (pci_request_selected_regions(ha->pdev, ha->bars,\n\t    QLA2XXX_DRIVER_NAME)) {\n\t\tql_log_pci(ql_log_fatal, ha->pdev, 0x0117,\n\t\t    \"Failed to reserve PIO/MMIO regions (%s), aborting.\\n\",\n\t\t    pci_name(ha->pdev));\n\n\t\tgoto iospace_error_exit;\n\t}\n\n\t/* Use MMIO operations for all accesses. */\n\tif (!(pci_resource_flags(ha->pdev, 0) & IORESOURCE_MEM)) {\n\t\tql_log_pci(ql_log_warn, ha->pdev, 0x0118,\n\t\t    \"Invalid pci I/O region size (%s).\\n\",\n\t\t    pci_name(ha->pdev));\n\t\tgoto iospace_error_exit;\n\t}\n\tif (pci_resource_len(ha->pdev, 0) < MIN_IOBASE_LEN) {\n\t\tql_log_pci(ql_log_warn, ha->pdev, 0x0119,\n\t\t    \"Invalid PCI mem region size (%s), aborting\\n\",\n\t\t\tpci_name(ha->pdev));\n\t\tgoto iospace_error_exit;\n\t}\n\n\tha->iobase = ioremap(pci_resource_start(ha->pdev, 0), MIN_IOBASE_LEN);\n\tif (!ha->iobase) {\n\t\tql_log_pci(ql_log_fatal, ha->pdev, 0x011a,\n\t\t    \"Cannot remap MMIO (%s), aborting.\\n\",\n\t\t    pci_name(ha->pdev));\n\t\tgoto iospace_error_exit;\n\t}\n\n\t/* 64bit PCI BAR - BAR2 will correspoond to region 4 */\n\t/* 83XX 26XX always use MQ type access for queues\n\t * - mbar 2, a.k.a region 4 */\n\tha->max_req_queues = ha->max_rsp_queues = 1;\n\tha->msix_count = QLA_BASE_VECTORS;\n\tha->mqiobase = ioremap(pci_resource_start(ha->pdev, 4),\n\t\t\tpci_resource_len(ha->pdev, 4));\n\n\tif (!ha->mqiobase) {\n\t\tql_log_pci(ql_log_fatal, ha->pdev, 0x011d,\n\t\t    \"BAR2/region4 not enabled\\n\");\n\t\tgoto mqiobase_exit;\n\t}\n\n\tha->msixbase = ioremap(pci_resource_start(ha->pdev, 2),\n\t\t\tpci_resource_len(ha->pdev, 2));\n\tif (ha->msixbase) {\n\t\t/* Read MSIX vector size of the board */\n\t\tpci_read_config_word(ha->pdev,\n\t\t    QLA_83XX_PCI_MSIX_CONTROL, &msix);\n\t\tha->msix_count = (msix & PCI_MSIX_FLAGS_QSIZE)  + 1;\n\t\t/*\n\t\t * By default, driver uses at least two msix vectors\n\t\t * (default & rspq)\n\t\t */\n\t\tif (ql2xmqsupport || ql2xnvmeenable) {\n\t\t\t/* MB interrupt uses 1 vector */\n\t\t\tha->max_req_queues = ha->msix_count - 1;\n\n\t\t\t/* ATIOQ needs 1 vector. That's 1 less QPair */\n\t\t\tif (QLA_TGT_MODE_ENABLED())\n\t\t\t\tha->max_req_queues--;\n\n\t\t\tha->max_rsp_queues = ha->max_req_queues;\n\n\t\t\t/* Queue pairs is the max value minus\n\t\t\t * the base queue pair */\n\t\t\tha->max_qpairs = ha->max_req_queues - 1;\n\t\t\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x00e3,\n\t\t\t    \"Max no of queues pairs: %d.\\n\", ha->max_qpairs);\n\t\t}\n\t\tql_log_pci(ql_log_info, ha->pdev, 0x011c,\n\t\t    \"MSI-X vector count: %d.\\n\", ha->msix_count);\n\t} else\n\t\tql_log_pci(ql_log_info, ha->pdev, 0x011e,\n\t\t    \"BAR 1 not enabled.\\n\");\n\nmqiobase_exit:\n\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x011f,\n\t    \"MSIX Count: %d.\\n\", ha->msix_count);\n\treturn 0;\n\niospace_error_exit:\n\treturn -ENOMEM;\n}\n\nstatic struct isp_operations qla2100_isp_ops = {\n\t.pci_config\t\t= qla2100_pci_config,\n\t.reset_chip\t\t= qla2x00_reset_chip,\n\t.chip_diag\t\t= qla2x00_chip_diag,\n\t.config_rings\t\t= qla2x00_config_rings,\n\t.reset_adapter\t\t= qla2x00_reset_adapter,\n\t.nvram_config\t\t= qla2x00_nvram_config,\n\t.update_fw_options\t= qla2x00_update_fw_options,\n\t.load_risc\t\t= qla2x00_load_risc,\n\t.pci_info_str\t\t= qla2x00_pci_info_str,\n\t.fw_version_str\t\t= qla2x00_fw_version_str,\n\t.intr_handler\t\t= qla2100_intr_handler,\n\t.enable_intrs\t\t= qla2x00_enable_intrs,\n\t.disable_intrs\t\t= qla2x00_disable_intrs,\n\t.abort_command\t\t= qla2x00_abort_command,\n\t.target_reset\t\t= qla2x00_abort_target,\n\t.lun_reset\t\t= qla2x00_lun_reset,\n\t.fabric_login\t\t= qla2x00_login_fabric,\n\t.fabric_logout\t\t= qla2x00_fabric_logout,\n\t.calc_req_entries\t= qla2x00_calc_iocbs_32,\n\t.build_iocbs\t\t= qla2x00_build_scsi_iocbs_32,\n\t.prep_ms_iocb\t\t= qla2x00_prep_ms_iocb,\n\t.prep_ms_fdmi_iocb\t= qla2x00_prep_ms_fdmi_iocb,\n\t.read_nvram\t\t= qla2x00_read_nvram_data,\n\t.write_nvram\t\t= qla2x00_write_nvram_data,\n\t.fw_dump\t\t= qla2100_fw_dump,\n\t.beacon_on\t\t= NULL,\n\t.beacon_off\t\t= NULL,\n\t.beacon_blink\t\t= NULL,\n\t.read_optrom\t\t= qla2x00_read_optrom_data,\n\t.write_optrom\t\t= qla2x00_write_optrom_data,\n\t.get_flash_version\t= qla2x00_get_flash_version,\n\t.start_scsi\t\t= qla2x00_start_scsi,\n\t.start_scsi_mq          = NULL,\n\t.abort_isp\t\t= qla2x00_abort_isp,\n\t.iospace_config     \t= qla2x00_iospace_config,\n\t.initialize_adapter\t= qla2x00_initialize_adapter,\n};\n\nstatic struct isp_operations qla2300_isp_ops = {\n\t.pci_config\t\t= qla2300_pci_config,\n\t.reset_chip\t\t= qla2x00_reset_chip,\n\t.chip_diag\t\t= qla2x00_chip_diag,\n\t.config_rings\t\t= qla2x00_config_rings,\n\t.reset_adapter\t\t= qla2x00_reset_adapter,\n\t.nvram_config\t\t= qla2x00_nvram_config,\n\t.update_fw_options\t= qla2x00_update_fw_options,\n\t.load_risc\t\t= qla2x00_load_risc,\n\t.pci_info_str\t\t= qla2x00_pci_info_str,\n\t.fw_version_str\t\t= qla2x00_fw_version_str,\n\t.intr_handler\t\t= qla2300_intr_handler,\n\t.enable_intrs\t\t= qla2x00_enable_intrs,\n\t.disable_intrs\t\t= qla2x00_disable_intrs,\n\t.abort_command\t\t= qla2x00_abort_command,\n\t.target_reset\t\t= qla2x00_abort_target,\n\t.lun_reset\t\t= qla2x00_lun_reset,\n\t.fabric_login\t\t= qla2x00_login_fabric,\n\t.fabric_logout\t\t= qla2x00_fabric_logout,\n\t.calc_req_entries\t= qla2x00_calc_iocbs_32,\n\t.build_iocbs\t\t= qla2x00_build_scsi_iocbs_32,\n\t.prep_ms_iocb\t\t= qla2x00_prep_ms_iocb,\n\t.prep_ms_fdmi_iocb\t= qla2x00_prep_ms_fdmi_iocb,\n\t.read_nvram\t\t= qla2x00_read_nvram_data,\n\t.write_nvram\t\t= qla2x00_write_nvram_data,\n\t.fw_dump\t\t= qla2300_fw_dump,\n\t.beacon_on\t\t= qla2x00_beacon_on,\n\t.beacon_off\t\t= qla2x00_beacon_off,\n\t.beacon_blink\t\t= qla2x00_beacon_blink,\n\t.read_optrom\t\t= qla2x00_read_optrom_data,\n\t.write_optrom\t\t= qla2x00_write_optrom_data,\n\t.get_flash_version\t= qla2x00_get_flash_version,\n\t.start_scsi\t\t= qla2x00_start_scsi,\n\t.start_scsi_mq          = NULL,\n\t.abort_isp\t\t= qla2x00_abort_isp,\n\t.iospace_config\t\t= qla2x00_iospace_config,\n\t.initialize_adapter\t= qla2x00_initialize_adapter,\n};\n\nstatic struct isp_operations qla24xx_isp_ops = {\n\t.pci_config\t\t= qla24xx_pci_config,\n\t.reset_chip\t\t= qla24xx_reset_chip,\n\t.chip_diag\t\t= qla24xx_chip_diag,\n\t.config_rings\t\t= qla24xx_config_rings,\n\t.reset_adapter\t\t= qla24xx_reset_adapter,\n\t.nvram_config\t\t= qla24xx_nvram_config,\n\t.update_fw_options\t= qla24xx_update_fw_options,\n\t.load_risc\t\t= qla24xx_load_risc,\n\t.pci_info_str\t\t= qla24xx_pci_info_str,\n\t.fw_version_str\t\t= qla24xx_fw_version_str,\n\t.intr_handler\t\t= qla24xx_intr_handler,\n\t.enable_intrs\t\t= qla24xx_enable_intrs,\n\t.disable_intrs\t\t= qla24xx_disable_intrs,\n\t.abort_command\t\t= qla24xx_abort_command,\n\t.target_reset\t\t= qla24xx_abort_target,\n\t.lun_reset\t\t= qla24xx_lun_reset,\n\t.fabric_login\t\t= qla24xx_login_fabric,\n\t.fabric_logout\t\t= qla24xx_fabric_logout,\n\t.calc_req_entries\t= NULL,\n\t.build_iocbs\t\t= NULL,\n\t.prep_ms_iocb\t\t= qla24xx_prep_ms_iocb,\n\t.prep_ms_fdmi_iocb\t= qla24xx_prep_ms_fdmi_iocb,\n\t.read_nvram\t\t= qla24xx_read_nvram_data,\n\t.write_nvram\t\t= qla24xx_write_nvram_data,\n\t.fw_dump\t\t= qla24xx_fw_dump,\n\t.beacon_on\t\t= qla24xx_beacon_on,\n\t.beacon_off\t\t= qla24xx_beacon_off,\n\t.beacon_blink\t\t= qla24xx_beacon_blink,\n\t.read_optrom\t\t= qla24xx_read_optrom_data,\n\t.write_optrom\t\t= qla24xx_write_optrom_data,\n\t.get_flash_version\t= qla24xx_get_flash_version,\n\t.start_scsi\t\t= qla24xx_start_scsi,\n\t.start_scsi_mq          = NULL,\n\t.abort_isp\t\t= qla2x00_abort_isp,\n\t.iospace_config\t\t= qla2x00_iospace_config,\n\t.initialize_adapter\t= qla2x00_initialize_adapter,\n};\n\nstatic struct isp_operations qla25xx_isp_ops = {\n\t.pci_config\t\t= qla25xx_pci_config,\n\t.reset_chip\t\t= qla24xx_reset_chip,\n\t.chip_diag\t\t= qla24xx_chip_diag,\n\t.config_rings\t\t= qla24xx_config_rings,\n\t.reset_adapter\t\t= qla24xx_reset_adapter,\n\t.nvram_config\t\t= qla24xx_nvram_config,\n\t.update_fw_options\t= qla24xx_update_fw_options,\n\t.load_risc\t\t= qla24xx_load_risc,\n\t.pci_info_str\t\t= qla24xx_pci_info_str,\n\t.fw_version_str\t\t= qla24xx_fw_version_str,\n\t.intr_handler\t\t= qla24xx_intr_handler,\n\t.enable_intrs\t\t= qla24xx_enable_intrs,\n\t.disable_intrs\t\t= qla24xx_disable_intrs,\n\t.abort_command\t\t= qla24xx_abort_command,\n\t.target_reset\t\t= qla24xx_abort_target,\n\t.lun_reset\t\t= qla24xx_lun_reset,\n\t.fabric_login\t\t= qla24xx_login_fabric,\n\t.fabric_logout\t\t= qla24xx_fabric_logout,\n\t.calc_req_entries\t= NULL,\n\t.build_iocbs\t\t= NULL,\n\t.prep_ms_iocb\t\t= qla24xx_prep_ms_iocb,\n\t.prep_ms_fdmi_iocb\t= qla24xx_prep_ms_fdmi_iocb,\n\t.read_nvram\t\t= qla25xx_read_nvram_data,\n\t.write_nvram\t\t= qla25xx_write_nvram_data,\n\t.fw_dump\t\t= qla25xx_fw_dump,\n\t.beacon_on\t\t= qla24xx_beacon_on,\n\t.beacon_off\t\t= qla24xx_beacon_off,\n\t.beacon_blink\t\t= qla24xx_beacon_blink,\n\t.read_optrom\t\t= qla25xx_read_optrom_data,\n\t.write_optrom\t\t= qla24xx_write_optrom_data,\n\t.get_flash_version\t= qla24xx_get_flash_version,\n\t.start_scsi\t\t= qla24xx_dif_start_scsi,\n\t.start_scsi_mq          = qla2xxx_dif_start_scsi_mq,\n\t.abort_isp\t\t= qla2x00_abort_isp,\n\t.iospace_config\t\t= qla2x00_iospace_config,\n\t.initialize_adapter\t= qla2x00_initialize_adapter,\n};\n\nstatic struct isp_operations qla81xx_isp_ops = {\n\t.pci_config\t\t= qla25xx_pci_config,\n\t.reset_chip\t\t= qla24xx_reset_chip,\n\t.chip_diag\t\t= qla24xx_chip_diag,\n\t.config_rings\t\t= qla24xx_config_rings,\n\t.reset_adapter\t\t= qla24xx_reset_adapter,\n\t.nvram_config\t\t= qla81xx_nvram_config,\n\t.update_fw_options\t= qla24xx_update_fw_options,\n\t.load_risc\t\t= qla81xx_load_risc,\n\t.pci_info_str\t\t= qla24xx_pci_info_str,\n\t.fw_version_str\t\t= qla24xx_fw_version_str,\n\t.intr_handler\t\t= qla24xx_intr_handler,\n\t.enable_intrs\t\t= qla24xx_enable_intrs,\n\t.disable_intrs\t\t= qla24xx_disable_intrs,\n\t.abort_command\t\t= qla24xx_abort_command,\n\t.target_reset\t\t= qla24xx_abort_target,\n\t.lun_reset\t\t= qla24xx_lun_reset,\n\t.fabric_login\t\t= qla24xx_login_fabric,\n\t.fabric_logout\t\t= qla24xx_fabric_logout,\n\t.calc_req_entries\t= NULL,\n\t.build_iocbs\t\t= NULL,\n\t.prep_ms_iocb\t\t= qla24xx_prep_ms_iocb,\n\t.prep_ms_fdmi_iocb\t= qla24xx_prep_ms_fdmi_iocb,\n\t.read_nvram\t\t= NULL,\n\t.write_nvram\t\t= NULL,\n\t.fw_dump\t\t= qla81xx_fw_dump,\n\t.beacon_on\t\t= qla24xx_beacon_on,\n\t.beacon_off\t\t= qla24xx_beacon_off,\n\t.beacon_blink\t\t= qla83xx_beacon_blink,\n\t.read_optrom\t\t= qla25xx_read_optrom_data,\n\t.write_optrom\t\t= qla24xx_write_optrom_data,\n\t.get_flash_version\t= qla24xx_get_flash_version,\n\t.start_scsi\t\t= qla24xx_dif_start_scsi,\n\t.start_scsi_mq          = qla2xxx_dif_start_scsi_mq,\n\t.abort_isp\t\t= qla2x00_abort_isp,\n\t.iospace_config\t\t= qla2x00_iospace_config,\n\t.initialize_adapter\t= qla2x00_initialize_adapter,\n};\n\nstatic struct isp_operations qla82xx_isp_ops = {\n\t.pci_config\t\t= qla82xx_pci_config,\n\t.reset_chip\t\t= qla82xx_reset_chip,\n\t.chip_diag\t\t= qla24xx_chip_diag,\n\t.config_rings\t\t= qla82xx_config_rings,\n\t.reset_adapter\t\t= qla24xx_reset_adapter,\n\t.nvram_config\t\t= qla81xx_nvram_config,\n\t.update_fw_options\t= qla24xx_update_fw_options,\n\t.load_risc\t\t= qla82xx_load_risc,\n\t.pci_info_str\t\t= qla24xx_pci_info_str,\n\t.fw_version_str\t\t= qla24xx_fw_version_str,\n\t.intr_handler\t\t= qla82xx_intr_handler,\n\t.enable_intrs\t\t= qla82xx_enable_intrs,\n\t.disable_intrs\t\t= qla82xx_disable_intrs,\n\t.abort_command\t\t= qla24xx_abort_command,\n\t.target_reset\t\t= qla24xx_abort_target,\n\t.lun_reset\t\t= qla24xx_lun_reset,\n\t.fabric_login\t\t= qla24xx_login_fabric,\n\t.fabric_logout\t\t= qla24xx_fabric_logout,\n\t.calc_req_entries\t= NULL,\n\t.build_iocbs\t\t= NULL,\n\t.prep_ms_iocb\t\t= qla24xx_prep_ms_iocb,\n\t.prep_ms_fdmi_iocb\t= qla24xx_prep_ms_fdmi_iocb,\n\t.read_nvram\t\t= qla24xx_read_nvram_data,\n\t.write_nvram\t\t= qla24xx_write_nvram_data,\n\t.fw_dump\t\t= qla82xx_fw_dump,\n\t.beacon_on\t\t= qla82xx_beacon_on,\n\t.beacon_off\t\t= qla82xx_beacon_off,\n\t.beacon_blink\t\t= NULL,\n\t.read_optrom\t\t= qla82xx_read_optrom_data,\n\t.write_optrom\t\t= qla82xx_write_optrom_data,\n\t.get_flash_version\t= qla82xx_get_flash_version,\n\t.start_scsi             = qla82xx_start_scsi,\n\t.start_scsi_mq          = NULL,\n\t.abort_isp\t\t= qla82xx_abort_isp,\n\t.iospace_config     \t= qla82xx_iospace_config,\n\t.initialize_adapter\t= qla2x00_initialize_adapter,\n};\n\nstatic struct isp_operations qla8044_isp_ops = {\n\t.pci_config\t\t= qla82xx_pci_config,\n\t.reset_chip\t\t= qla82xx_reset_chip,\n\t.chip_diag\t\t= qla24xx_chip_diag,\n\t.config_rings\t\t= qla82xx_config_rings,\n\t.reset_adapter\t\t= qla24xx_reset_adapter,\n\t.nvram_config\t\t= qla81xx_nvram_config,\n\t.update_fw_options\t= qla24xx_update_fw_options,\n\t.load_risc\t\t= qla82xx_load_risc,\n\t.pci_info_str\t\t= qla24xx_pci_info_str,\n\t.fw_version_str\t\t= qla24xx_fw_version_str,\n\t.intr_handler\t\t= qla8044_intr_handler,\n\t.enable_intrs\t\t= qla82xx_enable_intrs,\n\t.disable_intrs\t\t= qla82xx_disable_intrs,\n\t.abort_command\t\t= qla24xx_abort_command,\n\t.target_reset\t\t= qla24xx_abort_target,\n\t.lun_reset\t\t= qla24xx_lun_reset,\n\t.fabric_login\t\t= qla24xx_login_fabric,\n\t.fabric_logout\t\t= qla24xx_fabric_logout,\n\t.calc_req_entries\t= NULL,\n\t.build_iocbs\t\t= NULL,\n\t.prep_ms_iocb\t\t= qla24xx_prep_ms_iocb,\n\t.prep_ms_fdmi_iocb\t= qla24xx_prep_ms_fdmi_iocb,\n\t.read_nvram\t\t= NULL,\n\t.write_nvram\t\t= NULL,\n\t.fw_dump\t\t= qla8044_fw_dump,\n\t.beacon_on\t\t= qla82xx_beacon_on,\n\t.beacon_off\t\t= qla82xx_beacon_off,\n\t.beacon_blink\t\t= NULL,\n\t.read_optrom\t\t= qla8044_read_optrom_data,\n\t.write_optrom\t\t= qla8044_write_optrom_data,\n\t.get_flash_version\t= qla82xx_get_flash_version,\n\t.start_scsi             = qla82xx_start_scsi,\n\t.start_scsi_mq          = NULL,\n\t.abort_isp\t\t= qla8044_abort_isp,\n\t.iospace_config\t\t= qla82xx_iospace_config,\n\t.initialize_adapter\t= qla2x00_initialize_adapter,\n};\n\nstatic struct isp_operations qla83xx_isp_ops = {\n\t.pci_config\t\t= qla25xx_pci_config,\n\t.reset_chip\t\t= qla24xx_reset_chip,\n\t.chip_diag\t\t= qla24xx_chip_diag,\n\t.config_rings\t\t= qla24xx_config_rings,\n\t.reset_adapter\t\t= qla24xx_reset_adapter,\n\t.nvram_config\t\t= qla81xx_nvram_config,\n\t.update_fw_options\t= qla24xx_update_fw_options,\n\t.load_risc\t\t= qla81xx_load_risc,\n\t.pci_info_str\t\t= qla24xx_pci_info_str,\n\t.fw_version_str\t\t= qla24xx_fw_version_str,\n\t.intr_handler\t\t= qla24xx_intr_handler,\n\t.enable_intrs\t\t= qla24xx_enable_intrs,\n\t.disable_intrs\t\t= qla24xx_disable_intrs,\n\t.abort_command\t\t= qla24xx_abort_command,\n\t.target_reset\t\t= qla24xx_abort_target,\n\t.lun_reset\t\t= qla24xx_lun_reset,\n\t.fabric_login\t\t= qla24xx_login_fabric,\n\t.fabric_logout\t\t= qla24xx_fabric_logout,\n\t.calc_req_entries\t= NULL,\n\t.build_iocbs\t\t= NULL,\n\t.prep_ms_iocb\t\t= qla24xx_prep_ms_iocb,\n\t.prep_ms_fdmi_iocb\t= qla24xx_prep_ms_fdmi_iocb,\n\t.read_nvram\t\t= NULL,\n\t.write_nvram\t\t= NULL,\n\t.fw_dump\t\t= qla83xx_fw_dump,\n\t.beacon_on\t\t= qla24xx_beacon_on,\n\t.beacon_off\t\t= qla24xx_beacon_off,\n\t.beacon_blink\t\t= qla83xx_beacon_blink,\n\t.read_optrom\t\t= qla25xx_read_optrom_data,\n\t.write_optrom\t\t= qla24xx_write_optrom_data,\n\t.get_flash_version\t= qla24xx_get_flash_version,\n\t.start_scsi\t\t= qla24xx_dif_start_scsi,\n\t.start_scsi_mq          = qla2xxx_dif_start_scsi_mq,\n\t.abort_isp\t\t= qla2x00_abort_isp,\n\t.iospace_config\t\t= qla83xx_iospace_config,\n\t.initialize_adapter\t= qla2x00_initialize_adapter,\n};\n\nstatic struct isp_operations qlafx00_isp_ops = {\n\t.pci_config\t\t= qlafx00_pci_config,\n\t.reset_chip\t\t= qlafx00_soft_reset,\n\t.chip_diag\t\t= qlafx00_chip_diag,\n\t.config_rings\t\t= qlafx00_config_rings,\n\t.reset_adapter\t\t= qlafx00_soft_reset,\n\t.nvram_config\t\t= NULL,\n\t.update_fw_options\t= NULL,\n\t.load_risc\t\t= NULL,\n\t.pci_info_str\t\t= qlafx00_pci_info_str,\n\t.fw_version_str\t\t= qlafx00_fw_version_str,\n\t.intr_handler\t\t= qlafx00_intr_handler,\n\t.enable_intrs\t\t= qlafx00_enable_intrs,\n\t.disable_intrs\t\t= qlafx00_disable_intrs,\n\t.abort_command\t\t= qla24xx_async_abort_command,\n\t.target_reset\t\t= qlafx00_abort_target,\n\t.lun_reset\t\t= qlafx00_lun_reset,\n\t.fabric_login\t\t= NULL,\n\t.fabric_logout\t\t= NULL,\n\t.calc_req_entries\t= NULL,\n\t.build_iocbs\t\t= NULL,\n\t.prep_ms_iocb\t\t= qla24xx_prep_ms_iocb,\n\t.prep_ms_fdmi_iocb\t= qla24xx_prep_ms_fdmi_iocb,\n\t.read_nvram\t\t= qla24xx_read_nvram_data,\n\t.write_nvram\t\t= qla24xx_write_nvram_data,\n\t.fw_dump\t\t= NULL,\n\t.beacon_on\t\t= qla24xx_beacon_on,\n\t.beacon_off\t\t= qla24xx_beacon_off,\n\t.beacon_blink\t\t= NULL,\n\t.read_optrom\t\t= qla24xx_read_optrom_data,\n\t.write_optrom\t\t= qla24xx_write_optrom_data,\n\t.get_flash_version\t= qla24xx_get_flash_version,\n\t.start_scsi\t\t= qlafx00_start_scsi,\n\t.start_scsi_mq          = NULL,\n\t.abort_isp\t\t= qlafx00_abort_isp,\n\t.iospace_config\t\t= qlafx00_iospace_config,\n\t.initialize_adapter\t= qlafx00_initialize_adapter,\n};\n\nstatic struct isp_operations qla27xx_isp_ops = {\n\t.pci_config\t\t= qla25xx_pci_config,\n\t.reset_chip\t\t= qla24xx_reset_chip,\n\t.chip_diag\t\t= qla24xx_chip_diag,\n\t.config_rings\t\t= qla24xx_config_rings,\n\t.reset_adapter\t\t= qla24xx_reset_adapter,\n\t.nvram_config\t\t= qla81xx_nvram_config,\n\t.update_fw_options\t= qla24xx_update_fw_options,\n\t.load_risc\t\t= qla81xx_load_risc,\n\t.pci_info_str\t\t= qla24xx_pci_info_str,\n\t.fw_version_str\t\t= qla24xx_fw_version_str,\n\t.intr_handler\t\t= qla24xx_intr_handler,\n\t.enable_intrs\t\t= qla24xx_enable_intrs,\n\t.disable_intrs\t\t= qla24xx_disable_intrs,\n\t.abort_command\t\t= qla24xx_abort_command,\n\t.target_reset\t\t= qla24xx_abort_target,\n\t.lun_reset\t\t= qla24xx_lun_reset,\n\t.fabric_login\t\t= qla24xx_login_fabric,\n\t.fabric_logout\t\t= qla24xx_fabric_logout,\n\t.calc_req_entries\t= NULL,\n\t.build_iocbs\t\t= NULL,\n\t.prep_ms_iocb\t\t= qla24xx_prep_ms_iocb,\n\t.prep_ms_fdmi_iocb\t= qla24xx_prep_ms_fdmi_iocb,\n\t.read_nvram\t\t= NULL,\n\t.write_nvram\t\t= NULL,\n\t.fw_dump\t\t= qla27xx_fwdump,\n\t.mpi_fw_dump\t\t= qla27xx_mpi_fwdump,\n\t.beacon_on\t\t= qla24xx_beacon_on,\n\t.beacon_off\t\t= qla24xx_beacon_off,\n\t.beacon_blink\t\t= qla83xx_beacon_blink,\n\t.read_optrom\t\t= qla25xx_read_optrom_data,\n\t.write_optrom\t\t= qla24xx_write_optrom_data,\n\t.get_flash_version\t= qla24xx_get_flash_version,\n\t.start_scsi\t\t= qla24xx_dif_start_scsi,\n\t.start_scsi_mq          = qla2xxx_dif_start_scsi_mq,\n\t.abort_isp\t\t= qla2x00_abort_isp,\n\t.iospace_config\t\t= qla83xx_iospace_config,\n\t.initialize_adapter\t= qla2x00_initialize_adapter,\n};\n\nstatic inline void\nqla2x00_set_isp_flags(struct qla_hw_data *ha)\n{\n\tha->device_type = DT_EXTENDED_IDS;\n\tswitch (ha->pdev->device) {\n\tcase PCI_DEVICE_ID_QLOGIC_ISP2100:\n\t\tha->isp_type |= DT_ISP2100;\n\t\tha->device_type &= ~DT_EXTENDED_IDS;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2100;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP2200:\n\t\tha->isp_type |= DT_ISP2200;\n\t\tha->device_type &= ~DT_EXTENDED_IDS;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2100;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP2300:\n\t\tha->isp_type |= DT_ISP2300;\n\t\tha->device_type |= DT_ZIO_SUPPORTED;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2300;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP2312:\n\t\tha->isp_type |= DT_ISP2312;\n\t\tha->device_type |= DT_ZIO_SUPPORTED;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2300;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP2322:\n\t\tha->isp_type |= DT_ISP2322;\n\t\tha->device_type |= DT_ZIO_SUPPORTED;\n\t\tif (ha->pdev->subsystem_vendor == 0x1028 &&\n\t\t    ha->pdev->subsystem_device == 0x0170)\n\t\t\tha->device_type |= DT_OEM_001;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2300;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP6312:\n\t\tha->isp_type |= DT_ISP6312;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2300;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP6322:\n\t\tha->isp_type |= DT_ISP6322;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2300;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP2422:\n\t\tha->isp_type |= DT_ISP2422;\n\t\tha->device_type |= DT_ZIO_SUPPORTED;\n\t\tha->device_type |= DT_FWI2;\n\t\tha->device_type |= DT_IIDMA;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2400;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP2432:\n\t\tha->isp_type |= DT_ISP2432;\n\t\tha->device_type |= DT_ZIO_SUPPORTED;\n\t\tha->device_type |= DT_FWI2;\n\t\tha->device_type |= DT_IIDMA;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2400;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP8432:\n\t\tha->isp_type |= DT_ISP8432;\n\t\tha->device_type |= DT_ZIO_SUPPORTED;\n\t\tha->device_type |= DT_FWI2;\n\t\tha->device_type |= DT_IIDMA;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2400;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP5422:\n\t\tha->isp_type |= DT_ISP5422;\n\t\tha->device_type |= DT_FWI2;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2400;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP5432:\n\t\tha->isp_type |= DT_ISP5432;\n\t\tha->device_type |= DT_FWI2;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2400;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP2532:\n\t\tha->isp_type |= DT_ISP2532;\n\t\tha->device_type |= DT_ZIO_SUPPORTED;\n\t\tha->device_type |= DT_FWI2;\n\t\tha->device_type |= DT_IIDMA;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2400;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP8001:\n\t\tha->isp_type |= DT_ISP8001;\n\t\tha->device_type |= DT_ZIO_SUPPORTED;\n\t\tha->device_type |= DT_FWI2;\n\t\tha->device_type |= DT_IIDMA;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2400;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP8021:\n\t\tha->isp_type |= DT_ISP8021;\n\t\tha->device_type |= DT_ZIO_SUPPORTED;\n\t\tha->device_type |= DT_FWI2;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2400;\n\t\t/* Initialize 82XX ISP flags */\n\t\tqla82xx_init_flags(ha);\n\t\tbreak;\n\t case PCI_DEVICE_ID_QLOGIC_ISP8044:\n\t\tha->isp_type |= DT_ISP8044;\n\t\tha->device_type |= DT_ZIO_SUPPORTED;\n\t\tha->device_type |= DT_FWI2;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2400;\n\t\t/* Initialize 82XX ISP flags */\n\t\tqla82xx_init_flags(ha);\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP2031:\n\t\tha->isp_type |= DT_ISP2031;\n\t\tha->device_type |= DT_ZIO_SUPPORTED;\n\t\tha->device_type |= DT_FWI2;\n\t\tha->device_type |= DT_IIDMA;\n\t\tha->device_type |= DT_T10_PI;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2400;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP8031:\n\t\tha->isp_type |= DT_ISP8031;\n\t\tha->device_type |= DT_ZIO_SUPPORTED;\n\t\tha->device_type |= DT_FWI2;\n\t\tha->device_type |= DT_IIDMA;\n\t\tha->device_type |= DT_T10_PI;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2400;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISPF001:\n\t\tha->isp_type |= DT_ISPFX00;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP2071:\n\t\tha->isp_type |= DT_ISP2071;\n\t\tha->device_type |= DT_ZIO_SUPPORTED;\n\t\tha->device_type |= DT_FWI2;\n\t\tha->device_type |= DT_IIDMA;\n\t\tha->device_type |= DT_T10_PI;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2400;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP2271:\n\t\tha->isp_type |= DT_ISP2271;\n\t\tha->device_type |= DT_ZIO_SUPPORTED;\n\t\tha->device_type |= DT_FWI2;\n\t\tha->device_type |= DT_IIDMA;\n\t\tha->device_type |= DT_T10_PI;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2400;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP2261:\n\t\tha->isp_type |= DT_ISP2261;\n\t\tha->device_type |= DT_ZIO_SUPPORTED;\n\t\tha->device_type |= DT_FWI2;\n\t\tha->device_type |= DT_IIDMA;\n\t\tha->device_type |= DT_T10_PI;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2400;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP2081:\n\tcase PCI_DEVICE_ID_QLOGIC_ISP2089:\n\t\tha->isp_type |= DT_ISP2081;\n\t\tha->device_type |= DT_ZIO_SUPPORTED;\n\t\tha->device_type |= DT_FWI2;\n\t\tha->device_type |= DT_IIDMA;\n\t\tha->device_type |= DT_T10_PI;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2400;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_QLOGIC_ISP2281:\n\tcase PCI_DEVICE_ID_QLOGIC_ISP2289:\n\t\tha->isp_type |= DT_ISP2281;\n\t\tha->device_type |= DT_ZIO_SUPPORTED;\n\t\tha->device_type |= DT_FWI2;\n\t\tha->device_type |= DT_IIDMA;\n\t\tha->device_type |= DT_T10_PI;\n\t\tha->fw_srisc_address = RISC_START_ADDRESS_2400;\n\t\tbreak;\n\t}\n\n\tif (IS_QLA82XX(ha))\n\t\tha->port_no = ha->portnum & 1;\n\telse {\n\t\t/* Get adapter physical port no from interrupt pin register. */\n\t\tpci_read_config_byte(ha->pdev, PCI_INTERRUPT_PIN, &ha->port_no);\n\t\tif (IS_QLA25XX(ha) || IS_QLA2031(ha) ||\n\t\t    IS_QLA27XX(ha) || IS_QLA28XX(ha))\n\t\t\tha->port_no--;\n\t\telse\n\t\t\tha->port_no = !(ha->port_no & 1);\n\t}\n\n\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x000b,\n\t    \"device_type=0x%x port=%d fw_srisc_address=0x%x.\\n\",\n\t    ha->device_type, ha->port_no, ha->fw_srisc_address);\n}\n\nstatic void\nqla2xxx_scan_start(struct Scsi_Host *shost)\n{\n\tscsi_qla_host_t *vha = shost_priv(shost);\n\n\tif (vha->hw->flags.running_gold_fw)\n\t\treturn;\n\n\tset_bit(LOOP_RESYNC_NEEDED, &vha->dpc_flags);\n\tset_bit(LOCAL_LOOP_UPDATE, &vha->dpc_flags);\n\tset_bit(RSCN_UPDATE, &vha->dpc_flags);\n\tset_bit(NPIV_CONFIG_NEEDED, &vha->dpc_flags);\n}\n\nstatic int\nqla2xxx_scan_finished(struct Scsi_Host *shost, unsigned long time)\n{\n\tscsi_qla_host_t *vha = shost_priv(shost);\n\n\tif (test_bit(UNLOADING, &vha->dpc_flags))\n\t\treturn 1;\n\tif (!vha->host)\n\t\treturn 1;\n\tif (time > vha->hw->loop_reset_delay * HZ)\n\t\treturn 1;\n\n\treturn atomic_read(&vha->loop_state) == LOOP_READY;\n}\n\nstatic void qla2x00_iocb_work_fn(struct work_struct *work)\n{\n\tstruct scsi_qla_host *vha = container_of(work,\n\t\tstruct scsi_qla_host, iocb_work);\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct scsi_qla_host *base_vha = pci_get_drvdata(ha->pdev);\n\tint i = 2;\n\tunsigned long flags;\n\n\tif (test_bit(UNLOADING, &base_vha->dpc_flags))\n\t\treturn;\n\n\twhile (!list_empty(&vha->work_list) && i > 0) {\n\t\tqla2x00_do_work(vha);\n\t\ti--;\n\t}\n\n\tspin_lock_irqsave(&vha->work_lock, flags);\n\tclear_bit(IOCB_WORK_ACTIVE, &vha->dpc_flags);\n\tspin_unlock_irqrestore(&vha->work_lock, flags);\n}\n\n/*\n * PCI driver interface\n */\nstatic int\nqla2x00_probe_one(struct pci_dev *pdev, const struct pci_device_id *id)\n{\n\tint\tret = -ENODEV;\n\tstruct Scsi_Host *host;\n\tscsi_qla_host_t *base_vha = NULL;\n\tstruct qla_hw_data *ha;\n\tchar pci_info[30];\n\tchar fw_str[30], wq_name[30];\n\tstruct scsi_host_template *sht;\n\tint bars, mem_only = 0;\n\tuint16_t req_length = 0, rsp_length = 0;\n\tstruct req_que *req = NULL;\n\tstruct rsp_que *rsp = NULL;\n\tint i;\n\n\tbars = pci_select_bars(pdev, IORESOURCE_MEM | IORESOURCE_IO);\n\tsht = &qla2xxx_driver_template;\n\tif (pdev->device == PCI_DEVICE_ID_QLOGIC_ISP2422 ||\n\t    pdev->device == PCI_DEVICE_ID_QLOGIC_ISP2432 ||\n\t    pdev->device == PCI_DEVICE_ID_QLOGIC_ISP8432 ||\n\t    pdev->device == PCI_DEVICE_ID_QLOGIC_ISP5422 ||\n\t    pdev->device == PCI_DEVICE_ID_QLOGIC_ISP5432 ||\n\t    pdev->device == PCI_DEVICE_ID_QLOGIC_ISP2532 ||\n\t    pdev->device == PCI_DEVICE_ID_QLOGIC_ISP8001 ||\n\t    pdev->device == PCI_DEVICE_ID_QLOGIC_ISP8021 ||\n\t    pdev->device == PCI_DEVICE_ID_QLOGIC_ISP2031 ||\n\t    pdev->device == PCI_DEVICE_ID_QLOGIC_ISP8031 ||\n\t    pdev->device == PCI_DEVICE_ID_QLOGIC_ISPF001 ||\n\t    pdev->device == PCI_DEVICE_ID_QLOGIC_ISP8044 ||\n\t    pdev->device == PCI_DEVICE_ID_QLOGIC_ISP2071 ||\n\t    pdev->device == PCI_DEVICE_ID_QLOGIC_ISP2271 ||\n\t    pdev->device == PCI_DEVICE_ID_QLOGIC_ISP2261 ||\n\t    pdev->device == PCI_DEVICE_ID_QLOGIC_ISP2081 ||\n\t    pdev->device == PCI_DEVICE_ID_QLOGIC_ISP2281 ||\n\t    pdev->device == PCI_DEVICE_ID_QLOGIC_ISP2089 ||\n\t    pdev->device == PCI_DEVICE_ID_QLOGIC_ISP2289) {\n\t\tbars = pci_select_bars(pdev, IORESOURCE_MEM);\n\t\tmem_only = 1;\n\t\tql_dbg_pci(ql_dbg_init, pdev, 0x0007,\n\t\t    \"Mem only adapter.\\n\");\n\t}\n\tql_dbg_pci(ql_dbg_init, pdev, 0x0008,\n\t    \"Bars=%d.\\n\", bars);\n\n\tif (mem_only) {\n\t\tif (pci_enable_device_mem(pdev))\n\t\t\treturn ret;\n\t} else {\n\t\tif (pci_enable_device(pdev))\n\t\t\treturn ret;\n\t}\n\n\t/* This may fail but that's ok */\n\tpci_enable_pcie_error_reporting(pdev);\n\n\tha = kzalloc(sizeof(struct qla_hw_data), GFP_KERNEL);\n\tif (!ha) {\n\t\tql_log_pci(ql_log_fatal, pdev, 0x0009,\n\t\t    \"Unable to allocate memory for ha.\\n\");\n\t\tgoto disable_device;\n\t}\n\tql_dbg_pci(ql_dbg_init, pdev, 0x000a,\n\t    \"Memory allocated for ha=%p.\\n\", ha);\n\tha->pdev = pdev;\n\tINIT_LIST_HEAD(&ha->tgt.q_full_list);\n\tspin_lock_init(&ha->tgt.q_full_lock);\n\tspin_lock_init(&ha->tgt.sess_lock);\n\tspin_lock_init(&ha->tgt.atio_lock);\n\n\tatomic_set(&ha->nvme_active_aen_cnt, 0);\n\n\t/* Clear our data area */\n\tha->bars = bars;\n\tha->mem_only = mem_only;\n\tspin_lock_init(&ha->hardware_lock);\n\tspin_lock_init(&ha->vport_slock);\n\tmutex_init(&ha->selflogin_lock);\n\tmutex_init(&ha->optrom_mutex);\n\n\t/* Set ISP-type information. */\n\tqla2x00_set_isp_flags(ha);\n\n\t/* Set EEH reset type to fundamental if required by hba */\n\tif (IS_QLA24XX(ha) || IS_QLA25XX(ha) || IS_QLA81XX(ha) ||\n\t    IS_QLA83XX(ha) || IS_QLA27XX(ha) || IS_QLA28XX(ha))\n\t\tpdev->needs_freset = 1;\n\n\tha->prev_topology = 0;\n\tha->init_cb_size = sizeof(init_cb_t);\n\tha->link_data_rate = PORT_SPEED_UNKNOWN;\n\tha->optrom_size = OPTROM_SIZE_2300;\n\tha->max_exchg = FW_MAX_EXCHANGES_CNT;\n\tatomic_set(&ha->num_pend_mbx_stage1, 0);\n\tatomic_set(&ha->num_pend_mbx_stage2, 0);\n\tatomic_set(&ha->num_pend_mbx_stage3, 0);\n\tatomic_set(&ha->zio_threshold, DEFAULT_ZIO_THRESHOLD);\n\tha->last_zio_threshold = DEFAULT_ZIO_THRESHOLD;\n\n\t/* Assign ISP specific operations. */\n\tif (IS_QLA2100(ha)) {\n\t\tha->max_fibre_devices = MAX_FIBRE_DEVICES_2100;\n\t\tha->mbx_count = MAILBOX_REGISTER_COUNT_2100;\n\t\treq_length = REQUEST_ENTRY_CNT_2100;\n\t\trsp_length = RESPONSE_ENTRY_CNT_2100;\n\t\tha->max_loop_id = SNS_LAST_LOOP_ID_2100;\n\t\tha->gid_list_info_size = 4;\n\t\tha->flash_conf_off = ~0;\n\t\tha->flash_data_off = ~0;\n\t\tha->nvram_conf_off = ~0;\n\t\tha->nvram_data_off = ~0;\n\t\tha->isp_ops = &qla2100_isp_ops;\n\t} else if (IS_QLA2200(ha)) {\n\t\tha->max_fibre_devices = MAX_FIBRE_DEVICES_2100;\n\t\tha->mbx_count = MAILBOX_REGISTER_COUNT_2200;\n\t\treq_length = REQUEST_ENTRY_CNT_2200;\n\t\trsp_length = RESPONSE_ENTRY_CNT_2100;\n\t\tha->max_loop_id = SNS_LAST_LOOP_ID_2100;\n\t\tha->gid_list_info_size = 4;\n\t\tha->flash_conf_off = ~0;\n\t\tha->flash_data_off = ~0;\n\t\tha->nvram_conf_off = ~0;\n\t\tha->nvram_data_off = ~0;\n\t\tha->isp_ops = &qla2100_isp_ops;\n\t} else if (IS_QLA23XX(ha)) {\n\t\tha->max_fibre_devices = MAX_FIBRE_DEVICES_2100;\n\t\tha->mbx_count = MAILBOX_REGISTER_COUNT;\n\t\treq_length = REQUEST_ENTRY_CNT_2200;\n\t\trsp_length = RESPONSE_ENTRY_CNT_2300;\n\t\tha->max_loop_id = SNS_LAST_LOOP_ID_2300;\n\t\tha->gid_list_info_size = 6;\n\t\tif (IS_QLA2322(ha) || IS_QLA6322(ha))\n\t\t\tha->optrom_size = OPTROM_SIZE_2322;\n\t\tha->flash_conf_off = ~0;\n\t\tha->flash_data_off = ~0;\n\t\tha->nvram_conf_off = ~0;\n\t\tha->nvram_data_off = ~0;\n\t\tha->isp_ops = &qla2300_isp_ops;\n\t} else if (IS_QLA24XX_TYPE(ha)) {\n\t\tha->max_fibre_devices = MAX_FIBRE_DEVICES_2400;\n\t\tha->mbx_count = MAILBOX_REGISTER_COUNT;\n\t\treq_length = REQUEST_ENTRY_CNT_24XX;\n\t\trsp_length = RESPONSE_ENTRY_CNT_2300;\n\t\tha->tgt.atio_q_length = ATIO_ENTRY_CNT_24XX;\n\t\tha->max_loop_id = SNS_LAST_LOOP_ID_2300;\n\t\tha->init_cb_size = sizeof(struct mid_init_cb_24xx);\n\t\tha->gid_list_info_size = 8;\n\t\tha->optrom_size = OPTROM_SIZE_24XX;\n\t\tha->nvram_npiv_size = QLA_MAX_VPORTS_QLA24XX;\n\t\tha->isp_ops = &qla24xx_isp_ops;\n\t\tha->flash_conf_off = FARX_ACCESS_FLASH_CONF;\n\t\tha->flash_data_off = FARX_ACCESS_FLASH_DATA;\n\t\tha->nvram_conf_off = FARX_ACCESS_NVRAM_CONF;\n\t\tha->nvram_data_off = FARX_ACCESS_NVRAM_DATA;\n\t} else if (IS_QLA25XX(ha)) {\n\t\tha->max_fibre_devices = MAX_FIBRE_DEVICES_2400;\n\t\tha->mbx_count = MAILBOX_REGISTER_COUNT;\n\t\treq_length = REQUEST_ENTRY_CNT_24XX;\n\t\trsp_length = RESPONSE_ENTRY_CNT_2300;\n\t\tha->tgt.atio_q_length = ATIO_ENTRY_CNT_24XX;\n\t\tha->max_loop_id = SNS_LAST_LOOP_ID_2300;\n\t\tha->init_cb_size = sizeof(struct mid_init_cb_24xx);\n\t\tha->gid_list_info_size = 8;\n\t\tha->optrom_size = OPTROM_SIZE_25XX;\n\t\tha->nvram_npiv_size = QLA_MAX_VPORTS_QLA25XX;\n\t\tha->isp_ops = &qla25xx_isp_ops;\n\t\tha->flash_conf_off = FARX_ACCESS_FLASH_CONF;\n\t\tha->flash_data_off = FARX_ACCESS_FLASH_DATA;\n\t\tha->nvram_conf_off = FARX_ACCESS_NVRAM_CONF;\n\t\tha->nvram_data_off = FARX_ACCESS_NVRAM_DATA;\n\t} else if (IS_QLA81XX(ha)) {\n\t\tha->max_fibre_devices = MAX_FIBRE_DEVICES_2400;\n\t\tha->mbx_count = MAILBOX_REGISTER_COUNT;\n\t\treq_length = REQUEST_ENTRY_CNT_24XX;\n\t\trsp_length = RESPONSE_ENTRY_CNT_2300;\n\t\tha->tgt.atio_q_length = ATIO_ENTRY_CNT_24XX;\n\t\tha->max_loop_id = SNS_LAST_LOOP_ID_2300;\n\t\tha->init_cb_size = sizeof(struct mid_init_cb_81xx);\n\t\tha->gid_list_info_size = 8;\n\t\tha->optrom_size = OPTROM_SIZE_81XX;\n\t\tha->nvram_npiv_size = QLA_MAX_VPORTS_QLA25XX;\n\t\tha->isp_ops = &qla81xx_isp_ops;\n\t\tha->flash_conf_off = FARX_ACCESS_FLASH_CONF_81XX;\n\t\tha->flash_data_off = FARX_ACCESS_FLASH_DATA_81XX;\n\t\tha->nvram_conf_off = ~0;\n\t\tha->nvram_data_off = ~0;\n\t} else if (IS_QLA82XX(ha)) {\n\t\tha->max_fibre_devices = MAX_FIBRE_DEVICES_2400;\n\t\tha->mbx_count = MAILBOX_REGISTER_COUNT;\n\t\treq_length = REQUEST_ENTRY_CNT_82XX;\n\t\trsp_length = RESPONSE_ENTRY_CNT_82XX;\n\t\tha->max_loop_id = SNS_LAST_LOOP_ID_2300;\n\t\tha->init_cb_size = sizeof(struct mid_init_cb_81xx);\n\t\tha->gid_list_info_size = 8;\n\t\tha->optrom_size = OPTROM_SIZE_82XX;\n\t\tha->nvram_npiv_size = QLA_MAX_VPORTS_QLA25XX;\n\t\tha->isp_ops = &qla82xx_isp_ops;\n\t\tha->flash_conf_off = FARX_ACCESS_FLASH_CONF;\n\t\tha->flash_data_off = FARX_ACCESS_FLASH_DATA;\n\t\tha->nvram_conf_off = FARX_ACCESS_NVRAM_CONF;\n\t\tha->nvram_data_off = FARX_ACCESS_NVRAM_DATA;\n\t} else if (IS_QLA8044(ha)) {\n\t\tha->max_fibre_devices = MAX_FIBRE_DEVICES_2400;\n\t\tha->mbx_count = MAILBOX_REGISTER_COUNT;\n\t\treq_length = REQUEST_ENTRY_CNT_82XX;\n\t\trsp_length = RESPONSE_ENTRY_CNT_82XX;\n\t\tha->max_loop_id = SNS_LAST_LOOP_ID_2300;\n\t\tha->init_cb_size = sizeof(struct mid_init_cb_81xx);\n\t\tha->gid_list_info_size = 8;\n\t\tha->optrom_size = OPTROM_SIZE_83XX;\n\t\tha->nvram_npiv_size = QLA_MAX_VPORTS_QLA25XX;\n\t\tha->isp_ops = &qla8044_isp_ops;\n\t\tha->flash_conf_off = FARX_ACCESS_FLASH_CONF;\n\t\tha->flash_data_off = FARX_ACCESS_FLASH_DATA;\n\t\tha->nvram_conf_off = FARX_ACCESS_NVRAM_CONF;\n\t\tha->nvram_data_off = FARX_ACCESS_NVRAM_DATA;\n\t} else if (IS_QLA83XX(ha)) {\n\t\tha->portnum = PCI_FUNC(ha->pdev->devfn);\n\t\tha->max_fibre_devices = MAX_FIBRE_DEVICES_2400;\n\t\tha->mbx_count = MAILBOX_REGISTER_COUNT;\n\t\treq_length = REQUEST_ENTRY_CNT_83XX;\n\t\trsp_length = RESPONSE_ENTRY_CNT_83XX;\n\t\tha->tgt.atio_q_length = ATIO_ENTRY_CNT_24XX;\n\t\tha->max_loop_id = SNS_LAST_LOOP_ID_2300;\n\t\tha->init_cb_size = sizeof(struct mid_init_cb_81xx);\n\t\tha->gid_list_info_size = 8;\n\t\tha->optrom_size = OPTROM_SIZE_83XX;\n\t\tha->nvram_npiv_size = QLA_MAX_VPORTS_QLA25XX;\n\t\tha->isp_ops = &qla83xx_isp_ops;\n\t\tha->flash_conf_off = FARX_ACCESS_FLASH_CONF_81XX;\n\t\tha->flash_data_off = FARX_ACCESS_FLASH_DATA_81XX;\n\t\tha->nvram_conf_off = ~0;\n\t\tha->nvram_data_off = ~0;\n\t}  else if (IS_QLAFX00(ha)) {\n\t\tha->max_fibre_devices = MAX_FIBRE_DEVICES_FX00;\n\t\tha->mbx_count = MAILBOX_REGISTER_COUNT_FX00;\n\t\tha->aen_mbx_count = AEN_MAILBOX_REGISTER_COUNT_FX00;\n\t\treq_length = REQUEST_ENTRY_CNT_FX00;\n\t\trsp_length = RESPONSE_ENTRY_CNT_FX00;\n\t\tha->isp_ops = &qlafx00_isp_ops;\n\t\tha->port_down_retry_count = 30; /* default value */\n\t\tha->mr.fw_hbt_cnt = QLAFX00_HEARTBEAT_INTERVAL;\n\t\tha->mr.fw_reset_timer_tick = QLAFX00_RESET_INTERVAL;\n\t\tha->mr.fw_critemp_timer_tick = QLAFX00_CRITEMP_INTERVAL;\n\t\tha->mr.fw_hbt_en = 1;\n\t\tha->mr.host_info_resend = false;\n\t\tha->mr.hinfo_resend_timer_tick = QLAFX00_HINFO_RESEND_INTERVAL;\n\t} else if (IS_QLA27XX(ha)) {\n\t\tha->portnum = PCI_FUNC(ha->pdev->devfn);\n\t\tha->max_fibre_devices = MAX_FIBRE_DEVICES_2400;\n\t\tha->mbx_count = MAILBOX_REGISTER_COUNT;\n\t\treq_length = REQUEST_ENTRY_CNT_83XX;\n\t\trsp_length = RESPONSE_ENTRY_CNT_83XX;\n\t\tha->tgt.atio_q_length = ATIO_ENTRY_CNT_24XX;\n\t\tha->max_loop_id = SNS_LAST_LOOP_ID_2300;\n\t\tha->init_cb_size = sizeof(struct mid_init_cb_81xx);\n\t\tha->gid_list_info_size = 8;\n\t\tha->optrom_size = OPTROM_SIZE_83XX;\n\t\tha->nvram_npiv_size = QLA_MAX_VPORTS_QLA25XX;\n\t\tha->isp_ops = &qla27xx_isp_ops;\n\t\tha->flash_conf_off = FARX_ACCESS_FLASH_CONF_81XX;\n\t\tha->flash_data_off = FARX_ACCESS_FLASH_DATA_81XX;\n\t\tha->nvram_conf_off = ~0;\n\t\tha->nvram_data_off = ~0;\n\t} else if (IS_QLA28XX(ha)) {\n\t\tha->portnum = PCI_FUNC(ha->pdev->devfn);\n\t\tha->max_fibre_devices = MAX_FIBRE_DEVICES_2400;\n\t\tha->mbx_count = MAILBOX_REGISTER_COUNT;\n\t\treq_length = REQUEST_ENTRY_CNT_24XX;\n\t\trsp_length = RESPONSE_ENTRY_CNT_2300;\n\t\tha->tgt.atio_q_length = ATIO_ENTRY_CNT_24XX;\n\t\tha->max_loop_id = SNS_LAST_LOOP_ID_2300;\n\t\tha->init_cb_size = sizeof(struct mid_init_cb_81xx);\n\t\tha->gid_list_info_size = 8;\n\t\tha->optrom_size = OPTROM_SIZE_28XX;\n\t\tha->nvram_npiv_size = QLA_MAX_VPORTS_QLA25XX;\n\t\tha->isp_ops = &qla27xx_isp_ops;\n\t\tha->flash_conf_off = FARX_ACCESS_FLASH_CONF_28XX;\n\t\tha->flash_data_off = FARX_ACCESS_FLASH_DATA_28XX;\n\t\tha->nvram_conf_off = ~0;\n\t\tha->nvram_data_off = ~0;\n\t}\n\n\tql_dbg_pci(ql_dbg_init, pdev, 0x001e,\n\t    \"mbx_count=%d, req_length=%d, \"\n\t    \"rsp_length=%d, max_loop_id=%d, init_cb_size=%d, \"\n\t    \"gid_list_info_size=%d, optrom_size=%d, nvram_npiv_size=%d, \"\n\t    \"max_fibre_devices=%d.\\n\",\n\t    ha->mbx_count, req_length, rsp_length, ha->max_loop_id,\n\t    ha->init_cb_size, ha->gid_list_info_size, ha->optrom_size,\n\t    ha->nvram_npiv_size, ha->max_fibre_devices);\n\tql_dbg_pci(ql_dbg_init, pdev, 0x001f,\n\t    \"isp_ops=%p, flash_conf_off=%d, \"\n\t    \"flash_data_off=%d, nvram_conf_off=%d, nvram_data_off=%d.\\n\",\n\t    ha->isp_ops, ha->flash_conf_off, ha->flash_data_off,\n\t    ha->nvram_conf_off, ha->nvram_data_off);\n\n\t/* Configure PCI I/O space */\n\tret = ha->isp_ops->iospace_config(ha);\n\tif (ret)\n\t\tgoto iospace_config_failed;\n\n\tql_log_pci(ql_log_info, pdev, 0x001d,\n\t    \"Found an ISP%04X irq %d iobase 0x%p.\\n\",\n\t    pdev->device, pdev->irq, ha->iobase);\n\tmutex_init(&ha->vport_lock);\n\tmutex_init(&ha->mq_lock);\n\tinit_completion(&ha->mbx_cmd_comp);\n\tcomplete(&ha->mbx_cmd_comp);\n\tinit_completion(&ha->mbx_intr_comp);\n\tinit_completion(&ha->dcbx_comp);\n\tinit_completion(&ha->lb_portup_comp);\n\n\tset_bit(0, (unsigned long *) ha->vp_idx_map);\n\n\tqla2x00_config_dma_addressing(ha);\n\tql_dbg_pci(ql_dbg_init, pdev, 0x0020,\n\t    \"64 Bit addressing is %s.\\n\",\n\t    ha->flags.enable_64bit_addressing ? \"enable\" :\n\t    \"disable\");\n\tret = qla2x00_mem_alloc(ha, req_length, rsp_length, &req, &rsp);\n\tif (ret) {\n\t\tql_log_pci(ql_log_fatal, pdev, 0x0031,\n\t\t    \"Failed to allocate memory for adapter, aborting.\\n\");\n\n\t\tgoto probe_hw_failed;\n\t}\n\n\treq->max_q_depth = MAX_Q_DEPTH;\n\tif (ql2xmaxqdepth != 0 && ql2xmaxqdepth <= 0xffffU)\n\t\treq->max_q_depth = ql2xmaxqdepth;\n\n\n\tbase_vha = qla2x00_create_host(sht, ha);\n\tif (!base_vha) {\n\t\tret = -ENOMEM;\n\t\tgoto probe_hw_failed;\n\t}\n\n\tpci_set_drvdata(pdev, base_vha);\n\tset_bit(PFLG_DRIVER_PROBING, &base_vha->pci_flags);\n\n\thost = base_vha->host;\n\tbase_vha->req = req;\n\tif (IS_QLA2XXX_MIDTYPE(ha))\n\t\tbase_vha->mgmt_svr_loop_id =\n\t\t\tqla2x00_reserve_mgmt_server_loop_id(base_vha);\n\telse\n\t\tbase_vha->mgmt_svr_loop_id = MANAGEMENT_SERVER +\n\t\t\t\t\t\tbase_vha->vp_idx;\n\n\t/* Setup fcport template structure. */\n\tha->mr.fcport.vha = base_vha;\n\tha->mr.fcport.port_type = FCT_UNKNOWN;\n\tha->mr.fcport.loop_id = FC_NO_LOOP_ID;\n\tqla2x00_set_fcport_state(&ha->mr.fcport, FCS_UNCONFIGURED);\n\tha->mr.fcport.supported_classes = FC_COS_UNSPECIFIED;\n\tha->mr.fcport.scan_state = 1;\n\n\t/* Set the SG table size based on ISP type */\n\tif (!IS_FWI2_CAPABLE(ha)) {\n\t\tif (IS_QLA2100(ha))\n\t\t\thost->sg_tablesize = 32;\n\t} else {\n\t\tif (!IS_QLA82XX(ha))\n\t\t\thost->sg_tablesize = QLA_SG_ALL;\n\t}\n\thost->max_id = ha->max_fibre_devices;\n\thost->cmd_per_lun = 3;\n\thost->unique_id = host->host_no;\n\tif (IS_T10_PI_CAPABLE(ha) && ql2xenabledif)\n\t\thost->max_cmd_len = 32;\n\telse\n\t\thost->max_cmd_len = MAX_CMDSZ;\n\thost->max_channel = MAX_BUSES - 1;\n\t/* Older HBAs support only 16-bit LUNs */\n\tif (!IS_QLAFX00(ha) && !IS_FWI2_CAPABLE(ha) &&\n\t    ql2xmaxlun > 0xffff)\n\t\thost->max_lun = 0xffff;\n\telse\n\t\thost->max_lun = ql2xmaxlun;\n\thost->transportt = qla2xxx_transport_template;\n\tsht->vendor_id = (SCSI_NL_VID_TYPE_PCI | PCI_VENDOR_ID_QLOGIC);\n\n\tql_dbg(ql_dbg_init, base_vha, 0x0033,\n\t    \"max_id=%d this_id=%d \"\n\t    \"cmd_per_len=%d unique_id=%d max_cmd_len=%d max_channel=%d \"\n\t    \"max_lun=%llu transportt=%p, vendor_id=%llu.\\n\", host->max_id,\n\t    host->this_id, host->cmd_per_lun, host->unique_id,\n\t    host->max_cmd_len, host->max_channel, host->max_lun,\n\t    host->transportt, sht->vendor_id);\n\n\tINIT_WORK(&base_vha->iocb_work, qla2x00_iocb_work_fn);\n\n\t/* Set up the irqs */\n\tret = qla2x00_request_irqs(ha, rsp);\n\tif (ret)\n\t\tgoto probe_failed;\n\n\t/* Alloc arrays of request and response ring ptrs */\n\tret = qla2x00_alloc_queues(ha, req, rsp);\n\tif (ret) {\n\t\tql_log(ql_log_fatal, base_vha, 0x003d,\n\t\t    \"Failed to allocate memory for queue pointers...\"\n\t\t    \"aborting.\\n\");\n\t\tret = -ENODEV;\n\t\tgoto probe_failed;\n\t}\n\n\tif (ha->mqenable) {\n\t\t/* number of hardware queues supported by blk/scsi-mq*/\n\t\thost->nr_hw_queues = ha->max_qpairs;\n\n\t\tql_dbg(ql_dbg_init, base_vha, 0x0192,\n\t\t\t\"blk/scsi-mq enabled, HW queues = %d.\\n\", host->nr_hw_queues);\n\t} else {\n\t\tif (ql2xnvmeenable) {\n\t\t\thost->nr_hw_queues = ha->max_qpairs;\n\t\t\tql_dbg(ql_dbg_init, base_vha, 0x0194,\n\t\t\t    \"FC-NVMe support is enabled, HW queues=%d\\n\",\n\t\t\t    host->nr_hw_queues);\n\t\t} else {\n\t\t\tql_dbg(ql_dbg_init, base_vha, 0x0193,\n\t\t\t    \"blk/scsi-mq disabled.\\n\");\n\t\t}\n\t}\n\n\tqlt_probe_one_stage1(base_vha, ha);\n\n\tpci_save_state(pdev);\n\n\t/* Assign back pointers */\n\trsp->req = req;\n\treq->rsp = rsp;\n\n\tif (IS_QLAFX00(ha)) {\n\t\tha->rsp_q_map[0] = rsp;\n\t\tha->req_q_map[0] = req;\n\t\tset_bit(0, ha->req_qid_map);\n\t\tset_bit(0, ha->rsp_qid_map);\n\t}\n\n\t/* FWI2-capable only. */\n\treq->req_q_in = &ha->iobase->isp24.req_q_in;\n\treq->req_q_out = &ha->iobase->isp24.req_q_out;\n\trsp->rsp_q_in = &ha->iobase->isp24.rsp_q_in;\n\trsp->rsp_q_out = &ha->iobase->isp24.rsp_q_out;\n\tif (ha->mqenable || IS_QLA83XX(ha) || IS_QLA27XX(ha) ||\n\t    IS_QLA28XX(ha)) {\n\t\treq->req_q_in = &ha->mqiobase->isp25mq.req_q_in;\n\t\treq->req_q_out = &ha->mqiobase->isp25mq.req_q_out;\n\t\trsp->rsp_q_in = &ha->mqiobase->isp25mq.rsp_q_in;\n\t\trsp->rsp_q_out =  &ha->mqiobase->isp25mq.rsp_q_out;\n\t}\n\n\tif (IS_QLAFX00(ha)) {\n\t\treq->req_q_in = &ha->iobase->ispfx00.req_q_in;\n\t\treq->req_q_out = &ha->iobase->ispfx00.req_q_out;\n\t\trsp->rsp_q_in = &ha->iobase->ispfx00.rsp_q_in;\n\t\trsp->rsp_q_out = &ha->iobase->ispfx00.rsp_q_out;\n\t}\n\n\tif (IS_P3P_TYPE(ha)) {\n\t\treq->req_q_out = &ha->iobase->isp82.req_q_out[0];\n\t\trsp->rsp_q_in = &ha->iobase->isp82.rsp_q_in[0];\n\t\trsp->rsp_q_out = &ha->iobase->isp82.rsp_q_out[0];\n\t}\n\n\tql_dbg(ql_dbg_multiq, base_vha, 0xc009,\n\t    \"rsp_q_map=%p req_q_map=%p rsp->req=%p req->rsp=%p.\\n\",\n\t    ha->rsp_q_map, ha->req_q_map, rsp->req, req->rsp);\n\tql_dbg(ql_dbg_multiq, base_vha, 0xc00a,\n\t    \"req->req_q_in=%p req->req_q_out=%p \"\n\t    \"rsp->rsp_q_in=%p rsp->rsp_q_out=%p.\\n\",\n\t    req->req_q_in, req->req_q_out,\n\t    rsp->rsp_q_in, rsp->rsp_q_out);\n\tql_dbg(ql_dbg_init, base_vha, 0x003e,\n\t    \"rsp_q_map=%p req_q_map=%p rsp->req=%p req->rsp=%p.\\n\",\n\t    ha->rsp_q_map, ha->req_q_map, rsp->req, req->rsp);\n\tql_dbg(ql_dbg_init, base_vha, 0x003f,\n\t    \"req->req_q_in=%p req->req_q_out=%p rsp->rsp_q_in=%p rsp->rsp_q_out=%p.\\n\",\n\t    req->req_q_in, req->req_q_out, rsp->rsp_q_in, rsp->rsp_q_out);\n\n\tha->wq = alloc_workqueue(\"qla2xxx_wq\", 0, 0);\n\tif (unlikely(!ha->wq)) {\n\t\tret = -ENOMEM;\n\t\tgoto probe_failed;\n\t}\n\n\tif (ha->isp_ops->initialize_adapter(base_vha)) {\n\t\tql_log(ql_log_fatal, base_vha, 0x00d6,\n\t\t    \"Failed to initialize adapter - Adapter flags %x.\\n\",\n\t\t    base_vha->device_flags);\n\n\t\tif (IS_QLA82XX(ha)) {\n\t\t\tqla82xx_idc_lock(ha);\n\t\t\tqla82xx_wr_32(ha, QLA82XX_CRB_DEV_STATE,\n\t\t\t\tQLA8XXX_DEV_FAILED);\n\t\t\tqla82xx_idc_unlock(ha);\n\t\t\tql_log(ql_log_fatal, base_vha, 0x00d7,\n\t\t\t    \"HW State: FAILED.\\n\");\n\t\t} else if (IS_QLA8044(ha)) {\n\t\t\tqla8044_idc_lock(ha);\n\t\t\tqla8044_wr_direct(base_vha,\n\t\t\t\tQLA8044_CRB_DEV_STATE_INDEX,\n\t\t\t\tQLA8XXX_DEV_FAILED);\n\t\t\tqla8044_idc_unlock(ha);\n\t\t\tql_log(ql_log_fatal, base_vha, 0x0150,\n\t\t\t    \"HW State: FAILED.\\n\");\n\t\t}\n\n\t\tret = -ENODEV;\n\t\tgoto probe_failed;\n\t}\n\n\tif (IS_QLAFX00(ha))\n\t\thost->can_queue = QLAFX00_MAX_CANQUEUE;\n\telse\n\t\thost->can_queue = req->num_outstanding_cmds - 10;\n\n\tql_dbg(ql_dbg_init, base_vha, 0x0032,\n\t    \"can_queue=%d, req=%p, mgmt_svr_loop_id=%d, sg_tablesize=%d.\\n\",\n\t    host->can_queue, base_vha->req,\n\t    base_vha->mgmt_svr_loop_id, host->sg_tablesize);\n\n\tif (ha->mqenable) {\n\t\tbool startit = false;\n\n\t\tif (QLA_TGT_MODE_ENABLED())\n\t\t\tstartit = false;\n\n\t\tif (ql2x_ini_mode == QLA2XXX_INI_MODE_ENABLED)\n\t\t\tstartit = true;\n\n\t\t/* Create start of day qpairs for Block MQ */\n\t\tfor (i = 0; i < ha->max_qpairs; i++)\n\t\t\tqla2xxx_create_qpair(base_vha, 5, 0, startit);\n\t}\n\tqla_init_iocb_limit(base_vha);\n\n\tif (ha->flags.running_gold_fw)\n\t\tgoto skip_dpc;\n\n\t/*\n\t * Startup the kernel thread for this host adapter\n\t */\n\tha->dpc_thread = kthread_create(qla2x00_do_dpc, ha,\n\t    \"%s_dpc\", base_vha->host_str);\n\tif (IS_ERR(ha->dpc_thread)) {\n\t\tql_log(ql_log_fatal, base_vha, 0x00ed,\n\t\t    \"Failed to start DPC thread.\\n\");\n\t\tret = PTR_ERR(ha->dpc_thread);\n\t\tha->dpc_thread = NULL;\n\t\tgoto probe_failed;\n\t}\n\tql_dbg(ql_dbg_init, base_vha, 0x00ee,\n\t    \"DPC thread started successfully.\\n\");\n\n\t/*\n\t * If we're not coming up in initiator mode, we might sit for\n\t * a while without waking up the dpc thread, which leads to a\n\t * stuck process warning.  So just kick the dpc once here and\n\t * let the kthread start (and go back to sleep in qla2x00_do_dpc).\n\t */\n\tqla2xxx_wake_dpc(base_vha);\n\n\tINIT_WORK(&ha->board_disable, qla2x00_disable_board_on_pci_error);\n\n\tif (IS_QLA8031(ha) || IS_MCTP_CAPABLE(ha)) {\n\t\tsprintf(wq_name, \"qla2xxx_%lu_dpc_lp_wq\", base_vha->host_no);\n\t\tha->dpc_lp_wq = create_singlethread_workqueue(wq_name);\n\t\tINIT_WORK(&ha->idc_aen, qla83xx_service_idc_aen);\n\n\t\tsprintf(wq_name, \"qla2xxx_%lu_dpc_hp_wq\", base_vha->host_no);\n\t\tha->dpc_hp_wq = create_singlethread_workqueue(wq_name);\n\t\tINIT_WORK(&ha->nic_core_reset, qla83xx_nic_core_reset_work);\n\t\tINIT_WORK(&ha->idc_state_handler,\n\t\t    qla83xx_idc_state_handler_work);\n\t\tINIT_WORK(&ha->nic_core_unrecoverable,\n\t\t    qla83xx_nic_core_unrecoverable_work);\n\t}\n\nskip_dpc:\n\tlist_add_tail(&base_vha->list, &ha->vp_list);\n\tbase_vha->host->irq = ha->pdev->irq;\n\n\t/* Initialized the timer */\n\tqla2x00_start_timer(base_vha, WATCH_INTERVAL);\n\tql_dbg(ql_dbg_init, base_vha, 0x00ef,\n\t    \"Started qla2x00_timer with \"\n\t    \"interval=%d.\\n\", WATCH_INTERVAL);\n\tql_dbg(ql_dbg_init, base_vha, 0x00f0,\n\t    \"Detected hba at address=%p.\\n\",\n\t    ha);\n\n\tif (IS_T10_PI_CAPABLE(ha) && ql2xenabledif) {\n\t\tif (ha->fw_attributes & BIT_4) {\n\t\t\tint prot = 0, guard;\n\n\t\t\tbase_vha->flags.difdix_supported = 1;\n\t\t\tql_dbg(ql_dbg_init, base_vha, 0x00f1,\n\t\t\t    \"Registering for DIF/DIX type 1 and 3 protection.\\n\");\n\t\t\tif (ql2xenabledif == 1)\n\t\t\t\tprot = SHOST_DIX_TYPE0_PROTECTION;\n\t\t\tif (ql2xprotmask)\n\t\t\t\tscsi_host_set_prot(host, ql2xprotmask);\n\t\t\telse\n\t\t\t\tscsi_host_set_prot(host,\n\t\t\t\t    prot | SHOST_DIF_TYPE1_PROTECTION\n\t\t\t\t    | SHOST_DIF_TYPE2_PROTECTION\n\t\t\t\t    | SHOST_DIF_TYPE3_PROTECTION\n\t\t\t\t    | SHOST_DIX_TYPE1_PROTECTION\n\t\t\t\t    | SHOST_DIX_TYPE2_PROTECTION\n\t\t\t\t    | SHOST_DIX_TYPE3_PROTECTION);\n\n\t\t\tguard = SHOST_DIX_GUARD_CRC;\n\n\t\t\tif (IS_PI_IPGUARD_CAPABLE(ha) &&\n\t\t\t    (ql2xenabledif > 1 || IS_PI_DIFB_DIX0_CAPABLE(ha)))\n\t\t\t\tguard |= SHOST_DIX_GUARD_IP;\n\n\t\t\tif (ql2xprotguard)\n\t\t\t\tscsi_host_set_guard(host, ql2xprotguard);\n\t\t\telse\n\t\t\t\tscsi_host_set_guard(host, guard);\n\t\t} else\n\t\t\tbase_vha->flags.difdix_supported = 0;\n\t}\n\n\tha->isp_ops->enable_intrs(ha);\n\n\tif (IS_QLAFX00(ha)) {\n\t\tret = qlafx00_fx_disc(base_vha,\n\t\t\t&base_vha->hw->mr.fcport, FXDISC_GET_CONFIG_INFO);\n\t\thost->sg_tablesize = (ha->mr.extended_io_enabled) ?\n\t\t    QLA_SG_ALL : 128;\n\t}\n\n\tret = scsi_add_host(host, &pdev->dev);\n\tif (ret)\n\t\tgoto probe_failed;\n\n\tbase_vha->flags.init_done = 1;\n\tbase_vha->flags.online = 1;\n\tha->prev_minidump_failed = 0;\n\n\tql_dbg(ql_dbg_init, base_vha, 0x00f2,\n\t    \"Init done and hba is online.\\n\");\n\n\tif (qla_ini_mode_enabled(base_vha) ||\n\t\tqla_dual_mode_enabled(base_vha))\n\t\tscsi_scan_host(host);\n\telse\n\t\tql_dbg(ql_dbg_init, base_vha, 0x0122,\n\t\t\t\"skipping scsi_scan_host() for non-initiator port\\n\");\n\n\tqla2x00_alloc_sysfs_attr(base_vha);\n\n\tif (IS_QLAFX00(ha)) {\n\t\tret = qlafx00_fx_disc(base_vha,\n\t\t\t&base_vha->hw->mr.fcport, FXDISC_GET_PORT_INFO);\n\n\t\t/* Register system information */\n\t\tret =  qlafx00_fx_disc(base_vha,\n\t\t\t&base_vha->hw->mr.fcport, FXDISC_REG_HOST_INFO);\n\t}\n\n\tqla2x00_init_host_attr(base_vha);\n\n\tqla2x00_dfs_setup(base_vha);\n\n\tql_log(ql_log_info, base_vha, 0x00fb,\n\t    \"QLogic %s - %s.\\n\", ha->model_number, ha->model_desc);\n\tql_log(ql_log_info, base_vha, 0x00fc,\n\t    \"ISP%04X: %s @ %s hdma%c host#=%ld fw=%s.\\n\",\n\t    pdev->device, ha->isp_ops->pci_info_str(base_vha, pci_info,\n\t\t\t\t\t\t       sizeof(pci_info)),\n\t    pci_name(pdev), ha->flags.enable_64bit_addressing ? '+' : '-',\n\t    base_vha->host_no,\n\t    ha->isp_ops->fw_version_str(base_vha, fw_str, sizeof(fw_str)));\n\n\tqlt_add_target(ha, base_vha);\n\n\tclear_bit(PFLG_DRIVER_PROBING, &base_vha->pci_flags);\n\n\tif (test_bit(UNLOADING, &base_vha->dpc_flags))\n\t\treturn -ENODEV;\n\n\treturn 0;\n\nprobe_failed:\n\tif (base_vha->gnl.l) {\n\t\tdma_free_coherent(&ha->pdev->dev, base_vha->gnl.size,\n\t\t\t\tbase_vha->gnl.l, base_vha->gnl.ldma);\n\t\tbase_vha->gnl.l = NULL;\n\t}\n\n\tif (base_vha->timer_active)\n\t\tqla2x00_stop_timer(base_vha);\n\tbase_vha->flags.online = 0;\n\tif (ha->dpc_thread) {\n\t\tstruct task_struct *t = ha->dpc_thread;\n\n\t\tha->dpc_thread = NULL;\n\t\tkthread_stop(t);\n\t}\n\n\tqla2x00_free_device(base_vha);\n\tscsi_host_put(base_vha->host);\n\t/*\n\t * Need to NULL out local req/rsp after\n\t * qla2x00_free_device => qla2x00_free_queues frees\n\t * what these are pointing to. Or else we'll\n\t * fall over below in qla2x00_free_req/rsp_que.\n\t */\n\treq = NULL;\n\trsp = NULL;\n\nprobe_hw_failed:\n\tqla2x00_mem_free(ha);\n\tqla2x00_free_req_que(ha, req);\n\tqla2x00_free_rsp_que(ha, rsp);\n\tqla2x00_clear_drv_active(ha);\n\niospace_config_failed:\n\tif (IS_P3P_TYPE(ha)) {\n\t\tif (!ha->nx_pcibase)\n\t\t\tiounmap((device_reg_t *)ha->nx_pcibase);\n\t\tif (!ql2xdbwr)\n\t\t\tiounmap((device_reg_t *)ha->nxdb_wr_ptr);\n\t} else {\n\t\tif (ha->iobase)\n\t\t\tiounmap(ha->iobase);\n\t\tif (ha->cregbase)\n\t\t\tiounmap(ha->cregbase);\n\t}\n\tpci_release_selected_regions(ha->pdev, ha->bars);\n\tkfree(ha);\n\ndisable_device:\n\tpci_disable_device(pdev);\n\treturn ret;\n}\n\nstatic void __qla_set_remove_flag(scsi_qla_host_t *base_vha)\n{\n\tscsi_qla_host_t *vp;\n\tunsigned long flags;\n\tstruct qla_hw_data *ha;\n\n\tif (!base_vha)\n\t\treturn;\n\n\tha = base_vha->hw;\n\n\tspin_lock_irqsave(&ha->vport_slock, flags);\n\tlist_for_each_entry(vp, &ha->vp_list, list)\n\t\tset_bit(PFLG_DRIVER_REMOVING, &vp->pci_flags);\n\n\t/*\n\t * Indicate device removal to prevent future board_disable\n\t * and wait until any pending board_disable has completed.\n\t */\n\tset_bit(PFLG_DRIVER_REMOVING, &base_vha->pci_flags);\n\tspin_unlock_irqrestore(&ha->vport_slock, flags);\n}\n\nstatic void\nqla2x00_shutdown(struct pci_dev *pdev)\n{\n\tscsi_qla_host_t *vha;\n\tstruct qla_hw_data  *ha;\n\n\tvha = pci_get_drvdata(pdev);\n\tha = vha->hw;\n\n\tql_log(ql_log_info, vha, 0xfffa,\n\t\t\"Adapter shutdown\\n\");\n\n\t/*\n\t * Prevent future board_disable and wait\n\t * until any pending board_disable has completed.\n\t */\n\t__qla_set_remove_flag(vha);\n\tcancel_work_sync(&ha->board_disable);\n\n\tif (!atomic_read(&pdev->enable_cnt))\n\t\treturn;\n\n\t/* Notify ISPFX00 firmware */\n\tif (IS_QLAFX00(ha))\n\t\tqlafx00_driver_shutdown(vha, 20);\n\n\t/* Turn-off FCE trace */\n\tif (ha->flags.fce_enabled) {\n\t\tqla2x00_disable_fce_trace(vha, NULL, NULL);\n\t\tha->flags.fce_enabled = 0;\n\t}\n\n\t/* Turn-off EFT trace */\n\tif (ha->eft)\n\t\tqla2x00_disable_eft_trace(vha);\n\n\tif (IS_QLA25XX(ha) ||  IS_QLA2031(ha) || IS_QLA27XX(ha) ||\n\t    IS_QLA28XX(ha)) {\n\t\tif (ha->flags.fw_started)\n\t\t\tqla2x00_abort_isp_cleanup(vha);\n\t} else {\n\t\t/* Stop currently executing firmware. */\n\t\tqla2x00_try_to_stop_firmware(vha);\n\t}\n\n\t/* Disable timer */\n\tif (vha->timer_active)\n\t\tqla2x00_stop_timer(vha);\n\n\t/* Turn adapter off line */\n\tvha->flags.online = 0;\n\n\t/* turn-off interrupts on the card */\n\tif (ha->interrupts_on) {\n\t\tvha->flags.init_done = 0;\n\t\tha->isp_ops->disable_intrs(ha);\n\t}\n\n\tqla2x00_free_irqs(vha);\n\n\tqla2x00_free_fw_dump(ha);\n\n\tpci_disable_device(pdev);\n\tql_log(ql_log_info, vha, 0xfffe,\n\t\t\"Adapter shutdown successfully.\\n\");\n}\n\n/* Deletes all the virtual ports for a given ha */\nstatic void\nqla2x00_delete_all_vps(struct qla_hw_data *ha, scsi_qla_host_t *base_vha)\n{\n\tscsi_qla_host_t *vha;\n\tunsigned long flags;\n\n\tmutex_lock(&ha->vport_lock);\n\twhile (ha->cur_vport_count) {\n\t\tspin_lock_irqsave(&ha->vport_slock, flags);\n\n\t\tBUG_ON(base_vha->list.next == &ha->vp_list);\n\t\t/* This assumes first entry in ha->vp_list is always base vha */\n\t\tvha = list_first_entry(&base_vha->list, scsi_qla_host_t, list);\n\t\tscsi_host_get(vha->host);\n\n\t\tspin_unlock_irqrestore(&ha->vport_slock, flags);\n\t\tmutex_unlock(&ha->vport_lock);\n\n\t\tqla_nvme_delete(vha);\n\n\t\tfc_vport_terminate(vha->fc_vport);\n\t\tscsi_host_put(vha->host);\n\n\t\tmutex_lock(&ha->vport_lock);\n\t}\n\tmutex_unlock(&ha->vport_lock);\n}\n\n/* Stops all deferred work threads */\nstatic void\nqla2x00_destroy_deferred_work(struct qla_hw_data *ha)\n{\n\t/* Cancel all work and destroy DPC workqueues */\n\tif (ha->dpc_lp_wq) {\n\t\tcancel_work_sync(&ha->idc_aen);\n\t\tdestroy_workqueue(ha->dpc_lp_wq);\n\t\tha->dpc_lp_wq = NULL;\n\t}\n\n\tif (ha->dpc_hp_wq) {\n\t\tcancel_work_sync(&ha->nic_core_reset);\n\t\tcancel_work_sync(&ha->idc_state_handler);\n\t\tcancel_work_sync(&ha->nic_core_unrecoverable);\n\t\tdestroy_workqueue(ha->dpc_hp_wq);\n\t\tha->dpc_hp_wq = NULL;\n\t}\n\n\t/* Kill the kernel thread for this host */\n\tif (ha->dpc_thread) {\n\t\tstruct task_struct *t = ha->dpc_thread;\n\n\t\t/*\n\t\t * qla2xxx_wake_dpc checks for ->dpc_thread\n\t\t * so we need to zero it out.\n\t\t */\n\t\tha->dpc_thread = NULL;\n\t\tkthread_stop(t);\n\t}\n}\n\nstatic void\nqla2x00_unmap_iobases(struct qla_hw_data *ha)\n{\n\tif (IS_QLA82XX(ha)) {\n\n\t\tiounmap((device_reg_t *)ha->nx_pcibase);\n\t\tif (!ql2xdbwr)\n\t\t\tiounmap((device_reg_t *)ha->nxdb_wr_ptr);\n\t} else {\n\t\tif (ha->iobase)\n\t\t\tiounmap(ha->iobase);\n\n\t\tif (ha->cregbase)\n\t\t\tiounmap(ha->cregbase);\n\n\t\tif (ha->mqiobase)\n\t\t\tiounmap(ha->mqiobase);\n\n\t\tif ((IS_QLA83XX(ha) || IS_QLA27XX(ha) || IS_QLA28XX(ha)) &&\n\t\t    ha->msixbase)\n\t\t\tiounmap(ha->msixbase);\n\t}\n}\n\nstatic void\nqla2x00_clear_drv_active(struct qla_hw_data *ha)\n{\n\tif (IS_QLA8044(ha)) {\n\t\tqla8044_idc_lock(ha);\n\t\tqla8044_clear_drv_active(ha);\n\t\tqla8044_idc_unlock(ha);\n\t} else if (IS_QLA82XX(ha)) {\n\t\tqla82xx_idc_lock(ha);\n\t\tqla82xx_clear_drv_active(ha);\n\t\tqla82xx_idc_unlock(ha);\n\t}\n}\n\nstatic void\nqla2x00_remove_one(struct pci_dev *pdev)\n{\n\tscsi_qla_host_t *base_vha;\n\tstruct qla_hw_data  *ha;\n\n\tbase_vha = pci_get_drvdata(pdev);\n\tha = base_vha->hw;\n\tql_log(ql_log_info, base_vha, 0xb079,\n\t    \"Removing driver\\n\");\n\t__qla_set_remove_flag(base_vha);\n\tcancel_work_sync(&ha->board_disable);\n\n\t/*\n\t * If the PCI device is disabled then there was a PCI-disconnect and\n\t * qla2x00_disable_board_on_pci_error has taken care of most of the\n\t * resources.\n\t */\n\tif (!atomic_read(&pdev->enable_cnt)) {\n\t\tdma_free_coherent(&ha->pdev->dev, base_vha->gnl.size,\n\t\t    base_vha->gnl.l, base_vha->gnl.ldma);\n\t\tbase_vha->gnl.l = NULL;\n\t\tscsi_host_put(base_vha->host);\n\t\tkfree(ha);\n\t\tpci_set_drvdata(pdev, NULL);\n\t\treturn;\n\t}\n\tqla2x00_wait_for_hba_ready(base_vha);\n\n\t/*\n\t * if UNLOADING flag is already set, then continue unload,\n\t * where it was set first.\n\t */\n\tif (test_and_set_bit(UNLOADING, &base_vha->dpc_flags))\n\t\treturn;\n\n\tif (IS_QLA25XX(ha) || IS_QLA2031(ha) || IS_QLA27XX(ha) ||\n\t    IS_QLA28XX(ha)) {\n\t\tif (ha->flags.fw_started)\n\t\t\tqla2x00_abort_isp_cleanup(base_vha);\n\t} else if (!IS_QLAFX00(ha)) {\n\t\tif (IS_QLA8031(ha)) {\n\t\t\tql_dbg(ql_dbg_p3p, base_vha, 0xb07e,\n\t\t\t    \"Clearing fcoe driver presence.\\n\");\n\t\t\tif (qla83xx_clear_drv_presence(base_vha) != QLA_SUCCESS)\n\t\t\t\tql_dbg(ql_dbg_p3p, base_vha, 0xb079,\n\t\t\t\t    \"Error while clearing DRV-Presence.\\n\");\n\t\t}\n\n\t\tqla2x00_try_to_stop_firmware(base_vha);\n\t}\n\n\tqla2x00_wait_for_sess_deletion(base_vha);\n\n\tqla_nvme_delete(base_vha);\n\n\tdma_free_coherent(&ha->pdev->dev,\n\t\tbase_vha->gnl.size, base_vha->gnl.l, base_vha->gnl.ldma);\n\n\tbase_vha->gnl.l = NULL;\n\n\tvfree(base_vha->scan.l);\n\n\tif (IS_QLAFX00(ha))\n\t\tqlafx00_driver_shutdown(base_vha, 20);\n\n\tqla2x00_delete_all_vps(ha, base_vha);\n\n\tqla2x00_dfs_remove(base_vha);\n\n\tqla84xx_put_chip(base_vha);\n\n\t/* Disable timer */\n\tif (base_vha->timer_active)\n\t\tqla2x00_stop_timer(base_vha);\n\n\tbase_vha->flags.online = 0;\n\n\t/* free DMA memory */\n\tif (ha->exlogin_buf)\n\t\tqla2x00_free_exlogin_buffer(ha);\n\n\t/* free DMA memory */\n\tif (ha->exchoffld_buf)\n\t\tqla2x00_free_exchoffld_buffer(ha);\n\n\tqla2x00_destroy_deferred_work(ha);\n\n\tqlt_remove_target(ha, base_vha);\n\n\tqla2x00_free_sysfs_attr(base_vha, true);\n\n\tfc_remove_host(base_vha->host);\n\tqlt_remove_target_resources(ha);\n\n\tscsi_remove_host(base_vha->host);\n\n\tqla2x00_free_device(base_vha);\n\n\tqla2x00_clear_drv_active(ha);\n\n\tscsi_host_put(base_vha->host);\n\n\tqla2x00_unmap_iobases(ha);\n\n\tpci_release_selected_regions(ha->pdev, ha->bars);\n\tkfree(ha);\n\n\tpci_disable_pcie_error_reporting(pdev);\n\n\tpci_disable_device(pdev);\n}\n\nstatic inline void\nqla24xx_free_purex_list(struct purex_list *list)\n{\n\tstruct list_head *item, *next;\n\tulong flags;\n\n\tspin_lock_irqsave(&list->lock, flags);\n\tlist_for_each_safe(item, next, &list->head) {\n\t\tlist_del(item);\n\t\tkfree(list_entry(item, struct purex_item, list));\n\t}\n\tspin_unlock_irqrestore(&list->lock, flags);\n}\n\nstatic void\nqla2x00_free_device(scsi_qla_host_t *vha)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\n\tqla2x00_abort_all_cmds(vha, DID_NO_CONNECT << 16);\n\n\t/* Disable timer */\n\tif (vha->timer_active)\n\t\tqla2x00_stop_timer(vha);\n\n\tqla25xx_delete_queues(vha);\n\tvha->flags.online = 0;\n\n\t/* turn-off interrupts on the card */\n\tif (ha->interrupts_on) {\n\t\tvha->flags.init_done = 0;\n\t\tha->isp_ops->disable_intrs(ha);\n\t}\n\n\tqla2x00_free_fcports(vha);\n\n\tqla2x00_free_irqs(vha);\n\n\t/* Flush the work queue and remove it */\n\tif (ha->wq) {\n\t\tflush_workqueue(ha->wq);\n\t\tdestroy_workqueue(ha->wq);\n\t\tha->wq = NULL;\n\t}\n\n\n\tqla24xx_free_purex_list(&vha->purex_list);\n\n\tqla2x00_mem_free(ha);\n\n\tqla82xx_md_free(vha);\n\n\tqla2x00_free_queues(ha);\n}\n\nvoid qla2x00_free_fcports(struct scsi_qla_host *vha)\n{\n\tfc_port_t *fcport, *tfcport;\n\n\tlist_for_each_entry_safe(fcport, tfcport, &vha->vp_fcports, list)\n\t\tqla2x00_free_fcport(fcport);\n}\n\nstatic inline void\nqla2x00_schedule_rport_del(struct scsi_qla_host *vha, fc_port_t *fcport)\n{\n\tint now;\n\n\tif (!fcport->rport)\n\t\treturn;\n\n\tif (fcport->rport) {\n\t\tql_dbg(ql_dbg_disc, fcport->vha, 0x2109,\n\t\t    \"%s %8phN. rport %p roles %x\\n\",\n\t\t    __func__, fcport->port_name, fcport->rport,\n\t\t    fcport->rport->roles);\n\t\tfc_remote_port_delete(fcport->rport);\n\t}\n\tqlt_do_generation_tick(vha, &now);\n}\n\n/*\n * qla2x00_mark_device_lost Updates fcport state when device goes offline.\n *\n * Input: ha = adapter block pointer.  fcport = port structure pointer.\n *\n * Return: None.\n *\n * Context:\n */\nvoid qla2x00_mark_device_lost(scsi_qla_host_t *vha, fc_port_t *fcport,\n    int do_login)\n{\n\tif (IS_QLAFX00(vha->hw)) {\n\t\tqla2x00_set_fcport_state(fcport, FCS_DEVICE_LOST);\n\t\tqla2x00_schedule_rport_del(vha, fcport);\n\t\treturn;\n\t}\n\n\tif (atomic_read(&fcport->state) == FCS_ONLINE &&\n\t    vha->vp_idx == fcport->vha->vp_idx) {\n\t\tqla2x00_set_fcport_state(fcport, FCS_DEVICE_LOST);\n\t\tqla2x00_schedule_rport_del(vha, fcport);\n\t}\n\t/*\n\t * We may need to retry the login, so don't change the state of the\n\t * port but do the retries.\n\t */\n\tif (atomic_read(&fcport->state) != FCS_DEVICE_DEAD)\n\t\tqla2x00_set_fcport_state(fcport, FCS_DEVICE_LOST);\n\n\tif (!do_login)\n\t\treturn;\n\n\tset_bit(RELOGIN_NEEDED, &vha->dpc_flags);\n}\n\nvoid\nqla2x00_mark_all_devices_lost(scsi_qla_host_t *vha)\n{\n\tfc_port_t *fcport;\n\n\tql_dbg(ql_dbg_disc, vha, 0x20f1,\n\t    \"Mark all dev lost\\n\");\n\n\tlist_for_each_entry(fcport, &vha->vp_fcports, list) {\n\t\tfcport->scan_state = 0;\n\t\tqlt_schedule_sess_for_deletion(fcport);\n\t}\n}\n\nstatic void qla2x00_set_reserved_loop_ids(struct qla_hw_data *ha)\n{\n\tint i;\n\n\tif (IS_FWI2_CAPABLE(ha))\n\t\treturn;\n\n\tfor (i = 0; i < SNS_FIRST_LOOP_ID; i++)\n\t\tset_bit(i, ha->loop_id_map);\n\tset_bit(MANAGEMENT_SERVER, ha->loop_id_map);\n\tset_bit(BROADCAST, ha->loop_id_map);\n}\n\n/*\n* qla2x00_mem_alloc\n*      Allocates adapter memory.\n*\n* Returns:\n*      0  = success.\n*      !0  = failure.\n*/\nstatic int\nqla2x00_mem_alloc(struct qla_hw_data *ha, uint16_t req_len, uint16_t rsp_len,\n\tstruct req_que **req, struct rsp_que **rsp)\n{\n\tchar\tname[16];\n\n\tha->init_cb = dma_alloc_coherent(&ha->pdev->dev, ha->init_cb_size,\n\t\t&ha->init_cb_dma, GFP_KERNEL);\n\tif (!ha->init_cb)\n\t\tgoto fail;\n\n\tif (qlt_mem_alloc(ha) < 0)\n\t\tgoto fail_free_init_cb;\n\n\tha->gid_list = dma_alloc_coherent(&ha->pdev->dev,\n\t\tqla2x00_gid_list_size(ha), &ha->gid_list_dma, GFP_KERNEL);\n\tif (!ha->gid_list)\n\t\tgoto fail_free_tgt_mem;\n\n\tha->srb_mempool = mempool_create_slab_pool(SRB_MIN_REQ, srb_cachep);\n\tif (!ha->srb_mempool)\n\t\tgoto fail_free_gid_list;\n\n\tif (IS_P3P_TYPE(ha)) {\n\t\t/* Allocate cache for CT6 Ctx. */\n\t\tif (!ctx_cachep) {\n\t\t\tctx_cachep = kmem_cache_create(\"qla2xxx_ctx\",\n\t\t\t\tsizeof(struct ct6_dsd), 0,\n\t\t\t\tSLAB_HWCACHE_ALIGN, NULL);\n\t\t\tif (!ctx_cachep)\n\t\t\t\tgoto fail_free_srb_mempool;\n\t\t}\n\t\tha->ctx_mempool = mempool_create_slab_pool(SRB_MIN_REQ,\n\t\t\tctx_cachep);\n\t\tif (!ha->ctx_mempool)\n\t\t\tgoto fail_free_srb_mempool;\n\t\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x0021,\n\t\t    \"ctx_cachep=%p ctx_mempool=%p.\\n\",\n\t\t    ctx_cachep, ha->ctx_mempool);\n\t}\n\n\t/* Get memory for cached NVRAM */\n\tha->nvram = kzalloc(MAX_NVRAM_SIZE, GFP_KERNEL);\n\tif (!ha->nvram)\n\t\tgoto fail_free_ctx_mempool;\n\n\tsnprintf(name, sizeof(name), \"%s_%d\", QLA2XXX_DRIVER_NAME,\n\t\tha->pdev->device);\n\tha->s_dma_pool = dma_pool_create(name, &ha->pdev->dev,\n\t\tDMA_POOL_SIZE, 8, 0);\n\tif (!ha->s_dma_pool)\n\t\tgoto fail_free_nvram;\n\n\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x0022,\n\t    \"init_cb=%p gid_list=%p, srb_mempool=%p s_dma_pool=%p.\\n\",\n\t    ha->init_cb, ha->gid_list, ha->srb_mempool, ha->s_dma_pool);\n\n\tif (IS_P3P_TYPE(ha) || ql2xenabledif) {\n\t\tha->dl_dma_pool = dma_pool_create(name, &ha->pdev->dev,\n\t\t\tDSD_LIST_DMA_POOL_SIZE, 8, 0);\n\t\tif (!ha->dl_dma_pool) {\n\t\t\tql_log_pci(ql_log_fatal, ha->pdev, 0x0023,\n\t\t\t    \"Failed to allocate memory for dl_dma_pool.\\n\");\n\t\t\tgoto fail_s_dma_pool;\n\t\t}\n\n\t\tha->fcp_cmnd_dma_pool = dma_pool_create(name, &ha->pdev->dev,\n\t\t\tFCP_CMND_DMA_POOL_SIZE, 8, 0);\n\t\tif (!ha->fcp_cmnd_dma_pool) {\n\t\t\tql_log_pci(ql_log_fatal, ha->pdev, 0x0024,\n\t\t\t    \"Failed to allocate memory for fcp_cmnd_dma_pool.\\n\");\n\t\t\tgoto fail_dl_dma_pool;\n\t\t}\n\n\t\tif (ql2xenabledif) {\n\t\t\tu64 bufsize = DIF_BUNDLING_DMA_POOL_SIZE;\n\t\t\tstruct dsd_dma *dsd, *nxt;\n\t\t\tuint i;\n\t\t\t/* Creata a DMA pool of buffers for DIF bundling */\n\t\t\tha->dif_bundl_pool = dma_pool_create(name,\n\t\t\t    &ha->pdev->dev, DIF_BUNDLING_DMA_POOL_SIZE, 8, 0);\n\t\t\tif (!ha->dif_bundl_pool) {\n\t\t\t\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x0024,\n\t\t\t\t    \"%s: failed create dif_bundl_pool\\n\",\n\t\t\t\t    __func__);\n\t\t\t\tgoto fail_dif_bundl_dma_pool;\n\t\t\t}\n\n\t\t\tINIT_LIST_HEAD(&ha->pool.good.head);\n\t\t\tINIT_LIST_HEAD(&ha->pool.unusable.head);\n\t\t\tha->pool.good.count = 0;\n\t\t\tha->pool.unusable.count = 0;\n\t\t\tfor (i = 0; i < 128; i++) {\n\t\t\t\tdsd = kzalloc(sizeof(*dsd), GFP_ATOMIC);\n\t\t\t\tif (!dsd) {\n\t\t\t\t\tql_dbg_pci(ql_dbg_init, ha->pdev,\n\t\t\t\t\t    0xe0ee, \"%s: failed alloc dsd\\n\",\n\t\t\t\t\t    __func__);\n\t\t\t\t\treturn 1;\n\t\t\t\t}\n\t\t\t\tha->dif_bundle_kallocs++;\n\n\t\t\t\tdsd->dsd_addr = dma_pool_alloc(\n\t\t\t\t    ha->dif_bundl_pool, GFP_ATOMIC,\n\t\t\t\t    &dsd->dsd_list_dma);\n\t\t\t\tif (!dsd->dsd_addr) {\n\t\t\t\t\tql_dbg_pci(ql_dbg_init, ha->pdev,\n\t\t\t\t\t    0xe0ee,\n\t\t\t\t\t    \"%s: failed alloc ->dsd_addr\\n\",\n\t\t\t\t\t    __func__);\n\t\t\t\t\tkfree(dsd);\n\t\t\t\t\tha->dif_bundle_kallocs--;\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tha->dif_bundle_dma_allocs++;\n\n\t\t\t\t/*\n\t\t\t\t * if DMA buffer crosses 4G boundary,\n\t\t\t\t * put it on bad list\n\t\t\t\t */\n\t\t\t\tif (MSD(dsd->dsd_list_dma) ^\n\t\t\t\t    MSD(dsd->dsd_list_dma + bufsize)) {\n\t\t\t\t\tlist_add_tail(&dsd->list,\n\t\t\t\t\t    &ha->pool.unusable.head);\n\t\t\t\t\tha->pool.unusable.count++;\n\t\t\t\t} else {\n\t\t\t\t\tlist_add_tail(&dsd->list,\n\t\t\t\t\t    &ha->pool.good.head);\n\t\t\t\t\tha->pool.good.count++;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t/* return the good ones back to the pool */\n\t\t\tlist_for_each_entry_safe(dsd, nxt,\n\t\t\t    &ha->pool.good.head, list) {\n\t\t\t\tlist_del(&dsd->list);\n\t\t\t\tdma_pool_free(ha->dif_bundl_pool,\n\t\t\t\t    dsd->dsd_addr, dsd->dsd_list_dma);\n\t\t\t\tha->dif_bundle_dma_allocs--;\n\t\t\t\tkfree(dsd);\n\t\t\t\tha->dif_bundle_kallocs--;\n\t\t\t}\n\n\t\t\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x0024,\n\t\t\t    \"%s: dif dma pool (good=%u unusable=%u)\\n\",\n\t\t\t    __func__, ha->pool.good.count,\n\t\t\t    ha->pool.unusable.count);\n\t\t}\n\n\t\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x0025,\n\t\t    \"dl_dma_pool=%p fcp_cmnd_dma_pool=%p dif_bundl_pool=%p.\\n\",\n\t\t    ha->dl_dma_pool, ha->fcp_cmnd_dma_pool,\n\t\t    ha->dif_bundl_pool);\n\t}\n\n\t/* Allocate memory for SNS commands */\n\tif (IS_QLA2100(ha) || IS_QLA2200(ha)) {\n\t/* Get consistent memory allocated for SNS commands */\n\t\tha->sns_cmd = dma_alloc_coherent(&ha->pdev->dev,\n\t\tsizeof(struct sns_cmd_pkt), &ha->sns_cmd_dma, GFP_KERNEL);\n\t\tif (!ha->sns_cmd)\n\t\t\tgoto fail_dma_pool;\n\t\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x0026,\n\t\t    \"sns_cmd: %p.\\n\", ha->sns_cmd);\n\t} else {\n\t/* Get consistent memory allocated for MS IOCB */\n\t\tha->ms_iocb = dma_pool_alloc(ha->s_dma_pool, GFP_KERNEL,\n\t\t\t&ha->ms_iocb_dma);\n\t\tif (!ha->ms_iocb)\n\t\t\tgoto fail_dma_pool;\n\t/* Get consistent memory allocated for CT SNS commands */\n\t\tha->ct_sns = dma_alloc_coherent(&ha->pdev->dev,\n\t\t\tsizeof(struct ct_sns_pkt), &ha->ct_sns_dma, GFP_KERNEL);\n\t\tif (!ha->ct_sns)\n\t\t\tgoto fail_free_ms_iocb;\n\t\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x0027,\n\t\t    \"ms_iocb=%p ct_sns=%p.\\n\",\n\t\t    ha->ms_iocb, ha->ct_sns);\n\t}\n\n\t/* Allocate memory for request ring */\n\t*req = kzalloc(sizeof(struct req_que), GFP_KERNEL);\n\tif (!*req) {\n\t\tql_log_pci(ql_log_fatal, ha->pdev, 0x0028,\n\t\t    \"Failed to allocate memory for req.\\n\");\n\t\tgoto fail_req;\n\t}\n\t(*req)->length = req_len;\n\t(*req)->ring = dma_alloc_coherent(&ha->pdev->dev,\n\t\t((*req)->length + 1) * sizeof(request_t),\n\t\t&(*req)->dma, GFP_KERNEL);\n\tif (!(*req)->ring) {\n\t\tql_log_pci(ql_log_fatal, ha->pdev, 0x0029,\n\t\t    \"Failed to allocate memory for req_ring.\\n\");\n\t\tgoto fail_req_ring;\n\t}\n\t/* Allocate memory for response ring */\n\t*rsp = kzalloc(sizeof(struct rsp_que), GFP_KERNEL);\n\tif (!*rsp) {\n\t\tql_log_pci(ql_log_fatal, ha->pdev, 0x002a,\n\t\t    \"Failed to allocate memory for rsp.\\n\");\n\t\tgoto fail_rsp;\n\t}\n\t(*rsp)->hw = ha;\n\t(*rsp)->length = rsp_len;\n\t(*rsp)->ring = dma_alloc_coherent(&ha->pdev->dev,\n\t\t((*rsp)->length + 1) * sizeof(response_t),\n\t\t&(*rsp)->dma, GFP_KERNEL);\n\tif (!(*rsp)->ring) {\n\t\tql_log_pci(ql_log_fatal, ha->pdev, 0x002b,\n\t\t    \"Failed to allocate memory for rsp_ring.\\n\");\n\t\tgoto fail_rsp_ring;\n\t}\n\t(*req)->rsp = *rsp;\n\t(*rsp)->req = *req;\n\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x002c,\n\t    \"req=%p req->length=%d req->ring=%p rsp=%p \"\n\t    \"rsp->length=%d rsp->ring=%p.\\n\",\n\t    *req, (*req)->length, (*req)->ring, *rsp, (*rsp)->length,\n\t    (*rsp)->ring);\n\t/* Allocate memory for NVRAM data for vports */\n\tif (ha->nvram_npiv_size) {\n\t\tha->npiv_info = kcalloc(ha->nvram_npiv_size,\n\t\t\t\t\tsizeof(struct qla_npiv_entry),\n\t\t\t\t\tGFP_KERNEL);\n\t\tif (!ha->npiv_info) {\n\t\t\tql_log_pci(ql_log_fatal, ha->pdev, 0x002d,\n\t\t\t    \"Failed to allocate memory for npiv_info.\\n\");\n\t\t\tgoto fail_npiv_info;\n\t\t}\n\t} else\n\t\tha->npiv_info = NULL;\n\n\t/* Get consistent memory allocated for EX-INIT-CB. */\n\tif (IS_CNA_CAPABLE(ha) || IS_QLA2031(ha) || IS_QLA27XX(ha) ||\n\t    IS_QLA28XX(ha)) {\n\t\tha->ex_init_cb = dma_pool_alloc(ha->s_dma_pool, GFP_KERNEL,\n\t\t    &ha->ex_init_cb_dma);\n\t\tif (!ha->ex_init_cb)\n\t\t\tgoto fail_ex_init_cb;\n\t\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x002e,\n\t\t    \"ex_init_cb=%p.\\n\", ha->ex_init_cb);\n\t}\n\n\t/* Get consistent memory allocated for Special Features-CB. */\n\tif (IS_QLA27XX(ha) || IS_QLA28XX(ha)) {\n\t\tha->sf_init_cb = dma_pool_alloc(ha->s_dma_pool, GFP_KERNEL,\n\t\t\t\t\t\t&ha->sf_init_cb_dma);\n\t\tif (!ha->sf_init_cb)\n\t\t\tgoto fail_sf_init_cb;\n\t\tmemset(ha->sf_init_cb, 0, sizeof(struct init_sf_cb));\n\t\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x0199,\n\t\t\t   \"sf_init_cb=%p.\\n\", ha->sf_init_cb);\n\t}\n\n\tINIT_LIST_HEAD(&ha->gbl_dsd_list);\n\n\t/* Get consistent memory allocated for Async Port-Database. */\n\tif (!IS_FWI2_CAPABLE(ha)) {\n\t\tha->async_pd = dma_pool_alloc(ha->s_dma_pool, GFP_KERNEL,\n\t\t\t&ha->async_pd_dma);\n\t\tif (!ha->async_pd)\n\t\t\tgoto fail_async_pd;\n\t\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x002f,\n\t\t    \"async_pd=%p.\\n\", ha->async_pd);\n\t}\n\n\tINIT_LIST_HEAD(&ha->vp_list);\n\n\t/* Allocate memory for our loop_id bitmap */\n\tha->loop_id_map = kcalloc(BITS_TO_LONGS(LOOPID_MAP_SIZE),\n\t\t\t\t  sizeof(long),\n\t\t\t\t  GFP_KERNEL);\n\tif (!ha->loop_id_map)\n\t\tgoto fail_loop_id_map;\n\telse {\n\t\tqla2x00_set_reserved_loop_ids(ha);\n\t\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x0123,\n\t\t    \"loop_id_map=%p.\\n\", ha->loop_id_map);\n\t}\n\n\tha->sfp_data = dma_alloc_coherent(&ha->pdev->dev,\n\t    SFP_DEV_SIZE, &ha->sfp_data_dma, GFP_KERNEL);\n\tif (!ha->sfp_data) {\n\t\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x011b,\n\t\t    \"Unable to allocate memory for SFP read-data.\\n\");\n\t\tgoto fail_sfp_data;\n\t}\n\n\tha->flt = dma_alloc_coherent(&ha->pdev->dev,\n\t    sizeof(struct qla_flt_header) + FLT_REGIONS_SIZE, &ha->flt_dma,\n\t    GFP_KERNEL);\n\tif (!ha->flt) {\n\t\tql_dbg_pci(ql_dbg_init, ha->pdev, 0x011b,\n\t\t    \"Unable to allocate memory for FLT.\\n\");\n\t\tgoto fail_flt_buffer;\n\t}\n\n\treturn 0;\n\nfail_flt_buffer:\n\tdma_free_coherent(&ha->pdev->dev, SFP_DEV_SIZE,\n\t    ha->sfp_data, ha->sfp_data_dma);\nfail_sfp_data:\n\tkfree(ha->loop_id_map);\nfail_loop_id_map:\n\tdma_pool_free(ha->s_dma_pool, ha->async_pd, ha->async_pd_dma);\nfail_async_pd:\n\tdma_pool_free(ha->s_dma_pool, ha->sf_init_cb, ha->sf_init_cb_dma);\nfail_sf_init_cb:\n\tdma_pool_free(ha->s_dma_pool, ha->ex_init_cb, ha->ex_init_cb_dma);\nfail_ex_init_cb:\n\tkfree(ha->npiv_info);\nfail_npiv_info:\n\tdma_free_coherent(&ha->pdev->dev, ((*rsp)->length + 1) *\n\t\tsizeof(response_t), (*rsp)->ring, (*rsp)->dma);\n\t(*rsp)->ring = NULL;\n\t(*rsp)->dma = 0;\nfail_rsp_ring:\n\tkfree(*rsp);\n\t*rsp = NULL;\nfail_rsp:\n\tdma_free_coherent(&ha->pdev->dev, ((*req)->length + 1) *\n\t\tsizeof(request_t), (*req)->ring, (*req)->dma);\n\t(*req)->ring = NULL;\n\t(*req)->dma = 0;\nfail_req_ring:\n\tkfree(*req);\n\t*req = NULL;\nfail_req:\n\tdma_free_coherent(&ha->pdev->dev, sizeof(struct ct_sns_pkt),\n\t\tha->ct_sns, ha->ct_sns_dma);\n\tha->ct_sns = NULL;\n\tha->ct_sns_dma = 0;\nfail_free_ms_iocb:\n\tdma_pool_free(ha->s_dma_pool, ha->ms_iocb, ha->ms_iocb_dma);\n\tha->ms_iocb = NULL;\n\tha->ms_iocb_dma = 0;\n\n\tif (ha->sns_cmd)\n\t\tdma_free_coherent(&ha->pdev->dev, sizeof(struct sns_cmd_pkt),\n\t\t    ha->sns_cmd, ha->sns_cmd_dma);\nfail_dma_pool:\n\tif (ql2xenabledif) {\n\t\tstruct dsd_dma *dsd, *nxt;\n\n\t\tlist_for_each_entry_safe(dsd, nxt, &ha->pool.unusable.head,\n\t\t    list) {\n\t\t\tlist_del(&dsd->list);\n\t\t\tdma_pool_free(ha->dif_bundl_pool, dsd->dsd_addr,\n\t\t\t    dsd->dsd_list_dma);\n\t\t\tha->dif_bundle_dma_allocs--;\n\t\t\tkfree(dsd);\n\t\t\tha->dif_bundle_kallocs--;\n\t\t\tha->pool.unusable.count--;\n\t\t}\n\t\tdma_pool_destroy(ha->dif_bundl_pool);\n\t\tha->dif_bundl_pool = NULL;\n\t}\n\nfail_dif_bundl_dma_pool:\n\tif (IS_QLA82XX(ha) || ql2xenabledif) {\n\t\tdma_pool_destroy(ha->fcp_cmnd_dma_pool);\n\t\tha->fcp_cmnd_dma_pool = NULL;\n\t}\nfail_dl_dma_pool:\n\tif (IS_QLA82XX(ha) || ql2xenabledif) {\n\t\tdma_pool_destroy(ha->dl_dma_pool);\n\t\tha->dl_dma_pool = NULL;\n\t}\nfail_s_dma_pool:\n\tdma_pool_destroy(ha->s_dma_pool);\n\tha->s_dma_pool = NULL;\nfail_free_nvram:\n\tkfree(ha->nvram);\n\tha->nvram = NULL;\nfail_free_ctx_mempool:\n\tmempool_destroy(ha->ctx_mempool);\n\tha->ctx_mempool = NULL;\nfail_free_srb_mempool:\n\tmempool_destroy(ha->srb_mempool);\n\tha->srb_mempool = NULL;\nfail_free_gid_list:\n\tdma_free_coherent(&ha->pdev->dev, qla2x00_gid_list_size(ha),\n\tha->gid_list,\n\tha->gid_list_dma);\n\tha->gid_list = NULL;\n\tha->gid_list_dma = 0;\nfail_free_tgt_mem:\n\tqlt_mem_free(ha);\nfail_free_init_cb:\n\tdma_free_coherent(&ha->pdev->dev, ha->init_cb_size, ha->init_cb,\n\tha->init_cb_dma);\n\tha->init_cb = NULL;\n\tha->init_cb_dma = 0;\nfail:\n\tql_log(ql_log_fatal, NULL, 0x0030,\n\t    \"Memory allocation failure.\\n\");\n\treturn -ENOMEM;\n}\n\nint\nqla2x00_set_exlogins_buffer(scsi_qla_host_t *vha)\n{\n\tint rval;\n\tuint16_t\tsize, max_cnt;\n\tuint32_t temp;\n\tstruct qla_hw_data *ha = vha->hw;\n\n\t/* Return if we don't need to alloacate any extended logins */\n\tif (ql2xexlogins <= MAX_FIBRE_DEVICES_2400)\n\t\treturn QLA_SUCCESS;\n\n\tif (!IS_EXLOGIN_OFFLD_CAPABLE(ha))\n\t\treturn QLA_SUCCESS;\n\n\tql_log(ql_log_info, vha, 0xd021, \"EXLOGIN count: %d.\\n\", ql2xexlogins);\n\tmax_cnt = 0;\n\trval = qla_get_exlogin_status(vha, &size, &max_cnt);\n\tif (rval != QLA_SUCCESS) {\n\t\tql_log_pci(ql_log_fatal, ha->pdev, 0xd029,\n\t\t    \"Failed to get exlogin status.\\n\");\n\t\treturn rval;\n\t}\n\n\ttemp = (ql2xexlogins > max_cnt) ? max_cnt : ql2xexlogins;\n\ttemp *= size;\n\n\tif (temp != ha->exlogin_size) {\n\t\tqla2x00_free_exlogin_buffer(ha);\n\t\tha->exlogin_size = temp;\n\n\t\tql_log(ql_log_info, vha, 0xd024,\n\t\t    \"EXLOGIN: max_logins=%d, portdb=0x%x, total=%d.\\n\",\n\t\t    max_cnt, size, temp);\n\n\t\tql_log(ql_log_info, vha, 0xd025,\n\t\t    \"EXLOGIN: requested size=0x%x\\n\", ha->exlogin_size);\n\n\t\t/* Get consistent memory for extended logins */\n\t\tha->exlogin_buf = dma_alloc_coherent(&ha->pdev->dev,\n\t\t\tha->exlogin_size, &ha->exlogin_buf_dma, GFP_KERNEL);\n\t\tif (!ha->exlogin_buf) {\n\t\t\tql_log_pci(ql_log_fatal, ha->pdev, 0xd02a,\n\t\t    \"Failed to allocate memory for exlogin_buf_dma.\\n\");\n\t\t\treturn -ENOMEM;\n\t\t}\n\t}\n\n\t/* Now configure the dma buffer */\n\trval = qla_set_exlogin_mem_cfg(vha, ha->exlogin_buf_dma);\n\tif (rval) {\n\t\tql_log(ql_log_fatal, vha, 0xd033,\n\t\t    \"Setup extended login buffer  ****FAILED****.\\n\");\n\t\tqla2x00_free_exlogin_buffer(ha);\n\t}\n\n\treturn rval;\n}\n\n/*\n* qla2x00_free_exlogin_buffer\n*\n* Input:\n*\tha = adapter block pointer\n*/\nvoid\nqla2x00_free_exlogin_buffer(struct qla_hw_data *ha)\n{\n\tif (ha->exlogin_buf) {\n\t\tdma_free_coherent(&ha->pdev->dev, ha->exlogin_size,\n\t\t    ha->exlogin_buf, ha->exlogin_buf_dma);\n\t\tha->exlogin_buf = NULL;\n\t\tha->exlogin_size = 0;\n\t}\n}\n\nstatic void\nqla2x00_number_of_exch(scsi_qla_host_t *vha, u32 *ret_cnt, u16 max_cnt)\n{\n\tu32 temp;\n\tstruct init_cb_81xx *icb = (struct init_cb_81xx *)&vha->hw->init_cb;\n\t*ret_cnt = FW_DEF_EXCHANGES_CNT;\n\n\tif (max_cnt > vha->hw->max_exchg)\n\t\tmax_cnt = vha->hw->max_exchg;\n\n\tif (qla_ini_mode_enabled(vha)) {\n\t\tif (vha->ql2xiniexchg > max_cnt)\n\t\t\tvha->ql2xiniexchg = max_cnt;\n\n\t\tif (vha->ql2xiniexchg > FW_DEF_EXCHANGES_CNT)\n\t\t\t*ret_cnt = vha->ql2xiniexchg;\n\n\t} else if (qla_tgt_mode_enabled(vha)) {\n\t\tif (vha->ql2xexchoffld > max_cnt) {\n\t\t\tvha->ql2xexchoffld = max_cnt;\n\t\t\ticb->exchange_count = cpu_to_le16(vha->ql2xexchoffld);\n\t\t}\n\n\t\tif (vha->ql2xexchoffld > FW_DEF_EXCHANGES_CNT)\n\t\t\t*ret_cnt = vha->ql2xexchoffld;\n\t} else if (qla_dual_mode_enabled(vha)) {\n\t\ttemp = vha->ql2xiniexchg + vha->ql2xexchoffld;\n\t\tif (temp > max_cnt) {\n\t\t\tvha->ql2xiniexchg -= (temp - max_cnt)/2;\n\t\t\tvha->ql2xexchoffld -= (((temp - max_cnt)/2) + 1);\n\t\t\ttemp = max_cnt;\n\t\t\ticb->exchange_count = cpu_to_le16(vha->ql2xexchoffld);\n\t\t}\n\n\t\tif (temp > FW_DEF_EXCHANGES_CNT)\n\t\t\t*ret_cnt = temp;\n\t}\n}\n\nint\nqla2x00_set_exchoffld_buffer(scsi_qla_host_t *vha)\n{\n\tint rval;\n\tu16\tsize, max_cnt;\n\tu32 actual_cnt, totsz;\n\tstruct qla_hw_data *ha = vha->hw;\n\n\tif (!ha->flags.exchoffld_enabled)\n\t\treturn QLA_SUCCESS;\n\n\tif (!IS_EXCHG_OFFLD_CAPABLE(ha))\n\t\treturn QLA_SUCCESS;\n\n\tmax_cnt = 0;\n\trval = qla_get_exchoffld_status(vha, &size, &max_cnt);\n\tif (rval != QLA_SUCCESS) {\n\t\tql_log_pci(ql_log_fatal, ha->pdev, 0xd012,\n\t\t    \"Failed to get exlogin status.\\n\");\n\t\treturn rval;\n\t}\n\n\tqla2x00_number_of_exch(vha, &actual_cnt, max_cnt);\n\tql_log(ql_log_info, vha, 0xd014,\n\t    \"Actual exchange offload count: %d.\\n\", actual_cnt);\n\n\ttotsz = actual_cnt * size;\n\n\tif (totsz != ha->exchoffld_size) {\n\t\tqla2x00_free_exchoffld_buffer(ha);\n\t\tif (actual_cnt <= FW_DEF_EXCHANGES_CNT) {\n\t\t\tha->exchoffld_size = 0;\n\t\t\tha->flags.exchoffld_enabled = 0;\n\t\t\treturn QLA_SUCCESS;\n\t\t}\n\n\t\tha->exchoffld_size = totsz;\n\n\t\tql_log(ql_log_info, vha, 0xd016,\n\t\t    \"Exchange offload: max_count=%d, actual count=%d entry sz=0x%x, total sz=0x%x\\n\",\n\t\t    max_cnt, actual_cnt, size, totsz);\n\n\t\tql_log(ql_log_info, vha, 0xd017,\n\t\t    \"Exchange Buffers requested size = 0x%x\\n\",\n\t\t    ha->exchoffld_size);\n\n\t\t/* Get consistent memory for extended logins */\n\t\tha->exchoffld_buf = dma_alloc_coherent(&ha->pdev->dev,\n\t\t\tha->exchoffld_size, &ha->exchoffld_buf_dma, GFP_KERNEL);\n\t\tif (!ha->exchoffld_buf) {\n\t\t\tql_log_pci(ql_log_fatal, ha->pdev, 0xd013,\n\t\t\t\"Failed to allocate memory for Exchange Offload.\\n\");\n\n\t\t\tif (ha->max_exchg >\n\t\t\t    (FW_DEF_EXCHANGES_CNT + REDUCE_EXCHANGES_CNT)) {\n\t\t\t\tha->max_exchg -= REDUCE_EXCHANGES_CNT;\n\t\t\t} else if (ha->max_exchg >\n\t\t\t    (FW_DEF_EXCHANGES_CNT + 512)) {\n\t\t\t\tha->max_exchg -= 512;\n\t\t\t} else {\n\t\t\t\tha->flags.exchoffld_enabled = 0;\n\t\t\t\tql_log_pci(ql_log_fatal, ha->pdev, 0xd013,\n\t\t\t\t    \"Disabling Exchange offload due to lack of memory\\n\");\n\t\t\t}\n\t\t\tha->exchoffld_size = 0;\n\n\t\t\treturn -ENOMEM;\n\t\t}\n\t} else if (!ha->exchoffld_buf || (actual_cnt <= FW_DEF_EXCHANGES_CNT)) {\n\t\t/* pathological case */\n\t\tqla2x00_free_exchoffld_buffer(ha);\n\t\tha->exchoffld_size = 0;\n\t\tha->flags.exchoffld_enabled = 0;\n\t\tql_log(ql_log_info, vha, 0xd016,\n\t\t    \"Exchange offload not enable: offld size=%d, actual count=%d entry sz=0x%x, total sz=0x%x.\\n\",\n\t\t    ha->exchoffld_size, actual_cnt, size, totsz);\n\t\treturn 0;\n\t}\n\n\t/* Now configure the dma buffer */\n\trval = qla_set_exchoffld_mem_cfg(vha);\n\tif (rval) {\n\t\tql_log(ql_log_fatal, vha, 0xd02e,\n\t\t    \"Setup exchange offload buffer ****FAILED****.\\n\");\n\t\tqla2x00_free_exchoffld_buffer(ha);\n\t} else {\n\t\t/* re-adjust number of target exchange */\n\t\tstruct init_cb_81xx *icb = (struct init_cb_81xx *)ha->init_cb;\n\n\t\tif (qla_ini_mode_enabled(vha))\n\t\t\ticb->exchange_count = 0;\n\t\telse\n\t\t\ticb->exchange_count = cpu_to_le16(vha->ql2xexchoffld);\n\t}\n\n\treturn rval;\n}\n\n/*\n* qla2x00_free_exchoffld_buffer\n*\n* Input:\n*\tha = adapter block pointer\n*/\nvoid\nqla2x00_free_exchoffld_buffer(struct qla_hw_data *ha)\n{\n\tif (ha->exchoffld_buf) {\n\t\tdma_free_coherent(&ha->pdev->dev, ha->exchoffld_size,\n\t\t    ha->exchoffld_buf, ha->exchoffld_buf_dma);\n\t\tha->exchoffld_buf = NULL;\n\t\tha->exchoffld_size = 0;\n\t}\n}\n\n/*\n* qla2x00_free_fw_dump\n*\tFrees fw dump stuff.\n*\n* Input:\n*\tha = adapter block pointer\n*/\nstatic void\nqla2x00_free_fw_dump(struct qla_hw_data *ha)\n{\n\tstruct fwdt *fwdt = ha->fwdt;\n\tuint j;\n\n\tif (ha->fce)\n\t\tdma_free_coherent(&ha->pdev->dev,\n\t\t    FCE_SIZE, ha->fce, ha->fce_dma);\n\n\tif (ha->eft)\n\t\tdma_free_coherent(&ha->pdev->dev,\n\t\t    EFT_SIZE, ha->eft, ha->eft_dma);\n\n\tif (ha->fw_dump)\n\t\tvfree(ha->fw_dump);\n\n\tha->fce = NULL;\n\tha->fce_dma = 0;\n\tha->flags.fce_enabled = 0;\n\tha->eft = NULL;\n\tha->eft_dma = 0;\n\tha->fw_dumped = false;\n\tha->fw_dump_cap_flags = 0;\n\tha->fw_dump_reading = 0;\n\tha->fw_dump = NULL;\n\tha->fw_dump_len = 0;\n\n\tfor (j = 0; j < 2; j++, fwdt++) {\n\t\tif (fwdt->template)\n\t\t\tvfree(fwdt->template);\n\t\tfwdt->template = NULL;\n\t\tfwdt->length = 0;\n\t}\n}\n\n/*\n* qla2x00_mem_free\n*      Frees all adapter allocated memory.\n*\n* Input:\n*      ha = adapter block pointer.\n*/\nstatic void\nqla2x00_mem_free(struct qla_hw_data *ha)\n{\n\tqla2x00_free_fw_dump(ha);\n\n\tif (ha->mctp_dump)\n\t\tdma_free_coherent(&ha->pdev->dev, MCTP_DUMP_SIZE, ha->mctp_dump,\n\t\t    ha->mctp_dump_dma);\n\tha->mctp_dump = NULL;\n\n\tmempool_destroy(ha->srb_mempool);\n\tha->srb_mempool = NULL;\n\n\tif (ha->dcbx_tlv)\n\t\tdma_free_coherent(&ha->pdev->dev, DCBX_TLV_DATA_SIZE,\n\t\t    ha->dcbx_tlv, ha->dcbx_tlv_dma);\n\tha->dcbx_tlv = NULL;\n\n\tif (ha->xgmac_data)\n\t\tdma_free_coherent(&ha->pdev->dev, XGMAC_DATA_SIZE,\n\t\t    ha->xgmac_data, ha->xgmac_data_dma);\n\tha->xgmac_data = NULL;\n\n\tif (ha->sns_cmd)\n\t\tdma_free_coherent(&ha->pdev->dev, sizeof(struct sns_cmd_pkt),\n\t\tha->sns_cmd, ha->sns_cmd_dma);\n\tha->sns_cmd = NULL;\n\tha->sns_cmd_dma = 0;\n\n\tif (ha->ct_sns)\n\t\tdma_free_coherent(&ha->pdev->dev, sizeof(struct ct_sns_pkt),\n\t\tha->ct_sns, ha->ct_sns_dma);\n\tha->ct_sns = NULL;\n\tha->ct_sns_dma = 0;\n\n\tif (ha->sfp_data)\n\t\tdma_free_coherent(&ha->pdev->dev, SFP_DEV_SIZE, ha->sfp_data,\n\t\t    ha->sfp_data_dma);\n\tha->sfp_data = NULL;\n\n\tif (ha->flt)\n\t\tdma_free_coherent(&ha->pdev->dev,\n\t\t    sizeof(struct qla_flt_header) + FLT_REGIONS_SIZE,\n\t\t    ha->flt, ha->flt_dma);\n\tha->flt = NULL;\n\tha->flt_dma = 0;\n\n\tif (ha->ms_iocb)\n\t\tdma_pool_free(ha->s_dma_pool, ha->ms_iocb, ha->ms_iocb_dma);\n\tha->ms_iocb = NULL;\n\tha->ms_iocb_dma = 0;\n\n\tif (ha->sf_init_cb)\n\t\tdma_pool_free(ha->s_dma_pool,\n\t\t\t      ha->sf_init_cb, ha->sf_init_cb_dma);\n\n\tif (ha->ex_init_cb)\n\t\tdma_pool_free(ha->s_dma_pool,\n\t\t\tha->ex_init_cb, ha->ex_init_cb_dma);\n\tha->ex_init_cb = NULL;\n\tha->ex_init_cb_dma = 0;\n\n\tif (ha->async_pd)\n\t\tdma_pool_free(ha->s_dma_pool, ha->async_pd, ha->async_pd_dma);\n\tha->async_pd = NULL;\n\tha->async_pd_dma = 0;\n\n\tdma_pool_destroy(ha->s_dma_pool);\n\tha->s_dma_pool = NULL;\n\n\tif (ha->gid_list)\n\t\tdma_free_coherent(&ha->pdev->dev, qla2x00_gid_list_size(ha),\n\t\tha->gid_list, ha->gid_list_dma);\n\tha->gid_list = NULL;\n\tha->gid_list_dma = 0;\n\n\tif (IS_QLA82XX(ha)) {\n\t\tif (!list_empty(&ha->gbl_dsd_list)) {\n\t\t\tstruct dsd_dma *dsd_ptr, *tdsd_ptr;\n\n\t\t\t/* clean up allocated prev pool */\n\t\t\tlist_for_each_entry_safe(dsd_ptr,\n\t\t\t\ttdsd_ptr, &ha->gbl_dsd_list, list) {\n\t\t\t\tdma_pool_free(ha->dl_dma_pool,\n\t\t\t\tdsd_ptr->dsd_addr, dsd_ptr->dsd_list_dma);\n\t\t\t\tlist_del(&dsd_ptr->list);\n\t\t\t\tkfree(dsd_ptr);\n\t\t\t}\n\t\t}\n\t}\n\n\tdma_pool_destroy(ha->dl_dma_pool);\n\tha->dl_dma_pool = NULL;\n\n\tdma_pool_destroy(ha->fcp_cmnd_dma_pool);\n\tha->fcp_cmnd_dma_pool = NULL;\n\n\tmempool_destroy(ha->ctx_mempool);\n\tha->ctx_mempool = NULL;\n\n\tif (ql2xenabledif && ha->dif_bundl_pool) {\n\t\tstruct dsd_dma *dsd, *nxt;\n\n\t\tlist_for_each_entry_safe(dsd, nxt, &ha->pool.unusable.head,\n\t\t\t\t\t list) {\n\t\t\tlist_del(&dsd->list);\n\t\t\tdma_pool_free(ha->dif_bundl_pool, dsd->dsd_addr,\n\t\t\t\t      dsd->dsd_list_dma);\n\t\t\tha->dif_bundle_dma_allocs--;\n\t\t\tkfree(dsd);\n\t\t\tha->dif_bundle_kallocs--;\n\t\t\tha->pool.unusable.count--;\n\t\t}\n\t\tlist_for_each_entry_safe(dsd, nxt, &ha->pool.good.head, list) {\n\t\t\tlist_del(&dsd->list);\n\t\t\tdma_pool_free(ha->dif_bundl_pool, dsd->dsd_addr,\n\t\t\t\t      dsd->dsd_list_dma);\n\t\t\tha->dif_bundle_dma_allocs--;\n\t\t\tkfree(dsd);\n\t\t\tha->dif_bundle_kallocs--;\n\t\t}\n\t}\n\n\tdma_pool_destroy(ha->dif_bundl_pool);\n\tha->dif_bundl_pool = NULL;\n\n\tqlt_mem_free(ha);\n\n\tif (ha->init_cb)\n\t\tdma_free_coherent(&ha->pdev->dev, ha->init_cb_size,\n\t\t\tha->init_cb, ha->init_cb_dma);\n\tha->init_cb = NULL;\n\tha->init_cb_dma = 0;\n\n\tvfree(ha->optrom_buffer);\n\tha->optrom_buffer = NULL;\n\tkfree(ha->nvram);\n\tha->nvram = NULL;\n\tkfree(ha->npiv_info);\n\tha->npiv_info = NULL;\n\tkfree(ha->swl);\n\tha->swl = NULL;\n\tkfree(ha->loop_id_map);\n\tha->sf_init_cb = NULL;\n\tha->sf_init_cb_dma = 0;\n\tha->loop_id_map = NULL;\n}\n\nstruct scsi_qla_host *qla2x00_create_host(struct scsi_host_template *sht,\n\t\t\t\t\t\tstruct qla_hw_data *ha)\n{\n\tstruct Scsi_Host *host;\n\tstruct scsi_qla_host *vha = NULL;\n\n\thost = scsi_host_alloc(sht, sizeof(scsi_qla_host_t));\n\tif (!host) {\n\t\tql_log_pci(ql_log_fatal, ha->pdev, 0x0107,\n\t\t    \"Failed to allocate host from the scsi layer, aborting.\\n\");\n\t\treturn NULL;\n\t}\n\n\t/* Clear our data area */\n\tvha = shost_priv(host);\n\tmemset(vha, 0, sizeof(scsi_qla_host_t));\n\n\tvha->host = host;\n\tvha->host_no = host->host_no;\n\tvha->hw = ha;\n\n\tvha->qlini_mode = ql2x_ini_mode;\n\tvha->ql2xexchoffld = ql2xexchoffld;\n\tvha->ql2xiniexchg = ql2xiniexchg;\n\n\tINIT_LIST_HEAD(&vha->vp_fcports);\n\tINIT_LIST_HEAD(&vha->work_list);\n\tINIT_LIST_HEAD(&vha->list);\n\tINIT_LIST_HEAD(&vha->qla_cmd_list);\n\tINIT_LIST_HEAD(&vha->qla_sess_op_cmd_list);\n\tINIT_LIST_HEAD(&vha->logo_list);\n\tINIT_LIST_HEAD(&vha->plogi_ack_list);\n\tINIT_LIST_HEAD(&vha->qp_list);\n\tINIT_LIST_HEAD(&vha->gnl.fcports);\n\tINIT_LIST_HEAD(&vha->gpnid_list);\n\tINIT_WORK(&vha->iocb_work, qla2x00_iocb_work_fn);\n\n\tINIT_LIST_HEAD(&vha->purex_list.head);\n\tspin_lock_init(&vha->purex_list.lock);\n\n\tspin_lock_init(&vha->work_lock);\n\tspin_lock_init(&vha->cmd_list_lock);\n\tinit_waitqueue_head(&vha->fcport_waitQ);\n\tinit_waitqueue_head(&vha->vref_waitq);\n\n\tvha->gnl.size = sizeof(struct get_name_list_extended) *\n\t\t\t(ha->max_loop_id + 1);\n\tvha->gnl.l = dma_alloc_coherent(&ha->pdev->dev,\n\t    vha->gnl.size, &vha->gnl.ldma, GFP_KERNEL);\n\tif (!vha->gnl.l) {\n\t\tql_log(ql_log_fatal, vha, 0xd04a,\n\t\t    \"Alloc failed for name list.\\n\");\n\t\tscsi_host_put(vha->host);\n\t\treturn NULL;\n\t}\n\n\t/* todo: what about ext login? */\n\tvha->scan.size = ha->max_fibre_devices * sizeof(struct fab_scan_rp);\n\tvha->scan.l = vmalloc(vha->scan.size);\n\tif (!vha->scan.l) {\n\t\tql_log(ql_log_fatal, vha, 0xd04a,\n\t\t    \"Alloc failed for scan database.\\n\");\n\t\tdma_free_coherent(&ha->pdev->dev, vha->gnl.size,\n\t\t    vha->gnl.l, vha->gnl.ldma);\n\t\tvha->gnl.l = NULL;\n\t\tscsi_host_put(vha->host);\n\t\treturn NULL;\n\t}\n\tINIT_DELAYED_WORK(&vha->scan.scan_work, qla_scan_work_fn);\n\n\tsprintf(vha->host_str, \"%s_%lu\", QLA2XXX_DRIVER_NAME, vha->host_no);\n\tql_dbg(ql_dbg_init, vha, 0x0041,\n\t    \"Allocated the host=%p hw=%p vha=%p dev_name=%s\",\n\t    vha->host, vha->hw, vha,\n\t    dev_name(&(ha->pdev->dev)));\n\n\treturn vha;\n}\n\nstruct qla_work_evt *\nqla2x00_alloc_work(struct scsi_qla_host *vha, enum qla_work_type type)\n{\n\tstruct qla_work_evt *e;\n\tuint8_t bail;\n\n\tif (test_bit(UNLOADING, &vha->dpc_flags))\n\t\treturn NULL;\n\n\tQLA_VHA_MARK_BUSY(vha, bail);\n\tif (bail)\n\t\treturn NULL;\n\n\te = kzalloc(sizeof(struct qla_work_evt), GFP_ATOMIC);\n\tif (!e) {\n\t\tQLA_VHA_MARK_NOT_BUSY(vha);\n\t\treturn NULL;\n\t}\n\n\tINIT_LIST_HEAD(&e->list);\n\te->type = type;\n\te->flags = QLA_EVT_FLAG_FREE;\n\treturn e;\n}\n\nint\nqla2x00_post_work(struct scsi_qla_host *vha, struct qla_work_evt *e)\n{\n\tunsigned long flags;\n\tbool q = false;\n\n\tspin_lock_irqsave(&vha->work_lock, flags);\n\tlist_add_tail(&e->list, &vha->work_list);\n\n\tif (!test_and_set_bit(IOCB_WORK_ACTIVE, &vha->dpc_flags))\n\t\tq = true;\n\n\tspin_unlock_irqrestore(&vha->work_lock, flags);\n\n\tif (q)\n\t\tqueue_work(vha->hw->wq, &vha->iocb_work);\n\n\treturn QLA_SUCCESS;\n}\n\nint\nqla2x00_post_aen_work(struct scsi_qla_host *vha, enum fc_host_event_code code,\n    u32 data)\n{\n\tstruct qla_work_evt *e;\n\n\te = qla2x00_alloc_work(vha, QLA_EVT_AEN);\n\tif (!e)\n\t\treturn QLA_FUNCTION_FAILED;\n\n\te->u.aen.code = code;\n\te->u.aen.data = data;\n\treturn qla2x00_post_work(vha, e);\n}\n\nint\nqla2x00_post_idc_ack_work(struct scsi_qla_host *vha, uint16_t *mb)\n{\n\tstruct qla_work_evt *e;\n\n\te = qla2x00_alloc_work(vha, QLA_EVT_IDC_ACK);\n\tif (!e)\n\t\treturn QLA_FUNCTION_FAILED;\n\n\tmemcpy(e->u.idc_ack.mb, mb, QLA_IDC_ACK_REGS * sizeof(uint16_t));\n\treturn qla2x00_post_work(vha, e);\n}\n\n#define qla2x00_post_async_work(name, type)\t\\\nint qla2x00_post_async_##name##_work(\t\t\\\n    struct scsi_qla_host *vha,\t\t\t\\\n    fc_port_t *fcport, uint16_t *data)\t\t\\\n{\t\t\t\t\t\t\\\n\tstruct qla_work_evt *e;\t\t\t\\\n\t\t\t\t\t\t\\\n\te = qla2x00_alloc_work(vha, type);\t\\\n\tif (!e)\t\t\t\t\t\\\n\t\treturn QLA_FUNCTION_FAILED;\t\\\n\t\t\t\t\t\t\\\n\te->u.logio.fcport = fcport;\t\t\\\n\tif (data) {\t\t\t\t\\\n\t\te->u.logio.data[0] = data[0];\t\\\n\t\te->u.logio.data[1] = data[1];\t\\\n\t}\t\t\t\t\t\\\n\tfcport->flags |= FCF_ASYNC_ACTIVE;\t\\\n\treturn qla2x00_post_work(vha, e);\t\\\n}\n\nqla2x00_post_async_work(login, QLA_EVT_ASYNC_LOGIN);\nqla2x00_post_async_work(logout, QLA_EVT_ASYNC_LOGOUT);\nqla2x00_post_async_work(adisc, QLA_EVT_ASYNC_ADISC);\nqla2x00_post_async_work(prlo, QLA_EVT_ASYNC_PRLO);\nqla2x00_post_async_work(prlo_done, QLA_EVT_ASYNC_PRLO_DONE);\n\nint\nqla2x00_post_uevent_work(struct scsi_qla_host *vha, u32 code)\n{\n\tstruct qla_work_evt *e;\n\n\te = qla2x00_alloc_work(vha, QLA_EVT_UEVENT);\n\tif (!e)\n\t\treturn QLA_FUNCTION_FAILED;\n\n\te->u.uevent.code = code;\n\treturn qla2x00_post_work(vha, e);\n}\n\nstatic void\nqla2x00_uevent_emit(struct scsi_qla_host *vha, u32 code)\n{\n\tchar event_string[40];\n\tchar *envp[] = { event_string, NULL };\n\n\tswitch (code) {\n\tcase QLA_UEVENT_CODE_FW_DUMP:\n\t\tsnprintf(event_string, sizeof(event_string), \"FW_DUMP=%lu\",\n\t\t    vha->host_no);\n\t\tbreak;\n\tdefault:\n\t\t/* do nothing */\n\t\tbreak;\n\t}\n\tkobject_uevent_env(&vha->hw->pdev->dev.kobj, KOBJ_CHANGE, envp);\n}\n\nint\nqlafx00_post_aenfx_work(struct scsi_qla_host *vha,  uint32_t evtcode,\n\t\t\tuint32_t *data, int cnt)\n{\n\tstruct qla_work_evt *e;\n\n\te = qla2x00_alloc_work(vha, QLA_EVT_AENFX);\n\tif (!e)\n\t\treturn QLA_FUNCTION_FAILED;\n\n\te->u.aenfx.evtcode = evtcode;\n\te->u.aenfx.count = cnt;\n\tmemcpy(e->u.aenfx.mbx, data, sizeof(*data) * cnt);\n\treturn qla2x00_post_work(vha, e);\n}\n\nvoid qla24xx_sched_upd_fcport(fc_port_t *fcport)\n{\n\tunsigned long flags;\n\n\tif (IS_SW_RESV_ADDR(fcport->d_id))\n\t\treturn;\n\n\tspin_lock_irqsave(&fcport->vha->work_lock, flags);\n\tif (fcport->disc_state == DSC_UPD_FCPORT) {\n\t\tspin_unlock_irqrestore(&fcport->vha->work_lock, flags);\n\t\treturn;\n\t}\n\tfcport->jiffies_at_registration = jiffies;\n\tfcport->sec_since_registration = 0;\n\tfcport->next_disc_state = DSC_DELETED;\n\tqla2x00_set_fcport_disc_state(fcport, DSC_UPD_FCPORT);\n\tspin_unlock_irqrestore(&fcport->vha->work_lock, flags);\n\n\tqueue_work(system_unbound_wq, &fcport->reg_work);\n}\n\nstatic\nvoid qla24xx_create_new_sess(struct scsi_qla_host *vha, struct qla_work_evt *e)\n{\n\tunsigned long flags;\n\tfc_port_t *fcport =  NULL, *tfcp;\n\tstruct qlt_plogi_ack_t *pla =\n\t    (struct qlt_plogi_ack_t *)e->u.new_sess.pla;\n\tuint8_t free_fcport = 0;\n\n\tql_dbg(ql_dbg_disc, vha, 0xffff,\n\t    \"%s %d %8phC enter\\n\",\n\t    __func__, __LINE__, e->u.new_sess.port_name);\n\n\tspin_lock_irqsave(&vha->hw->tgt.sess_lock, flags);\n\tfcport = qla2x00_find_fcport_by_wwpn(vha, e->u.new_sess.port_name, 1);\n\tif (fcport) {\n\t\tfcport->d_id = e->u.new_sess.id;\n\t\tif (pla) {\n\t\t\tfcport->fw_login_state = DSC_LS_PLOGI_PEND;\n\t\t\tmemcpy(fcport->node_name,\n\t\t\t    pla->iocb.u.isp24.u.plogi.node_name,\n\t\t\t    WWN_SIZE);\n\t\t\tqlt_plogi_ack_link(vha, pla, fcport, QLT_PLOGI_LINK_SAME_WWN);\n\t\t\t/* we took an extra ref_count to prevent PLOGI ACK when\n\t\t\t * fcport/sess has not been created.\n\t\t\t */\n\t\t\tpla->ref_count--;\n\t\t}\n\t} else {\n\t\tspin_unlock_irqrestore(&vha->hw->tgt.sess_lock, flags);\n\t\tfcport = qla2x00_alloc_fcport(vha, GFP_KERNEL);\n\t\tif (fcport) {\n\t\t\tfcport->d_id = e->u.new_sess.id;\n\t\t\tfcport->flags |= FCF_FABRIC_DEVICE;\n\t\t\tfcport->fw_login_state = DSC_LS_PLOGI_PEND;\n\n\t\t\tmemcpy(fcport->port_name, e->u.new_sess.port_name,\n\t\t\t    WWN_SIZE);\n\n\t\t\tfcport->fc4_type = e->u.new_sess.fc4_type;\n\t\t\tif (e->u.new_sess.fc4_type & FS_FCP_IS_N2N) {\n\t\t\t\tfcport->dm_login_expire = jiffies +\n\t\t\t\t\tQLA_N2N_WAIT_TIME * HZ;\n\t\t\t\tfcport->fc4_type = FS_FC4TYPE_FCP;\n\t\t\t\tfcport->n2n_flag = 1;\n\t\t\t\tif (vha->flags.nvme_enabled)\n\t\t\t\t\tfcport->fc4_type |= FS_FC4TYPE_NVME;\n\t\t\t}\n\n\t\t} else {\n\t\t\tql_dbg(ql_dbg_disc, vha, 0xffff,\n\t\t\t\t   \"%s %8phC mem alloc fail.\\n\",\n\t\t\t\t   __func__, e->u.new_sess.port_name);\n\n\t\t\tif (pla) {\n\t\t\t\tlist_del(&pla->list);\n\t\t\t\tkmem_cache_free(qla_tgt_plogi_cachep, pla);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tspin_lock_irqsave(&vha->hw->tgt.sess_lock, flags);\n\t\t/* search again to make sure no one else got ahead */\n\t\ttfcp = qla2x00_find_fcport_by_wwpn(vha,\n\t\t    e->u.new_sess.port_name, 1);\n\t\tif (tfcp) {\n\t\t\t/* should rarily happen */\n\t\t\tql_dbg(ql_dbg_disc, vha, 0xffff,\n\t\t\t    \"%s %8phC found existing fcport b4 add. DS %d LS %d\\n\",\n\t\t\t    __func__, tfcp->port_name, tfcp->disc_state,\n\t\t\t    tfcp->fw_login_state);\n\n\t\t\tfree_fcport = 1;\n\t\t} else {\n\t\t\tlist_add_tail(&fcport->list, &vha->vp_fcports);\n\n\t\t}\n\t\tif (pla) {\n\t\t\tqlt_plogi_ack_link(vha, pla, fcport,\n\t\t\t    QLT_PLOGI_LINK_SAME_WWN);\n\t\t\tpla->ref_count--;\n\t\t}\n\t}\n\tspin_unlock_irqrestore(&vha->hw->tgt.sess_lock, flags);\n\n\tif (fcport) {\n\t\tfcport->id_changed = 1;\n\t\tfcport->scan_state = QLA_FCPORT_FOUND;\n\t\tfcport->chip_reset = vha->hw->base_qpair->chip_reset;\n\t\tmemcpy(fcport->node_name, e->u.new_sess.node_name, WWN_SIZE);\n\n\t\tif (pla) {\n\t\t\tif (pla->iocb.u.isp24.status_subcode == ELS_PRLI) {\n\t\t\t\tu16 wd3_lo;\n\n\t\t\t\tfcport->fw_login_state = DSC_LS_PRLI_PEND;\n\t\t\t\tfcport->local = 0;\n\t\t\t\tfcport->loop_id =\n\t\t\t\t\tle16_to_cpu(\n\t\t\t\t\t    pla->iocb.u.isp24.nport_handle);\n\t\t\t\tfcport->fw_login_state = DSC_LS_PRLI_PEND;\n\t\t\t\twd3_lo =\n\t\t\t\t    le16_to_cpu(\n\t\t\t\t\tpla->iocb.u.isp24.u.prli.wd3_lo);\n\n\t\t\t\tif (wd3_lo & BIT_7)\n\t\t\t\t\tfcport->conf_compl_supported = 1;\n\n\t\t\t\tif ((wd3_lo & BIT_4) == 0)\n\t\t\t\t\tfcport->port_type = FCT_INITIATOR;\n\t\t\t\telse\n\t\t\t\t\tfcport->port_type = FCT_TARGET;\n\t\t\t}\n\t\t\tqlt_plogi_ack_unref(vha, pla);\n\t\t} else {\n\t\t\tfc_port_t *dfcp = NULL;\n\n\t\t\tspin_lock_irqsave(&vha->hw->tgt.sess_lock, flags);\n\t\t\ttfcp = qla2x00_find_fcport_by_nportid(vha,\n\t\t\t    &e->u.new_sess.id, 1);\n\t\t\tif (tfcp && (tfcp != fcport)) {\n\t\t\t\t/*\n\t\t\t\t * We have a conflict fcport with same NportID.\n\t\t\t\t */\n\t\t\t\tql_dbg(ql_dbg_disc, vha, 0xffff,\n\t\t\t\t    \"%s %8phC found conflict b4 add. DS %d LS %d\\n\",\n\t\t\t\t    __func__, tfcp->port_name, tfcp->disc_state,\n\t\t\t\t    tfcp->fw_login_state);\n\n\t\t\t\tswitch (tfcp->disc_state) {\n\t\t\t\tcase DSC_DELETED:\n\t\t\t\t\tbreak;\n\t\t\t\tcase DSC_DELETE_PEND:\n\t\t\t\t\tfcport->login_pause = 1;\n\t\t\t\t\ttfcp->conflict = fcport;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tfcport->login_pause = 1;\n\t\t\t\t\ttfcp->conflict = fcport;\n\t\t\t\t\tdfcp = tfcp;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tspin_unlock_irqrestore(&vha->hw->tgt.sess_lock, flags);\n\t\t\tif (dfcp)\n\t\t\t\tqlt_schedule_sess_for_deletion(tfcp);\n\n\t\t\tif (N2N_TOPO(vha->hw)) {\n\t\t\t\tfcport->flags &= ~FCF_FABRIC_DEVICE;\n\t\t\t\tfcport->keep_nport_handle = 1;\n\t\t\t\tif (vha->flags.nvme_enabled) {\n\t\t\t\t\tfcport->fc4_type =\n\t\t\t\t\t    (FS_FC4TYPE_NVME | FS_FC4TYPE_FCP);\n\t\t\t\t\tfcport->n2n_flag = 1;\n\t\t\t\t}\n\t\t\t\tfcport->fw_login_state = 0;\n\n\t\t\t\tschedule_delayed_work(&vha->scan.scan_work, 5);\n\t\t\t} else {\n\t\t\t\tqla24xx_fcport_handle_login(vha, fcport);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (free_fcport) {\n\t\tqla2x00_free_fcport(fcport);\n\t\tif (pla) {\n\t\t\tlist_del(&pla->list);\n\t\t\tkmem_cache_free(qla_tgt_plogi_cachep, pla);\n\t\t}\n\t}\n}\n\nstatic void qla_sp_retry(struct scsi_qla_host *vha, struct qla_work_evt *e)\n{\n\tstruct srb *sp = e->u.iosb.sp;\n\tint rval;\n\n\trval = qla2x00_start_sp(sp);\n\tif (rval != QLA_SUCCESS) {\n\t\tql_dbg(ql_dbg_disc, vha, 0x2043,\n\t\t    \"%s: %s: Re-issue IOCB failed (%d).\\n\",\n\t\t    __func__, sp->name, rval);\n\t\tqla24xx_sp_unmap(vha, sp);\n\t}\n}\n\nvoid\nqla2x00_do_work(struct scsi_qla_host *vha)\n{\n\tstruct qla_work_evt *e, *tmp;\n\tunsigned long flags;\n\tLIST_HEAD(work);\n\tint rc;\n\n\tspin_lock_irqsave(&vha->work_lock, flags);\n\tlist_splice_init(&vha->work_list, &work);\n\tspin_unlock_irqrestore(&vha->work_lock, flags);\n\n\tlist_for_each_entry_safe(e, tmp, &work, list) {\n\t\trc = QLA_SUCCESS;\n\t\tswitch (e->type) {\n\t\tcase QLA_EVT_AEN:\n\t\t\tfc_host_post_event(vha->host, fc_get_event_number(),\n\t\t\t    e->u.aen.code, e->u.aen.data);\n\t\t\tbreak;\n\t\tcase QLA_EVT_IDC_ACK:\n\t\t\tqla81xx_idc_ack(vha, e->u.idc_ack.mb);\n\t\t\tbreak;\n\t\tcase QLA_EVT_ASYNC_LOGIN:\n\t\t\tqla2x00_async_login(vha, e->u.logio.fcport,\n\t\t\t    e->u.logio.data);\n\t\t\tbreak;\n\t\tcase QLA_EVT_ASYNC_LOGOUT:\n\t\t\trc = qla2x00_async_logout(vha, e->u.logio.fcport);\n\t\t\tbreak;\n\t\tcase QLA_EVT_ASYNC_ADISC:\n\t\t\tqla2x00_async_adisc(vha, e->u.logio.fcport,\n\t\t\t    e->u.logio.data);\n\t\t\tbreak;\n\t\tcase QLA_EVT_UEVENT:\n\t\t\tqla2x00_uevent_emit(vha, e->u.uevent.code);\n\t\t\tbreak;\n\t\tcase QLA_EVT_AENFX:\n\t\t\tqlafx00_process_aen(vha, e);\n\t\t\tbreak;\n\t\tcase QLA_EVT_GPNID:\n\t\t\tqla24xx_async_gpnid(vha, &e->u.gpnid.id);\n\t\t\tbreak;\n\t\tcase QLA_EVT_UNMAP:\n\t\t\tqla24xx_sp_unmap(vha, e->u.iosb.sp);\n\t\t\tbreak;\n\t\tcase QLA_EVT_RELOGIN:\n\t\t\tqla2x00_relogin(vha);\n\t\t\tbreak;\n\t\tcase QLA_EVT_NEW_SESS:\n\t\t\tqla24xx_create_new_sess(vha, e);\n\t\t\tbreak;\n\t\tcase QLA_EVT_GPDB:\n\t\t\tqla24xx_async_gpdb(vha, e->u.fcport.fcport,\n\t\t\t    e->u.fcport.opt);\n\t\t\tbreak;\n\t\tcase QLA_EVT_PRLI:\n\t\t\tqla24xx_async_prli(vha, e->u.fcport.fcport);\n\t\t\tbreak;\n\t\tcase QLA_EVT_GPSC:\n\t\t\tqla24xx_async_gpsc(vha, e->u.fcport.fcport);\n\t\t\tbreak;\n\t\tcase QLA_EVT_GNL:\n\t\t\tqla24xx_async_gnl(vha, e->u.fcport.fcport);\n\t\t\tbreak;\n\t\tcase QLA_EVT_NACK:\n\t\t\tqla24xx_do_nack_work(vha, e);\n\t\t\tbreak;\n\t\tcase QLA_EVT_ASYNC_PRLO:\n\t\t\trc = qla2x00_async_prlo(vha, e->u.logio.fcport);\n\t\t\tbreak;\n\t\tcase QLA_EVT_ASYNC_PRLO_DONE:\n\t\t\tqla2x00_async_prlo_done(vha, e->u.logio.fcport,\n\t\t\t    e->u.logio.data);\n\t\t\tbreak;\n\t\tcase QLA_EVT_GPNFT:\n\t\t\tqla24xx_async_gpnft(vha, e->u.gpnft.fc4_type,\n\t\t\t    e->u.gpnft.sp);\n\t\t\tbreak;\n\t\tcase QLA_EVT_GPNFT_DONE:\n\t\t\tqla24xx_async_gpnft_done(vha, e->u.iosb.sp);\n\t\t\tbreak;\n\t\tcase QLA_EVT_GNNFT_DONE:\n\t\t\tqla24xx_async_gnnft_done(vha, e->u.iosb.sp);\n\t\t\tbreak;\n\t\tcase QLA_EVT_GNNID:\n\t\t\tqla24xx_async_gnnid(vha, e->u.fcport.fcport);\n\t\t\tbreak;\n\t\tcase QLA_EVT_GFPNID:\n\t\t\tqla24xx_async_gfpnid(vha, e->u.fcport.fcport);\n\t\t\tbreak;\n\t\tcase QLA_EVT_SP_RETRY:\n\t\t\tqla_sp_retry(vha, e);\n\t\t\tbreak;\n\t\tcase QLA_EVT_IIDMA:\n\t\t\tqla_do_iidma_work(vha, e->u.fcport.fcport);\n\t\t\tbreak;\n\t\tcase QLA_EVT_ELS_PLOGI:\n\t\t\tqla24xx_els_dcmd2_iocb(vha, ELS_DCMD_PLOGI,\n\t\t\t    e->u.fcport.fcport, false);\n\t\t\tbreak;\n\t\t}\n\n\t\tif (rc == EAGAIN) {\n\t\t\t/* put 'work' at head of 'vha->work_list' */\n\t\t\tspin_lock_irqsave(&vha->work_lock, flags);\n\t\t\tlist_splice(&work, &vha->work_list);\n\t\t\tspin_unlock_irqrestore(&vha->work_lock, flags);\n\t\t\tbreak;\n\t\t}\n\t\tlist_del_init(&e->list);\n\t\tif (e->flags & QLA_EVT_FLAG_FREE)\n\t\t\tkfree(e);\n\n\t\t/* For each work completed decrement vha ref count */\n\t\tQLA_VHA_MARK_NOT_BUSY(vha);\n\t}\n}\n\nint qla24xx_post_relogin_work(struct scsi_qla_host *vha)\n{\n\tstruct qla_work_evt *e;\n\n\te = qla2x00_alloc_work(vha, QLA_EVT_RELOGIN);\n\n\tif (!e) {\n\t\tset_bit(RELOGIN_NEEDED, &vha->dpc_flags);\n\t\treturn QLA_FUNCTION_FAILED;\n\t}\n\n\treturn qla2x00_post_work(vha, e);\n}\n\n/* Relogins all the fcports of a vport\n * Context: dpc thread\n */\nvoid qla2x00_relogin(struct scsi_qla_host *vha)\n{\n\tfc_port_t       *fcport;\n\tint status, relogin_needed = 0;\n\tstruct event_arg ea;\n\n\tlist_for_each_entry(fcport, &vha->vp_fcports, list) {\n\t\t/*\n\t\t * If the port is not ONLINE then try to login\n\t\t * to it if we haven't run out of retries.\n\t\t */\n\t\tif (atomic_read(&fcport->state) != FCS_ONLINE &&\n\t\t    fcport->login_retry) {\n\t\t\tif (fcport->scan_state != QLA_FCPORT_FOUND ||\n\t\t\t    fcport->disc_state == DSC_LOGIN_COMPLETE)\n\t\t\t\tcontinue;\n\n\t\t\tif (fcport->flags & (FCF_ASYNC_SENT|FCF_ASYNC_ACTIVE) ||\n\t\t\t\tfcport->disc_state == DSC_DELETE_PEND) {\n\t\t\t\trelogin_needed = 1;\n\t\t\t} else {\n\t\t\t\tif (vha->hw->current_topology != ISP_CFG_NL) {\n\t\t\t\t\tmemset(&ea, 0, sizeof(ea));\n\t\t\t\t\tea.fcport = fcport;\n\t\t\t\t\tqla24xx_handle_relogin_event(vha, &ea);\n\t\t\t\t} else if (vha->hw->current_topology ==\n\t\t\t\t    ISP_CFG_NL) {\n\t\t\t\t\tfcport->login_retry--;\n\t\t\t\t\tstatus =\n\t\t\t\t\t    qla2x00_local_device_login(vha,\n\t\t\t\t\t\tfcport);\n\t\t\t\t\tif (status == QLA_SUCCESS) {\n\t\t\t\t\t\tfcport->old_loop_id =\n\t\t\t\t\t\t    fcport->loop_id;\n\t\t\t\t\t\tql_dbg(ql_dbg_disc, vha, 0x2003,\n\t\t\t\t\t\t    \"Port login OK: logged in ID 0x%x.\\n\",\n\t\t\t\t\t\t    fcport->loop_id);\n\t\t\t\t\t\tqla2x00_update_fcport\n\t\t\t\t\t\t\t(vha, fcport);\n\t\t\t\t\t} else if (status == 1) {\n\t\t\t\t\t\tset_bit(RELOGIN_NEEDED,\n\t\t\t\t\t\t    &vha->dpc_flags);\n\t\t\t\t\t\t/* retry the login again */\n\t\t\t\t\t\tql_dbg(ql_dbg_disc, vha, 0x2007,\n\t\t\t\t\t\t    \"Retrying %d login again loop_id 0x%x.\\n\",\n\t\t\t\t\t\t    fcport->login_retry,\n\t\t\t\t\t\t    fcport->loop_id);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfcport->login_retry = 0;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (fcport->login_retry == 0 &&\n\t\t\t\t\t    status != QLA_SUCCESS)\n\t\t\t\t\t\tqla2x00_clear_loop_id(fcport);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (test_bit(LOOP_RESYNC_NEEDED, &vha->dpc_flags))\n\t\t\tbreak;\n\t}\n\n\tif (relogin_needed)\n\t\tset_bit(RELOGIN_NEEDED, &vha->dpc_flags);\n\n\tql_dbg(ql_dbg_disc, vha, 0x400e,\n\t    \"Relogin end.\\n\");\n}\n\n/* Schedule work on any of the dpc-workqueues */\nvoid\nqla83xx_schedule_work(scsi_qla_host_t *base_vha, int work_code)\n{\n\tstruct qla_hw_data *ha = base_vha->hw;\n\n\tswitch (work_code) {\n\tcase MBA_IDC_AEN: /* 0x8200 */\n\t\tif (ha->dpc_lp_wq)\n\t\t\tqueue_work(ha->dpc_lp_wq, &ha->idc_aen);\n\t\tbreak;\n\n\tcase QLA83XX_NIC_CORE_RESET: /* 0x1 */\n\t\tif (!ha->flags.nic_core_reset_hdlr_active) {\n\t\t\tif (ha->dpc_hp_wq)\n\t\t\t\tqueue_work(ha->dpc_hp_wq, &ha->nic_core_reset);\n\t\t} else\n\t\t\tql_dbg(ql_dbg_p3p, base_vha, 0xb05e,\n\t\t\t    \"NIC Core reset is already active. Skip \"\n\t\t\t    \"scheduling it again.\\n\");\n\t\tbreak;\n\tcase QLA83XX_IDC_STATE_HANDLER: /* 0x2 */\n\t\tif (ha->dpc_hp_wq)\n\t\t\tqueue_work(ha->dpc_hp_wq, &ha->idc_state_handler);\n\t\tbreak;\n\tcase QLA83XX_NIC_CORE_UNRECOVERABLE: /* 0x3 */\n\t\tif (ha->dpc_hp_wq)\n\t\t\tqueue_work(ha->dpc_hp_wq, &ha->nic_core_unrecoverable);\n\t\tbreak;\n\tdefault:\n\t\tql_log(ql_log_warn, base_vha, 0xb05f,\n\t\t    \"Unknown work-code=0x%x.\\n\", work_code);\n\t}\n\n\treturn;\n}\n\n/* Work: Perform NIC Core Unrecoverable state handling */\nvoid\nqla83xx_nic_core_unrecoverable_work(struct work_struct *work)\n{\n\tstruct qla_hw_data *ha =\n\t\tcontainer_of(work, struct qla_hw_data, nic_core_unrecoverable);\n\tscsi_qla_host_t *base_vha = pci_get_drvdata(ha->pdev);\n\tuint32_t dev_state = 0;\n\n\tqla83xx_idc_lock(base_vha, 0);\n\tqla83xx_rd_reg(base_vha, QLA83XX_IDC_DEV_STATE, &dev_state);\n\tqla83xx_reset_ownership(base_vha);\n\tif (ha->flags.nic_core_reset_owner) {\n\t\tha->flags.nic_core_reset_owner = 0;\n\t\tqla83xx_wr_reg(base_vha, QLA83XX_IDC_DEV_STATE,\n\t\t    QLA8XXX_DEV_FAILED);\n\t\tql_log(ql_log_info, base_vha, 0xb060, \"HW State: FAILED.\\n\");\n\t\tqla83xx_schedule_work(base_vha, QLA83XX_IDC_STATE_HANDLER);\n\t}\n\tqla83xx_idc_unlock(base_vha, 0);\n}\n\n/* Work: Execute IDC state handler */\nvoid\nqla83xx_idc_state_handler_work(struct work_struct *work)\n{\n\tstruct qla_hw_data *ha =\n\t\tcontainer_of(work, struct qla_hw_data, idc_state_handler);\n\tscsi_qla_host_t *base_vha = pci_get_drvdata(ha->pdev);\n\tuint32_t dev_state = 0;\n\n\tqla83xx_idc_lock(base_vha, 0);\n\tqla83xx_rd_reg(base_vha, QLA83XX_IDC_DEV_STATE, &dev_state);\n\tif (dev_state == QLA8XXX_DEV_FAILED ||\n\t\t\tdev_state == QLA8XXX_DEV_NEED_QUIESCENT)\n\t\tqla83xx_idc_state_handler(base_vha);\n\tqla83xx_idc_unlock(base_vha, 0);\n}\n\nstatic int\nqla83xx_check_nic_core_fw_alive(scsi_qla_host_t *base_vha)\n{\n\tint rval = QLA_SUCCESS;\n\tunsigned long heart_beat_wait = jiffies + (1 * HZ);\n\tuint32_t heart_beat_counter1, heart_beat_counter2;\n\n\tdo {\n\t\tif (time_after(jiffies, heart_beat_wait)) {\n\t\t\tql_dbg(ql_dbg_p3p, base_vha, 0xb07c,\n\t\t\t    \"Nic Core f/w is not alive.\\n\");\n\t\t\trval = QLA_FUNCTION_FAILED;\n\t\t\tbreak;\n\t\t}\n\n\t\tqla83xx_idc_lock(base_vha, 0);\n\t\tqla83xx_rd_reg(base_vha, QLA83XX_FW_HEARTBEAT,\n\t\t    &heart_beat_counter1);\n\t\tqla83xx_idc_unlock(base_vha, 0);\n\t\tmsleep(100);\n\t\tqla83xx_idc_lock(base_vha, 0);\n\t\tqla83xx_rd_reg(base_vha, QLA83XX_FW_HEARTBEAT,\n\t\t    &heart_beat_counter2);\n\t\tqla83xx_idc_unlock(base_vha, 0);\n\t} while (heart_beat_counter1 == heart_beat_counter2);\n\n\treturn rval;\n}\n\n/* Work: Perform NIC Core Reset handling */\nvoid\nqla83xx_nic_core_reset_work(struct work_struct *work)\n{\n\tstruct qla_hw_data *ha =\n\t\tcontainer_of(work, struct qla_hw_data, nic_core_reset);\n\tscsi_qla_host_t *base_vha = pci_get_drvdata(ha->pdev);\n\tuint32_t dev_state = 0;\n\n\tif (IS_QLA2031(ha)) {\n\t\tif (qla2xxx_mctp_dump(base_vha) != QLA_SUCCESS)\n\t\t\tql_log(ql_log_warn, base_vha, 0xb081,\n\t\t\t    \"Failed to dump mctp\\n\");\n\t\treturn;\n\t}\n\n\tif (!ha->flags.nic_core_reset_hdlr_active) {\n\t\tif (qla83xx_check_nic_core_fw_alive(base_vha) == QLA_SUCCESS) {\n\t\t\tqla83xx_idc_lock(base_vha, 0);\n\t\t\tqla83xx_rd_reg(base_vha, QLA83XX_IDC_DEV_STATE,\n\t\t\t    &dev_state);\n\t\t\tqla83xx_idc_unlock(base_vha, 0);\n\t\t\tif (dev_state != QLA8XXX_DEV_NEED_RESET) {\n\t\t\t\tql_dbg(ql_dbg_p3p, base_vha, 0xb07a,\n\t\t\t\t    \"Nic Core f/w is alive.\\n\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tha->flags.nic_core_reset_hdlr_active = 1;\n\t\tif (qla83xx_nic_core_reset(base_vha)) {\n\t\t\t/* NIC Core reset failed. */\n\t\t\tql_dbg(ql_dbg_p3p, base_vha, 0xb061,\n\t\t\t    \"NIC Core reset failed.\\n\");\n\t\t}\n\t\tha->flags.nic_core_reset_hdlr_active = 0;\n\t}\n}\n\n/* Work: Handle 8200 IDC aens */\nvoid\nqla83xx_service_idc_aen(struct work_struct *work)\n{\n\tstruct qla_hw_data *ha =\n\t\tcontainer_of(work, struct qla_hw_data, idc_aen);\n\tscsi_qla_host_t *base_vha = pci_get_drvdata(ha->pdev);\n\tuint32_t dev_state, idc_control;\n\n\tqla83xx_idc_lock(base_vha, 0);\n\tqla83xx_rd_reg(base_vha, QLA83XX_IDC_DEV_STATE, &dev_state);\n\tqla83xx_rd_reg(base_vha, QLA83XX_IDC_CONTROL, &idc_control);\n\tqla83xx_idc_unlock(base_vha, 0);\n\tif (dev_state == QLA8XXX_DEV_NEED_RESET) {\n\t\tif (idc_control & QLA83XX_IDC_GRACEFUL_RESET) {\n\t\t\tql_dbg(ql_dbg_p3p, base_vha, 0xb062,\n\t\t\t    \"Application requested NIC Core Reset.\\n\");\n\t\t\tqla83xx_schedule_work(base_vha, QLA83XX_NIC_CORE_RESET);\n\t\t} else if (qla83xx_check_nic_core_fw_alive(base_vha) ==\n\t\t    QLA_SUCCESS) {\n\t\t\tql_dbg(ql_dbg_p3p, base_vha, 0xb07b,\n\t\t\t    \"Other protocol driver requested NIC Core Reset.\\n\");\n\t\t\tqla83xx_schedule_work(base_vha, QLA83XX_NIC_CORE_RESET);\n\t\t}\n\t} else if (dev_state == QLA8XXX_DEV_FAILED ||\n\t\t\tdev_state == QLA8XXX_DEV_NEED_QUIESCENT) {\n\t\tqla83xx_schedule_work(base_vha, QLA83XX_IDC_STATE_HANDLER);\n\t}\n}\n\nstatic void\nqla83xx_wait_logic(void)\n{\n\tint i;\n\n\t/* Yield CPU */\n\tif (!in_interrupt()) {\n\t\t/*\n\t\t * Wait about 200ms before retrying again.\n\t\t * This controls the number of retries for single\n\t\t * lock operation.\n\t\t */\n\t\tmsleep(100);\n\t\tschedule();\n\t} else {\n\t\tfor (i = 0; i < 20; i++)\n\t\t\tcpu_relax(); /* This a nop instr on i386 */\n\t}\n}\n\nstatic int\nqla83xx_force_lock_recovery(scsi_qla_host_t *base_vha)\n{\n\tint rval;\n\tuint32_t data;\n\tuint32_t idc_lck_rcvry_stage_mask = 0x3;\n\tuint32_t idc_lck_rcvry_owner_mask = 0x3c;\n\tstruct qla_hw_data *ha = base_vha->hw;\n\n\tql_dbg(ql_dbg_p3p, base_vha, 0xb086,\n\t    \"Trying force recovery of the IDC lock.\\n\");\n\n\trval = qla83xx_rd_reg(base_vha, QLA83XX_IDC_LOCK_RECOVERY, &data);\n\tif (rval)\n\t\treturn rval;\n\n\tif ((data & idc_lck_rcvry_stage_mask) > 0) {\n\t\treturn QLA_SUCCESS;\n\t} else {\n\t\tdata = (IDC_LOCK_RECOVERY_STAGE1) | (ha->portnum << 2);\n\t\trval = qla83xx_wr_reg(base_vha, QLA83XX_IDC_LOCK_RECOVERY,\n\t\t    data);\n\t\tif (rval)\n\t\t\treturn rval;\n\n\t\tmsleep(200);\n\n\t\trval = qla83xx_rd_reg(base_vha, QLA83XX_IDC_LOCK_RECOVERY,\n\t\t    &data);\n\t\tif (rval)\n\t\t\treturn rval;\n\n\t\tif (((data & idc_lck_rcvry_owner_mask) >> 2) == ha->portnum) {\n\t\t\tdata &= (IDC_LOCK_RECOVERY_STAGE2 |\n\t\t\t\t\t~(idc_lck_rcvry_stage_mask));\n\t\t\trval = qla83xx_wr_reg(base_vha,\n\t\t\t    QLA83XX_IDC_LOCK_RECOVERY, data);\n\t\t\tif (rval)\n\t\t\t\treturn rval;\n\n\t\t\t/* Forcefully perform IDC UnLock */\n\t\t\trval = qla83xx_rd_reg(base_vha, QLA83XX_DRIVER_UNLOCK,\n\t\t\t    &data);\n\t\t\tif (rval)\n\t\t\t\treturn rval;\n\t\t\t/* Clear lock-id by setting 0xff */\n\t\t\trval = qla83xx_wr_reg(base_vha, QLA83XX_DRIVER_LOCKID,\n\t\t\t    0xff);\n\t\t\tif (rval)\n\t\t\t\treturn rval;\n\t\t\t/* Clear lock-recovery by setting 0x0 */\n\t\t\trval = qla83xx_wr_reg(base_vha,\n\t\t\t    QLA83XX_IDC_LOCK_RECOVERY, 0x0);\n\t\t\tif (rval)\n\t\t\t\treturn rval;\n\t\t} else\n\t\t\treturn QLA_SUCCESS;\n\t}\n\n\treturn rval;\n}\n\nstatic int\nqla83xx_idc_lock_recovery(scsi_qla_host_t *base_vha)\n{\n\tint rval = QLA_SUCCESS;\n\tuint32_t o_drv_lockid, n_drv_lockid;\n\tunsigned long lock_recovery_timeout;\n\n\tlock_recovery_timeout = jiffies + QLA83XX_MAX_LOCK_RECOVERY_WAIT;\nretry_lockid:\n\trval = qla83xx_rd_reg(base_vha, QLA83XX_DRIVER_LOCKID, &o_drv_lockid);\n\tif (rval)\n\t\tgoto exit;\n\n\t/* MAX wait time before forcing IDC Lock recovery = 2 secs */\n\tif (time_after_eq(jiffies, lock_recovery_timeout)) {\n\t\tif (qla83xx_force_lock_recovery(base_vha) == QLA_SUCCESS)\n\t\t\treturn QLA_SUCCESS;\n\t\telse\n\t\t\treturn QLA_FUNCTION_FAILED;\n\t}\n\n\trval = qla83xx_rd_reg(base_vha, QLA83XX_DRIVER_LOCKID, &n_drv_lockid);\n\tif (rval)\n\t\tgoto exit;\n\n\tif (o_drv_lockid == n_drv_lockid) {\n\t\tqla83xx_wait_logic();\n\t\tgoto retry_lockid;\n\t} else\n\t\treturn QLA_SUCCESS;\n\nexit:\n\treturn rval;\n}\n\nvoid\nqla83xx_idc_lock(scsi_qla_host_t *base_vha, uint16_t requester_id)\n{\n\tuint32_t data;\n\tuint32_t lock_owner;\n\tstruct qla_hw_data *ha = base_vha->hw;\n\n\t/* IDC-lock implementation using driver-lock/lock-id remote registers */\nretry_lock:\n\tif (qla83xx_rd_reg(base_vha, QLA83XX_DRIVER_LOCK, &data)\n\t    == QLA_SUCCESS) {\n\t\tif (data) {\n\t\t\t/* Setting lock-id to our function-number */\n\t\t\tqla83xx_wr_reg(base_vha, QLA83XX_DRIVER_LOCKID,\n\t\t\t    ha->portnum);\n\t\t} else {\n\t\t\tqla83xx_rd_reg(base_vha, QLA83XX_DRIVER_LOCKID,\n\t\t\t    &lock_owner);\n\t\t\tql_dbg(ql_dbg_p3p, base_vha, 0xb063,\n\t\t\t    \"Failed to acquire IDC lock, acquired by %d, \"\n\t\t\t    \"retrying...\\n\", lock_owner);\n\n\t\t\t/* Retry/Perform IDC-Lock recovery */\n\t\t\tif (qla83xx_idc_lock_recovery(base_vha)\n\t\t\t    == QLA_SUCCESS) {\n\t\t\t\tqla83xx_wait_logic();\n\t\t\t\tgoto retry_lock;\n\t\t\t} else\n\t\t\t\tql_log(ql_log_warn, base_vha, 0xb075,\n\t\t\t\t    \"IDC Lock recovery FAILED.\\n\");\n\t\t}\n\n\t}\n\n\treturn;\n}\n\nstatic bool\nqla25xx_rdp_rsp_reduce_size(struct scsi_qla_host *vha,\n\tstruct purex_entry_24xx *purex)\n{\n\tchar fwstr[16];\n\tu32 sid = purex->s_id[2] << 16 | purex->s_id[1] << 8 | purex->s_id[0];\n\tstruct port_database_24xx *pdb;\n\n\t/* Domain Controller is always logged-out. */\n\t/* if RDP request is not from Domain Controller: */\n\tif (sid != 0xfffc01)\n\t\treturn false;\n\n\tql_dbg(ql_dbg_init, vha, 0x0181, \"%s: s_id=%#x\\n\", __func__, sid);\n\n\tpdb = kzalloc(sizeof(*pdb), GFP_KERNEL);\n\tif (!pdb) {\n\t\tql_dbg(ql_dbg_init, vha, 0x0181,\n\t\t    \"%s: Failed allocate pdb\\n\", __func__);\n\t} else if (qla24xx_get_port_database(vha,\n\t\t\t\tle16_to_cpu(purex->nport_handle), pdb)) {\n\t\tql_dbg(ql_dbg_init, vha, 0x0181,\n\t\t    \"%s: Failed get pdb sid=%x\\n\", __func__, sid);\n\t} else if (pdb->current_login_state != PDS_PLOGI_COMPLETE &&\n\t    pdb->current_login_state != PDS_PRLI_COMPLETE) {\n\t\tql_dbg(ql_dbg_init, vha, 0x0181,\n\t\t    \"%s: Port not logged in sid=%#x\\n\", __func__, sid);\n\t} else {\n\t\t/* RDP request is from logged in port */\n\t\tkfree(pdb);\n\t\treturn false;\n\t}\n\tkfree(pdb);\n\n\tvha->hw->isp_ops->fw_version_str(vha, fwstr, sizeof(fwstr));\n\tfwstr[strcspn(fwstr, \" \")] = 0;\n\t/* if FW version allows RDP response length upto 2048 bytes: */\n\tif (strcmp(fwstr, \"8.09.00\") > 0 || strcmp(fwstr, \"8.05.65\") == 0)\n\t\treturn false;\n\n\tql_dbg(ql_dbg_init, vha, 0x0181, \"%s: fw=%s\\n\", __func__, fwstr);\n\n\t/* RDP response length is to be reduced to maximum 256 bytes */\n\treturn true;\n}\n\n/*\n * Function Name: qla24xx_process_purex_iocb\n *\n * Description:\n * Prepare a RDP response and send to Fabric switch\n *\n * PARAMETERS:\n * vha:\tSCSI qla host\n * purex: RDP request received by HBA\n */\nvoid qla24xx_process_purex_rdp(struct scsi_qla_host *vha,\n\t\t\t       struct purex_item *item)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct purex_entry_24xx *purex =\n\t    (struct purex_entry_24xx *)&item->iocb;\n\tdma_addr_t rsp_els_dma;\n\tdma_addr_t rsp_payload_dma;\n\tdma_addr_t stat_dma;\n\tdma_addr_t sfp_dma;\n\tstruct els_entry_24xx *rsp_els = NULL;\n\tstruct rdp_rsp_payload *rsp_payload = NULL;\n\tstruct link_statistics *stat = NULL;\n\tuint8_t *sfp = NULL;\n\tuint16_t sfp_flags = 0;\n\tuint rsp_payload_length = sizeof(*rsp_payload);\n\tint rval;\n\n\tql_dbg(ql_dbg_init + ql_dbg_verbose, vha, 0x0180,\n\t    \"%s: Enter\\n\", __func__);\n\n\tql_dbg(ql_dbg_init + ql_dbg_verbose, vha, 0x0181,\n\t    \"-------- ELS REQ -------\\n\");\n\tql_dump_buffer(ql_dbg_init + ql_dbg_verbose, vha, 0x0182,\n\t    purex, sizeof(*purex));\n\n\tif (qla25xx_rdp_rsp_reduce_size(vha, purex)) {\n\t\trsp_payload_length =\n\t\t    offsetof(typeof(*rsp_payload), optical_elmt_desc);\n\t\tql_dbg(ql_dbg_init, vha, 0x0181,\n\t\t    \"Reducing RSP payload length to %u bytes...\\n\",\n\t\t    rsp_payload_length);\n\t}\n\n\trsp_els = dma_alloc_coherent(&ha->pdev->dev, sizeof(*rsp_els),\n\t    &rsp_els_dma, GFP_KERNEL);\n\tif (!rsp_els) {\n\t\tql_log(ql_log_warn, vha, 0x0183,\n\t\t    \"Failed allocate dma buffer ELS RSP.\\n\");\n\t\tgoto dealloc;\n\t}\n\n\trsp_payload = dma_alloc_coherent(&ha->pdev->dev, sizeof(*rsp_payload),\n\t    &rsp_payload_dma, GFP_KERNEL);\n\tif (!rsp_payload) {\n\t\tql_log(ql_log_warn, vha, 0x0184,\n\t\t    \"Failed allocate dma buffer ELS RSP payload.\\n\");\n\t\tgoto dealloc;\n\t}\n\n\tsfp = dma_alloc_coherent(&ha->pdev->dev, SFP_RTDI_LEN,\n\t    &sfp_dma, GFP_KERNEL);\n\n\tstat = dma_alloc_coherent(&ha->pdev->dev, sizeof(*stat),\n\t    &stat_dma, GFP_KERNEL);\n\n\t/* Prepare Response IOCB */\n\trsp_els->entry_type = ELS_IOCB_TYPE;\n\trsp_els->entry_count = 1;\n\trsp_els->sys_define = 0;\n\trsp_els->entry_status = 0;\n\trsp_els->handle = 0;\n\trsp_els->nport_handle = purex->nport_handle;\n\trsp_els->tx_dsd_count = cpu_to_le16(1);\n\trsp_els->vp_index = purex->vp_idx;\n\trsp_els->sof_type = EST_SOFI3;\n\trsp_els->rx_xchg_address = purex->rx_xchg_addr;\n\trsp_els->rx_dsd_count = 0;\n\trsp_els->opcode = purex->els_frame_payload[0];\n\n\trsp_els->d_id[0] = purex->s_id[0];\n\trsp_els->d_id[1] = purex->s_id[1];\n\trsp_els->d_id[2] = purex->s_id[2];\n\n\trsp_els->control_flags = cpu_to_le16(EPD_ELS_ACC);\n\trsp_els->rx_byte_count = 0;\n\trsp_els->tx_byte_count = cpu_to_le32(rsp_payload_length);\n\n\tput_unaligned_le64(rsp_payload_dma, &rsp_els->tx_address);\n\trsp_els->tx_len = rsp_els->tx_byte_count;\n\n\trsp_els->rx_address = 0;\n\trsp_els->rx_len = 0;\n\n\t/* Prepare Response Payload */\n\trsp_payload->hdr.cmd = cpu_to_be32(0x2 << 24); /* LS_ACC */\n\trsp_payload->hdr.len = cpu_to_be32(le32_to_cpu(rsp_els->tx_byte_count) -\n\t\t\t\t\t   sizeof(rsp_payload->hdr));\n\n\t/* Link service Request Info Descriptor */\n\trsp_payload->ls_req_info_desc.desc_tag = cpu_to_be32(0x1);\n\trsp_payload->ls_req_info_desc.desc_len =\n\t    cpu_to_be32(RDP_DESC_LEN(rsp_payload->ls_req_info_desc));\n\trsp_payload->ls_req_info_desc.req_payload_word_0 =\n\t    cpu_to_be32p((uint32_t *)purex->els_frame_payload);\n\n\t/* Link service Request Info Descriptor 2 */\n\trsp_payload->ls_req_info_desc2.desc_tag = cpu_to_be32(0x1);\n\trsp_payload->ls_req_info_desc2.desc_len =\n\t    cpu_to_be32(RDP_DESC_LEN(rsp_payload->ls_req_info_desc2));\n\trsp_payload->ls_req_info_desc2.req_payload_word_0 =\n\t    cpu_to_be32p((uint32_t *)purex->els_frame_payload);\n\n\n\trsp_payload->sfp_diag_desc.desc_tag = cpu_to_be32(0x10000);\n\trsp_payload->sfp_diag_desc.desc_len =\n\t\tcpu_to_be32(RDP_DESC_LEN(rsp_payload->sfp_diag_desc));\n\n\tif (sfp) {\n\t\t/* SFP Flags */\n\t\tmemset(sfp, 0, SFP_RTDI_LEN);\n\t\trval = qla2x00_read_sfp(vha, sfp_dma, sfp, 0xa0, 0x7, 2, 0);\n\t\tif (!rval) {\n\t\t\t/* SFP Flags bits 3-0: Port Tx Laser Type */\n\t\t\tif (sfp[0] & BIT_2 || sfp[1] & (BIT_6|BIT_5))\n\t\t\t\tsfp_flags |= BIT_0; /* short wave */\n\t\t\telse if (sfp[0] & BIT_1)\n\t\t\t\tsfp_flags |= BIT_1; /* long wave 1310nm */\n\t\t\telse if (sfp[1] & BIT_4)\n\t\t\t\tsfp_flags |= BIT_1|BIT_0; /* long wave 1550nm */\n\t\t}\n\n\t\t/* SFP Type */\n\t\tmemset(sfp, 0, SFP_RTDI_LEN);\n\t\trval = qla2x00_read_sfp(vha, sfp_dma, sfp, 0xa0, 0x0, 1, 0);\n\t\tif (!rval) {\n\t\t\tsfp_flags |= BIT_4; /* optical */\n\t\t\tif (sfp[0] == 0x3)\n\t\t\t\tsfp_flags |= BIT_6; /* sfp+ */\n\t\t}\n\n\t\trsp_payload->sfp_diag_desc.sfp_flags = cpu_to_be16(sfp_flags);\n\n\t\t/* SFP Diagnostics */\n\t\tmemset(sfp, 0, SFP_RTDI_LEN);\n\t\trval = qla2x00_read_sfp(vha, sfp_dma, sfp, 0xa2, 0x60, 10, 0);\n\t\tif (!rval) {\n\t\t\t__be16 *trx = (__force __be16 *)sfp; /* already be16 */\n\t\t\trsp_payload->sfp_diag_desc.temperature = trx[0];\n\t\t\trsp_payload->sfp_diag_desc.vcc = trx[1];\n\t\t\trsp_payload->sfp_diag_desc.tx_bias = trx[2];\n\t\t\trsp_payload->sfp_diag_desc.tx_power = trx[3];\n\t\t\trsp_payload->sfp_diag_desc.rx_power = trx[4];\n\t\t}\n\t}\n\n\t/* Port Speed Descriptor */\n\trsp_payload->port_speed_desc.desc_tag = cpu_to_be32(0x10001);\n\trsp_payload->port_speed_desc.desc_len =\n\t    cpu_to_be32(RDP_DESC_LEN(rsp_payload->port_speed_desc));\n\trsp_payload->port_speed_desc.speed_capab = cpu_to_be16(\n\t    qla25xx_fdmi_port_speed_capability(ha));\n\trsp_payload->port_speed_desc.operating_speed = cpu_to_be16(\n\t    qla25xx_fdmi_port_speed_currently(ha));\n\n\t/* Link Error Status Descriptor */\n\trsp_payload->ls_err_desc.desc_tag = cpu_to_be32(0x10002);\n\trsp_payload->ls_err_desc.desc_len =\n\t\tcpu_to_be32(RDP_DESC_LEN(rsp_payload->ls_err_desc));\n\n\tif (stat) {\n\t\trval = qla24xx_get_isp_stats(vha, stat, stat_dma, 0);\n\t\tif (!rval) {\n\t\t\trsp_payload->ls_err_desc.link_fail_cnt =\n\t\t\t    cpu_to_be32(le32_to_cpu(stat->link_fail_cnt));\n\t\t\trsp_payload->ls_err_desc.loss_sync_cnt =\n\t\t\t    cpu_to_be32(le32_to_cpu(stat->loss_sync_cnt));\n\t\t\trsp_payload->ls_err_desc.loss_sig_cnt =\n\t\t\t    cpu_to_be32(le32_to_cpu(stat->loss_sig_cnt));\n\t\t\trsp_payload->ls_err_desc.prim_seq_err_cnt =\n\t\t\t    cpu_to_be32(le32_to_cpu(stat->prim_seq_err_cnt));\n\t\t\trsp_payload->ls_err_desc.inval_xmit_word_cnt =\n\t\t\t    cpu_to_be32(le32_to_cpu(stat->inval_xmit_word_cnt));\n\t\t\trsp_payload->ls_err_desc.inval_crc_cnt =\n\t\t\t    cpu_to_be32(le32_to_cpu(stat->inval_crc_cnt));\n\t\t\trsp_payload->ls_err_desc.pn_port_phy_type |= BIT_6;\n\t\t}\n\t}\n\n\t/* Portname Descriptor */\n\trsp_payload->port_name_diag_desc.desc_tag = cpu_to_be32(0x10003);\n\trsp_payload->port_name_diag_desc.desc_len =\n\t    cpu_to_be32(RDP_DESC_LEN(rsp_payload->port_name_diag_desc));\n\tmemcpy(rsp_payload->port_name_diag_desc.WWNN,\n\t    vha->node_name,\n\t    sizeof(rsp_payload->port_name_diag_desc.WWNN));\n\tmemcpy(rsp_payload->port_name_diag_desc.WWPN,\n\t    vha->port_name,\n\t    sizeof(rsp_payload->port_name_diag_desc.WWPN));\n\n\t/* F-Port Portname Descriptor */\n\trsp_payload->port_name_direct_desc.desc_tag = cpu_to_be32(0x10003);\n\trsp_payload->port_name_direct_desc.desc_len =\n\t    cpu_to_be32(RDP_DESC_LEN(rsp_payload->port_name_direct_desc));\n\tmemcpy(rsp_payload->port_name_direct_desc.WWNN,\n\t    vha->fabric_node_name,\n\t    sizeof(rsp_payload->port_name_direct_desc.WWNN));\n\tmemcpy(rsp_payload->port_name_direct_desc.WWPN,\n\t    vha->fabric_port_name,\n\t    sizeof(rsp_payload->port_name_direct_desc.WWPN));\n\n\t/* Bufer Credit Descriptor */\n\trsp_payload->buffer_credit_desc.desc_tag = cpu_to_be32(0x10006);\n\trsp_payload->buffer_credit_desc.desc_len =\n\t\tcpu_to_be32(RDP_DESC_LEN(rsp_payload->buffer_credit_desc));\n\trsp_payload->buffer_credit_desc.fcport_b2b = 0;\n\trsp_payload->buffer_credit_desc.attached_fcport_b2b = cpu_to_be32(0);\n\trsp_payload->buffer_credit_desc.fcport_rtt = cpu_to_be32(0);\n\n\tif (ha->flags.plogi_template_valid) {\n\t\tuint32_t tmp =\n\t\tbe16_to_cpu(ha->plogi_els_payld.fl_csp.sp_bb_cred);\n\t\trsp_payload->buffer_credit_desc.fcport_b2b = cpu_to_be32(tmp);\n\t}\n\n\tif (rsp_payload_length < sizeof(*rsp_payload))\n\t\tgoto send;\n\n\t/* Optical Element Descriptor, Temperature */\n\trsp_payload->optical_elmt_desc[0].desc_tag = cpu_to_be32(0x10007);\n\trsp_payload->optical_elmt_desc[0].desc_len =\n\t\tcpu_to_be32(RDP_DESC_LEN(*rsp_payload->optical_elmt_desc));\n\t/* Optical Element Descriptor, Voltage */\n\trsp_payload->optical_elmt_desc[1].desc_tag = cpu_to_be32(0x10007);\n\trsp_payload->optical_elmt_desc[1].desc_len =\n\t\tcpu_to_be32(RDP_DESC_LEN(*rsp_payload->optical_elmt_desc));\n\t/* Optical Element Descriptor, Tx Bias Current */\n\trsp_payload->optical_elmt_desc[2].desc_tag = cpu_to_be32(0x10007);\n\trsp_payload->optical_elmt_desc[2].desc_len =\n\t\tcpu_to_be32(RDP_DESC_LEN(*rsp_payload->optical_elmt_desc));\n\t/* Optical Element Descriptor, Tx Power */\n\trsp_payload->optical_elmt_desc[3].desc_tag = cpu_to_be32(0x10007);\n\trsp_payload->optical_elmt_desc[3].desc_len =\n\t\tcpu_to_be32(RDP_DESC_LEN(*rsp_payload->optical_elmt_desc));\n\t/* Optical Element Descriptor, Rx Power */\n\trsp_payload->optical_elmt_desc[4].desc_tag = cpu_to_be32(0x10007);\n\trsp_payload->optical_elmt_desc[4].desc_len =\n\t\tcpu_to_be32(RDP_DESC_LEN(*rsp_payload->optical_elmt_desc));\n\n\tif (sfp) {\n\t\tmemset(sfp, 0, SFP_RTDI_LEN);\n\t\trval = qla2x00_read_sfp(vha, sfp_dma, sfp, 0xa2, 0, 64, 0);\n\t\tif (!rval) {\n\t\t\t__be16 *trx = (__force __be16 *)sfp; /* already be16 */\n\n\t\t\t/* Optical Element Descriptor, Temperature */\n\t\t\trsp_payload->optical_elmt_desc[0].high_alarm = trx[0];\n\t\t\trsp_payload->optical_elmt_desc[0].low_alarm = trx[1];\n\t\t\trsp_payload->optical_elmt_desc[0].high_warn = trx[2];\n\t\t\trsp_payload->optical_elmt_desc[0].low_warn = trx[3];\n\t\t\trsp_payload->optical_elmt_desc[0].element_flags =\n\t\t\t    cpu_to_be32(1 << 28);\n\n\t\t\t/* Optical Element Descriptor, Voltage */\n\t\t\trsp_payload->optical_elmt_desc[1].high_alarm = trx[4];\n\t\t\trsp_payload->optical_elmt_desc[1].low_alarm = trx[5];\n\t\t\trsp_payload->optical_elmt_desc[1].high_warn = trx[6];\n\t\t\trsp_payload->optical_elmt_desc[1].low_warn = trx[7];\n\t\t\trsp_payload->optical_elmt_desc[1].element_flags =\n\t\t\t    cpu_to_be32(2 << 28);\n\n\t\t\t/* Optical Element Descriptor, Tx Bias Current */\n\t\t\trsp_payload->optical_elmt_desc[2].high_alarm = trx[8];\n\t\t\trsp_payload->optical_elmt_desc[2].low_alarm = trx[9];\n\t\t\trsp_payload->optical_elmt_desc[2].high_warn = trx[10];\n\t\t\trsp_payload->optical_elmt_desc[2].low_warn = trx[11];\n\t\t\trsp_payload->optical_elmt_desc[2].element_flags =\n\t\t\t    cpu_to_be32(3 << 28);\n\n\t\t\t/* Optical Element Descriptor, Tx Power */\n\t\t\trsp_payload->optical_elmt_desc[3].high_alarm = trx[12];\n\t\t\trsp_payload->optical_elmt_desc[3].low_alarm = trx[13];\n\t\t\trsp_payload->optical_elmt_desc[3].high_warn = trx[14];\n\t\t\trsp_payload->optical_elmt_desc[3].low_warn = trx[15];\n\t\t\trsp_payload->optical_elmt_desc[3].element_flags =\n\t\t\t    cpu_to_be32(4 << 28);\n\n\t\t\t/* Optical Element Descriptor, Rx Power */\n\t\t\trsp_payload->optical_elmt_desc[4].high_alarm = trx[16];\n\t\t\trsp_payload->optical_elmt_desc[4].low_alarm = trx[17];\n\t\t\trsp_payload->optical_elmt_desc[4].high_warn = trx[18];\n\t\t\trsp_payload->optical_elmt_desc[4].low_warn = trx[19];\n\t\t\trsp_payload->optical_elmt_desc[4].element_flags =\n\t\t\t    cpu_to_be32(5 << 28);\n\t\t}\n\n\t\tmemset(sfp, 0, SFP_RTDI_LEN);\n\t\trval = qla2x00_read_sfp(vha, sfp_dma, sfp, 0xa2, 112, 64, 0);\n\t\tif (!rval) {\n\t\t\t/* Temperature high/low alarm/warning */\n\t\t\trsp_payload->optical_elmt_desc[0].element_flags |=\n\t\t\t    cpu_to_be32(\n\t\t\t\t(sfp[0] >> 7 & 1) << 3 |\n\t\t\t\t(sfp[0] >> 6 & 1) << 2 |\n\t\t\t\t(sfp[4] >> 7 & 1) << 1 |\n\t\t\t\t(sfp[4] >> 6 & 1) << 0);\n\n\t\t\t/* Voltage high/low alarm/warning */\n\t\t\trsp_payload->optical_elmt_desc[1].element_flags |=\n\t\t\t    cpu_to_be32(\n\t\t\t\t(sfp[0] >> 5 & 1) << 3 |\n\t\t\t\t(sfp[0] >> 4 & 1) << 2 |\n\t\t\t\t(sfp[4] >> 5 & 1) << 1 |\n\t\t\t\t(sfp[4] >> 4 & 1) << 0);\n\n\t\t\t/* Tx Bias Current high/low alarm/warning */\n\t\t\trsp_payload->optical_elmt_desc[2].element_flags |=\n\t\t\t    cpu_to_be32(\n\t\t\t\t(sfp[0] >> 3 & 1) << 3 |\n\t\t\t\t(sfp[0] >> 2 & 1) << 2 |\n\t\t\t\t(sfp[4] >> 3 & 1) << 1 |\n\t\t\t\t(sfp[4] >> 2 & 1) << 0);\n\n\t\t\t/* Tx Power high/low alarm/warning */\n\t\t\trsp_payload->optical_elmt_desc[3].element_flags |=\n\t\t\t    cpu_to_be32(\n\t\t\t\t(sfp[0] >> 1 & 1) << 3 |\n\t\t\t\t(sfp[0] >> 0 & 1) << 2 |\n\t\t\t\t(sfp[4] >> 1 & 1) << 1 |\n\t\t\t\t(sfp[4] >> 0 & 1) << 0);\n\n\t\t\t/* Rx Power high/low alarm/warning */\n\t\t\trsp_payload->optical_elmt_desc[4].element_flags |=\n\t\t\t    cpu_to_be32(\n\t\t\t\t(sfp[1] >> 7 & 1) << 3 |\n\t\t\t\t(sfp[1] >> 6 & 1) << 2 |\n\t\t\t\t(sfp[5] >> 7 & 1) << 1 |\n\t\t\t\t(sfp[5] >> 6 & 1) << 0);\n\t\t}\n\t}\n\n\t/* Optical Product Data Descriptor */\n\trsp_payload->optical_prod_desc.desc_tag = cpu_to_be32(0x10008);\n\trsp_payload->optical_prod_desc.desc_len =\n\t\tcpu_to_be32(RDP_DESC_LEN(rsp_payload->optical_prod_desc));\n\n\tif (sfp) {\n\t\tmemset(sfp, 0, SFP_RTDI_LEN);\n\t\trval = qla2x00_read_sfp(vha, sfp_dma, sfp, 0xa0, 20, 64, 0);\n\t\tif (!rval) {\n\t\t\tmemcpy(rsp_payload->optical_prod_desc.vendor_name,\n\t\t\t    sfp + 0,\n\t\t\t    sizeof(rsp_payload->optical_prod_desc.vendor_name));\n\t\t\tmemcpy(rsp_payload->optical_prod_desc.part_number,\n\t\t\t    sfp + 20,\n\t\t\t    sizeof(rsp_payload->optical_prod_desc.part_number));\n\t\t\tmemcpy(rsp_payload->optical_prod_desc.revision,\n\t\t\t    sfp + 36,\n\t\t\t    sizeof(rsp_payload->optical_prod_desc.revision));\n\t\t\tmemcpy(rsp_payload->optical_prod_desc.serial_number,\n\t\t\t    sfp + 48,\n\t\t\t    sizeof(rsp_payload->optical_prod_desc.serial_number));\n\t\t}\n\n\t\tmemset(sfp, 0, SFP_RTDI_LEN);\n\t\trval = qla2x00_read_sfp(vha, sfp_dma, sfp, 0xa0, 84, 8, 0);\n\t\tif (!rval) {\n\t\t\tmemcpy(rsp_payload->optical_prod_desc.date,\n\t\t\t    sfp + 0,\n\t\t\t    sizeof(rsp_payload->optical_prod_desc.date));\n\t\t}\n\t}\n\nsend:\n\tql_dbg(ql_dbg_init, vha, 0x0183,\n\t    \"Sending ELS Response to RDP Request...\\n\");\n\tql_dbg(ql_dbg_init + ql_dbg_verbose, vha, 0x0184,\n\t    \"-------- ELS RSP -------\\n\");\n\tql_dump_buffer(ql_dbg_init + ql_dbg_verbose, vha, 0x0185,\n\t    rsp_els, sizeof(*rsp_els));\n\tql_dbg(ql_dbg_init + ql_dbg_verbose, vha, 0x0186,\n\t    \"-------- ELS RSP PAYLOAD -------\\n\");\n\tql_dump_buffer(ql_dbg_init + ql_dbg_verbose, vha, 0x0187,\n\t    rsp_payload, rsp_payload_length);\n\n\trval = qla2x00_issue_iocb(vha, rsp_els, rsp_els_dma, 0);\n\n\tif (rval) {\n\t\tql_log(ql_log_warn, vha, 0x0188,\n\t\t    \"%s: iocb failed to execute -> %x\\n\", __func__, rval);\n\t} else if (rsp_els->comp_status) {\n\t\tql_log(ql_log_warn, vha, 0x0189,\n\t\t    \"%s: iocb failed to complete -> completion=%#x subcode=(%#x,%#x)\\n\",\n\t\t    __func__, rsp_els->comp_status,\n\t\t    rsp_els->error_subcode_1, rsp_els->error_subcode_2);\n\t} else {\n\t\tql_dbg(ql_dbg_init, vha, 0x018a, \"%s: done.\\n\", __func__);\n\t}\n\ndealloc:\n\tif (stat)\n\t\tdma_free_coherent(&ha->pdev->dev, sizeof(*stat),\n\t\t    stat, stat_dma);\n\tif (sfp)\n\t\tdma_free_coherent(&ha->pdev->dev, SFP_RTDI_LEN,\n\t\t    sfp, sfp_dma);\n\tif (rsp_payload)\n\t\tdma_free_coherent(&ha->pdev->dev, sizeof(*rsp_payload),\n\t\t    rsp_payload, rsp_payload_dma);\n\tif (rsp_els)\n\t\tdma_free_coherent(&ha->pdev->dev, sizeof(*rsp_els),\n\t\t    rsp_els, rsp_els_dma);\n}\n\nvoid\nqla24xx_free_purex_item(struct purex_item *item)\n{\n\tif (item == &item->vha->default_item)\n\t\tmemset(&item->vha->default_item, 0, sizeof(struct purex_item));\n\telse\n\t\tkfree(item);\n}\n\nvoid qla24xx_process_purex_list(struct purex_list *list)\n{\n\tstruct list_head head = LIST_HEAD_INIT(head);\n\tstruct purex_item *item, *next;\n\tulong flags;\n\n\tspin_lock_irqsave(&list->lock, flags);\n\tlist_splice_init(&list->head, &head);\n\tspin_unlock_irqrestore(&list->lock, flags);\n\n\tlist_for_each_entry_safe(item, next, &head, list) {\n\t\tlist_del(&item->list);\n\t\titem->process_item(item->vha, item);\n\t\tqla24xx_free_purex_item(item);\n\t}\n}\n\nvoid\nqla83xx_idc_unlock(scsi_qla_host_t *base_vha, uint16_t requester_id)\n{\n#if 0\n\tuint16_t options = (requester_id << 15) | BIT_7;\n#endif\n\tuint16_t retry;\n\tuint32_t data;\n\tstruct qla_hw_data *ha = base_vha->hw;\n\n\t/* IDC-unlock implementation using driver-unlock/lock-id\n\t * remote registers\n\t */\n\tretry = 0;\nretry_unlock:\n\tif (qla83xx_rd_reg(base_vha, QLA83XX_DRIVER_LOCKID, &data)\n\t    == QLA_SUCCESS) {\n\t\tif (data == ha->portnum) {\n\t\t\tqla83xx_rd_reg(base_vha, QLA83XX_DRIVER_UNLOCK, &data);\n\t\t\t/* Clearing lock-id by setting 0xff */\n\t\t\tqla83xx_wr_reg(base_vha, QLA83XX_DRIVER_LOCKID, 0xff);\n\t\t} else if (retry < 10) {\n\t\t\t/* SV: XXX: IDC unlock retrying needed here? */\n\n\t\t\t/* Retry for IDC-unlock */\n\t\t\tqla83xx_wait_logic();\n\t\t\tretry++;\n\t\t\tql_dbg(ql_dbg_p3p, base_vha, 0xb064,\n\t\t\t    \"Failed to release IDC lock, retrying=%d\\n\", retry);\n\t\t\tgoto retry_unlock;\n\t\t}\n\t} else if (retry < 10) {\n\t\t/* Retry for IDC-unlock */\n\t\tqla83xx_wait_logic();\n\t\tretry++;\n\t\tql_dbg(ql_dbg_p3p, base_vha, 0xb065,\n\t\t    \"Failed to read drv-lockid, retrying=%d\\n\", retry);\n\t\tgoto retry_unlock;\n\t}\n\n\treturn;\n\n#if 0\n\t/* XXX: IDC-unlock implementation using access-control mbx */\n\tretry = 0;\nretry_unlock2:\n\tif (qla83xx_access_control(base_vha, options, 0, 0, NULL)) {\n\t\tif (retry < 10) {\n\t\t\t/* Retry for IDC-unlock */\n\t\t\tqla83xx_wait_logic();\n\t\t\tretry++;\n\t\t\tql_dbg(ql_dbg_p3p, base_vha, 0xb066,\n\t\t\t    \"Failed to release IDC lock, retrying=%d\\n\", retry);\n\t\t\tgoto retry_unlock2;\n\t\t}\n\t}\n\n\treturn;\n#endif\n}\n\nint\n__qla83xx_set_drv_presence(scsi_qla_host_t *vha)\n{\n\tint rval = QLA_SUCCESS;\n\tstruct qla_hw_data *ha = vha->hw;\n\tuint32_t drv_presence;\n\n\trval = qla83xx_rd_reg(vha, QLA83XX_IDC_DRV_PRESENCE, &drv_presence);\n\tif (rval == QLA_SUCCESS) {\n\t\tdrv_presence |= (1 << ha->portnum);\n\t\trval = qla83xx_wr_reg(vha, QLA83XX_IDC_DRV_PRESENCE,\n\t\t    drv_presence);\n\t}\n\n\treturn rval;\n}\n\nint\nqla83xx_set_drv_presence(scsi_qla_host_t *vha)\n{\n\tint rval = QLA_SUCCESS;\n\n\tqla83xx_idc_lock(vha, 0);\n\trval = __qla83xx_set_drv_presence(vha);\n\tqla83xx_idc_unlock(vha, 0);\n\n\treturn rval;\n}\n\nint\n__qla83xx_clear_drv_presence(scsi_qla_host_t *vha)\n{\n\tint rval = QLA_SUCCESS;\n\tstruct qla_hw_data *ha = vha->hw;\n\tuint32_t drv_presence;\n\n\trval = qla83xx_rd_reg(vha, QLA83XX_IDC_DRV_PRESENCE, &drv_presence);\n\tif (rval == QLA_SUCCESS) {\n\t\tdrv_presence &= ~(1 << ha->portnum);\n\t\trval = qla83xx_wr_reg(vha, QLA83XX_IDC_DRV_PRESENCE,\n\t\t    drv_presence);\n\t}\n\n\treturn rval;\n}\n\nint\nqla83xx_clear_drv_presence(scsi_qla_host_t *vha)\n{\n\tint rval = QLA_SUCCESS;\n\n\tqla83xx_idc_lock(vha, 0);\n\trval = __qla83xx_clear_drv_presence(vha);\n\tqla83xx_idc_unlock(vha, 0);\n\n\treturn rval;\n}\n\nstatic void\nqla83xx_need_reset_handler(scsi_qla_host_t *vha)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tuint32_t drv_ack, drv_presence;\n\tunsigned long ack_timeout;\n\n\t/* Wait for IDC ACK from all functions (DRV-ACK == DRV-PRESENCE) */\n\tack_timeout = jiffies + (ha->fcoe_reset_timeout * HZ);\n\twhile (1) {\n\t\tqla83xx_rd_reg(vha, QLA83XX_IDC_DRIVER_ACK, &drv_ack);\n\t\tqla83xx_rd_reg(vha, QLA83XX_IDC_DRV_PRESENCE, &drv_presence);\n\t\tif ((drv_ack & drv_presence) == drv_presence)\n\t\t\tbreak;\n\n\t\tif (time_after_eq(jiffies, ack_timeout)) {\n\t\t\tql_log(ql_log_warn, vha, 0xb067,\n\t\t\t    \"RESET ACK TIMEOUT! drv_presence=0x%x \"\n\t\t\t    \"drv_ack=0x%x\\n\", drv_presence, drv_ack);\n\t\t\t/*\n\t\t\t * The function(s) which did not ack in time are forced\n\t\t\t * to withdraw any further participation in the IDC\n\t\t\t * reset.\n\t\t\t */\n\t\t\tif (drv_ack != drv_presence)\n\t\t\t\tqla83xx_wr_reg(vha, QLA83XX_IDC_DRV_PRESENCE,\n\t\t\t\t    drv_ack);\n\t\t\tbreak;\n\t\t}\n\n\t\tqla83xx_idc_unlock(vha, 0);\n\t\tmsleep(1000);\n\t\tqla83xx_idc_lock(vha, 0);\n\t}\n\n\tqla83xx_wr_reg(vha, QLA83XX_IDC_DEV_STATE, QLA8XXX_DEV_COLD);\n\tql_log(ql_log_info, vha, 0xb068, \"HW State: COLD/RE-INIT.\\n\");\n}\n\nstatic int\nqla83xx_device_bootstrap(scsi_qla_host_t *vha)\n{\n\tint rval = QLA_SUCCESS;\n\tuint32_t idc_control;\n\n\tqla83xx_wr_reg(vha, QLA83XX_IDC_DEV_STATE, QLA8XXX_DEV_INITIALIZING);\n\tql_log(ql_log_info, vha, 0xb069, \"HW State: INITIALIZING.\\n\");\n\n\t/* Clearing IDC-Control Graceful-Reset Bit before resetting f/w */\n\t__qla83xx_get_idc_control(vha, &idc_control);\n\tidc_control &= ~QLA83XX_IDC_GRACEFUL_RESET;\n\t__qla83xx_set_idc_control(vha, 0);\n\n\tqla83xx_idc_unlock(vha, 0);\n\trval = qla83xx_restart_nic_firmware(vha);\n\tqla83xx_idc_lock(vha, 0);\n\n\tif (rval != QLA_SUCCESS) {\n\t\tql_log(ql_log_fatal, vha, 0xb06a,\n\t\t    \"Failed to restart NIC f/w.\\n\");\n\t\tqla83xx_wr_reg(vha, QLA83XX_IDC_DEV_STATE, QLA8XXX_DEV_FAILED);\n\t\tql_log(ql_log_info, vha, 0xb06b, \"HW State: FAILED.\\n\");\n\t} else {\n\t\tql_dbg(ql_dbg_p3p, vha, 0xb06c,\n\t\t    \"Success in restarting nic f/w.\\n\");\n\t\tqla83xx_wr_reg(vha, QLA83XX_IDC_DEV_STATE, QLA8XXX_DEV_READY);\n\t\tql_log(ql_log_info, vha, 0xb06d, \"HW State: READY.\\n\");\n\t}\n\n\treturn rval;\n}\n\n/* Assumes idc_lock always held on entry */\nint\nqla83xx_idc_state_handler(scsi_qla_host_t *base_vha)\n{\n\tstruct qla_hw_data *ha = base_vha->hw;\n\tint rval = QLA_SUCCESS;\n\tunsigned long dev_init_timeout;\n\tuint32_t dev_state;\n\n\t/* Wait for MAX-INIT-TIMEOUT for the device to go ready */\n\tdev_init_timeout = jiffies + (ha->fcoe_dev_init_timeout * HZ);\n\n\twhile (1) {\n\n\t\tif (time_after_eq(jiffies, dev_init_timeout)) {\n\t\t\tql_log(ql_log_warn, base_vha, 0xb06e,\n\t\t\t    \"Initialization TIMEOUT!\\n\");\n\t\t\t/* Init timeout. Disable further NIC Core\n\t\t\t * communication.\n\t\t\t */\n\t\t\tqla83xx_wr_reg(base_vha, QLA83XX_IDC_DEV_STATE,\n\t\t\t\tQLA8XXX_DEV_FAILED);\n\t\t\tql_log(ql_log_info, base_vha, 0xb06f,\n\t\t\t    \"HW State: FAILED.\\n\");\n\t\t}\n\n\t\tqla83xx_rd_reg(base_vha, QLA83XX_IDC_DEV_STATE, &dev_state);\n\t\tswitch (dev_state) {\n\t\tcase QLA8XXX_DEV_READY:\n\t\t\tif (ha->flags.nic_core_reset_owner)\n\t\t\t\tqla83xx_idc_audit(base_vha,\n\t\t\t\t    IDC_AUDIT_COMPLETION);\n\t\t\tha->flags.nic_core_reset_owner = 0;\n\t\t\tql_dbg(ql_dbg_p3p, base_vha, 0xb070,\n\t\t\t    \"Reset_owner reset by 0x%x.\\n\",\n\t\t\t    ha->portnum);\n\t\t\tgoto exit;\n\t\tcase QLA8XXX_DEV_COLD:\n\t\t\tif (ha->flags.nic_core_reset_owner)\n\t\t\t\trval = qla83xx_device_bootstrap(base_vha);\n\t\t\telse {\n\t\t\t/* Wait for AEN to change device-state */\n\t\t\t\tqla83xx_idc_unlock(base_vha, 0);\n\t\t\t\tmsleep(1000);\n\t\t\t\tqla83xx_idc_lock(base_vha, 0);\n\t\t\t}\n\t\t\tbreak;\n\t\tcase QLA8XXX_DEV_INITIALIZING:\n\t\t\t/* Wait for AEN to change device-state */\n\t\t\tqla83xx_idc_unlock(base_vha, 0);\n\t\t\tmsleep(1000);\n\t\t\tqla83xx_idc_lock(base_vha, 0);\n\t\t\tbreak;\n\t\tcase QLA8XXX_DEV_NEED_RESET:\n\t\t\tif (!ql2xdontresethba && ha->flags.nic_core_reset_owner)\n\t\t\t\tqla83xx_need_reset_handler(base_vha);\n\t\t\telse {\n\t\t\t\t/* Wait for AEN to change device-state */\n\t\t\t\tqla83xx_idc_unlock(base_vha, 0);\n\t\t\t\tmsleep(1000);\n\t\t\t\tqla83xx_idc_lock(base_vha, 0);\n\t\t\t}\n\t\t\t/* reset timeout value after need reset handler */\n\t\t\tdev_init_timeout = jiffies +\n\t\t\t    (ha->fcoe_dev_init_timeout * HZ);\n\t\t\tbreak;\n\t\tcase QLA8XXX_DEV_NEED_QUIESCENT:\n\t\t\t/* XXX: DEBUG for now */\n\t\t\tqla83xx_idc_unlock(base_vha, 0);\n\t\t\tmsleep(1000);\n\t\t\tqla83xx_idc_lock(base_vha, 0);\n\t\t\tbreak;\n\t\tcase QLA8XXX_DEV_QUIESCENT:\n\t\t\t/* XXX: DEBUG for now */\n\t\t\tif (ha->flags.quiesce_owner)\n\t\t\t\tgoto exit;\n\n\t\t\tqla83xx_idc_unlock(base_vha, 0);\n\t\t\tmsleep(1000);\n\t\t\tqla83xx_idc_lock(base_vha, 0);\n\t\t\tdev_init_timeout = jiffies +\n\t\t\t    (ha->fcoe_dev_init_timeout * HZ);\n\t\t\tbreak;\n\t\tcase QLA8XXX_DEV_FAILED:\n\t\t\tif (ha->flags.nic_core_reset_owner)\n\t\t\t\tqla83xx_idc_audit(base_vha,\n\t\t\t\t    IDC_AUDIT_COMPLETION);\n\t\t\tha->flags.nic_core_reset_owner = 0;\n\t\t\t__qla83xx_clear_drv_presence(base_vha);\n\t\t\tqla83xx_idc_unlock(base_vha, 0);\n\t\t\tqla8xxx_dev_failed_handler(base_vha);\n\t\t\trval = QLA_FUNCTION_FAILED;\n\t\t\tqla83xx_idc_lock(base_vha, 0);\n\t\t\tgoto exit;\n\t\tcase QLA8XXX_BAD_VALUE:\n\t\t\tqla83xx_idc_unlock(base_vha, 0);\n\t\t\tmsleep(1000);\n\t\t\tqla83xx_idc_lock(base_vha, 0);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tql_log(ql_log_warn, base_vha, 0xb071,\n\t\t\t    \"Unknown Device State: %x.\\n\", dev_state);\n\t\t\tqla83xx_idc_unlock(base_vha, 0);\n\t\t\tqla8xxx_dev_failed_handler(base_vha);\n\t\t\trval = QLA_FUNCTION_FAILED;\n\t\t\tqla83xx_idc_lock(base_vha, 0);\n\t\t\tgoto exit;\n\t\t}\n\t}\n\nexit:\n\treturn rval;\n}\n\nvoid\nqla2x00_disable_board_on_pci_error(struct work_struct *work)\n{\n\tstruct qla_hw_data *ha = container_of(work, struct qla_hw_data,\n\t    board_disable);\n\tstruct pci_dev *pdev = ha->pdev;\n\tscsi_qla_host_t *base_vha = pci_get_drvdata(ha->pdev);\n\n\tql_log(ql_log_warn, base_vha, 0x015b,\n\t    \"Disabling adapter.\\n\");\n\n\tif (!atomic_read(&pdev->enable_cnt)) {\n\t\tql_log(ql_log_info, base_vha, 0xfffc,\n\t\t    \"PCI device disabled, no action req for PCI error=%lx\\n\",\n\t\t    base_vha->pci_flags);\n\t\treturn;\n\t}\n\n\t/*\n\t * if UNLOADING flag is already set, then continue unload,\n\t * where it was set first.\n\t */\n\tif (test_and_set_bit(UNLOADING, &base_vha->dpc_flags))\n\t\treturn;\n\n\tqla2x00_wait_for_sess_deletion(base_vha);\n\n\tqla2x00_delete_all_vps(ha, base_vha);\n\n\tqla2x00_abort_all_cmds(base_vha, DID_NO_CONNECT << 16);\n\n\tqla2x00_dfs_remove(base_vha);\n\n\tqla84xx_put_chip(base_vha);\n\n\tif (base_vha->timer_active)\n\t\tqla2x00_stop_timer(base_vha);\n\n\tbase_vha->flags.online = 0;\n\n\tqla2x00_destroy_deferred_work(ha);\n\n\t/*\n\t * Do not try to stop beacon blink as it will issue a mailbox\n\t * command.\n\t */\n\tqla2x00_free_sysfs_attr(base_vha, false);\n\n\tfc_remove_host(base_vha->host);\n\n\tscsi_remove_host(base_vha->host);\n\n\tbase_vha->flags.init_done = 0;\n\tqla25xx_delete_queues(base_vha);\n\tqla2x00_free_fcports(base_vha);\n\tqla2x00_free_irqs(base_vha);\n\tqla2x00_mem_free(ha);\n\tqla82xx_md_free(base_vha);\n\tqla2x00_free_queues(ha);\n\n\tqla2x00_unmap_iobases(ha);\n\n\tpci_release_selected_regions(ha->pdev, ha->bars);\n\tpci_disable_pcie_error_reporting(pdev);\n\tpci_disable_device(pdev);\n\n\t/*\n\t * Let qla2x00_remove_one cleanup qla_hw_data on device removal.\n\t */\n}\n\n/**************************************************************************\n* qla2x00_do_dpc\n*   This kernel thread is a task that is schedule by the interrupt handler\n*   to perform the background processing for interrupts.\n*\n* Notes:\n* This task always run in the context of a kernel thread.  It\n* is kick-off by the driver's detect code and starts up\n* up one per adapter. It immediately goes to sleep and waits for\n* some fibre event.  When either the interrupt handler or\n* the timer routine detects a event it will one of the task\n* bits then wake us up.\n**************************************************************************/\nstatic int\nqla2x00_do_dpc(void *data)\n{\n\tscsi_qla_host_t *base_vha;\n\tstruct qla_hw_data *ha;\n\tuint32_t online;\n\tstruct qla_qpair *qpair;\n\n\tha = (struct qla_hw_data *)data;\n\tbase_vha = pci_get_drvdata(ha->pdev);\n\n\tset_user_nice(current, MIN_NICE);\n\n\tset_current_state(TASK_INTERRUPTIBLE);\n\twhile (!kthread_should_stop()) {\n\t\tql_dbg(ql_dbg_dpc, base_vha, 0x4000,\n\t\t    \"DPC handler sleeping.\\n\");\n\n\t\tschedule();\n\n\t\tif (!base_vha->flags.init_done || ha->flags.mbox_busy)\n\t\t\tgoto end_loop;\n\n\t\tif (ha->flags.eeh_busy) {\n\t\t\tql_dbg(ql_dbg_dpc, base_vha, 0x4003,\n\t\t\t    \"eeh_busy=%d.\\n\", ha->flags.eeh_busy);\n\t\t\tgoto end_loop;\n\t\t}\n\n\t\tha->dpc_active = 1;\n\n\t\tql_dbg(ql_dbg_dpc + ql_dbg_verbose, base_vha, 0x4001,\n\t\t    \"DPC handler waking up, dpc_flags=0x%lx.\\n\",\n\t\t    base_vha->dpc_flags);\n\n\t\tif (test_bit(UNLOADING, &base_vha->dpc_flags))\n\t\t\tbreak;\n\n\t\tif (IS_P3P_TYPE(ha)) {\n\t\t\tif (IS_QLA8044(ha)) {\n\t\t\t\tif (test_and_clear_bit(ISP_UNRECOVERABLE,\n\t\t\t\t\t&base_vha->dpc_flags)) {\n\t\t\t\t\tqla8044_idc_lock(ha);\n\t\t\t\t\tqla8044_wr_direct(base_vha,\n\t\t\t\t\t\tQLA8044_CRB_DEV_STATE_INDEX,\n\t\t\t\t\t\tQLA8XXX_DEV_FAILED);\n\t\t\t\t\tqla8044_idc_unlock(ha);\n\t\t\t\t\tql_log(ql_log_info, base_vha, 0x4004,\n\t\t\t\t\t\t\"HW State: FAILED.\\n\");\n\t\t\t\t\tqla8044_device_state_handler(base_vha);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t} else {\n\t\t\t\tif (test_and_clear_bit(ISP_UNRECOVERABLE,\n\t\t\t\t\t&base_vha->dpc_flags)) {\n\t\t\t\t\tqla82xx_idc_lock(ha);\n\t\t\t\t\tqla82xx_wr_32(ha, QLA82XX_CRB_DEV_STATE,\n\t\t\t\t\t\tQLA8XXX_DEV_FAILED);\n\t\t\t\t\tqla82xx_idc_unlock(ha);\n\t\t\t\t\tql_log(ql_log_info, base_vha, 0x0151,\n\t\t\t\t\t\t\"HW State: FAILED.\\n\");\n\t\t\t\t\tqla82xx_device_state_handler(base_vha);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (test_and_clear_bit(FCOE_CTX_RESET_NEEDED,\n\t\t\t\t&base_vha->dpc_flags)) {\n\n\t\t\t\tql_dbg(ql_dbg_dpc, base_vha, 0x4005,\n\t\t\t\t    \"FCoE context reset scheduled.\\n\");\n\t\t\t\tif (!(test_and_set_bit(ABORT_ISP_ACTIVE,\n\t\t\t\t\t&base_vha->dpc_flags))) {\n\t\t\t\t\tif (qla82xx_fcoe_ctx_reset(base_vha)) {\n\t\t\t\t\t\t/* FCoE-ctx reset failed.\n\t\t\t\t\t\t * Escalate to chip-reset\n\t\t\t\t\t\t */\n\t\t\t\t\t\tset_bit(ISP_ABORT_NEEDED,\n\t\t\t\t\t\t\t&base_vha->dpc_flags);\n\t\t\t\t\t}\n\t\t\t\t\tclear_bit(ABORT_ISP_ACTIVE,\n\t\t\t\t\t\t&base_vha->dpc_flags);\n\t\t\t\t}\n\n\t\t\t\tql_dbg(ql_dbg_dpc, base_vha, 0x4006,\n\t\t\t\t    \"FCoE context reset end.\\n\");\n\t\t\t}\n\t\t} else if (IS_QLAFX00(ha)) {\n\t\t\tif (test_and_clear_bit(ISP_UNRECOVERABLE,\n\t\t\t\t&base_vha->dpc_flags)) {\n\t\t\t\tql_dbg(ql_dbg_dpc, base_vha, 0x4020,\n\t\t\t\t    \"Firmware Reset Recovery\\n\");\n\t\t\t\tif (qlafx00_reset_initialize(base_vha)) {\n\t\t\t\t\t/* Failed. Abort isp later. */\n\t\t\t\t\tif (!test_bit(UNLOADING,\n\t\t\t\t\t    &base_vha->dpc_flags)) {\n\t\t\t\t\t\tset_bit(ISP_UNRECOVERABLE,\n\t\t\t\t\t\t    &base_vha->dpc_flags);\n\t\t\t\t\t\tql_dbg(ql_dbg_dpc, base_vha,\n\t\t\t\t\t\t    0x4021,\n\t\t\t\t\t\t    \"Reset Recovery Failed\\n\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (test_and_clear_bit(FX00_TARGET_SCAN,\n\t\t\t\t&base_vha->dpc_flags)) {\n\t\t\t\tql_dbg(ql_dbg_dpc, base_vha, 0x4022,\n\t\t\t\t    \"ISPFx00 Target Scan scheduled\\n\");\n\t\t\t\tif (qlafx00_rescan_isp(base_vha)) {\n\t\t\t\t\tif (!test_bit(UNLOADING,\n\t\t\t\t\t    &base_vha->dpc_flags))\n\t\t\t\t\t\tset_bit(ISP_UNRECOVERABLE,\n\t\t\t\t\t\t    &base_vha->dpc_flags);\n\t\t\t\t\tql_dbg(ql_dbg_dpc, base_vha, 0x401e,\n\t\t\t\t\t    \"ISPFx00 Target Scan Failed\\n\");\n\t\t\t\t}\n\t\t\t\tql_dbg(ql_dbg_dpc, base_vha, 0x401f,\n\t\t\t\t    \"ISPFx00 Target Scan End\\n\");\n\t\t\t}\n\t\t\tif (test_and_clear_bit(FX00_HOST_INFO_RESEND,\n\t\t\t\t&base_vha->dpc_flags)) {\n\t\t\t\tql_dbg(ql_dbg_dpc, base_vha, 0x4023,\n\t\t\t\t    \"ISPFx00 Host Info resend scheduled\\n\");\n\t\t\t\tqlafx00_fx_disc(base_vha,\n\t\t\t\t    &base_vha->hw->mr.fcport,\n\t\t\t\t    FXDISC_REG_HOST_INFO);\n\t\t\t}\n\t\t}\n\n\t\tif (test_and_clear_bit(DETECT_SFP_CHANGE,\n\t\t    &base_vha->dpc_flags)) {\n\t\t\t/* Semantic:\n\t\t\t *  - NO-OP -- await next ISP-ABORT. Preferred method\n\t\t\t *             to minimize disruptions that will occur\n\t\t\t *             when a forced chip-reset occurs.\n\t\t\t *  - Force -- ISP-ABORT scheduled.\n\t\t\t */\n\t\t\t/* set_bit(ISP_ABORT_NEEDED, &base_vha->dpc_flags); */\n\t\t}\n\n\t\tif (test_and_clear_bit\n\t\t    (ISP_ABORT_NEEDED, &base_vha->dpc_flags) &&\n\t\t    !test_bit(UNLOADING, &base_vha->dpc_flags)) {\n\t\t\tbool do_reset = true;\n\n\t\t\tswitch (base_vha->qlini_mode) {\n\t\t\tcase QLA2XXX_INI_MODE_ENABLED:\n\t\t\t\tbreak;\n\t\t\tcase QLA2XXX_INI_MODE_DISABLED:\n\t\t\t\tif (!qla_tgt_mode_enabled(base_vha) &&\n\t\t\t\t    !ha->flags.fw_started)\n\t\t\t\t\tdo_reset = false;\n\t\t\t\tbreak;\n\t\t\tcase QLA2XXX_INI_MODE_DUAL:\n\t\t\t\tif (!qla_dual_mode_enabled(base_vha) &&\n\t\t\t\t    !ha->flags.fw_started)\n\t\t\t\t\tdo_reset = false;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (do_reset && !(test_and_set_bit(ABORT_ISP_ACTIVE,\n\t\t\t    &base_vha->dpc_flags))) {\n\t\t\t\tbase_vha->flags.online = 1;\n\t\t\t\tql_dbg(ql_dbg_dpc, base_vha, 0x4007,\n\t\t\t\t    \"ISP abort scheduled.\\n\");\n\t\t\t\tif (ha->isp_ops->abort_isp(base_vha)) {\n\t\t\t\t\t/* failed. retry later */\n\t\t\t\t\tset_bit(ISP_ABORT_NEEDED,\n\t\t\t\t\t    &base_vha->dpc_flags);\n\t\t\t\t}\n\t\t\t\tclear_bit(ABORT_ISP_ACTIVE,\n\t\t\t\t\t\t&base_vha->dpc_flags);\n\t\t\t\tql_dbg(ql_dbg_dpc, base_vha, 0x4008,\n\t\t\t\t    \"ISP abort end.\\n\");\n\t\t\t}\n\t\t}\n\n\t\tif (test_bit(PROCESS_PUREX_IOCB, &base_vha->dpc_flags)) {\n\t\t\tif (atomic_read(&base_vha->loop_state) == LOOP_READY) {\n\t\t\t\tqla24xx_process_purex_list\n\t\t\t\t\t(&base_vha->purex_list);\n\t\t\t\tclear_bit(PROCESS_PUREX_IOCB,\n\t\t\t\t    &base_vha->dpc_flags);\n\t\t\t}\n\t\t}\n\n\t\tif (test_and_clear_bit(FCPORT_UPDATE_NEEDED,\n\t\t    &base_vha->dpc_flags)) {\n\t\t\tqla2x00_update_fcports(base_vha);\n\t\t}\n\n\t\tif (IS_QLAFX00(ha))\n\t\t\tgoto loop_resync_check;\n\n\t\tif (test_bit(ISP_QUIESCE_NEEDED, &base_vha->dpc_flags)) {\n\t\t\tql_dbg(ql_dbg_dpc, base_vha, 0x4009,\n\t\t\t    \"Quiescence mode scheduled.\\n\");\n\t\t\tif (IS_P3P_TYPE(ha)) {\n\t\t\t\tif (IS_QLA82XX(ha))\n\t\t\t\t\tqla82xx_device_state_handler(base_vha);\n\t\t\t\tif (IS_QLA8044(ha))\n\t\t\t\t\tqla8044_device_state_handler(base_vha);\n\t\t\t\tclear_bit(ISP_QUIESCE_NEEDED,\n\t\t\t\t    &base_vha->dpc_flags);\n\t\t\t\tif (!ha->flags.quiesce_owner) {\n\t\t\t\t\tqla2x00_perform_loop_resync(base_vha);\n\t\t\t\t\tif (IS_QLA82XX(ha)) {\n\t\t\t\t\t\tqla82xx_idc_lock(ha);\n\t\t\t\t\t\tqla82xx_clear_qsnt_ready(\n\t\t\t\t\t\t    base_vha);\n\t\t\t\t\t\tqla82xx_idc_unlock(ha);\n\t\t\t\t\t} else if (IS_QLA8044(ha)) {\n\t\t\t\t\t\tqla8044_idc_lock(ha);\n\t\t\t\t\t\tqla8044_clear_qsnt_ready(\n\t\t\t\t\t\t    base_vha);\n\t\t\t\t\t\tqla8044_idc_unlock(ha);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tclear_bit(ISP_QUIESCE_NEEDED,\n\t\t\t\t    &base_vha->dpc_flags);\n\t\t\t\tqla2x00_quiesce_io(base_vha);\n\t\t\t}\n\t\t\tql_dbg(ql_dbg_dpc, base_vha, 0x400a,\n\t\t\t    \"Quiescence mode end.\\n\");\n\t\t}\n\n\t\tif (test_and_clear_bit(RESET_MARKER_NEEDED,\n\t\t\t\t&base_vha->dpc_flags) &&\n\t\t    (!(test_and_set_bit(RESET_ACTIVE, &base_vha->dpc_flags)))) {\n\n\t\t\tql_dbg(ql_dbg_dpc, base_vha, 0x400b,\n\t\t\t    \"Reset marker scheduled.\\n\");\n\t\t\tqla2x00_rst_aen(base_vha);\n\t\t\tclear_bit(RESET_ACTIVE, &base_vha->dpc_flags);\n\t\t\tql_dbg(ql_dbg_dpc, base_vha, 0x400c,\n\t\t\t    \"Reset marker end.\\n\");\n\t\t}\n\n\t\t/* Retry each device up to login retry count */\n\t\tif (test_bit(RELOGIN_NEEDED, &base_vha->dpc_flags) &&\n\t\t    !test_bit(LOOP_RESYNC_NEEDED, &base_vha->dpc_flags) &&\n\t\t    atomic_read(&base_vha->loop_state) != LOOP_DOWN) {\n\n\t\t\tif (!base_vha->relogin_jif ||\n\t\t\t    time_after_eq(jiffies, base_vha->relogin_jif)) {\n\t\t\t\tbase_vha->relogin_jif = jiffies + HZ;\n\t\t\t\tclear_bit(RELOGIN_NEEDED, &base_vha->dpc_flags);\n\n\t\t\t\tql_dbg(ql_dbg_disc, base_vha, 0x400d,\n\t\t\t\t    \"Relogin scheduled.\\n\");\n\t\t\t\tqla24xx_post_relogin_work(base_vha);\n\t\t\t}\n\t\t}\nloop_resync_check:\n\t\tif (test_and_clear_bit(LOOP_RESYNC_NEEDED,\n\t\t    &base_vha->dpc_flags)) {\n\n\t\t\tql_dbg(ql_dbg_dpc, base_vha, 0x400f,\n\t\t\t    \"Loop resync scheduled.\\n\");\n\n\t\t\tif (!(test_and_set_bit(LOOP_RESYNC_ACTIVE,\n\t\t\t    &base_vha->dpc_flags))) {\n\n\t\t\t\tqla2x00_loop_resync(base_vha);\n\n\t\t\t\tclear_bit(LOOP_RESYNC_ACTIVE,\n\t\t\t\t\t\t&base_vha->dpc_flags);\n\t\t\t}\n\n\t\t\tql_dbg(ql_dbg_dpc, base_vha, 0x4010,\n\t\t\t    \"Loop resync end.\\n\");\n\t\t}\n\n\t\tif (IS_QLAFX00(ha))\n\t\t\tgoto intr_on_check;\n\n\t\tif (test_bit(NPIV_CONFIG_NEEDED, &base_vha->dpc_flags) &&\n\t\t    atomic_read(&base_vha->loop_state) == LOOP_READY) {\n\t\t\tclear_bit(NPIV_CONFIG_NEEDED, &base_vha->dpc_flags);\n\t\t\tqla2xxx_flash_npiv_conf(base_vha);\n\t\t}\n\nintr_on_check:\n\t\tif (!ha->interrupts_on)\n\t\t\tha->isp_ops->enable_intrs(ha);\n\n\t\tif (test_and_clear_bit(BEACON_BLINK_NEEDED,\n\t\t\t\t\t&base_vha->dpc_flags)) {\n\t\t\tif (ha->beacon_blink_led == 1)\n\t\t\t\tha->isp_ops->beacon_blink(base_vha);\n\t\t}\n\n\t\t/* qpair online check */\n\t\tif (test_and_clear_bit(QPAIR_ONLINE_CHECK_NEEDED,\n\t\t    &base_vha->dpc_flags)) {\n\t\t\tif (ha->flags.eeh_busy ||\n\t\t\t    ha->flags.pci_channel_io_perm_failure)\n\t\t\t\tonline = 0;\n\t\t\telse\n\t\t\t\tonline = 1;\n\n\t\t\tmutex_lock(&ha->mq_lock);\n\t\t\tlist_for_each_entry(qpair, &base_vha->qp_list,\n\t\t\t    qp_list_elem)\n\t\t\tqpair->online = online;\n\t\t\tmutex_unlock(&ha->mq_lock);\n\t\t}\n\n\t\tif (test_and_clear_bit(SET_NVME_ZIO_THRESHOLD_NEEDED,\n\t\t    &base_vha->dpc_flags)) {\n\t\t\tql_log(ql_log_info, base_vha, 0xffffff,\n\t\t\t\t\"nvme: SET ZIO Activity exchange threshold to %d.\\n\",\n\t\t\t\t\t\tha->nvme_last_rptd_aen);\n\t\t\tif (qla27xx_set_zio_threshold(base_vha,\n\t\t\t    ha->nvme_last_rptd_aen)) {\n\t\t\t\tql_log(ql_log_info, base_vha, 0xffffff,\n\t\t\t\t    \"nvme: Unable to SET ZIO Activity exchange threshold to %d.\\n\",\n\t\t\t\t    ha->nvme_last_rptd_aen);\n\t\t\t}\n\t\t}\n\n\t\tif (test_and_clear_bit(SET_ZIO_THRESHOLD_NEEDED,\n\t\t    &base_vha->dpc_flags)) {\n\t\t\tql_log(ql_log_info, base_vha, 0xffffff,\n\t\t\t    \"SET ZIO Activity exchange threshold to %d.\\n\",\n\t\t\t    ha->last_zio_threshold);\n\t\t\tqla27xx_set_zio_threshold(base_vha,\n\t\t\t    ha->last_zio_threshold);\n\t\t}\n\n\t\tif (!IS_QLAFX00(ha))\n\t\t\tqla2x00_do_dpc_all_vps(base_vha);\n\n\t\tif (test_and_clear_bit(N2N_LINK_RESET,\n\t\t\t&base_vha->dpc_flags)) {\n\t\t\tqla2x00_lip_reset(base_vha);\n\t\t}\n\n\t\tha->dpc_active = 0;\nend_loop:\n\t\tset_current_state(TASK_INTERRUPTIBLE);\n\t} /* End of while(1) */\n\t__set_current_state(TASK_RUNNING);\n\n\tql_dbg(ql_dbg_dpc, base_vha, 0x4011,\n\t    \"DPC handler exiting.\\n\");\n\n\t/*\n\t * Make sure that nobody tries to wake us up again.\n\t */\n\tha->dpc_active = 0;\n\n\t/* Cleanup any residual CTX SRBs. */\n\tqla2x00_abort_all_cmds(base_vha, DID_NO_CONNECT << 16);\n\n\treturn 0;\n}\n\nvoid\nqla2xxx_wake_dpc(struct scsi_qla_host *vha)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct task_struct *t = ha->dpc_thread;\n\n\tif (!test_bit(UNLOADING, &vha->dpc_flags) && t)\n\t\twake_up_process(t);\n}\n\n/*\n*  qla2x00_rst_aen\n*      Processes asynchronous reset.\n*\n* Input:\n*      ha  = adapter block pointer.\n*/\nstatic void\nqla2x00_rst_aen(scsi_qla_host_t *vha)\n{\n\tif (vha->flags.online && !vha->flags.reset_active &&\n\t    !atomic_read(&vha->loop_down_timer) &&\n\t    !(test_bit(ABORT_ISP_ACTIVE, &vha->dpc_flags))) {\n\t\tdo {\n\t\t\tclear_bit(RESET_MARKER_NEEDED, &vha->dpc_flags);\n\n\t\t\t/*\n\t\t\t * Issue marker command only when we are going to start\n\t\t\t * the I/O.\n\t\t\t */\n\t\t\tvha->marker_needed = 1;\n\t\t} while (!atomic_read(&vha->loop_down_timer) &&\n\t\t    (test_bit(RESET_MARKER_NEEDED, &vha->dpc_flags)));\n\t}\n}\n\n/**************************************************************************\n*   qla2x00_timer\n*\n* Description:\n*   One second timer\n*\n* Context: Interrupt\n***************************************************************************/\nvoid\nqla2x00_timer(struct timer_list *t)\n{\n\tscsi_qla_host_t *vha = from_timer(vha, t, timer);\n\tunsigned long\tcpu_flags = 0;\n\tint\t\tstart_dpc = 0;\n\tint\t\tindex;\n\tsrb_t\t\t*sp;\n\tuint16_t        w;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct req_que *req;\n\n\tif (ha->flags.eeh_busy) {\n\t\tql_dbg(ql_dbg_timer, vha, 0x6000,\n\t\t    \"EEH = %d, restarting timer.\\n\",\n\t\t    ha->flags.eeh_busy);\n\t\tqla2x00_restart_timer(vha, WATCH_INTERVAL);\n\t\treturn;\n\t}\n\n\t/*\n\t * Hardware read to raise pending EEH errors during mailbox waits. If\n\t * the read returns -1 then disable the board.\n\t */\n\tif (!pci_channel_offline(ha->pdev)) {\n\t\tpci_read_config_word(ha->pdev, PCI_VENDOR_ID, &w);\n\t\tqla2x00_check_reg16_for_disconnect(vha, w);\n\t}\n\n\t/* Make sure qla82xx_watchdog is run only for physical port */\n\tif (!vha->vp_idx && IS_P3P_TYPE(ha)) {\n\t\tif (test_bit(ISP_QUIESCE_NEEDED, &vha->dpc_flags))\n\t\t\tstart_dpc++;\n\t\tif (IS_QLA82XX(ha))\n\t\t\tqla82xx_watchdog(vha);\n\t\telse if (IS_QLA8044(ha))\n\t\t\tqla8044_watchdog(vha);\n\t}\n\n\tif (!vha->vp_idx && IS_QLAFX00(ha))\n\t\tqlafx00_timer_routine(vha);\n\n\t/* Loop down handler. */\n\tif (atomic_read(&vha->loop_down_timer) > 0 &&\n\t    !(test_bit(ABORT_ISP_ACTIVE, &vha->dpc_flags)) &&\n\t    !(test_bit(FCOE_CTX_RESET_NEEDED, &vha->dpc_flags))\n\t\t&& vha->flags.online) {\n\n\t\tif (atomic_read(&vha->loop_down_timer) ==\n\t\t    vha->loop_down_abort_time) {\n\n\t\t\tql_log(ql_log_info, vha, 0x6008,\n\t\t\t    \"Loop down - aborting the queues before time expires.\\n\");\n\n\t\t\tif (!IS_QLA2100(ha) && vha->link_down_timeout)\n\t\t\t\tatomic_set(&vha->loop_state, LOOP_DEAD);\n\n\t\t\t/*\n\t\t\t * Schedule an ISP abort to return any FCP2-device\n\t\t\t * commands.\n\t\t\t */\n\t\t\t/* NPIV - scan physical port only */\n\t\t\tif (!vha->vp_idx) {\n\t\t\t\tspin_lock_irqsave(&ha->hardware_lock,\n\t\t\t\t    cpu_flags);\n\t\t\t\treq = ha->req_q_map[0];\n\t\t\t\tfor (index = 1;\n\t\t\t\t    index < req->num_outstanding_cmds;\n\t\t\t\t    index++) {\n\t\t\t\t\tfc_port_t *sfcp;\n\n\t\t\t\t\tsp = req->outstanding_cmds[index];\n\t\t\t\t\tif (!sp)\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\tif (sp->cmd_type != TYPE_SRB)\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\tif (sp->type != SRB_SCSI_CMD)\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\tsfcp = sp->fcport;\n\t\t\t\t\tif (!(sfcp->flags & FCF_FCP2_DEVICE))\n\t\t\t\t\t\tcontinue;\n\n\t\t\t\t\tif (IS_QLA82XX(ha))\n\t\t\t\t\t\tset_bit(FCOE_CTX_RESET_NEEDED,\n\t\t\t\t\t\t\t&vha->dpc_flags);\n\t\t\t\t\telse\n\t\t\t\t\t\tset_bit(ISP_ABORT_NEEDED,\n\t\t\t\t\t\t\t&vha->dpc_flags);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tspin_unlock_irqrestore(&ha->hardware_lock,\n\t\t\t\t\t\t\t\tcpu_flags);\n\t\t\t}\n\t\t\tstart_dpc++;\n\t\t}\n\n\t\t/* if the loop has been down for 4 minutes, reinit adapter */\n\t\tif (atomic_dec_and_test(&vha->loop_down_timer) != 0) {\n\t\t\tif (!(vha->device_flags & DFLG_NO_CABLE)) {\n\t\t\t\tql_log(ql_log_warn, vha, 0x6009,\n\t\t\t\t    \"Loop down - aborting ISP.\\n\");\n\n\t\t\t\tif (IS_QLA82XX(ha))\n\t\t\t\t\tset_bit(FCOE_CTX_RESET_NEEDED,\n\t\t\t\t\t\t&vha->dpc_flags);\n\t\t\t\telse\n\t\t\t\t\tset_bit(ISP_ABORT_NEEDED,\n\t\t\t\t\t\t&vha->dpc_flags);\n\t\t\t}\n\t\t}\n\t\tql_dbg(ql_dbg_timer, vha, 0x600a,\n\t\t    \"Loop down - seconds remaining %d.\\n\",\n\t\t    atomic_read(&vha->loop_down_timer));\n\t}\n\t/* Check if beacon LED needs to be blinked for physical host only */\n\tif (!vha->vp_idx && (ha->beacon_blink_led == 1)) {\n\t\t/* There is no beacon_blink function for ISP82xx */\n\t\tif (!IS_P3P_TYPE(ha)) {\n\t\t\tset_bit(BEACON_BLINK_NEEDED, &vha->dpc_flags);\n\t\t\tstart_dpc++;\n\t\t}\n\t}\n\n\t/* Process any deferred work. */\n\tif (!list_empty(&vha->work_list)) {\n\t\tunsigned long flags;\n\t\tbool q = false;\n\n\t\tspin_lock_irqsave(&vha->work_lock, flags);\n\t\tif (!test_and_set_bit(IOCB_WORK_ACTIVE, &vha->dpc_flags))\n\t\t\tq = true;\n\t\tspin_unlock_irqrestore(&vha->work_lock, flags);\n\t\tif (q)\n\t\t\tqueue_work(vha->hw->wq, &vha->iocb_work);\n\t}\n\n\t/*\n\t * FC-NVME\n\t * see if the active AEN count has changed from what was last reported.\n\t */\n\tindex = atomic_read(&ha->nvme_active_aen_cnt);\n\tif (!vha->vp_idx &&\n\t    (index != ha->nvme_last_rptd_aen) &&\n\t    (index >= DEFAULT_ZIO_THRESHOLD) &&\n\t    ha->zio_mode == QLA_ZIO_MODE_6 &&\n\t    !ha->flags.host_shutting_down) {\n\t\tql_log(ql_log_info, vha, 0x3002,\n\t\t    \"nvme: Sched: Set ZIO exchange threshold to %d.\\n\",\n\t\t    ha->nvme_last_rptd_aen);\n\t\tha->nvme_last_rptd_aen = atomic_read(&ha->nvme_active_aen_cnt);\n\t\tset_bit(SET_NVME_ZIO_THRESHOLD_NEEDED, &vha->dpc_flags);\n\t\tstart_dpc++;\n\t}\n\n\tif (!vha->vp_idx &&\n\t    atomic_read(&ha->zio_threshold) != ha->last_zio_threshold &&\n\t    IS_ZIO_THRESHOLD_CAPABLE(ha)) {\n\t\tql_log(ql_log_info, vha, 0x3002,\n\t\t    \"Sched: Set ZIO exchange threshold to %d.\\n\",\n\t\t    ha->last_zio_threshold);\n\t\tha->last_zio_threshold = atomic_read(&ha->zio_threshold);\n\t\tset_bit(SET_ZIO_THRESHOLD_NEEDED, &vha->dpc_flags);\n\t\tstart_dpc++;\n\t}\n\n\t/* Schedule the DPC routine if needed */\n\tif ((test_bit(ISP_ABORT_NEEDED, &vha->dpc_flags) ||\n\t    test_bit(LOOP_RESYNC_NEEDED, &vha->dpc_flags) ||\n\t    test_bit(FCPORT_UPDATE_NEEDED, &vha->dpc_flags) ||\n\t    start_dpc ||\n\t    test_bit(RESET_MARKER_NEEDED, &vha->dpc_flags) ||\n\t    test_bit(BEACON_BLINK_NEEDED, &vha->dpc_flags) ||\n\t    test_bit(ISP_UNRECOVERABLE, &vha->dpc_flags) ||\n\t    test_bit(FCOE_CTX_RESET_NEEDED, &vha->dpc_flags) ||\n\t    test_bit(VP_DPC_NEEDED, &vha->dpc_flags) ||\n\t    test_bit(RELOGIN_NEEDED, &vha->dpc_flags) ||\n\t    test_bit(PROCESS_PUREX_IOCB, &vha->dpc_flags))) {\n\t\tql_dbg(ql_dbg_timer, vha, 0x600b,\n\t\t    \"isp_abort_needed=%d loop_resync_needed=%d \"\n\t\t    \"fcport_update_needed=%d start_dpc=%d \"\n\t\t    \"reset_marker_needed=%d\",\n\t\t    test_bit(ISP_ABORT_NEEDED, &vha->dpc_flags),\n\t\t    test_bit(LOOP_RESYNC_NEEDED, &vha->dpc_flags),\n\t\t    test_bit(FCPORT_UPDATE_NEEDED, &vha->dpc_flags),\n\t\t    start_dpc,\n\t\t    test_bit(RESET_MARKER_NEEDED, &vha->dpc_flags));\n\t\tql_dbg(ql_dbg_timer, vha, 0x600c,\n\t\t    \"beacon_blink_needed=%d isp_unrecoverable=%d \"\n\t\t    \"fcoe_ctx_reset_needed=%d vp_dpc_needed=%d \"\n\t\t    \"relogin_needed=%d, Process_purex_iocb=%d.\\n\",\n\t\t    test_bit(BEACON_BLINK_NEEDED, &vha->dpc_flags),\n\t\t    test_bit(ISP_UNRECOVERABLE, &vha->dpc_flags),\n\t\t    test_bit(FCOE_CTX_RESET_NEEDED, &vha->dpc_flags),\n\t\t    test_bit(VP_DPC_NEEDED, &vha->dpc_flags),\n\t\t    test_bit(RELOGIN_NEEDED, &vha->dpc_flags),\n\t\t    test_bit(PROCESS_PUREX_IOCB, &vha->dpc_flags));\n\t\tqla2xxx_wake_dpc(vha);\n\t}\n\n\tqla2x00_restart_timer(vha, WATCH_INTERVAL);\n}\n\n/* Firmware interface routines. */\n\n#define FW_ISP21XX\t0\n#define FW_ISP22XX\t1\n#define FW_ISP2300\t2\n#define FW_ISP2322\t3\n#define FW_ISP24XX\t4\n#define FW_ISP25XX\t5\n#define FW_ISP81XX\t6\n#define FW_ISP82XX\t7\n#define FW_ISP2031\t8\n#define FW_ISP8031\t9\n#define FW_ISP27XX\t10\n#define FW_ISP28XX\t11\n\n#define FW_FILE_ISP21XX\t\"ql2100_fw.bin\"\n#define FW_FILE_ISP22XX\t\"ql2200_fw.bin\"\n#define FW_FILE_ISP2300\t\"ql2300_fw.bin\"\n#define FW_FILE_ISP2322\t\"ql2322_fw.bin\"\n#define FW_FILE_ISP24XX\t\"ql2400_fw.bin\"\n#define FW_FILE_ISP25XX\t\"ql2500_fw.bin\"\n#define FW_FILE_ISP81XX\t\"ql8100_fw.bin\"\n#define FW_FILE_ISP82XX\t\"ql8200_fw.bin\"\n#define FW_FILE_ISP2031\t\"ql2600_fw.bin\"\n#define FW_FILE_ISP8031\t\"ql8300_fw.bin\"\n#define FW_FILE_ISP27XX\t\"ql2700_fw.bin\"\n#define FW_FILE_ISP28XX\t\"ql2800_fw.bin\"\n\n\nstatic DEFINE_MUTEX(qla_fw_lock);\n\nstatic struct fw_blob qla_fw_blobs[] = {\n\t{ .name = FW_FILE_ISP21XX, .segs = { 0x1000, 0 }, },\n\t{ .name = FW_FILE_ISP22XX, .segs = { 0x1000, 0 }, },\n\t{ .name = FW_FILE_ISP2300, .segs = { 0x800, 0 }, },\n\t{ .name = FW_FILE_ISP2322, .segs = { 0x800, 0x1c000, 0x1e000, 0 }, },\n\t{ .name = FW_FILE_ISP24XX, },\n\t{ .name = FW_FILE_ISP25XX, },\n\t{ .name = FW_FILE_ISP81XX, },\n\t{ .name = FW_FILE_ISP82XX, },\n\t{ .name = FW_FILE_ISP2031, },\n\t{ .name = FW_FILE_ISP8031, },\n\t{ .name = FW_FILE_ISP27XX, },\n\t{ .name = FW_FILE_ISP28XX, },\n\t{ .name = NULL, },\n};\n\nstruct fw_blob *\nqla2x00_request_firmware(scsi_qla_host_t *vha)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct fw_blob *blob;\n\n\tif (IS_QLA2100(ha)) {\n\t\tblob = &qla_fw_blobs[FW_ISP21XX];\n\t} else if (IS_QLA2200(ha)) {\n\t\tblob = &qla_fw_blobs[FW_ISP22XX];\n\t} else if (IS_QLA2300(ha) || IS_QLA2312(ha) || IS_QLA6312(ha)) {\n\t\tblob = &qla_fw_blobs[FW_ISP2300];\n\t} else if (IS_QLA2322(ha) || IS_QLA6322(ha)) {\n\t\tblob = &qla_fw_blobs[FW_ISP2322];\n\t} else if (IS_QLA24XX_TYPE(ha)) {\n\t\tblob = &qla_fw_blobs[FW_ISP24XX];\n\t} else if (IS_QLA25XX(ha)) {\n\t\tblob = &qla_fw_blobs[FW_ISP25XX];\n\t} else if (IS_QLA81XX(ha)) {\n\t\tblob = &qla_fw_blobs[FW_ISP81XX];\n\t} else if (IS_QLA82XX(ha)) {\n\t\tblob = &qla_fw_blobs[FW_ISP82XX];\n\t} else if (IS_QLA2031(ha)) {\n\t\tblob = &qla_fw_blobs[FW_ISP2031];\n\t} else if (IS_QLA8031(ha)) {\n\t\tblob = &qla_fw_blobs[FW_ISP8031];\n\t} else if (IS_QLA27XX(ha)) {\n\t\tblob = &qla_fw_blobs[FW_ISP27XX];\n\t} else if (IS_QLA28XX(ha)) {\n\t\tblob = &qla_fw_blobs[FW_ISP28XX];\n\t} else {\n\t\treturn NULL;\n\t}\n\n\tif (!blob->name)\n\t\treturn NULL;\n\n\tmutex_lock(&qla_fw_lock);\n\tif (blob->fw)\n\t\tgoto out;\n\n\tif (request_firmware(&blob->fw, blob->name, &ha->pdev->dev)) {\n\t\tql_log(ql_log_warn, vha, 0x0063,\n\t\t    \"Failed to load firmware image (%s).\\n\", blob->name);\n\t\tblob->fw = NULL;\n\t\tblob = NULL;\n\t}\n\nout:\n\tmutex_unlock(&qla_fw_lock);\n\treturn blob;\n}\n\nstatic void\nqla2x00_release_firmware(void)\n{\n\tstruct fw_blob *blob;\n\n\tmutex_lock(&qla_fw_lock);\n\tfor (blob = qla_fw_blobs; blob->name; blob++)\n\t\trelease_firmware(blob->fw);\n\tmutex_unlock(&qla_fw_lock);\n}\n\nstatic void qla_pci_error_cleanup(scsi_qla_host_t *vha)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tscsi_qla_host_t *base_vha = pci_get_drvdata(ha->pdev);\n\tstruct qla_qpair *qpair = NULL;\n\tstruct scsi_qla_host *vp;\n\tfc_port_t *fcport;\n\tint i;\n\tunsigned long flags;\n\n\tha->chip_reset++;\n\n\tha->base_qpair->chip_reset = ha->chip_reset;\n\tfor (i = 0; i < ha->max_qpairs; i++) {\n\t\tif (ha->queue_pair_map[i])\n\t\t\tha->queue_pair_map[i]->chip_reset =\n\t\t\t    ha->base_qpair->chip_reset;\n\t}\n\n\t/* purge MBox commands */\n\tif (atomic_read(&ha->num_pend_mbx_stage3)) {\n\t\tclear_bit(MBX_INTR_WAIT, &ha->mbx_cmd_flags);\n\t\tcomplete(&ha->mbx_intr_comp);\n\t}\n\n\ti = 0;\n\n\twhile (atomic_read(&ha->num_pend_mbx_stage3) ||\n\t    atomic_read(&ha->num_pend_mbx_stage2) ||\n\t    atomic_read(&ha->num_pend_mbx_stage1)) {\n\t\tmsleep(20);\n\t\ti++;\n\t\tif (i > 50)\n\t\t\tbreak;\n\t}\n\n\tha->flags.purge_mbox = 0;\n\n\tmutex_lock(&ha->mq_lock);\n\tlist_for_each_entry(qpair, &base_vha->qp_list, qp_list_elem)\n\t\tqpair->online = 0;\n\tmutex_unlock(&ha->mq_lock);\n\n\tqla2x00_mark_all_devices_lost(vha);\n\n\tspin_lock_irqsave(&ha->vport_slock, flags);\n\tlist_for_each_entry(vp, &ha->vp_list, list) {\n\t\tatomic_inc(&vp->vref_count);\n\t\tspin_unlock_irqrestore(&ha->vport_slock, flags);\n\t\tqla2x00_mark_all_devices_lost(vp);\n\t\tspin_lock_irqsave(&ha->vport_slock, flags);\n\t\tatomic_dec(&vp->vref_count);\n\t}\n\tspin_unlock_irqrestore(&ha->vport_slock, flags);\n\n\t/* Clear all async request states across all VPs. */\n\tlist_for_each_entry(fcport, &vha->vp_fcports, list)\n\t\tfcport->flags &= ~(FCF_LOGIN_NEEDED | FCF_ASYNC_SENT);\n\n\tspin_lock_irqsave(&ha->vport_slock, flags);\n\tlist_for_each_entry(vp, &ha->vp_list, list) {\n\t\tatomic_inc(&vp->vref_count);\n\t\tspin_unlock_irqrestore(&ha->vport_slock, flags);\n\t\tlist_for_each_entry(fcport, &vp->vp_fcports, list)\n\t\t\tfcport->flags &= ~(FCF_LOGIN_NEEDED | FCF_ASYNC_SENT);\n\t\tspin_lock_irqsave(&ha->vport_slock, flags);\n\t\tatomic_dec(&vp->vref_count);\n\t}\n\tspin_unlock_irqrestore(&ha->vport_slock, flags);\n}\n\n\nstatic pci_ers_result_t\nqla2xxx_pci_error_detected(struct pci_dev *pdev, pci_channel_state_t state)\n{\n\tscsi_qla_host_t *vha = pci_get_drvdata(pdev);\n\tstruct qla_hw_data *ha = vha->hw;\n\n\tql_dbg(ql_dbg_aer, vha, 0x9000,\n\t    \"PCI error detected, state %x.\\n\", state);\n\n\tif (!atomic_read(&pdev->enable_cnt)) {\n\t\tql_log(ql_log_info, vha, 0xffff,\n\t\t\t\"PCI device is disabled,state %x\\n\", state);\n\t\treturn PCI_ERS_RESULT_NEED_RESET;\n\t}\n\n\tswitch (state) {\n\tcase pci_channel_io_normal:\n\t\tha->flags.eeh_busy = 0;\n\t\tif (ql2xmqsupport || ql2xnvmeenable) {\n\t\t\tset_bit(QPAIR_ONLINE_CHECK_NEEDED, &vha->dpc_flags);\n\t\t\tqla2xxx_wake_dpc(vha);\n\t\t}\n\t\treturn PCI_ERS_RESULT_CAN_RECOVER;\n\tcase pci_channel_io_frozen:\n\t\tha->flags.eeh_busy = 1;\n\t\tqla_pci_error_cleanup(vha);\n\t\treturn PCI_ERS_RESULT_NEED_RESET;\n\tcase pci_channel_io_perm_failure:\n\t\tha->flags.pci_channel_io_perm_failure = 1;\n\t\tqla2x00_abort_all_cmds(vha, DID_NO_CONNECT << 16);\n\t\tif (ql2xmqsupport || ql2xnvmeenable) {\n\t\t\tset_bit(QPAIR_ONLINE_CHECK_NEEDED, &vha->dpc_flags);\n\t\t\tqla2xxx_wake_dpc(vha);\n\t\t}\n\t\treturn PCI_ERS_RESULT_DISCONNECT;\n\t}\n\treturn PCI_ERS_RESULT_NEED_RESET;\n}\n\nstatic pci_ers_result_t\nqla2xxx_pci_mmio_enabled(struct pci_dev *pdev)\n{\n\tint risc_paused = 0;\n\tuint32_t stat;\n\tunsigned long flags;\n\tscsi_qla_host_t *base_vha = pci_get_drvdata(pdev);\n\tstruct qla_hw_data *ha = base_vha->hw;\n\tstruct device_reg_2xxx __iomem *reg = &ha->iobase->isp;\n\tstruct device_reg_24xx __iomem *reg24 = &ha->iobase->isp24;\n\n\tif (IS_QLA82XX(ha))\n\t\treturn PCI_ERS_RESULT_RECOVERED;\n\n\tspin_lock_irqsave(&ha->hardware_lock, flags);\n\tif (IS_QLA2100(ha) || IS_QLA2200(ha)){\n\t\tstat = rd_reg_word(&reg->hccr);\n\t\tif (stat & HCCR_RISC_PAUSE)\n\t\t\trisc_paused = 1;\n\t} else if (IS_QLA23XX(ha)) {\n\t\tstat = rd_reg_dword(&reg->u.isp2300.host_status);\n\t\tif (stat & HSR_RISC_PAUSED)\n\t\t\trisc_paused = 1;\n\t} else if (IS_FWI2_CAPABLE(ha)) {\n\t\tstat = rd_reg_dword(&reg24->host_status);\n\t\tif (stat & HSRX_RISC_PAUSED)\n\t\t\trisc_paused = 1;\n\t}\n\tspin_unlock_irqrestore(&ha->hardware_lock, flags);\n\n\tif (risc_paused) {\n\t\tql_log(ql_log_info, base_vha, 0x9003,\n\t\t    \"RISC paused -- mmio_enabled, Dumping firmware.\\n\");\n\t\tqla2xxx_dump_fw(base_vha);\n\n\t\treturn PCI_ERS_RESULT_NEED_RESET;\n\t} else\n\t\treturn PCI_ERS_RESULT_RECOVERED;\n}\n\nstatic pci_ers_result_t\nqla2xxx_pci_slot_reset(struct pci_dev *pdev)\n{\n\tpci_ers_result_t ret = PCI_ERS_RESULT_DISCONNECT;\n\tscsi_qla_host_t *base_vha = pci_get_drvdata(pdev);\n\tstruct qla_hw_data *ha = base_vha->hw;\n\tint rc;\n\tstruct qla_qpair *qpair = NULL;\n\n\tql_dbg(ql_dbg_aer, base_vha, 0x9004,\n\t    \"Slot Reset.\\n\");\n\n\t/* Workaround: qla2xxx driver which access hardware earlier\n\t * needs error state to be pci_channel_io_online.\n\t * Otherwise mailbox command timesout.\n\t */\n\tpdev->error_state = pci_channel_io_normal;\n\n\tpci_restore_state(pdev);\n\n\t/* pci_restore_state() clears the saved_state flag of the device\n\t * save restored state which resets saved_state flag\n\t */\n\tpci_save_state(pdev);\n\n\tif (ha->mem_only)\n\t\trc = pci_enable_device_mem(pdev);\n\telse\n\t\trc = pci_enable_device(pdev);\n\n\tif (rc) {\n\t\tql_log(ql_log_warn, base_vha, 0x9005,\n\t\t    \"Can't re-enable PCI device after reset.\\n\");\n\t\tgoto exit_slot_reset;\n\t}\n\n\n\tif (ha->isp_ops->pci_config(base_vha))\n\t\tgoto exit_slot_reset;\n\n\tmutex_lock(&ha->mq_lock);\n\tlist_for_each_entry(qpair, &base_vha->qp_list, qp_list_elem)\n\t\tqpair->online = 1;\n\tmutex_unlock(&ha->mq_lock);\n\n\tbase_vha->flags.online = 1;\n\tset_bit(ABORT_ISP_ACTIVE, &base_vha->dpc_flags);\n\tif (ha->isp_ops->abort_isp(base_vha) == QLA_SUCCESS)\n\t\tret =  PCI_ERS_RESULT_RECOVERED;\n\tclear_bit(ABORT_ISP_ACTIVE, &base_vha->dpc_flags);\n\n\nexit_slot_reset:\n\tql_dbg(ql_dbg_aer, base_vha, 0x900e,\n\t    \"slot_reset return %x.\\n\", ret);\n\n\treturn ret;\n}\n\nstatic void\nqla2xxx_pci_resume(struct pci_dev *pdev)\n{\n\tscsi_qla_host_t *base_vha = pci_get_drvdata(pdev);\n\tstruct qla_hw_data *ha = base_vha->hw;\n\tint ret;\n\n\tql_dbg(ql_dbg_aer, base_vha, 0x900f,\n\t    \"pci_resume.\\n\");\n\n\tha->flags.eeh_busy = 0;\n\n\tret = qla2x00_wait_for_hba_online(base_vha);\n\tif (ret != QLA_SUCCESS) {\n\t\tql_log(ql_log_fatal, base_vha, 0x9002,\n\t\t    \"The device failed to resume I/O from slot/link_reset.\\n\");\n\t}\n}\n\nstatic void\nqla_pci_reset_prepare(struct pci_dev *pdev)\n{\n\tscsi_qla_host_t *base_vha = pci_get_drvdata(pdev);\n\tstruct qla_hw_data *ha = base_vha->hw;\n\tstruct qla_qpair *qpair;\n\n\tql_log(ql_log_warn, base_vha, 0xffff,\n\t    \"%s.\\n\", __func__);\n\n\t/*\n\t * PCI FLR/function reset is about to reset the\n\t * slot. Stop the chip to stop all DMA access.\n\t * It is assumed that pci_reset_done will be called\n\t * after FLR to resume Chip operation.\n\t */\n\tha->flags.eeh_busy = 1;\n\tmutex_lock(&ha->mq_lock);\n\tlist_for_each_entry(qpair, &base_vha->qp_list, qp_list_elem)\n\t\tqpair->online = 0;\n\tmutex_unlock(&ha->mq_lock);\n\n\tset_bit(ABORT_ISP_ACTIVE, &base_vha->dpc_flags);\n\tqla2x00_abort_isp_cleanup(base_vha);\n\tqla2x00_abort_all_cmds(base_vha, DID_RESET << 16);\n}\n\nstatic void\nqla_pci_reset_done(struct pci_dev *pdev)\n{\n\tscsi_qla_host_t *base_vha = pci_get_drvdata(pdev);\n\tstruct qla_hw_data *ha = base_vha->hw;\n\tstruct qla_qpair *qpair;\n\n\tql_log(ql_log_warn, base_vha, 0xffff,\n\t    \"%s.\\n\", __func__);\n\n\t/*\n\t * FLR just completed by PCI layer. Resume adapter\n\t */\n\tha->flags.eeh_busy = 0;\n\tmutex_lock(&ha->mq_lock);\n\tlist_for_each_entry(qpair, &base_vha->qp_list, qp_list_elem)\n\t\tqpair->online = 1;\n\tmutex_unlock(&ha->mq_lock);\n\n\tbase_vha->flags.online = 1;\n\tha->isp_ops->abort_isp(base_vha);\n\tclear_bit(ABORT_ISP_ACTIVE, &base_vha->dpc_flags);\n}\n\nstatic int qla2xxx_map_queues(struct Scsi_Host *shost)\n{\n\tint rc;\n\tscsi_qla_host_t *vha = (scsi_qla_host_t *)shost->hostdata;\n\tstruct blk_mq_queue_map *qmap = &shost->tag_set.map[HCTX_TYPE_DEFAULT];\n\n\tif (USER_CTRL_IRQ(vha->hw) || !vha->hw->mqiobase)\n\t\trc = blk_mq_map_queues(qmap);\n\telse\n\t\trc = blk_mq_pci_map_queues(qmap, vha->hw->pdev, vha->irq_offset);\n\treturn rc;\n}\n\nstruct scsi_host_template qla2xxx_driver_template = {\n\t.module\t\t\t= THIS_MODULE,\n\t.name\t\t\t= QLA2XXX_DRIVER_NAME,\n\t.queuecommand\t\t= qla2xxx_queuecommand,\n\n\t.eh_timed_out\t\t= fc_eh_timed_out,\n\t.eh_abort_handler\t= qla2xxx_eh_abort,\n\t.eh_device_reset_handler = qla2xxx_eh_device_reset,\n\t.eh_target_reset_handler = qla2xxx_eh_target_reset,\n\t.eh_bus_reset_handler\t= qla2xxx_eh_bus_reset,\n\t.eh_host_reset_handler\t= qla2xxx_eh_host_reset,\n\n\t.slave_configure\t= qla2xxx_slave_configure,\n\n\t.slave_alloc\t\t= qla2xxx_slave_alloc,\n\t.slave_destroy\t\t= qla2xxx_slave_destroy,\n\t.scan_finished\t\t= qla2xxx_scan_finished,\n\t.scan_start\t\t= qla2xxx_scan_start,\n\t.change_queue_depth\t= scsi_change_queue_depth,\n\t.map_queues             = qla2xxx_map_queues,\n\t.this_id\t\t= -1,\n\t.cmd_per_lun\t\t= 3,\n\t.sg_tablesize\t\t= SG_ALL,\n\n\t.max_sectors\t\t= 0xFFFF,\n\t.shost_attrs\t\t= qla2x00_host_attrs,\n\n\t.supported_mode\t\t= MODE_INITIATOR,\n\t.track_queue_depth\t= 1,\n\t.cmd_size\t\t= sizeof(srb_t),\n};\n\nstatic const struct pci_error_handlers qla2xxx_err_handler = {\n\t.error_detected = qla2xxx_pci_error_detected,\n\t.mmio_enabled = qla2xxx_pci_mmio_enabled,\n\t.slot_reset = qla2xxx_pci_slot_reset,\n\t.resume = qla2xxx_pci_resume,\n\t.reset_prepare = qla_pci_reset_prepare,\n\t.reset_done = qla_pci_reset_done,\n};\n\nstatic struct pci_device_id qla2xxx_pci_tbl[] = {\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP2100) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP2200) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP2300) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP2312) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP2322) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP6312) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP6322) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP2422) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP2432) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP8432) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP5422) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP5432) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP2532) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP2031) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP8001) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP8021) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP8031) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISPF001) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP8044) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP2071) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP2271) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP2261) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP2061) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP2081) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP2281) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP2089) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, PCI_DEVICE_ID_QLOGIC_ISP2289) },\n\t{ 0 },\n};\nMODULE_DEVICE_TABLE(pci, qla2xxx_pci_tbl);\n\nstatic struct pci_driver qla2xxx_pci_driver = {\n\t.name\t\t= QLA2XXX_DRIVER_NAME,\n\t.driver\t\t= {\n\t\t.owner\t\t= THIS_MODULE,\n\t},\n\t.id_table\t= qla2xxx_pci_tbl,\n\t.probe\t\t= qla2x00_probe_one,\n\t.remove\t\t= qla2x00_remove_one,\n\t.shutdown\t= qla2x00_shutdown,\n\t.err_handler\t= &qla2xxx_err_handler,\n};\n\nstatic const struct file_operations apidev_fops = {\n\t.owner = THIS_MODULE,\n\t.llseek = noop_llseek,\n};\n\n/**\n * qla2x00_module_init - Module initialization.\n **/\nstatic int __init\nqla2x00_module_init(void)\n{\n\tint ret = 0;\n\n\tBUILD_BUG_ON(sizeof(cmd_a64_entry_t) != 64);\n\tBUILD_BUG_ON(sizeof(cmd_entry_t) != 64);\n\tBUILD_BUG_ON(sizeof(cont_a64_entry_t) != 64);\n\tBUILD_BUG_ON(sizeof(cont_entry_t) != 64);\n\tBUILD_BUG_ON(sizeof(init_cb_t) != 96);\n\tBUILD_BUG_ON(sizeof(mrk_entry_t) != 64);\n\tBUILD_BUG_ON(sizeof(ms_iocb_entry_t) != 64);\n\tBUILD_BUG_ON(sizeof(request_t) != 64);\n\tBUILD_BUG_ON(sizeof(struct abort_entry_24xx) != 64);\n\tBUILD_BUG_ON(sizeof(struct abort_iocb_entry_fx00) != 64);\n\tBUILD_BUG_ON(sizeof(struct abts_entry_24xx) != 64);\n\tBUILD_BUG_ON(sizeof(struct access_chip_84xx) != 64);\n\tBUILD_BUG_ON(sizeof(struct access_chip_rsp_84xx) != 64);\n\tBUILD_BUG_ON(sizeof(struct cmd_bidir) != 64);\n\tBUILD_BUG_ON(sizeof(struct cmd_nvme) != 64);\n\tBUILD_BUG_ON(sizeof(struct cmd_type_6) != 64);\n\tBUILD_BUG_ON(sizeof(struct cmd_type_7) != 64);\n\tBUILD_BUG_ON(sizeof(struct cmd_type_7_fx00) != 64);\n\tBUILD_BUG_ON(sizeof(struct cmd_type_crc_2) != 64);\n\tBUILD_BUG_ON(sizeof(struct ct_entry_24xx) != 64);\n\tBUILD_BUG_ON(sizeof(struct ct_fdmi1_hba_attributes) != 2344);\n\tBUILD_BUG_ON(sizeof(struct ct_fdmi2_hba_attributes) != 4424);\n\tBUILD_BUG_ON(sizeof(struct ct_fdmi2_port_attributes) != 4164);\n\tBUILD_BUG_ON(sizeof(struct ct_fdmi_hba_attr) != 260);\n\tBUILD_BUG_ON(sizeof(struct ct_fdmi_port_attr) != 260);\n\tBUILD_BUG_ON(sizeof(struct ct_rsp_hdr) != 16);\n\tBUILD_BUG_ON(sizeof(struct ctio_crc2_to_fw) != 64);\n\tBUILD_BUG_ON(sizeof(struct device_reg_24xx) != 256);\n\tBUILD_BUG_ON(sizeof(struct device_reg_25xxmq) != 24);\n\tBUILD_BUG_ON(sizeof(struct device_reg_2xxx) != 256);\n\tBUILD_BUG_ON(sizeof(struct device_reg_82xx) != 1288);\n\tBUILD_BUG_ON(sizeof(struct device_reg_fx00) != 216);\n\tBUILD_BUG_ON(sizeof(struct els_entry_24xx) != 64);\n\tBUILD_BUG_ON(sizeof(struct els_sts_entry_24xx) != 64);\n\tBUILD_BUG_ON(sizeof(struct fxdisc_entry_fx00) != 64);\n\tBUILD_BUG_ON(sizeof(struct imm_ntfy_from_isp) != 64);\n\tBUILD_BUG_ON(sizeof(struct init_cb_24xx) != 128);\n\tBUILD_BUG_ON(sizeof(struct init_cb_81xx) != 128);\n\tBUILD_BUG_ON(sizeof(struct logio_entry_24xx) != 64);\n\tBUILD_BUG_ON(sizeof(struct mbx_entry) != 64);\n\tBUILD_BUG_ON(sizeof(struct mid_init_cb_24xx) != 5252);\n\tBUILD_BUG_ON(sizeof(struct mrk_entry_24xx) != 64);\n\tBUILD_BUG_ON(sizeof(struct nvram_24xx) != 512);\n\tBUILD_BUG_ON(sizeof(struct nvram_81xx) != 512);\n\tBUILD_BUG_ON(sizeof(struct pt_ls4_request) != 64);\n\tBUILD_BUG_ON(sizeof(struct pt_ls4_rx_unsol) != 64);\n\tBUILD_BUG_ON(sizeof(struct purex_entry_24xx) != 64);\n\tBUILD_BUG_ON(sizeof(struct qla2100_fw_dump) != 123634);\n\tBUILD_BUG_ON(sizeof(struct qla2300_fw_dump) != 136100);\n\tBUILD_BUG_ON(sizeof(struct qla24xx_fw_dump) != 37976);\n\tBUILD_BUG_ON(sizeof(struct qla25xx_fw_dump) != 39228);\n\tBUILD_BUG_ON(sizeof(struct qla2xxx_fce_chain) != 52);\n\tBUILD_BUG_ON(sizeof(struct qla2xxx_fw_dump) != 136172);\n\tBUILD_BUG_ON(sizeof(struct qla2xxx_mq_chain) != 524);\n\tBUILD_BUG_ON(sizeof(struct qla2xxx_mqueue_chain) != 8);\n\tBUILD_BUG_ON(sizeof(struct qla2xxx_mqueue_header) != 12);\n\tBUILD_BUG_ON(sizeof(struct qla2xxx_offld_chain) != 24);\n\tBUILD_BUG_ON(sizeof(struct qla81xx_fw_dump) != 39420);\n\tBUILD_BUG_ON(sizeof(struct qla82xx_uri_data_desc) != 28);\n\tBUILD_BUG_ON(sizeof(struct qla82xx_uri_table_desc) != 32);\n\tBUILD_BUG_ON(sizeof(struct qla83xx_fw_dump) != 51196);\n\tBUILD_BUG_ON(sizeof(struct qla_fcp_prio_cfg) != FCP_PRIO_CFG_SIZE);\n\tBUILD_BUG_ON(sizeof(struct qla_fdt_layout) != 128);\n\tBUILD_BUG_ON(sizeof(struct qla_flt_header) != 8);\n\tBUILD_BUG_ON(sizeof(struct qla_flt_region) != 16);\n\tBUILD_BUG_ON(sizeof(struct qla_npiv_entry) != 24);\n\tBUILD_BUG_ON(sizeof(struct qla_npiv_header) != 16);\n\tBUILD_BUG_ON(sizeof(struct rdp_rsp_payload) != 336);\n\tBUILD_BUG_ON(sizeof(struct sns_cmd_pkt) != 2064);\n\tBUILD_BUG_ON(sizeof(struct sts_entry_24xx) != 64);\n\tBUILD_BUG_ON(sizeof(struct tsk_mgmt_entry) != 64);\n\tBUILD_BUG_ON(sizeof(struct tsk_mgmt_entry_fx00) != 64);\n\tBUILD_BUG_ON(sizeof(struct verify_chip_entry_84xx) != 64);\n\tBUILD_BUG_ON(sizeof(struct verify_chip_rsp_84xx) != 52);\n\tBUILD_BUG_ON(sizeof(struct vf_evfp_entry_24xx) != 56);\n\tBUILD_BUG_ON(sizeof(struct vp_config_entry_24xx) != 64);\n\tBUILD_BUG_ON(sizeof(struct vp_ctrl_entry_24xx) != 64);\n\tBUILD_BUG_ON(sizeof(struct vp_rpt_id_entry_24xx) != 64);\n\tBUILD_BUG_ON(sizeof(sts21_entry_t) != 64);\n\tBUILD_BUG_ON(sizeof(sts22_entry_t) != 64);\n\tBUILD_BUG_ON(sizeof(sts_cont_entry_t) != 64);\n\tBUILD_BUG_ON(sizeof(sts_entry_t) != 64);\n\tBUILD_BUG_ON(sizeof(sw_info_t) != 32);\n\tBUILD_BUG_ON(sizeof(target_id_t) != 2);\n\n\t/* Allocate cache for SRBs. */\n\tsrb_cachep = kmem_cache_create(\"qla2xxx_srbs\", sizeof(srb_t), 0,\n\t    SLAB_HWCACHE_ALIGN, NULL);\n\tif (srb_cachep == NULL) {\n\t\tql_log(ql_log_fatal, NULL, 0x0001,\n\t\t    \"Unable to allocate SRB cache...Failing load!.\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\t/* Initialize target kmem_cache and mem_pools */\n\tret = qlt_init();\n\tif (ret < 0) {\n\t\tgoto destroy_cache;\n\t} else if (ret > 0) {\n\t\t/*\n\t\t * If initiator mode is explictly disabled by qlt_init(),\n\t\t * prevent scsi_transport_fc.c:fc_scsi_scan_rport() from\n\t\t * performing scsi_scan_target() during LOOP UP event.\n\t\t */\n\t\tqla2xxx_transport_functions.disable_target_scan = 1;\n\t\tqla2xxx_transport_vport_functions.disable_target_scan = 1;\n\t}\n\n\t/* Derive version string. */\n\tstrcpy(qla2x00_version_str, QLA2XXX_VERSION);\n\tif (ql2xextended_error_logging)\n\t\tstrcat(qla2x00_version_str, \"-debug\");\n\tif (ql2xextended_error_logging == 1)\n\t\tql2xextended_error_logging = QL_DBG_DEFAULT1_MASK;\n\n\tif (ql2x_ini_mode == QLA2XXX_INI_MODE_DUAL)\n\t\tqla_insert_tgt_attrs();\n\n\tqla2xxx_transport_template =\n\t    fc_attach_transport(&qla2xxx_transport_functions);\n\tif (!qla2xxx_transport_template) {\n\t\tql_log(ql_log_fatal, NULL, 0x0002,\n\t\t    \"fc_attach_transport failed...Failing load!.\\n\");\n\t\tret = -ENODEV;\n\t\tgoto qlt_exit;\n\t}\n\n\tapidev_major = register_chrdev(0, QLA2XXX_APIDEV, &apidev_fops);\n\tif (apidev_major < 0) {\n\t\tql_log(ql_log_fatal, NULL, 0x0003,\n\t\t    \"Unable to register char device %s.\\n\", QLA2XXX_APIDEV);\n\t}\n\n\tqla2xxx_transport_vport_template =\n\t    fc_attach_transport(&qla2xxx_transport_vport_functions);\n\tif (!qla2xxx_transport_vport_template) {\n\t\tql_log(ql_log_fatal, NULL, 0x0004,\n\t\t    \"fc_attach_transport vport failed...Failing load!.\\n\");\n\t\tret = -ENODEV;\n\t\tgoto unreg_chrdev;\n\t}\n\tql_log(ql_log_info, NULL, 0x0005,\n\t    \"QLogic Fibre Channel HBA Driver: %s.\\n\",\n\t    qla2x00_version_str);\n\tret = pci_register_driver(&qla2xxx_pci_driver);\n\tif (ret) {\n\t\tql_log(ql_log_fatal, NULL, 0x0006,\n\t\t    \"pci_register_driver failed...ret=%d Failing load!.\\n\",\n\t\t    ret);\n\t\tgoto release_vport_transport;\n\t}\n\treturn ret;\n\nrelease_vport_transport:\n\tfc_release_transport(qla2xxx_transport_vport_template);\n\nunreg_chrdev:\n\tif (apidev_major >= 0)\n\t\tunregister_chrdev(apidev_major, QLA2XXX_APIDEV);\n\tfc_release_transport(qla2xxx_transport_template);\n\nqlt_exit:\n\tqlt_exit();\n\ndestroy_cache:\n\tkmem_cache_destroy(srb_cachep);\n\treturn ret;\n}\n\n/**\n * qla2x00_module_exit - Module cleanup.\n **/\nstatic void __exit\nqla2x00_module_exit(void)\n{\n\tpci_unregister_driver(&qla2xxx_pci_driver);\n\tqla2x00_release_firmware();\n\tkmem_cache_destroy(ctx_cachep);\n\tfc_release_transport(qla2xxx_transport_vport_template);\n\tif (apidev_major >= 0)\n\t\tunregister_chrdev(apidev_major, QLA2XXX_APIDEV);\n\tfc_release_transport(qla2xxx_transport_template);\n\tqlt_exit();\n\tkmem_cache_destroy(srb_cachep);\n}\n\nmodule_init(qla2x00_module_init);\nmodule_exit(qla2x00_module_exit);\n\nMODULE_AUTHOR(\"QLogic Corporation\");\nMODULE_DESCRIPTION(\"QLogic Fibre Channel HBA Driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_FIRMWARE(FW_FILE_ISP21XX);\nMODULE_FIRMWARE(FW_FILE_ISP22XX);\nMODULE_FIRMWARE(FW_FILE_ISP2300);\nMODULE_FIRMWARE(FW_FILE_ISP2322);\nMODULE_FIRMWARE(FW_FILE_ISP24XX);\nMODULE_FIRMWARE(FW_FILE_ISP25XX);\n"}}, "reports": [{"events": [{"location": {"col": 17, "file": 0, "line": 4229}, "message": "WARNING: *_pool_zalloc should be used for ha -> sf_init_cb, instead of *_pool_alloc/memset"}], "macros": [], "notes": [], "path": "/src/drivers/scsi/qla2xxx/qla_os.c", "reportHash": "f62f9512708a790403a253a5bbf50b47", "checkerName": "coccinelle", "reviewStatus": null, "severity": "UNSPECIFIED"}, {"events": [{"location": {"col": 6, "file": 0, "line": 7155}, "message": "atomic_dec_and_test variation before object free at line 7191."}], "macros": [], "notes": [], "path": "/src/drivers/scsi/qla2xxx/qla_os.c", "reportHash": "003fd03c18920621a7c9b00741718440", "checkerName": "coccinelle", "reviewStatus": null, "severity": "UNSPECIFIED"}]};
      window.onload = function() {
        if (!browserCompatible) {
          setNonCompatibleBrowserMessage();
        } else {
          BugViewer.init(data.files, data.reports);
          BugViewer.create();
          BugViewer.initByUrl();
        }
      };
    </script>
  </head>
  <body>
  <div class="container">
    <div id="content">
      <div id="side-bar">
        <div class="header">
          <a href="index.html" class="button">&#8249; Return to List</a>
        </div>
        <div id="report-nav">
          <div class="header">Reports</div>
        </div>
      </div>
      <div id="editor-wrapper">
        <div class="header">
          <div id="file">
            <span class="label">File:</span>
            <span id="file-path"></span>
          </div>
          <div id="checker">
            <span class="label">Checker name:</span>
            <span id="checker-name"></span>
          </div>
          <div id="review-status-wrapper">
            <span class="label">Review status:</span>
            <span id="review-status"></span>
          </div>
        </div>
        <div id="editor"></div>
      </div>
    </div>
  </div>
  </body>
</html>
