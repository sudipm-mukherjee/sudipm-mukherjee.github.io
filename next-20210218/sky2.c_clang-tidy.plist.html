<!DOCTYPE html>
<html>
  <head>
    <title>Plist HTML Viewer</title>

    <meta charset="UTF-8">

    <style type="text/css">
      .CodeMirror{font-family:monospace;height:300px;color:#000;direction:ltr}.CodeMirror-lines{padding:4px 0}.CodeMirror pre{padding:0 4px}.CodeMirror-gutter-filler,.CodeMirror-scrollbar-filler{background-color:#fff}.CodeMirror-gutters{border-right:1px solid #ddd;background-color:#f7f7f7;white-space:nowrap}.CodeMirror-linenumber{padding:0 3px 0 5px;min-width:20px;text-align:right;color:#999;white-space:nowrap}.CodeMirror-guttermarker{color:#000}.CodeMirror-guttermarker-subtle{color:#999}.CodeMirror-cursor{border-left:1px solid #000;border-right:none;width:0}.CodeMirror div.CodeMirror-secondarycursor{border-left:1px solid silver}.cm-fat-cursor .CodeMirror-cursor{width:auto;border:0!important;background:#7e7}.cm-fat-cursor div.CodeMirror-cursors{z-index:1}.cm-animate-fat-cursor{width:auto;border:0;-webkit-animation:blink 1.06s steps(1) infinite;-moz-animation:blink 1.06s steps(1) infinite;animation:blink 1.06s steps(1) infinite;background-color:#7e7}@-moz-keyframes blink{50%{background-color:transparent}}@-webkit-keyframes blink{50%{background-color:transparent}}@keyframes blink{50%{background-color:transparent}}.cm-tab{display:inline-block;text-decoration:inherit}.CodeMirror-rulers{position:absolute;left:0;right:0;top:-50px;bottom:-20px;overflow:hidden}.CodeMirror-ruler{border-left:1px solid #ccc;top:0;bottom:0;position:absolute}.cm-s-default .cm-header{color:#00f}.cm-s-default .cm-quote{color:#090}.cm-negative{color:#d44}.cm-positive{color:#292}.cm-header,.cm-strong{font-weight:700}.cm-em{font-style:italic}.cm-link{text-decoration:underline}.cm-strikethrough{text-decoration:line-through}.cm-s-default .cm-keyword{color:#708}.cm-s-default .cm-atom{color:#219}.cm-s-default .cm-number{color:#164}.cm-s-default .cm-def{color:#00f}.cm-s-default .cm-variable-2{color:#05a}.cm-s-default .cm-type,.cm-s-default .cm-variable-3{color:#085}.cm-s-default .cm-comment{color:#a50}.cm-s-default .cm-string{color:#a11}.cm-s-default .cm-string-2{color:#f50}.cm-s-default .cm-meta{color:#555}.cm-s-default .cm-qualifier{color:#555}.cm-s-default .cm-builtin{color:#30a}.cm-s-default .cm-bracket{color:#997}.cm-s-default .cm-tag{color:#170}.cm-s-default .cm-attribute{color:#00c}.cm-s-default .cm-hr{color:#999}.cm-s-default .cm-link{color:#00c}.cm-s-default .cm-error{color:red}.cm-invalidchar{color:red}.CodeMirror-composing{border-bottom:2px solid}div.CodeMirror span.CodeMirror-matchingbracket{color:#0f0}div.CodeMirror span.CodeMirror-nonmatchingbracket{color:#f22}.CodeMirror-matchingtag{background:rgba(255,150,0,.3)}.CodeMirror-activeline-background{background:#e8f2ff}.CodeMirror{position:relative;overflow:hidden;background:#fff}.CodeMirror-scroll{overflow:scroll!important;margin-bottom:-30px;margin-right:-30px;padding-bottom:30px;height:100%;outline:0;position:relative}.CodeMirror-sizer{position:relative;border-right:30px solid transparent}.CodeMirror-gutter-filler,.CodeMirror-hscrollbar,.CodeMirror-scrollbar-filler,.CodeMirror-vscrollbar{position:absolute;z-index:6;display:none}.CodeMirror-vscrollbar{right:0;top:0;overflow-x:hidden;overflow-y:scroll}.CodeMirror-hscrollbar{bottom:0;left:0;overflow-y:hidden;overflow-x:scroll}.CodeMirror-scrollbar-filler{right:0;bottom:0}.CodeMirror-gutter-filler{left:0;bottom:0}.CodeMirror-gutters{position:absolute;left:0;top:0;min-height:100%;z-index:3}.CodeMirror-gutter{white-space:normal;height:100%;display:inline-block;vertical-align:top;margin-bottom:-30px}.CodeMirror-gutter-wrapper{position:absolute;z-index:4;background:0 0!important;border:none!important}.CodeMirror-gutter-background{position:absolute;top:0;bottom:0;z-index:4}.CodeMirror-gutter-elt{position:absolute;cursor:default;z-index:4}.CodeMirror-gutter-wrapper ::selection{background-color:transparent}.CodeMirror-gutter-wrapper ::-moz-selection{background-color:transparent}.CodeMirror-lines{cursor:text;min-height:1px}.CodeMirror pre{-moz-border-radius:0;-webkit-border-radius:0;border-radius:0;border-width:0;background:0 0;font-family:inherit;font-size:inherit;margin:0;white-space:pre;word-wrap:normal;line-height:inherit;color:inherit;z-index:2;position:relative;overflow:visible;-webkit-tap-highlight-color:transparent;-webkit-font-variant-ligatures:contextual;font-variant-ligatures:contextual}.CodeMirror-wrap pre{word-wrap:break-word;white-space:pre-wrap;word-break:normal}.CodeMirror-linebackground{position:absolute;left:0;right:0;top:0;bottom:0;z-index:0}.CodeMirror-linewidget{position:relative;z-index:2;overflow:auto}.CodeMirror-rtl pre{direction:rtl}.CodeMirror-code{outline:0}.CodeMirror-gutter,.CodeMirror-gutters,.CodeMirror-linenumber,.CodeMirror-scroll,.CodeMirror-sizer{-moz-box-sizing:content-box;box-sizing:content-box}.CodeMirror-measure{position:absolute;width:100%;height:0;overflow:hidden;visibility:hidden}.CodeMirror-cursor{position:absolute;pointer-events:none}.CodeMirror-measure pre{position:static}div.CodeMirror-cursors{visibility:hidden;position:relative;z-index:3}div.CodeMirror-dragcursors{visibility:visible}.CodeMirror-focused div.CodeMirror-cursors{visibility:visible}.CodeMirror-selected{background:#d9d9d9}.CodeMirror-focused .CodeMirror-selected{background:#d7d4f0}.CodeMirror-crosshair{cursor:crosshair}.CodeMirror-line::selection,.CodeMirror-line>span::selection,.CodeMirror-line>span>span::selection{background:#d7d4f0}.CodeMirror-line::-moz-selection,.CodeMirror-line>span::-moz-selection,.CodeMirror-line>span>span::-moz-selection{background:#d7d4f0}.cm-searching{background-color:#ffa;background-color:rgba(255,255,0,.4)}.cm-force-border{padding-right:.1px}@media print{.CodeMirror div.CodeMirror-cursors{visibility:hidden}}.cm-tab-wrap-hack:after{content:''}span.CodeMirror-selectedtext{background:0 0}
/*# sourceMappingURL=codemirror.min.css.map */

      .severity-low {
  background-color: #669603;
}

.severity-low:after {
  content : 'L';
}

.severity-unspecified {
  background-color: #666666;
}

.severity-unspecified:after {
  content : 'U';
}

.severity-style {
  background-color: #9932cc;
}

.severity-style:after {
  content : 'S';
}

.severity-medium {
  background-color: #a9d323;
  color: black;
}

.severity-medium:after {
  content : 'M';
}

.severity-high {
  background-color: #ffa800;
}

.severity-high:after {
  content : 'H';
}

.severity-critical {
  background-color: #e92625;
}

.severity-critical:after {
  content : 'C';
}

i[class*="severity-"] {
  line-height: normal;
  text-transform: capitalize;
  font-size: 0.8em;
  font-weight: bold;
  color: white;
  display: inline-block;
  width: 16px;
  height: 16px;
  text-align: center;
  font-family: sans-serif;
}

      html, body {
  width: 100%;
  height: 100%;
  padding: 0px;
  margin: 0px;
}

div.container {
  padding: 10px;
}

#content {
  height: 100%;
  display: block;
  overflow: hidden;
}

#content > div {
  margin: 10px;
  overflow: hidden;
  border: 1px solid #ddd;
  border-radius: 3px;
  overflow: hidden;
  height: 97%;
}

.button {
  background-color: #f1f1f1;
  text-decoration: none;
  display: inline-block;
  padding: 8px 16px;
  color: black;
  cursor: pointer;
}

.button:hover {
  background-color: #ddd;
  color: black;
}

.review-status {
  color: white;
  text-align: center;
}

.review-status-confirmed {
  background-color: #e92625;
}

.review-status-false-positive {
  background-color: grey;
}

.review-status-intentional {
  background-color: #669603;
}

      div.container {
  width: 100%;
  height: 100%;
  padding: 0px;
}

#editor-wrapper {
  margin: 10px;
}

#side-bar {
  float: left;
  width: 260px;
  margin: 0px;
}

#report-nav ul {
  list-style-type: none;
  padding: 0;
  margin: 0;
  overflow-y: auto;
  height: 100%;
}

#report-nav ul > li {
  padding: .4em;
  background-color: #fff;
  border-bottom: 1px solid rgba(0,0,0,.125);
  text-align: left;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

#report-nav ul > li.active {
  background-color: #427ea9;
  color: white;
}

#report-nav ul > li:hover {
  background-color: #427ea9;
  color: white;
  cursor: pointer;
}

#report-nav ul a {
  text-decoration: none;
}

#report-nav i[class*="severity-"] {
  margin-right: 5px;
}

.header {
  border-bottom: 1px solid lightgrey;
  font-family: monospace;
  padding: 10px;
  background-color: #fafbfc;
  border-bottom: 1px solid #e1e4e8;
  border-top-left-radius: 2px;
  border-top-right-radius: 2px;
}

#report-nav .header {
  font-weight: bold;
}

#editor-wrapper .header > div {
  padding-top: 2px;
}

#file-path,
#checker-name {
  color: #195ea2;
}

#review-status {
  padding: 0px 5px;
}

#file-path {
  font-family: monospace;
}

.check-msg {
  display: inline-block;
  padding: 3px 6px;
  margin: 1px;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
  border-radius: 5px;
}

.check-msg.info {
  color: #00546f;
  background-color: #bfdfe9;
  border: 1px solid #87a8b3;
}

.check-msg.error {
  background-color: #f2dede;
  color: #a94442;
  border: 1px solid #ebcccc;
}

.check-msg.macro {
  background-color: #d7dac2;
  color: #4f5c6d;
  border: 1px solid #d7dac2;
}

.check-msg.note {
  background-color: #d7d7d7;
  color: #4f5c6d;
  border: 1px solid #bfbfbf;
}

.check-msg.current {
  border: 2px dashed #3692ff;
}

.check-msg .tag {
  padding: 1px 5px;
  text-align: center;
  border-radius: 2px;
  margin-right: 5px;
  text-decoration: inherit;
}

.check-msg .tag.macro {
  background-color: #83876a;
  color: white;
  text-transform: capitalize;
}

.check-msg .tag.note {
  background-color: #9299a1;
  color: white;
  text-transform: capitalize;
}

.checker-enum {
  color: white;
  padding: 1px 5px;
  text-align: center;
  border-radius: 25px;
  margin-right: 5px;
  text-decoration: inherit;
}

.checker-enum.info {
  background-color: #427ea9;
}

.checker-enum.error {
  background-color: #a94442;
}

.arrow {
  border: solid black;
  border-width: 0 3px 3px 0;
  display: inline-block;
  padding: 3px;
  cursor: pointer;
  margin: 0px 5px;
}

.arrow:hover {
  border: solid #437ea8;
  border-width: 0 3px 3px 0;
}

.left-arrow {
  transform: rotate(135deg);
  -webkit-transform: rotate(135deg);
}

.right-arrow {
  transform: rotate(-45deg);
  -webkit-transform: rotate(-45deg);
}

    </style>

    <script type="text/javascript">
      function setNonCompatibleBrowserMessage() {
  document.body.innerHTML =
    '<h2 style="margin-left: 20px;">Your browser is not compatible with CodeChecker Viewer!</h2> \
     <p style="margin-left: 20px;">The version required for the following browsers are:</p> \
     <ul style="margin-left: 20px;"> \
     <li>Internet Explorer: version 9 or newer</li> \
     <li>Firefox: version 22.0 or newer</li> \
     </ul>';
}

// http://stackoverflow.com/questions/5916900/how-can-you-detect-the-version-of-a-browser
var browserVersion = (function(){
  var ua = navigator.userAgent, tem,
    M = ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];

  if (/trident/i.test(M[1])) {
    tem = /\brv[ :]+(\d+)/g.exec(ua) || [];
    return 'IE ' + (tem[1] || '');
  }

  if (M[1] === 'Chrome') {
    tem = ua.match(/\b(OPR|Edge)\/(\d+)/);
    if (tem != null) return tem.slice(1).join(' ').replace('OPR', 'Opera');
  }

  M = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, '-?'];
  if ((tem = ua.match(/version\/(\d+)/i)) != null) M.splice(1, 1, tem[1]);
    return M.join(' ');
})();

var pos = browserVersion.indexOf(' ');
var browser = browserVersion.substr(0, pos);
var version = parseInt(browserVersion.substr(pos + 1));

var browserCompatible
  = browser === 'Firefox'
  ? version >= 22
  : browser === 'IE'
  ? version >= 9
  : true;


      /* MIT License

Copyright (C) 2017 by Marijn Haverbeke <marijnh@gmail.com> and others

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
 */
      !function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.CodeMirror=t()}(this,function(){"use strict";function e(e){return new RegExp("(^|\\s)"+e+"(?:$|\\s)\\s*")}function t(e){for(var t=e.childNodes.length;t>0;--t)e.removeChild(e.firstChild);return e}function r(e,r){return t(e).appendChild(r)}function n(e,t,r,n){var i=document.createElement(e);if(r&&(i.className=r),n&&(i.style.cssText=n),"string"==typeof t)i.appendChild(document.createTextNode(t));else if(t)for(var o=0;o<t.length;++o)i.appendChild(t[o]);return i}function i(e,t,r,i){var o=n(e,t,r,i);return o.setAttribute("role","presentation"),o}function o(e,t){if(3==t.nodeType&&(t=t.parentNode),e.contains)return e.contains(t);do{if(11==t.nodeType&&(t=t.host),t==e)return!0}while(t=t.parentNode)}function l(){var e;try{e=document.activeElement}catch(t){e=document.body||null}for(;e&&e.shadowRoot&&e.shadowRoot.activeElement;)e=e.shadowRoot.activeElement;return e}function s(t,r){var n=t.className;e(r).test(n)||(t.className+=(n?" ":"")+r)}function a(t,r){for(var n=t.split(" "),i=0;i<n.length;i++)n[i]&&!e(n[i]).test(r)&&(r+=" "+n[i]);return r}function u(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t)}}function c(e,t,r){t||(t={});for(var n in e)!e.hasOwnProperty(n)||!1===r&&t.hasOwnProperty(n)||(t[n]=e[n]);return t}function f(e,t,r,n,i){null==t&&-1==(t=e.search(/[^\s\u00a0]/))&&(t=e.length);for(var o=n||0,l=i||0;;){var s=e.indexOf("\t",o);if(s<0||s>=t)return l+(t-o);l+=s-o,l+=r-l%r,o=s+1}}function h(e,t){for(var r=0;r<e.length;++r)if(e[r]==t)return r;return-1}function d(e,t,r){for(var n=0,i=0;;){var o=e.indexOf("\t",n);-1==o&&(o=e.length);var l=o-n;if(o==e.length||i+l>=t)return n+Math.min(l,t-i);if(i+=o-n,i+=r-i%r,n=o+1,i>=t)return n}}function p(e){for(;Kl.length<=e;)Kl.push(g(Kl)+" ");return Kl[e]}function g(e){return e[e.length-1]}function v(e,t){for(var r=[],n=0;n<e.length;n++)r[n]=t(e[n],n);return r}function m(e,t,r){for(var n=0,i=r(t);n<e.length&&r(e[n])<=i;)n++;e.splice(n,0,t)}function y(){}function b(e,t){var r;return Object.create?r=Object.create(e):(y.prototype=e,r=new y),t&&c(t,r),r}function w(e){return/\w/.test(e)||e>""&&(e.toUpperCase()!=e.toLowerCase()||jl.test(e))}function x(e,t){return t?!!(t.source.indexOf("\\w")>-1&&w(e))||t.test(e):w(e)}function C(e){for(var t in e)if(e.hasOwnProperty(t)&&e[t])return!1;return!0}function S(e){return e.charCodeAt(0)>=768&&Xl.test(e)}function L(e,t,r){for(;(r<0?t>0:t<e.length)&&S(e.charAt(t));)t+=r;return t}function k(e,t,r){for(var n=t>r?-1:1;;){if(t==r)return t;var i=(t+r)/2,o=n<0?Math.ceil(i):Math.floor(i);if(o==t)return e(o)?t:r;e(o)?r=o:t=o+n}}function T(e,t,r){var o=this;this.input=r,o.scrollbarFiller=n("div",null,"CodeMirror-scrollbar-filler"),o.scrollbarFiller.setAttribute("cm-not-content","true"),o.gutterFiller=n("div",null,"CodeMirror-gutter-filler"),o.gutterFiller.setAttribute("cm-not-content","true"),o.lineDiv=i("div",null,"CodeMirror-code"),o.selectionDiv=n("div",null,null,"position: relative; z-index: 1"),o.cursorDiv=n("div",null,"CodeMirror-cursors"),o.measure=n("div",null,"CodeMirror-measure"),o.lineMeasure=n("div",null,"CodeMirror-measure"),o.lineSpace=i("div",[o.measure,o.lineMeasure,o.selectionDiv,o.cursorDiv,o.lineDiv],null,"position: relative; outline: none");var l=i("div",[o.lineSpace],"CodeMirror-lines");o.mover=n("div",[l],null,"position: relative"),o.sizer=n("div",[o.mover],"CodeMirror-sizer"),o.sizerWidth=null,o.heightForcer=n("div",null,null,"position: absolute; height: "+Rl+"px; width: 1px;"),o.gutters=n("div",null,"CodeMirror-gutters"),o.lineGutter=null,o.scroller=n("div",[o.sizer,o.heightForcer,o.gutters],"CodeMirror-scroll"),o.scroller.setAttribute("tabIndex","-1"),o.wrapper=n("div",[o.scrollbarFiller,o.gutterFiller,o.scroller],"CodeMirror"),gl&&vl<8&&(o.gutters.style.zIndex=-1,o.scroller.style.paddingRight=0),ml||fl&&Tl||(o.scroller.draggable=!0),e&&(e.appendChild?e.appendChild(o.wrapper):e(o.wrapper)),o.viewFrom=o.viewTo=t.first,o.reportedViewFrom=o.reportedViewTo=t.first,o.view=[],o.renderedView=null,o.externalMeasured=null,o.viewOffset=0,o.lastWrapHeight=o.lastWrapWidth=0,o.updateLineNumbers=null,o.nativeBarWidth=o.barHeight=o.barWidth=0,o.scrollbarsClipped=!1,o.lineNumWidth=o.lineNumInnerWidth=o.lineNumChars=null,o.alignWidgets=!1,o.cachedCharWidth=o.cachedTextHeight=o.cachedPaddingH=null,o.maxLine=null,o.maxLineLength=0,o.maxLineChanged=!1,o.wheelDX=o.wheelDY=o.wheelStartX=o.wheelStartY=null,o.shift=!1,o.selForContextMenu=null,o.activeTouch=null,r.init(o)}function M(e,t){if((t-=e.first)<0||t>=e.size)throw new Error("There is no line "+(t+e.first)+" in the document.");for(var r=e;!r.lines;)for(var n=0;;++n){var i=r.children[n],o=i.chunkSize();if(t<o){r=i;break}t-=o}return r.lines[t]}function N(e,t,r){var n=[],i=t.line;return e.iter(t.line,r.line+1,function(e){var o=e.text;i==r.line&&(o=o.slice(0,r.ch)),i==t.line&&(o=o.slice(t.ch)),n.push(o),++i}),n}function O(e,t,r){var n=[];return e.iter(t,r,function(e){n.push(e.text)}),n}function A(e,t){var r=t-e.height;if(r)for(var n=e;n;n=n.parent)n.height+=r}function W(e){if(null==e.parent)return null;for(var t=e.parent,r=h(t.lines,e),n=t.parent;n;t=n,n=n.parent)for(var i=0;n.children[i]!=t;++i)r+=n.children[i].chunkSize();return r+t.first}function D(e,t){var r=e.first;e:do{for(var n=0;n<e.children.length;++n){var i=e.children[n],o=i.height;if(t<o){e=i;continue e}t-=o,r+=i.chunkSize()}return r}while(!e.lines);for(var l=0;l<e.lines.length;++l){var s=e.lines[l].height;if(t<s)break;t-=s}return r+l}function H(e,t){return t>=e.first&&t<e.first+e.size}function F(e,t){return String(e.lineNumberFormatter(t+e.firstLineNumber))}function E(e,t,r){if(void 0===r&&(r=null),!(this instanceof E))return new E(e,t,r);this.line=e,this.ch=t,this.sticky=r}function P(e,t){return e.line-t.line||e.ch-t.ch}function I(e,t){return e.sticky==t.sticky&&0==P(e,t)}function z(e){return E(e.line,e.ch)}function R(e,t){return P(e,t)<0?t:e}function B(e,t){return P(e,t)<0?e:t}function G(e,t){return Math.max(e.first,Math.min(t,e.first+e.size-1))}function U(e,t){if(t.line<e.first)return E(e.first,0);var r=e.first+e.size-1;return t.line>r?E(r,M(e,r).text.length):V(t,M(e,t.line).text.length)}function V(e,t){var r=e.ch;return null==r||r>t?E(e.line,t):r<0?E(e.line,0):e}function K(e,t){for(var r=[],n=0;n<t.length;n++)r[n]=U(e,t[n]);return r}function j(){Yl=!0}function X(){_l=!0}function Y(e,t,r){this.marker=e,this.from=t,this.to=r}function _(e,t){if(e)for(var r=0;r<e.length;++r){var n=e[r];if(n.marker==t)return n}}function $(e,t){for(var r,n=0;n<e.length;++n)e[n]!=t&&(r||(r=[])).push(e[n]);return r}function q(e,t){e.markedSpans=e.markedSpans?e.markedSpans.concat([t]):[t],t.marker.attachLine(e)}function Z(e,t,r){var n;if(e)for(var i=0;i<e.length;++i){var o=e[i],l=o.marker;if(null==o.from||(l.inclusiveLeft?o.from<=t:o.from<t)||o.from==t&&"bookmark"==l.type&&(!r||!o.marker.insertLeft)){var s=null==o.to||(l.inclusiveRight?o.to>=t:o.to>t);(n||(n=[])).push(new Y(l,o.from,s?null:o.to))}}return n}function Q(e,t,r){var n;if(e)for(var i=0;i<e.length;++i){var o=e[i],l=o.marker;if(null==o.to||(l.inclusiveRight?o.to>=t:o.to>t)||o.from==t&&"bookmark"==l.type&&(!r||o.marker.insertLeft)){var s=null==o.from||(l.inclusiveLeft?o.from<=t:o.from<t);(n||(n=[])).push(new Y(l,s?null:o.from-t,null==o.to?null:o.to-t))}}return n}function J(e,t){if(t.full)return null;var r=H(e,t.from.line)&&M(e,t.from.line).markedSpans,n=H(e,t.to.line)&&M(e,t.to.line).markedSpans;if(!r&&!n)return null;var i=t.from.ch,o=t.to.ch,l=0==P(t.from,t.to),s=Z(r,i,l),a=Q(n,o,l),u=1==t.text.length,c=g(t.text).length+(u?i:0);if(s)for(var f=0;f<s.length;++f){var h=s[f];if(null==h.to){var d=_(a,h.marker);d?u&&(h.to=null==d.to?null:d.to+c):h.to=i}}if(a)for(var p=0;p<a.length;++p){var v=a[p];null!=v.to&&(v.to+=c),null==v.from?_(s,v.marker)||(v.from=c,u&&(s||(s=[])).push(v)):(v.from+=c,u&&(s||(s=[])).push(v))}s&&(s=ee(s)),a&&a!=s&&(a=ee(a));var m=[s];if(!u){var y,b=t.text.length-2;if(b>0&&s)for(var w=0;w<s.length;++w)null==s[w].to&&(y||(y=[])).push(new Y(s[w].marker,null,null));for(var x=0;x<b;++x)m.push(y);m.push(a)}return m}function ee(e){for(var t=0;t<e.length;++t){var r=e[t];null!=r.from&&r.from==r.to&&!1!==r.marker.clearWhenEmpty&&e.splice(t--,1)}return e.length?e:null}function te(e,t,r){var n=null;if(e.iter(t.line,r.line+1,function(e){if(e.markedSpans)for(var t=0;t<e.markedSpans.length;++t){var r=e.markedSpans[t].marker;!r.readOnly||n&&-1!=h(n,r)||(n||(n=[])).push(r)}}),!n)return null;for(var i=[{from:t,to:r}],o=0;o<n.length;++o)for(var l=n[o],s=l.find(0),a=0;a<i.length;++a){var u=i[a];if(!(P(u.to,s.from)<0||P(u.from,s.to)>0)){var c=[a,1],f=P(u.from,s.from),d=P(u.to,s.to);(f<0||!l.inclusiveLeft&&!f)&&c.push({from:u.from,to:s.from}),(d>0||!l.inclusiveRight&&!d)&&c.push({from:s.to,to:u.to}),i.splice.apply(i,c),a+=c.length-3}}return i}function re(e){var t=e.markedSpans;if(t){for(var r=0;r<t.length;++r)t[r].marker.detachLine(e);e.markedSpans=null}}function ne(e,t){if(t){for(var r=0;r<t.length;++r)t[r].marker.attachLine(e);e.markedSpans=t}}function ie(e){return e.inclusiveLeft?-1:0}function oe(e){return e.inclusiveRight?1:0}function le(e,t){var r=e.lines.length-t.lines.length;if(0!=r)return r;var n=e.find(),i=t.find(),o=P(n.from,i.from)||ie(e)-ie(t);if(o)return-o;var l=P(n.to,i.to)||oe(e)-oe(t);return l||t.id-e.id}function se(e,t){var r,n=_l&&e.markedSpans;if(n)for(var i=void 0,o=0;o<n.length;++o)(i=n[o]).marker.collapsed&&null==(t?i.from:i.to)&&(!r||le(r,i.marker)<0)&&(r=i.marker);return r}function ae(e){return se(e,!0)}function ue(e){return se(e,!1)}function ce(e,t,r,n,i){var o=M(e,t),l=_l&&o.markedSpans;if(l)for(var s=0;s<l.length;++s){var a=l[s];if(a.marker.collapsed){var u=a.marker.find(0),c=P(u.from,r)||ie(a.marker)-ie(i),f=P(u.to,n)||oe(a.marker)-oe(i);if(!(c>=0&&f<=0||c<=0&&f>=0)&&(c<=0&&(a.marker.inclusiveRight&&i.inclusiveLeft?P(u.to,r)>=0:P(u.to,r)>0)||c>=0&&(a.marker.inclusiveRight&&i.inclusiveLeft?P(u.from,n)<=0:P(u.from,n)<0)))return!0}}}function fe(e){for(var t;t=ae(e);)e=t.find(-1,!0).line;return e}function he(e){for(var t;t=ue(e);)e=t.find(1,!0).line;return e}function de(e){for(var t,r;t=ue(e);)e=t.find(1,!0).line,(r||(r=[])).push(e);return r}function pe(e,t){var r=M(e,t),n=fe(r);return r==n?t:W(n)}function ge(e,t){if(t>e.lastLine())return t;var r,n=M(e,t);if(!ve(e,n))return t;for(;r=ue(n);)n=r.find(1,!0).line;return W(n)+1}function ve(e,t){var r=_l&&t.markedSpans;if(r)for(var n=void 0,i=0;i<r.length;++i)if((n=r[i]).marker.collapsed){if(null==n.from)return!0;if(!n.marker.widgetNode&&0==n.from&&n.marker.inclusiveLeft&&me(e,t,n))return!0}}function me(e,t,r){if(null==r.to){var n=r.marker.find(1,!0);return me(e,n.line,_(n.line.markedSpans,r.marker))}if(r.marker.inclusiveRight&&r.to==t.text.length)return!0;for(var i=void 0,o=0;o<t.markedSpans.length;++o)if((i=t.markedSpans[o]).marker.collapsed&&!i.marker.widgetNode&&i.from==r.to&&(null==i.to||i.to!=r.from)&&(i.marker.inclusiveLeft||r.marker.inclusiveRight)&&me(e,t,i))return!0}function ye(e){for(var t=0,r=(e=fe(e)).parent,n=0;n<r.lines.length;++n){var i=r.lines[n];if(i==e)break;t+=i.height}for(var o=r.parent;o;r=o,o=r.parent)for(var l=0;l<o.children.length;++l){var s=o.children[l];if(s==r)break;t+=s.height}return t}function be(e){if(0==e.height)return 0;for(var t,r=e.text.length,n=e;t=ae(n);){var i=t.find(0,!0);n=i.from.line,r+=i.from.ch-i.to.ch}for(n=e;t=ue(n);){var o=t.find(0,!0);r-=n.text.length-o.from.ch,r+=(n=o.to.line).text.length-o.to.ch}return r}function we(e){var t=e.display,r=e.doc;t.maxLine=M(r,r.first),t.maxLineLength=be(t.maxLine),t.maxLineChanged=!0,r.iter(function(e){var r=be(e);r>t.maxLineLength&&(t.maxLineLength=r,t.maxLine=e)})}function xe(e,t,r,n){if(!e)return n(t,r,"ltr",0);for(var i=!1,o=0;o<e.length;++o){var l=e[o];(l.from<r&&l.to>t||t==r&&l.to==t)&&(n(Math.max(l.from,t),Math.min(l.to,r),1==l.level?"rtl":"ltr",o),i=!0)}i||n(t,r,"ltr")}function Ce(e,t,r){var n;$l=null;for(var i=0;i<e.length;++i){var o=e[i];if(o.from<t&&o.to>t)return i;o.to==t&&(o.from!=o.to&&"before"==r?n=i:$l=i),o.from==t&&(o.from!=o.to&&"before"!=r?n=i:$l=i)}return null!=n?n:$l}function Se(e,t){var r=e.order;return null==r&&(r=e.order=ql(e.text,t)),r}function Le(e,t){return e._handlers&&e._handlers[t]||Zl}function ke(e,t,r){if(e.removeEventListener)e.removeEventListener(t,r,!1);else if(e.detachEvent)e.detachEvent("on"+t,r);else{var n=e._handlers,i=n&&n[t];if(i){var o=h(i,r);o>-1&&(n[t]=i.slice(0,o).concat(i.slice(o+1)))}}}function Te(e,t){var r=Le(e,t);if(r.length)for(var n=Array.prototype.slice.call(arguments,2),i=0;i<r.length;++i)r[i].apply(null,n)}function Me(e,t,r){return"string"==typeof t&&(t={type:t,preventDefault:function(){this.defaultPrevented=!0}}),Te(e,r||t.type,e,t),He(t)||t.codemirrorIgnore}function Ne(e){var t=e._handlers&&e._handlers.cursorActivity;if(t)for(var r=e.curOp.cursorActivityHandlers||(e.curOp.cursorActivityHandlers=[]),n=0;n<t.length;++n)-1==h(r,t[n])&&r.push(t[n])}function Oe(e,t){return Le(e,t).length>0}function Ae(e){e.prototype.on=function(e,t){Ql(this,e,t)},e.prototype.off=function(e,t){ke(this,e,t)}}function We(e){e.preventDefault?e.preventDefault():e.returnValue=!1}function De(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}function He(e){return null!=e.defaultPrevented?e.defaultPrevented:0==e.returnValue}function Fe(e){We(e),De(e)}function Ee(e){return e.target||e.srcElement}function Pe(e){var t=e.which;return null==t&&(1&e.button?t=1:2&e.button?t=3:4&e.button&&(t=2)),Ml&&e.ctrlKey&&1==t&&(t=3),t}function Ie(e){if(null==Il){var t=n("span","​");r(e,n("span",[t,document.createTextNode("x")])),0!=e.firstChild.offsetHeight&&(Il=t.offsetWidth<=1&&t.offsetHeight>2&&!(gl&&vl<8))}var i=Il?n("span","​"):n("span"," ",null,"display: inline-block; width: 1px; margin-right: -1px");return i.setAttribute("cm-text",""),i}function ze(e){if(null!=zl)return zl;var n=r(e,document.createTextNode("AخA")),i=Wl(n,0,1).getBoundingClientRect(),o=Wl(n,1,2).getBoundingClientRect();return t(e),!(!i||i.left==i.right)&&(zl=o.right-i.right<3)}function Re(e){if(null!=ns)return ns;var t=r(e,n("span","x")),i=t.getBoundingClientRect(),o=Wl(t,0,1).getBoundingClientRect();return ns=Math.abs(i.left-o.left)>1}function Be(e,t){arguments.length>2&&(t.dependencies=Array.prototype.slice.call(arguments,2)),is[e]=t}function Ge(e){if("string"==typeof e&&os.hasOwnProperty(e))e=os[e];else if(e&&"string"==typeof e.name&&os.hasOwnProperty(e.name)){var t=os[e.name];"string"==typeof t&&(t={name:t}),(e=b(t,e)).name=t.name}else{if("string"==typeof e&&/^[\w\-]+\/[\w\-]+\+xml$/.test(e))return Ge("application/xml");if("string"==typeof e&&/^[\w\-]+\/[\w\-]+\+json$/.test(e))return Ge("application/json")}return"string"==typeof e?{name:e}:e||{name:"null"}}function Ue(e,t){t=Ge(t);var r=is[t.name];if(!r)return Ue(e,"text/plain");var n=r(e,t);if(ls.hasOwnProperty(t.name)){var i=ls[t.name];for(var o in i)i.hasOwnProperty(o)&&(n.hasOwnProperty(o)&&(n["_"+o]=n[o]),n[o]=i[o])}if(n.name=t.name,t.helperType&&(n.helperType=t.helperType),t.modeProps)for(var l in t.modeProps)n[l]=t.modeProps[l];return n}function Ve(e,t){c(t,ls.hasOwnProperty(e)?ls[e]:ls[e]={})}function Ke(e,t){if(!0===t)return t;if(e.copyState)return e.copyState(t);var r={};for(var n in t){var i=t[n];i instanceof Array&&(i=i.concat([])),r[n]=i}return r}function je(e,t){for(var r;e.innerMode&&(r=e.innerMode(t))&&r.mode!=e;)t=r.state,e=r.mode;return r||{mode:e,state:t}}function Xe(e,t,r){return!e.startState||e.startState(t,r)}function Ye(e,t,r,n){var i=[e.state.modeGen],o={};tt(e,t.text,e.doc.mode,r,function(e,t){return i.push(e,t)},o,n);for(var l=r.state,s=0;s<e.state.overlays.length;++s)!function(n){var l=e.state.overlays[n],s=1,a=0;r.state=!0,tt(e,t.text,l.mode,r,function(e,t){for(var r=s;a<e;){var n=i[s];n>e&&i.splice(s,1,e,i[s+1],n),s+=2,a=Math.min(e,n)}if(t)if(l.opaque)i.splice(r,s-r,e,"overlay "+t),s=r+2;else for(;r<s;r+=2){var o=i[r+1];i[r+1]=(o?o+" ":"")+"overlay "+t}},o)}(s);return r.state=l,{styles:i,classes:o.bgClass||o.textClass?o:null}}function _e(e,t,r){if(!t.styles||t.styles[0]!=e.state.modeGen){var n=$e(e,W(t)),i=t.text.length>e.options.maxHighlightLength&&Ke(e.doc.mode,n.state),o=Ye(e,t,n);i&&(n.state=i),t.stateAfter=n.save(!i),t.styles=o.styles,o.classes?t.styleClasses=o.classes:t.styleClasses&&(t.styleClasses=null),r===e.doc.highlightFrontier&&(e.doc.modeFrontier=Math.max(e.doc.modeFrontier,++e.doc.highlightFrontier))}return t.styles}function $e(e,t,r){var n=e.doc,i=e.display;if(!n.mode.startState)return new us(n,!0,t);var o=rt(e,t,r),l=o>n.first&&M(n,o-1).stateAfter,s=l?us.fromSaved(n,l,o):new us(n,Xe(n.mode),o);return n.iter(o,t,function(r){qe(e,r.text,s);var n=s.line;r.stateAfter=n==t-1||n%5==0||n>=i.viewFrom&&n<i.viewTo?s.save():null,s.nextLine()}),r&&(n.modeFrontier=s.line),s}function qe(e,t,r,n){var i=e.doc.mode,o=new ss(t,e.options.tabSize,r);for(o.start=o.pos=n||0,""==t&&Ze(i,r.state);!o.eol();)Qe(i,o,r.state),o.start=o.pos}function Ze(e,t){if(e.blankLine)return e.blankLine(t);if(e.innerMode){var r=je(e,t);return r.mode.blankLine?r.mode.blankLine(r.state):void 0}}function Qe(e,t,r,n){for(var i=0;i<10;i++){n&&(n[0]=je(e,r).mode);var o=e.token(t,r);if(t.pos>t.start)return o}throw new Error("Mode "+e.name+" failed to advance stream.")}function Je(e,t,r,n){var i,o,l=e.doc,s=l.mode,a=M(l,(t=U(l,t)).line),u=$e(e,t.line,r),c=new ss(a.text,e.options.tabSize,u);for(n&&(o=[]);(n||c.pos<t.ch)&&!c.eol();)c.start=c.pos,i=Qe(s,c,u.state),n&&o.push(new cs(c,i,Ke(l.mode,u.state)));return n?o:new cs(c,i,u.state)}function et(e,t){if(e)for(;;){var r=e.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!r)break;e=e.slice(0,r.index)+e.slice(r.index+r[0].length);var n=r[1]?"bgClass":"textClass";null==t[n]?t[n]=r[2]:new RegExp("(?:^|s)"+r[2]+"(?:$|s)").test(t[n])||(t[n]+=" "+r[2])}return e}function tt(e,t,r,n,i,o,l){var s=r.flattenSpans;null==s&&(s=e.options.flattenSpans);var a,u=0,c=null,f=new ss(t,e.options.tabSize,n),h=e.options.addModeClass&&[null];for(""==t&&et(Ze(r,n.state),o);!f.eol();){if(f.pos>e.options.maxHighlightLength?(s=!1,l&&qe(e,t,n,f.pos),f.pos=t.length,a=null):a=et(Qe(r,f,n.state,h),o),h){var d=h[0].name;d&&(a="m-"+(a?d+" "+a:d))}if(!s||c!=a){for(;u<f.start;)i(u=Math.min(f.start,u+5e3),c);c=a}f.start=f.pos}for(;u<f.pos;){var p=Math.min(f.pos,u+5e3);i(p,c),u=p}}function rt(e,t,r){for(var n,i,o=e.doc,l=r?-1:t-(e.doc.mode.innerMode?1e3:100),s=t;s>l;--s){if(s<=o.first)return o.first;var a=M(o,s-1),u=a.stateAfter;if(u&&(!r||s+(u instanceof as?u.lookAhead:0)<=o.modeFrontier))return s;var c=f(a.text,null,e.options.tabSize);(null==i||n>c)&&(i=s-1,n=c)}return i}function nt(e,t){if(e.modeFrontier=Math.min(e.modeFrontier,t),!(e.highlightFrontier<t-10)){for(var r=e.first,n=t-1;n>r;n--){var i=M(e,n).stateAfter;if(i&&(!(i instanceof as)||n+i.lookAhead<t)){r=n+1;break}}e.highlightFrontier=Math.min(e.highlightFrontier,r)}}function it(e,t,r,n){e.text=t,e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null),null!=e.order&&(e.order=null),re(e),ne(e,r);var i=n?n(e):1;i!=e.height&&A(e,i)}function ot(e){e.parent=null,re(e)}function lt(e,t){if(!e||/^\s*$/.test(e))return null;var r=t.addModeClass?ps:ds;return r[e]||(r[e]=e.replace(/\S+/g,"cm-$&"))}function st(e,t){var r=i("span",null,null,ml?"padding-right: .1px":null),n={pre:i("pre",[r],"CodeMirror-line"),content:r,col:0,pos:0,cm:e,trailingSpace:!1,splitSpaces:(gl||ml)&&e.getOption("lineWrapping")};t.measure={};for(var o=0;o<=(t.rest?t.rest.length:0);o++){var l=o?t.rest[o-1]:t.line,s=void 0;n.pos=0,n.addToken=ut,ze(e.display.measure)&&(s=Se(l,e.doc.direction))&&(n.addToken=ft(n.addToken,s)),n.map=[],dt(l,n,_e(e,l,t!=e.display.externalMeasured&&W(l))),l.styleClasses&&(l.styleClasses.bgClass&&(n.bgClass=a(l.styleClasses.bgClass,n.bgClass||"")),l.styleClasses.textClass&&(n.textClass=a(l.styleClasses.textClass,n.textClass||""))),0==n.map.length&&n.map.push(0,0,n.content.appendChild(Ie(e.display.measure))),0==o?(t.measure.map=n.map,t.measure.cache={}):((t.measure.maps||(t.measure.maps=[])).push(n.map),(t.measure.caches||(t.measure.caches=[])).push({}))}if(ml){var u=n.content.lastChild;(/\bcm-tab\b/.test(u.className)||u.querySelector&&u.querySelector(".cm-tab"))&&(n.content.className="cm-tab-wrap-hack")}return Te(e,"renderLine",e,t.line,n.pre),n.pre.className&&(n.textClass=a(n.pre.className,n.textClass||"")),n}function at(e){var t=n("span","•","cm-invalidchar");return t.title="\\u"+e.charCodeAt(0).toString(16),t.setAttribute("aria-label",t.title),t}function ut(e,t,r,i,o,l,s){if(t){var a,u=e.splitSpaces?ct(t,e.trailingSpace):t,c=e.cm.state.specialChars,f=!1;if(c.test(t)){a=document.createDocumentFragment();for(var h=0;;){c.lastIndex=h;var d=c.exec(t),g=d?d.index-h:t.length-h;if(g){var v=document.createTextNode(u.slice(h,h+g));gl&&vl<9?a.appendChild(n("span",[v])):a.appendChild(v),e.map.push(e.pos,e.pos+g,v),e.col+=g,e.pos+=g}if(!d)break;h+=g+1;var m=void 0;if("\t"==d[0]){var y=e.cm.options.tabSize,b=y-e.col%y;(m=a.appendChild(n("span",p(b),"cm-tab"))).setAttribute("role","presentation"),m.setAttribute("cm-text","\t"),e.col+=b}else"\r"==d[0]||"\n"==d[0]?((m=a.appendChild(n("span","\r"==d[0]?"␍":"␤","cm-invalidchar"))).setAttribute("cm-text",d[0]),e.col+=1):((m=e.cm.options.specialCharPlaceholder(d[0])).setAttribute("cm-text",d[0]),gl&&vl<9?a.appendChild(n("span",[m])):a.appendChild(m),e.col+=1);e.map.push(e.pos,e.pos+1,m),e.pos++}}else e.col+=t.length,a=document.createTextNode(u),e.map.push(e.pos,e.pos+t.length,a),gl&&vl<9&&(f=!0),e.pos+=t.length;if(e.trailingSpace=32==u.charCodeAt(t.length-1),r||i||o||f||s){var w=r||"";i&&(w+=i),o&&(w+=o);var x=n("span",[a],w,s);return l&&(x.title=l),e.content.appendChild(x)}e.content.appendChild(a)}}function ct(e,t){if(e.length>1&&!/  /.test(e))return e;for(var r=t,n="",i=0;i<e.length;i++){var o=e.charAt(i);" "!=o||!r||i!=e.length-1&&32!=e.charCodeAt(i+1)||(o=" "),n+=o,r=" "==o}return n}function ft(e,t){return function(r,n,i,o,l,s,a){i=i?i+" cm-force-border":"cm-force-border";for(var u=r.pos,c=u+n.length;;){for(var f=void 0,h=0;h<t.length&&!((f=t[h]).to>u&&f.from<=u);h++);if(f.to>=c)return e(r,n,i,o,l,s,a);e(r,n.slice(0,f.to-u),i,o,null,s,a),o=null,n=n.slice(f.to-u),u=f.to}}}function ht(e,t,r,n){var i=!n&&r.widgetNode;i&&e.map.push(e.pos,e.pos+t,i),!n&&e.cm.display.input.needsContentAttribute&&(i||(i=e.content.appendChild(document.createElement("span"))),i.setAttribute("cm-marker",r.id)),i&&(e.cm.display.input.setUneditable(i),e.content.appendChild(i)),e.pos+=t,e.trailingSpace=!1}function dt(e,t,r){var n=e.markedSpans,i=e.text,o=0;if(n)for(var l,s,a,u,c,f,h,d=i.length,p=0,g=1,v="",m=0;;){if(m==p){a=u=c=f=s="",h=null,m=1/0;for(var y=[],b=void 0,w=0;w<n.length;++w){var x=n[w],C=x.marker;"bookmark"==C.type&&x.from==p&&C.widgetNode?y.push(C):x.from<=p&&(null==x.to||x.to>p||C.collapsed&&x.to==p&&x.from==p)?(null!=x.to&&x.to!=p&&m>x.to&&(m=x.to,u=""),C.className&&(a+=" "+C.className),C.css&&(s=(s?s+";":"")+C.css),C.startStyle&&x.from==p&&(c+=" "+C.startStyle),C.endStyle&&x.to==m&&(b||(b=[])).push(C.endStyle,x.to),C.title&&!f&&(f=C.title),C.collapsed&&(!h||le(h.marker,C)<0)&&(h=x)):x.from>p&&m>x.from&&(m=x.from)}if(b)for(var S=0;S<b.length;S+=2)b[S+1]==m&&(u+=" "+b[S]);if(!h||h.from==p)for(var L=0;L<y.length;++L)ht(t,0,y[L]);if(h&&(h.from||0)==p){if(ht(t,(null==h.to?d+1:h.to)-p,h.marker,null==h.from),null==h.to)return;h.to==p&&(h=!1)}}if(p>=d)break;for(var k=Math.min(d,m);;){if(v){var T=p+v.length;if(!h){var M=T>k?v.slice(0,k-p):v;t.addToken(t,M,l?l+a:a,c,p+M.length==m?u:"",f,s)}if(T>=k){v=v.slice(k-p),p=k;break}p=T,c=""}v=i.slice(o,o=r[g++]),l=lt(r[g++],t.cm.options)}}else for(var N=1;N<r.length;N+=2)t.addToken(t,i.slice(o,o=r[N]),lt(r[N+1],t.cm.options))}function pt(e,t,r){this.line=t,this.rest=de(t),this.size=this.rest?W(g(this.rest))-r+1:1,this.node=this.text=null,this.hidden=ve(e,t)}function gt(e,t,r){for(var n,i=[],o=t;o<r;o=n){var l=new pt(e.doc,M(e.doc,o),o);n=o+l.size,i.push(l)}return i}function vt(e){gs?gs.ops.push(e):e.ownsGroup=gs={ops:[e],delayedCallbacks:[]}}function mt(e){var t=e.delayedCallbacks,r=0;do{for(;r<t.length;r++)t[r].call(null);for(var n=0;n<e.ops.length;n++){var i=e.ops[n];if(i.cursorActivityHandlers)for(;i.cursorActivityCalled<i.cursorActivityHandlers.length;)i.cursorActivityHandlers[i.cursorActivityCalled++].call(null,i.cm)}}while(r<t.length)}function yt(e,t){var r=e.ownsGroup;if(r)try{mt(r)}finally{gs=null,t(r)}}function bt(e,t){var r=Le(e,t);if(r.length){var n,i=Array.prototype.slice.call(arguments,2);gs?n=gs.delayedCallbacks:vs?n=vs:(n=vs=[],setTimeout(wt,0));for(var o=0;o<r.length;++o)!function(e){n.push(function(){return r[e].apply(null,i)})}(o)}}function wt(){var e=vs;vs=null;for(var t=0;t<e.length;++t)e[t]()}function xt(e,t,r,n){for(var i=0;i<t.changes.length;i++){var o=t.changes[i];"text"==o?kt(e,t):"gutter"==o?Mt(e,t,r,n):"class"==o?Tt(e,t):"widget"==o&&Nt(e,t,n)}t.changes=null}function Ct(e){return e.node==e.text&&(e.node=n("div",null,null,"position: relative"),e.text.parentNode&&e.text.parentNode.replaceChild(e.node,e.text),e.node.appendChild(e.text),gl&&vl<8&&(e.node.style.zIndex=2)),e.node}function St(e,t){var r=t.bgClass?t.bgClass+" "+(t.line.bgClass||""):t.line.bgClass;if(r&&(r+=" CodeMirror-linebackground"),t.background)r?t.background.className=r:(t.background.parentNode.removeChild(t.background),t.background=null);else if(r){var i=Ct(t);t.background=i.insertBefore(n("div",null,r),i.firstChild),e.display.input.setUneditable(t.background)}}function Lt(e,t){var r=e.display.externalMeasured;return r&&r.line==t.line?(e.display.externalMeasured=null,t.measure=r.measure,r.built):st(e,t)}function kt(e,t){var r=t.text.className,n=Lt(e,t);t.text==t.node&&(t.node=n.pre),t.text.parentNode.replaceChild(n.pre,t.text),t.text=n.pre,n.bgClass!=t.bgClass||n.textClass!=t.textClass?(t.bgClass=n.bgClass,t.textClass=n.textClass,Tt(e,t)):r&&(t.text.className=r)}function Tt(e,t){St(e,t),t.line.wrapClass?Ct(t).className=t.line.wrapClass:t.node!=t.text&&(t.node.className="");var r=t.textClass?t.textClass+" "+(t.line.textClass||""):t.line.textClass;t.text.className=r||""}function Mt(e,t,r,i){if(t.gutter&&(t.node.removeChild(t.gutter),t.gutter=null),t.gutterBackground&&(t.node.removeChild(t.gutterBackground),t.gutterBackground=null),t.line.gutterClass){var o=Ct(t);t.gutterBackground=n("div",null,"CodeMirror-gutter-background "+t.line.gutterClass,"left: "+(e.options.fixedGutter?i.fixedPos:-i.gutterTotalWidth)+"px; width: "+i.gutterTotalWidth+"px"),e.display.input.setUneditable(t.gutterBackground),o.insertBefore(t.gutterBackground,t.text)}var l=t.line.gutterMarkers;if(e.options.lineNumbers||l){var s=Ct(t),a=t.gutter=n("div",null,"CodeMirror-gutter-wrapper","left: "+(e.options.fixedGutter?i.fixedPos:-i.gutterTotalWidth)+"px");if(e.display.input.setUneditable(a),s.insertBefore(a,t.text),t.line.gutterClass&&(a.className+=" "+t.line.gutterClass),!e.options.lineNumbers||l&&l["CodeMirror-linenumbers"]||(t.lineNumber=a.appendChild(n("div",F(e.options,r),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+i.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+e.display.lineNumInnerWidth+"px"))),l)for(var u=0;u<e.options.gutters.length;++u){var c=e.options.gutters[u],f=l.hasOwnProperty(c)&&l[c];f&&a.appendChild(n("div",[f],"CodeMirror-gutter-elt","left: "+i.gutterLeft[c]+"px; width: "+i.gutterWidth[c]+"px"))}}}function Nt(e,t,r){t.alignable&&(t.alignable=null);for(var n=t.node.firstChild,i=void 0;n;n=i)i=n.nextSibling,"CodeMirror-linewidget"==n.className&&t.node.removeChild(n);At(e,t,r)}function Ot(e,t,r,n){var i=Lt(e,t);return t.text=t.node=i.pre,i.bgClass&&(t.bgClass=i.bgClass),i.textClass&&(t.textClass=i.textClass),Tt(e,t),Mt(e,t,r,n),At(e,t,n),t.node}function At(e,t,r){if(Wt(e,t.line,t,r,!0),t.rest)for(var n=0;n<t.rest.length;n++)Wt(e,t.rest[n],t,r,!1)}function Wt(e,t,r,i,o){if(t.widgets)for(var l=Ct(r),s=0,a=t.widgets;s<a.length;++s){var u=a[s],c=n("div",[u.node],"CodeMirror-linewidget");u.handleMouseEvents||c.setAttribute("cm-ignore-events","true"),Dt(u,c,r,i),e.display.input.setUneditable(c),o&&u.above?l.insertBefore(c,r.gutter||r.text):l.appendChild(c),bt(u,"redraw")}}function Dt(e,t,r,n){if(e.noHScroll){(r.alignable||(r.alignable=[])).push(t);var i=n.wrapperWidth;t.style.left=n.fixedPos+"px",e.coverGutter||(i-=n.gutterTotalWidth,t.style.paddingLeft=n.gutterTotalWidth+"px"),t.style.width=i+"px"}e.coverGutter&&(t.style.zIndex=5,t.style.position="relative",e.noHScroll||(t.style.marginLeft=-n.gutterTotalWidth+"px"))}function Ht(e){if(null!=e.height)return e.height;var t=e.doc.cm;if(!t)return 0;if(!o(document.body,e.node)){var i="position: relative;";e.coverGutter&&(i+="margin-left: -"+t.display.gutters.offsetWidth+"px;"),e.noHScroll&&(i+="width: "+t.display.wrapper.clientWidth+"px;"),r(t.display.measure,n("div",[e.node],null,i))}return e.height=e.node.parentNode.offsetHeight}function Ft(e,t){for(var r=Ee(t);r!=e.wrapper;r=r.parentNode)if(!r||1==r.nodeType&&"true"==r.getAttribute("cm-ignore-events")||r.parentNode==e.sizer&&r!=e.mover)return!0}function Et(e){return e.lineSpace.offsetTop}function Pt(e){return e.mover.offsetHeight-e.lineSpace.offsetHeight}function It(e){if(e.cachedPaddingH)return e.cachedPaddingH;var t=r(e.measure,n("pre","x")),i=window.getComputedStyle?window.getComputedStyle(t):t.currentStyle,o={left:parseInt(i.paddingLeft),right:parseInt(i.paddingRight)};return isNaN(o.left)||isNaN(o.right)||(e.cachedPaddingH=o),o}function zt(e){return Rl-e.display.nativeBarWidth}function Rt(e){return e.display.scroller.clientWidth-zt(e)-e.display.barWidth}function Bt(e){return e.display.scroller.clientHeight-zt(e)-e.display.barHeight}function Gt(e,t,r){var n=e.options.lineWrapping,i=n&&Rt(e);if(!t.measure.heights||n&&t.measure.width!=i){var o=t.measure.heights=[];if(n){t.measure.width=i;for(var l=t.text.firstChild.getClientRects(),s=0;s<l.length-1;s++){var a=l[s],u=l[s+1];Math.abs(a.bottom-u.bottom)>2&&o.push((a.bottom+u.top)/2-r.top)}}o.push(r.bottom-r.top)}}function Ut(e,t,r){if(e.line==t)return{map:e.measure.map,cache:e.measure.cache};for(var n=0;n<e.rest.length;n++)if(e.rest[n]==t)return{map:e.measure.maps[n],cache:e.measure.caches[n]};for(var i=0;i<e.rest.length;i++)if(W(e.rest[i])>r)return{map:e.measure.maps[i],cache:e.measure.caches[i],before:!0}}function Vt(e,t){var n=W(t=fe(t)),i=e.display.externalMeasured=new pt(e.doc,t,n);i.lineN=n;var o=i.built=st(e,i);return i.text=o.pre,r(e.display.lineMeasure,o.pre),i}function Kt(e,t,r,n){return Yt(e,Xt(e,t),r,n)}function jt(e,t){if(t>=e.display.viewFrom&&t<e.display.viewTo)return e.display.view[Lr(e,t)];var r=e.display.externalMeasured;return r&&t>=r.lineN&&t<r.lineN+r.size?r:void 0}function Xt(e,t){var r=W(t),n=jt(e,r);n&&!n.text?n=null:n&&n.changes&&(xt(e,n,r,br(e)),e.curOp.forceUpdate=!0),n||(n=Vt(e,t));var i=Ut(n,t,r);return{line:t,view:n,rect:null,map:i.map,cache:i.cache,before:i.before,hasHeights:!1}}function Yt(e,t,r,n,i){t.before&&(r=-1);var o,l=r+(n||"");return t.cache.hasOwnProperty(l)?o=t.cache[l]:(t.rect||(t.rect=t.view.text.getBoundingClientRect()),t.hasHeights||(Gt(e,t.view,t.rect),t.hasHeights=!0),(o=qt(e,t,r,n)).bogus||(t.cache[l]=o)),{left:o.left,right:o.right,top:i?o.rtop:o.top,bottom:i?o.rbottom:o.bottom}}function _t(e,t,r){for(var n,i,o,l,s,a,u=0;u<e.length;u+=3)if(s=e[u],a=e[u+1],t<s?(i=0,o=1,l="left"):t<a?o=(i=t-s)+1:(u==e.length-3||t==a&&e[u+3]>t)&&(i=(o=a-s)-1,t>=a&&(l="right")),null!=i){if(n=e[u+2],s==a&&r==(n.insertLeft?"left":"right")&&(l=r),"left"==r&&0==i)for(;u&&e[u-2]==e[u-3]&&e[u-1].insertLeft;)n=e[2+(u-=3)],l="left";if("right"==r&&i==a-s)for(;u<e.length-3&&e[u+3]==e[u+4]&&!e[u+5].insertLeft;)n=e[(u+=3)+2],l="right";break}return{node:n,start:i,end:o,collapse:l,coverStart:s,coverEnd:a}}function $t(e,t){var r=ms;if("left"==t)for(var n=0;n<e.length&&(r=e[n]).left==r.right;n++);else for(var i=e.length-1;i>=0&&(r=e[i]).left==r.right;i--);return r}function qt(e,t,r,n){var i,o=_t(t.map,r,n),l=o.node,s=o.start,a=o.end,u=o.collapse;if(3==l.nodeType){for(var c=0;c<4;c++){for(;s&&S(t.line.text.charAt(o.coverStart+s));)--s;for(;o.coverStart+a<o.coverEnd&&S(t.line.text.charAt(o.coverStart+a));)++a;if((i=gl&&vl<9&&0==s&&a==o.coverEnd-o.coverStart?l.parentNode.getBoundingClientRect():$t(Wl(l,s,a).getClientRects(),n)).left||i.right||0==s)break;a=s,s-=1,u="right"}gl&&vl<11&&(i=Zt(e.display.measure,i))}else{s>0&&(u=n="right");var f;i=e.options.lineWrapping&&(f=l.getClientRects()).length>1?f["right"==n?f.length-1:0]:l.getBoundingClientRect()}if(gl&&vl<9&&!s&&(!i||!i.left&&!i.right)){var h=l.parentNode.getClientRects()[0];i=h?{left:h.left,right:h.left+yr(e.display),top:h.top,bottom:h.bottom}:ms}for(var d=i.top-t.rect.top,p=i.bottom-t.rect.top,g=(d+p)/2,v=t.view.measure.heights,m=0;m<v.length-1&&!(g<v[m]);m++);var y=m?v[m-1]:0,b=v[m],w={left:("right"==u?i.right:i.left)-t.rect.left,right:("left"==u?i.left:i.right)-t.rect.left,top:y,bottom:b};return i.left||i.right||(w.bogus=!0),e.options.singleCursorHeightPerLine||(w.rtop=d,w.rbottom=p),w}function Zt(e,t){if(!window.screen||null==screen.logicalXDPI||screen.logicalXDPI==screen.deviceXDPI||!Re(e))return t;var r=screen.logicalXDPI/screen.deviceXDPI,n=screen.logicalYDPI/screen.deviceYDPI;return{left:t.left*r,right:t.right*r,top:t.top*n,bottom:t.bottom*n}}function Qt(e){if(e.measure&&(e.measure.cache={},e.measure.heights=null,e.rest))for(var t=0;t<e.rest.length;t++)e.measure.caches[t]={}}function Jt(e){e.display.externalMeasure=null,t(e.display.lineMeasure);for(var r=0;r<e.display.view.length;r++)Qt(e.display.view[r])}function er(e){Jt(e),e.display.cachedCharWidth=e.display.cachedTextHeight=e.display.cachedPaddingH=null,e.options.lineWrapping||(e.display.maxLineChanged=!0),e.display.lineNumChars=null}function tr(){return bl&&kl?-(document.body.getBoundingClientRect().left-parseInt(getComputedStyle(document.body).marginLeft)):window.pageXOffset||(document.documentElement||document.body).scrollLeft}function rr(){return bl&&kl?-(document.body.getBoundingClientRect().top-parseInt(getComputedStyle(document.body).marginTop)):window.pageYOffset||(document.documentElement||document.body).scrollTop}function nr(e){var t=0;if(e.widgets)for(var r=0;r<e.widgets.length;++r)e.widgets[r].above&&(t+=Ht(e.widgets[r]));return t}function ir(e,t,r,n,i){if(!i){var o=nr(t);r.top+=o,r.bottom+=o}if("line"==n)return r;n||(n="local");var l=ye(t);if("local"==n?l+=Et(e.display):l-=e.display.viewOffset,"page"==n||"window"==n){var s=e.display.lineSpace.getBoundingClientRect();l+=s.top+("window"==n?0:rr());var a=s.left+("window"==n?0:tr());r.left+=a,r.right+=a}return r.top+=l,r.bottom+=l,r}function or(e,t,r){if("div"==r)return t;var n=t.left,i=t.top;if("page"==r)n-=tr(),i-=rr();else if("local"==r||!r){var o=e.display.sizer.getBoundingClientRect();n+=o.left,i+=o.top}var l=e.display.lineSpace.getBoundingClientRect();return{left:n-l.left,top:i-l.top}}function lr(e,t,r,n,i){return n||(n=M(e.doc,t.line)),ir(e,n,Kt(e,n,t.ch,i),r)}function sr(e,t,r,n,i,o){function l(t,l){var s=Yt(e,i,t,l?"right":"left",o);return l?s.left=s.right:s.right=s.left,ir(e,n,s,r)}function s(e,t,r){var n=1==a[t].level;return l(r?e-1:e,n!=r)}n=n||M(e.doc,t.line),i||(i=Xt(e,n));var a=Se(n,e.doc.direction),u=t.ch,c=t.sticky;if(u>=n.text.length?(u=n.text.length,c="before"):u<=0&&(u=0,c="after"),!a)return l("before"==c?u-1:u,"before"==c);var f=Ce(a,u,c),h=$l,d=s(u,f,"before"==c);return null!=h&&(d.other=s(u,h,"before"!=c)),d}function ar(e,t){var r=0;t=U(e.doc,t),e.options.lineWrapping||(r=yr(e.display)*t.ch);var n=M(e.doc,t.line),i=ye(n)+Et(e.display);return{left:r,right:r,top:i,bottom:i+n.height}}function ur(e,t,r,n,i){var o=E(e,t,r);return o.xRel=i,n&&(o.outside=!0),o}function cr(e,t,r){var n=e.doc;if((r+=e.display.viewOffset)<0)return ur(n.first,0,null,!0,-1);var i=D(n,r),o=n.first+n.size-1;if(i>o)return ur(n.first+n.size-1,M(n,o).text.length,null,!0,1);t<0&&(t=0);for(var l=M(n,i);;){var s=pr(e,l,i,t,r),a=ue(l),u=a&&a.find(0,!0);if(!a||!(s.ch>u.from.ch||s.ch==u.from.ch&&s.xRel>0))return s;i=W(l=u.to.line)}}function fr(e,t,r,n){n-=nr(t);var i=t.text.length,o=k(function(t){return Yt(e,r,t-1).bottom<=n},i,0);return i=k(function(t){return Yt(e,r,t).top>n},o,i),{begin:o,end:i}}function hr(e,t,r,n){return r||(r=Xt(e,t)),fr(e,t,r,ir(e,t,Yt(e,r,n),"line").top)}function dr(e,t,r,n){return!(e.bottom<=r)&&(e.top>r||(n?e.left:e.right)>t)}function pr(e,t,r,n,i){i-=ye(t);var o=Xt(e,t),l=nr(t),s=0,a=t.text.length,u=!0,c=Se(t,e.doc.direction);if(c){var f=(e.options.lineWrapping?vr:gr)(e,t,r,o,c,n,i);s=(u=1!=f.level)?f.from:f.to-1,a=u?f.to:f.from-1}var h,d,p=null,g=null,v=k(function(t){var r=Yt(e,o,t);return r.top+=l,r.bottom+=l,!!dr(r,n,i,!1)&&(r.top<=i&&r.left<=n&&(p=t,g=r),!0)},s,a),m=!1;if(g){var y=n-g.left<g.right-n,b=y==u;v=p+(b?0:1),d=b?"after":"before",h=y?g.left:g.right}else{u||v!=a&&v!=s||v++,d=0==v?"after":v==t.text.length?"before":Yt(e,o,v-(u?1:0)).bottom+l<=i==u?"after":"before";var w=sr(e,E(r,v,d),"line",t,o);h=w.left,m=i<w.top||i>=w.bottom}return v=L(t.text,v,1),ur(r,v,d,m,n-h)}function gr(e,t,r,n,i,o,l){var s=k(function(s){var a=i[s],u=1!=a.level;return dr(sr(e,E(r,u?a.to:a.from,u?"before":"after"),"line",t,n),o,l,!0)},0,i.length-1),a=i[s];if(s>0){var u=1!=a.level,c=sr(e,E(r,u?a.from:a.to,u?"after":"before"),"line",t,n);dr(c,o,l,!0)&&c.top>l&&(a=i[s-1])}return a}function vr(e,t,r,n,i,o,l){for(var s=fr(e,t,n,l),a=s.begin,u=s.end,c=null,f=null,h=0;h<i.length;h++){var d=i[h];if(!(d.from>=u||d.to<=a)){var p=Yt(e,n,1!=d.level?Math.min(u,d.to)-1:Math.max(a,d.from)).right,g=p<o?o-p+1e9:p-o;(!c||f>g)&&(c=d,f=g)}}return c||(c=i[i.length-1]),c.from<a&&(c={from:a,to:c.to,level:c.level}),c.to>u&&(c={from:c.from,to:u,level:c.level}),c}function mr(e){if(null!=e.cachedTextHeight)return e.cachedTextHeight;if(null==hs){hs=n("pre");for(var i=0;i<49;++i)hs.appendChild(document.createTextNode("x")),hs.appendChild(n("br"));hs.appendChild(document.createTextNode("x"))}r(e.measure,hs);var o=hs.offsetHeight/50;return o>3&&(e.cachedTextHeight=o),t(e.measure),o||1}function yr(e){if(null!=e.cachedCharWidth)return e.cachedCharWidth;var t=n("span","xxxxxxxxxx"),i=n("pre",[t]);r(e.measure,i);var o=t.getBoundingClientRect(),l=(o.right-o.left)/10;return l>2&&(e.cachedCharWidth=l),l||10}function br(e){for(var t=e.display,r={},n={},i=t.gutters.clientLeft,o=t.gutters.firstChild,l=0;o;o=o.nextSibling,++l)r[e.options.gutters[l]]=o.offsetLeft+o.clientLeft+i,n[e.options.gutters[l]]=o.clientWidth;return{fixedPos:wr(t),gutterTotalWidth:t.gutters.offsetWidth,gutterLeft:r,gutterWidth:n,wrapperWidth:t.wrapper.clientWidth}}function wr(e){return e.scroller.getBoundingClientRect().left-e.sizer.getBoundingClientRect().left}function xr(e){var t=mr(e.display),r=e.options.lineWrapping,n=r&&Math.max(5,e.display.scroller.clientWidth/yr(e.display)-3);return function(i){if(ve(e.doc,i))return 0;var o=0;if(i.widgets)for(var l=0;l<i.widgets.length;l++)i.widgets[l].height&&(o+=i.widgets[l].height);return r?o+(Math.ceil(i.text.length/n)||1)*t:o+t}}function Cr(e){var t=e.doc,r=xr(e);t.iter(function(e){var t=r(e);t!=e.height&&A(e,t)})}function Sr(e,t,r,n){var i=e.display;if(!r&&"true"==Ee(t).getAttribute("cm-not-content"))return null;var o,l,s=i.lineSpace.getBoundingClientRect();try{o=t.clientX-s.left,l=t.clientY-s.top}catch(t){return null}var a,u=cr(e,o,l);if(n&&1==u.xRel&&(a=M(e.doc,u.line).text).length==u.ch){var c=f(a,a.length,e.options.tabSize)-a.length;u=E(u.line,Math.max(0,Math.round((o-It(e.display).left)/yr(e.display))-c))}return u}function Lr(e,t){if(t>=e.display.viewTo)return null;if((t-=e.display.viewFrom)<0)return null;for(var r=e.display.view,n=0;n<r.length;n++)if((t-=r[n].size)<0)return n}function kr(e){e.display.input.showSelection(e.display.input.prepareSelection())}function Tr(e,t){void 0===t&&(t=!0);for(var r=e.doc,n={},i=n.cursors=document.createDocumentFragment(),o=n.selection=document.createDocumentFragment(),l=0;l<r.sel.ranges.length;l++)if(t||l!=r.sel.primIndex){var s=r.sel.ranges[l];if(!(s.from().line>=e.display.viewTo||s.to().line<e.display.viewFrom)){var a=s.empty();(a||e.options.showCursorWhenSelecting)&&Mr(e,s.head,i),a||Or(e,s,o)}}return n}function Mr(e,t,r){var i=sr(e,t,"div",null,null,!e.options.singleCursorHeightPerLine),o=r.appendChild(n("div"," ","CodeMirror-cursor"));if(o.style.left=i.left+"px",o.style.top=i.top+"px",o.style.height=Math.max(0,i.bottom-i.top)*e.options.cursorHeight+"px",i.other){var l=r.appendChild(n("div"," ","CodeMirror-cursor CodeMirror-secondarycursor"));l.style.display="",l.style.left=i.other.left+"px",l.style.top=i.other.top+"px",l.style.height=.85*(i.other.bottom-i.other.top)+"px"}}function Nr(e,t){return e.top-t.top||e.left-t.left}function Or(e,t,r){function i(e,t,r,i){t<0&&(t=0),t=Math.round(t),i=Math.round(i),a.appendChild(n("div",null,"CodeMirror-selected","position: absolute; left: "+e+"px;\n                             top: "+t+"px; width: "+(null==r?f-e:r)+"px;\n                             height: "+(i-t)+"px"))}function o(t,r,n){function o(r,n){return lr(e,E(t,r),"div",u,n)}var l,a,u=M(s,t),h=u.text.length,d=Se(u,s.direction);return xe(d,r||0,null==n?h:n,function(t,s,p,g){var v=o(t,"ltr"==p?"left":"right"),m=o(s-1,"ltr"==p?"right":"left");if("ltr"==p){var y=null==r&&0==t?c:v.left,b=null==n&&s==h?f:m.right;m.top-v.top<=3?i(y,m.top,b-y,m.bottom):(i(y,v.top,null,v.bottom),v.bottom<m.top&&i(c,v.bottom,null,m.top),i(c,m.top,m.right,m.bottom))}else if(t<s){var w=null==r&&0==t?f:v.right,x=null==n&&s==h?c:m.left;if(m.top-v.top<=3)i(x,m.top,w-x,m.bottom);else{var C=c;if(g){var S=hr(e,u,null,t).end;C=o(S-(/\s/.test(u.text.charAt(S-1))?2:1),"left").left}i(C,v.top,w-C,v.bottom),v.bottom<m.top&&i(c,v.bottom,null,m.top);var L=null;d.length,L=o(hr(e,u,null,s).begin,"right").right-x,i(x,m.top,L,m.bottom)}}(!l||Nr(v,l)<0)&&(l=v),Nr(m,l)<0&&(l=m),(!a||Nr(v,a)<0)&&(a=v),Nr(m,a)<0&&(a=m)}),{start:l,end:a}}var l=e.display,s=e.doc,a=document.createDocumentFragment(),u=It(e.display),c=u.left,f=Math.max(l.sizerWidth,Rt(e)-l.sizer.offsetLeft)-u.right,h=t.from(),d=t.to();if(h.line==d.line)o(h.line,h.ch,d.ch);else{var p=M(s,h.line),g=M(s,d.line),v=fe(p)==fe(g),m=o(h.line,h.ch,v?p.text.length+1:null).end,y=o(d.line,v?0:null,d.ch).start;v&&(m.top<y.top-2?(i(m.right,m.top,null,m.bottom),i(c,y.top,y.left,y.bottom)):i(m.right,m.top,y.left-m.right,m.bottom)),m.bottom<y.top&&i(c,m.bottom,null,y.top)}r.appendChild(a)}function Ar(e){if(e.state.focused){var t=e.display;clearInterval(t.blinker);var r=!0;t.cursorDiv.style.visibility="",e.options.cursorBlinkRate>0?t.blinker=setInterval(function(){return t.cursorDiv.style.visibility=(r=!r)?"":"hidden"},e.options.cursorBlinkRate):e.options.cursorBlinkRate<0&&(t.cursorDiv.style.visibility="hidden")}}function Wr(e){e.state.focused||(e.display.input.focus(),Hr(e))}function Dr(e){e.state.delayingBlurEvent=!0,setTimeout(function(){e.state.delayingBlurEvent&&(e.state.delayingBlurEvent=!1,Fr(e))},100)}function Hr(e,t){e.state.delayingBlurEvent&&(e.state.delayingBlurEvent=!1),"nocursor"!=e.options.readOnly&&(e.state.focused||(Te(e,"focus",e,t),e.state.focused=!0,s(e.display.wrapper,"CodeMirror-focused"),e.curOp||e.display.selForContextMenu==e.doc.sel||(e.display.input.reset(),ml&&setTimeout(function(){return e.display.input.reset(!0)},20)),e.display.input.receivedFocus()),Ar(e))}function Fr(e,t){e.state.delayingBlurEvent||(e.state.focused&&(Te(e,"blur",e,t),e.state.focused=!1,Fl(e.display.wrapper,"CodeMirror-focused")),clearInterval(e.display.blinker),setTimeout(function(){e.state.focused||(e.display.shift=!1)},150))}function Er(e){for(var t=e.display,r=t.lineDiv.offsetTop,n=0;n<t.view.length;n++){var i=t.view[n],o=void 0;if(!i.hidden){if(gl&&vl<8){var l=i.node.offsetTop+i.node.offsetHeight;o=l-r,r=l}else{var s=i.node.getBoundingClientRect();o=s.bottom-s.top}var a=i.line.height-o;if(o<2&&(o=mr(t)),(a>.005||a<-.005)&&(A(i.line,o),Pr(i.line),i.rest))for(var u=0;u<i.rest.length;u++)Pr(i.rest[u])}}}function Pr(e){if(e.widgets)for(var t=0;t<e.widgets.length;++t)e.widgets[t].height=e.widgets[t].node.parentNode.offsetHeight}function Ir(e,t,r){var n=r&&null!=r.top?Math.max(0,r.top):e.scroller.scrollTop;n=Math.floor(n-Et(e));var i=r&&null!=r.bottom?r.bottom:n+e.wrapper.clientHeight,o=D(t,n),l=D(t,i);if(r&&r.ensure){var s=r.ensure.from.line,a=r.ensure.to.line;s<o?(o=s,l=D(t,ye(M(t,s))+e.wrapper.clientHeight)):Math.min(a,t.lastLine())>=l&&(o=D(t,ye(M(t,a))-e.wrapper.clientHeight),l=a)}return{from:o,to:Math.max(l,o+1)}}function zr(e){var t=e.display,r=t.view;if(t.alignWidgets||t.gutters.firstChild&&e.options.fixedGutter){for(var n=wr(t)-t.scroller.scrollLeft+e.doc.scrollLeft,i=t.gutters.offsetWidth,o=n+"px",l=0;l<r.length;l++)if(!r[l].hidden){e.options.fixedGutter&&(r[l].gutter&&(r[l].gutter.style.left=o),r[l].gutterBackground&&(r[l].gutterBackground.style.left=o));var s=r[l].alignable;if(s)for(var a=0;a<s.length;a++)s[a].style.left=o}e.options.fixedGutter&&(t.gutters.style.left=n+i+"px")}}function Rr(e){if(!e.options.lineNumbers)return!1;var t=e.doc,r=F(e.options,t.first+t.size-1),i=e.display;if(r.length!=i.lineNumChars){var o=i.measure.appendChild(n("div",[n("div",r)],"CodeMirror-linenumber CodeMirror-gutter-elt")),l=o.firstChild.offsetWidth,s=o.offsetWidth-l;return i.lineGutter.style.width="",i.lineNumInnerWidth=Math.max(l,i.lineGutter.offsetWidth-s)+1,i.lineNumWidth=i.lineNumInnerWidth+s,i.lineNumChars=i.lineNumInnerWidth?r.length:-1,i.lineGutter.style.width=i.lineNumWidth+"px",Wn(e),!0}return!1}function Br(e,t){if(!Me(e,"scrollCursorIntoView")){var r=e.display,i=r.sizer.getBoundingClientRect(),o=null;if(t.top+i.top<0?o=!0:t.bottom+i.top>(window.innerHeight||document.documentElement.clientHeight)&&(o=!1),null!=o&&!Sl){var l=n("div","​",null,"position: absolute;\n                         top: "+(t.top-r.viewOffset-Et(e.display))+"px;\n                         height: "+(t.bottom-t.top+zt(e)+r.barHeight)+"px;\n                         left: "+t.left+"px; width: "+Math.max(2,t.right-t.left)+"px;");e.display.lineSpace.appendChild(l),l.scrollIntoView(o),e.display.lineSpace.removeChild(l)}}}function Gr(e,t,r,n){null==n&&(n=0);var i;e.options.lineWrapping||t!=r||(r="before"==(t=t.ch?E(t.line,"before"==t.sticky?t.ch-1:t.ch,"after"):t).sticky?E(t.line,t.ch+1,"before"):t);for(var o=0;o<5;o++){var l=!1,s=sr(e,t),a=r&&r!=t?sr(e,r):s,u=Vr(e,i={left:Math.min(s.left,a.left),top:Math.min(s.top,a.top)-n,right:Math.max(s.left,a.left),bottom:Math.max(s.bottom,a.bottom)+n}),c=e.doc.scrollTop,f=e.doc.scrollLeft;if(null!=u.scrollTop&&(qr(e,u.scrollTop),Math.abs(e.doc.scrollTop-c)>1&&(l=!0)),null!=u.scrollLeft&&(Qr(e,u.scrollLeft),Math.abs(e.doc.scrollLeft-f)>1&&(l=!0)),!l)break}return i}function Ur(e,t){var r=Vr(e,t);null!=r.scrollTop&&qr(e,r.scrollTop),null!=r.scrollLeft&&Qr(e,r.scrollLeft)}function Vr(e,t){var r=e.display,n=mr(e.display);t.top<0&&(t.top=0);var i=e.curOp&&null!=e.curOp.scrollTop?e.curOp.scrollTop:r.scroller.scrollTop,o=Bt(e),l={};t.bottom-t.top>o&&(t.bottom=t.top+o);var s=e.doc.height+Pt(r),a=t.top<n,u=t.bottom>s-n;if(t.top<i)l.scrollTop=a?0:t.top;else if(t.bottom>i+o){var c=Math.min(t.top,(u?s:t.bottom)-o);c!=i&&(l.scrollTop=c)}var f=e.curOp&&null!=e.curOp.scrollLeft?e.curOp.scrollLeft:r.scroller.scrollLeft,h=Rt(e)-(e.options.fixedGutter?r.gutters.offsetWidth:0),d=t.right-t.left>h;return d&&(t.right=t.left+h),t.left<10?l.scrollLeft=0:t.left<f?l.scrollLeft=Math.max(0,t.left-(d?0:10)):t.right>h+f-3&&(l.scrollLeft=t.right+(d?0:10)-h),l}function Kr(e,t){null!=t&&(_r(e),e.curOp.scrollTop=(null==e.curOp.scrollTop?e.doc.scrollTop:e.curOp.scrollTop)+t)}function jr(e){_r(e);var t=e.getCursor();e.curOp.scrollToPos={from:t,to:t,margin:e.options.cursorScrollMargin}}function Xr(e,t,r){null==t&&null==r||_r(e),null!=t&&(e.curOp.scrollLeft=t),null!=r&&(e.curOp.scrollTop=r)}function Yr(e,t){_r(e),e.curOp.scrollToPos=t}function _r(e){var t=e.curOp.scrollToPos;t&&(e.curOp.scrollToPos=null,$r(e,ar(e,t.from),ar(e,t.to),t.margin))}function $r(e,t,r,n){var i=Vr(e,{left:Math.min(t.left,r.left),top:Math.min(t.top,r.top)-n,right:Math.max(t.right,r.right),bottom:Math.max(t.bottom,r.bottom)+n});Xr(e,i.scrollLeft,i.scrollTop)}function qr(e,t){Math.abs(e.doc.scrollTop-t)<2||(fl||On(e,{top:t}),Zr(e,t,!0),fl&&On(e),Cn(e,100))}function Zr(e,t,r){t=Math.min(e.display.scroller.scrollHeight-e.display.scroller.clientHeight,t),(e.display.scroller.scrollTop!=t||r)&&(e.doc.scrollTop=t,e.display.scrollbars.setScrollTop(t),e.display.scroller.scrollTop!=t&&(e.display.scroller.scrollTop=t))}function Qr(e,t,r,n){t=Math.min(t,e.display.scroller.scrollWidth-e.display.scroller.clientWidth),(r?t==e.doc.scrollLeft:Math.abs(e.doc.scrollLeft-t)<2)&&!n||(e.doc.scrollLeft=t,zr(e),e.display.scroller.scrollLeft!=t&&(e.display.scroller.scrollLeft=t),e.display.scrollbars.setScrollLeft(t))}function Jr(e){var t=e.display,r=t.gutters.offsetWidth,n=Math.round(e.doc.height+Pt(e.display));return{clientHeight:t.scroller.clientHeight,viewHeight:t.wrapper.clientHeight,scrollWidth:t.scroller.scrollWidth,clientWidth:t.scroller.clientWidth,viewWidth:t.wrapper.clientWidth,barLeft:e.options.fixedGutter?r:0,docHeight:n,scrollHeight:n+zt(e)+t.barHeight,nativeBarWidth:t.nativeBarWidth,gutterWidth:r}}function en(e,t){t||(t=Jr(e));var r=e.display.barWidth,n=e.display.barHeight;tn(e,t);for(var i=0;i<4&&r!=e.display.barWidth||n!=e.display.barHeight;i++)r!=e.display.barWidth&&e.options.lineWrapping&&Er(e),tn(e,Jr(e)),r=e.display.barWidth,n=e.display.barHeight}function tn(e,t){var r=e.display,n=r.scrollbars.update(t);r.sizer.style.paddingRight=(r.barWidth=n.right)+"px",r.sizer.style.paddingBottom=(r.barHeight=n.bottom)+"px",r.heightForcer.style.borderBottom=n.bottom+"px solid transparent",n.right&&n.bottom?(r.scrollbarFiller.style.display="block",r.scrollbarFiller.style.height=n.bottom+"px",r.scrollbarFiller.style.width=n.right+"px"):r.scrollbarFiller.style.display="",n.bottom&&e.options.coverGutterNextToScrollbar&&e.options.fixedGutter?(r.gutterFiller.style.display="block",r.gutterFiller.style.height=n.bottom+"px",r.gutterFiller.style.width=t.gutterWidth+"px"):r.gutterFiller.style.display=""}function rn(e){e.display.scrollbars&&(e.display.scrollbars.clear(),e.display.scrollbars.addClass&&Fl(e.display.wrapper,e.display.scrollbars.addClass)),e.display.scrollbars=new ws[e.options.scrollbarStyle](function(t){e.display.wrapper.insertBefore(t,e.display.scrollbarFiller),Ql(t,"mousedown",function(){e.state.focused&&setTimeout(function(){return e.display.input.focus()},0)}),t.setAttribute("cm-not-content","true")},function(t,r){"horizontal"==r?Qr(e,t):qr(e,t)},e),e.display.scrollbars.addClass&&s(e.display.wrapper,e.display.scrollbars.addClass)}function nn(e){e.curOp={cm:e,viewChanged:!1,startHeight:e.doc.height,forceUpdate:!1,updateInput:null,typing:!1,changeObjs:null,cursorActivityHandlers:null,cursorActivityCalled:0,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,focus:!1,id:++xs},vt(e.curOp)}function on(e){yt(e.curOp,function(e){for(var t=0;t<e.ops.length;t++)e.ops[t].cm.curOp=null;ln(e)})}function ln(e){for(var t=e.ops,r=0;r<t.length;r++)sn(t[r]);for(var n=0;n<t.length;n++)an(t[n]);for(var i=0;i<t.length;i++)un(t[i]);for(var o=0;o<t.length;o++)cn(t[o]);for(var l=0;l<t.length;l++)fn(t[l])}function sn(e){var t=e.cm,r=t.display;Ln(t),e.updateMaxLine&&we(t),e.mustUpdate=e.viewChanged||e.forceUpdate||null!=e.scrollTop||e.scrollToPos&&(e.scrollToPos.from.line<r.viewFrom||e.scrollToPos.to.line>=r.viewTo)||r.maxLineChanged&&t.options.lineWrapping,e.update=e.mustUpdate&&new Cs(t,e.mustUpdate&&{top:e.scrollTop,ensure:e.scrollToPos},e.forceUpdate)}function an(e){e.updatedDisplay=e.mustUpdate&&Mn(e.cm,e.update)}function un(e){var t=e.cm,r=t.display;e.updatedDisplay&&Er(t),e.barMeasure=Jr(t),r.maxLineChanged&&!t.options.lineWrapping&&(e.adjustWidthTo=Kt(t,r.maxLine,r.maxLine.text.length).left+3,t.display.sizerWidth=e.adjustWidthTo,e.barMeasure.scrollWidth=Math.max(r.scroller.clientWidth,r.sizer.offsetLeft+e.adjustWidthTo+zt(t)+t.display.barWidth),e.maxScrollLeft=Math.max(0,r.sizer.offsetLeft+e.adjustWidthTo-Rt(t))),(e.updatedDisplay||e.selectionChanged)&&(e.preparedSelection=r.input.prepareSelection())}function cn(e){var t=e.cm;null!=e.adjustWidthTo&&(t.display.sizer.style.minWidth=e.adjustWidthTo+"px",e.maxScrollLeft<t.doc.scrollLeft&&Qr(t,Math.min(t.display.scroller.scrollLeft,e.maxScrollLeft),!0),t.display.maxLineChanged=!1);var r=e.focus&&e.focus==l();e.preparedSelection&&t.display.input.showSelection(e.preparedSelection,r),(e.updatedDisplay||e.startHeight!=t.doc.height)&&en(t,e.barMeasure),e.updatedDisplay&&Dn(t,e.barMeasure),e.selectionChanged&&Ar(t),t.state.focused&&e.updateInput&&t.display.input.reset(e.typing),r&&Wr(e.cm)}function fn(e){var t=e.cm,r=t.display,n=t.doc;e.updatedDisplay&&Nn(t,e.update),null==r.wheelStartX||null==e.scrollTop&&null==e.scrollLeft&&!e.scrollToPos||(r.wheelStartX=r.wheelStartY=null),null!=e.scrollTop&&Zr(t,e.scrollTop,e.forceScroll),null!=e.scrollLeft&&Qr(t,e.scrollLeft,!0,!0),e.scrollToPos&&Br(t,Gr(t,U(n,e.scrollToPos.from),U(n,e.scrollToPos.to),e.scrollToPos.margin));var i=e.maybeHiddenMarkers,o=e.maybeUnhiddenMarkers;if(i)for(var l=0;l<i.length;++l)i[l].lines.length||Te(i[l],"hide");if(o)for(var s=0;s<o.length;++s)o[s].lines.length&&Te(o[s],"unhide");r.wrapper.offsetHeight&&(n.scrollTop=t.display.scroller.scrollTop),e.changeObjs&&Te(t,"changes",t,e.changeObjs),e.update&&e.update.finish()}function hn(e,t){if(e.curOp)return t();nn(e);try{return t()}finally{on(e)}}function dn(e,t){return function(){if(e.curOp)return t.apply(e,arguments);nn(e);try{return t.apply(e,arguments)}finally{on(e)}}}function pn(e){return function(){if(this.curOp)return e.apply(this,arguments);nn(this);try{return e.apply(this,arguments)}finally{on(this)}}}function gn(e){return function(){var t=this.cm;if(!t||t.curOp)return e.apply(this,arguments);nn(t);try{return e.apply(this,arguments)}finally{on(t)}}}function vn(e,t,r,n){null==t&&(t=e.doc.first),null==r&&(r=e.doc.first+e.doc.size),n||(n=0);var i=e.display;if(n&&r<i.viewTo&&(null==i.updateLineNumbers||i.updateLineNumbers>t)&&(i.updateLineNumbers=t),e.curOp.viewChanged=!0,t>=i.viewTo)_l&&pe(e.doc,t)<i.viewTo&&yn(e);else if(r<=i.viewFrom)_l&&ge(e.doc,r+n)>i.viewFrom?yn(e):(i.viewFrom+=n,i.viewTo+=n);else if(t<=i.viewFrom&&r>=i.viewTo)yn(e);else if(t<=i.viewFrom){var o=bn(e,r,r+n,1);o?(i.view=i.view.slice(o.index),i.viewFrom=o.lineN,i.viewTo+=n):yn(e)}else if(r>=i.viewTo){var l=bn(e,t,t,-1);l?(i.view=i.view.slice(0,l.index),i.viewTo=l.lineN):yn(e)}else{var s=bn(e,t,t,-1),a=bn(e,r,r+n,1);s&&a?(i.view=i.view.slice(0,s.index).concat(gt(e,s.lineN,a.lineN)).concat(i.view.slice(a.index)),i.viewTo+=n):yn(e)}var u=i.externalMeasured;u&&(r<u.lineN?u.lineN+=n:t<u.lineN+u.size&&(i.externalMeasured=null))}function mn(e,t,r){e.curOp.viewChanged=!0;var n=e.display,i=e.display.externalMeasured;if(i&&t>=i.lineN&&t<i.lineN+i.size&&(n.externalMeasured=null),!(t<n.viewFrom||t>=n.viewTo)){var o=n.view[Lr(e,t)];if(null!=o.node){var l=o.changes||(o.changes=[]);-1==h(l,r)&&l.push(r)}}}function yn(e){e.display.viewFrom=e.display.viewTo=e.doc.first,e.display.view=[],e.display.viewOffset=0}function bn(e,t,r,n){var i,o=Lr(e,t),l=e.display.view;if(!_l||r==e.doc.first+e.doc.size)return{index:o,lineN:r};for(var s=e.display.viewFrom,a=0;a<o;a++)s+=l[a].size;if(s!=t){if(n>0){if(o==l.length-1)return null;i=s+l[o].size-t,o++}else i=s-t;t+=i,r+=i}for(;pe(e.doc,r)!=r;){if(o==(n<0?0:l.length-1))return null;r+=n*l[o-(n<0?1:0)].size,o+=n}return{index:o,lineN:r}}function wn(e,t,r){var n=e.display;0==n.view.length||t>=n.viewTo||r<=n.viewFrom?(n.view=gt(e,t,r),n.viewFrom=t):(n.viewFrom>t?n.view=gt(e,t,n.viewFrom).concat(n.view):n.viewFrom<t&&(n.view=n.view.slice(Lr(e,t))),n.viewFrom=t,n.viewTo<r?n.view=n.view.concat(gt(e,n.viewTo,r)):n.viewTo>r&&(n.view=n.view.slice(0,Lr(e,r)))),n.viewTo=r}function xn(e){for(var t=e.display.view,r=0,n=0;n<t.length;n++){var i=t[n];i.hidden||i.node&&!i.changes||++r}return r}function Cn(e,t){e.doc.highlightFrontier<e.display.viewTo&&e.state.highlight.set(t,u(Sn,e))}function Sn(e){var t=e.doc;if(!(t.highlightFrontier>=e.display.viewTo)){var r=+new Date+e.options.workTime,n=$e(e,t.highlightFrontier),i=[];t.iter(n.line,Math.min(t.first+t.size,e.display.viewTo+500),function(o){if(n.line>=e.display.viewFrom){var l=o.styles,s=o.text.length>e.options.maxHighlightLength?Ke(t.mode,n.state):null,a=Ye(e,o,n,!0);s&&(n.state=s),o.styles=a.styles;var u=o.styleClasses,c=a.classes;c?o.styleClasses=c:u&&(o.styleClasses=null);for(var f=!l||l.length!=o.styles.length||u!=c&&(!u||!c||u.bgClass!=c.bgClass||u.textClass!=c.textClass),h=0;!f&&h<l.length;++h)f=l[h]!=o.styles[h];f&&i.push(n.line),o.stateAfter=n.save(),n.nextLine()}else o.text.length<=e.options.maxHighlightLength&&qe(e,o.text,n),o.stateAfter=n.line%5==0?n.save():null,n.nextLine();if(+new Date>r)return Cn(e,e.options.workDelay),!0}),t.highlightFrontier=n.line,t.modeFrontier=Math.max(t.modeFrontier,n.line),i.length&&hn(e,function(){for(var t=0;t<i.length;t++)mn(e,i[t],"text")})}}function Ln(e){var t=e.display;!t.scrollbarsClipped&&t.scroller.offsetWidth&&(t.nativeBarWidth=t.scroller.offsetWidth-t.scroller.clientWidth,t.heightForcer.style.height=zt(e)+"px",t.sizer.style.marginBottom=-t.nativeBarWidth+"px",t.sizer.style.borderRightWidth=zt(e)+"px",t.scrollbarsClipped=!0)}function kn(e){if(e.hasFocus())return null;var t=l();if(!t||!o(e.display.lineDiv,t))return null;var r={activeElt:t};if(window.getSelection){var n=window.getSelection();n.anchorNode&&n.extend&&o(e.display.lineDiv,n.anchorNode)&&(r.anchorNode=n.anchorNode,r.anchorOffset=n.anchorOffset,r.focusNode=n.focusNode,r.focusOffset=n.focusOffset)}return r}function Tn(e){if(e&&e.activeElt&&e.activeElt!=l()&&(e.activeElt.focus(),e.anchorNode&&o(document.body,e.anchorNode)&&o(document.body,e.focusNode))){var t=window.getSelection(),r=document.createRange();r.setEnd(e.anchorNode,e.anchorOffset),r.collapse(!1),t.removeAllRanges(),t.addRange(r),t.extend(e.focusNode,e.focusOffset)}}function Mn(e,r){var n=e.display,i=e.doc;if(r.editorIsHidden)return yn(e),!1;if(!r.force&&r.visible.from>=n.viewFrom&&r.visible.to<=n.viewTo&&(null==n.updateLineNumbers||n.updateLineNumbers>=n.viewTo)&&n.renderedView==n.view&&0==xn(e))return!1;Rr(e)&&(yn(e),r.dims=br(e));var o=i.first+i.size,l=Math.max(r.visible.from-e.options.viewportMargin,i.first),s=Math.min(o,r.visible.to+e.options.viewportMargin);n.viewFrom<l&&l-n.viewFrom<20&&(l=Math.max(i.first,n.viewFrom)),n.viewTo>s&&n.viewTo-s<20&&(s=Math.min(o,n.viewTo)),_l&&(l=pe(e.doc,l),s=ge(e.doc,s));var a=l!=n.viewFrom||s!=n.viewTo||n.lastWrapHeight!=r.wrapperHeight||n.lastWrapWidth!=r.wrapperWidth;wn(e,l,s),n.viewOffset=ye(M(e.doc,n.viewFrom)),e.display.mover.style.top=n.viewOffset+"px";var u=xn(e);if(!a&&0==u&&!r.force&&n.renderedView==n.view&&(null==n.updateLineNumbers||n.updateLineNumbers>=n.viewTo))return!1;var c=kn(e);return u>4&&(n.lineDiv.style.display="none"),An(e,n.updateLineNumbers,r.dims),u>4&&(n.lineDiv.style.display=""),n.renderedView=n.view,Tn(c),t(n.cursorDiv),t(n.selectionDiv),n.gutters.style.height=n.sizer.style.minHeight=0,a&&(n.lastWrapHeight=r.wrapperHeight,n.lastWrapWidth=r.wrapperWidth,Cn(e,400)),n.updateLineNumbers=null,!0}function Nn(e,t){for(var r=t.viewport,n=!0;(n&&e.options.lineWrapping&&t.oldDisplayWidth!=Rt(e)||(r&&null!=r.top&&(r={top:Math.min(e.doc.height+Pt(e.display)-Bt(e),r.top)}),t.visible=Ir(e.display,e.doc,r),!(t.visible.from>=e.display.viewFrom&&t.visible.to<=e.display.viewTo)))&&Mn(e,t);n=!1){Er(e);var i=Jr(e);kr(e),en(e,i),Dn(e,i),t.force=!1}t.signal(e,"update",e),e.display.viewFrom==e.display.reportedViewFrom&&e.display.viewTo==e.display.reportedViewTo||(t.signal(e,"viewportChange",e,e.display.viewFrom,e.display.viewTo),e.display.reportedViewFrom=e.display.viewFrom,e.display.reportedViewTo=e.display.viewTo)}function On(e,t){var r=new Cs(e,t);if(Mn(e,r)){Er(e),Nn(e,r);var n=Jr(e);kr(e),en(e,n),Dn(e,n),r.finish()}}function An(e,r,n){function i(t){var r=t.nextSibling;return ml&&Ml&&e.display.currentWheelTarget==t?t.style.display="none":t.parentNode.removeChild(t),r}for(var o=e.display,l=e.options.lineNumbers,s=o.lineDiv,a=s.firstChild,u=o.view,c=o.viewFrom,f=0;f<u.length;f++){var d=u[f];if(d.hidden);else if(d.node&&d.node.parentNode==s){for(;a!=d.node;)a=i(a);var p=l&&null!=r&&r<=c&&d.lineNumber;d.changes&&(h(d.changes,"gutter")>-1&&(p=!1),xt(e,d,c,n)),p&&(t(d.lineNumber),d.lineNumber.appendChild(document.createTextNode(F(e.options,c)))),a=d.node.nextSibling}else{var g=Ot(e,d,c,n);s.insertBefore(g,a)}c+=d.size}for(;a;)a=i(a)}function Wn(e){var t=e.display.gutters.offsetWidth;e.display.sizer.style.marginLeft=t+"px"}function Dn(e,t){e.display.sizer.style.minHeight=t.docHeight+"px",e.display.heightForcer.style.top=t.docHeight+"px",e.display.gutters.style.height=t.docHeight+e.display.barHeight+zt(e)+"px"}function Hn(e){var r=e.display.gutters,i=e.options.gutters;t(r);for(var o=0;o<i.length;++o){var l=i[o],s=r.appendChild(n("div",null,"CodeMirror-gutter "+l));"CodeMirror-linenumbers"==l&&(e.display.lineGutter=s,s.style.width=(e.display.lineNumWidth||1)+"px")}r.style.display=o?"":"none",Wn(e)}function Fn(e){var t=h(e.gutters,"CodeMirror-linenumbers");-1==t&&e.lineNumbers?e.gutters=e.gutters.concat(["CodeMirror-linenumbers"]):t>-1&&!e.lineNumbers&&(e.gutters=e.gutters.slice(0),e.gutters.splice(t,1))}function En(e){var t=e.wheelDeltaX,r=e.wheelDeltaY;return null==t&&e.detail&&e.axis==e.HORIZONTAL_AXIS&&(t=e.detail),null==r&&e.detail&&e.axis==e.VERTICAL_AXIS?r=e.detail:null==r&&(r=e.wheelDelta),{x:t,y:r}}function Pn(e){var t=En(e);return t.x*=Ls,t.y*=Ls,t}function In(e,t){var r=En(t),n=r.x,i=r.y,o=e.display,l=o.scroller,s=l.scrollWidth>l.clientWidth,a=l.scrollHeight>l.clientHeight;if(n&&s||i&&a){if(i&&Ml&&ml)e:for(var u=t.target,c=o.view;u!=l;u=u.parentNode)for(var f=0;f<c.length;f++)if(c[f].node==u){e.display.currentWheelTarget=u;break e}if(n&&!fl&&!wl&&null!=Ls)return i&&a&&qr(e,Math.max(0,l.scrollTop+i*Ls)),Qr(e,Math.max(0,l.scrollLeft+n*Ls)),(!i||i&&a)&&We(t),void(o.wheelStartX=null);if(i&&null!=Ls){var h=i*Ls,d=e.doc.scrollTop,p=d+o.wrapper.clientHeight;h<0?d=Math.max(0,d+h-50):p=Math.min(e.doc.height,p+h+50),On(e,{top:d,bottom:p})}Ss<20&&(null==o.wheelStartX?(o.wheelStartX=l.scrollLeft,o.wheelStartY=l.scrollTop,o.wheelDX=n,o.wheelDY=i,setTimeout(function(){if(null!=o.wheelStartX){var e=l.scrollLeft-o.wheelStartX,t=l.scrollTop-o.wheelStartY,r=t&&o.wheelDY&&t/o.wheelDY||e&&o.wheelDX&&e/o.wheelDX;o.wheelStartX=o.wheelStartY=null,r&&(Ls=(Ls*Ss+r)/(Ss+1),++Ss)}},200)):(o.wheelDX+=n,o.wheelDY+=i))}}function zn(e,t){var r=e[t];e.sort(function(e,t){return P(e.from(),t.from())}),t=h(e,r);for(var n=1;n<e.length;n++){var i=e[n],o=e[n-1];if(P(o.to(),i.from())>=0){var l=B(o.from(),i.from()),s=R(o.to(),i.to()),a=o.empty()?i.from()==i.head:o.from()==o.head;n<=t&&--t,e.splice(--n,2,new Ts(a?s:l,a?l:s))}}return new ks(e,t)}function Rn(e,t){return new ks([new Ts(e,t||e)],0)}function Bn(e){return e.text?E(e.from.line+e.text.length-1,g(e.text).length+(1==e.text.length?e.from.ch:0)):e.to}function Gn(e,t){if(P(e,t.from)<0)return e;if(P(e,t.to)<=0)return Bn(t);var r=e.line+t.text.length-(t.to.line-t.from.line)-1,n=e.ch;return e.line==t.to.line&&(n+=Bn(t).ch-t.to.ch),E(r,n)}function Un(e,t){for(var r=[],n=0;n<e.sel.ranges.length;n++){var i=e.sel.ranges[n];r.push(new Ts(Gn(i.anchor,t),Gn(i.head,t)))}return zn(r,e.sel.primIndex)}function Vn(e,t,r){return e.line==t.line?E(r.line,e.ch-t.ch+r.ch):E(r.line+(e.line-t.line),e.ch)}function Kn(e,t,r){for(var n=[],i=E(e.first,0),o=i,l=0;l<t.length;l++){var s=t[l],a=Vn(s.from,i,o),u=Vn(Bn(s),i,o);if(i=s.to,o=u,"around"==r){var c=e.sel.ranges[l],f=P(c.head,c.anchor)<0;n[l]=new Ts(f?u:a,f?a:u)}else n[l]=new Ts(a,a)}return new ks(n,e.sel.primIndex)}function jn(e){e.doc.mode=Ue(e.options,e.doc.modeOption),Xn(e)}function Xn(e){e.doc.iter(function(e){e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null)}),e.doc.modeFrontier=e.doc.highlightFrontier=e.doc.first,Cn(e,100),e.state.modeGen++,e.curOp&&vn(e)}function Yn(e,t){return 0==t.from.ch&&0==t.to.ch&&""==g(t.text)&&(!e.cm||e.cm.options.wholeLineUpdateBefore)}function _n(e,t,r,n){function i(e){return r?r[e]:null}function o(e,r,i){it(e,r,i,n),bt(e,"change",e,t)}function l(e,t){for(var r=[],o=e;o<t;++o)r.push(new fs(u[o],i(o),n));return r}var s=t.from,a=t.to,u=t.text,c=M(e,s.line),f=M(e,a.line),h=g(u),d=i(u.length-1),p=a.line-s.line;if(t.full)e.insert(0,l(0,u.length)),e.remove(u.length,e.size-u.length);else if(Yn(e,t)){var v=l(0,u.length-1);o(f,f.text,d),p&&e.remove(s.line,p),v.length&&e.insert(s.line,v)}else if(c==f)if(1==u.length)o(c,c.text.slice(0,s.ch)+h+c.text.slice(a.ch),d);else{var m=l(1,u.length-1);m.push(new fs(h+c.text.slice(a.ch),d,n)),o(c,c.text.slice(0,s.ch)+u[0],i(0)),e.insert(s.line+1,m)}else if(1==u.length)o(c,c.text.slice(0,s.ch)+u[0]+f.text.slice(a.ch),i(0)),e.remove(s.line+1,p);else{o(c,c.text.slice(0,s.ch)+u[0],i(0)),o(f,h+f.text.slice(a.ch),d);var y=l(1,u.length-1);p>1&&e.remove(s.line+1,p-1),e.insert(s.line+1,y)}bt(e,"change",e,t)}function $n(e,t,r){function n(e,i,o){if(e.linked)for(var l=0;l<e.linked.length;++l){var s=e.linked[l];if(s.doc!=i){var a=o&&s.sharedHist;r&&!a||(t(s.doc,a),n(s.doc,e,a))}}}n(e,null,!0)}function qn(e,t){if(t.cm)throw new Error("This document is already in use.");e.doc=t,t.cm=e,Cr(e),jn(e),Zn(e),e.options.lineWrapping||we(e),e.options.mode=t.modeOption,vn(e)}function Zn(e){("rtl"==e.doc.direction?s:Fl)(e.display.lineDiv,"CodeMirror-rtl")}function Qn(e){hn(e,function(){Zn(e),vn(e)})}function Jn(e){this.done=[],this.undone=[],this.undoDepth=1/0,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=e||1}function ei(e,t){var r={from:z(t.from),to:Bn(t),text:N(e,t.from,t.to)};return si(e,r,t.from.line,t.to.line+1),$n(e,function(e){return si(e,r,t.from.line,t.to.line+1)},!0),r}function ti(e){for(;e.length&&g(e).ranges;)e.pop()}function ri(e,t){return t?(ti(e.done),g(e.done)):e.done.length&&!g(e.done).ranges?g(e.done):e.done.length>1&&!e.done[e.done.length-2].ranges?(e.done.pop(),g(e.done)):void 0}function ni(e,t,r,n){var i=e.history;i.undone.length=0;var o,l,s=+new Date;if((i.lastOp==n||i.lastOrigin==t.origin&&t.origin&&("+"==t.origin.charAt(0)&&e.cm&&i.lastModTime>s-e.cm.options.historyEventDelay||"*"==t.origin.charAt(0)))&&(o=ri(i,i.lastOp==n)))l=g(o.changes),0==P(t.from,t.to)&&0==P(t.from,l.to)?l.to=Bn(t):o.changes.push(ei(e,t));else{var a=g(i.done);for(a&&a.ranges||li(e.sel,i.done),o={changes:[ei(e,t)],generation:i.generation},i.done.push(o);i.done.length>i.undoDepth;)i.done.shift(),i.done[0].ranges||i.done.shift()}i.done.push(r),i.generation=++i.maxGeneration,i.lastModTime=i.lastSelTime=s,i.lastOp=i.lastSelOp=n,i.lastOrigin=i.lastSelOrigin=t.origin,l||Te(e,"historyAdded")}function ii(e,t,r,n){var i=t.charAt(0);return"*"==i||"+"==i&&r.ranges.length==n.ranges.length&&r.somethingSelected()==n.somethingSelected()&&new Date-e.history.lastSelTime<=(e.cm?e.cm.options.historyEventDelay:500)}function oi(e,t,r,n){var i=e.history,o=n&&n.origin;r==i.lastSelOp||o&&i.lastSelOrigin==o&&(i.lastModTime==i.lastSelTime&&i.lastOrigin==o||ii(e,o,g(i.done),t))?i.done[i.done.length-1]=t:li(t,i.done),i.lastSelTime=+new Date,i.lastSelOrigin=o,i.lastSelOp=r,n&&!1!==n.clearRedo&&ti(i.undone)}function li(e,t){var r=g(t);r&&r.ranges&&r.equals(e)||t.push(e)}function si(e,t,r,n){var i=t["spans_"+e.id],o=0;e.iter(Math.max(e.first,r),Math.min(e.first+e.size,n),function(r){r.markedSpans&&((i||(i=t["spans_"+e.id]={}))[o]=r.markedSpans),++o})}function ai(e){if(!e)return null;for(var t,r=0;r<e.length;++r)e[r].marker.explicitlyCleared?t||(t=e.slice(0,r)):t&&t.push(e[r]);return t?t.length?t:null:e}function ui(e,t){var r=t["spans_"+e.id];if(!r)return null;for(var n=[],i=0;i<t.text.length;++i)n.push(ai(r[i]));return n}function ci(e,t){var r=ui(e,t),n=J(e,t);if(!r)return n;if(!n)return r;for(var i=0;i<r.length;++i){var o=r[i],l=n[i];if(o&&l)e:for(var s=0;s<l.length;++s){for(var a=l[s],u=0;u<o.length;++u)if(o[u].marker==a.marker)continue e;o.push(a)}else l&&(r[i]=l)}return r}function fi(e,t,r){for(var n=[],i=0;i<e.length;++i){var o=e[i];if(o.ranges)n.push(r?ks.prototype.deepCopy.call(o):o);else{var l=o.changes,s=[];n.push({changes:s});for(var a=0;a<l.length;++a){var u=l[a],c=void 0;if(s.push({from:u.from,to:u.to,text:u.text}),t)for(var f in u)(c=f.match(/^spans_(\d+)$/))&&h(t,Number(c[1]))>-1&&(g(s)[f]=u[f],delete u[f])}}}return n}function hi(e,t,r,n){if(n){var i=e.anchor;if(r){var o=P(t,i)<0;o!=P(r,i)<0?(i=t,t=r):o!=P(t,r)<0&&(t=r)}return new Ts(i,t)}return new Ts(r||t,t)}function di(e,t,r,n,i){null==i&&(i=e.cm&&(e.cm.display.shift||e.extend)),bi(e,new ks([hi(e.sel.primary(),t,r,i)],0),n)}function pi(e,t,r){for(var n=[],i=e.cm&&(e.cm.display.shift||e.extend),o=0;o<e.sel.ranges.length;o++)n[o]=hi(e.sel.ranges[o],t[o],null,i);bi(e,zn(n,e.sel.primIndex),r)}function gi(e,t,r,n){var i=e.sel.ranges.slice(0);i[t]=r,bi(e,zn(i,e.sel.primIndex),n)}function vi(e,t,r,n){bi(e,Rn(t,r),n)}function mi(e,t,r){var n={ranges:t.ranges,update:function(t){var r=this;this.ranges=[];for(var n=0;n<t.length;n++)r.ranges[n]=new Ts(U(e,t[n].anchor),U(e,t[n].head))},origin:r&&r.origin};return Te(e,"beforeSelectionChange",e,n),e.cm&&Te(e.cm,"beforeSelectionChange",e.cm,n),n.ranges!=t.ranges?zn(n.ranges,n.ranges.length-1):t}function yi(e,t,r){var n=e.history.done,i=g(n);i&&i.ranges?(n[n.length-1]=t,wi(e,t,r)):bi(e,t,r)}function bi(e,t,r){wi(e,t,r),oi(e,e.sel,e.cm?e.cm.curOp.id:NaN,r)}function wi(e,t,r){(Oe(e,"beforeSelectionChange")||e.cm&&Oe(e.cm,"beforeSelectionChange"))&&(t=mi(e,t,r)),xi(e,Si(e,t,r&&r.bias||(P(t.primary().head,e.sel.primary().head)<0?-1:1),!0)),r&&!1===r.scroll||!e.cm||jr(e.cm)}function xi(e,t){t.equals(e.sel)||(e.sel=t,e.cm&&(e.cm.curOp.updateInput=e.cm.curOp.selectionChanged=!0,Ne(e.cm)),bt(e,"cursorActivity",e))}function Ci(e){xi(e,Si(e,e.sel,null,!1))}function Si(e,t,r,n){for(var i,o=0;o<t.ranges.length;o++){var l=t.ranges[o],s=t.ranges.length==e.sel.ranges.length&&e.sel.ranges[o],a=ki(e,l.anchor,s&&s.anchor,r,n),u=ki(e,l.head,s&&s.head,r,n);(i||a!=l.anchor||u!=l.head)&&(i||(i=t.ranges.slice(0,o)),i[o]=new Ts(a,u))}return i?zn(i,t.primIndex):t}function Li(e,t,r,n,i){var o=M(e,t.line);if(o.markedSpans)for(var l=0;l<o.markedSpans.length;++l){var s=o.markedSpans[l],a=s.marker;if((null==s.from||(a.inclusiveLeft?s.from<=t.ch:s.from<t.ch))&&(null==s.to||(a.inclusiveRight?s.to>=t.ch:s.to>t.ch))){if(i&&(Te(a,"beforeCursorEnter"),a.explicitlyCleared)){if(o.markedSpans){--l;continue}break}if(!a.atomic)continue;if(r){var u=a.find(n<0?1:-1),c=void 0;if((n<0?a.inclusiveRight:a.inclusiveLeft)&&(u=Ti(e,u,-n,u&&u.line==t.line?o:null)),u&&u.line==t.line&&(c=P(u,r))&&(n<0?c<0:c>0))return Li(e,u,t,n,i)}var f=a.find(n<0?-1:1);return(n<0?a.inclusiveLeft:a.inclusiveRight)&&(f=Ti(e,f,n,f.line==t.line?o:null)),f?Li(e,f,t,n,i):null}}return t}function ki(e,t,r,n,i){var o=n||1,l=Li(e,t,r,o,i)||!i&&Li(e,t,r,o,!0)||Li(e,t,r,-o,i)||!i&&Li(e,t,r,-o,!0);return l||(e.cantEdit=!0,E(e.first,0))}function Ti(e,t,r,n){return r<0&&0==t.ch?t.line>e.first?U(e,E(t.line-1)):null:r>0&&t.ch==(n||M(e,t.line)).text.length?t.line<e.first+e.size-1?E(t.line+1,0):null:new E(t.line,t.ch+r)}function Mi(e){e.setSelection(E(e.firstLine(),0),E(e.lastLine()),Gl)}function Ni(e,t,r){var n={canceled:!1,from:t.from,to:t.to,text:t.text,origin:t.origin,cancel:function(){return n.canceled=!0}};return r&&(n.update=function(t,r,i,o){t&&(n.from=U(e,t)),r&&(n.to=U(e,r)),i&&(n.text=i),void 0!==o&&(n.origin=o)}),Te(e,"beforeChange",e,n),e.cm&&Te(e.cm,"beforeChange",e.cm,n),n.canceled?null:{from:n.from,to:n.to,text:n.text,origin:n.origin}}function Oi(e,t,r){if(e.cm){if(!e.cm.curOp)return dn(e.cm,Oi)(e,t,r);if(e.cm.state.suppressEdits)return}if(!(Oe(e,"beforeChange")||e.cm&&Oe(e.cm,"beforeChange"))||(t=Ni(e,t,!0))){var n=Yl&&!r&&te(e,t.from,t.to);if(n)for(var i=n.length-1;i>=0;--i)Ai(e,{from:n[i].from,to:n[i].to,text:i?[""]:t.text,origin:t.origin});else Ai(e,t)}}function Ai(e,t){if(1!=t.text.length||""!=t.text[0]||0!=P(t.from,t.to)){var r=Un(e,t);ni(e,t,r,e.cm?e.cm.curOp.id:NaN),Hi(e,t,r,J(e,t));var n=[];$n(e,function(e,r){r||-1!=h(n,e.history)||(zi(e.history,t),n.push(e.history)),Hi(e,t,null,J(e,t))})}}function Wi(e,t,r){if(!e.cm||!e.cm.state.suppressEdits||r){for(var n,i=e.history,o=e.sel,l="undo"==t?i.done:i.undone,s="undo"==t?i.undone:i.done,a=0;a<l.length&&(n=l[a],r?!n.ranges||n.equals(e.sel):n.ranges);a++);if(a!=l.length){for(i.lastOrigin=i.lastSelOrigin=null;(n=l.pop()).ranges;){if(li(n,s),r&&!n.equals(e.sel))return void bi(e,n,{clearRedo:!1});o=n}var u=[];li(o,s),s.push({changes:u,generation:i.generation}),i.generation=n.generation||++i.maxGeneration;for(var c=Oe(e,"beforeChange")||e.cm&&Oe(e.cm,"beforeChange"),f=n.changes.length-1;f>=0;--f){var d=function(r){var i=n.changes[r];if(i.origin=t,c&&!Ni(e,i,!1))return l.length=0,{};u.push(ei(e,i));var o=r?Un(e,i):g(l);Hi(e,i,o,ci(e,i)),!r&&e.cm&&e.cm.scrollIntoView({from:i.from,to:Bn(i)});var s=[];$n(e,function(e,t){t||-1!=h(s,e.history)||(zi(e.history,i),s.push(e.history)),Hi(e,i,null,ci(e,i))})}(f);if(d)return d.v}}}}function Di(e,t){if(0!=t&&(e.first+=t,e.sel=new ks(v(e.sel.ranges,function(e){return new Ts(E(e.anchor.line+t,e.anchor.ch),E(e.head.line+t,e.head.ch))}),e.sel.primIndex),e.cm)){vn(e.cm,e.first,e.first-t,t);for(var r=e.cm.display,n=r.viewFrom;n<r.viewTo;n++)mn(e.cm,n,"gutter")}}function Hi(e,t,r,n){if(e.cm&&!e.cm.curOp)return dn(e.cm,Hi)(e,t,r,n);if(t.to.line<e.first)Di(e,t.text.length-1-(t.to.line-t.from.line));else if(!(t.from.line>e.lastLine())){if(t.from.line<e.first){var i=t.text.length-1-(e.first-t.from.line);Di(e,i),t={from:E(e.first,0),to:E(t.to.line+i,t.to.ch),text:[g(t.text)],origin:t.origin}}var o=e.lastLine();t.to.line>o&&(t={from:t.from,to:E(o,M(e,o).text.length),text:[t.text[0]],origin:t.origin}),t.removed=N(e,t.from,t.to),r||(r=Un(e,t)),e.cm?Fi(e.cm,t,n):_n(e,t,n),wi(e,r,Gl)}}function Fi(e,t,r){var n=e.doc,i=e.display,o=t.from,l=t.to,s=!1,a=o.line;e.options.lineWrapping||(a=W(fe(M(n,o.line))),n.iter(a,l.line+1,function(e){if(e==i.maxLine)return s=!0,!0})),n.sel.contains(t.from,t.to)>-1&&Ne(e),_n(n,t,r,xr(e)),e.options.lineWrapping||(n.iter(a,o.line+t.text.length,function(e){var t=be(e);t>i.maxLineLength&&(i.maxLine=e,i.maxLineLength=t,i.maxLineChanged=!0,s=!1)}),s&&(e.curOp.updateMaxLine=!0)),nt(n,o.line),Cn(e,400);var u=t.text.length-(l.line-o.line)-1;t.full?vn(e):o.line!=l.line||1!=t.text.length||Yn(e.doc,t)?vn(e,o.line,l.line+1,u):mn(e,o.line,"text");var c=Oe(e,"changes"),f=Oe(e,"change");if(f||c){var h={from:o,to:l,text:t.text,removed:t.removed,origin:t.origin};f&&bt(e,"change",e,h),c&&(e.curOp.changeObjs||(e.curOp.changeObjs=[])).push(h)}e.display.selForContextMenu=null}function Ei(e,t,r,n,i){if(n||(n=r),P(n,r)<0){var o;r=(o=[n,r])[0],n=o[1]}"string"==typeof t&&(t=e.splitLines(t)),Oi(e,{from:r,to:n,text:t,origin:i})}function Pi(e,t,r,n){r<e.line?e.line+=n:t<e.line&&(e.line=t,e.ch=0)}function Ii(e,t,r,n){for(var i=0;i<e.length;++i){var o=e[i],l=!0;if(o.ranges){o.copied||((o=e[i]=o.deepCopy()).copied=!0);for(var s=0;s<o.ranges.length;s++)Pi(o.ranges[s].anchor,t,r,n),Pi(o.ranges[s].head,t,r,n)}else{for(var a=0;a<o.changes.length;++a){var u=o.changes[a];if(r<u.from.line)u.from=E(u.from.line+n,u.from.ch),u.to=E(u.to.line+n,u.to.ch);else if(t<=u.to.line){l=!1;break}}l||(e.splice(0,i+1),i=0)}}}function zi(e,t){var r=t.from.line,n=t.to.line,i=t.text.length-(n-r)-1;Ii(e.done,r,n,i),Ii(e.undone,r,n,i)}function Ri(e,t,r,n){var i=t,o=t;return"number"==typeof t?o=M(e,G(e,t)):i=W(t),null==i?null:(n(o,i)&&e.cm&&mn(e.cm,i,r),o)}function Bi(e){var t=this;this.lines=e,this.parent=null;for(var r=0,n=0;n<e.length;++n)e[n].parent=t,r+=e[n].height;this.height=r}function Gi(e){var t=this;this.children=e;for(var r=0,n=0,i=0;i<e.length;++i){var o=e[i];r+=o.chunkSize(),n+=o.height,o.parent=t}this.size=r,this.height=n,this.parent=null}function Ui(e,t,r){ye(t)<(e.curOp&&e.curOp.scrollTop||e.doc.scrollTop)&&Kr(e,r)}function Vi(e,t,r,n){var i=new Ms(e,r,n),o=e.cm;return o&&i.noHScroll&&(o.display.alignWidgets=!0),Ri(e,t,"widget",function(t){var r=t.widgets||(t.widgets=[]);if(null==i.insertAt?r.push(i):r.splice(Math.min(r.length-1,Math.max(0,i.insertAt)),0,i),i.line=t,o&&!ve(e,t)){var n=ye(t)<e.scrollTop;A(t,t.height+Ht(i)),n&&Kr(o,i.height),o.curOp.forceUpdate=!0}return!0}),bt(o,"lineWidgetAdded",o,i,"number"==typeof t?t:W(t)),i}function Ki(e,t,r,n,o){if(n&&n.shared)return ji(e,t,r,n,o);if(e.cm&&!e.cm.curOp)return dn(e.cm,Ki)(e,t,r,n,o);var l=new Os(e,o),s=P(t,r);if(n&&c(n,l,!1),s>0||0==s&&!1!==l.clearWhenEmpty)return l;if(l.replacedWith&&(l.collapsed=!0,l.widgetNode=i("span",[l.replacedWith],"CodeMirror-widget"),n.handleMouseEvents||l.widgetNode.setAttribute("cm-ignore-events","true"),n.insertLeft&&(l.widgetNode.insertLeft=!0)),l.collapsed){if(ce(e,t.line,t,r,l)||t.line!=r.line&&ce(e,r.line,t,r,l))throw new Error("Inserting collapsed marker partially overlapping an existing one");X()}l.addToHistory&&ni(e,{from:t,to:r,origin:"markText"},e.sel,NaN);var a,u=t.line,f=e.cm;if(e.iter(u,r.line+1,function(e){f&&l.collapsed&&!f.options.lineWrapping&&fe(e)==f.display.maxLine&&(a=!0),l.collapsed&&u!=t.line&&A(e,0),q(e,new Y(l,u==t.line?t.ch:null,u==r.line?r.ch:null)),++u}),l.collapsed&&e.iter(t.line,r.line+1,function(t){ve(e,t)&&A(t,0)}),l.clearOnEnter&&Ql(l,"beforeCursorEnter",function(){return l.clear()}),l.readOnly&&(j(),(e.history.done.length||e.history.undone.length)&&e.clearHistory()),l.collapsed&&(l.id=++Ns,l.atomic=!0),f){if(a&&(f.curOp.updateMaxLine=!0),l.collapsed)vn(f,t.line,r.line+1);else if(l.className||l.title||l.startStyle||l.endStyle||l.css)for(var h=t.line;h<=r.line;h++)mn(f,h,"text");l.atomic&&Ci(f.doc),bt(f,"markerAdded",f,l)}return l}function ji(e,t,r,n,i){(n=c(n)).shared=!1;var o=[Ki(e,t,r,n,i)],l=o[0],s=n.widgetNode;return $n(e,function(e){s&&(n.widgetNode=s.cloneNode(!0)),o.push(Ki(e,U(e,t),U(e,r),n,i));for(var a=0;a<e.linked.length;++a)if(e.linked[a].isParent)return;l=g(o)}),new As(o,l)}function Xi(e){return e.findMarks(E(e.first,0),e.clipPos(E(e.lastLine())),function(e){return e.parent})}function Yi(e,t){for(var r=0;r<t.length;r++){var n=t[r],i=n.find(),o=e.clipPos(i.from),l=e.clipPos(i.to);if(P(o,l)){var s=Ki(e,o,l,n.primary,n.primary.type);n.markers.push(s),s.parent=n}}}function _i(e){for(var t=0;t<e.length;t++)!function(t){var r=e[t],n=[r.primary.doc];$n(r.primary.doc,function(e){return n.push(e)});for(var i=0;i<r.markers.length;i++){var o=r.markers[i];-1==h(n,o.doc)&&(o.parent=null,r.markers.splice(i--,1))}}(t)}function $i(e){var t=this;if(Qi(t),!Me(t,e)&&!Ft(t.display,e)){We(e),gl&&(Hs=+new Date);var r=Sr(t,e,!0),n=e.dataTransfer.files;if(r&&!t.isReadOnly())if(n&&n.length&&window.FileReader&&window.File)for(var i=n.length,o=Array(i),l=0,s=0;s<i;++s)!function(e,n){if(!t.options.allowDropFileTypes||-1!=h(t.options.allowDropFileTypes,e.type)){var s=new FileReader;s.onload=dn(t,function(){var e=s.result;if(/[\x00-\x08\x0e-\x1f]{2}/.test(e)&&(e=""),o[n]=e,++l==i){var a={from:r=U(t.doc,r),to:r,text:t.doc.splitLines(o.join(t.doc.lineSeparator())),origin:"paste"};Oi(t.doc,a),yi(t.doc,Rn(r,Bn(a)))}}),s.readAsText(e)}}(n[s],s);else{if(t.state.draggingText&&t.doc.sel.contains(r)>-1)return t.state.draggingText(e),void setTimeout(function(){return t.display.input.focus()},20);try{var a=e.dataTransfer.getData("Text");if(a){var u;if(t.state.draggingText&&!t.state.draggingText.copy&&(u=t.listSelections()),wi(t.doc,Rn(r,r)),u)for(var c=0;c<u.length;++c)Ei(t.doc,"",u[c].anchor,u[c].head,"drag");t.replaceSelection(a,"around","paste"),t.display.input.focus()}}catch(e){}}}}function qi(e,t){if(gl&&(!e.state.draggingText||+new Date-Hs<100))Fe(t);else if(!Me(e,t)&&!Ft(e.display,t)&&(t.dataTransfer.setData("Text",e.getSelection()),t.dataTransfer.effectAllowed="copyMove",t.dataTransfer.setDragImage&&!xl)){var r=n("img",null,null,"position: fixed; left: 0; top: 0;");r.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",wl&&(r.width=r.height=1,e.display.wrapper.appendChild(r),r._top=r.offsetTop),t.dataTransfer.setDragImage(r,0,0),wl&&r.parentNode.removeChild(r)}}function Zi(e,t){var i=Sr(e,t);if(i){var o=document.createDocumentFragment();Mr(e,i,o),e.display.dragCursor||(e.display.dragCursor=n("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),e.display.lineSpace.insertBefore(e.display.dragCursor,e.display.cursorDiv)),r(e.display.dragCursor,o)}}function Qi(e){e.display.dragCursor&&(e.display.lineSpace.removeChild(e.display.dragCursor),e.display.dragCursor=null)}function Ji(e){if(document.getElementsByClassName)for(var t=document.getElementsByClassName("CodeMirror"),r=0;r<t.length;r++){var n=t[r].CodeMirror;n&&e(n)}}function eo(){Fs||(to(),Fs=!0)}function to(){var e;Ql(window,"resize",function(){null==e&&(e=setTimeout(function(){e=null,Ji(ro)},100))}),Ql(window,"blur",function(){return Ji(Fr)})}function ro(e){var t=e.display;t.lastWrapHeight==t.wrapper.clientHeight&&t.lastWrapWidth==t.wrapper.clientWidth||(t.cachedCharWidth=t.cachedTextHeight=t.cachedPaddingH=null,t.scrollbarsClipped=!1,e.setSize())}function no(e){var t=e.split(/-(?!$)/);e=t[t.length-1];for(var r,n,i,o,l=0;l<t.length-1;l++){var s=t[l];if(/^(cmd|meta|m)$/i.test(s))o=!0;else if(/^a(lt)?$/i.test(s))r=!0;else if(/^(c|ctrl|control)$/i.test(s))n=!0;else{if(!/^s(hift)?$/i.test(s))throw new Error("Unrecognized modifier name: "+s);i=!0}}return r&&(e="Alt-"+e),n&&(e="Ctrl-"+e),o&&(e="Cmd-"+e),i&&(e="Shift-"+e),e}function io(e){var t={};for(var r in e)if(e.hasOwnProperty(r)){var n=e[r];if(/^(name|fallthrough|(de|at)tach)$/.test(r))continue;if("..."==n){delete e[r];continue}for(var i=v(r.split(" "),no),o=0;o<i.length;o++){var l=void 0,s=void 0;o==i.length-1?(s=i.join(" "),l=n):(s=i.slice(0,o+1).join(" "),l="...");var a=t[s];if(a){if(a!=l)throw new Error("Inconsistent bindings for "+s)}else t[s]=l}delete e[r]}for(var u in t)e[u]=t[u];return e}function oo(e,t,r,n){var i=(t=uo(t)).call?t.call(e,n):t[e];if(!1===i)return"nothing";if("..."===i)return"multi";if(null!=i&&r(i))return"handled";if(t.fallthrough){if("[object Array]"!=Object.prototype.toString.call(t.fallthrough))return oo(e,t.fallthrough,r,n);for(var o=0;o<t.fallthrough.length;o++){var l=oo(e,t.fallthrough[o],r,n);if(l)return l}}}function lo(e){var t="string"==typeof e?e:Es[e.keyCode];return"Ctrl"==t||"Alt"==t||"Shift"==t||"Mod"==t}function so(e,t,r){var n=e;return t.altKey&&"Alt"!=n&&(e="Alt-"+e),(Dl?t.metaKey:t.ctrlKey)&&"Ctrl"!=n&&(e="Ctrl-"+e),(Dl?t.ctrlKey:t.metaKey)&&"Cmd"!=n&&(e="Cmd-"+e),!r&&t.shiftKey&&"Shift"!=n&&(e="Shift-"+e),e}function ao(e,t){if(wl&&34==e.keyCode&&e.char)return!1;var r=Es[e.keyCode];return null!=r&&!e.altGraphKey&&so(r,e,t)}function uo(e){return"string"==typeof e?Rs[e]:e}function co(e,t){for(var r=e.doc.sel.ranges,n=[],i=0;i<r.length;i++){for(var o=t(r[i]);n.length&&P(o.from,g(n).to)<=0;){var l=n.pop();if(P(l.from,o.from)<0){o.from=l.from;break}}n.push(o)}hn(e,function(){for(var t=n.length-1;t>=0;t--)Ei(e.doc,"",n[t].from,n[t].to,"+delete");jr(e)})}function fo(e,t,r){var n=L(e.text,t+r,r);return n<0||n>e.text.length?null:n}function ho(e,t,r){var n=fo(e,t.ch,r);return null==n?null:new E(t.line,n,r<0?"after":"before")}function po(e,t,r,n,i){if(e){var o=Se(r,t.doc.direction);if(o){var l,s=i<0?g(o):o[0],a=i<0==(1==s.level)?"after":"before";if(s.level>0){var u=Xt(t,r);l=i<0?r.text.length-1:0;var c=Yt(t,u,l).top;l=k(function(e){return Yt(t,u,e).top==c},i<0==(1==s.level)?s.from:s.to-1,l),"before"==a&&(l=fo(r,l,1))}else l=i<0?s.to:s.from;return new E(n,l,a)}}return new E(n,i<0?r.text.length:0,i<0?"before":"after")}function go(e,t,r,n){var i=Se(t,e.doc.direction);if(!i)return ho(t,r,n);r.ch>=t.text.length?(r.ch=t.text.length,r.sticky="before"):r.ch<=0&&(r.ch=0,r.sticky="after");var o=Ce(i,r.ch,r.sticky),l=i[o];if("ltr"==e.doc.direction&&l.level%2==0&&(n>0?l.to>r.ch:l.from<r.ch))return ho(t,r,n);var s,a=function(e,r){return fo(t,e instanceof E?e.ch:e,r)},u=function(r){return e.options.lineWrapping?(s=s||Xt(e,t),hr(e,t,s,r)):{begin:0,end:t.text.length}},c=u("before"==r.sticky?a(r,-1):r.ch);if("rtl"==e.doc.direction||1==l.level){var f=1==l.level==n<0,h=a(r,f?1:-1);if(null!=h&&(f?h<=l.to&&h<=c.end:h>=l.from&&h>=c.begin)){var d=f?"before":"after";return new E(r.line,h,d)}}var p=function(e,t,n){for(var o=function(e,t){return t?new E(r.line,a(e,1),"before"):new E(r.line,e,"after")};e>=0&&e<i.length;e+=t){var l=i[e],s=t>0==(1!=l.level),u=s?n.begin:a(n.end,-1);if(l.from<=u&&u<l.to)return o(u,s);if(u=s?l.from:a(l.to,-1),n.begin<=u&&u<n.end)return o(u,s)}},g=p(o+n,n,c);if(g)return g;var v=n>0?c.end:a(c.begin,-1);return null==v||n>0&&v==t.text.length||!(g=p(n>0?0:i.length-1,n,u(v)))?null:g}function vo(e,t){var r=M(e.doc,t),n=fe(r);return n!=r&&(t=W(n)),po(!0,e,n,t,1)}function mo(e,t){var r=M(e.doc,t),n=he(r);return n!=r&&(t=W(n)),po(!0,e,r,t,-1)}function yo(e,t){var r=vo(e,t.line),n=M(e.doc,r.line),i=Se(n,e.doc.direction);if(!i||0==i[0].level){var o=Math.max(0,n.text.search(/\S/)),l=t.line==r.line&&t.ch<=o&&t.ch;return E(r.line,l?0:o,r.sticky)}return r}function bo(e,t,r){if("string"==typeof t&&!(t=Bs[t]))return!1;e.display.input.ensurePolled();var n=e.display.shift,i=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),r&&(e.display.shift=!1),i=t(e)!=Bl}finally{e.display.shift=n,e.state.suppressEdits=!1}return i}function wo(e,t,r){for(var n=0;n<e.state.keyMaps.length;n++){var i=oo(t,e.state.keyMaps[n],r,e);if(i)return i}return e.options.extraKeys&&oo(t,e.options.extraKeys,r,e)||oo(t,e.options.keyMap,r,e)}function xo(e,t,r,n){var i=e.state.keySeq;if(i){if(lo(t))return"handled";Gs.set(50,function(){e.state.keySeq==i&&(e.state.keySeq=null,e.display.input.reset())}),t=i+" "+t}var o=wo(e,t,n);return"multi"==o&&(e.state.keySeq=t),"handled"==o&&bt(e,"keyHandled",e,t,r),"handled"!=o&&"multi"!=o||(We(r),Ar(e)),i&&!o&&/\'$/.test(t)?(We(r),!0):!!o}function Co(e,t){var r=ao(t,!0);return!!r&&(t.shiftKey&&!e.state.keySeq?xo(e,"Shift-"+r,t,function(t){return bo(e,t,!0)})||xo(e,r,t,function(t){if("string"==typeof t?/^go[A-Z]/.test(t):t.motion)return bo(e,t)}):xo(e,r,t,function(t){return bo(e,t)}))}function So(e,t,r){return xo(e,"'"+r+"'",t,function(t){return bo(e,t,!0)})}function Lo(e){var t=this;if(t.curOp.focus=l(),!Me(t,e)){gl&&vl<11&&27==e.keyCode&&(e.returnValue=!1);var r=e.keyCode;t.display.shift=16==r||e.shiftKey;var n=Co(t,e);wl&&(Us=n?r:null,!n&&88==r&&!rs&&(Ml?e.metaKey:e.ctrlKey)&&t.replaceSelection("",null,"cut")),18!=r||/\bCodeMirror-crosshair\b/.test(t.display.lineDiv.className)||ko(t)}}function ko(e){function t(e){18!=e.keyCode&&e.altKey||(Fl(r,"CodeMirror-crosshair"),ke(document,"keyup",t),ke(document,"mouseover",t))}var r=e.display.lineDiv;s(r,"CodeMirror-crosshair"),Ql(document,"keyup",t),Ql(document,"mouseover",t)}function To(e){16==e.keyCode&&(this.doc.sel.shift=!1),Me(this,e)}function Mo(e){var t=this;if(!(Ft(t.display,e)||Me(t,e)||e.ctrlKey&&!e.altKey||Ml&&e.metaKey)){var r=e.keyCode,n=e.charCode;if(wl&&r==Us)return Us=null,void We(e);if(!wl||e.which&&!(e.which<10)||!Co(t,e)){var i=String.fromCharCode(null==n?r:n);"\b"!=i&&(So(t,e,i)||t.display.input.onKeyPress(e))}}}function No(e,t){var r=+new Date;return js&&js.compare(r,e,t)?(Ks=js=null,"triple"):Ks&&Ks.compare(r,e,t)?(js=new Vs(r,e,t),Ks=null,"double"):(Ks=new Vs(r,e,t),js=null,"single")}function Oo(e){var t=this,r=t.display;if(!(Me(t,e)||r.activeTouch&&r.input.supportsTouch()))if(r.input.ensurePolled(),r.shift=e.shiftKey,Ft(r,e))ml||(r.scroller.draggable=!1,setTimeout(function(){return r.scroller.draggable=!0},100));else if(!zo(t,e)){var n=Sr(t,e),i=Pe(e),o=n?No(n,i):"single";window.focus(),1==i&&t.state.selectingText&&t.state.selectingText(e),n&&Ao(t,i,n,o,e)||(1==i?n?Do(t,n,o,e):Ee(e)==r.scroller&&We(e):2==i?(n&&di(t.doc,n),setTimeout(function(){return r.input.focus()},20)):3==i&&(Hl?Ro(t,e):Dr(t)))}}function Ao(e,t,r,n,i){var o="Click";return"double"==n?o="Double"+o:"triple"==n&&(o="Triple"+o),o=(1==t?"Left":2==t?"Middle":"Right")+o,xo(e,so(o,i),i,function(t){if("string"==typeof t&&(t=Bs[t]),!t)return!1;var n=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),n=t(e,r)!=Bl}finally{e.state.suppressEdits=!1}return n})}function Wo(e,t,r){var n=e.getOption("configureMouse"),i=n?n(e,t,r):{};if(null==i.unit){var o=Nl?r.shiftKey&&r.metaKey:r.altKey;i.unit=o?"rectangle":"single"==t?"char":"double"==t?"word":"line"}return(null==i.extend||e.doc.extend)&&(i.extend=e.doc.extend||r.shiftKey),null==i.addNew&&(i.addNew=Ml?r.metaKey:r.ctrlKey),null==i.moveOnDrag&&(i.moveOnDrag=!(Ml?r.altKey:r.ctrlKey)),i}function Do(e,t,r,n){gl?setTimeout(u(Wr,e),0):e.curOp.focus=l();var i,o=Wo(e,r,n),s=e.doc.sel;e.options.dragDrop&&Jl&&!e.isReadOnly()&&"single"==r&&(i=s.contains(t))>-1&&(P((i=s.ranges[i]).from(),t)<0||t.xRel>0)&&(P(i.to(),t)>0||t.xRel<0)?Ho(e,n,t,o):Eo(e,n,t,o)}function Ho(e,t,r,n){var i=e.display,o=!1,l=dn(e,function(t){ml&&(i.scroller.draggable=!1),e.state.draggingText=!1,ke(document,"mouseup",l),ke(document,"mousemove",s),ke(i.scroller,"dragstart",a),ke(i.scroller,"drop",l),o||(We(t),n.addNew||di(e.doc,r,null,null,n.extend),ml||gl&&9==vl?setTimeout(function(){document.body.focus(),i.input.focus()},20):i.input.focus())}),s=function(e){o=o||Math.abs(t.clientX-e.clientX)+Math.abs(t.clientY-e.clientY)>=10},a=function(){return o=!0};ml&&(i.scroller.draggable=!0),e.state.draggingText=l,l.copy=!n.moveOnDrag,i.scroller.dragDrop&&i.scroller.dragDrop(),Ql(document,"mouseup",l),Ql(document,"mousemove",s),Ql(i.scroller,"dragstart",a),Ql(i.scroller,"drop",l),Dr(e),setTimeout(function(){return i.input.focus()},20)}function Fo(e,t,r){if("char"==r)return new Ts(t,t);if("word"==r)return e.findWordAt(t);if("line"==r)return new Ts(E(t.line,0),U(e.doc,E(t.line+1,0)));var n=r(e,t);return new Ts(n.from,n.to)}function Eo(e,t,r,n){function i(t){if(0!=P(m,t))if(m=t,"rectangle"==n.unit){for(var i=[],o=e.options.tabSize,l=f(M(u,r.line).text,r.ch,o),s=f(M(u,t.line).text,t.ch,o),a=Math.min(l,s),g=Math.max(l,s),v=Math.min(r.line,t.line),y=Math.min(e.lastLine(),Math.max(r.line,t.line));v<=y;v++){var b=M(u,v).text,w=d(b,a,o);a==g?i.push(new Ts(E(v,w),E(v,w))):b.length>w&&i.push(new Ts(E(v,w),E(v,d(b,g,o))))}i.length||i.push(new Ts(r,r)),bi(u,zn(p.ranges.slice(0,h).concat(i),h),{origin:"*mouse",scroll:!1}),e.scrollIntoView(t)}else{var x,C=c,S=Fo(e,t,n.unit),L=C.anchor;P(S.anchor,L)>0?(x=S.head,L=B(C.from(),S.anchor)):(x=S.anchor,L=R(C.to(),S.head));var k=p.ranges.slice(0);k[h]=Po(e,new Ts(U(u,L),x)),bi(u,zn(k,h),Ul)}}function o(t){var r=++b,s=Sr(e,t,!0,"rectangle"==n.unit);if(s)if(0!=P(s,m)){e.curOp.focus=l(),i(s);var c=Ir(a,u);(s.line>=c.to||s.line<c.from)&&setTimeout(dn(e,function(){b==r&&o(t)}),150)}else{var f=t.clientY<y.top?-20:t.clientY>y.bottom?20:0;f&&setTimeout(dn(e,function(){b==r&&(a.scroller.scrollTop+=f,o(t))}),50)}}function s(t){e.state.selectingText=!1,b=1/0,We(t),a.input.focus(),ke(document,"mousemove",w),ke(document,"mouseup",x),u.history.lastSelOrigin=null}var a=e.display,u=e.doc;We(t);var c,h,p=u.sel,g=p.ranges;if(n.addNew&&!n.extend?(h=u.sel.contains(r),c=h>-1?g[h]:new Ts(r,r)):(c=u.sel.primary(),h=u.sel.primIndex),"rectangle"==n.unit)n.addNew||(c=new Ts(r,r)),r=Sr(e,t,!0,!0),h=-1;else{var v=Fo(e,r,n.unit);c=n.extend?hi(c,v.anchor,v.head,n.extend):v}n.addNew?-1==h?(h=g.length,bi(u,zn(g.concat([c]),h),{scroll:!1,origin:"*mouse"})):g.length>1&&g[h].empty()&&"char"==n.unit&&!n.extend?(bi(u,zn(g.slice(0,h).concat(g.slice(h+1)),0),{scroll:!1,origin:"*mouse"}),p=u.sel):gi(u,h,c,Ul):(h=0,bi(u,new ks([c],0),Ul),p=u.sel);var m=r,y=a.wrapper.getBoundingClientRect(),b=0,w=dn(e,function(e){Pe(e)?o(e):s(e)}),x=dn(e,s);e.state.selectingText=x,Ql(document,"mousemove",w),Ql(document,"mouseup",x)}function Po(e,t){var r=t.anchor,n=t.head,i=M(e.doc,r.line);if(0==P(r,n)&&r.sticky==n.sticky)return t;var o=Se(i);if(!o)return t;var l=Ce(o,r.ch,r.sticky),s=o[l];if(s.from!=r.ch&&s.to!=r.ch)return t;var a=l+(s.from==r.ch==(1!=s.level)?0:1);if(0==a||a==o.length)return t;var u;if(n.line!=r.line)u=(n.line-r.line)*("ltr"==e.doc.direction?1:-1)>0;else{var c=Ce(o,n.ch,n.sticky),f=c-l||(n.ch-r.ch)*(1==s.level?-1:1);u=c==a-1||c==a?f<0:f>0}var h=o[a+(u?-1:0)],d=u==(1==h.level),p=d?h.from:h.to,g=d?"after":"before";return r.ch==p&&r.sticky==g?t:new Ts(new E(r.line,p,g),n)}function Io(e,t,r,n){var i,o;if(t.touches)i=t.touches[0].clientX,o=t.touches[0].clientY;else try{i=t.clientX,o=t.clientY}catch(t){return!1}if(i>=Math.floor(e.display.gutters.getBoundingClientRect().right))return!1;n&&We(t);var l=e.display,s=l.lineDiv.getBoundingClientRect();if(o>s.bottom||!Oe(e,r))return He(t);o-=s.top-l.viewOffset;for(var a=0;a<e.options.gutters.length;++a){var u=l.gutters.childNodes[a];if(u&&u.getBoundingClientRect().right>=i)return Te(e,r,e,D(e.doc,o),e.options.gutters[a],t),He(t)}}function zo(e,t){return Io(e,t,"gutterClick",!0)}function Ro(e,t){Ft(e.display,t)||Bo(e,t)||Me(e,t,"contextmenu")||e.display.input.onContextMenu(t)}function Bo(e,t){return!!Oe(e,"gutterContextMenu")&&Io(e,t,"gutterContextMenu",!1)}function Go(e){e.display.wrapper.className=e.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+e.options.theme.replace(/(^|\s)\s*/g," cm-s-"),er(e)}function Uo(e){Hn(e),vn(e),zr(e)}function Vo(e,t,r){if(!t!=!(r&&r!=Xs)){var n=e.display.dragFunctions,i=t?Ql:ke;i(e.display.scroller,"dragstart",n.start),i(e.display.scroller,"dragenter",n.enter),i(e.display.scroller,"dragover",n.over),i(e.display.scroller,"dragleave",n.leave),i(e.display.scroller,"drop",n.drop)}}function Ko(e){e.options.lineWrapping?(s(e.display.wrapper,"CodeMirror-wrap"),e.display.sizer.style.minWidth="",e.display.sizerWidth=null):(Fl(e.display.wrapper,"CodeMirror-wrap"),we(e)),Cr(e),vn(e),er(e),setTimeout(function(){return en(e)},100)}function jo(e,t){var r=this;if(!(this instanceof jo))return new jo(e,t);this.options=t=t?c(t):{},c(Ys,t,!1),Fn(t);var n=t.value;"string"==typeof n&&(n=new Ds(n,t.mode,null,t.lineSeparator,t.direction)),this.doc=n;var i=new jo.inputStyles[t.inputStyle](this),o=this.display=new T(e,n,i);o.wrapper.CodeMirror=this,Hn(this),Go(this),t.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),rn(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,delayingBlurEvent:!1,focused:!1,suppressEdits:!1,pasteIncoming:!1,cutIncoming:!1,selectingText:!1,draggingText:!1,highlight:new Pl,keySeq:null,specialChars:null},t.autofocus&&!Tl&&o.input.focus(),gl&&vl<11&&setTimeout(function(){return r.display.input.reset(!0)},20),Xo(this),eo(),nn(this),this.curOp.forceUpdate=!0,qn(this,n),t.autofocus&&!Tl||this.hasFocus()?setTimeout(u(Hr,this),20):Fr(this);for(var l in _s)_s.hasOwnProperty(l)&&_s[l](r,t[l],Xs);Rr(this),t.finishInit&&t.finishInit(this);for(var s=0;s<$s.length;++s)$s[s](r);on(this),ml&&t.lineWrapping&&"optimizelegibility"==getComputedStyle(o.lineDiv).textRendering&&(o.lineDiv.style.textRendering="auto")}function Xo(e){function t(){i.activeTouch&&(o=setTimeout(function(){return i.activeTouch=null},1e3),(l=i.activeTouch).end=+new Date)}function r(e){if(1!=e.touches.length)return!1;var t=e.touches[0];return t.radiusX<=1&&t.radiusY<=1}function n(e,t){if(null==t.left)return!0;var r=t.left-e.left,n=t.top-e.top;return r*r+n*n>400}var i=e.display;Ql(i.scroller,"mousedown",dn(e,Oo)),gl&&vl<11?Ql(i.scroller,"dblclick",dn(e,function(t){if(!Me(e,t)){var r=Sr(e,t);if(r&&!zo(e,t)&&!Ft(e.display,t)){We(t);var n=e.findWordAt(r);di(e.doc,n.anchor,n.head)}}})):Ql(i.scroller,"dblclick",function(t){return Me(e,t)||We(t)}),Hl||Ql(i.scroller,"contextmenu",function(t){return Ro(e,t)});var o,l={end:0};Ql(i.scroller,"touchstart",function(t){if(!Me(e,t)&&!r(t)&&!zo(e,t)){i.input.ensurePolled(),clearTimeout(o);var n=+new Date;i.activeTouch={start:n,moved:!1,prev:n-l.end<=300?l:null},1==t.touches.length&&(i.activeTouch.left=t.touches[0].pageX,i.activeTouch.top=t.touches[0].pageY)}}),Ql(i.scroller,"touchmove",function(){i.activeTouch&&(i.activeTouch.moved=!0)}),Ql(i.scroller,"touchend",function(r){var o=i.activeTouch;if(o&&!Ft(i,r)&&null!=o.left&&!o.moved&&new Date-o.start<300){var l,s=e.coordsChar(i.activeTouch,"page");l=!o.prev||n(o,o.prev)?new Ts(s,s):!o.prev.prev||n(o,o.prev.prev)?e.findWordAt(s):new Ts(E(s.line,0),U(e.doc,E(s.line+1,0))),e.setSelection(l.anchor,l.head),e.focus(),We(r)}t()}),Ql(i.scroller,"touchcancel",t),Ql(i.scroller,"scroll",function(){i.scroller.clientHeight&&(qr(e,i.scroller.scrollTop),Qr(e,i.scroller.scrollLeft,!0),Te(e,"scroll",e))}),Ql(i.scroller,"mousewheel",function(t){return In(e,t)}),Ql(i.scroller,"DOMMouseScroll",function(t){return In(e,t)}),Ql(i.wrapper,"scroll",function(){return i.wrapper.scrollTop=i.wrapper.scrollLeft=0}),i.dragFunctions={enter:function(t){Me(e,t)||Fe(t)},over:function(t){Me(e,t)||(Zi(e,t),Fe(t))},start:function(t){return qi(e,t)},drop:dn(e,$i),leave:function(t){Me(e,t)||Qi(e)}};var s=i.input.getField();Ql(s,"keyup",function(t){return To.call(e,t)}),Ql(s,"keydown",dn(e,Lo)),Ql(s,"keypress",dn(e,Mo)),Ql(s,"focus",function(t){return Hr(e,t)}),Ql(s,"blur",function(t){return Fr(e,t)})}function Yo(e,t,r,n){var i,o=e.doc;null==r&&(r="add"),"smart"==r&&(o.mode.indent?i=$e(e,t).state:r="prev");var l=e.options.tabSize,s=M(o,t),a=f(s.text,null,l);s.stateAfter&&(s.stateAfter=null);var u,c=s.text.match(/^\s*/)[0];if(n||/\S/.test(s.text)){if("smart"==r&&((u=o.mode.indent(i,s.text.slice(c.length),s.text))==Bl||u>150)){if(!n)return;r="prev"}}else u=0,r="not";"prev"==r?u=t>o.first?f(M(o,t-1).text,null,l):0:"add"==r?u=a+e.options.indentUnit:"subtract"==r?u=a-e.options.indentUnit:"number"==typeof r&&(u=a+r),u=Math.max(0,u);var h="",d=0;if(e.options.indentWithTabs)for(var g=Math.floor(u/l);g;--g)d+=l,h+="\t";if(d<u&&(h+=p(u-d)),h!=c)return Ei(o,h,E(t,0),E(t,c.length),"+input"),s.stateAfter=null,!0;for(var v=0;v<o.sel.ranges.length;v++){var m=o.sel.ranges[v];if(m.head.line==t&&m.head.ch<c.length){var y=E(t,c.length);gi(o,v,new Ts(y,y));break}}}function _o(e){qs=e}function $o(e,t,r,n,i){var o=e.doc;e.display.shift=!1,n||(n=o.sel);var l=e.state.pasteIncoming||"paste"==i,s=es(t),a=null;if(l&&n.ranges.length>1)if(qs&&qs.text.join("\n")==t){if(n.ranges.length%qs.text.length==0){a=[];for(var u=0;u<qs.text.length;u++)a.push(o.splitLines(qs.text[u]))}}else s.length==n.ranges.length&&e.options.pasteLinesPerSelection&&(a=v(s,function(e){return[e]}));for(var c,f=n.ranges.length-1;f>=0;f--){var h=n.ranges[f],d=h.from(),p=h.to();h.empty()&&(r&&r>0?d=E(d.line,d.ch-r):e.state.overwrite&&!l?p=E(p.line,Math.min(M(o,p.line).text.length,p.ch+g(s).length)):qs&&qs.lineWise&&qs.text.join("\n")==t&&(d=p=E(d.line,0))),c=e.curOp.updateInput;var m={from:d,to:p,text:a?a[f%a.length]:s,origin:i||(l?"paste":e.state.cutIncoming?"cut":"+input")};Oi(e.doc,m),bt(e,"inputRead",e,m)}t&&!l&&Zo(e,t),jr(e),e.curOp.updateInput=c,e.curOp.typing=!0,e.state.pasteIncoming=e.state.cutIncoming=!1}function qo(e,t){var r=e.clipboardData&&e.clipboardData.getData("Text");if(r)return e.preventDefault(),t.isReadOnly()||t.options.disableInput||hn(t,function(){return $o(t,r,0,null,"paste")}),!0}function Zo(e,t){if(e.options.electricChars&&e.options.smartIndent)for(var r=e.doc.sel,n=r.ranges.length-1;n>=0;n--){var i=r.ranges[n];if(!(i.head.ch>100||n&&r.ranges[n-1].head.line==i.head.line)){var o=e.getModeAt(i.head),l=!1;if(o.electricChars){for(var s=0;s<o.electricChars.length;s++)if(t.indexOf(o.electricChars.charAt(s))>-1){l=Yo(e,i.head.line,"smart");break}}else o.electricInput&&o.electricInput.test(M(e.doc,i.head.line).text.slice(0,i.head.ch))&&(l=Yo(e,i.head.line,"smart"));l&&bt(e,"electricInput",e,i.head.line)}}}function Qo(e){for(var t=[],r=[],n=0;n<e.doc.sel.ranges.length;n++){var i=e.doc.sel.ranges[n].head.line,o={anchor:E(i,0),head:E(i+1,0)};r.push(o),t.push(e.getRange(o.anchor,o.head))}return{text:t,ranges:r}}function Jo(e,t){e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!!t)}function el(){var e=n("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; outline: none"),t=n("div",[e],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return ml?e.style.width="1000px":e.setAttribute("wrap","off"),Ll&&(e.style.border="1px solid black"),Jo(e),t}function tl(e,t,r,n,i){function o(){var n=t.line+r;return!(n<e.first||n>=e.first+e.size)&&(t=new E(n,t.ch,t.sticky),u=M(e,n))}function l(n){var l;if(null==(l=i?go(e.cm,u,t,r):ho(u,t,r))){if(n||!o())return!1;t=po(i,e.cm,u,t.line,r)}else t=l;return!0}var s=t,a=r,u=M(e,t.line);if("char"==n)l();else if("column"==n)l(!0);else if("word"==n||"group"==n)for(var c=null,f="group"==n,h=e.cm&&e.cm.getHelper(t,"wordChars"),d=!0;!(r<0)||l(!d);d=!1){var p=u.text.charAt(t.ch)||"\n",g=x(p,h)?"w":f&&"\n"==p?"n":!f||/\s/.test(p)?null:"p";if(!f||d||g||(g="s"),c&&c!=g){r<0&&(r=1,l(),t.sticky="after");break}if(g&&(c=g),r>0&&!l(!d))break}var v=ki(e,t,s,a,!0);return I(s,v)&&(v.hitSide=!0),v}function rl(e,t,r,n){var i,o=e.doc,l=t.left;if("page"==n){var s=Math.min(e.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight),a=Math.max(s-.5*mr(e.display),3);i=(r>0?t.bottom:t.top)+r*a}else"line"==n&&(i=r>0?t.bottom+3:t.top-3);for(var u;(u=cr(e,l,i)).outside;){if(r<0?i<=0:i>=o.height){u.hitSide=!0;break}i+=5*r}return u}function nl(e,t){var r=jt(e,t.line);if(!r||r.hidden)return null;var n=M(e.doc,t.line),i=Ut(r,n,t.line),o=Se(n,e.doc.direction),l="left";o&&(l=Ce(o,t.ch)%2?"right":"left");var s=_t(i.map,t.ch,l);return s.offset="right"==s.collapse?s.end:s.start,s}function il(e){for(var t=e;t;t=t.parentNode)if(/CodeMirror-gutter-wrapper/.test(t.className))return!0;return!1}function ol(e,t){return t&&(e.bad=!0),e}function ll(e,t,r,n,i){function o(e){return function(t){return t.id==e}}function l(){c&&(u+=f,c=!1)}function s(e){e&&(l(),u+=e)}function a(t){if(1==t.nodeType){var r=t.getAttribute("cm-text");if(null!=r)return void s(r||t.textContent.replace(/\u200b/g,""));var u,h=t.getAttribute("cm-marker");if(h){var d=e.findMarks(E(n,0),E(i+1,0),o(+h));return void(d.length&&(u=d[0].find(0))&&s(N(e.doc,u.from,u.to).join(f)))}if("false"==t.getAttribute("contenteditable"))return;var p=/^(pre|div|p)$/i.test(t.nodeName);p&&l();for(var g=0;g<t.childNodes.length;g++)a(t.childNodes[g]);p&&(c=!0)}else 3==t.nodeType&&s(t.nodeValue)}for(var u="",c=!1,f=e.doc.lineSeparator();a(t),t!=r;)t=t.nextSibling;return u}function sl(e,t,r){var n;if(t==e.display.lineDiv){if(!(n=e.display.lineDiv.childNodes[r]))return ol(e.clipPos(E(e.display.viewTo-1)),!0);t=null,r=0}else for(n=t;;n=n.parentNode){if(!n||n==e.display.lineDiv)return null;if(n.parentNode&&n.parentNode==e.display.lineDiv)break}for(var i=0;i<e.display.view.length;i++){var o=e.display.view[i];if(o.node==n)return al(o,t,r)}}function al(e,t,r){function n(t,r,n){for(var i=-1;i<(f?f.length:0);i++)for(var o=i<0?c.map:f[i],l=0;l<o.length;l+=3){var s=o[l+2];if(s==t||s==r){var a=W(i<0?e.line:e.rest[i]),u=o[l]+n;return(n<0||s!=t)&&(u=o[l+(n?1:0)]),E(a,u)}}}var i=e.text.firstChild,l=!1;if(!t||!o(i,t))return ol(E(W(e.line),0),!0);if(t==i&&(l=!0,t=i.childNodes[r],r=0,!t)){var s=e.rest?g(e.rest):e.line;return ol(E(W(s),s.text.length),l)}var a=3==t.nodeType?t:null,u=t;for(a||1!=t.childNodes.length||3!=t.firstChild.nodeType||(a=t.firstChild,r&&(r=a.nodeValue.length));u.parentNode!=i;)u=u.parentNode;var c=e.measure,f=c.maps,h=n(a,u,r);if(h)return ol(h,l);for(var d=u.nextSibling,p=a?a.nodeValue.length-r:0;d;d=d.nextSibling){if(h=n(d,d.firstChild,0))return ol(E(h.line,h.ch-p),l);p+=d.textContent.length}for(var v=u.previousSibling,m=r;v;v=v.previousSibling){if(h=n(v,v.firstChild,-1))return ol(E(h.line,h.ch+m),l);m+=v.textContent.length}}var ul=navigator.userAgent,cl=navigator.platform,fl=/gecko\/\d/i.test(ul),hl=/MSIE \d/.test(ul),dl=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(ul),pl=/Edge\/(\d+)/.exec(ul),gl=hl||dl||pl,vl=gl&&(hl?document.documentMode||6:+(pl||dl)[1]),ml=!pl&&/WebKit\//.test(ul),yl=ml&&/Qt\/\d+\.\d+/.test(ul),bl=!pl&&/Chrome\//.test(ul),wl=/Opera\//.test(ul),xl=/Apple Computer/.test(navigator.vendor),Cl=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(ul),Sl=/PhantomJS/.test(ul),Ll=!pl&&/AppleWebKit/.test(ul)&&/Mobile\/\w+/.test(ul),kl=/Android/.test(ul),Tl=Ll||kl||/webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(ul),Ml=Ll||/Mac/.test(cl),Nl=/\bCrOS\b/.test(ul),Ol=/win/i.test(cl),Al=wl&&ul.match(/Version\/(\d*\.\d*)/);Al&&(Al=Number(Al[1])),Al&&Al>=15&&(wl=!1,ml=!0);var Wl,Dl=Ml&&(yl||wl&&(null==Al||Al<12.11)),Hl=fl||gl&&vl>=9,Fl=function(t,r){var n=t.className,i=e(r).exec(n);if(i){var o=n.slice(i.index+i[0].length);t.className=n.slice(0,i.index)+(o?i[1]+o:"")}};Wl=document.createRange?function(e,t,r,n){var i=document.createRange();return i.setEnd(n||e,r),i.setStart(e,t),i}:function(e,t,r){var n=document.body.createTextRange();try{n.moveToElementText(e.parentNode)}catch(e){return n}return n.collapse(!0),n.moveEnd("character",r),n.moveStart("character",t),n};var El=function(e){e.select()};Ll?El=function(e){e.selectionStart=0,e.selectionEnd=e.value.length}:gl&&(El=function(e){try{e.select()}catch(e){}});var Pl=function(){this.id=null};Pl.prototype.set=function(e,t){clearTimeout(this.id),this.id=setTimeout(t,e)};var Il,zl,Rl=30,Bl={toString:function(){return"CodeMirror.Pass"}},Gl={scroll:!1},Ul={origin:"*mouse"},Vl={origin:"+move"},Kl=[""],jl=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/,Xl=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/,Yl=!1,_l=!1,$l=null,ql=function(){function e(e){return e<=247?r.charAt(e):1424<=e&&e<=1524?"R":1536<=e&&e<=1785?n.charAt(e-1536):1774<=e&&e<=2220?"r":8192<=e&&e<=8203?"w":8204==e?"b":"L"}function t(e,t,r){this.level=e,this.from=t,this.to=r}var r="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",n="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111",i=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,o=/[stwN]/,l=/[LRr]/,s=/[Lb1n]/,a=/[1n]/;return function(r,n){var u="ltr"==n?"L":"R";if(0==r.length||"ltr"==n&&!i.test(r))return!1;for(var c=r.length,f=[],h=0;h<c;++h)f.push(e(r.charCodeAt(h)));for(var d=0,p=u;d<c;++d){var v=f[d];"m"==v?f[d]=p:p=v}for(var m=0,y=u;m<c;++m){var b=f[m];"1"==b&&"r"==y?f[m]="n":l.test(b)&&(y=b,"r"==b&&(f[m]="R"))}for(var w=1,x=f[0];w<c-1;++w){var C=f[w];"+"==C&&"1"==x&&"1"==f[w+1]?f[w]="1":","!=C||x!=f[w+1]||"1"!=x&&"n"!=x||(f[w]=x),x=C}for(var S=0;S<c;++S){var L=f[S];if(","==L)f[S]="N";else if("%"==L){var k=void 0;for(k=S+1;k<c&&"%"==f[k];++k);for(var T=S&&"!"==f[S-1]||k<c&&"1"==f[k]?"1":"N",M=S;M<k;++M)f[M]=T;S=k-1}}for(var N=0,O=u;N<c;++N){var A=f[N];"L"==O&&"1"==A?f[N]="L":l.test(A)&&(O=A)}for(var W=0;W<c;++W)if(o.test(f[W])){var D=void 0;for(D=W+1;D<c&&o.test(f[D]);++D);for(var H="L"==(W?f[W-1]:u),F=H==("L"==(D<c?f[D]:u))?H?"L":"R":u,E=W;E<D;++E)f[E]=F;W=D-1}for(var P,I=[],z=0;z<c;)if(s.test(f[z])){var R=z;for(++z;z<c&&s.test(f[z]);++z);I.push(new t(0,R,z))}else{var B=z,G=I.length;for(++z;z<c&&"L"!=f[z];++z);for(var U=B;U<z;)if(a.test(f[U])){B<U&&I.splice(G,0,new t(1,B,U));var V=U;for(++U;U<z&&a.test(f[U]);++U);I.splice(G,0,new t(2,V,U)),B=U}else++U;B<z&&I.splice(G,0,new t(1,B,z))}return 1==I[0].level&&(P=r.match(/^\s+/))&&(I[0].from=P[0].length,I.unshift(new t(0,0,P[0].length))),1==g(I).level&&(P=r.match(/\s+$/))&&(g(I).to-=P[0].length,I.push(new t(0,c-P[0].length,c))),"rtl"==n?I.reverse():I}}(),Zl=[],Ql=function(e,t,r){if(e.addEventListener)e.addEventListener(t,r,!1);else if(e.attachEvent)e.attachEvent("on"+t,r);else{var n=e._handlers||(e._handlers={});n[t]=(n[t]||Zl).concat(r)}},Jl=function(){if(gl&&vl<9)return!1;var e=n("div");return"draggable"in e||"dragDrop"in e}(),es=3!="\n\nb".split(/\n/).length?function(e){for(var t=0,r=[],n=e.length;t<=n;){var i=e.indexOf("\n",t);-1==i&&(i=e.length);var o=e.slice(t,"\r"==e.charAt(i-1)?i-1:i),l=o.indexOf("\r");-1!=l?(r.push(o.slice(0,l)),t+=l+1):(r.push(o),t=i+1)}return r}:function(e){return e.split(/\r\n?|\n/)},ts=window.getSelection?function(e){try{return e.selectionStart!=e.selectionEnd}catch(e){return!1}}:function(e){var t;try{t=e.ownerDocument.selection.createRange()}catch(e){}return!(!t||t.parentElement()!=e)&&0!=t.compareEndPoints("StartToEnd",t)},rs=function(){var e=n("div");return"oncopy"in e||(e.setAttribute("oncopy","return;"),"function"==typeof e.oncopy)}(),ns=null,is={},os={},ls={},ss=function(e,t,r){this.pos=this.start=0,this.string=e,this.tabSize=t||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0,this.lineOracle=r};ss.prototype.eol=function(){return this.pos>=this.string.length},ss.prototype.sol=function(){return this.pos==this.lineStart},ss.prototype.peek=function(){return this.string.charAt(this.pos)||void 0},ss.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},ss.prototype.eat=function(e){var t=this.string.charAt(this.pos);if("string"==typeof e?t==e:t&&(e.test?e.test(t):e(t)))return++this.pos,t},ss.prototype.eatWhile=function(e){for(var t=this.pos;this.eat(e););return this.pos>t},ss.prototype.eatSpace=function(){for(var e=this,t=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++e.pos;return this.pos>t},ss.prototype.skipToEnd=function(){this.pos=this.string.length},ss.prototype.skipTo=function(e){var t=this.string.indexOf(e,this.pos);if(t>-1)return this.pos=t,!0},ss.prototype.backUp=function(e){this.pos-=e},ss.prototype.column=function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=f(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?f(this.string,this.lineStart,this.tabSize):0)},ss.prototype.indentation=function(){return f(this.string,null,this.tabSize)-(this.lineStart?f(this.string,this.lineStart,this.tabSize):0)},ss.prototype.match=function(e,t,r){if("string"!=typeof e){var n=this.string.slice(this.pos).match(e);return n&&n.index>0?null:(n&&!1!==t&&(this.pos+=n[0].length),n)}var i=function(e){return r?e.toLowerCase():e};if(i(this.string.substr(this.pos,e.length))==i(e))return!1!==t&&(this.pos+=e.length),!0},ss.prototype.current=function(){return this.string.slice(this.start,this.pos)},ss.prototype.hideFirstChars=function(e,t){this.lineStart+=e;try{return t()}finally{this.lineStart-=e}},ss.prototype.lookAhead=function(e){var t=this.lineOracle;return t&&t.lookAhead(e)};var as=function(e,t){this.state=e,this.lookAhead=t},us=function(e,t,r,n){this.state=t,this.doc=e,this.line=r,this.maxLookAhead=n||0};us.prototype.lookAhead=function(e){var t=this.doc.getLine(this.line+e);return null!=t&&e>this.maxLookAhead&&(this.maxLookAhead=e),t},us.prototype.nextLine=function(){this.line++,this.maxLookAhead>0&&this.maxLookAhead--},us.fromSaved=function(e,t,r){return t instanceof as?new us(e,Ke(e.mode,t.state),r,t.lookAhead):new us(e,Ke(e.mode,t),r)},us.prototype.save=function(e){var t=!1!==e?Ke(this.doc.mode,this.state):this.state;return this.maxLookAhead>0?new as(t,this.maxLookAhead):t};var cs=function(e,t,r){this.start=e.start,this.end=e.pos,this.string=e.current(),this.type=t||null,this.state=r},fs=function(e,t,r){this.text=e,ne(this,t),this.height=r?r(this):1};fs.prototype.lineNo=function(){return W(this)},Ae(fs);var hs,ds={},ps={},gs=null,vs=null,ms={left:0,right:0,top:0,bottom:0},ys=function(e,t,r){this.cm=r;var i=this.vert=n("div",[n("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),o=this.horiz=n("div",[n("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");e(i),e(o),Ql(i,"scroll",function(){i.clientHeight&&t(i.scrollTop,"vertical")}),Ql(o,"scroll",function(){o.clientWidth&&t(o.scrollLeft,"horizontal")}),this.checkedZeroWidth=!1,gl&&vl<8&&(this.horiz.style.minHeight=this.vert.style.minWidth="18px")};ys.prototype.update=function(e){var t=e.scrollWidth>e.clientWidth+1,r=e.scrollHeight>e.clientHeight+1,n=e.nativeBarWidth;if(r){this.vert.style.display="block",this.vert.style.bottom=t?n+"px":"0";var i=e.viewHeight-(t?n:0);this.vert.firstChild.style.height=Math.max(0,e.scrollHeight-e.clientHeight+i)+"px"}else this.vert.style.display="",this.vert.firstChild.style.height="0";if(t){this.horiz.style.display="block",this.horiz.style.right=r?n+"px":"0",this.horiz.style.left=e.barLeft+"px";var o=e.viewWidth-e.barLeft-(r?n:0);this.horiz.firstChild.style.width=Math.max(0,e.scrollWidth-e.clientWidth+o)+"px"}else this.horiz.style.display="",this.horiz.firstChild.style.width="0";return!this.checkedZeroWidth&&e.clientHeight>0&&(0==n&&this.zeroWidthHack(),this.checkedZeroWidth=!0),{right:r?n:0,bottom:t?n:0}},ys.prototype.setScrollLeft=function(e){this.horiz.scrollLeft!=e&&(this.horiz.scrollLeft=e),this.disableHoriz&&this.enableZeroWidthBar(this.horiz,this.disableHoriz,"horiz")},ys.prototype.setScrollTop=function(e){this.vert.scrollTop!=e&&(this.vert.scrollTop=e),this.disableVert&&this.enableZeroWidthBar(this.vert,this.disableVert,"vert")},ys.prototype.zeroWidthHack=function(){var e=Ml&&!Cl?"12px":"18px";this.horiz.style.height=this.vert.style.width=e,this.horiz.style.pointerEvents=this.vert.style.pointerEvents="none",this.disableHoriz=new Pl,this.disableVert=new Pl},ys.prototype.enableZeroWidthBar=function(e,t,r){function n(){var i=e.getBoundingClientRect();("vert"==r?document.elementFromPoint(i.right-1,(i.top+i.bottom)/2):document.elementFromPoint((i.right+i.left)/2,i.bottom-1))!=e?e.style.pointerEvents="none":t.set(1e3,n)}e.style.pointerEvents="auto",t.set(1e3,n)},ys.prototype.clear=function(){var e=this.horiz.parentNode;e.removeChild(this.horiz),e.removeChild(this.vert)};var bs=function(){};bs.prototype.update=function(){return{bottom:0,right:0}},bs.prototype.setScrollLeft=function(){},bs.prototype.setScrollTop=function(){},bs.prototype.clear=function(){};var ws={native:ys,null:bs},xs=0,Cs=function(e,t,r){var n=e.display;this.viewport=t,this.visible=Ir(n,e.doc,t),this.editorIsHidden=!n.wrapper.offsetWidth,this.wrapperHeight=n.wrapper.clientHeight,this.wrapperWidth=n.wrapper.clientWidth,this.oldDisplayWidth=Rt(e),this.force=r,this.dims=br(e),this.events=[]};Cs.prototype.signal=function(e,t){Oe(e,t)&&this.events.push(arguments)},Cs.prototype.finish=function(){for(var e=this,t=0;t<this.events.length;t++)Te.apply(null,e.events[t])};var Ss=0,Ls=null;gl?Ls=-.53:fl?Ls=15:bl?Ls=-.7:xl&&(Ls=-1/3);var ks=function(e,t){this.ranges=e,this.primIndex=t};ks.prototype.primary=function(){return this.ranges[this.primIndex]},ks.prototype.equals=function(e){var t=this;if(e==this)return!0;if(e.primIndex!=this.primIndex||e.ranges.length!=this.ranges.length)return!1;for(var r=0;r<this.ranges.length;r++){var n=t.ranges[r],i=e.ranges[r];if(!I(n.anchor,i.anchor)||!I(n.head,i.head))return!1}return!0},ks.prototype.deepCopy=function(){for(var e=this,t=[],r=0;r<this.ranges.length;r++)t[r]=new Ts(z(e.ranges[r].anchor),z(e.ranges[r].head));return new ks(t,this.primIndex)},ks.prototype.somethingSelected=function(){for(var e=this,t=0;t<this.ranges.length;t++)if(!e.ranges[t].empty())return!0;return!1},ks.prototype.contains=function(e,t){var r=this;t||(t=e);for(var n=0;n<this.ranges.length;n++){var i=r.ranges[n];if(P(t,i.from())>=0&&P(e,i.to())<=0)return n}return-1};var Ts=function(e,t){this.anchor=e,this.head=t};Ts.prototype.from=function(){return B(this.anchor,this.head)},Ts.prototype.to=function(){return R(this.anchor,this.head)},Ts.prototype.empty=function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch},Bi.prototype={chunkSize:function(){return this.lines.length},removeInner:function(e,t){for(var r=this,n=e,i=e+t;n<i;++n){var o=r.lines[n];r.height-=o.height,ot(o),bt(o,"delete")}this.lines.splice(e,t)},collapse:function(e){e.push.apply(e,this.lines)},insertInner:function(e,t,r){var n=this;this.height+=r,this.lines=this.lines.slice(0,e).concat(t).concat(this.lines.slice(e));for(var i=0;i<t.length;++i)t[i].parent=n},iterN:function(e,t,r){for(var n=this,i=e+t;e<i;++e)if(r(n.lines[e]))return!0}},Gi.prototype={chunkSize:function(){return this.size},removeInner:function(e,t){var r=this;this.size-=t;for(var n=0;n<this.children.length;++n){var i=r.children[n],o=i.chunkSize();if(e<o){var l=Math.min(t,o-e),s=i.height;if(i.removeInner(e,l),r.height-=s-i.height,o==l&&(r.children.splice(n--,1),i.parent=null),0==(t-=l))break;e=0}else e-=o}if(this.size-t<25&&(this.children.length>1||!(this.children[0]instanceof Bi))){var a=[];this.collapse(a),this.children=[new Bi(a)],this.children[0].parent=this}},collapse:function(e){for(var t=this,r=0;r<this.children.length;++r)t.children[r].collapse(e)},insertInner:function(e,t,r){var n=this;this.size+=t.length,this.height+=r;for(var i=0;i<this.children.length;++i){var o=n.children[i],l=o.chunkSize();if(e<=l){if(o.insertInner(e,t,r),o.lines&&o.lines.length>50){for(var s=o.lines.length%25+25,a=s;a<o.lines.length;){var u=new Bi(o.lines.slice(a,a+=25));o.height-=u.height,n.children.splice(++i,0,u),u.parent=n}o.lines=o.lines.slice(0,s),n.maybeSpill()}break}e-=l}},maybeSpill:function(){if(!(this.children.length<=10)){var e=this;do{var t=new Gi(e.children.splice(e.children.length-5,5));if(e.parent){e.size-=t.size,e.height-=t.height;var r=h(e.parent.children,e);e.parent.children.splice(r+1,0,t)}else{var n=new Gi(e.children);n.parent=e,e.children=[n,t],e=n}t.parent=e.parent}while(e.children.length>10);e.parent.maybeSpill()}},iterN:function(e,t,r){for(var n=this,i=0;i<this.children.length;++i){var o=n.children[i],l=o.chunkSize();if(e<l){var s=Math.min(t,l-e);if(o.iterN(e,s,r))return!0;if(0==(t-=s))break;e=0}else e-=l}}};var Ms=function(e,t,r){var n=this;if(r)for(var i in r)r.hasOwnProperty(i)&&(n[i]=r[i]);this.doc=e,this.node=t};Ms.prototype.clear=function(){var e=this,t=this.doc.cm,r=this.line.widgets,n=this.line,i=W(n);if(null!=i&&r){for(var o=0;o<r.length;++o)r[o]==e&&r.splice(o--,1);r.length||(n.widgets=null);var l=Ht(this);A(n,Math.max(0,n.height-l)),t&&(hn(t,function(){Ui(t,n,-l),mn(t,i,"widget")}),bt(t,"lineWidgetCleared",t,this,i))}},Ms.prototype.changed=function(){var e=this,t=this.height,r=this.doc.cm,n=this.line;this.height=null;var i=Ht(this)-t;i&&(A(n,n.height+i),r&&hn(r,function(){r.curOp.forceUpdate=!0,Ui(r,n,i),bt(r,"lineWidgetChanged",r,e,W(n))}))},Ae(Ms);var Ns=0,Os=function(e,t){this.lines=[],this.type=t,this.doc=e,this.id=++Ns};Os.prototype.clear=function(){var e=this;if(!this.explicitlyCleared){var t=this.doc.cm,r=t&&!t.curOp;if(r&&nn(t),Oe(this,"clear")){var n=this.find();n&&bt(this,"clear",n.from,n.to)}for(var i=null,o=null,l=0;l<this.lines.length;++l){var s=e.lines[l],a=_(s.markedSpans,e);t&&!e.collapsed?mn(t,W(s),"text"):t&&(null!=a.to&&(o=W(s)),null!=a.from&&(i=W(s))),s.markedSpans=$(s.markedSpans,a),null==a.from&&e.collapsed&&!ve(e.doc,s)&&t&&A(s,mr(t.display))}if(t&&this.collapsed&&!t.options.lineWrapping)for(var u=0;u<this.lines.length;++u){var c=fe(e.lines[u]),f=be(c);f>t.display.maxLineLength&&(t.display.maxLine=c,t.display.maxLineLength=f,t.display.maxLineChanged=!0)}null!=i&&t&&this.collapsed&&vn(t,i,o+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,t&&Ci(t.doc)),t&&bt(t,"markerCleared",t,this,i,o),r&&on(t),this.parent&&this.parent.clear()}},Os.prototype.find=function(e,t){var r=this;null==e&&"bookmark"==this.type&&(e=1);for(var n,i,o=0;o<this.lines.length;++o){var l=r.lines[o],s=_(l.markedSpans,r);if(null!=s.from&&(n=E(t?l:W(l),s.from),-1==e))return n;if(null!=s.to&&(i=E(t?l:W(l),s.to),1==e))return i}return n&&{from:n,to:i}},Os.prototype.changed=function(){var e=this,t=this.find(-1,!0),r=this,n=this.doc.cm;t&&n&&hn(n,function(){var i=t.line,o=W(t.line),l=jt(n,o);if(l&&(Qt(l),n.curOp.selectionChanged=n.curOp.forceUpdate=!0),n.curOp.updateMaxLine=!0,!ve(r.doc,i)&&null!=r.height){var s=r.height;r.height=null;var a=Ht(r)-s;a&&A(i,i.height+a)}bt(n,"markerChanged",n,e)})},Os.prototype.attachLine=function(e){if(!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;t.maybeHiddenMarkers&&-1!=h(t.maybeHiddenMarkers,this)||(t.maybeUnhiddenMarkers||(t.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(e)},Os.prototype.detachLine=function(e){if(this.lines.splice(h(this.lines,e),1),!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;(t.maybeHiddenMarkers||(t.maybeHiddenMarkers=[])).push(this)}},Ae(Os);var As=function(e,t){var r=this;this.markers=e,this.primary=t;for(var n=0;n<e.length;++n)e[n].parent=r};As.prototype.clear=function(){var e=this;if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var t=0;t<this.markers.length;++t)e.markers[t].clear();bt(this,"clear")}},As.prototype.find=function(e,t){return this.primary.find(e,t)},Ae(As);var Ws=0,Ds=function(e,t,r,n,i){if(!(this instanceof Ds))return new Ds(e,t,r,n,i);null==r&&(r=0),Gi.call(this,[new Bi([new fs("",null)])]),this.first=r,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=r;var o=E(r,0);this.sel=Rn(o),this.history=new Jn(null),this.id=++Ws,this.modeOption=t,this.lineSep=n,this.direction="rtl"==i?"rtl":"ltr",this.extend=!1,"string"==typeof e&&(e=this.splitLines(e)),_n(this,{from:o,to:o,text:e}),bi(this,Rn(o),Gl)};Ds.prototype=b(Gi.prototype,{constructor:Ds,iter:function(e,t,r){r?this.iterN(e-this.first,t-e,r):this.iterN(this.first,this.first+this.size,e)},insert:function(e,t){for(var r=0,n=0;n<t.length;++n)r+=t[n].height;this.insertInner(e-this.first,t,r)},remove:function(e,t){this.removeInner(e-this.first,t)},getValue:function(e){var t=O(this,this.first,this.first+this.size);return!1===e?t:t.join(e||this.lineSeparator())},setValue:gn(function(e){var t=E(this.first,0),r=this.first+this.size-1;Oi(this,{from:t,to:E(r,M(this,r).text.length),text:this.splitLines(e),origin:"setValue",full:!0},!0),this.cm&&Xr(this.cm,0,0),bi(this,Rn(t),Gl)}),replaceRange:function(e,t,r,n){Ei(this,e,t=U(this,t),r=r?U(this,r):t,n)},getRange:function(e,t,r){var n=N(this,U(this,e),U(this,t));return!1===r?n:n.join(r||this.lineSeparator())},getLine:function(e){var t=this.getLineHandle(e);return t&&t.text},getLineHandle:function(e){if(H(this,e))return M(this,e)},getLineNumber:function(e){return W(e)},getLineHandleVisualStart:function(e){return"number"==typeof e&&(e=M(this,e)),fe(e)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(e){return U(this,e)},getCursor:function(e){var t=this.sel.primary();return null==e||"head"==e?t.head:"anchor"==e?t.anchor:"end"==e||"to"==e||!1===e?t.to():t.from()},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:gn(function(e,t,r){vi(this,U(this,"number"==typeof e?E(e,t||0):e),null,r)}),setSelection:gn(function(e,t,r){vi(this,U(this,e),U(this,t||e),r)}),extendSelection:gn(function(e,t,r){di(this,U(this,e),t&&U(this,t),r)}),extendSelections:gn(function(e,t){pi(this,K(this,e),t)}),extendSelectionsBy:gn(function(e,t){pi(this,K(this,v(this.sel.ranges,e)),t)}),setSelections:gn(function(e,t,r){var n=this;if(e.length){for(var i=[],o=0;o<e.length;o++)i[o]=new Ts(U(n,e[o].anchor),U(n,e[o].head));null==t&&(t=Math.min(e.length-1,this.sel.primIndex)),bi(this,zn(i,t),r)}}),addSelection:gn(function(e,t,r){var n=this.sel.ranges.slice(0);n.push(new Ts(U(this,e),U(this,t||e))),bi(this,zn(n,n.length-1),r)}),getSelection:function(e){for(var t,r=this,n=this.sel.ranges,i=0;i<n.length;i++){var o=N(r,n[i].from(),n[i].to());t=t?t.concat(o):o}return!1===e?t:t.join(e||this.lineSeparator())},getSelections:function(e){for(var t=this,r=[],n=this.sel.ranges,i=0;i<n.length;i++){var o=N(t,n[i].from(),n[i].to());!1!==e&&(o=o.join(e||t.lineSeparator())),r[i]=o}return r},replaceSelection:function(e,t,r){for(var n=[],i=0;i<this.sel.ranges.length;i++)n[i]=e;this.replaceSelections(n,t,r||"+input")},replaceSelections:gn(function(e,t,r){for(var n=this,i=[],o=this.sel,l=0;l<o.ranges.length;l++){var s=o.ranges[l];i[l]={from:s.from(),to:s.to(),text:n.splitLines(e[l]),origin:r}}for(var a=t&&"end"!=t&&Kn(this,i,t),u=i.length-1;u>=0;u--)Oi(n,i[u]);a?yi(this,a):this.cm&&jr(this.cm)}),undo:gn(function(){Wi(this,"undo")}),redo:gn(function(){Wi(this,"redo")}),undoSelection:gn(function(){Wi(this,"undo",!0)}),redoSelection:gn(function(){Wi(this,"redo",!0)}),setExtending:function(e){this.extend=e},getExtending:function(){return this.extend},historySize:function(){for(var e=this.history,t=0,r=0,n=0;n<e.done.length;n++)e.done[n].ranges||++t;for(var i=0;i<e.undone.length;i++)e.undone[i].ranges||++r;return{undo:t,redo:r}},clearHistory:function(){this.history=new Jn(this.history.maxGeneration)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(e){return e&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(e){return this.history.generation==(e||this.cleanGeneration)},getHistory:function(){return{done:fi(this.history.done),undone:fi(this.history.undone)}},setHistory:function(e){var t=this.history=new Jn(this.history.maxGeneration);t.done=fi(e.done.slice(0),null,!0),t.undone=fi(e.undone.slice(0),null,!0)},setGutterMarker:gn(function(e,t,r){return Ri(this,e,"gutter",function(e){var n=e.gutterMarkers||(e.gutterMarkers={});return n[t]=r,!r&&C(n)&&(e.gutterMarkers=null),!0})}),clearGutter:gn(function(e){var t=this;this.iter(function(r){r.gutterMarkers&&r.gutterMarkers[e]&&Ri(t,r,"gutter",function(){return r.gutterMarkers[e]=null,C(r.gutterMarkers)&&(r.gutterMarkers=null),!0})})}),lineInfo:function(e){var t;if("number"==typeof e){if(!H(this,e))return null;if(t=e,!(e=M(this,e)))return null}else if(null==(t=W(e)))return null;return{line:t,handle:e,text:e.text,gutterMarkers:e.gutterMarkers,textClass:e.textClass,bgClass:e.bgClass,wrapClass:e.wrapClass,widgets:e.widgets}},addLineClass:gn(function(t,r,n){return Ri(this,t,"gutter"==r?"gutter":"class",function(t){var i="text"==r?"textClass":"background"==r?"bgClass":"gutter"==r?"gutterClass":"wrapClass";if(t[i]){if(e(n).test(t[i]))return!1;t[i]+=" "+n}else t[i]=n;return!0})}),removeLineClass:gn(function(t,r,n){return Ri(this,t,"gutter"==r?"gutter":"class",function(t){var i="text"==r?"textClass":"background"==r?"bgClass":"gutter"==r?"gutterClass":"wrapClass",o=t[i];if(!o)return!1;if(null==n)t[i]=null;else{var l=o.match(e(n));if(!l)return!1;var s=l.index+l[0].length;t[i]=o.slice(0,l.index)+(l.index&&s!=o.length?" ":"")+o.slice(s)||null}return!0})}),addLineWidget:gn(function(e,t,r){return Vi(this,e,t,r)}),removeLineWidget:function(e){e.clear()},markText:function(e,t,r){return Ki(this,U(this,e),U(this,t),r,r&&r.type||"range")},setBookmark:function(e,t){var r={replacedWith:t&&(null==t.nodeType?t.widget:t),insertLeft:t&&t.insertLeft,clearWhenEmpty:!1,shared:t&&t.shared,handleMouseEvents:t&&t.handleMouseEvents};return e=U(this,e),Ki(this,e,e,r,"bookmark")},findMarksAt:function(e){var t=[],r=M(this,(e=U(this,e)).line).markedSpans;if(r)for(var n=0;n<r.length;++n){var i=r[n];(null==i.from||i.from<=e.ch)&&(null==i.to||i.to>=e.ch)&&t.push(i.marker.parent||i.marker)}return t},findMarks:function(e,t,r){e=U(this,e),t=U(this,t);var n=[],i=e.line;return this.iter(e.line,t.line+1,function(o){var l=o.markedSpans;if(l)for(var s=0;s<l.length;s++){var a=l[s];null!=a.to&&i==e.line&&e.ch>=a.to||null==a.from&&i!=e.line||null!=a.from&&i==t.line&&a.from>=t.ch||r&&!r(a.marker)||n.push(a.marker.parent||a.marker)}++i}),n},getAllMarks:function(){var e=[];return this.iter(function(t){var r=t.markedSpans;if(r)for(var n=0;n<r.length;++n)null!=r[n].from&&e.push(r[n].marker)}),e},posFromIndex:function(e){var t,r=this.first,n=this.lineSeparator().length;return this.iter(function(i){var o=i.text.length+n;if(o>e)return t=e,!0;e-=o,++r}),U(this,E(r,t))},indexFromPos:function(e){var t=(e=U(this,e)).ch;if(e.line<this.first||e.ch<0)return 0;var r=this.lineSeparator().length;return this.iter(this.first,e.line,function(e){t+=e.text.length+r}),t},copy:function(e){var t=new Ds(O(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return t.scrollTop=this.scrollTop,t.scrollLeft=this.scrollLeft,t.sel=this.sel,t.extend=!1,e&&(t.history.undoDepth=this.history.undoDepth,t.setHistory(this.getHistory())),t},linkedDoc:function(e){e||(e={});var t=this.first,r=this.first+this.size;null!=e.from&&e.from>t&&(t=e.from),null!=e.to&&e.to<r&&(r=e.to);var n=new Ds(O(this,t,r),e.mode||this.modeOption,t,this.lineSep,this.direction);return e.sharedHist&&(n.history=this.history),(this.linked||(this.linked=[])).push({doc:n,sharedHist:e.sharedHist}),n.linked=[{doc:this,isParent:!0,sharedHist:e.sharedHist}],Yi(n,Xi(this)),n},unlinkDoc:function(e){var t=this;if(e instanceof jo&&(e=e.doc),this.linked)for(var r=0;r<this.linked.length;++r)if(t.linked[r].doc==e){t.linked.splice(r,1),e.unlinkDoc(t),_i(Xi(t));break}if(e.history==this.history){var n=[e.id];$n(e,function(e){return n.push(e.id)},!0),e.history=new Jn(null),e.history.done=fi(this.history.done,n),e.history.undone=fi(this.history.undone,n)}},iterLinkedDocs:function(e){$n(this,e)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(e){return this.lineSep?e.split(this.lineSep):es(e)},lineSeparator:function(){return this.lineSep||"\n"},setDirection:gn(function(e){"rtl"!=e&&(e="ltr"),e!=this.direction&&(this.direction=e,this.iter(function(e){return e.order=null}),this.cm&&Qn(this.cm))})}),Ds.prototype.eachLine=Ds.prototype.iter;for(var Hs=0,Fs=!1,Es={3:"Enter",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",106:"*",107:"=",109:"-",110:".",111:"/",127:"Delete",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},Ps=0;Ps<10;Ps++)Es[Ps+48]=Es[Ps+96]=String(Ps);for(var Is=65;Is<=90;Is++)Es[Is]=String.fromCharCode(Is);for(var zs=1;zs<=12;zs++)Es[zs+111]=Es[zs+63235]="F"+zs;var Rs={};Rs.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},Rs.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Up":"goLineUp","Ctrl-Down":"goLineDown","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},Rs.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Alt-F":"goWordRight","Alt-B":"goWordLeft","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-D":"delWordAfter","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars","Ctrl-O":"openLine"},Rs.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Home":"goDocStart","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineLeft","Cmd-Right":"goLineRight","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delWrappedLineLeft","Cmd-Delete":"delWrappedLineRight","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd",fallthrough:["basic","emacsy"]},Rs.default=Ml?Rs.macDefault:Rs.pcDefault;var Bs={selectAll:Mi,singleSelection:function(e){return e.setSelection(e.getCursor("anchor"),e.getCursor("head"),Gl)},killLine:function(e){return co(e,function(t){if(t.empty()){var r=M(e.doc,t.head.line).text.length;return t.head.ch==r&&t.head.line<e.lastLine()?{from:t.head,to:E(t.head.line+1,0)}:{from:t.head,to:E(t.head.line,r)}}return{from:t.from(),to:t.to()}})},deleteLine:function(e){return co(e,function(t){return{from:E(t.from().line,0),to:U(e.doc,E(t.to().line+1,0))}})},delLineLeft:function(e){return co(e,function(e){return{from:E(e.from().line,0),to:e.from()}})},delWrappedLineLeft:function(e){return co(e,function(t){var r=e.charCoords(t.head,"div").top+5;return{from:e.coordsChar({left:0,top:r},"div"),to:t.from()}})},delWrappedLineRight:function(e){return co(e,function(t){var r=e.charCoords(t.head,"div").top+5,n=e.coordsChar({left:e.display.lineDiv.offsetWidth+100,top:r},"div");return{from:t.from(),to:n}})},undo:function(e){return e.undo()},redo:function(e){return e.redo()},undoSelection:function(e){return e.undoSelection()},redoSelection:function(e){return e.redoSelection()},goDocStart:function(e){return e.extendSelection(E(e.firstLine(),0))},goDocEnd:function(e){return e.extendSelection(E(e.lastLine()))},goLineStart:function(e){return e.extendSelectionsBy(function(t){return vo(e,t.head.line)},{origin:"+move",bias:1})},goLineStartSmart:function(e){return e.extendSelectionsBy(function(t){return yo(e,t.head)},{origin:"+move",bias:1})},goLineEnd:function(e){return e.extendSelectionsBy(function(t){return mo(e,t.head.line)},{origin:"+move",bias:-1})},goLineRight:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5;return e.coordsChar({left:e.display.lineDiv.offsetWidth+100,top:r},"div")},Vl)},goLineLeft:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5;return e.coordsChar({left:0,top:r},"div")},Vl)},goLineLeftSmart:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5,n=e.coordsChar({left:0,top:r},"div");return n.ch<e.getLine(n.line).search(/\S/)?yo(e,t.head):n},Vl)},goLineUp:function(e){return e.moveV(-1,"line")},goLineDown:function(e){return e.moveV(1,"line")},goPageUp:function(e){return e.moveV(-1,"page")},goPageDown:function(e){return e.moveV(1,"page")},goCharLeft:function(e){return e.moveH(-1,"char")},goCharRight:function(e){return e.moveH(1,"char")},goColumnLeft:function(e){return e.moveH(-1,"column")},goColumnRight:function(e){return e.moveH(1,"column")},goWordLeft:function(e){return e.moveH(-1,"word")},goGroupRight:function(e){return e.moveH(1,"group")},goGroupLeft:function(e){return e.moveH(-1,"group")},goWordRight:function(e){return e.moveH(1,"word")},delCharBefore:function(e){return e.deleteH(-1,"char")},delCharAfter:function(e){return e.deleteH(1,"char")},delWordBefore:function(e){return e.deleteH(-1,"word")},delWordAfter:function(e){return e.deleteH(1,"word")},delGroupBefore:function(e){return e.deleteH(-1,"group")},delGroupAfter:function(e){return e.deleteH(1,"group")},indentAuto:function(e){return e.indentSelection("smart")},indentMore:function(e){return e.indentSelection("add")},indentLess:function(e){return e.indentSelection("subtract")},insertTab:function(e){return e.replaceSelection("\t")},insertSoftTab:function(e){for(var t=[],r=e.listSelections(),n=e.options.tabSize,i=0;i<r.length;i++){var o=r[i].from(),l=f(e.getLine(o.line),o.ch,n);t.push(p(n-l%n))}e.replaceSelections(t)},defaultTab:function(e){e.somethingSelected()?e.indentSelection("add"):e.execCommand("insertTab")},transposeChars:function(e){return hn(e,function(){for(var t=e.listSelections(),r=[],n=0;n<t.length;n++)if(t[n].empty()){var i=t[n].head,o=M(e.doc,i.line).text;if(o)if(i.ch==o.length&&(i=new E(i.line,i.ch-1)),i.ch>0)i=new E(i.line,i.ch+1),e.replaceRange(o.charAt(i.ch-1)+o.charAt(i.ch-2),E(i.line,i.ch-2),i,"+transpose");else if(i.line>e.doc.first){var l=M(e.doc,i.line-1).text;l&&(i=new E(i.line,1),e.replaceRange(o.charAt(0)+e.doc.lineSeparator()+l.charAt(l.length-1),E(i.line-1,l.length-1),i,"+transpose"))}r.push(new Ts(i,i))}e.setSelections(r)})},newlineAndIndent:function(e){return hn(e,function(){for(var t=e.listSelections(),r=t.length-1;r>=0;r--)e.replaceRange(e.doc.lineSeparator(),t[r].anchor,t[r].head,"+input");t=e.listSelections();for(var n=0;n<t.length;n++)e.indentLine(t[n].from().line,null,!0);jr(e)})},openLine:function(e){return e.replaceSelection("\n","start")},toggleOverwrite:function(e){return e.toggleOverwrite()}},Gs=new Pl,Us=null,Vs=function(e,t,r){this.time=e,this.pos=t,this.button=r};Vs.prototype.compare=function(e,t,r){return this.time+400>e&&0==P(t,this.pos)&&r==this.button};var Ks,js,Xs={toString:function(){return"CodeMirror.Init"}},Ys={},_s={};jo.defaults=Ys,jo.optionHandlers=_s;var $s=[];jo.defineInitHook=function(e){return $s.push(e)};var qs=null,Zs=function(e){this.cm=e,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new Pl,this.composing=null,this.gracePeriod=!1,this.readDOMTimeout=null};Zs.prototype.init=function(e){function t(e){if(!Me(i,e)){if(i.somethingSelected())_o({lineWise:!1,text:i.getSelections()}),"cut"==e.type&&i.replaceSelection("",null,"cut");else{if(!i.options.lineWiseCopyCut)return;var t=Qo(i);_o({lineWise:!0,text:t.text}),"cut"==e.type&&i.operation(function(){i.setSelections(t.ranges,0,Gl),i.replaceSelection("",null,"cut")})}if(e.clipboardData){e.clipboardData.clearData();var r=qs.text.join("\n");if(e.clipboardData.setData("Text",r),e.clipboardData.getData("Text")==r)return void e.preventDefault()}var l=el(),s=l.firstChild;i.display.lineSpace.insertBefore(l,i.display.lineSpace.firstChild),s.value=qs.text.join("\n");var a=document.activeElement;El(s),setTimeout(function(){i.display.lineSpace.removeChild(l),a.focus(),a==o&&n.showPrimarySelection()},50)}}var r=this,n=this,i=n.cm,o=n.div=e.lineDiv;Jo(o,i.options.spellcheck),Ql(o,"paste",function(e){Me(i,e)||qo(e,i)||vl<=11&&setTimeout(dn(i,function(){return r.updateFromDOM()}),20)}),Ql(o,"compositionstart",function(e){r.composing={data:e.data,done:!1}}),Ql(o,"compositionupdate",function(e){r.composing||(r.composing={data:e.data,done:!1})}),Ql(o,"compositionend",function(e){r.composing&&(e.data!=r.composing.data&&r.readFromDOMSoon(),r.composing.done=!0)}),Ql(o,"touchstart",function(){return n.forceCompositionEnd()}),Ql(o,"input",function(){r.composing||r.readFromDOMSoon()}),Ql(o,"copy",t),Ql(o,"cut",t)},Zs.prototype.prepareSelection=function(){var e=Tr(this.cm,!1);return e.focus=this.cm.state.focused,e},Zs.prototype.showSelection=function(e,t){e&&this.cm.display.view.length&&((e.focus||t)&&this.showPrimarySelection(),this.showMultipleSelections(e))},Zs.prototype.showPrimarySelection=function(){var e=window.getSelection(),t=this.cm,r=t.doc.sel.primary(),n=r.from(),i=r.to();if(t.display.viewTo==t.display.viewFrom||n.line>=t.display.viewTo||i.line<t.display.viewFrom)e.removeAllRanges();else{var o=sl(t,e.anchorNode,e.anchorOffset),l=sl(t,e.focusNode,e.focusOffset);if(!o||o.bad||!l||l.bad||0!=P(B(o,l),n)||0!=P(R(o,l),i)){var s=t.display.view,a=n.line>=t.display.viewFrom&&nl(t,n)||{node:s[0].measure.map[2],offset:0},u=i.line<t.display.viewTo&&nl(t,i);if(!u){var c=s[s.length-1].measure,f=c.maps?c.maps[c.maps.length-1]:c.map;u={node:f[f.length-1],offset:f[f.length-2]-f[f.length-3]}}if(a&&u){var h,d=e.rangeCount&&e.getRangeAt(0);try{h=Wl(a.node,a.offset,u.offset,u.node)}catch(e){}h&&(!fl&&t.state.focused?(e.collapse(a.node,a.offset),h.collapsed||(e.removeAllRanges(),e.addRange(h))):(e.removeAllRanges(),e.addRange(h)),d&&null==e.anchorNode?e.addRange(d):fl&&this.startGracePeriod()),this.rememberSelection()}else e.removeAllRanges()}}},Zs.prototype.startGracePeriod=function(){var e=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout(function(){e.gracePeriod=!1,e.selectionChanged()&&e.cm.operation(function(){return e.cm.curOp.selectionChanged=!0})},20)},Zs.prototype.showMultipleSelections=function(e){r(this.cm.display.cursorDiv,e.cursors),r(this.cm.display.selectionDiv,e.selection)},Zs.prototype.rememberSelection=function(){var e=window.getSelection();this.lastAnchorNode=e.anchorNode,this.lastAnchorOffset=e.anchorOffset,this.lastFocusNode=e.focusNode,this.lastFocusOffset=e.focusOffset},Zs.prototype.selectionInEditor=function(){var e=window.getSelection();if(!e.rangeCount)return!1;var t=e.getRangeAt(0).commonAncestorContainer;return o(this.div,t)},Zs.prototype.focus=function(){"nocursor"!=this.cm.options.readOnly&&(this.selectionInEditor()||this.showSelection(this.prepareSelection(),!0),this.div.focus())},Zs.prototype.blur=function(){this.div.blur()},Zs.prototype.getField=function(){return this.div},Zs.prototype.supportsTouch=function(){return!0},Zs.prototype.receivedFocus=function(){function e(){t.cm.state.focused&&(t.pollSelection(),t.polling.set(t.cm.options.pollInterval,e))}var t=this;this.selectionInEditor()?this.pollSelection():hn(this.cm,function(){return t.cm.curOp.selectionChanged=!0}),this.polling.set(this.cm.options.pollInterval,e)},Zs.prototype.selectionChanged=function(){var e=window.getSelection();return e.anchorNode!=this.lastAnchorNode||e.anchorOffset!=this.lastAnchorOffset||e.focusNode!=this.lastFocusNode||e.focusOffset!=this.lastFocusOffset},Zs.prototype.pollSelection=function(){if(null==this.readDOMTimeout&&!this.gracePeriod&&this.selectionChanged()){var e=window.getSelection(),t=this.cm;if(kl&&bl&&this.cm.options.gutters.length&&il(e.anchorNode))return this.cm.triggerOnKeyDown({type:"keydown",keyCode:8,preventDefault:Math.abs}),this.blur(),void this.focus();if(!this.composing){this.rememberSelection();var r=sl(t,e.anchorNode,e.anchorOffset),n=sl(t,e.focusNode,e.focusOffset);r&&n&&hn(t,function(){bi(t.doc,Rn(r,n),Gl),(r.bad||n.bad)&&(t.curOp.selectionChanged=!0)})}}},Zs.prototype.pollContent=function(){null!=this.readDOMTimeout&&(clearTimeout(this.readDOMTimeout),this.readDOMTimeout=null);var e=this.cm,t=e.display,r=e.doc.sel.primary(),n=r.from(),i=r.to();if(0==n.ch&&n.line>e.firstLine()&&(n=E(n.line-1,M(e.doc,n.line-1).length)),i.ch==M(e.doc,i.line).text.length&&i.line<e.lastLine()&&(i=E(i.line+1,0)),n.line<t.viewFrom||i.line>t.viewTo-1)return!1;var o,l,s;n.line==t.viewFrom||0==(o=Lr(e,n.line))?(l=W(t.view[0].line),s=t.view[0].node):(l=W(t.view[o].line),s=t.view[o-1].node.nextSibling);var a,u,c=Lr(e,i.line);if(c==t.view.length-1?(a=t.viewTo-1,u=t.lineDiv.lastChild):(a=W(t.view[c+1].line)-1,u=t.view[c+1].node.previousSibling),!s)return!1;for(var f=e.doc.splitLines(ll(e,s,u,l,a)),h=N(e.doc,E(l,0),E(a,M(e.doc,a).text.length));f.length>1&&h.length>1;)if(g(f)==g(h))f.pop(),h.pop(),a--;else{if(f[0]!=h[0])break;f.shift(),h.shift(),l++}for(var d=0,p=0,v=f[0],m=h[0],y=Math.min(v.length,m.length);d<y&&v.charCodeAt(d)==m.charCodeAt(d);)++d;for(var b=g(f),w=g(h),x=Math.min(b.length-(1==f.length?d:0),w.length-(1==h.length?d:0));p<x&&b.charCodeAt(b.length-p-1)==w.charCodeAt(w.length-p-1);)++p;if(1==f.length&&1==h.length&&l==n.line)for(;d&&d>n.ch&&b.charCodeAt(b.length-p-1)==w.charCodeAt(w.length-p-1);)d--,p++;f[f.length-1]=b.slice(0,b.length-p).replace(/^\u200b+/,""),f[0]=f[0].slice(d).replace(/\u200b+$/,"");var C=E(l,d),S=E(a,h.length?g(h).length-p:0);return f.length>1||f[0]||P(C,S)?(Ei(e.doc,f,C,S,"+input"),!0):void 0},Zs.prototype.ensurePolled=function(){this.forceCompositionEnd()},Zs.prototype.reset=function(){this.forceCompositionEnd()},Zs.prototype.forceCompositionEnd=function(){this.composing&&(clearTimeout(this.readDOMTimeout),this.composing=null,this.updateFromDOM(),this.div.blur(),this.div.focus())},Zs.prototype.readFromDOMSoon=function(){var e=this;null==this.readDOMTimeout&&(this.readDOMTimeout=setTimeout(function(){if(e.readDOMTimeout=null,e.composing){if(!e.composing.done)return;e.composing=null}e.updateFromDOM()},80))},Zs.prototype.updateFromDOM=function(){var e=this;!this.cm.isReadOnly()&&this.pollContent()||hn(this.cm,function(){return vn(e.cm)})},Zs.prototype.setUneditable=function(e){e.contentEditable="false"},Zs.prototype.onKeyPress=function(e){0!=e.charCode&&(e.preventDefault(),this.cm.isReadOnly()||dn(this.cm,$o)(this.cm,String.fromCharCode(null==e.charCode?e.keyCode:e.charCode),0))},Zs.prototype.readOnlyChanged=function(e){this.div.contentEditable=String("nocursor"!=e)},Zs.prototype.onContextMenu=function(){},Zs.prototype.resetPosition=function(){},Zs.prototype.needsContentAttribute=!0;var Qs=function(e){this.cm=e,this.prevInput="",this.pollingFast=!1,this.polling=new Pl,this.hasSelection=!1,this.composing=null};Qs.prototype.init=function(e){function t(e){if(!Me(i,e)){if(i.somethingSelected())_o({lineWise:!1,text:i.getSelections()});else{if(!i.options.lineWiseCopyCut)return;var t=Qo(i);_o({lineWise:!0,text:t.text}),"cut"==e.type?i.setSelections(t.ranges,null,Gl):(n.prevInput="",l.value=t.text.join("\n"),El(l))}"cut"==e.type&&(i.state.cutIncoming=!0)}}var r=this,n=this,i=this.cm,o=this.wrapper=el(),l=this.textarea=o.firstChild;e.wrapper.insertBefore(o,e.wrapper.firstChild),Ll&&(l.style.width="0px"),Ql(l,"input",function(){gl&&vl>=9&&r.hasSelection&&(r.hasSelection=null),n.poll()}),Ql(l,"paste",function(e){Me(i,e)||qo(e,i)||(i.state.pasteIncoming=!0,n.fastPoll())}),Ql(l,"cut",t),Ql(l,"copy",t),Ql(e.scroller,"paste",function(t){Ft(e,t)||Me(i,t)||(i.state.pasteIncoming=!0,n.focus())}),Ql(e.lineSpace,"selectstart",function(t){Ft(e,t)||We(t)}),Ql(l,"compositionstart",function(){var e=i.getCursor("from");n.composing&&n.composing.range.clear(),n.composing={start:e,range:i.markText(e,i.getCursor("to"),{className:"CodeMirror-composing"})}}),Ql(l,"compositionend",function(){n.composing&&(n.poll(),n.composing.range.clear(),n.composing=null)})},Qs.prototype.prepareSelection=function(){var e=this.cm,t=e.display,r=e.doc,n=Tr(e);if(e.options.moveInputWithCursor){var i=sr(e,r.sel.primary().head,"div"),o=t.wrapper.getBoundingClientRect(),l=t.lineDiv.getBoundingClientRect();n.teTop=Math.max(0,Math.min(t.wrapper.clientHeight-10,i.top+l.top-o.top)),n.teLeft=Math.max(0,Math.min(t.wrapper.clientWidth-10,i.left+l.left-o.left))}return n},Qs.prototype.showSelection=function(e){var t=this.cm.display;r(t.cursorDiv,e.cursors),r(t.selectionDiv,e.selection),null!=e.teTop&&(this.wrapper.style.top=e.teTop+"px",this.wrapper.style.left=e.teLeft+"px")},Qs.prototype.reset=function(e){if(!this.contextMenuPending&&!this.composing){var t=this.cm;if(t.somethingSelected()){this.prevInput="";var r=t.getSelection();this.textarea.value=r,t.state.focused&&El(this.textarea),gl&&vl>=9&&(this.hasSelection=r)}else e||(this.prevInput=this.textarea.value="",gl&&vl>=9&&(this.hasSelection=null))}},Qs.prototype.getField=function(){return this.textarea},Qs.prototype.supportsTouch=function(){return!1},Qs.prototype.focus=function(){if("nocursor"!=this.cm.options.readOnly&&(!Tl||l()!=this.textarea))try{this.textarea.focus()}catch(e){}},Qs.prototype.blur=function(){this.textarea.blur()},Qs.prototype.resetPosition=function(){this.wrapper.style.top=this.wrapper.style.left=0},Qs.prototype.receivedFocus=function(){this.slowPoll()},Qs.prototype.slowPoll=function(){var e=this;this.pollingFast||this.polling.set(this.cm.options.pollInterval,function(){e.poll(),e.cm.state.focused&&e.slowPoll()})},Qs.prototype.fastPoll=function(){function e(){r.poll()||t?(r.pollingFast=!1,r.slowPoll()):(t=!0,r.polling.set(60,e))}var t=!1,r=this;r.pollingFast=!0,r.polling.set(20,e)},Qs.prototype.poll=function(){var e=this,t=this.cm,r=this.textarea,n=this.prevInput;if(this.contextMenuPending||!t.state.focused||ts(r)&&!n&&!this.composing||t.isReadOnly()||t.options.disableInput||t.state.keySeq)return!1;var i=r.value;if(i==n&&!t.somethingSelected())return!1;if(gl&&vl>=9&&this.hasSelection===i||Ml&&/[\uf700-\uf7ff]/.test(i))return t.display.input.reset(),!1;if(t.doc.sel==t.display.selForContextMenu){var o=i.charCodeAt(0);if(8203!=o||n||(n="​"),8666==o)return this.reset(),this.cm.execCommand("undo")}for(var l=0,s=Math.min(n.length,i.length);l<s&&n.charCodeAt(l)==i.charCodeAt(l);)++l;return hn(t,function(){$o(t,i.slice(l),n.length-l,null,e.composing?"*compose":null),i.length>1e3||i.indexOf("\n")>-1?r.value=e.prevInput="":e.prevInput=i,e.composing&&(e.composing.range.clear(),e.composing.range=t.markText(e.composing.start,t.getCursor("to"),{className:"CodeMirror-composing"}))}),!0},Qs.prototype.ensurePolled=function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},Qs.prototype.onKeyPress=function(){gl&&vl>=9&&(this.hasSelection=null),this.fastPoll()},Qs.prototype.onContextMenu=function(e){function t(){if(null!=l.selectionStart){var e=i.somethingSelected(),t="​"+(e?l.value:"");l.value="⇚",l.value=t,n.prevInput=e?"":"​",l.selectionStart=1,l.selectionEnd=t.length,o.selForContextMenu=i.doc.sel}}function r(){if(n.contextMenuPending=!1,n.wrapper.style.cssText=c,l.style.cssText=u,gl&&vl<9&&o.scrollbars.setScrollTop(o.scroller.scrollTop=a),null!=l.selectionStart){(!gl||gl&&vl<9)&&t();var e=0,r=function(){o.selForContextMenu==i.doc.sel&&0==l.selectionStart&&l.selectionEnd>0&&"​"==n.prevInput?dn(i,Mi)(i):e++<10?o.detectingSelectAll=setTimeout(r,500):(o.selForContextMenu=null,o.input.reset())};o.detectingSelectAll=setTimeout(r,200)}}var n=this,i=n.cm,o=i.display,l=n.textarea,s=Sr(i,e),a=o.scroller.scrollTop;if(s&&!wl){i.options.resetSelectionOnContextMenu&&-1==i.doc.sel.contains(s)&&dn(i,bi)(i.doc,Rn(s),Gl);var u=l.style.cssText,c=n.wrapper.style.cssText;n.wrapper.style.cssText="position: absolute";var f=n.wrapper.getBoundingClientRect();l.style.cssText="position: absolute; width: 30px; height: 30px;\n      top: "+(e.clientY-f.top-5)+"px; left: "+(e.clientX-f.left-5)+"px;\n      z-index: 1000; background: "+(gl?"rgba(255, 255, 255, .05)":"transparent")+";\n      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);";var h;if(ml&&(h=window.scrollY),o.input.focus(),ml&&window.scrollTo(null,h),o.input.reset(),i.somethingSelected()||(l.value=n.prevInput=" "),n.contextMenuPending=!0,o.selForContextMenu=i.doc.sel,clearTimeout(o.detectingSelectAll),gl&&vl>=9&&t(),Hl){Fe(e);var d=function(){ke(window,"mouseup",d),setTimeout(r,20)};Ql(window,"mouseup",d)}else setTimeout(r,50)}},Qs.prototype.readOnlyChanged=function(e){e||this.reset(),this.textarea.disabled="nocursor"==e},Qs.prototype.setUneditable=function(){},Qs.prototype.needsContentAttribute=!1,function(e){function t(t,n,i,o){e.defaults[t]=n,i&&(r[t]=o?function(e,t,r){r!=Xs&&i(e,t,r)}:i)}var r=e.optionHandlers;e.defineOption=t,e.Init=Xs,t("value","",function(e,t){return e.setValue(t)},!0),t("mode",null,function(e,t){e.doc.modeOption=t,jn(e)},!0),t("indentUnit",2,jn,!0),t("indentWithTabs",!1),t("smartIndent",!0),t("tabSize",4,function(e){Xn(e),er(e),vn(e)},!0),t("lineSeparator",null,function(e,t){if(e.doc.lineSep=t,t){var r=[],n=e.doc.first;e.doc.iter(function(e){for(var i=0;;){var o=e.text.indexOf(t,i);if(-1==o)break;i=o+t.length,r.push(E(n,o))}n++});for(var i=r.length-1;i>=0;i--)Ei(e.doc,t,r[i],E(r[i].line,r[i].ch+t.length))}}),t("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b-\u200f\u2028\u2029\ufeff]/g,function(e,t,r){e.state.specialChars=new RegExp(t.source+(t.test("\t")?"":"|\t"),"g"),r!=Xs&&e.refresh()}),t("specialCharPlaceholder",at,function(e){return e.refresh()},!0),t("electricChars",!0),t("inputStyle",Tl?"contenteditable":"textarea",function(){throw new Error("inputStyle can not (yet) be changed in a running editor")},!0),t("spellcheck",!1,function(e,t){return e.getInputField().spellcheck=t},!0),t("rtlMoveVisually",!Ol),t("wholeLineUpdateBefore",!0),t("theme","default",function(e){Go(e),Uo(e)},!0),t("keyMap","default",function(e,t,r){var n=uo(t),i=r!=Xs&&uo(r);i&&i.detach&&i.detach(e,n),n.attach&&n.attach(e,i||null)}),t("extraKeys",null),t("configureMouse",null),t("lineWrapping",!1,Ko,!0),t("gutters",[],function(e){Fn(e.options),Uo(e)},!0),t("fixedGutter",!0,function(e,t){e.display.gutters.style.left=t?wr(e.display)+"px":"0",e.refresh()},!0),t("coverGutterNextToScrollbar",!1,function(e){return en(e)},!0),t("scrollbarStyle","native",function(e){rn(e),en(e),e.display.scrollbars.setScrollTop(e.doc.scrollTop),e.display.scrollbars.setScrollLeft(e.doc.scrollLeft)},!0),t("lineNumbers",!1,function(e){Fn(e.options),Uo(e)},!0),t("firstLineNumber",1,Uo,!0),t("lineNumberFormatter",function(e){return e},Uo,!0),t("showCursorWhenSelecting",!1,kr,!0),t("resetSelectionOnContextMenu",!0),t("lineWiseCopyCut",!0),t("pasteLinesPerSelection",!0),t("readOnly",!1,function(e,t){"nocursor"==t&&(Fr(e),e.display.input.blur()),e.display.input.readOnlyChanged(t)}),t("disableInput",!1,function(e,t){t||e.display.input.reset()},!0),t("dragDrop",!0,Vo),t("allowDropFileTypes",null),t("cursorBlinkRate",530),t("cursorScrollMargin",0),t("cursorHeight",1,kr,!0),t("singleCursorHeightPerLine",!0,kr,!0),t("workTime",100),t("workDelay",100),t("flattenSpans",!0,Xn,!0),t("addModeClass",!1,Xn,!0),t("pollInterval",100),t("undoDepth",200,function(e,t){return e.doc.history.undoDepth=t}),t("historyEventDelay",1250),t("viewportMargin",10,function(e){return e.refresh()},!0),t("maxHighlightLength",1e4,Xn,!0),t("moveInputWithCursor",!0,function(e,t){t||e.display.input.resetPosition()}),t("tabindex",null,function(e,t){return e.display.input.getField().tabIndex=t||""}),t("autofocus",null),t("direction","ltr",function(e,t){return e.doc.setDirection(t)},!0)}(jo),function(e){var t=e.optionHandlers,r=e.helpers={};e.prototype={constructor:e,focus:function(){window.focus(),this.display.input.focus()},setOption:function(e,r){var n=this.options,i=n[e];n[e]==r&&"mode"!=e||(n[e]=r,t.hasOwnProperty(e)&&dn(this,t[e])(this,r,i),Te(this,"optionChange",this,e))},getOption:function(e){return this.options[e]},getDoc:function(){return this.doc},addKeyMap:function(e,t){this.state.keyMaps[t?"push":"unshift"](uo(e))},removeKeyMap:function(e){for(var t=this.state.keyMaps,r=0;r<t.length;++r)if(t[r]==e||t[r].name==e)return t.splice(r,1),!0},addOverlay:pn(function(t,r){var n=t.token?t:e.getMode(this.options,t);if(n.startState)throw new Error("Overlays may not be stateful.");m(this.state.overlays,{mode:n,modeSpec:t,opaque:r&&r.opaque,priority:r&&r.priority||0},function(e){return e.priority}),this.state.modeGen++,vn(this)}),removeOverlay:pn(function(e){for(var t=this,r=this.state.overlays,n=0;n<r.length;++n){var i=r[n].modeSpec;if(i==e||"string"==typeof e&&i.name==e)return r.splice(n,1),t.state.modeGen++,void vn(t)}}),indentLine:pn(function(e,t,r){"string"!=typeof t&&"number"!=typeof t&&(t=null==t?this.options.smartIndent?"smart":"prev":t?"add":"subtract"),H(this.doc,e)&&Yo(this,e,t,r)}),indentSelection:pn(function(e){for(var t=this,r=this.doc.sel.ranges,n=-1,i=0;i<r.length;i++){var o=r[i];if(o.empty())o.head.line>n&&(Yo(t,o.head.line,e,!0),n=o.head.line,i==t.doc.sel.primIndex&&jr(t));else{var l=o.from(),s=o.to(),a=Math.max(n,l.line);n=Math.min(t.lastLine(),s.line-(s.ch?0:1))+1;for(var u=a;u<n;++u)Yo(t,u,e);var c=t.doc.sel.ranges;0==l.ch&&r.length==c.length&&c[i].from().ch>0&&gi(t.doc,i,new Ts(l,c[i].to()),Gl)}}}),getTokenAt:function(e,t){return Je(this,e,t)},getLineTokens:function(e,t){return Je(this,E(e),t,!0)},getTokenTypeAt:function(e){e=U(this.doc,e);var t,r=_e(this,M(this.doc,e.line)),n=0,i=(r.length-1)/2,o=e.ch;if(0==o)t=r[2];else for(;;){var l=n+i>>1;if((l?r[2*l-1]:0)>=o)i=l;else{if(!(r[2*l+1]<o)){t=r[2*l+2];break}n=l+1}}var s=t?t.indexOf("overlay "):-1;return s<0?t:0==s?null:t.slice(0,s-1)},getModeAt:function(t){var r=this.doc.mode;return r.innerMode?e.innerMode(r,this.getTokenAt(t).state).mode:r},getHelper:function(e,t){return this.getHelpers(e,t)[0]},getHelpers:function(e,t){var n=this,i=[];if(!r.hasOwnProperty(t))return i;var o=r[t],l=this.getModeAt(e);if("string"==typeof l[t])o[l[t]]&&i.push(o[l[t]]);else if(l[t])for(var s=0;s<l[t].length;s++){var a=o[l[t][s]];a&&i.push(a)}else l.helperType&&o[l.helperType]?i.push(o[l.helperType]):o[l.name]&&i.push(o[l.name]);for(var u=0;u<o._global.length;u++){var c=o._global[u];c.pred(l,n)&&-1==h(i,c.val)&&i.push(c.val)}return i},getStateAfter:function(e,t){var r=this.doc;return e=G(r,null==e?r.first+r.size-1:e),$e(this,e+1,t).state},cursorCoords:function(e,t){var r,n=this.doc.sel.primary();return r=null==e?n.head:"object"==typeof e?U(this.doc,e):e?n.from():n.to(),sr(this,r,t||"page")},charCoords:function(e,t){return lr(this,U(this.doc,e),t||"page")},coordsChar:function(e,t){return e=or(this,e,t||"page"),cr(this,e.left,e.top)},lineAtHeight:function(e,t){return e=or(this,{top:e,left:0},t||"page").top,D(this.doc,e+this.display.viewOffset)},heightAtLine:function(e,t,r){var n,i=!1;if("number"==typeof e){var o=this.doc.first+this.doc.size-1;e<this.doc.first?e=this.doc.first:e>o&&(e=o,i=!0),n=M(this.doc,e)}else n=e;return ir(this,n,{top:0,left:0},t||"page",r||i).top+(i?this.doc.height-ye(n):0)},defaultTextHeight:function(){return mr(this.display)},defaultCharWidth:function(){return yr(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(e,t,r,n,i){var o=this.display,l=(e=sr(this,U(this.doc,e))).bottom,s=e.left;if(t.style.position="absolute",t.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(t),o.sizer.appendChild(t),"over"==n)l=e.top;else if("above"==n||"near"==n){var a=Math.max(o.wrapper.clientHeight,this.doc.height),u=Math.max(o.sizer.clientWidth,o.lineSpace.clientWidth);("above"==n||e.bottom+t.offsetHeight>a)&&e.top>t.offsetHeight?l=e.top-t.offsetHeight:e.bottom+t.offsetHeight<=a&&(l=e.bottom),s+t.offsetWidth>u&&(s=u-t.offsetWidth)}t.style.top=l+"px",t.style.left=t.style.right="","right"==i?(s=o.sizer.clientWidth-t.offsetWidth,t.style.right="0px"):("left"==i?s=0:"middle"==i&&(s=(o.sizer.clientWidth-t.offsetWidth)/2),t.style.left=s+"px"),r&&Ur(this,{left:s,top:l,right:s+t.offsetWidth,bottom:l+t.offsetHeight})},triggerOnKeyDown:pn(Lo),triggerOnKeyPress:pn(Mo),triggerOnKeyUp:To,triggerOnMouseDown:pn(Oo),execCommand:function(e){if(Bs.hasOwnProperty(e))return Bs[e].call(null,this)},triggerElectric:pn(function(e){Zo(this,e)}),findPosH:function(e,t,r,n){var i=this,o=1;t<0&&(o=-1,t=-t);for(var l=U(this.doc,e),s=0;s<t&&!(l=tl(i.doc,l,o,r,n)).hitSide;++s);return l},moveH:pn(function(e,t){var r=this;this.extendSelectionsBy(function(n){return r.display.shift||r.doc.extend||n.empty()?tl(r.doc,n.head,e,t,r.options.rtlMoveVisually):e<0?n.from():n.to()},Vl)}),deleteH:pn(function(e,t){var r=this.doc.sel,n=this.doc;r.somethingSelected()?n.replaceSelection("",null,"+delete"):co(this,function(r){var i=tl(n,r.head,e,t,!1);return e<0?{from:i,to:r.head}:{from:r.head,to:i}})}),findPosV:function(e,t,r,n){var i=this,o=1,l=n;t<0&&(o=-1,t=-t);for(var s=U(this.doc,e),a=0;a<t;++a){var u=sr(i,s,"div");if(null==l?l=u.left:u.left=l,(s=rl(i,u,o,r)).hitSide)break}return s},moveV:pn(function(e,t){var r=this,n=this.doc,i=[],o=!this.display.shift&&!n.extend&&n.sel.somethingSelected();if(n.extendSelectionsBy(function(l){if(o)return e<0?l.from():l.to();var s=sr(r,l.head,"div");null!=l.goalColumn&&(s.left=l.goalColumn),i.push(s.left);var a=rl(r,s,e,t);return"page"==t&&l==n.sel.primary()&&Kr(r,lr(r,a,"div").top-s.top),a},Vl),i.length)for(var l=0;l<n.sel.ranges.length;l++)n.sel.ranges[l].goalColumn=i[l]}),findWordAt:function(e){var t=M(this.doc,e.line).text,r=e.ch,n=e.ch;if(t){var i=this.getHelper(e,"wordChars");"before"!=e.sticky&&n!=t.length||!r?++n:--r;for(var o=t.charAt(r),l=x(o,i)?function(e){return x(e,i)}:/\s/.test(o)?function(e){return/\s/.test(e)}:function(e){return!/\s/.test(e)&&!x(e)};r>0&&l(t.charAt(r-1));)--r;for(;n<t.length&&l(t.charAt(n));)++n}return new Ts(E(e.line,r),E(e.line,n))},toggleOverwrite:function(e){null!=e&&e==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?s(this.display.cursorDiv,"CodeMirror-overwrite"):Fl(this.display.cursorDiv,"CodeMirror-overwrite"),Te(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==l()},isReadOnly:function(){return!(!this.options.readOnly&&!this.doc.cantEdit)},scrollTo:pn(function(e,t){Xr(this,e,t)}),getScrollInfo:function(){var e=this.display.scroller;return{left:e.scrollLeft,top:e.scrollTop,height:e.scrollHeight-zt(this)-this.display.barHeight,width:e.scrollWidth-zt(this)-this.display.barWidth,clientHeight:Bt(this),clientWidth:Rt(this)}},scrollIntoView:pn(function(e,t){null==e?(e={from:this.doc.sel.primary().head,to:null},null==t&&(t=this.options.cursorScrollMargin)):"number"==typeof e?e={from:E(e,0),to:null}:null==e.from&&(e={from:e,to:null}),e.to||(e.to=e.from),e.margin=t||0,null!=e.from.line?Yr(this,e):$r(this,e.from,e.to,e.margin)}),setSize:pn(function(e,t){var r=this,n=function(e){return"number"==typeof e||/^\d+$/.test(String(e))?e+"px":e};null!=e&&(this.display.wrapper.style.width=n(e)),null!=t&&(this.display.wrapper.style.height=n(t)),this.options.lineWrapping&&Jt(this);var i=this.display.viewFrom;this.doc.iter(i,this.display.viewTo,function(e){if(e.widgets)for(var t=0;t<e.widgets.length;t++)if(e.widgets[t].noHScroll){mn(r,i,"widget");break}++i}),this.curOp.forceUpdate=!0,Te(this,"refresh",this)}),operation:function(e){return hn(this,e)},startOperation:function(){return nn(this)},endOperation:function(){return on(this)},refresh:pn(function(){var e=this.display.cachedTextHeight;vn(this),this.curOp.forceUpdate=!0,er(this),Xr(this,this.doc.scrollLeft,this.doc.scrollTop),Wn(this),(null==e||Math.abs(e-mr(this.display))>.5)&&Cr(this),Te(this,"refresh",this)}),swapDoc:pn(function(e){var t=this.doc;return t.cm=null,qn(this,e),er(this),this.display.input.reset(),Xr(this,e.scrollLeft,e.scrollTop),this.curOp.forceScroll=!0,bt(this,"swapDoc",this,t),t}),getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},Ae(e),e.registerHelper=function(t,n,i){r.hasOwnProperty(t)||(r[t]=e[t]={_global:[]}),r[t][n]=i},e.registerGlobalHelper=function(t,n,i,o){e.registerHelper(t,n,o),r[t]._global.push({pred:i,val:o})}}(jo);var Js="iter insert remove copy getEditor constructor".split(" ");for(var ea in Ds.prototype)Ds.prototype.hasOwnProperty(ea)&&h(Js,ea)<0&&(jo.prototype[ea]=function(e){return function(){return e.apply(this.doc,arguments)}}(Ds.prototype[ea]));return Ae(Ds),jo.inputStyles={textarea:Qs,contenteditable:Zs},jo.defineMode=function(e){jo.defaults.mode||"null"==e||(jo.defaults.mode=e),Be.apply(this,arguments)},jo.defineMIME=function(e,t){os[e]=t},jo.defineMode("null",function(){return{token:function(e){return e.skipToEnd()}}}),jo.defineMIME("text/plain","null"),jo.defineExtension=function(e,t){jo.prototype[e]=t},jo.defineDocExtension=function(e,t){Ds.prototype[e]=t},jo.fromTextArea=function(e,t){function r(){e.value=a.getValue()}if(t=t?c(t):{},t.value=e.value,!t.tabindex&&e.tabIndex&&(t.tabindex=e.tabIndex),!t.placeholder&&e.placeholder&&(t.placeholder=e.placeholder),null==t.autofocus){var n=l();t.autofocus=n==e||null!=e.getAttribute("autofocus")&&n==document.body}var i;if(e.form&&(Ql(e.form,"submit",r),!t.leaveSubmitMethodAlone)){var o=e.form;i=o.submit;try{var s=o.submit=function(){r(),o.submit=i,o.submit(),o.submit=s}}catch(e){}}t.finishInit=function(t){t.save=r,t.getTextArea=function(){return e},t.toTextArea=function(){t.toTextArea=isNaN,r(),e.parentNode.removeChild(t.getWrapperElement()),e.style.display="",e.form&&(ke(e.form,"submit",r),"function"==typeof e.form.submit&&(e.form.submit=i))}},e.style.display="none";var a=jo(function(t){return e.parentNode.insertBefore(t,e.nextSibling)},t);return a},function(e){e.off=ke,e.on=Ql,e.wheelEventPixels=Pn,e.Doc=Ds,e.splitLines=es,e.countColumn=f,e.findColumn=d,e.isWordChar=w,e.Pass=Bl,e.signal=Te,e.Line=fs,e.changeEnd=Bn,e.scrollbarModel=ws,e.Pos=E,e.cmpPos=P,e.modes=is,e.mimeModes=os,e.resolveMode=Ge,e.getMode=Ue,e.modeExtensions=ls,e.extendMode=Ve,e.copyState=Ke,e.startState=Xe,e.innerMode=je,e.commands=Bs,e.keyMap=Rs,e.keyName=ao,e.isModifierKey=lo,e.lookupKey=oo,e.normalizeKeyMap=io,e.StringStream=ss,e.SharedTextMarker=As,e.TextMarker=Os,e.LineWidget=Ms,e.e_preventDefault=We,e.e_stopPropagation=De,e.e_stop=Fe,e.addClass=s,e.contains=o,e.rmClass=Fl,e.keyNames=Es}(jo),jo.version="5.30.0",jo});
      !function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){"use strict";function t(e,t,n,r,o,a){this.indented=e,this.column=t,this.type=n,this.info=r,this.align=o,this.prev=a}function n(e,n,r,o){var a=e.indented;return e.context&&"statement"==e.context.type&&"statement"!=r&&(a=e.context.indented),e.context=new t(a,n,r,o,null,e.context)}function r(e){var t=e.context.type;return")"!=t&&"]"!=t&&"}"!=t||(e.indented=e.context.indented),e.context=e.context.prev}function o(e,t,n){return"variable"==t.prevToken||"type"==t.prevToken||(!!/\S(?:[^- ]>|[*\]])\s*$|\*$/.test(e.string.slice(0,n))||(!(!t.typeAtEndOfLine||e.column()!=e.indentation())||void 0))}function a(e){for(;;){if(!e||"top"==e.type)return!0;if("}"==e.type&&"namespace"!=e.prev.info)return!1;e=e.prev}}function i(e){for(var t={},n=e.split(" "),r=0;r<n.length;++r)t[n[r]]=!0;return t}function l(e,t){return"function"==typeof e?e(t):e.propertyIsEnumerable(t)}function s(e,t){if(!t.startOfLine)return!1;for(var n,r=null;n=e.peek();){if("\\"==n&&e.match(/^.$/)){r=s;break}if("/"==n&&e.match(/^\/[\/\*]/,!1))break;e.next()}return t.tokenize=r,"meta"}function c(e,t){return"type"==t.prevToken&&"type"}function u(e){return e.eatWhile(/[\w\.']/),"number"}function d(e,t){if(e.backUp(1),e.match(/(R|u8R|uR|UR|LR)/)){var n=e.match(/"([^\s\\()]{0,16})\(/);return!!n&&(t.cpp11RawStringDelim=n[1],t.tokenize=m,m(e,t))}return e.match(/(u8|u|U|L)/)?!!e.match(/["']/,!1)&&"string":(e.next(),!1)}function f(e){var t=/(\w+)::~?(\w+)$/.exec(e);return t&&t[1]==t[2]}function p(e,t){for(var n;null!=(n=e.next());)if('"'==n&&!e.eat('"')){t.tokenize=null;break}return"string"}function m(e,t){var n=t.cpp11RawStringDelim.replace(/[^\w\s]/g,"\\$&");return e.match(new RegExp(".*?\\)"+n+'"'))?t.tokenize=null:e.skipToEnd(),"string"}function h(t,n){function r(e){if(e)for(var t in e)e.hasOwnProperty(t)&&o.push(t)}"string"==typeof t&&(t=[t]);var o=[];r(n.keywords),r(n.types),r(n.builtin),r(n.atoms),o.length&&(n.helperType=t[0],e.registerHelper("hintWords",t[0],o));for(var a=0;a<t.length;++a)e.defineMIME(t[a],n)}function g(e,t){for(var n=!1;!e.eol();){if(!n&&e.match('"""')){t.tokenize=null;break}n="\\"==e.next()&&!n}return"string"}function y(e){return function(t,n){for(var r,o=!1,a=!1;!t.eol();){if(!e&&!o&&t.match('"')){a=!0;break}if(e&&t.match('"""')){a=!0;break}r=t.next(),!o&&"$"==r&&t.match("{")&&t.skipTo("}"),o=!o&&"\\"==r&&!e}return!a&&e||(n.tokenize=null),"string"}}function x(e){return function(t,n){for(var r,o=!1,a=!1;!t.eol();){if(!o&&t.match('"')&&("single"==e||t.match('""'))){a=!0;break}if(!o&&t.match("``")){w=x(e),a=!0;break}r=t.next(),o="single"==e&&!o&&"\\"==r}return a&&(n.tokenize=null),"string"}}e.defineMode("clike",function(i,s){function c(e,t){var n=e.next();if(S[n]){var r=S[n](e,t);if(!1!==r)return r}if('"'==n||"'"==n)return t.tokenize=u(n),t.tokenize(e,t);if(D.test(n))return p=n,null;if(L.test(n)){if(e.backUp(1),e.match(I))return"number";e.next()}if("/"==n){if(e.eat("*"))return t.tokenize=d,d(e,t);if(e.eat("/"))return e.skipToEnd(),"comment"}if(F.test(n)){for(;!e.match(/^\/[\/*]/,!1)&&e.eat(F););return"operator"}if(e.eatWhile(z),P)for(;e.match(P);)e.eatWhile(z);var o=e.current();return l(x,o)?(l(w,o)&&(p="newstatement"),l(v,o)&&(m=!0),"keyword"):l(b,o)?"type":l(k,o)?(l(w,o)&&(p="newstatement"),"builtin"):l(_,o)?"atom":"variable"}function u(e){return function(t,n){for(var r,o=!1,a=!1;null!=(r=t.next());){if(r==e&&!o){a=!0;break}o=!o&&"\\"==r}return(a||!o&&!C)&&(n.tokenize=null),"string"}}function d(e,t){for(var n,r=!1;n=e.next();){if("/"==n&&r){t.tokenize=null;break}r="*"==n}return"comment"}function f(e,t){s.typeFirstDefinitions&&e.eol()&&a(t.context)&&(t.typeAtEndOfLine=o(e,t,e.pos))}var p,m,h=i.indentUnit,g=s.statementIndentUnit||h,y=s.dontAlignCalls,x=s.keywords||{},b=s.types||{},k=s.builtin||{},w=s.blockKeywords||{},v=s.defKeywords||{},_=s.atoms||{},S=s.hooks||{},C=s.multiLineStrings,T=!1!==s.indentStatements,M=!1!==s.indentSwitch,P=s.namespaceSeparator,D=s.isPunctuationChar||/[\[\]{}\(\),;\:\.]/,L=s.numberStart||/[\d\.]/,I=s.number||/^(?:0x[a-f\d]+|0b[01]+|(?:\d+\.?\d*|\.\d+)(?:e[-+]?\d+)?)(u|ll?|l|f)?/i,F=s.isOperatorChar||/[+\-*&%=<>!?|\/]/,z=s.isIdentifierChar||/[\w\$_\xa1-\uffff]/;return{startState:function(e){return{tokenize:null,context:new t((e||0)-h,0,"top",null,!1),indented:0,startOfLine:!0,prevToken:null}},token:function(e,t){var i=t.context;if(e.sol()&&(null==i.align&&(i.align=!1),t.indented=e.indentation(),t.startOfLine=!0),e.eatSpace())return f(e,t),null;p=m=null;var l=(t.tokenize||c)(e,t);if("comment"==l||"meta"==l)return l;if(null==i.align&&(i.align=!0),";"==p||":"==p||","==p&&e.match(/^\s*(?:\/\/.*)?$/,!1))for(;"statement"==t.context.type;)r(t);else if("{"==p)n(t,e.column(),"}");else if("["==p)n(t,e.column(),"]");else if("("==p)n(t,e.column(),")");else if("}"==p){for(;"statement"==i.type;)i=r(t);for("}"==i.type&&(i=r(t));"statement"==i.type;)i=r(t)}else p==i.type?r(t):T&&(("}"==i.type||"top"==i.type)&&";"!=p||"statement"==i.type&&"newstatement"==p)&&n(t,e.column(),"statement",e.current());if("variable"==l&&("def"==t.prevToken||s.typeFirstDefinitions&&o(e,t,e.start)&&a(t.context)&&e.match(/^\s*\(/,!1))&&(l="def"),S.token){var u=S.token(e,t,l);void 0!==u&&(l=u)}return"def"==l&&!1===s.styleDefs&&(l="variable"),t.startOfLine=!1,t.prevToken=m?"def":l||p,f(e,t),l},indent:function(t,n){if(t.tokenize!=c&&null!=t.tokenize||t.typeAtEndOfLine)return e.Pass;var r=t.context,o=n&&n.charAt(0);if("statement"==r.type&&"}"==o&&(r=r.prev),s.dontIndentStatements)for(;"statement"==r.type&&s.dontIndentStatements.test(r.info);)r=r.prev;if(S.indent){var a=S.indent(t,r,n);if("number"==typeof a)return a}var i=o==r.type,l=r.prev&&"switch"==r.prev.info;if(s.allmanIndentation&&/[{(]/.test(o)){for(;"top"!=r.type&&"}"!=r.type;)r=r.prev;return r.indented}return"statement"==r.type?r.indented+("{"==o?0:g):!r.align||y&&")"==r.type?")"!=r.type||i?r.indented+(i?0:h)+(i||!l||/^(?:case|default)\b/.test(n)?0:h):r.indented+g:r.column+(i?0:1)},electricInput:M?/^\s*(?:case .*?:|default:|\{\}?|\})$/:/^\s*[{}]$/,blockCommentStart:"/*",blockCommentEnd:"*/",lineComment:"//",fold:"brace"}});var b="auto if break case register continue return default do sizeof static else struct switch extern typedef union for goto while enum const volatile",k="int long char short double float unsigned signed void size_t ptrdiff_t";h(["text/x-csrc","text/x-c","text/x-chdr"],{name:"clike",keywords:i(b),types:i(k+" bool _Complex _Bool float_t double_t intptr_t intmax_t int8_t int16_t int32_t int64_t uintptr_t uintmax_t uint8_t uint16_t uint32_t uint64_t"),blockKeywords:i("case do else for if switch while struct"),defKeywords:i("struct"),typeFirstDefinitions:!0,atoms:i("null true false"),hooks:{"#":s,"*":c},modeProps:{fold:["brace","include"]}}),h(["text/x-c++src","text/x-c++hdr"],{name:"clike",keywords:i(b+" asm dynamic_cast namespace reinterpret_cast try explicit new static_cast typeid catch operator template typename class friend private this using const_cast inline public throw virtual delete mutable protected alignas alignof constexpr decltype nullptr noexcept thread_local final static_assert override"),types:i(k+" bool wchar_t"),blockKeywords:i("catch class do else finally for if struct switch try while"),defKeywords:i("class namespace struct enum union"),typeFirstDefinitions:!0,atoms:i("true false null"),dontIndentStatements:/^template$/,isIdentifierChar:/[\w\$_~\xa1-\uffff]/,hooks:{"#":s,"*":c,u:d,U:d,L:d,R:d,0:u,1:u,2:u,3:u,4:u,5:u,6:u,7:u,8:u,9:u,token:function(e,t,n){if("variable"==n&&"("==e.peek()&&(";"==t.prevToken||null==t.prevToken||"}"==t.prevToken)&&f(e.current()))return"def"}},namespaceSeparator:"::",modeProps:{fold:["brace","include"]}}),h("text/x-java",{name:"clike",keywords:i("abstract assert break case catch class const continue default do else enum extends final finally float for goto if implements import instanceof interface native new package private protected public return static strictfp super switch synchronized this throw throws transient try volatile while @interface"),types:i("byte short int long float double boolean char void Boolean Byte Character Double Float Integer Long Number Object Short String StringBuffer StringBuilder Void"),blockKeywords:i("catch class do else finally for if switch try while"),defKeywords:i("class interface package enum @interface"),typeFirstDefinitions:!0,atoms:i("true false null"),number:/^(?:0x[a-f\d_]+|0b[01_]+|(?:[\d_]+\.?\d*|\.\d+)(?:e[-+]?[\d_]+)?)(u|ll?|l|f)?/i,hooks:{"@":function(e){return!e.match("interface",!1)&&(e.eatWhile(/[\w\$_]/),"meta")}},modeProps:{fold:["brace","import"]}}),h("text/x-csharp",{name:"clike",keywords:i("abstract as async await base break case catch checked class const continue default delegate do else enum event explicit extern finally fixed for foreach goto if implicit in interface internal is lock namespace new operator out override params private protected public readonly ref return sealed sizeof stackalloc static struct switch this throw try typeof unchecked unsafe using virtual void volatile while add alias ascending descending dynamic from get global group into join let orderby partial remove select set value var yield"),types:i("Action Boolean Byte Char DateTime DateTimeOffset Decimal Double Func Guid Int16 Int32 Int64 Object SByte Single String Task TimeSpan UInt16 UInt32 UInt64 bool byte char decimal double short int long object sbyte float string ushort uint ulong"),blockKeywords:i("catch class do else finally for foreach if struct switch try while"),defKeywords:i("class interface namespace struct var"),typeFirstDefinitions:!0,atoms:i("true false null"),hooks:{"@":function(e,t){return e.eat('"')?(t.tokenize=p,p(e,t)):(e.eatWhile(/[\w\$_]/),"meta")}}}),h("text/x-scala",{name:"clike",keywords:i("abstract case catch class def do else extends final finally for forSome if implicit import lazy match new null object override package private protected return sealed super this throw trait try type val var while with yield _ assert assume require print println printf readLine readBoolean readByte readShort readChar readInt readLong readFloat readDouble"),types:i("AnyVal App Application Array BufferedIterator BigDecimal BigInt Char Console Either Enumeration Equiv Error Exception Fractional Function IndexedSeq Int Integral Iterable Iterator List Map Numeric Nil NotNull Option Ordered Ordering PartialFunction PartialOrdering Product Proxy Range Responder Seq Serializable Set Specializable Stream StringBuilder StringContext Symbol Throwable Traversable TraversableOnce Tuple Unit Vector Boolean Byte Character CharSequence Class ClassLoader Cloneable Comparable Compiler Double Exception Float Integer Long Math Number Object Package Pair Process Runtime Runnable SecurityManager Short StackTraceElement StrictMath String StringBuffer System Thread ThreadGroup ThreadLocal Throwable Triple Void"),multiLineStrings:!0,blockKeywords:i("catch class enum do else finally for forSome if match switch try while"),defKeywords:i("class enum def object package trait type val var"),atoms:i("true false null"),indentStatements:!1,indentSwitch:!1,isOperatorChar:/[+\-*&%=<>!?|\/#:@]/,hooks:{"@":function(e){return e.eatWhile(/[\w\$_]/),"meta"},'"':function(e,t){return!!e.match('""')&&(t.tokenize=g,t.tokenize(e,t))},"'":function(e){return e.eatWhile(/[\w\$_\xa1-\uffff]/),"atom"},"=":function(e,n){var r=n.context;return!("}"!=r.type||!r.align||!e.eat(">"))&&(n.context=new t(r.indented,r.column,r.type,r.info,null,r.prev),"operator")}},modeProps:{closeBrackets:{triples:'"'}}}),h("text/x-kotlin",{name:"clike",keywords:i("package as typealias class interface this super val var fun for is in This throw return break continue object if else while do try when !in !is as? file import where by get set abstract enum open inner override private public internal protected catch finally out final vararg reified dynamic companion constructor init sealed field property receiver param sparam lateinit data inline noinline tailrec external annotation crossinline const operator infix suspend"),types:i("Boolean Byte Character CharSequence Class ClassLoader Cloneable Comparable Compiler Double Exception Float Integer Long Math Number Object Package Pair Process Runtime Runnable SecurityManager Short StackTraceElement StrictMath String StringBuffer System Thread ThreadGroup ThreadLocal Throwable Triple Void"),intendSwitch:!1,indentStatements:!1,multiLineStrings:!0,number:/^(?:0x[a-f\d_]+|0b[01_]+|(?:[\d_]+\.?\d*|\.\d+)(?:e[-+]?[\d_]+)?)(u|ll?|l|f)?/i,blockKeywords:i("catch class do else finally for if where try while enum"),defKeywords:i("class val var object package interface fun"),atoms:i("true false null this"),hooks:{'"':function(e,t){return t.tokenize=y(e.match('""')),t.tokenize(e,t)}},modeProps:{closeBrackets:{triples:'"'}}}),h(["x-shader/x-vertex","x-shader/x-fragment"],{name:"clike",keywords:i("sampler1D sampler2D sampler3D samplerCube sampler1DShadow sampler2DShadow const attribute uniform varying break continue discard return for while do if else struct in out inout"),types:i("float int bool void vec2 vec3 vec4 ivec2 ivec3 ivec4 bvec2 bvec3 bvec4 mat2 mat3 mat4"),blockKeywords:i("for while do if else struct"),builtin:i("radians degrees sin cos tan asin acos atan pow exp log exp2 sqrt inversesqrt abs sign floor ceil fract mod min max clamp mix step smoothstep length distance dot cross normalize ftransform faceforward reflect refract matrixCompMult lessThan lessThanEqual greaterThan greaterThanEqual equal notEqual any all not texture1D texture1DProj texture1DLod texture1DProjLod texture2D texture2DProj texture2DLod texture2DProjLod texture3D texture3DProj texture3DLod texture3DProjLod textureCube textureCubeLod shadow1D shadow2D shadow1DProj shadow2DProj shadow1DLod shadow2DLod shadow1DProjLod shadow2DProjLod dFdx dFdy fwidth noise1 noise2 noise3 noise4"),atoms:i("true false gl_FragColor gl_SecondaryColor gl_Normal gl_Vertex gl_MultiTexCoord0 gl_MultiTexCoord1 gl_MultiTexCoord2 gl_MultiTexCoord3 gl_MultiTexCoord4 gl_MultiTexCoord5 gl_MultiTexCoord6 gl_MultiTexCoord7 gl_FogCoord gl_PointCoord gl_Position gl_PointSize gl_ClipVertex gl_FrontColor gl_BackColor gl_FrontSecondaryColor gl_BackSecondaryColor gl_TexCoord gl_FogFragCoord gl_FragCoord gl_FrontFacing gl_FragData gl_FragDepth gl_ModelViewMatrix gl_ProjectionMatrix gl_ModelViewProjectionMatrix gl_TextureMatrix gl_NormalMatrix gl_ModelViewMatrixInverse gl_ProjectionMatrixInverse gl_ModelViewProjectionMatrixInverse gl_TexureMatrixTranspose gl_ModelViewMatrixInverseTranspose gl_ProjectionMatrixInverseTranspose gl_ModelViewProjectionMatrixInverseTranspose gl_TextureMatrixInverseTranspose gl_NormalScale gl_DepthRange gl_ClipPlane gl_Point gl_FrontMaterial gl_BackMaterial gl_LightSource gl_LightModel gl_FrontLightModelProduct gl_BackLightModelProduct gl_TextureColor gl_EyePlaneS gl_EyePlaneT gl_EyePlaneR gl_EyePlaneQ gl_FogParameters gl_MaxLights gl_MaxClipPlanes gl_MaxTextureUnits gl_MaxTextureCoords gl_MaxVertexAttribs gl_MaxVertexUniformComponents gl_MaxVaryingFloats gl_MaxVertexTextureImageUnits gl_MaxTextureImageUnits gl_MaxFragmentUniformComponents gl_MaxCombineTextureImageUnits gl_MaxDrawBuffers"),indentSwitch:!1,hooks:{"#":s},modeProps:{fold:["brace","include"]}}),h("text/x-nesc",{name:"clike",keywords:i(b+"as atomic async call command component components configuration event generic implementation includes interface module new norace nx_struct nx_union post provides signal task uses abstract extends"),types:i(k),blockKeywords:i("case do else for if switch while struct"),atoms:i("null true false"),hooks:{"#":s},modeProps:{fold:["brace","include"]}}),h("text/x-objectivec",{name:"clike",keywords:i(b+"inline restrict _Bool _Complex _Imaginary BOOL Class bycopy byref id IMP in inout nil oneway out Protocol SEL self super atomic nonatomic retain copy readwrite readonly"),types:i(k),atoms:i("YES NO NULL NILL ON OFF true false"),hooks:{"@":function(e){return e.eatWhile(/[\w\$]/),"keyword"},"#":s,indent:function(e,t,n){if("statement"==t.type&&/^@\w/.test(n))return t.indented}},modeProps:{fold:"brace"}}),h("text/x-squirrel",{name:"clike",keywords:i("base break clone continue const default delete enum extends function in class foreach local resume return this throw typeof yield constructor instanceof static"),types:i(k),blockKeywords:i("case catch class else for foreach if switch try while"),defKeywords:i("function local class"),typeFirstDefinitions:!0,atoms:i("true false null"),hooks:{"#":s},modeProps:{fold:["brace","include"]}});var w=null;h("text/x-ceylon",{name:"clike",keywords:i("abstracts alias assembly assert assign break case catch class continue dynamic else exists extends finally for function given if import in interface is let module new nonempty object of out outer package return satisfies super switch then this throw try value void while"),types:function(e){var t=e.charAt(0);return t===t.toUpperCase()&&t!==t.toLowerCase()},blockKeywords:i("case catch class dynamic else finally for function if interface module new object switch try while"),defKeywords:i("class dynamic function interface module object package value"),builtin:i("abstract actual aliased annotation by default deprecated doc final formal late license native optional sealed see serializable shared suppressWarnings tagged throws variable"),isPunctuationChar:/[\[\]{}\(\),;\:\.`]/,isOperatorChar:/[+\-*&%=<>!?|^~:\/]/,numberStart:/[\d#$]/,number:/^(?:#[\da-fA-F_]+|\$[01_]+|[\d_]+[kMGTPmunpf]?|[\d_]+\.[\d_]+(?:[eE][-+]?\d+|[kMGTPmunpf]|)|)/i,multiLineStrings:!0,typeFirstDefinitions:!0,atoms:i("true false null larger smaller equal empty finished"),indentSwitch:!1,styleDefs:!1,hooks:{"@":function(e){return e.eatWhile(/[\w\$_]/),"meta"},'"':function(e,t){return t.tokenize=x(e.match('""')?"triple":"single"),t.tokenize(e,t)},"`":function(e,t){return!(!w||!e.match("`"))&&(t.tokenize=w,w=null,t.tokenize(e,t))},"'":function(e){return e.eatWhile(/[\w\$_\xa1-\uffff]/),"atom"},token:function(e,t,n){if(("variable"==n||"type"==n)&&"."==t.prevToken)return"variable-2"}},modeProps:{fold:["brace","import"],closeBrackets:{triples:'"'}}})});
      // -------------------------------------------------------------------------
//  Part of the CodeChecker project, under the Apache License v2.0 with
//  LLVM Exceptions. See LICENSE for license information.
//  SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
// -------------------------------------------------------------------------

var BugViewer = {
  _files : [],
  _reports : [],
  _lineWidgets : [],
  _navigationMenuItems : [],
  _sourceFileData : null,
  _currentReport : null,
  _lastBugEvent  : null,

  init : function (files, reports) {
    this._files = files;
    this._reports = reports;

    this.initEscapeChars();
  },

  initEscapeChars : function () {
    this.escapeChars = {
      ' ' : 'nbsp',
      '<' : 'lt',
      '>' : 'gt',
      '"' : 'quot',
      '&' : 'amp'
    };

    var regexString = '[';
    for (var key in this.escapeChars) {
      regexString += key;
    }
    regexString += ']';

    this.escapeRegExp = new RegExp( regexString, 'g');
  },

  escapeHTML : function (str) {
    var that = this;

    return str.replace(this.escapeRegExp, function (m) {
      return '&' + that.escapeChars[m] + ';';
    });
  },

  initByUrl : function () {
    if (!this._reports) return;

    var state = {};
    window.location.hash.substr(1).split('&').forEach(function (s) {
      var parts = s.split('=');
      state[parts[0]] = parts[1];
    });

    for (var key in this._reports) {
      var report = this._reports[key];
      if (report.reportHash === state['reportHash']) {
        this.navigate(report);
        return;
      }
    }

    this.navigate(this._reports[0]);
  },

  create : function () {
    this._content = document.getElementById('editor-wrapper');
    this._filepath = document.getElementById('file-path');
    this._checkerName = document.getElementById('checker-name');
    this._reviewStatusWrapper =
      document.getElementById('review-status-wrapper');
    this._reviewStatus = document.getElementById('review-status');
    this._editor = document.getElementById('editor');

    this._codeMirror = CodeMirror(this._editor, {
      mode: 'text/x-c++src',
      matchBrackets : true,
      lineNumbers : true,
      readOnly : true,
      foldGutter : true,
      extraKeys : {},
      viewportMargin : 100
    });

    this._createNavigationMenu();
  },

  navigate : function (report, item) {
    if (!item) {
      var items = this._navigationMenuItems.filter(function (navItem) {
        return navItem.report.reportHash === report.reportHash;
      });

      if (!items.length) return;

      item = items[0].widget;
    }

    this._selectedReport.classList.remove('active');
    this._selectedReport = item;
    this._selectedReport.classList.add('active');
    this.setReport(report);
  },

  _createNavigationMenu : function () {
    var that = this;

    var nav = document.getElementById('report-nav');
    var list = document.createElement('ul');
    this._reports.forEach(function (report) {
      var events = report['events'];
      var lastBugEvent = events[events.length - 1];
      var item = document.createElement('li');

      var severity = document.createElement('i');
      severity.className = 'severity-' + report.severity.toLowerCase();

      item.appendChild(severity);
      item.appendChild(document.createTextNode(lastBugEvent.message));

      item.addEventListener('click', function () {
        that.navigate(report, item);
      })
      list.appendChild(item);
      that._navigationMenuItems.push({ report : report, widget : item });
    });

    if (!this._selectedReport && list.childNodes.length) {
      this._selectedReport = list.childNodes[0];
      this._selectedReport.classList.add('active');
    }

    nav.appendChild(list);
  },

  setReport : function (report) {
    this._currentReport = report;
    var events = report['events'];
    var lastBugEvent = events[events.length - 1];
    this.setCurrentBugEvent(lastBugEvent, events.length - 1);
    this.setCheckerName(report.checkerName);
    this.setReviewStatus(report.reviewStatus);

    window.location.hash = '#reportHash=' + report.reportHash;
  },

  setCurrentBugEvent : function (event, idx) {
    this._currentBugEvent = event;
    this.setSourceFileData(this._files[event.location.file]);
    this.drawBugPath();

    this.jumpTo(event.location.line, 0);
    this.highlightBugEvent(event, idx);
  },

  highlightBugEvent : function (event, idx) {
    this._lineWidgets.forEach(function (widget) {
      var lineIdx = widget.node.getAttribute('idx');
      if (parseInt(lineIdx) === idx) {
        widget.node.classList.add('current');
      }
    });
  },

  setCheckerName : function (checkerName) {
    this._checkerName.innerHTML = checkerName;
  },

  setReviewStatus : function (status) {
    if (status) {
      var className =
        'review-status-' + status.toLowerCase().split(' ').join('-');
      this._reviewStatus.className = "review-status " + className;

      this._reviewStatus.innerHTML = status;
      this._reviewStatusWrapper.style.display = 'block';
    } else {
      this._reviewStatusWrapper.style.display = 'none';
    }
  },

  setSourceFileData : function (file) {
    if (this._sourceFileData && file.id === this._sourceFileData.id) {
      return;
    }

    this._sourceFileData = file;
    this._filepath.innerHTML = file.path;
    this._codeMirror.doc.setValue(file.content);
    this._refresh();
  },

  _refresh : function () {
    var that = this;
    setTimeout(function () {
      var fullHeight = parseInt(that._content.clientHeight);
      var headerHeight = that._filepath.clientHeight;

      that._codeMirror.setSize('auto', fullHeight - headerHeight);
      that._codeMirror.refresh();
    }, 200);
  },

  clearBubbles : function () {
    this._lineWidgets.forEach(function (widget) { widget.clear(); });
    this._lineWidgets = [];
  },

  getMessage : function (event, kind) {
    if (kind === 'macro') {
      var name = 'macro expansion' + (event.name ? ': ' + event.name : '');

      return '<span class="tag macro">' + name + '</span>'
        + this.escapeHTML(event.expansion).replace(/(?:\r\n|\r|\n)/g, '<br>');
    } else if (kind === 'note') {
      return '<span class="tag note">note</span>'
        +  this.escapeHTML(event.message).replace(/(?:\r\n|\r|\n)/g, '<br>');
    }
  },

  addExtraPathEvents : function (events, kind) {
    var that = this;

    if (!events) {
      return;
    }

    events.forEach(function (event) {
      if (event.location.file !== that._currentBugEvent.location.file) {
        return;
      }

      var left =
        that._codeMirror.defaultCharWidth() * event.location.col + 'px';

      var element = document.createElement('div');
      element.setAttribute('style', 'margin-left: ' + left);
      element.setAttribute('class', 'check-msg ' + kind);

      var msg = document.createElement('span');
      msg.innerHTML = that.getMessage(event, kind);
      element.appendChild(msg);

      that._lineWidgets.push(that._codeMirror.addLineWidget(
        event.location.line - 1, element));
    });
  },

  drawBugPath : function () {
    var that = this;

    this.clearBubbles();

    this.addExtraPathEvents(this._currentReport.macros, 'macro');
    this.addExtraPathEvents(this._currentReport.notes, 'note');

    // Processing bug path events.
    var currentEvents = this._currentReport.events;
    currentEvents.forEach(function (event, step) {
      if (event.location.file !== that._currentBugEvent.location.file)
        return;

      var left =
        that._codeMirror.defaultCharWidth() * event.location.col + 'px';
      var type = step === currentEvents.length - 1 ? 'error' : 'info';

      var element = document.createElement('div');
      element.setAttribute('style', 'margin-left: ' + left);
      element.setAttribute('class', 'check-msg ' + type);
      element.setAttribute('idx', step);

      var enumeration = document.createElement('span');
      enumeration.setAttribute('class', 'checker-enum ' + type);
      enumeration.innerHTML = step + 1;

      if (currentEvents.length > 1)
        element.appendChild(enumeration);

      var prevBugEvent = step - 1;
      if (step > 0) {
        var prevBug = document.createElement('span');
        prevBug.setAttribute('class', 'arrow left-arrow');
        prevBug.addEventListener('click', function () {
          var event = currentEvents[prevBugEvent];
          that.setCurrentBugEvent(event, prevBugEvent);
        });
        element.appendChild(prevBug);
      }

      var msg = document.createElement('span');
      msg.innerHTML = that.escapeHTML(event.message)
        .replace(/(?:\r\n|\r|\n)/g, '<br>');

      element.appendChild(msg);

      var nextBugEvent = step + 1;
      if (nextBugEvent < currentEvents.length) {
        var nextBug = document.createElement('span');
        nextBug.setAttribute('class', 'arrow right-arrow');
        nextBug.addEventListener('click', function () {
          var event = currentEvents[nextBugEvent];
          that.setCurrentBugEvent(event, nextBugEvent);
        });
        element.appendChild(nextBug);
      }


      that._lineWidgets.push(that._codeMirror.addLineWidget(
        event.location.line - 1, element));
    });
  },

  jumpTo : function (line, column) {
    var that = this;

    setTimeout(function () {
      var selPosPixel
        = that._codeMirror.charCoords({ line : line, ch : column }, 'local');
      var editorSize = {
        width  : that._editor.clientWidth,
        height : that._editor.clientHeight
      };

      that._codeMirror.scrollIntoView({
        top    : selPosPixel.top - 100,
        bottom : selPosPixel.top + editorSize.height - 150,
        left   : selPosPixel.left < editorSize.width - 100
               ? 0
               : selPosPixel.left - 50,
        right  : selPosPixel.left < editorSize.width - 100
               ? 10
               : selPosPixel.left + editorSize.width - 100
      });
    }, 0);
  }
}


      var data = {"files": {"0": {"id": 0, "path": "/src/drivers/net/ethernet/marvell/sky2.c", "content": "// SPDX-License-Identifier: GPL-2.0-only\n/*\n * New driver for Marvell Yukon 2 chipset.\n * Based on earlier sk98lin, and skge driver.\n *\n * This driver intentionally does not support all the features\n * of the original driver such as link fail-over and link management because\n * those should be done at higher levels.\n *\n * Copyright (C) 2005 Stephen Hemminger <shemminger@osdl.org>\n */\n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/crc32.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/netdevice.h>\n#include <linux/dma-mapping.h>\n#include <linux/etherdevice.h>\n#include <linux/ethtool.h>\n#include <linux/pci.h>\n#include <linux/interrupt.h>\n#include <linux/ip.h>\n#include <linux/slab.h>\n#include <net/ip.h>\n#include <linux/tcp.h>\n#include <linux/in.h>\n#include <linux/delay.h>\n#include <linux/workqueue.h>\n#include <linux/if_vlan.h>\n#include <linux/prefetch.h>\n#include <linux/debugfs.h>\n#include <linux/mii.h>\n#include <linux/of_device.h>\n#include <linux/of_net.h>\n#include <linux/dmi.h>\n\n#include <asm/irq.h>\n\n#include \"sky2.h\"\n\n#define DRV_NAME\t\t\"sky2\"\n#define DRV_VERSION\t\t\"1.30\"\n\n/*\n * The Yukon II chipset takes 64 bit command blocks (called list elements)\n * that are organized into three (receive, transmit, status) different rings\n * similar to Tigon3.\n */\n\n#define RX_LE_SIZE\t    \t1024\n#define RX_LE_BYTES\t\t(RX_LE_SIZE*sizeof(struct sky2_rx_le))\n#define RX_MAX_PENDING\t\t(RX_LE_SIZE/6 - 2)\n#define RX_DEF_PENDING\t\tRX_MAX_PENDING\n\n/* This is the worst case number of transmit list elements for a single skb:\n   VLAN:GSO + CKSUM + Data + skb_frags * DMA */\n#define MAX_SKB_TX_LE\t(2 + (sizeof(dma_addr_t)/sizeof(u32))*(MAX_SKB_FRAGS+1))\n#define TX_MIN_PENDING\t\t(MAX_SKB_TX_LE+1)\n#define TX_MAX_PENDING\t\t1024\n#define TX_DEF_PENDING\t\t63\n\n#define TX_WATCHDOG\t\t(5 * HZ)\n#define NAPI_WEIGHT\t\t64\n#define PHY_RETRIES\t\t1000\n\n#define SKY2_EEPROM_MAGIC\t0x9955aabb\n\n#define RING_NEXT(x, s)\t(((x)+1) & ((s)-1))\n\nstatic const u32 default_msg =\n    NETIF_MSG_DRV | NETIF_MSG_PROBE | NETIF_MSG_LINK\n    | NETIF_MSG_TIMER | NETIF_MSG_TX_ERR | NETIF_MSG_RX_ERR\n    | NETIF_MSG_IFUP | NETIF_MSG_IFDOWN;\n\nstatic int debug = -1;\t\t/* defaults above */\nmodule_param(debug, int, 0);\nMODULE_PARM_DESC(debug, \"Debug level (0=none,...,16=all)\");\n\nstatic int copybreak __read_mostly = 128;\nmodule_param(copybreak, int, 0);\nMODULE_PARM_DESC(copybreak, \"Receive copy threshold\");\n\nstatic int disable_msi = -1;\nmodule_param(disable_msi, int, 0);\nMODULE_PARM_DESC(disable_msi, \"Disable Message Signaled Interrupt (MSI)\");\n\nstatic int legacy_pme = 0;\nmodule_param(legacy_pme, int, 0);\nMODULE_PARM_DESC(legacy_pme, \"Legacy power management\");\n\nstatic const struct pci_device_id sky2_id_table[] = {\n\t{ PCI_DEVICE(PCI_VENDOR_ID_SYSKONNECT, 0x9000) }, /* SK-9Sxx */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_SYSKONNECT, 0x9E00) }, /* SK-9Exx */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_SYSKONNECT, 0x9E01) }, /* SK-9E21M */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_DLINK, 0x4b00) },\t/* DGE-560T */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_DLINK, 0x4001) }, \t/* DGE-550SX */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_DLINK, 0x4B02) },\t/* DGE-560SX */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_DLINK, 0x4B03) },\t/* DGE-550T */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4340) }, /* 88E8021 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4341) }, /* 88E8022 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4342) }, /* 88E8061 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4343) }, /* 88E8062 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4344) }, /* 88E8021 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4345) }, /* 88E8022 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4346) }, /* 88E8061 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4347) }, /* 88E8062 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4350) }, /* 88E8035 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4351) }, /* 88E8036 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4352) }, /* 88E8038 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4353) }, /* 88E8039 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4354) }, /* 88E8040 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4355) }, /* 88E8040T */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4356) }, /* 88EC033 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4357) }, /* 88E8042 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x435A) }, /* 88E8048 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4360) }, /* 88E8052 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4361) }, /* 88E8050 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4362) }, /* 88E8053 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4363) }, /* 88E8055 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4364) }, /* 88E8056 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4365) }, /* 88E8070 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4366) }, /* 88EC036 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4367) }, /* 88EC032 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4368) }, /* 88EC034 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4369) }, /* 88EC042 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x436A) }, /* 88E8058 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x436B) }, /* 88E8071 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x436C) }, /* 88E8072 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x436D) }, /* 88E8055 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4370) }, /* 88E8075 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4380) }, /* 88E8057 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4381) }, /* 88E8059 */\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, 0x4382) }, /* 88E8079 */\n\t{ 0 }\n};\n\nMODULE_DEVICE_TABLE(pci, sky2_id_table);\n\n/* Avoid conditionals by using array */\nstatic const unsigned txqaddr[] = { Q_XA1, Q_XA2 };\nstatic const unsigned rxqaddr[] = { Q_R1, Q_R2 };\nstatic const u32 portirq_msk[] = { Y2_IS_PORT_1, Y2_IS_PORT_2 };\n\nstatic void sky2_set_multicast(struct net_device *dev);\nstatic irqreturn_t sky2_intr(int irq, void *dev_id);\n\n/* Access to PHY via serial interconnect */\nstatic int gm_phy_write(struct sky2_hw *hw, unsigned port, u16 reg, u16 val)\n{\n\tint i;\n\n\tgma_write16(hw, port, GM_SMI_DATA, val);\n\tgma_write16(hw, port, GM_SMI_CTRL,\n\t\t    GM_SMI_CT_PHY_AD(PHY_ADDR_MARV) | GM_SMI_CT_REG_AD(reg));\n\n\tfor (i = 0; i < PHY_RETRIES; i++) {\n\t\tu16 ctrl = gma_read16(hw, port, GM_SMI_CTRL);\n\t\tif (ctrl == 0xffff)\n\t\t\tgoto io_error;\n\n\t\tif (!(ctrl & GM_SMI_CT_BUSY))\n\t\t\treturn 0;\n\n\t\tudelay(10);\n\t}\n\n\tdev_warn(&hw->pdev->dev, \"%s: phy write timeout\\n\", hw->dev[port]->name);\n\treturn -ETIMEDOUT;\n\nio_error:\n\tdev_err(&hw->pdev->dev, \"%s: phy I/O error\\n\", hw->dev[port]->name);\n\treturn -EIO;\n}\n\nstatic int __gm_phy_read(struct sky2_hw *hw, unsigned port, u16 reg, u16 *val)\n{\n\tint i;\n\n\tgma_write16(hw, port, GM_SMI_CTRL, GM_SMI_CT_PHY_AD(PHY_ADDR_MARV)\n\t\t    | GM_SMI_CT_REG_AD(reg) | GM_SMI_CT_OP_RD);\n\n\tfor (i = 0; i < PHY_RETRIES; i++) {\n\t\tu16 ctrl = gma_read16(hw, port, GM_SMI_CTRL);\n\t\tif (ctrl == 0xffff)\n\t\t\tgoto io_error;\n\n\t\tif (ctrl & GM_SMI_CT_RD_VAL) {\n\t\t\t*val = gma_read16(hw, port, GM_SMI_DATA);\n\t\t\treturn 0;\n\t\t}\n\n\t\tudelay(10);\n\t}\n\n\tdev_warn(&hw->pdev->dev, \"%s: phy read timeout\\n\", hw->dev[port]->name);\n\treturn -ETIMEDOUT;\nio_error:\n\tdev_err(&hw->pdev->dev, \"%s: phy I/O error\\n\", hw->dev[port]->name);\n\treturn -EIO;\n}\n\nstatic inline u16 gm_phy_read(struct sky2_hw *hw, unsigned port, u16 reg)\n{\n\tu16 v = 0;\n\t__gm_phy_read(hw, port, reg, &v);\n\treturn v;\n}\n\n\nstatic void sky2_power_on(struct sky2_hw *hw)\n{\n\t/* switch power to VCC (WA for VAUX problem) */\n\tsky2_write8(hw, B0_POWER_CTRL,\n\t\t    PC_VAUX_ENA | PC_VCC_ENA | PC_VAUX_OFF | PC_VCC_ON);\n\n\t/* disable Core Clock Division, */\n\tsky2_write32(hw, B2_Y2_CLK_CTRL, Y2_CLK_DIV_DIS);\n\n\tif (hw->chip_id == CHIP_ID_YUKON_XL && hw->chip_rev > CHIP_REV_YU_XL_A1)\n\t\t/* enable bits are inverted */\n\t\tsky2_write8(hw, B2_Y2_CLK_GATE,\n\t\t\t    Y2_PCI_CLK_LNK1_DIS | Y2_COR_CLK_LNK1_DIS |\n\t\t\t    Y2_CLK_GAT_LNK1_DIS | Y2_PCI_CLK_LNK2_DIS |\n\t\t\t    Y2_COR_CLK_LNK2_DIS | Y2_CLK_GAT_LNK2_DIS);\n\telse\n\t\tsky2_write8(hw, B2_Y2_CLK_GATE, 0);\n\n\tif (hw->flags & SKY2_HW_ADV_POWER_CTL) {\n\t\tu32 reg;\n\n\t\tsky2_pci_write32(hw, PCI_DEV_REG3, 0);\n\n\t\treg = sky2_pci_read32(hw, PCI_DEV_REG4);\n\t\t/* set all bits to 0 except bits 15..12 and 8 */\n\t\treg &= P_ASPM_CONTROL_MSK;\n\t\tsky2_pci_write32(hw, PCI_DEV_REG4, reg);\n\n\t\treg = sky2_pci_read32(hw, PCI_DEV_REG5);\n\t\t/* set all bits to 0 except bits 28 & 27 */\n\t\treg &= P_CTL_TIM_VMAIN_AV_MSK;\n\t\tsky2_pci_write32(hw, PCI_DEV_REG5, reg);\n\n\t\tsky2_pci_write32(hw, PCI_CFG_REG_1, 0);\n\n\t\tsky2_write16(hw, B0_CTST, Y2_HW_WOL_ON);\n\n\t\t/* Enable workaround for dev 4.107 on Yukon-Ultra & Extreme */\n\t\treg = sky2_read32(hw, B2_GP_IO);\n\t\treg |= GLB_GPIO_STAT_RACE_DIS;\n\t\tsky2_write32(hw, B2_GP_IO, reg);\n\n\t\tsky2_read32(hw, B2_GP_IO);\n\t}\n\n\t/* Turn on \"driver loaded\" LED */\n\tsky2_write16(hw, B0_CTST, Y2_LED_STAT_ON);\n}\n\nstatic void sky2_power_aux(struct sky2_hw *hw)\n{\n\tif (hw->chip_id == CHIP_ID_YUKON_XL && hw->chip_rev > CHIP_REV_YU_XL_A1)\n\t\tsky2_write8(hw, B2_Y2_CLK_GATE, 0);\n\telse\n\t\t/* enable bits are inverted */\n\t\tsky2_write8(hw, B2_Y2_CLK_GATE,\n\t\t\t    Y2_PCI_CLK_LNK1_DIS | Y2_COR_CLK_LNK1_DIS |\n\t\t\t    Y2_CLK_GAT_LNK1_DIS | Y2_PCI_CLK_LNK2_DIS |\n\t\t\t    Y2_COR_CLK_LNK2_DIS | Y2_CLK_GAT_LNK2_DIS);\n\n\t/* switch power to VAUX if supported and PME from D3cold */\n\tif ( (sky2_read32(hw, B0_CTST) & Y2_VAUX_AVAIL) &&\n\t     pci_pme_capable(hw->pdev, PCI_D3cold))\n\t\tsky2_write8(hw, B0_POWER_CTRL,\n\t\t\t    (PC_VAUX_ENA | PC_VCC_ENA |\n\t\t\t     PC_VAUX_ON | PC_VCC_OFF));\n\n\t/* turn off \"driver loaded LED\" */\n\tsky2_write16(hw, B0_CTST, Y2_LED_STAT_OFF);\n}\n\nstatic void sky2_gmac_reset(struct sky2_hw *hw, unsigned port)\n{\n\tu16 reg;\n\n\t/* disable all GMAC IRQ's */\n\tsky2_write8(hw, SK_REG(port, GMAC_IRQ_MSK), 0);\n\n\tgma_write16(hw, port, GM_MC_ADDR_H1, 0);\t/* clear MC hash */\n\tgma_write16(hw, port, GM_MC_ADDR_H2, 0);\n\tgma_write16(hw, port, GM_MC_ADDR_H3, 0);\n\tgma_write16(hw, port, GM_MC_ADDR_H4, 0);\n\n\treg = gma_read16(hw, port, GM_RX_CTRL);\n\treg |= GM_RXCR_UCF_ENA | GM_RXCR_MCF_ENA;\n\tgma_write16(hw, port, GM_RX_CTRL, reg);\n}\n\n/* flow control to advertise bits */\nstatic const u16 copper_fc_adv[] = {\n\t[FC_NONE]\t= 0,\n\t[FC_TX]\t\t= PHY_M_AN_ASP,\n\t[FC_RX]\t\t= PHY_M_AN_PC,\n\t[FC_BOTH]\t= PHY_M_AN_PC | PHY_M_AN_ASP,\n};\n\n/* flow control to advertise bits when using 1000BaseX */\nstatic const u16 fiber_fc_adv[] = {\n\t[FC_NONE] = PHY_M_P_NO_PAUSE_X,\n\t[FC_TX]   = PHY_M_P_ASYM_MD_X,\n\t[FC_RX]\t  = PHY_M_P_SYM_MD_X,\n\t[FC_BOTH] = PHY_M_P_BOTH_MD_X,\n};\n\n/* flow control to GMA disable bits */\nstatic const u16 gm_fc_disable[] = {\n\t[FC_NONE] = GM_GPCR_FC_RX_DIS | GM_GPCR_FC_TX_DIS,\n\t[FC_TX]\t  = GM_GPCR_FC_RX_DIS,\n\t[FC_RX]\t  = GM_GPCR_FC_TX_DIS,\n\t[FC_BOTH] = 0,\n};\n\n\nstatic void sky2_phy_init(struct sky2_hw *hw, unsigned port)\n{\n\tstruct sky2_port *sky2 = netdev_priv(hw->dev[port]);\n\tu16 ctrl, ct1000, adv, pg, ledctrl, ledover, reg;\n\n\tif ( (sky2->flags & SKY2_FLAG_AUTO_SPEED) &&\n\t    !(hw->flags & SKY2_HW_NEWER_PHY)) {\n\t\tu16 ectrl = gm_phy_read(hw, port, PHY_MARV_EXT_CTRL);\n\n\t\tectrl &= ~(PHY_M_EC_M_DSC_MSK | PHY_M_EC_S_DSC_MSK |\n\t\t\t   PHY_M_EC_MAC_S_MSK);\n\t\tectrl |= PHY_M_EC_MAC_S(MAC_TX_CLK_25_MHZ);\n\n\t\t/* on PHY 88E1040 Rev.D0 (and newer) downshift control changed */\n\t\tif (hw->chip_id == CHIP_ID_YUKON_EC)\n\t\t\t/* set downshift counter to 3x and enable downshift */\n\t\t\tectrl |= PHY_M_EC_DSC_2(2) | PHY_M_EC_DOWN_S_ENA;\n\t\telse\n\t\t\t/* set master & slave downshift counter to 1x */\n\t\t\tectrl |= PHY_M_EC_M_DSC(0) | PHY_M_EC_S_DSC(1);\n\n\t\tgm_phy_write(hw, port, PHY_MARV_EXT_CTRL, ectrl);\n\t}\n\n\tctrl = gm_phy_read(hw, port, PHY_MARV_PHY_CTRL);\n\tif (sky2_is_copper(hw)) {\n\t\tif (!(hw->flags & SKY2_HW_GIGABIT)) {\n\t\t\t/* enable automatic crossover */\n\t\t\tctrl |= PHY_M_PC_MDI_XMODE(PHY_M_PC_ENA_AUTO) >> 1;\n\n\t\t\tif (hw->chip_id == CHIP_ID_YUKON_FE_P &&\n\t\t\t    hw->chip_rev == CHIP_REV_YU_FE2_A0) {\n\t\t\t\tu16 spec;\n\n\t\t\t\t/* Enable Class A driver for FE+ A0 */\n\t\t\t\tspec = gm_phy_read(hw, port, PHY_MARV_FE_SPEC_2);\n\t\t\t\tspec |= PHY_M_FESC_SEL_CL_A;\n\t\t\t\tgm_phy_write(hw, port, PHY_MARV_FE_SPEC_2, spec);\n\t\t\t}\n\t\t} else {\n\t\t\t/* disable energy detect */\n\t\t\tctrl &= ~PHY_M_PC_EN_DET_MSK;\n\n\t\t\t/* enable automatic crossover */\n\t\t\tctrl |= PHY_M_PC_MDI_XMODE(PHY_M_PC_ENA_AUTO);\n\n\t\t\t/* downshift on PHY 88E1112 and 88E1149 is changed */\n\t\t\tif ( (sky2->flags & SKY2_FLAG_AUTO_SPEED) &&\n\t\t\t     (hw->flags & SKY2_HW_NEWER_PHY)) {\n\t\t\t\t/* set downshift counter to 3x and enable downshift */\n\t\t\t\tctrl &= ~PHY_M_PC_DSC_MSK;\n\t\t\t\tctrl |= PHY_M_PC_DSC(2) | PHY_M_PC_DOWN_S_ENA;\n\t\t\t}\n\t\t}\n\t} else {\n\t\t/* workaround for deviation #4.88 (CRC errors) */\n\t\t/* disable Automatic Crossover */\n\n\t\tctrl &= ~PHY_M_PC_MDIX_MSK;\n\t}\n\n\tgm_phy_write(hw, port, PHY_MARV_PHY_CTRL, ctrl);\n\n\t/* special setup for PHY 88E1112 Fiber */\n\tif (hw->chip_id == CHIP_ID_YUKON_XL && (hw->flags & SKY2_HW_FIBRE_PHY)) {\n\t\tpg = gm_phy_read(hw, port, PHY_MARV_EXT_ADR);\n\n\t\t/* Fiber: select 1000BASE-X only mode MAC Specific Ctrl Reg. */\n\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, 2);\n\t\tctrl = gm_phy_read(hw, port, PHY_MARV_PHY_CTRL);\n\t\tctrl &= ~PHY_M_MAC_MD_MSK;\n\t\tctrl |= PHY_M_MAC_MODE_SEL(PHY_M_MAC_MD_1000BX);\n\t\tgm_phy_write(hw, port, PHY_MARV_PHY_CTRL, ctrl);\n\n\t\tif (hw->pmd_type  == 'P') {\n\t\t\t/* select page 1 to access Fiber registers */\n\t\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, 1);\n\n\t\t\t/* for SFP-module set SIGDET polarity to low */\n\t\t\tctrl = gm_phy_read(hw, port, PHY_MARV_PHY_CTRL);\n\t\t\tctrl |= PHY_M_FIB_SIGD_POL;\n\t\t\tgm_phy_write(hw, port, PHY_MARV_PHY_CTRL, ctrl);\n\t\t}\n\n\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, pg);\n\t}\n\n\tctrl = PHY_CT_RESET;\n\tct1000 = 0;\n\tadv = PHY_AN_CSMA;\n\treg = 0;\n\n\tif (sky2->flags & SKY2_FLAG_AUTO_SPEED) {\n\t\tif (sky2_is_copper(hw)) {\n\t\t\tif (sky2->advertising & ADVERTISED_1000baseT_Full)\n\t\t\t\tct1000 |= PHY_M_1000C_AFD;\n\t\t\tif (sky2->advertising & ADVERTISED_1000baseT_Half)\n\t\t\t\tct1000 |= PHY_M_1000C_AHD;\n\t\t\tif (sky2->advertising & ADVERTISED_100baseT_Full)\n\t\t\t\tadv |= PHY_M_AN_100_FD;\n\t\t\tif (sky2->advertising & ADVERTISED_100baseT_Half)\n\t\t\t\tadv |= PHY_M_AN_100_HD;\n\t\t\tif (sky2->advertising & ADVERTISED_10baseT_Full)\n\t\t\t\tadv |= PHY_M_AN_10_FD;\n\t\t\tif (sky2->advertising & ADVERTISED_10baseT_Half)\n\t\t\t\tadv |= PHY_M_AN_10_HD;\n\n\t\t} else {\t/* special defines for FIBER (88E1040S only) */\n\t\t\tif (sky2->advertising & ADVERTISED_1000baseT_Full)\n\t\t\t\tadv |= PHY_M_AN_1000X_AFD;\n\t\t\tif (sky2->advertising & ADVERTISED_1000baseT_Half)\n\t\t\t\tadv |= PHY_M_AN_1000X_AHD;\n\t\t}\n\n\t\t/* Restart Auto-negotiation */\n\t\tctrl |= PHY_CT_ANE | PHY_CT_RE_CFG;\n\t} else {\n\t\t/* forced speed/duplex settings */\n\t\tct1000 = PHY_M_1000C_MSE;\n\n\t\t/* Disable auto update for duplex flow control and duplex */\n\t\treg |= GM_GPCR_AU_DUP_DIS | GM_GPCR_AU_SPD_DIS;\n\n\t\tswitch (sky2->speed) {\n\t\tcase SPEED_1000:\n\t\t\tctrl |= PHY_CT_SP1000;\n\t\t\treg |= GM_GPCR_SPEED_1000;\n\t\t\tbreak;\n\t\tcase SPEED_100:\n\t\t\tctrl |= PHY_CT_SP100;\n\t\t\treg |= GM_GPCR_SPEED_100;\n\t\t\tbreak;\n\t\t}\n\n\t\tif (sky2->duplex == DUPLEX_FULL) {\n\t\t\treg |= GM_GPCR_DUP_FULL;\n\t\t\tctrl |= PHY_CT_DUP_MD;\n\t\t} else if (sky2->speed < SPEED_1000)\n\t\t\tsky2->flow_mode = FC_NONE;\n\t}\n\n\tif (sky2->flags & SKY2_FLAG_AUTO_PAUSE) {\n\t\tif (sky2_is_copper(hw))\n\t\t\tadv |= copper_fc_adv[sky2->flow_mode];\n\t\telse\n\t\t\tadv |= fiber_fc_adv[sky2->flow_mode];\n\t} else {\n\t\treg |= GM_GPCR_AU_FCT_DIS;\n \t\treg |= gm_fc_disable[sky2->flow_mode];\n\n\t\t/* Forward pause packets to GMAC? */\n\t\tif (sky2->flow_mode & FC_RX)\n\t\t\tsky2_write8(hw, SK_REG(port, GMAC_CTRL), GMC_PAUSE_ON);\n\t\telse\n\t\t\tsky2_write8(hw, SK_REG(port, GMAC_CTRL), GMC_PAUSE_OFF);\n\t}\n\n\tgma_write16(hw, port, GM_GP_CTRL, reg);\n\n\tif (hw->flags & SKY2_HW_GIGABIT)\n\t\tgm_phy_write(hw, port, PHY_MARV_1000T_CTRL, ct1000);\n\n\tgm_phy_write(hw, port, PHY_MARV_AUNE_ADV, adv);\n\tgm_phy_write(hw, port, PHY_MARV_CTRL, ctrl);\n\n\t/* Setup Phy LED's */\n\tledctrl = PHY_M_LED_PULS_DUR(PULS_170MS);\n\tledover = 0;\n\n\tswitch (hw->chip_id) {\n\tcase CHIP_ID_YUKON_FE:\n\t\t/* on 88E3082 these bits are at 11..9 (shifted left) */\n\t\tledctrl |= PHY_M_LED_BLINK_RT(BLINK_84MS) << 1;\n\n\t\tctrl = gm_phy_read(hw, port, PHY_MARV_FE_LED_PAR);\n\n\t\t/* delete ACT LED control bits */\n\t\tctrl &= ~PHY_M_FELP_LED1_MSK;\n\t\t/* change ACT LED control to blink mode */\n\t\tctrl |= PHY_M_FELP_LED1_CTRL(LED_PAR_CTRL_ACT_BL);\n\t\tgm_phy_write(hw, port, PHY_MARV_FE_LED_PAR, ctrl);\n\t\tbreak;\n\n\tcase CHIP_ID_YUKON_FE_P:\n\t\t/* Enable Link Partner Next Page */\n\t\tctrl = gm_phy_read(hw, port, PHY_MARV_PHY_CTRL);\n\t\tctrl |= PHY_M_PC_ENA_LIP_NP;\n\n\t\t/* disable Energy Detect and enable scrambler */\n\t\tctrl &= ~(PHY_M_PC_ENA_ENE_DT | PHY_M_PC_DIS_SCRAMB);\n\t\tgm_phy_write(hw, port, PHY_MARV_PHY_CTRL, ctrl);\n\n\t\t/* set LED2 -> ACT, LED1 -> LINK, LED0 -> SPEED */\n\t\tctrl = PHY_M_FELP_LED2_CTRL(LED_PAR_CTRL_ACT_BL) |\n\t\t\tPHY_M_FELP_LED1_CTRL(LED_PAR_CTRL_LINK) |\n\t\t\tPHY_M_FELP_LED0_CTRL(LED_PAR_CTRL_SPEED);\n\n\t\tgm_phy_write(hw, port, PHY_MARV_FE_LED_PAR, ctrl);\n\t\tbreak;\n\n\tcase CHIP_ID_YUKON_XL:\n\t\tpg = gm_phy_read(hw, port, PHY_MARV_EXT_ADR);\n\n\t\t/* select page 3 to access LED control register */\n\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, 3);\n\n\t\t/* set LED Function Control register */\n\t\tgm_phy_write(hw, port, PHY_MARV_PHY_CTRL,\n\t\t\t     (PHY_M_LEDC_LOS_CTRL(1) |\t/* LINK/ACT */\n\t\t\t      PHY_M_LEDC_INIT_CTRL(7) |\t/* 10 Mbps */\n\t\t\t      PHY_M_LEDC_STA1_CTRL(7) |\t/* 100 Mbps */\n\t\t\t      PHY_M_LEDC_STA0_CTRL(7)));\t/* 1000 Mbps */\n\n\t\t/* set Polarity Control register */\n\t\tgm_phy_write(hw, port, PHY_MARV_PHY_STAT,\n\t\t\t     (PHY_M_POLC_LS1_P_MIX(4) |\n\t\t\t      PHY_M_POLC_IS0_P_MIX(4) |\n\t\t\t      PHY_M_POLC_LOS_CTRL(2) |\n\t\t\t      PHY_M_POLC_INIT_CTRL(2) |\n\t\t\t      PHY_M_POLC_STA1_CTRL(2) |\n\t\t\t      PHY_M_POLC_STA0_CTRL(2)));\n\n\t\t/* restore page register */\n\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, pg);\n\t\tbreak;\n\n\tcase CHIP_ID_YUKON_EC_U:\n\tcase CHIP_ID_YUKON_EX:\n\tcase CHIP_ID_YUKON_SUPR:\n\t\tpg = gm_phy_read(hw, port, PHY_MARV_EXT_ADR);\n\n\t\t/* select page 3 to access LED control register */\n\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, 3);\n\n\t\t/* set LED Function Control register */\n\t\tgm_phy_write(hw, port, PHY_MARV_PHY_CTRL,\n\t\t\t     (PHY_M_LEDC_LOS_CTRL(1) |\t/* LINK/ACT */\n\t\t\t      PHY_M_LEDC_INIT_CTRL(8) |\t/* 10 Mbps */\n\t\t\t      PHY_M_LEDC_STA1_CTRL(7) |\t/* 100 Mbps */\n\t\t\t      PHY_M_LEDC_STA0_CTRL(7)));/* 1000 Mbps */\n\n\t\t/* set Blink Rate in LED Timer Control Register */\n\t\tgm_phy_write(hw, port, PHY_MARV_INT_MASK,\n\t\t\t     ledctrl | PHY_M_LED_BLINK_RT(BLINK_84MS));\n\t\t/* restore page register */\n\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, pg);\n\t\tbreak;\n\n\tdefault:\n\t\t/* set Tx LED (LED_TX) to blink mode on Rx OR Tx activity */\n\t\tledctrl |= PHY_M_LED_BLINK_RT(BLINK_84MS) | PHY_M_LEDC_TX_CTRL;\n\n\t\t/* turn off the Rx LED (LED_RX) */\n\t\tledover |= PHY_M_LED_MO_RX(MO_LED_OFF);\n\t}\n\n\tif (hw->chip_id == CHIP_ID_YUKON_EC_U || hw->chip_id == CHIP_ID_YUKON_UL_2) {\n\t\t/* apply fixes in PHY AFE */\n\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, 255);\n\n\t\t/* increase differential signal amplitude in 10BASE-T */\n\t\tgm_phy_write(hw, port, 0x18, 0xaa99);\n\t\tgm_phy_write(hw, port, 0x17, 0x2011);\n\n\t\tif (hw->chip_id == CHIP_ID_YUKON_EC_U) {\n\t\t\t/* fix for IEEE A/B Symmetry failure in 1000BASE-T */\n\t\t\tgm_phy_write(hw, port, 0x18, 0xa204);\n\t\t\tgm_phy_write(hw, port, 0x17, 0x2002);\n\t\t}\n\n\t\t/* set page register to 0 */\n\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, 0);\n\t} else if (hw->chip_id == CHIP_ID_YUKON_FE_P &&\n\t\t   hw->chip_rev == CHIP_REV_YU_FE2_A0) {\n\t\t/* apply workaround for integrated resistors calibration */\n\t\tgm_phy_write(hw, port, PHY_MARV_PAGE_ADDR, 17);\n\t\tgm_phy_write(hw, port, PHY_MARV_PAGE_DATA, 0x3f60);\n\t} else if (hw->chip_id == CHIP_ID_YUKON_OPT && hw->chip_rev == 0) {\n\t\t/* apply fixes in PHY AFE */\n\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, 0x00ff);\n\n\t\t/* apply RDAC termination workaround */\n\t\tgm_phy_write(hw, port, 24, 0x2800);\n\t\tgm_phy_write(hw, port, 23, 0x2001);\n\n\t\t/* set page register back to 0 */\n\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, 0);\n\t} else if (hw->chip_id != CHIP_ID_YUKON_EX &&\n\t\t   hw->chip_id < CHIP_ID_YUKON_SUPR) {\n\t\t/* no effect on Yukon-XL */\n\t\tgm_phy_write(hw, port, PHY_MARV_LED_CTRL, ledctrl);\n\n\t\tif (!(sky2->flags & SKY2_FLAG_AUTO_SPEED) ||\n\t\t    sky2->speed == SPEED_100) {\n\t\t\t/* turn on 100 Mbps LED (LED_LINK100) */\n\t\t\tledover |= PHY_M_LED_MO_100(MO_LED_ON);\n\t\t}\n\n\t\tif (ledover)\n\t\t\tgm_phy_write(hw, port, PHY_MARV_LED_OVER, ledover);\n\n\t} else if (hw->chip_id == CHIP_ID_YUKON_PRM &&\n\t\t   (sky2_read8(hw, B2_MAC_CFG) & 0xf) == 0x7) {\n\t\tint i;\n\t\t/* This a phy register setup workaround copied from vendor driver. */\n\t\tstatic const struct {\n\t\t\tu16 reg, val;\n\t\t} eee_afe[] = {\n\t\t\t{ 0x156, 0x58ce },\n\t\t\t{ 0x153, 0x99eb },\n\t\t\t{ 0x141, 0x8064 },\n\t\t\t/* { 0x155, 0x130b },*/\n\t\t\t{ 0x000, 0x0000 },\n\t\t\t{ 0x151, 0x8433 },\n\t\t\t{ 0x14b, 0x8c44 },\n\t\t\t{ 0x14c, 0x0f90 },\n\t\t\t{ 0x14f, 0x39aa },\n\t\t\t/* { 0x154, 0x2f39 },*/\n\t\t\t{ 0x14d, 0xba33 },\n\t\t\t{ 0x144, 0x0048 },\n\t\t\t{ 0x152, 0x2010 },\n\t\t\t/* { 0x158, 0x1223 },*/\n\t\t\t{ 0x140, 0x4444 },\n\t\t\t{ 0x154, 0x2f3b },\n\t\t\t{ 0x158, 0xb203 },\n\t\t\t{ 0x157, 0x2029 },\n\t\t};\n\n\t\t/* Start Workaround for OptimaEEE Rev.Z0 */\n\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, 0x00fb);\n\n\t\tgm_phy_write(hw, port,  1, 0x4099);\n\t\tgm_phy_write(hw, port,  3, 0x1120);\n\t\tgm_phy_write(hw, port, 11, 0x113c);\n\t\tgm_phy_write(hw, port, 14, 0x8100);\n\t\tgm_phy_write(hw, port, 15, 0x112a);\n\t\tgm_phy_write(hw, port, 17, 0x1008);\n\n\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, 0x00fc);\n\t\tgm_phy_write(hw, port,  1, 0x20b0);\n\n\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, 0x00ff);\n\n\t\tfor (i = 0; i < ARRAY_SIZE(eee_afe); i++) {\n\t\t\t/* apply AFE settings */\n\t\t\tgm_phy_write(hw, port, 17, eee_afe[i].val);\n\t\t\tgm_phy_write(hw, port, 16, eee_afe[i].reg | 1u<<13);\n\t\t}\n\n\t\t/* End Workaround for OptimaEEE */\n\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, 0);\n\n\t\t/* Enable 10Base-Te (EEE) */\n\t\tif (hw->chip_id >= CHIP_ID_YUKON_PRM) {\n\t\t\treg = gm_phy_read(hw, port, PHY_MARV_EXT_CTRL);\n\t\t\tgm_phy_write(hw, port, PHY_MARV_EXT_CTRL,\n\t\t\t\t     reg | PHY_M_10B_TE_ENABLE);\n\t\t}\n\t}\n\n\t/* Enable phy interrupt on auto-negotiation complete (or link up) */\n\tif (sky2->flags & SKY2_FLAG_AUTO_SPEED)\n\t\tgm_phy_write(hw, port, PHY_MARV_INT_MASK, PHY_M_IS_AN_COMPL);\n\telse\n\t\tgm_phy_write(hw, port, PHY_MARV_INT_MASK, PHY_M_DEF_MSK);\n}\n\nstatic const u32 phy_power[] = { PCI_Y2_PHY1_POWD, PCI_Y2_PHY2_POWD };\nstatic const u32 coma_mode[] = { PCI_Y2_PHY1_COMA, PCI_Y2_PHY2_COMA };\n\nstatic void sky2_phy_power_up(struct sky2_hw *hw, unsigned port)\n{\n\tu32 reg1;\n\n\tsky2_write8(hw, B2_TST_CTRL1, TST_CFG_WRITE_ON);\n\treg1 = sky2_pci_read32(hw, PCI_DEV_REG1);\n\treg1 &= ~phy_power[port];\n\n\tif (hw->chip_id == CHIP_ID_YUKON_XL && hw->chip_rev > CHIP_REV_YU_XL_A1)\n\t\treg1 |= coma_mode[port];\n\n\tsky2_pci_write32(hw, PCI_DEV_REG1, reg1);\n\tsky2_write8(hw, B2_TST_CTRL1, TST_CFG_WRITE_OFF);\n\tsky2_pci_read32(hw, PCI_DEV_REG1);\n\n\tif (hw->chip_id == CHIP_ID_YUKON_FE)\n\t\tgm_phy_write(hw, port, PHY_MARV_CTRL, PHY_CT_ANE);\n\telse if (hw->flags & SKY2_HW_ADV_POWER_CTL)\n\t\tsky2_write8(hw, SK_REG(port, GPHY_CTRL), GPC_RST_CLR);\n}\n\nstatic void sky2_phy_power_down(struct sky2_hw *hw, unsigned port)\n{\n\tu32 reg1;\n\tu16 ctrl;\n\n\t/* release GPHY Control reset */\n\tsky2_write8(hw, SK_REG(port, GPHY_CTRL), GPC_RST_CLR);\n\n\t/* release GMAC reset */\n\tsky2_write8(hw, SK_REG(port, GMAC_CTRL), GMC_RST_CLR);\n\n\tif (hw->flags & SKY2_HW_NEWER_PHY) {\n\t\t/* select page 2 to access MAC control register */\n\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, 2);\n\n\t\tctrl = gm_phy_read(hw, port, PHY_MARV_PHY_CTRL);\n\t\t/* allow GMII Power Down */\n\t\tctrl &= ~PHY_M_MAC_GMIF_PUP;\n\t\tgm_phy_write(hw, port, PHY_MARV_PHY_CTRL, ctrl);\n\n\t\t/* set page register back to 0 */\n\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, 0);\n\t}\n\n\t/* setup General Purpose Control Register */\n\tgma_write16(hw, port, GM_GP_CTRL,\n\t\t    GM_GPCR_FL_PASS | GM_GPCR_SPEED_100 |\n\t\t    GM_GPCR_AU_DUP_DIS | GM_GPCR_AU_FCT_DIS |\n\t\t    GM_GPCR_AU_SPD_DIS);\n\n\tif (hw->chip_id != CHIP_ID_YUKON_EC) {\n\t\tif (hw->chip_id == CHIP_ID_YUKON_EC_U) {\n\t\t\t/* select page 2 to access MAC control register */\n\t\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, 2);\n\n\t\t\tctrl = gm_phy_read(hw, port, PHY_MARV_PHY_CTRL);\n\t\t\t/* enable Power Down */\n\t\t\tctrl |= PHY_M_PC_POW_D_ENA;\n\t\t\tgm_phy_write(hw, port, PHY_MARV_PHY_CTRL, ctrl);\n\n\t\t\t/* set page register back to 0 */\n\t\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, 0);\n\t\t}\n\n\t\t/* set IEEE compatible Power Down Mode (dev. #4.99) */\n\t\tgm_phy_write(hw, port, PHY_MARV_CTRL, PHY_CT_PDOWN);\n\t}\n\n\tsky2_write8(hw, B2_TST_CTRL1, TST_CFG_WRITE_ON);\n\treg1 = sky2_pci_read32(hw, PCI_DEV_REG1);\n\treg1 |= phy_power[port];\t\t/* set PHY to PowerDown/COMA Mode */\n\tsky2_pci_write32(hw, PCI_DEV_REG1, reg1);\n\tsky2_write8(hw, B2_TST_CTRL1, TST_CFG_WRITE_OFF);\n}\n\n/* configure IPG according to used link speed */\nstatic void sky2_set_ipg(struct sky2_port *sky2)\n{\n\tu16 reg;\n\n\treg = gma_read16(sky2->hw, sky2->port, GM_SERIAL_MODE);\n\treg &= ~GM_SMOD_IPG_MSK;\n\tif (sky2->speed > SPEED_100)\n\t\treg |= IPG_DATA_VAL(IPG_DATA_DEF_1000);\n\telse\n\t\treg |= IPG_DATA_VAL(IPG_DATA_DEF_10_100);\n\tgma_write16(sky2->hw, sky2->port, GM_SERIAL_MODE, reg);\n}\n\n/* Enable Rx/Tx */\nstatic void sky2_enable_rx_tx(struct sky2_port *sky2)\n{\n\tstruct sky2_hw *hw = sky2->hw;\n\tunsigned port = sky2->port;\n\tu16 reg;\n\n\treg = gma_read16(hw, port, GM_GP_CTRL);\n\treg |= GM_GPCR_RX_ENA | GM_GPCR_TX_ENA;\n\tgma_write16(hw, port, GM_GP_CTRL, reg);\n}\n\n/* Force a renegotiation */\nstatic void sky2_phy_reinit(struct sky2_port *sky2)\n{\n\tspin_lock_bh(&sky2->phy_lock);\n\tsky2_phy_init(sky2->hw, sky2->port);\n\tsky2_enable_rx_tx(sky2);\n\tspin_unlock_bh(&sky2->phy_lock);\n}\n\n/* Put device in state to listen for Wake On Lan */\nstatic void sky2_wol_init(struct sky2_port *sky2)\n{\n\tstruct sky2_hw *hw = sky2->hw;\n\tunsigned port = sky2->port;\n\tenum flow_control save_mode;\n\tu16 ctrl;\n\n\t/* Bring hardware out of reset */\n\tsky2_write16(hw, B0_CTST, CS_RST_CLR);\n\tsky2_write16(hw, SK_REG(port, GMAC_LINK_CTRL), GMLC_RST_CLR);\n\n\tsky2_write8(hw, SK_REG(port, GPHY_CTRL), GPC_RST_CLR);\n\tsky2_write8(hw, SK_REG(port, GMAC_CTRL), GMC_RST_CLR);\n\n\t/* Force to 10/100\n\t * sky2_reset will re-enable on resume\n\t */\n\tsave_mode = sky2->flow_mode;\n\tctrl = sky2->advertising;\n\n\tsky2->advertising &= ~(ADVERTISED_1000baseT_Half|ADVERTISED_1000baseT_Full);\n\tsky2->flow_mode = FC_NONE;\n\n\tspin_lock_bh(&sky2->phy_lock);\n\tsky2_phy_power_up(hw, port);\n\tsky2_phy_init(hw, port);\n\tspin_unlock_bh(&sky2->phy_lock);\n\n\tsky2->flow_mode = save_mode;\n\tsky2->advertising = ctrl;\n\n\t/* Set GMAC to no flow control and auto update for speed/duplex */\n\tgma_write16(hw, port, GM_GP_CTRL,\n\t\t    GM_GPCR_FC_TX_DIS|GM_GPCR_TX_ENA|GM_GPCR_RX_ENA|\n\t\t    GM_GPCR_DUP_FULL|GM_GPCR_FC_RX_DIS|GM_GPCR_AU_FCT_DIS);\n\n\t/* Set WOL address */\n\tmemcpy_toio(hw->regs + WOL_REGS(port, WOL_MAC_ADDR),\n\t\t    sky2->netdev->dev_addr, ETH_ALEN);\n\n\t/* Turn on appropriate WOL control bits */\n\tsky2_write16(hw, WOL_REGS(port, WOL_CTRL_STAT), WOL_CTL_CLEAR_RESULT);\n\tctrl = 0;\n\tif (sky2->wol & WAKE_PHY)\n\t\tctrl |= WOL_CTL_ENA_PME_ON_LINK_CHG|WOL_CTL_ENA_LINK_CHG_UNIT;\n\telse\n\t\tctrl |= WOL_CTL_DIS_PME_ON_LINK_CHG|WOL_CTL_DIS_LINK_CHG_UNIT;\n\n\tif (sky2->wol & WAKE_MAGIC)\n\t\tctrl |= WOL_CTL_ENA_PME_ON_MAGIC_PKT|WOL_CTL_ENA_MAGIC_PKT_UNIT;\n\telse\n\t\tctrl |= WOL_CTL_DIS_PME_ON_MAGIC_PKT|WOL_CTL_DIS_MAGIC_PKT_UNIT;\n\n\tctrl |= WOL_CTL_DIS_PME_ON_PATTERN|WOL_CTL_DIS_PATTERN_UNIT;\n\tsky2_write16(hw, WOL_REGS(port, WOL_CTRL_STAT), ctrl);\n\n\t/* Disable PiG firmware */\n\tsky2_write16(hw, B0_CTST, Y2_HW_WOL_OFF);\n\n\t/* Needed by some broken BIOSes, use PCI rather than PCI-e for WOL */\n\tif (legacy_pme) {\n\t\tu32 reg1 = sky2_pci_read32(hw, PCI_DEV_REG1);\n\t\treg1 |= PCI_Y2_PME_LEGACY;\n\t\tsky2_pci_write32(hw, PCI_DEV_REG1, reg1);\n\t}\n\n\t/* block receiver */\n\tsky2_write8(hw, SK_REG(port, RX_GMF_CTRL_T), GMF_RST_SET);\n\tsky2_read32(hw, B0_CTST);\n}\n\nstatic void sky2_set_tx_stfwd(struct sky2_hw *hw, unsigned port)\n{\n\tstruct net_device *dev = hw->dev[port];\n\n\tif ( (hw->chip_id == CHIP_ID_YUKON_EX &&\n\t      hw->chip_rev != CHIP_REV_YU_EX_A0) ||\n\t     hw->chip_id >= CHIP_ID_YUKON_FE_P) {\n\t\t/* Yukon-Extreme B0 and further Extreme devices */\n\t\tsky2_write32(hw, SK_REG(port, TX_GMF_CTRL_T), TX_STFW_ENA);\n\t} else if (dev->mtu > ETH_DATA_LEN) {\n\t\t/* set Tx GMAC FIFO Almost Empty Threshold */\n\t\tsky2_write32(hw, SK_REG(port, TX_GMF_AE_THR),\n\t\t\t     (ECU_JUMBO_WM << 16) | ECU_AE_THR);\n\n\t\tsky2_write32(hw, SK_REG(port, TX_GMF_CTRL_T), TX_STFW_DIS);\n\t} else\n\t\tsky2_write32(hw, SK_REG(port, TX_GMF_CTRL_T), TX_STFW_ENA);\n}\n\nstatic void sky2_mac_init(struct sky2_hw *hw, unsigned port)\n{\n\tstruct sky2_port *sky2 = netdev_priv(hw->dev[port]);\n\tu16 reg;\n\tu32 rx_reg;\n\tint i;\n\tconst u8 *addr = hw->dev[port]->dev_addr;\n\n\tsky2_write8(hw, SK_REG(port, GPHY_CTRL), GPC_RST_SET);\n\tsky2_write8(hw, SK_REG(port, GPHY_CTRL), GPC_RST_CLR);\n\n\tsky2_write8(hw, SK_REG(port, GMAC_CTRL), GMC_RST_CLR);\n\n\tif (hw->chip_id == CHIP_ID_YUKON_XL &&\n\t    hw->chip_rev == CHIP_REV_YU_XL_A0 &&\n\t    port == 1) {\n\t\t/* WA DEV_472 -- looks like crossed wires on port 2 */\n\t\t/* clear GMAC 1 Control reset */\n\t\tsky2_write8(hw, SK_REG(0, GMAC_CTRL), GMC_RST_CLR);\n\t\tdo {\n\t\t\tsky2_write8(hw, SK_REG(1, GMAC_CTRL), GMC_RST_SET);\n\t\t\tsky2_write8(hw, SK_REG(1, GMAC_CTRL), GMC_RST_CLR);\n\t\t} while (gm_phy_read(hw, 1, PHY_MARV_ID0) != PHY_MARV_ID0_VAL ||\n\t\t\t gm_phy_read(hw, 1, PHY_MARV_ID1) != PHY_MARV_ID1_Y2 ||\n\t\t\t gm_phy_read(hw, 1, PHY_MARV_INT_MASK) != 0);\n\t}\n\n\tsky2_read16(hw, SK_REG(port, GMAC_IRQ_SRC));\n\n\t/* Enable Transmit FIFO Underrun */\n\tsky2_write8(hw, SK_REG(port, GMAC_IRQ_MSK), GMAC_DEF_MSK);\n\n\tspin_lock_bh(&sky2->phy_lock);\n\tsky2_phy_power_up(hw, port);\n\tsky2_phy_init(hw, port);\n\tspin_unlock_bh(&sky2->phy_lock);\n\n\t/* MIB clear */\n\treg = gma_read16(hw, port, GM_PHY_ADDR);\n\tgma_write16(hw, port, GM_PHY_ADDR, reg | GM_PAR_MIB_CLR);\n\n\tfor (i = GM_MIB_CNT_BASE; i <= GM_MIB_CNT_END; i += 4)\n\t\tgma_read16(hw, port, i);\n\tgma_write16(hw, port, GM_PHY_ADDR, reg);\n\n\t/* transmit control */\n\tgma_write16(hw, port, GM_TX_CTRL, TX_COL_THR(TX_COL_DEF));\n\n\t/* receive control reg: unicast + multicast + no FCS  */\n\tgma_write16(hw, port, GM_RX_CTRL,\n\t\t    GM_RXCR_UCF_ENA | GM_RXCR_CRC_DIS | GM_RXCR_MCF_ENA);\n\n\t/* transmit flow control */\n\tgma_write16(hw, port, GM_TX_FLOW_CTRL, 0xffff);\n\n\t/* transmit parameter */\n\tgma_write16(hw, port, GM_TX_PARAM,\n\t\t    TX_JAM_LEN_VAL(TX_JAM_LEN_DEF) |\n\t\t    TX_JAM_IPG_VAL(TX_JAM_IPG_DEF) |\n\t\t    TX_IPG_JAM_DATA(TX_IPG_JAM_DEF) |\n\t\t    TX_BACK_OFF_LIM(TX_BOF_LIM_DEF));\n\n\t/* serial mode register */\n\treg = DATA_BLIND_VAL(DATA_BLIND_DEF) |\n\t\tGM_SMOD_VLAN_ENA | IPG_DATA_VAL(IPG_DATA_DEF_1000);\n\n\tif (hw->dev[port]->mtu > ETH_DATA_LEN)\n\t\treg |= GM_SMOD_JUMBO_ENA;\n\n\tif (hw->chip_id == CHIP_ID_YUKON_EC_U &&\n\t    hw->chip_rev == CHIP_REV_YU_EC_U_B1)\n\t\treg |= GM_NEW_FLOW_CTRL;\n\n\tgma_write16(hw, port, GM_SERIAL_MODE, reg);\n\n\t/* virtual address for data */\n\tgma_set_addr(hw, port, GM_SRC_ADDR_2L, addr);\n\n\t/* physical address: used for pause frames */\n\tgma_set_addr(hw, port, GM_SRC_ADDR_1L, addr);\n\n\t/* ignore counter overflows */\n\tgma_write16(hw, port, GM_TX_IRQ_MSK, 0);\n\tgma_write16(hw, port, GM_RX_IRQ_MSK, 0);\n\tgma_write16(hw, port, GM_TR_IRQ_MSK, 0);\n\n\t/* Configure Rx MAC FIFO */\n\tsky2_write8(hw, SK_REG(port, RX_GMF_CTRL_T), GMF_RST_CLR);\n\trx_reg = GMF_OPER_ON | GMF_RX_F_FL_ON;\n\tif (hw->chip_id == CHIP_ID_YUKON_EX ||\n\t    hw->chip_id == CHIP_ID_YUKON_FE_P)\n\t\trx_reg |= GMF_RX_OVER_ON;\n\n\tsky2_write32(hw, SK_REG(port, RX_GMF_CTRL_T), rx_reg);\n\n\tif (hw->chip_id == CHIP_ID_YUKON_XL) {\n\t\t/* Hardware errata - clear flush mask */\n\t\tsky2_write16(hw, SK_REG(port, RX_GMF_FL_MSK), 0);\n\t} else {\n\t\t/* Flush Rx MAC FIFO on any flow control or error */\n\t\tsky2_write16(hw, SK_REG(port, RX_GMF_FL_MSK), GMR_FS_ANY_ERR);\n\t}\n\n\t/* Set threshold to 0xa (64 bytes) + 1 to workaround pause bug  */\n\treg = RX_GMF_FL_THR_DEF + 1;\n\t/* Another magic mystery workaround from sk98lin */\n\tif (hw->chip_id == CHIP_ID_YUKON_FE_P &&\n\t    hw->chip_rev == CHIP_REV_YU_FE2_A0)\n\t\treg = 0x178;\n\tsky2_write16(hw, SK_REG(port, RX_GMF_FL_THR), reg);\n\n\t/* Configure Tx MAC FIFO */\n\tsky2_write8(hw, SK_REG(port, TX_GMF_CTRL_T), GMF_RST_CLR);\n\tsky2_write16(hw, SK_REG(port, TX_GMF_CTRL_T), GMF_OPER_ON);\n\n\t/* On chips without ram buffer, pause is controlled by MAC level */\n\tif (!(hw->flags & SKY2_HW_RAM_BUFFER)) {\n\t\t/* Pause threshold is scaled by 8 in bytes */\n\t\tif (hw->chip_id == CHIP_ID_YUKON_FE_P &&\n\t\t    hw->chip_rev == CHIP_REV_YU_FE2_A0)\n\t\t\treg = 1568 / 8;\n\t\telse\n\t\t\treg = 1024 / 8;\n\t\tsky2_write16(hw, SK_REG(port, RX_GMF_UP_THR), reg);\n\t\tsky2_write16(hw, SK_REG(port, RX_GMF_LP_THR), 768 / 8);\n\n\t\tsky2_set_tx_stfwd(hw, port);\n\t}\n\n\tif (hw->chip_id == CHIP_ID_YUKON_FE_P &&\n\t    hw->chip_rev == CHIP_REV_YU_FE2_A0) {\n\t\t/* disable dynamic watermark */\n\t\treg = sky2_read16(hw, SK_REG(port, TX_GMF_EA));\n\t\treg &= ~TX_DYN_WM_ENA;\n\t\tsky2_write16(hw, SK_REG(port, TX_GMF_EA), reg);\n\t}\n}\n\n/* Assign Ram Buffer allocation to queue */\nstatic void sky2_ramset(struct sky2_hw *hw, u16 q, u32 start, u32 space)\n{\n\tu32 end;\n\n\t/* convert from K bytes to qwords used for hw register */\n\tstart *= 1024/8;\n\tspace *= 1024/8;\n\tend = start + space - 1;\n\n\tsky2_write8(hw, RB_ADDR(q, RB_CTRL), RB_RST_CLR);\n\tsky2_write32(hw, RB_ADDR(q, RB_START), start);\n\tsky2_write32(hw, RB_ADDR(q, RB_END), end);\n\tsky2_write32(hw, RB_ADDR(q, RB_WP), start);\n\tsky2_write32(hw, RB_ADDR(q, RB_RP), start);\n\n\tif (q == Q_R1 || q == Q_R2) {\n\t\tu32 tp = space - space/4;\n\n\t\t/* On receive queue's set the thresholds\n\t\t * give receiver priority when > 3/4 full\n\t\t * send pause when down to 2K\n\t\t */\n\t\tsky2_write32(hw, RB_ADDR(q, RB_RX_UTHP), tp);\n\t\tsky2_write32(hw, RB_ADDR(q, RB_RX_LTHP), space/2);\n\n\t\ttp = space - 8192/8;\n\t\tsky2_write32(hw, RB_ADDR(q, RB_RX_UTPP), tp);\n\t\tsky2_write32(hw, RB_ADDR(q, RB_RX_LTPP), space/4);\n\t} else {\n\t\t/* Enable store & forward on Tx queue's because\n\t\t * Tx FIFO is only 1K on Yukon\n\t\t */\n\t\tsky2_write8(hw, RB_ADDR(q, RB_CTRL), RB_ENA_STFWD);\n\t}\n\n\tsky2_write8(hw, RB_ADDR(q, RB_CTRL), RB_ENA_OP_MD);\n\tsky2_read8(hw, RB_ADDR(q, RB_CTRL));\n}\n\n/* Setup Bus Memory Interface */\nstatic void sky2_qset(struct sky2_hw *hw, u16 q)\n{\n\tsky2_write32(hw, Q_ADDR(q, Q_CSR), BMU_CLR_RESET);\n\tsky2_write32(hw, Q_ADDR(q, Q_CSR), BMU_OPER_INIT);\n\tsky2_write32(hw, Q_ADDR(q, Q_CSR), BMU_FIFO_OP_ON);\n\tsky2_write32(hw, Q_ADDR(q, Q_WM),  BMU_WM_DEFAULT);\n}\n\n/* Setup prefetch unit registers. This is the interface between\n * hardware and driver list elements\n */\nstatic void sky2_prefetch_init(struct sky2_hw *hw, u32 qaddr,\n\t\t\t       dma_addr_t addr, u32 last)\n{\n\tsky2_write32(hw, Y2_QADDR(qaddr, PREF_UNIT_CTRL), PREF_UNIT_RST_SET);\n\tsky2_write32(hw, Y2_QADDR(qaddr, PREF_UNIT_CTRL), PREF_UNIT_RST_CLR);\n\tsky2_write32(hw, Y2_QADDR(qaddr, PREF_UNIT_ADDR_HI), upper_32_bits(addr));\n\tsky2_write32(hw, Y2_QADDR(qaddr, PREF_UNIT_ADDR_LO), lower_32_bits(addr));\n\tsky2_write16(hw, Y2_QADDR(qaddr, PREF_UNIT_LAST_IDX), last);\n\tsky2_write32(hw, Y2_QADDR(qaddr, PREF_UNIT_CTRL), PREF_UNIT_OP_ON);\n\n\tsky2_read32(hw, Y2_QADDR(qaddr, PREF_UNIT_CTRL));\n}\n\nstatic inline struct sky2_tx_le *get_tx_le(struct sky2_port *sky2, u16 *slot)\n{\n\tstruct sky2_tx_le *le = sky2->tx_le + *slot;\n\n\t*slot = RING_NEXT(*slot, sky2->tx_ring_size);\n\tle->ctrl = 0;\n\treturn le;\n}\n\nstatic void tx_init(struct sky2_port *sky2)\n{\n\tstruct sky2_tx_le *le;\n\n\tsky2->tx_prod = sky2->tx_cons = 0;\n\tsky2->tx_tcpsum = 0;\n\tsky2->tx_last_mss = 0;\n\tnetdev_reset_queue(sky2->netdev);\n\n\tle = get_tx_le(sky2, &sky2->tx_prod);\n\tle->addr = 0;\n\tle->opcode = OP_ADDR64 | HW_OWNER;\n\tsky2->tx_last_upper = 0;\n}\n\n/* Update chip's next pointer */\nstatic inline void sky2_put_idx(struct sky2_hw *hw, unsigned q, u16 idx)\n{\n\t/* Make sure write' to descriptors are complete before we tell hardware */\n\twmb();\n\tsky2_write16(hw, Y2_QADDR(q, PREF_UNIT_PUT_IDX), idx);\n}\n\n\nstatic inline struct sky2_rx_le *sky2_next_rx(struct sky2_port *sky2)\n{\n\tstruct sky2_rx_le *le = sky2->rx_le + sky2->rx_put;\n\tsky2->rx_put = RING_NEXT(sky2->rx_put, RX_LE_SIZE);\n\tle->ctrl = 0;\n\treturn le;\n}\n\nstatic unsigned sky2_get_rx_threshold(struct sky2_port *sky2)\n{\n\tunsigned size;\n\n\t/* Space needed for frame data + headers rounded up */\n\tsize = roundup(sky2->netdev->mtu + ETH_HLEN + VLAN_HLEN, 8);\n\n\t/* Stopping point for hardware truncation */\n\treturn (size - 8) / sizeof(u32);\n}\n\nstatic unsigned sky2_get_rx_data_size(struct sky2_port *sky2)\n{\n\tstruct rx_ring_info *re;\n\tunsigned size;\n\n\t/* Space needed for frame data + headers rounded up */\n\tsize = roundup(sky2->netdev->mtu + ETH_HLEN + VLAN_HLEN, 8);\n\n\tsky2->rx_nfrags = size >> PAGE_SHIFT;\n\tBUG_ON(sky2->rx_nfrags > ARRAY_SIZE(re->frag_addr));\n\n\t/* Compute residue after pages */\n\tsize -= sky2->rx_nfrags << PAGE_SHIFT;\n\n\t/* Optimize to handle small packets and headers */\n\tif (size < copybreak)\n\t\tsize = copybreak;\n\tif (size < ETH_HLEN)\n\t\tsize = ETH_HLEN;\n\n\treturn size;\n}\n\n/* Build description to hardware for one receive segment */\nstatic void sky2_rx_add(struct sky2_port *sky2, u8 op,\n\t\t\tdma_addr_t map, unsigned len)\n{\n\tstruct sky2_rx_le *le;\n\n\tif (sizeof(dma_addr_t) > sizeof(u32)) {\n\t\tle = sky2_next_rx(sky2);\n\t\tle->addr = cpu_to_le32(upper_32_bits(map));\n\t\tle->opcode = OP_ADDR64 | HW_OWNER;\n\t}\n\n\tle = sky2_next_rx(sky2);\n\tle->addr = cpu_to_le32(lower_32_bits(map));\n\tle->length = cpu_to_le16(len);\n\tle->opcode = op | HW_OWNER;\n}\n\n/* Build description to hardware for one possibly fragmented skb */\nstatic void sky2_rx_submit(struct sky2_port *sky2,\n\t\t\t   const struct rx_ring_info *re)\n{\n\tint i;\n\n\tsky2_rx_add(sky2, OP_PACKET, re->data_addr, sky2->rx_data_size);\n\n\tfor (i = 0; i < skb_shinfo(re->skb)->nr_frags; i++)\n\t\tsky2_rx_add(sky2, OP_BUFFER, re->frag_addr[i], PAGE_SIZE);\n}\n\n\nstatic int sky2_rx_map_skb(struct pci_dev *pdev, struct rx_ring_info *re,\n\t\t\t    unsigned size)\n{\n\tstruct sk_buff *skb = re->skb;\n\tint i;\n\n\tre->data_addr = dma_map_single(&pdev->dev, skb->data, size,\n\t\t\t\t       DMA_FROM_DEVICE);\n\tif (dma_mapping_error(&pdev->dev, re->data_addr))\n\t\tgoto mapping_error;\n\n\tdma_unmap_len_set(re, data_size, size);\n\n\tfor (i = 0; i < skb_shinfo(skb)->nr_frags; i++) {\n\t\tconst skb_frag_t *frag = &skb_shinfo(skb)->frags[i];\n\n\t\tre->frag_addr[i] = skb_frag_dma_map(&pdev->dev, frag, 0,\n\t\t\t\t\t\t    skb_frag_size(frag),\n\t\t\t\t\t\t    DMA_FROM_DEVICE);\n\n\t\tif (dma_mapping_error(&pdev->dev, re->frag_addr[i]))\n\t\t\tgoto map_page_error;\n\t}\n\treturn 0;\n\nmap_page_error:\n\twhile (--i >= 0) {\n\t\tdma_unmap_page(&pdev->dev, re->frag_addr[i],\n\t\t\t       skb_frag_size(&skb_shinfo(skb)->frags[i]),\n\t\t\t       DMA_FROM_DEVICE);\n\t}\n\n\tdma_unmap_single(&pdev->dev, re->data_addr,\n\t\t\t dma_unmap_len(re, data_size), DMA_FROM_DEVICE);\n\nmapping_error:\n\tif (net_ratelimit())\n\t\tdev_warn(&pdev->dev, \"%s: rx mapping error\\n\",\n\t\t\t skb->dev->name);\n\treturn -EIO;\n}\n\nstatic void sky2_rx_unmap_skb(struct pci_dev *pdev, struct rx_ring_info *re)\n{\n\tstruct sk_buff *skb = re->skb;\n\tint i;\n\n\tdma_unmap_single(&pdev->dev, re->data_addr,\n\t\t\t dma_unmap_len(re, data_size), DMA_FROM_DEVICE);\n\n\tfor (i = 0; i < skb_shinfo(skb)->nr_frags; i++)\n\t\tdma_unmap_page(&pdev->dev, re->frag_addr[i],\n\t\t\t       skb_frag_size(&skb_shinfo(skb)->frags[i]),\n\t\t\t       DMA_FROM_DEVICE);\n}\n\n/* Tell chip where to start receive checksum.\n * Actually has two checksums, but set both same to avoid possible byte\n * order problems.\n */\nstatic void rx_set_checksum(struct sky2_port *sky2)\n{\n\tstruct sky2_rx_le *le = sky2_next_rx(sky2);\n\n\tle->addr = cpu_to_le32((ETH_HLEN << 16) | ETH_HLEN);\n\tle->ctrl = 0;\n\tle->opcode = OP_TCPSTART | HW_OWNER;\n\n\tsky2_write32(sky2->hw,\n\t\t     Q_ADDR(rxqaddr[sky2->port], Q_CSR),\n\t\t     (sky2->netdev->features & NETIF_F_RXCSUM)\n\t\t     ? BMU_ENA_RX_CHKSUM : BMU_DIS_RX_CHKSUM);\n}\n\n/* Enable/disable receive hash calculation (RSS) */\nstatic void rx_set_rss(struct net_device *dev, netdev_features_t features)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tstruct sky2_hw *hw = sky2->hw;\n\tint i, nkeys = 4;\n\n\t/* Supports IPv6 and other modes */\n\tif (hw->flags & SKY2_HW_NEW_LE) {\n\t\tnkeys = 10;\n\t\tsky2_write32(hw, SK_REG(sky2->port, RSS_CFG), HASH_ALL);\n\t}\n\n\t/* Program RSS initial values */\n\tif (features & NETIF_F_RXHASH) {\n\t\tu32 rss_key[10];\n\n\t\tnetdev_rss_key_fill(rss_key, sizeof(rss_key));\n\t\tfor (i = 0; i < nkeys; i++)\n\t\t\tsky2_write32(hw, SK_REG(sky2->port, RSS_KEY + i * 4),\n\t\t\t\t     rss_key[i]);\n\n\t\t/* Need to turn on (undocumented) flag to make hashing work  */\n\t\tsky2_write32(hw, SK_REG(sky2->port, RX_GMF_CTRL_T),\n\t\t\t     RX_STFW_ENA);\n\n\t\tsky2_write32(hw, Q_ADDR(rxqaddr[sky2->port], Q_CSR),\n\t\t\t     BMU_ENA_RX_RSS_HASH);\n\t} else\n\t\tsky2_write32(hw, Q_ADDR(rxqaddr[sky2->port], Q_CSR),\n\t\t\t     BMU_DIS_RX_RSS_HASH);\n}\n\n/*\n * The RX Stop command will not work for Yukon-2 if the BMU does not\n * reach the end of packet and since we can't make sure that we have\n * incoming data, we must reset the BMU while it is not doing a DMA\n * transfer. Since it is possible that the RX path is still active,\n * the RX RAM buffer will be stopped first, so any possible incoming\n * data will not trigger a DMA. After the RAM buffer is stopped, the\n * BMU is polled until any DMA in progress is ended and only then it\n * will be reset.\n */\nstatic void sky2_rx_stop(struct sky2_port *sky2)\n{\n\tstruct sky2_hw *hw = sky2->hw;\n\tunsigned rxq = rxqaddr[sky2->port];\n\tint i;\n\n\t/* disable the RAM Buffer receive queue */\n\tsky2_write8(hw, RB_ADDR(rxq, RB_CTRL), RB_DIS_OP_MD);\n\n\tfor (i = 0; i < 0xffff; i++)\n\t\tif (sky2_read8(hw, RB_ADDR(rxq, Q_RSL))\n\t\t    == sky2_read8(hw, RB_ADDR(rxq, Q_RL)))\n\t\t\tgoto stopped;\n\n\tnetdev_warn(sky2->netdev, \"receiver stop failed\\n\");\nstopped:\n\tsky2_write32(hw, Q_ADDR(rxq, Q_CSR), BMU_RST_SET | BMU_FIFO_RST);\n\n\t/* reset the Rx prefetch unit */\n\tsky2_write32(hw, Y2_QADDR(rxq, PREF_UNIT_CTRL), PREF_UNIT_RST_SET);\n}\n\n/* Clean out receive buffer area, assumes receiver hardware stopped */\nstatic void sky2_rx_clean(struct sky2_port *sky2)\n{\n\tunsigned i;\n\n\tif (sky2->rx_le)\n\t\tmemset(sky2->rx_le, 0, RX_LE_BYTES);\n\n\tfor (i = 0; i < sky2->rx_pending; i++) {\n\t\tstruct rx_ring_info *re = sky2->rx_ring + i;\n\n\t\tif (re->skb) {\n\t\t\tsky2_rx_unmap_skb(sky2->hw->pdev, re);\n\t\t\tkfree_skb(re->skb);\n\t\t\tre->skb = NULL;\n\t\t}\n\t}\n}\n\n/* Basic MII support */\nstatic int sky2_ioctl(struct net_device *dev, struct ifreq *ifr, int cmd)\n{\n\tstruct mii_ioctl_data *data = if_mii(ifr);\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tstruct sky2_hw *hw = sky2->hw;\n\tint err = -EOPNOTSUPP;\n\n\tif (!netif_running(dev))\n\t\treturn -ENODEV;\t/* Phy still in reset */\n\n\tswitch (cmd) {\n\tcase SIOCGMIIPHY:\n\t\tdata->phy_id = PHY_ADDR_MARV;\n\n\t\tfallthrough;\n\tcase SIOCGMIIREG: {\n\t\tu16 val = 0;\n\n\t\tspin_lock_bh(&sky2->phy_lock);\n\t\terr = __gm_phy_read(hw, sky2->port, data->reg_num & 0x1f, &val);\n\t\tspin_unlock_bh(&sky2->phy_lock);\n\n\t\tdata->val_out = val;\n\t\tbreak;\n\t}\n\n\tcase SIOCSMIIREG:\n\t\tspin_lock_bh(&sky2->phy_lock);\n\t\terr = gm_phy_write(hw, sky2->port, data->reg_num & 0x1f,\n\t\t\t\t   data->val_in);\n\t\tspin_unlock_bh(&sky2->phy_lock);\n\t\tbreak;\n\t}\n\treturn err;\n}\n\n#define SKY2_VLAN_OFFLOADS (NETIF_F_IP_CSUM | NETIF_F_SG | NETIF_F_TSO)\n\nstatic void sky2_vlan_mode(struct net_device *dev, netdev_features_t features)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tstruct sky2_hw *hw = sky2->hw;\n\tu16 port = sky2->port;\n\n\tif (features & NETIF_F_HW_VLAN_CTAG_RX)\n\t\tsky2_write32(hw, SK_REG(port, RX_GMF_CTRL_T),\n\t\t\t     RX_VLAN_STRIP_ON);\n\telse\n\t\tsky2_write32(hw, SK_REG(port, RX_GMF_CTRL_T),\n\t\t\t     RX_VLAN_STRIP_OFF);\n\n\tif (features & NETIF_F_HW_VLAN_CTAG_TX) {\n\t\tsky2_write32(hw, SK_REG(port, TX_GMF_CTRL_T),\n\t\t\t     TX_VLAN_TAG_ON);\n\n\t\tdev->vlan_features |= SKY2_VLAN_OFFLOADS;\n\t} else {\n\t\tsky2_write32(hw, SK_REG(port, TX_GMF_CTRL_T),\n\t\t\t     TX_VLAN_TAG_OFF);\n\n\t\t/* Can't do transmit offload of vlan without hw vlan */\n\t\tdev->vlan_features &= ~SKY2_VLAN_OFFLOADS;\n\t}\n}\n\n/* Amount of required worst case padding in rx buffer */\nstatic inline unsigned sky2_rx_pad(const struct sky2_hw *hw)\n{\n\treturn (hw->flags & SKY2_HW_RAM_BUFFER) ? 8 : 2;\n}\n\n/*\n * Allocate an skb for receiving. If the MTU is large enough\n * make the skb non-linear with a fragment list of pages.\n */\nstatic struct sk_buff *sky2_rx_alloc(struct sky2_port *sky2, gfp_t gfp)\n{\n\tstruct sk_buff *skb;\n\tint i;\n\n\tskb = __netdev_alloc_skb(sky2->netdev,\n\t\t\t\t sky2->rx_data_size + sky2_rx_pad(sky2->hw),\n\t\t\t\t gfp);\n\tif (!skb)\n\t\tgoto nomem;\n\n\tif (sky2->hw->flags & SKY2_HW_RAM_BUFFER) {\n\t\tunsigned char *start;\n\t\t/*\n\t\t * Workaround for a bug in FIFO that cause hang\n\t\t * if the FIFO if the receive buffer is not 64 byte aligned.\n\t\t * The buffer returned from netdev_alloc_skb is\n\t\t * aligned except if slab debugging is enabled.\n\t\t */\n\t\tstart = PTR_ALIGN(skb->data, 8);\n\t\tskb_reserve(skb, start - skb->data);\n\t} else\n\t\tskb_reserve(skb, NET_IP_ALIGN);\n\n\tfor (i = 0; i < sky2->rx_nfrags; i++) {\n\t\tstruct page *page = alloc_page(gfp);\n\n\t\tif (!page)\n\t\t\tgoto free_partial;\n\t\tskb_fill_page_desc(skb, i, page, 0, PAGE_SIZE);\n\t}\n\n\treturn skb;\nfree_partial:\n\tkfree_skb(skb);\nnomem:\n\treturn NULL;\n}\n\nstatic inline void sky2_rx_update(struct sky2_port *sky2, unsigned rxq)\n{\n\tsky2_put_idx(sky2->hw, rxq, sky2->rx_put);\n}\n\nstatic int sky2_alloc_rx_skbs(struct sky2_port *sky2)\n{\n\tstruct sky2_hw *hw = sky2->hw;\n\tunsigned i;\n\n\tsky2->rx_data_size = sky2_get_rx_data_size(sky2);\n\n\t/* Fill Rx ring */\n\tfor (i = 0; i < sky2->rx_pending; i++) {\n\t\tstruct rx_ring_info *re = sky2->rx_ring + i;\n\n\t\tre->skb = sky2_rx_alloc(sky2, GFP_KERNEL);\n\t\tif (!re->skb)\n\t\t\treturn -ENOMEM;\n\n\t\tif (sky2_rx_map_skb(hw->pdev, re, sky2->rx_data_size)) {\n\t\t\tdev_kfree_skb(re->skb);\n\t\t\tre->skb = NULL;\n\t\t\treturn -ENOMEM;\n\t\t}\n\t}\n\treturn 0;\n}\n\n/*\n * Setup receiver buffer pool.\n * Normal case this ends up creating one list element for skb\n * in the receive ring. Worst case if using large MTU and each\n * allocation falls on a different 64 bit region, that results\n * in 6 list elements per ring entry.\n * One element is used for checksum enable/disable, and one\n * extra to avoid wrap.\n */\nstatic void sky2_rx_start(struct sky2_port *sky2)\n{\n\tstruct sky2_hw *hw = sky2->hw;\n\tstruct rx_ring_info *re;\n\tunsigned rxq = rxqaddr[sky2->port];\n\tunsigned i, thresh;\n\n\tsky2->rx_put = sky2->rx_next = 0;\n\tsky2_qset(hw, rxq);\n\n\t/* On PCI express lowering the watermark gives better performance */\n\tif (pci_is_pcie(hw->pdev))\n\t\tsky2_write32(hw, Q_ADDR(rxq, Q_WM), BMU_WM_PEX);\n\n\t/* These chips have no ram buffer?\n\t * MAC Rx RAM Read is controlled by hardware */\n\tif (hw->chip_id == CHIP_ID_YUKON_EC_U &&\n\t    hw->chip_rev > CHIP_REV_YU_EC_U_A0)\n\t\tsky2_write32(hw, Q_ADDR(rxq, Q_TEST), F_M_RX_RAM_DIS);\n\n\tsky2_prefetch_init(hw, rxq, sky2->rx_le_map, RX_LE_SIZE - 1);\n\n\tif (!(hw->flags & SKY2_HW_NEW_LE))\n\t\trx_set_checksum(sky2);\n\n\tif (!(hw->flags & SKY2_HW_RSS_BROKEN))\n\t\trx_set_rss(sky2->netdev, sky2->netdev->features);\n\n\t/* submit Rx ring */\n\tfor (i = 0; i < sky2->rx_pending; i++) {\n\t\tre = sky2->rx_ring + i;\n\t\tsky2_rx_submit(sky2, re);\n\t}\n\n\t/*\n\t * The receiver hangs if it receives frames larger than the\n\t * packet buffer. As a workaround, truncate oversize frames, but\n\t * the register is limited to 9 bits, so if you do frames > 2052\n\t * you better get the MTU right!\n\t */\n\tthresh = sky2_get_rx_threshold(sky2);\n\tif (thresh > 0x1ff)\n\t\tsky2_write32(hw, SK_REG(sky2->port, RX_GMF_CTRL_T), RX_TRUNC_OFF);\n\telse {\n\t\tsky2_write16(hw, SK_REG(sky2->port, RX_GMF_TR_THR), thresh);\n\t\tsky2_write32(hw, SK_REG(sky2->port, RX_GMF_CTRL_T), RX_TRUNC_ON);\n\t}\n\n\t/* Tell chip about available buffers */\n\tsky2_rx_update(sky2, rxq);\n\n\tif (hw->chip_id == CHIP_ID_YUKON_EX ||\n\t    hw->chip_id == CHIP_ID_YUKON_SUPR) {\n\t\t/*\n\t\t * Disable flushing of non ASF packets;\n\t\t * must be done after initializing the BMUs;\n\t\t * drivers without ASF support should do this too, otherwise\n\t\t * it may happen that they cannot run on ASF devices;\n\t\t * remember that the MAC FIFO isn't reset during initialization.\n\t\t */\n\t\tsky2_write32(hw, SK_REG(sky2->port, RX_GMF_CTRL_T), RX_MACSEC_FLUSH_OFF);\n\t}\n\n\tif (hw->chip_id >= CHIP_ID_YUKON_SUPR) {\n\t\t/* Enable RX Home Address & Routing Header checksum fix */\n\t\tsky2_write16(hw, SK_REG(sky2->port, RX_GMF_FL_CTRL),\n\t\t\t     RX_IPV6_SA_MOB_ENA | RX_IPV6_DA_MOB_ENA);\n\n\t\t/* Enable TX Home Address & Routing Header checksum fix */\n\t\tsky2_write32(hw, Q_ADDR(txqaddr[sky2->port], Q_TEST),\n\t\t\t     TBMU_TEST_HOME_ADD_FIX_EN | TBMU_TEST_ROUTING_ADD_FIX_EN);\n\t}\n}\n\nstatic int sky2_alloc_buffers(struct sky2_port *sky2)\n{\n\tstruct sky2_hw *hw = sky2->hw;\n\n\t/* must be power of 2 */\n\tsky2->tx_le = dma_alloc_coherent(&hw->pdev->dev,\n\t\t\t\t\t sky2->tx_ring_size * sizeof(struct sky2_tx_le),\n\t\t\t\t\t &sky2->tx_le_map, GFP_KERNEL);\n\tif (!sky2->tx_le)\n\t\tgoto nomem;\n\n\tsky2->tx_ring = kcalloc(sky2->tx_ring_size, sizeof(struct tx_ring_info),\n\t\t\t\tGFP_KERNEL);\n\tif (!sky2->tx_ring)\n\t\tgoto nomem;\n\n\tsky2->rx_le = dma_alloc_coherent(&hw->pdev->dev, RX_LE_BYTES,\n\t\t\t\t\t &sky2->rx_le_map, GFP_KERNEL);\n\tif (!sky2->rx_le)\n\t\tgoto nomem;\n\n\tsky2->rx_ring = kcalloc(sky2->rx_pending, sizeof(struct rx_ring_info),\n\t\t\t\tGFP_KERNEL);\n\tif (!sky2->rx_ring)\n\t\tgoto nomem;\n\n\treturn sky2_alloc_rx_skbs(sky2);\nnomem:\n\treturn -ENOMEM;\n}\n\nstatic void sky2_free_buffers(struct sky2_port *sky2)\n{\n\tstruct sky2_hw *hw = sky2->hw;\n\n\tsky2_rx_clean(sky2);\n\n\tif (sky2->rx_le) {\n\t\tdma_free_coherent(&hw->pdev->dev, RX_LE_BYTES, sky2->rx_le,\n\t\t\t\t  sky2->rx_le_map);\n\t\tsky2->rx_le = NULL;\n\t}\n\tif (sky2->tx_le) {\n\t\tdma_free_coherent(&hw->pdev->dev,\n\t\t\t\t  sky2->tx_ring_size * sizeof(struct sky2_tx_le),\n\t\t\t\t  sky2->tx_le, sky2->tx_le_map);\n\t\tsky2->tx_le = NULL;\n\t}\n\tkfree(sky2->tx_ring);\n\tkfree(sky2->rx_ring);\n\n\tsky2->tx_ring = NULL;\n\tsky2->rx_ring = NULL;\n}\n\nstatic void sky2_hw_up(struct sky2_port *sky2)\n{\n\tstruct sky2_hw *hw = sky2->hw;\n\tunsigned port = sky2->port;\n\tu32 ramsize;\n\tint cap;\n\tstruct net_device *otherdev = hw->dev[sky2->port^1];\n\n\ttx_init(sky2);\n\n\t/*\n \t * On dual port PCI-X card, there is an problem where status\n\t * can be received out of order due to split transactions\n\t */\n\tif (otherdev && netif_running(otherdev) &&\n \t    (cap = pci_find_capability(hw->pdev, PCI_CAP_ID_PCIX))) {\n \t\tu16 cmd;\n\n\t\tcmd = sky2_pci_read16(hw, cap + PCI_X_CMD);\n \t\tcmd &= ~PCI_X_CMD_MAX_SPLIT;\n \t\tsky2_pci_write16(hw, cap + PCI_X_CMD, cmd);\n\t}\n\n\tsky2_mac_init(hw, port);\n\n\t/* Register is number of 4K blocks on internal RAM buffer. */\n\tramsize = sky2_read8(hw, B2_E_0) * 4;\n\tif (ramsize > 0) {\n\t\tu32 rxspace;\n\n\t\tnetdev_dbg(sky2->netdev, \"ram buffer %dK\\n\", ramsize);\n\t\tif (ramsize < 16)\n\t\t\trxspace = ramsize / 2;\n\t\telse\n\t\t\trxspace = 8 + (2*(ramsize - 16))/3;\n\n\t\tsky2_ramset(hw, rxqaddr[port], 0, rxspace);\n\t\tsky2_ramset(hw, txqaddr[port], rxspace, ramsize - rxspace);\n\n\t\t/* Make sure SyncQ is disabled */\n\t\tsky2_write8(hw, RB_ADDR(port == 0 ? Q_XS1 : Q_XS2, RB_CTRL),\n\t\t\t    RB_RST_SET);\n\t}\n\n\tsky2_qset(hw, txqaddr[port]);\n\n\t/* This is copied from sk98lin 10.0.5.3; no one tells me about erratta's */\n\tif (hw->chip_id == CHIP_ID_YUKON_EX && hw->chip_rev == CHIP_REV_YU_EX_B0)\n\t\tsky2_write32(hw, Q_ADDR(txqaddr[port], Q_TEST), F_TX_CHK_AUTO_OFF);\n\n\t/* Set almost empty threshold */\n\tif (hw->chip_id == CHIP_ID_YUKON_EC_U &&\n\t    hw->chip_rev == CHIP_REV_YU_EC_U_A0)\n\t\tsky2_write16(hw, Q_ADDR(txqaddr[port], Q_AL), ECU_TXFF_LEV);\n\n\tsky2_prefetch_init(hw, txqaddr[port], sky2->tx_le_map,\n\t\t\t   sky2->tx_ring_size - 1);\n\n\tsky2_vlan_mode(sky2->netdev, sky2->netdev->features);\n\tnetdev_update_features(sky2->netdev);\n\n\tsky2_rx_start(sky2);\n}\n\n/* Setup device IRQ and enable napi to process */\nstatic int sky2_setup_irq(struct sky2_hw *hw, const char *name)\n{\n\tstruct pci_dev *pdev = hw->pdev;\n\tint err;\n\n\terr = request_irq(pdev->irq, sky2_intr,\n\t\t\t  (hw->flags & SKY2_HW_USE_MSI) ? 0 : IRQF_SHARED,\n\t\t\t  name, hw);\n\tif (err)\n\t\tdev_err(&pdev->dev, \"cannot assign irq %d\\n\", pdev->irq);\n\telse {\n\t\thw->flags |= SKY2_HW_IRQ_SETUP;\n\n\t\tnapi_enable(&hw->napi);\n\t\tsky2_write32(hw, B0_IMSK, Y2_IS_BASE);\n\t\tsky2_read32(hw, B0_IMSK);\n\t}\n\n\treturn err;\n}\n\n\n/* Bring up network interface. */\nstatic int sky2_open(struct net_device *dev)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tstruct sky2_hw *hw = sky2->hw;\n\tunsigned port = sky2->port;\n\tu32 imask;\n\tint err;\n\n\tnetif_carrier_off(dev);\n\n\terr = sky2_alloc_buffers(sky2);\n\tif (err)\n\t\tgoto err_out;\n\n\t/* With single port, IRQ is setup when device is brought up */\n\tif (hw->ports == 1 && (err = sky2_setup_irq(hw, dev->name)))\n\t\tgoto err_out;\n\n\tsky2_hw_up(sky2);\n\n\t/* Enable interrupts from phy/mac for port */\n\timask = sky2_read32(hw, B0_IMSK);\n\n\tif (hw->chip_id == CHIP_ID_YUKON_OPT ||\n\t    hw->chip_id == CHIP_ID_YUKON_PRM ||\n\t    hw->chip_id == CHIP_ID_YUKON_OP_2)\n\t\timask |= Y2_IS_PHY_QLNK;\t/* enable PHY Quick Link */\n\n\timask |= portirq_msk[port];\n\tsky2_write32(hw, B0_IMSK, imask);\n\tsky2_read32(hw, B0_IMSK);\n\n\tnetif_info(sky2, ifup, dev, \"enabling interface\\n\");\n\n\treturn 0;\n\nerr_out:\n\tsky2_free_buffers(sky2);\n\treturn err;\n}\n\n/* Modular subtraction in ring */\nstatic inline int tx_inuse(const struct sky2_port *sky2)\n{\n\treturn (sky2->tx_prod - sky2->tx_cons) & (sky2->tx_ring_size - 1);\n}\n\n/* Number of list elements available for next tx */\nstatic inline int tx_avail(const struct sky2_port *sky2)\n{\n\treturn sky2->tx_pending - tx_inuse(sky2);\n}\n\n/* Estimate of number of transmit list elements required */\nstatic unsigned tx_le_req(const struct sk_buff *skb)\n{\n\tunsigned count;\n\n\tcount = (skb_shinfo(skb)->nr_frags + 1)\n\t\t* (sizeof(dma_addr_t) / sizeof(u32));\n\n\tif (skb_is_gso(skb))\n\t\t++count;\n\telse if (sizeof(dma_addr_t) == sizeof(u32))\n\t\t++count;\t/* possible vlan */\n\n\tif (skb->ip_summed == CHECKSUM_PARTIAL)\n\t\t++count;\n\n\treturn count;\n}\n\nstatic void sky2_tx_unmap(struct pci_dev *pdev, struct tx_ring_info *re)\n{\n\tif (re->flags & TX_MAP_SINGLE)\n\t\tdma_unmap_single(&pdev->dev, dma_unmap_addr(re, mapaddr),\n\t\t\t\t dma_unmap_len(re, maplen), DMA_TO_DEVICE);\n\telse if (re->flags & TX_MAP_PAGE)\n\t\tdma_unmap_page(&pdev->dev, dma_unmap_addr(re, mapaddr),\n\t\t\t       dma_unmap_len(re, maplen), DMA_TO_DEVICE);\n\tre->flags = 0;\n}\n\n/*\n * Put one packet in ring for transmit.\n * A single packet can generate multiple list elements, and\n * the number of ring elements will probably be less than the number\n * of list elements used.\n */\nstatic netdev_tx_t sky2_xmit_frame(struct sk_buff *skb,\n\t\t\t\t   struct net_device *dev)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tstruct sky2_hw *hw = sky2->hw;\n\tstruct sky2_tx_le *le = NULL;\n\tstruct tx_ring_info *re;\n\tunsigned i, len;\n\tdma_addr_t mapping;\n\tu32 upper;\n\tu16 slot;\n\tu16 mss;\n\tu8 ctrl;\n\n \tif (unlikely(tx_avail(sky2) < tx_le_req(skb)))\n  \t\treturn NETDEV_TX_BUSY;\n\n\tlen = skb_headlen(skb);\n\tmapping = dma_map_single(&hw->pdev->dev, skb->data, len,\n\t\t\t\t DMA_TO_DEVICE);\n\n\tif (dma_mapping_error(&hw->pdev->dev, mapping))\n\t\tgoto mapping_error;\n\n\tslot = sky2->tx_prod;\n\tnetif_printk(sky2, tx_queued, KERN_DEBUG, dev,\n\t\t     \"tx queued, slot %u, len %d\\n\", slot, skb->len);\n\n\t/* Send high bits if needed */\n\tupper = upper_32_bits(mapping);\n\tif (upper != sky2->tx_last_upper) {\n\t\tle = get_tx_le(sky2, &slot);\n\t\tle->addr = cpu_to_le32(upper);\n\t\tsky2->tx_last_upper = upper;\n\t\tle->opcode = OP_ADDR64 | HW_OWNER;\n\t}\n\n\t/* Check for TCP Segmentation Offload */\n\tmss = skb_shinfo(skb)->gso_size;\n\tif (mss != 0) {\n\n\t\tif (!(hw->flags & SKY2_HW_NEW_LE))\n\t\t\tmss += ETH_HLEN + ip_hdrlen(skb) + tcp_hdrlen(skb);\n\n  \t\tif (mss != sky2->tx_last_mss) {\n\t\t\tle = get_tx_le(sky2, &slot);\n  \t\t\tle->addr = cpu_to_le32(mss);\n\n\t\t\tif (hw->flags & SKY2_HW_NEW_LE)\n\t\t\t\tle->opcode = OP_MSS | HW_OWNER;\n\t\t\telse\n\t\t\t\tle->opcode = OP_LRGLEN | HW_OWNER;\n\t\t\tsky2->tx_last_mss = mss;\n\t\t}\n\t}\n\n\tctrl = 0;\n\n\t/* Add VLAN tag, can piggyback on LRGLEN or ADDR64 */\n\tif (skb_vlan_tag_present(skb)) {\n\t\tif (!le) {\n\t\t\tle = get_tx_le(sky2, &slot);\n\t\t\tle->addr = 0;\n\t\t\tle->opcode = OP_VLAN|HW_OWNER;\n\t\t} else\n\t\t\tle->opcode |= OP_VLAN;\n\t\tle->length = cpu_to_be16(skb_vlan_tag_get(skb));\n\t\tctrl |= INS_VLAN;\n\t}\n\n\t/* Handle TCP checksum offload */\n\tif (skb->ip_summed == CHECKSUM_PARTIAL) {\n\t\t/* On Yukon EX (some versions) encoding change. */\n \t\tif (hw->flags & SKY2_HW_AUTO_TX_SUM)\n \t\t\tctrl |= CALSUM;\t/* auto checksum */\n\t\telse {\n\t\t\tconst unsigned offset = skb_transport_offset(skb);\n\t\t\tu32 tcpsum;\n\n\t\t\ttcpsum = offset << 16;\t\t\t/* sum start */\n\t\t\ttcpsum |= offset + skb->csum_offset;\t/* sum write */\n\n\t\t\tctrl |= CALSUM | WR_SUM | INIT_SUM | LOCK_SUM;\n\t\t\tif (ip_hdr(skb)->protocol == IPPROTO_UDP)\n\t\t\t\tctrl |= UDPTCP;\n\n\t\t\tif (tcpsum != sky2->tx_tcpsum) {\n\t\t\t\tsky2->tx_tcpsum = tcpsum;\n\n\t\t\t\tle = get_tx_le(sky2, &slot);\n\t\t\t\tle->addr = cpu_to_le32(tcpsum);\n\t\t\t\tle->length = 0;\t/* initial checksum value */\n\t\t\t\tle->ctrl = 1;\t/* one packet */\n\t\t\t\tle->opcode = OP_TCPLISW | HW_OWNER;\n\t\t\t}\n\t\t}\n\t}\n\n\tre = sky2->tx_ring + slot;\n\tre->flags = TX_MAP_SINGLE;\n\tdma_unmap_addr_set(re, mapaddr, mapping);\n\tdma_unmap_len_set(re, maplen, len);\n\n\tle = get_tx_le(sky2, &slot);\n\tle->addr = cpu_to_le32(lower_32_bits(mapping));\n\tle->length = cpu_to_le16(len);\n\tle->ctrl = ctrl;\n\tle->opcode = mss ? (OP_LARGESEND | HW_OWNER) : (OP_PACKET | HW_OWNER);\n\n\n\tfor (i = 0; i < skb_shinfo(skb)->nr_frags; i++) {\n\t\tconst skb_frag_t *frag = &skb_shinfo(skb)->frags[i];\n\n\t\tmapping = skb_frag_dma_map(&hw->pdev->dev, frag, 0,\n\t\t\t\t\t   skb_frag_size(frag), DMA_TO_DEVICE);\n\n\t\tif (dma_mapping_error(&hw->pdev->dev, mapping))\n\t\t\tgoto mapping_unwind;\n\n\t\tupper = upper_32_bits(mapping);\n\t\tif (upper != sky2->tx_last_upper) {\n\t\t\tle = get_tx_le(sky2, &slot);\n\t\t\tle->addr = cpu_to_le32(upper);\n\t\t\tsky2->tx_last_upper = upper;\n\t\t\tle->opcode = OP_ADDR64 | HW_OWNER;\n\t\t}\n\n\t\tre = sky2->tx_ring + slot;\n\t\tre->flags = TX_MAP_PAGE;\n\t\tdma_unmap_addr_set(re, mapaddr, mapping);\n\t\tdma_unmap_len_set(re, maplen, skb_frag_size(frag));\n\n\t\tle = get_tx_le(sky2, &slot);\n\t\tle->addr = cpu_to_le32(lower_32_bits(mapping));\n\t\tle->length = cpu_to_le16(skb_frag_size(frag));\n\t\tle->ctrl = ctrl;\n\t\tle->opcode = OP_BUFFER | HW_OWNER;\n\t}\n\n\tre->skb = skb;\n\tle->ctrl |= EOP;\n\n\tsky2->tx_prod = slot;\n\n\tif (tx_avail(sky2) <= MAX_SKB_TX_LE)\n\t\tnetif_stop_queue(dev);\n\n\tnetdev_sent_queue(dev, skb->len);\n\tsky2_put_idx(hw, txqaddr[sky2->port], sky2->tx_prod);\n\n\treturn NETDEV_TX_OK;\n\nmapping_unwind:\n\tfor (i = sky2->tx_prod; i != slot; i = RING_NEXT(i, sky2->tx_ring_size)) {\n\t\tre = sky2->tx_ring + i;\n\n\t\tsky2_tx_unmap(hw->pdev, re);\n\t}\n\nmapping_error:\n\tif (net_ratelimit())\n\t\tdev_warn(&hw->pdev->dev, \"%s: tx mapping error\\n\", dev->name);\n\tdev_kfree_skb_any(skb);\n\treturn NETDEV_TX_OK;\n}\n\n/*\n * Free ring elements from starting at tx_cons until \"done\"\n *\n * NB:\n *  1. The hardware will tell us about partial completion of multi-part\n *     buffers so make sure not to free skb to early.\n *  2. This may run in parallel start_xmit because the it only\n *     looks at the tail of the queue of FIFO (tx_cons), not\n *     the head (tx_prod)\n */\nstatic void sky2_tx_complete(struct sky2_port *sky2, u16 done)\n{\n\tstruct net_device *dev = sky2->netdev;\n\tu16 idx;\n\tunsigned int bytes_compl = 0, pkts_compl = 0;\n\n\tBUG_ON(done >= sky2->tx_ring_size);\n\n\tfor (idx = sky2->tx_cons; idx != done;\n\t     idx = RING_NEXT(idx, sky2->tx_ring_size)) {\n\t\tstruct tx_ring_info *re = sky2->tx_ring + idx;\n\t\tstruct sk_buff *skb = re->skb;\n\n\t\tsky2_tx_unmap(sky2->hw->pdev, re);\n\n\t\tif (skb) {\n\t\t\tnetif_printk(sky2, tx_done, KERN_DEBUG, dev,\n\t\t\t\t     \"tx done %u\\n\", idx);\n\n\t\t\tpkts_compl++;\n\t\t\tbytes_compl += skb->len;\n\n\t\t\tre->skb = NULL;\n\t\t\tdev_kfree_skb_any(skb);\n\n\t\t\tsky2->tx_next = RING_NEXT(idx, sky2->tx_ring_size);\n\t\t}\n\t}\n\n\tsky2->tx_cons = idx;\n\tsmp_mb();\n\n\tnetdev_completed_queue(dev, pkts_compl, bytes_compl);\n\n\tu64_stats_update_begin(&sky2->tx_stats.syncp);\n\tsky2->tx_stats.packets += pkts_compl;\n\tsky2->tx_stats.bytes += bytes_compl;\n\tu64_stats_update_end(&sky2->tx_stats.syncp);\n}\n\nstatic void sky2_tx_reset(struct sky2_hw *hw, unsigned port)\n{\n\t/* Disable Force Sync bit and Enable Alloc bit */\n\tsky2_write8(hw, SK_REG(port, TXA_CTRL),\n\t\t    TXA_DIS_FSYNC | TXA_DIS_ALLOC | TXA_STOP_RC);\n\n\t/* Stop Interval Timer and Limit Counter of Tx Arbiter */\n\tsky2_write32(hw, SK_REG(port, TXA_ITI_INI), 0L);\n\tsky2_write32(hw, SK_REG(port, TXA_LIM_INI), 0L);\n\n\t/* Reset the PCI FIFO of the async Tx queue */\n\tsky2_write32(hw, Q_ADDR(txqaddr[port], Q_CSR),\n\t\t     BMU_RST_SET | BMU_FIFO_RST);\n\n\t/* Reset the Tx prefetch units */\n\tsky2_write32(hw, Y2_QADDR(txqaddr[port], PREF_UNIT_CTRL),\n\t\t     PREF_UNIT_RST_SET);\n\n\tsky2_write32(hw, RB_ADDR(txqaddr[port], RB_CTRL), RB_RST_SET);\n\tsky2_write8(hw, SK_REG(port, TX_GMF_CTRL_T), GMF_RST_SET);\n\n\tsky2_read32(hw, B0_CTST);\n}\n\nstatic void sky2_hw_down(struct sky2_port *sky2)\n{\n\tstruct sky2_hw *hw = sky2->hw;\n\tunsigned port = sky2->port;\n\tu16 ctrl;\n\n\t/* Force flow control off */\n\tsky2_write8(hw, SK_REG(port, GMAC_CTRL), GMC_PAUSE_OFF);\n\n\t/* Stop transmitter */\n\tsky2_write32(hw, Q_ADDR(txqaddr[port], Q_CSR), BMU_STOP);\n\tsky2_read32(hw, Q_ADDR(txqaddr[port], Q_CSR));\n\n\tsky2_write32(hw, RB_ADDR(txqaddr[port], RB_CTRL),\n\t\t     RB_RST_SET | RB_DIS_OP_MD);\n\n\tctrl = gma_read16(hw, port, GM_GP_CTRL);\n\tctrl &= ~(GM_GPCR_TX_ENA | GM_GPCR_RX_ENA);\n\tgma_write16(hw, port, GM_GP_CTRL, ctrl);\n\n\tsky2_write8(hw, SK_REG(port, GPHY_CTRL), GPC_RST_SET);\n\n\t/* Workaround shared GMAC reset */\n\tif (!(hw->chip_id == CHIP_ID_YUKON_XL && hw->chip_rev == 0 &&\n\t      port == 0 && hw->dev[1] && netif_running(hw->dev[1])))\n\t\tsky2_write8(hw, SK_REG(port, GMAC_CTRL), GMC_RST_SET);\n\n\tsky2_write8(hw, SK_REG(port, RX_GMF_CTRL_T), GMF_RST_SET);\n\n\t/* Force any delayed status interrupt and NAPI */\n\tsky2_write32(hw, STAT_LEV_TIMER_CNT, 0);\n\tsky2_write32(hw, STAT_TX_TIMER_CNT, 0);\n\tsky2_write32(hw, STAT_ISR_TIMER_CNT, 0);\n\tsky2_read8(hw, STAT_ISR_TIMER_CTRL);\n\n\tsky2_rx_stop(sky2);\n\n\tspin_lock_bh(&sky2->phy_lock);\n\tsky2_phy_power_down(hw, port);\n\tspin_unlock_bh(&sky2->phy_lock);\n\n\tsky2_tx_reset(hw, port);\n\n\t/* Free any pending frames stuck in HW queue */\n\tsky2_tx_complete(sky2, sky2->tx_prod);\n}\n\n/* Network shutdown */\nstatic int sky2_close(struct net_device *dev)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tstruct sky2_hw *hw = sky2->hw;\n\n\t/* Never really got started! */\n\tif (!sky2->tx_le)\n\t\treturn 0;\n\n\tnetif_info(sky2, ifdown, dev, \"disabling interface\\n\");\n\n\tif (hw->ports == 1) {\n\t\tsky2_write32(hw, B0_IMSK, 0);\n\t\tsky2_read32(hw, B0_IMSK);\n\n\t\tnapi_disable(&hw->napi);\n\t\tfree_irq(hw->pdev->irq, hw);\n\t\thw->flags &= ~SKY2_HW_IRQ_SETUP;\n\t} else {\n\t\tu32 imask;\n\n\t\t/* Disable port IRQ */\n\t\timask  = sky2_read32(hw, B0_IMSK);\n\t\timask &= ~portirq_msk[sky2->port];\n\t\tsky2_write32(hw, B0_IMSK, imask);\n\t\tsky2_read32(hw, B0_IMSK);\n\n\t\tsynchronize_irq(hw->pdev->irq);\n\t\tnapi_synchronize(&hw->napi);\n\t}\n\n\tsky2_hw_down(sky2);\n\n\tsky2_free_buffers(sky2);\n\n\treturn 0;\n}\n\nstatic u16 sky2_phy_speed(const struct sky2_hw *hw, u16 aux)\n{\n\tif (hw->flags & SKY2_HW_FIBRE_PHY)\n\t\treturn SPEED_1000;\n\n\tif (!(hw->flags & SKY2_HW_GIGABIT)) {\n\t\tif (aux & PHY_M_PS_SPEED_100)\n\t\t\treturn SPEED_100;\n\t\telse\n\t\t\treturn SPEED_10;\n\t}\n\n\tswitch (aux & PHY_M_PS_SPEED_MSK) {\n\tcase PHY_M_PS_SPEED_1000:\n\t\treturn SPEED_1000;\n\tcase PHY_M_PS_SPEED_100:\n\t\treturn SPEED_100;\n\tdefault:\n\t\treturn SPEED_10;\n\t}\n}\n\nstatic void sky2_link_up(struct sky2_port *sky2)\n{\n\tstruct sky2_hw *hw = sky2->hw;\n\tunsigned port = sky2->port;\n\tstatic const char *fc_name[] = {\n\t\t[FC_NONE]\t= \"none\",\n\t\t[FC_TX]\t\t= \"tx\",\n\t\t[FC_RX]\t\t= \"rx\",\n\t\t[FC_BOTH]\t= \"both\",\n\t};\n\n\tsky2_set_ipg(sky2);\n\n\tsky2_enable_rx_tx(sky2);\n\n\tgm_phy_write(hw, port, PHY_MARV_INT_MASK, PHY_M_DEF_MSK);\n\n\tnetif_carrier_on(sky2->netdev);\n\n\tmod_timer(&hw->watchdog_timer, jiffies + 1);\n\n\t/* Turn on link LED */\n\tsky2_write8(hw, SK_REG(port, LNK_LED_REG),\n\t\t    LINKLED_ON | LINKLED_BLINK_OFF | LINKLED_LINKSYNC_OFF);\n\n\tnetif_info(sky2, link, sky2->netdev,\n\t\t   \"Link is up at %d Mbps, %s duplex, flow control %s\\n\",\n\t\t   sky2->speed,\n\t\t   sky2->duplex == DUPLEX_FULL ? \"full\" : \"half\",\n\t\t   fc_name[sky2->flow_status]);\n}\n\nstatic void sky2_link_down(struct sky2_port *sky2)\n{\n\tstruct sky2_hw *hw = sky2->hw;\n\tunsigned port = sky2->port;\n\tu16 reg;\n\n\tgm_phy_write(hw, port, PHY_MARV_INT_MASK, 0);\n\n\treg = gma_read16(hw, port, GM_GP_CTRL);\n\treg &= ~(GM_GPCR_RX_ENA | GM_GPCR_TX_ENA);\n\tgma_write16(hw, port, GM_GP_CTRL, reg);\n\n\tnetif_carrier_off(sky2->netdev);\n\n\t/* Turn off link LED */\n\tsky2_write8(hw, SK_REG(port, LNK_LED_REG), LINKLED_OFF);\n\n\tnetif_info(sky2, link, sky2->netdev, \"Link is down\\n\");\n\n\tsky2_phy_init(hw, port);\n}\n\nstatic enum flow_control sky2_flow(int rx, int tx)\n{\n\tif (rx)\n\t\treturn tx ? FC_BOTH : FC_RX;\n\telse\n\t\treturn tx ? FC_TX : FC_NONE;\n}\n\nstatic int sky2_autoneg_done(struct sky2_port *sky2, u16 aux)\n{\n\tstruct sky2_hw *hw = sky2->hw;\n\tunsigned port = sky2->port;\n\tu16 advert, lpa;\n\n\tadvert = gm_phy_read(hw, port, PHY_MARV_AUNE_ADV);\n\tlpa = gm_phy_read(hw, port, PHY_MARV_AUNE_LP);\n\tif (lpa & PHY_M_AN_RF) {\n\t\tnetdev_err(sky2->netdev, \"remote fault\\n\");\n\t\treturn -1;\n\t}\n\n\tif (!(aux & PHY_M_PS_SPDUP_RES)) {\n\t\tnetdev_err(sky2->netdev, \"speed/duplex mismatch\\n\");\n\t\treturn -1;\n\t}\n\n\tsky2->speed = sky2_phy_speed(hw, aux);\n\tsky2->duplex = (aux & PHY_M_PS_FULL_DUP) ? DUPLEX_FULL : DUPLEX_HALF;\n\n\t/* Since the pause result bits seem to in different positions on\n\t * different chips. look at registers.\n\t */\n\tif (hw->flags & SKY2_HW_FIBRE_PHY) {\n\t\t/* Shift for bits in fiber PHY */\n\t\tadvert &= ~(ADVERTISE_PAUSE_CAP|ADVERTISE_PAUSE_ASYM);\n\t\tlpa &= ~(LPA_PAUSE_CAP|LPA_PAUSE_ASYM);\n\n\t\tif (advert & ADVERTISE_1000XPAUSE)\n\t\t\tadvert |= ADVERTISE_PAUSE_CAP;\n\t\tif (advert & ADVERTISE_1000XPSE_ASYM)\n\t\t\tadvert |= ADVERTISE_PAUSE_ASYM;\n\t\tif (lpa & LPA_1000XPAUSE)\n\t\t\tlpa |= LPA_PAUSE_CAP;\n\t\tif (lpa & LPA_1000XPAUSE_ASYM)\n\t\t\tlpa |= LPA_PAUSE_ASYM;\n\t}\n\n\tsky2->flow_status = FC_NONE;\n\tif (advert & ADVERTISE_PAUSE_CAP) {\n\t\tif (lpa & LPA_PAUSE_CAP)\n\t\t\tsky2->flow_status = FC_BOTH;\n\t\telse if (advert & ADVERTISE_PAUSE_ASYM)\n\t\t\tsky2->flow_status = FC_RX;\n\t} else if (advert & ADVERTISE_PAUSE_ASYM) {\n\t\tif ((lpa & LPA_PAUSE_CAP) && (lpa & LPA_PAUSE_ASYM))\n\t\t\tsky2->flow_status = FC_TX;\n\t}\n\n\tif (sky2->duplex == DUPLEX_HALF && sky2->speed < SPEED_1000 &&\n\t    !(hw->chip_id == CHIP_ID_YUKON_EC_U || hw->chip_id == CHIP_ID_YUKON_EX))\n\t\tsky2->flow_status = FC_NONE;\n\n\tif (sky2->flow_status & FC_TX)\n\t\tsky2_write8(hw, SK_REG(port, GMAC_CTRL), GMC_PAUSE_ON);\n\telse\n\t\tsky2_write8(hw, SK_REG(port, GMAC_CTRL), GMC_PAUSE_OFF);\n\n\treturn 0;\n}\n\n/* Interrupt from PHY */\nstatic void sky2_phy_intr(struct sky2_hw *hw, unsigned port)\n{\n\tstruct net_device *dev = hw->dev[port];\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tu16 istatus, phystat;\n\n\tif (!netif_running(dev))\n\t\treturn;\n\n\tspin_lock(&sky2->phy_lock);\n\tistatus = gm_phy_read(hw, port, PHY_MARV_INT_STAT);\n\tphystat = gm_phy_read(hw, port, PHY_MARV_PHY_STAT);\n\n\tnetif_info(sky2, intr, sky2->netdev, \"phy interrupt status 0x%x 0x%x\\n\",\n\t\t   istatus, phystat);\n\n\tif (istatus & PHY_M_IS_AN_COMPL) {\n\t\tif (sky2_autoneg_done(sky2, phystat) == 0 &&\n\t\t    !netif_carrier_ok(dev))\n\t\t\tsky2_link_up(sky2);\n\t\tgoto out;\n\t}\n\n\tif (istatus & PHY_M_IS_LSP_CHANGE)\n\t\tsky2->speed = sky2_phy_speed(hw, phystat);\n\n\tif (istatus & PHY_M_IS_DUP_CHANGE)\n\t\tsky2->duplex =\n\t\t    (phystat & PHY_M_PS_FULL_DUP) ? DUPLEX_FULL : DUPLEX_HALF;\n\n\tif (istatus & PHY_M_IS_LST_CHANGE) {\n\t\tif (phystat & PHY_M_PS_LINK_UP)\n\t\t\tsky2_link_up(sky2);\n\t\telse\n\t\t\tsky2_link_down(sky2);\n\t}\nout:\n\tspin_unlock(&sky2->phy_lock);\n}\n\n/* Special quick link interrupt (Yukon-2 Optima only) */\nstatic void sky2_qlink_intr(struct sky2_hw *hw)\n{\n\tstruct sky2_port *sky2 = netdev_priv(hw->dev[0]);\n\tu32 imask;\n\tu16 phy;\n\n\t/* disable irq */\n\timask = sky2_read32(hw, B0_IMSK);\n\timask &= ~Y2_IS_PHY_QLNK;\n\tsky2_write32(hw, B0_IMSK, imask);\n\n\t/* reset PHY Link Detect */\n\tphy = sky2_pci_read16(hw, PSM_CONFIG_REG4);\n\tsky2_write8(hw, B2_TST_CTRL1, TST_CFG_WRITE_ON);\n\tsky2_pci_write16(hw, PSM_CONFIG_REG4, phy | 1);\n\tsky2_write8(hw, B2_TST_CTRL1, TST_CFG_WRITE_OFF);\n\n\tsky2_link_up(sky2);\n}\n\n/* Transmit timeout is only called if we are running, carrier is up\n * and tx queue is full (stopped).\n */\nstatic void sky2_tx_timeout(struct net_device *dev, unsigned int txqueue)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tstruct sky2_hw *hw = sky2->hw;\n\n\tnetif_err(sky2, timer, dev, \"tx timeout\\n\");\n\n\tnetdev_printk(KERN_DEBUG, dev, \"transmit ring %u .. %u report=%u done=%u\\n\",\n\t\t      sky2->tx_cons, sky2->tx_prod,\n\t\t      sky2_read16(hw, sky2->port == 0 ? STAT_TXA1_RIDX : STAT_TXA2_RIDX),\n\t\t      sky2_read16(hw, Q_ADDR(txqaddr[sky2->port], Q_DONE)));\n\n\t/* can't restart safely under softirq */\n\tschedule_work(&hw->restart_work);\n}\n\nstatic int sky2_change_mtu(struct net_device *dev, int new_mtu)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tstruct sky2_hw *hw = sky2->hw;\n\tunsigned port = sky2->port;\n\tint err;\n\tu16 ctl, mode;\n\tu32 imask;\n\n\tif (!netif_running(dev)) {\n\t\tdev->mtu = new_mtu;\n\t\tnetdev_update_features(dev);\n\t\treturn 0;\n\t}\n\n\timask = sky2_read32(hw, B0_IMSK);\n\tsky2_write32(hw, B0_IMSK, 0);\n\tsky2_read32(hw, B0_IMSK);\n\n\tnetif_trans_update(dev);\t/* prevent tx timeout */\n\tnapi_disable(&hw->napi);\n\tnetif_tx_disable(dev);\n\n\tsynchronize_irq(hw->pdev->irq);\n\n\tif (!(hw->flags & SKY2_HW_RAM_BUFFER))\n\t\tsky2_set_tx_stfwd(hw, port);\n\n\tctl = gma_read16(hw, port, GM_GP_CTRL);\n\tgma_write16(hw, port, GM_GP_CTRL, ctl & ~GM_GPCR_RX_ENA);\n\tsky2_rx_stop(sky2);\n\tsky2_rx_clean(sky2);\n\n\tdev->mtu = new_mtu;\n\tnetdev_update_features(dev);\n\n\tmode = DATA_BLIND_VAL(DATA_BLIND_DEF) |\tGM_SMOD_VLAN_ENA;\n\tif (sky2->speed > SPEED_100)\n\t\tmode |= IPG_DATA_VAL(IPG_DATA_DEF_1000);\n\telse\n\t\tmode |= IPG_DATA_VAL(IPG_DATA_DEF_10_100);\n\n\tif (dev->mtu > ETH_DATA_LEN)\n\t\tmode |= GM_SMOD_JUMBO_ENA;\n\n\tgma_write16(hw, port, GM_SERIAL_MODE, mode);\n\n\tsky2_write8(hw, RB_ADDR(rxqaddr[port], RB_CTRL), RB_ENA_OP_MD);\n\n\terr = sky2_alloc_rx_skbs(sky2);\n\tif (!err)\n\t\tsky2_rx_start(sky2);\n\telse\n\t\tsky2_rx_clean(sky2);\n\tsky2_write32(hw, B0_IMSK, imask);\n\n\tsky2_read32(hw, B0_Y2_SP_LISR);\n\tnapi_enable(&hw->napi);\n\n\tif (err)\n\t\tdev_close(dev);\n\telse {\n\t\tgma_write16(hw, port, GM_GP_CTRL, ctl);\n\n\t\tnetif_wake_queue(dev);\n\t}\n\n\treturn err;\n}\n\nstatic inline bool needs_copy(const struct rx_ring_info *re,\n\t\t\t      unsigned length)\n{\n#ifndef CONFIG_HAVE_EFFICIENT_UNALIGNED_ACCESS\n\t/* Some architectures need the IP header to be aligned */\n\tif (!IS_ALIGNED(re->data_addr + ETH_HLEN, sizeof(u32)))\n\t\treturn true;\n#endif\n\treturn length < copybreak;\n}\n\n/* For small just reuse existing skb for next receive */\nstatic struct sk_buff *receive_copy(struct sky2_port *sky2,\n\t\t\t\t    const struct rx_ring_info *re,\n\t\t\t\t    unsigned length)\n{\n\tstruct sk_buff *skb;\n\n\tskb = netdev_alloc_skb_ip_align(sky2->netdev, length);\n\tif (likely(skb)) {\n\t\tdma_sync_single_for_cpu(&sky2->hw->pdev->dev, re->data_addr,\n\t\t\t\t\tlength, DMA_FROM_DEVICE);\n\t\tskb_copy_from_linear_data(re->skb, skb->data, length);\n\t\tskb->ip_summed = re->skb->ip_summed;\n\t\tskb->csum = re->skb->csum;\n\t\tskb_copy_hash(skb, re->skb);\n\t\t__vlan_hwaccel_copy_tag(skb, re->skb);\n\n\t\tdma_sync_single_for_device(&sky2->hw->pdev->dev,\n\t\t\t\t\t   re->data_addr, length,\n\t\t\t\t\t   DMA_FROM_DEVICE);\n\t\t__vlan_hwaccel_clear_tag(re->skb);\n\t\tskb_clear_hash(re->skb);\n\t\tre->skb->ip_summed = CHECKSUM_NONE;\n\t\tskb_put(skb, length);\n\t}\n\treturn skb;\n}\n\n/* Adjust length of skb with fragments to match received data */\nstatic void skb_put_frags(struct sk_buff *skb, unsigned int hdr_space,\n\t\t\t  unsigned int length)\n{\n\tint i, num_frags;\n\tunsigned int size;\n\n\t/* put header into skb */\n\tsize = min(length, hdr_space);\n\tskb->tail += size;\n\tskb->len += size;\n\tlength -= size;\n\n\tnum_frags = skb_shinfo(skb)->nr_frags;\n\tfor (i = 0; i < num_frags; i++) {\n\t\tskb_frag_t *frag = &skb_shinfo(skb)->frags[i];\n\n\t\tif (length == 0) {\n\t\t\t/* don't need this page */\n\t\t\t__skb_frag_unref(frag);\n\t\t\t--skb_shinfo(skb)->nr_frags;\n\t\t} else {\n\t\t\tsize = min(length, (unsigned) PAGE_SIZE);\n\n\t\t\tskb_frag_size_set(frag, size);\n\t\t\tskb->data_len += size;\n\t\t\tskb->truesize += PAGE_SIZE;\n\t\t\tskb->len += size;\n\t\t\tlength -= size;\n\t\t}\n\t}\n}\n\n/* Normal packet - take skb from ring element and put in a new one  */\nstatic struct sk_buff *receive_new(struct sky2_port *sky2,\n\t\t\t\t   struct rx_ring_info *re,\n\t\t\t\t   unsigned int length)\n{\n\tstruct sk_buff *skb;\n\tstruct rx_ring_info nre;\n\tunsigned hdr_space = sky2->rx_data_size;\n\n\tnre.skb = sky2_rx_alloc(sky2, GFP_ATOMIC);\n\tif (unlikely(!nre.skb))\n\t\tgoto nobuf;\n\n\tif (sky2_rx_map_skb(sky2->hw->pdev, &nre, hdr_space))\n\t\tgoto nomap;\n\n\tskb = re->skb;\n\tsky2_rx_unmap_skb(sky2->hw->pdev, re);\n\tprefetch(skb->data);\n\t*re = nre;\n\n\tif (skb_shinfo(skb)->nr_frags)\n\t\tskb_put_frags(skb, hdr_space, length);\n\telse\n\t\tskb_put(skb, length);\n\treturn skb;\n\nnomap:\n\tdev_kfree_skb(nre.skb);\nnobuf:\n\treturn NULL;\n}\n\n/*\n * Receive one packet.\n * For larger packets, get new buffer.\n */\nstatic struct sk_buff *sky2_receive(struct net_device *dev,\n\t\t\t\t    u16 length, u32 status)\n{\n \tstruct sky2_port *sky2 = netdev_priv(dev);\n\tstruct rx_ring_info *re = sky2->rx_ring + sky2->rx_next;\n\tstruct sk_buff *skb = NULL;\n\tu16 count = (status & GMR_FS_LEN) >> 16;\n\n\tnetif_printk(sky2, rx_status, KERN_DEBUG, dev,\n\t\t     \"rx slot %u status 0x%x len %d\\n\",\n\t\t     sky2->rx_next, status, length);\n\n\tsky2->rx_next = (sky2->rx_next + 1) % sky2->rx_pending;\n\tprefetch(sky2->rx_ring + sky2->rx_next);\n\n\tif (skb_vlan_tag_present(re->skb))\n\t\tcount -= VLAN_HLEN;\t/* Account for vlan tag */\n\n\t/* This chip has hardware problems that generates bogus status.\n\t * So do only marginal checking and expect higher level protocols\n\t * to handle crap frames.\n\t */\n\tif (sky2->hw->chip_id == CHIP_ID_YUKON_FE_P &&\n\t    sky2->hw->chip_rev == CHIP_REV_YU_FE2_A0 &&\n\t    length != count)\n\t\tgoto okay;\n\n\tif (status & GMR_FS_ANY_ERR)\n\t\tgoto error;\n\n\tif (!(status & GMR_FS_RX_OK))\n\t\tgoto resubmit;\n\n\t/* if length reported by DMA does not match PHY, packet was truncated */\n\tif (length != count)\n\t\tgoto error;\n\nokay:\n\tif (needs_copy(re, length))\n\t\tskb = receive_copy(sky2, re, length);\n\telse\n\t\tskb = receive_new(sky2, re, length);\n\n\tdev->stats.rx_dropped += (skb == NULL);\n\nresubmit:\n\tsky2_rx_submit(sky2, re);\n\n\treturn skb;\n\nerror:\n\t++dev->stats.rx_errors;\n\n\tif (net_ratelimit())\n\t\tnetif_info(sky2, rx_err, dev,\n\t\t\t   \"rx error, status 0x%x length %d\\n\", status, length);\n\n\tgoto resubmit;\n}\n\n/* Transmit complete */\nstatic inline void sky2_tx_done(struct net_device *dev, u16 last)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\n\tif (netif_running(dev)) {\n\t\tsky2_tx_complete(sky2, last);\n\n\t\t/* Wake unless it's detached, and called e.g. from sky2_close() */\n\t\tif (tx_avail(sky2) > MAX_SKB_TX_LE + 4)\n\t\t\tnetif_wake_queue(dev);\n\t}\n}\n\nstatic inline void sky2_skb_rx(const struct sky2_port *sky2,\n\t\t\t       struct sk_buff *skb)\n{\n\tif (skb->ip_summed == CHECKSUM_NONE)\n\t\tnetif_receive_skb(skb);\n\telse\n\t\tnapi_gro_receive(&sky2->hw->napi, skb);\n}\n\nstatic inline void sky2_rx_done(struct sky2_hw *hw, unsigned port,\n\t\t\t\tunsigned packets, unsigned bytes)\n{\n\tstruct net_device *dev = hw->dev[port];\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\n\tif (packets == 0)\n\t\treturn;\n\n\tu64_stats_update_begin(&sky2->rx_stats.syncp);\n\tsky2->rx_stats.packets += packets;\n\tsky2->rx_stats.bytes += bytes;\n\tu64_stats_update_end(&sky2->rx_stats.syncp);\n\n\tsky2->last_rx = jiffies;\n\tsky2_rx_update(netdev_priv(dev), rxqaddr[port]);\n}\n\nstatic void sky2_rx_checksum(struct sky2_port *sky2, u32 status)\n{\n\t/* If this happens then driver assuming wrong format for chip type */\n\tBUG_ON(sky2->hw->flags & SKY2_HW_NEW_LE);\n\n\t/* Both checksum counters are programmed to start at\n\t * the same offset, so unless there is a problem they\n\t * should match. This failure is an early indication that\n\t * hardware receive checksumming won't work.\n\t */\n\tif (likely((u16)(status >> 16) == (u16)status)) {\n\t\tstruct sk_buff *skb = sky2->rx_ring[sky2->rx_next].skb;\n\t\tskb->ip_summed = CHECKSUM_COMPLETE;\n\t\tskb->csum = le16_to_cpu(status);\n\t} else {\n\t\tdev_notice(&sky2->hw->pdev->dev,\n\t\t\t   \"%s: receive checksum problem (status = %#x)\\n\",\n\t\t\t   sky2->netdev->name, status);\n\n\t\t/* Disable checksum offload\n\t\t * It will be reenabled on next ndo_set_features, but if it's\n\t\t * really broken, will get disabled again\n\t\t */\n\t\tsky2->netdev->features &= ~NETIF_F_RXCSUM;\n\t\tsky2_write32(sky2->hw, Q_ADDR(rxqaddr[sky2->port], Q_CSR),\n\t\t\t     BMU_DIS_RX_CHKSUM);\n\t}\n}\n\nstatic void sky2_rx_tag(struct sky2_port *sky2, u16 length)\n{\n\tstruct sk_buff *skb;\n\n\tskb = sky2->rx_ring[sky2->rx_next].skb;\n\t__vlan_hwaccel_put_tag(skb, htons(ETH_P_8021Q), be16_to_cpu(length));\n}\n\nstatic void sky2_rx_hash(struct sky2_port *sky2, u32 status)\n{\n\tstruct sk_buff *skb;\n\n\tskb = sky2->rx_ring[sky2->rx_next].skb;\n\tskb_set_hash(skb, le32_to_cpu(status), PKT_HASH_TYPE_L3);\n}\n\n/* Process status response ring */\nstatic int sky2_status_intr(struct sky2_hw *hw, int to_do, u16 idx)\n{\n\tint work_done = 0;\n\tunsigned int total_bytes[2] = { 0 };\n\tunsigned int total_packets[2] = { 0 };\n\n\tif (to_do <= 0)\n\t\treturn work_done;\n\n\trmb();\n\tdo {\n\t\tstruct sky2_port *sky2;\n\t\tstruct sky2_status_le *le  = hw->st_le + hw->st_idx;\n\t\tunsigned port;\n\t\tstruct net_device *dev;\n\t\tstruct sk_buff *skb;\n\t\tu32 status;\n\t\tu16 length;\n\t\tu8 opcode = le->opcode;\n\n\t\tif (!(opcode & HW_OWNER))\n\t\t\tbreak;\n\n\t\thw->st_idx = RING_NEXT(hw->st_idx, hw->st_size);\n\n\t\tport = le->css & CSS_LINK_BIT;\n\t\tdev = hw->dev[port];\n\t\tsky2 = netdev_priv(dev);\n\t\tlength = le16_to_cpu(le->length);\n\t\tstatus = le32_to_cpu(le->status);\n\n\t\tle->opcode = 0;\n\t\tswitch (opcode & ~HW_OWNER) {\n\t\tcase OP_RXSTAT:\n\t\t\ttotal_packets[port]++;\n\t\t\ttotal_bytes[port] += length;\n\n\t\t\tskb = sky2_receive(dev, length, status);\n\t\t\tif (!skb)\n\t\t\t\tbreak;\n\n\t\t\t/* This chip reports checksum status differently */\n\t\t\tif (hw->flags & SKY2_HW_NEW_LE) {\n\t\t\t\tif ((dev->features & NETIF_F_RXCSUM) &&\n\t\t\t\t    (le->css & (CSS_ISIPV4 | CSS_ISIPV6)) &&\n\t\t\t\t    (le->css & CSS_TCPUDPCSOK))\n\t\t\t\t\tskb->ip_summed = CHECKSUM_UNNECESSARY;\n\t\t\t\telse\n\t\t\t\t\tskb->ip_summed = CHECKSUM_NONE;\n\t\t\t}\n\n\t\t\tskb->protocol = eth_type_trans(skb, dev);\n\t\t\tsky2_skb_rx(sky2, skb);\n\n\t\t\t/* Stop after net poll weight */\n\t\t\tif (++work_done >= to_do)\n\t\t\t\tgoto exit_loop;\n\t\t\tbreak;\n\n\t\tcase OP_RXVLAN:\n\t\t\tsky2_rx_tag(sky2, length);\n\t\t\tbreak;\n\n\t\tcase OP_RXCHKSVLAN:\n\t\t\tsky2_rx_tag(sky2, length);\n\t\t\tfallthrough;\n\t\tcase OP_RXCHKS:\n\t\t\tif (likely(dev->features & NETIF_F_RXCSUM))\n\t\t\t\tsky2_rx_checksum(sky2, status);\n\t\t\tbreak;\n\n\t\tcase OP_RSS_HASH:\n\t\t\tsky2_rx_hash(sky2, status);\n\t\t\tbreak;\n\n\t\tcase OP_TXINDEXLE:\n\t\t\t/* TX index reports status for both ports */\n\t\t\tsky2_tx_done(hw->dev[0], status & 0xfff);\n\t\t\tif (hw->dev[1])\n\t\t\t\tsky2_tx_done(hw->dev[1],\n\t\t\t\t     ((status >> 24) & 0xff)\n\t\t\t\t\t     | (u16)(length & 0xf) << 8);\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tif (net_ratelimit())\n\t\t\t\tpr_warn(\"unknown status opcode 0x%x\\n\", opcode);\n\t\t}\n\t} while (hw->st_idx != idx);\n\n\t/* Fully processed status ring so clear irq */\n\tsky2_write32(hw, STAT_CTRL, SC_STAT_CLR_IRQ);\n\nexit_loop:\n\tsky2_rx_done(hw, 0, total_packets[0], total_bytes[0]);\n\tsky2_rx_done(hw, 1, total_packets[1], total_bytes[1]);\n\n\treturn work_done;\n}\n\nstatic void sky2_hw_error(struct sky2_hw *hw, unsigned port, u32 status)\n{\n\tstruct net_device *dev = hw->dev[port];\n\n\tif (net_ratelimit())\n\t\tnetdev_info(dev, \"hw error interrupt status 0x%x\\n\", status);\n\n\tif (status & Y2_IS_PAR_RD1) {\n\t\tif (net_ratelimit())\n\t\t\tnetdev_err(dev, \"ram data read parity error\\n\");\n\t\t/* Clear IRQ */\n\t\tsky2_write16(hw, RAM_BUFFER(port, B3_RI_CTRL), RI_CLR_RD_PERR);\n\t}\n\n\tif (status & Y2_IS_PAR_WR1) {\n\t\tif (net_ratelimit())\n\t\t\tnetdev_err(dev, \"ram data write parity error\\n\");\n\n\t\tsky2_write16(hw, RAM_BUFFER(port, B3_RI_CTRL), RI_CLR_WR_PERR);\n\t}\n\n\tif (status & Y2_IS_PAR_MAC1) {\n\t\tif (net_ratelimit())\n\t\t\tnetdev_err(dev, \"MAC parity error\\n\");\n\t\tsky2_write8(hw, SK_REG(port, TX_GMF_CTRL_T), GMF_CLI_TX_PE);\n\t}\n\n\tif (status & Y2_IS_PAR_RX1) {\n\t\tif (net_ratelimit())\n\t\t\tnetdev_err(dev, \"RX parity error\\n\");\n\t\tsky2_write32(hw, Q_ADDR(rxqaddr[port], Q_CSR), BMU_CLR_IRQ_PAR);\n\t}\n\n\tif (status & Y2_IS_TCP_TXA1) {\n\t\tif (net_ratelimit())\n\t\t\tnetdev_err(dev, \"TCP segmentation error\\n\");\n\t\tsky2_write32(hw, Q_ADDR(txqaddr[port], Q_CSR), BMU_CLR_IRQ_TCP);\n\t}\n}\n\nstatic void sky2_hw_intr(struct sky2_hw *hw)\n{\n\tstruct pci_dev *pdev = hw->pdev;\n\tu32 status = sky2_read32(hw, B0_HWE_ISRC);\n\tu32 hwmsk = sky2_read32(hw, B0_HWE_IMSK);\n\n\tstatus &= hwmsk;\n\n\tif (status & Y2_IS_TIST_OV)\n\t\tsky2_write8(hw, GMAC_TI_ST_CTRL, GMT_ST_CLR_IRQ);\n\n\tif (status & (Y2_IS_MST_ERR | Y2_IS_IRQ_STAT)) {\n\t\tu16 pci_err;\n\n\t\tsky2_write8(hw, B2_TST_CTRL1, TST_CFG_WRITE_ON);\n\t\tpci_err = sky2_pci_read16(hw, PCI_STATUS);\n\t\tif (net_ratelimit())\n\t\t\tdev_err(&pdev->dev, \"PCI hardware error (0x%x)\\n\",\n\t\t\t        pci_err);\n\n\t\tsky2_pci_write16(hw, PCI_STATUS,\n\t\t\t\t      pci_err | PCI_STATUS_ERROR_BITS);\n\t\tsky2_write8(hw, B2_TST_CTRL1, TST_CFG_WRITE_OFF);\n\t}\n\n\tif (status & Y2_IS_PCI_EXP) {\n\t\t/* PCI-Express uncorrectable Error occurred */\n\t\tu32 err;\n\n\t\tsky2_write8(hw, B2_TST_CTRL1, TST_CFG_WRITE_ON);\n\t\terr = sky2_read32(hw, Y2_CFG_AER + PCI_ERR_UNCOR_STATUS);\n\t\tsky2_write32(hw, Y2_CFG_AER + PCI_ERR_UNCOR_STATUS,\n\t\t\t     0xfffffffful);\n\t\tif (net_ratelimit())\n\t\t\tdev_err(&pdev->dev, \"PCI Express error (0x%x)\\n\", err);\n\n\t\tsky2_read32(hw, Y2_CFG_AER + PCI_ERR_UNCOR_STATUS);\n\t\tsky2_write8(hw, B2_TST_CTRL1, TST_CFG_WRITE_OFF);\n\t}\n\n\tif (status & Y2_HWE_L1_MASK)\n\t\tsky2_hw_error(hw, 0, status);\n\tstatus >>= 8;\n\tif (status & Y2_HWE_L1_MASK)\n\t\tsky2_hw_error(hw, 1, status);\n}\n\nstatic void sky2_mac_intr(struct sky2_hw *hw, unsigned port)\n{\n\tstruct net_device *dev = hw->dev[port];\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tu8 status = sky2_read8(hw, SK_REG(port, GMAC_IRQ_SRC));\n\n\tnetif_info(sky2, intr, dev, \"mac interrupt status 0x%x\\n\", status);\n\n\tif (status & GM_IS_RX_CO_OV)\n\t\tgma_read16(hw, port, GM_RX_IRQ_SRC);\n\n\tif (status & GM_IS_TX_CO_OV)\n\t\tgma_read16(hw, port, GM_TX_IRQ_SRC);\n\n\tif (status & GM_IS_RX_FF_OR) {\n\t\t++dev->stats.rx_fifo_errors;\n\t\tsky2_write8(hw, SK_REG(port, RX_GMF_CTRL_T), GMF_CLI_RX_FO);\n\t}\n\n\tif (status & GM_IS_TX_FF_UR) {\n\t\t++dev->stats.tx_fifo_errors;\n\t\tsky2_write8(hw, SK_REG(port, TX_GMF_CTRL_T), GMF_CLI_TX_FU);\n\t}\n}\n\n/* This should never happen it is a bug. */\nstatic void sky2_le_error(struct sky2_hw *hw, unsigned port, u16 q)\n{\n\tstruct net_device *dev = hw->dev[port];\n\tu16 idx = sky2_read16(hw, Y2_QADDR(q, PREF_UNIT_GET_IDX));\n\n\tdev_err(&hw->pdev->dev, \"%s: descriptor error q=%#x get=%u put=%u\\n\",\n\t\tdev->name, (unsigned) q, (unsigned) idx,\n\t\t(unsigned) sky2_read16(hw, Y2_QADDR(q, PREF_UNIT_PUT_IDX)));\n\n\tsky2_write32(hw, Q_ADDR(q, Q_CSR), BMU_CLR_IRQ_CHK);\n}\n\nstatic int sky2_rx_hung(struct net_device *dev)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tstruct sky2_hw *hw = sky2->hw;\n\tunsigned port = sky2->port;\n\tunsigned rxq = rxqaddr[port];\n\tu32 mac_rp = sky2_read32(hw, SK_REG(port, RX_GMF_RP));\n\tu8 mac_lev = sky2_read8(hw, SK_REG(port, RX_GMF_RLEV));\n\tu8 fifo_rp = sky2_read8(hw, Q_ADDR(rxq, Q_RP));\n\tu8 fifo_lev = sky2_read8(hw, Q_ADDR(rxq, Q_RL));\n\n\t/* If idle and MAC or PCI is stuck */\n\tif (sky2->check.last == sky2->last_rx &&\n\t    ((mac_rp == sky2->check.mac_rp &&\n\t      mac_lev != 0 && mac_lev >= sky2->check.mac_lev) ||\n\t     /* Check if the PCI RX hang */\n\t     (fifo_rp == sky2->check.fifo_rp &&\n\t      fifo_lev != 0 && fifo_lev >= sky2->check.fifo_lev))) {\n\t\tnetdev_printk(KERN_DEBUG, dev,\n\t\t\t      \"hung mac %d:%d fifo %d (%d:%d)\\n\",\n\t\t\t      mac_lev, mac_rp, fifo_lev,\n\t\t\t      fifo_rp, sky2_read8(hw, Q_ADDR(rxq, Q_WP)));\n\t\treturn 1;\n\t} else {\n\t\tsky2->check.last = sky2->last_rx;\n\t\tsky2->check.mac_rp = mac_rp;\n\t\tsky2->check.mac_lev = mac_lev;\n\t\tsky2->check.fifo_rp = fifo_rp;\n\t\tsky2->check.fifo_lev = fifo_lev;\n\t\treturn 0;\n\t}\n}\n\nstatic void sky2_watchdog(struct timer_list *t)\n{\n\tstruct sky2_hw *hw = from_timer(hw, t, watchdog_timer);\n\n\t/* Check for lost IRQ once a second */\n\tif (sky2_read32(hw, B0_ISRC)) {\n\t\tnapi_schedule(&hw->napi);\n\t} else {\n\t\tint i, active = 0;\n\n\t\tfor (i = 0; i < hw->ports; i++) {\n\t\t\tstruct net_device *dev = hw->dev[i];\n\t\t\tif (!netif_running(dev))\n\t\t\t\tcontinue;\n\t\t\t++active;\n\n\t\t\t/* For chips with Rx FIFO, check if stuck */\n\t\t\tif ((hw->flags & SKY2_HW_RAM_BUFFER) &&\n\t\t\t     sky2_rx_hung(dev)) {\n\t\t\t\tnetdev_info(dev, \"receiver hang detected\\n\");\n\t\t\t\tschedule_work(&hw->restart_work);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tif (active == 0)\n\t\t\treturn;\n\t}\n\n\tmod_timer(&hw->watchdog_timer, round_jiffies(jiffies + HZ));\n}\n\n/* Hardware/software error handling */\nstatic void sky2_err_intr(struct sky2_hw *hw, u32 status)\n{\n\tif (net_ratelimit())\n\t\tdev_warn(&hw->pdev->dev, \"error interrupt status=%#x\\n\", status);\n\n\tif (status & Y2_IS_HW_ERR)\n\t\tsky2_hw_intr(hw);\n\n\tif (status & Y2_IS_IRQ_MAC1)\n\t\tsky2_mac_intr(hw, 0);\n\n\tif (status & Y2_IS_IRQ_MAC2)\n\t\tsky2_mac_intr(hw, 1);\n\n\tif (status & Y2_IS_CHK_RX1)\n\t\tsky2_le_error(hw, 0, Q_R1);\n\n\tif (status & Y2_IS_CHK_RX2)\n\t\tsky2_le_error(hw, 1, Q_R2);\n\n\tif (status & Y2_IS_CHK_TXA1)\n\t\tsky2_le_error(hw, 0, Q_XA1);\n\n\tif (status & Y2_IS_CHK_TXA2)\n\t\tsky2_le_error(hw, 1, Q_XA2);\n}\n\nstatic int sky2_poll(struct napi_struct *napi, int work_limit)\n{\n\tstruct sky2_hw *hw = container_of(napi, struct sky2_hw, napi);\n\tu32 status = sky2_read32(hw, B0_Y2_SP_EISR);\n\tint work_done = 0;\n\tu16 idx;\n\n\tif (unlikely(status & Y2_IS_ERROR))\n\t\tsky2_err_intr(hw, status);\n\n\tif (status & Y2_IS_IRQ_PHY1)\n\t\tsky2_phy_intr(hw, 0);\n\n\tif (status & Y2_IS_IRQ_PHY2)\n\t\tsky2_phy_intr(hw, 1);\n\n\tif (status & Y2_IS_PHY_QLNK)\n\t\tsky2_qlink_intr(hw);\n\n\twhile ((idx = sky2_read16(hw, STAT_PUT_IDX)) != hw->st_idx) {\n\t\twork_done += sky2_status_intr(hw, work_limit - work_done, idx);\n\n\t\tif (work_done >= work_limit)\n\t\t\tgoto done;\n\t}\n\n\tnapi_complete_done(napi, work_done);\n\tsky2_read32(hw, B0_Y2_SP_LISR);\ndone:\n\n\treturn work_done;\n}\n\nstatic irqreturn_t sky2_intr(int irq, void *dev_id)\n{\n\tstruct sky2_hw *hw = dev_id;\n\tu32 status;\n\n\t/* Reading this mask interrupts as side effect */\n\tstatus = sky2_read32(hw, B0_Y2_SP_ISRC2);\n\tif (status == 0 || status == ~0) {\n\t\tsky2_write32(hw, B0_Y2_SP_ICR, 2);\n\t\treturn IRQ_NONE;\n\t}\n\n\tprefetch(&hw->st_le[hw->st_idx]);\n\n\tnapi_schedule(&hw->napi);\n\n\treturn IRQ_HANDLED;\n}\n\n#ifdef CONFIG_NET_POLL_CONTROLLER\nstatic void sky2_netpoll(struct net_device *dev)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\n\tnapi_schedule(&sky2->hw->napi);\n}\n#endif\n\n/* Chip internal frequency for clock calculations */\nstatic u32 sky2_mhz(const struct sky2_hw *hw)\n{\n\tswitch (hw->chip_id) {\n\tcase CHIP_ID_YUKON_EC:\n\tcase CHIP_ID_YUKON_EC_U:\n\tcase CHIP_ID_YUKON_EX:\n\tcase CHIP_ID_YUKON_SUPR:\n\tcase CHIP_ID_YUKON_UL_2:\n\tcase CHIP_ID_YUKON_OPT:\n\tcase CHIP_ID_YUKON_PRM:\n\tcase CHIP_ID_YUKON_OP_2:\n\t\treturn 125;\n\n\tcase CHIP_ID_YUKON_FE:\n\t\treturn 100;\n\n\tcase CHIP_ID_YUKON_FE_P:\n\t\treturn 50;\n\n\tcase CHIP_ID_YUKON_XL:\n\t\treturn 156;\n\n\tdefault:\n\t\tBUG();\n\t}\n}\n\nstatic inline u32 sky2_us2clk(const struct sky2_hw *hw, u32 us)\n{\n\treturn sky2_mhz(hw) * us;\n}\n\nstatic inline u32 sky2_clk2us(const struct sky2_hw *hw, u32 clk)\n{\n\treturn clk / sky2_mhz(hw);\n}\n\n\nstatic int sky2_init(struct sky2_hw *hw)\n{\n\tu8 t8;\n\n\t/* Enable all clocks and check for bad PCI access */\n\tsky2_pci_write32(hw, PCI_DEV_REG3, 0);\n\n\tsky2_write8(hw, B0_CTST, CS_RST_CLR);\n\n\thw->chip_id = sky2_read8(hw, B2_CHIP_ID);\n\thw->chip_rev = (sky2_read8(hw, B2_MAC_CFG) & CFG_CHIP_R_MSK) >> 4;\n\n\tswitch (hw->chip_id) {\n\tcase CHIP_ID_YUKON_XL:\n\t\thw->flags = SKY2_HW_GIGABIT | SKY2_HW_NEWER_PHY;\n\t\tif (hw->chip_rev < CHIP_REV_YU_XL_A2)\n\t\t\thw->flags |= SKY2_HW_RSS_BROKEN;\n\t\tbreak;\n\n\tcase CHIP_ID_YUKON_EC_U:\n\t\thw->flags = SKY2_HW_GIGABIT\n\t\t\t| SKY2_HW_NEWER_PHY\n\t\t\t| SKY2_HW_ADV_POWER_CTL;\n\t\tbreak;\n\n\tcase CHIP_ID_YUKON_EX:\n\t\thw->flags = SKY2_HW_GIGABIT\n\t\t\t| SKY2_HW_NEWER_PHY\n\t\t\t| SKY2_HW_NEW_LE\n\t\t\t| SKY2_HW_ADV_POWER_CTL\n\t\t\t| SKY2_HW_RSS_CHKSUM;\n\n\t\t/* New transmit checksum */\n\t\tif (hw->chip_rev != CHIP_REV_YU_EX_B0)\n\t\t\thw->flags |= SKY2_HW_AUTO_TX_SUM;\n\t\tbreak;\n\n\tcase CHIP_ID_YUKON_EC:\n\t\t/* This rev is really old, and requires untested workarounds */\n\t\tif (hw->chip_rev == CHIP_REV_YU_EC_A1) {\n\t\t\tdev_err(&hw->pdev->dev, \"unsupported revision Yukon-EC rev A1\\n\");\n\t\t\treturn -EOPNOTSUPP;\n\t\t}\n\t\thw->flags = SKY2_HW_GIGABIT | SKY2_HW_RSS_BROKEN;\n\t\tbreak;\n\n\tcase CHIP_ID_YUKON_FE:\n\t\thw->flags = SKY2_HW_RSS_BROKEN;\n\t\tbreak;\n\n\tcase CHIP_ID_YUKON_FE_P:\n\t\thw->flags = SKY2_HW_NEWER_PHY\n\t\t\t| SKY2_HW_NEW_LE\n\t\t\t| SKY2_HW_AUTO_TX_SUM\n\t\t\t| SKY2_HW_ADV_POWER_CTL;\n\n\t\t/* The workaround for status conflicts VLAN tag detection. */\n\t\tif (hw->chip_rev == CHIP_REV_YU_FE2_A0)\n\t\t\thw->flags |= SKY2_HW_VLAN_BROKEN | SKY2_HW_RSS_CHKSUM;\n\t\tbreak;\n\n\tcase CHIP_ID_YUKON_SUPR:\n\t\thw->flags = SKY2_HW_GIGABIT\n\t\t\t| SKY2_HW_NEWER_PHY\n\t\t\t| SKY2_HW_NEW_LE\n\t\t\t| SKY2_HW_AUTO_TX_SUM\n\t\t\t| SKY2_HW_ADV_POWER_CTL;\n\n\t\tif (hw->chip_rev == CHIP_REV_YU_SU_A0)\n\t\t\thw->flags |= SKY2_HW_RSS_CHKSUM;\n\t\tbreak;\n\n\tcase CHIP_ID_YUKON_UL_2:\n\t\thw->flags = SKY2_HW_GIGABIT\n\t\t\t| SKY2_HW_ADV_POWER_CTL;\n\t\tbreak;\n\n\tcase CHIP_ID_YUKON_OPT:\n\tcase CHIP_ID_YUKON_PRM:\n\tcase CHIP_ID_YUKON_OP_2:\n\t\thw->flags = SKY2_HW_GIGABIT\n\t\t\t| SKY2_HW_NEW_LE\n\t\t\t| SKY2_HW_ADV_POWER_CTL;\n\t\tbreak;\n\n\tdefault:\n\t\tdev_err(&hw->pdev->dev, \"unsupported chip type 0x%x\\n\",\n\t\t\thw->chip_id);\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\thw->pmd_type = sky2_read8(hw, B2_PMD_TYP);\n\tif (hw->pmd_type == 'L' || hw->pmd_type == 'S' || hw->pmd_type == 'P')\n\t\thw->flags |= SKY2_HW_FIBRE_PHY;\n\n\thw->ports = 1;\n\tt8 = sky2_read8(hw, B2_Y2_HW_RES);\n\tif ((t8 & CFG_DUAL_MAC_MSK) == CFG_DUAL_MAC_MSK) {\n\t\tif (!(sky2_read8(hw, B2_Y2_CLK_GATE) & Y2_STATUS_LNK2_INAC))\n\t\t\t++hw->ports;\n\t}\n\n\tif (sky2_read8(hw, B2_E_0))\n\t\thw->flags |= SKY2_HW_RAM_BUFFER;\n\n\treturn 0;\n}\n\nstatic void sky2_reset(struct sky2_hw *hw)\n{\n\tstruct pci_dev *pdev = hw->pdev;\n\tu16 status;\n\tint i;\n\tu32 hwe_mask = Y2_HWE_ALL_MASK;\n\n\t/* disable ASF */\n\tif (hw->chip_id == CHIP_ID_YUKON_EX\n\t    || hw->chip_id == CHIP_ID_YUKON_SUPR) {\n\t\tsky2_write32(hw, CPU_WDOG, 0);\n\t\tstatus = sky2_read16(hw, HCU_CCSR);\n\t\tstatus &= ~(HCU_CCSR_AHB_RST | HCU_CCSR_CPU_RST_MODE |\n\t\t\t    HCU_CCSR_UC_STATE_MSK);\n\t\t/*\n\t\t * CPU clock divider shouldn't be used because\n\t\t * - ASF firmware may malfunction\n\t\t * - Yukon-Supreme: Parallel FLASH doesn't support divided clocks\n\t\t */\n\t\tstatus &= ~HCU_CCSR_CPU_CLK_DIVIDE_MSK;\n\t\tsky2_write16(hw, HCU_CCSR, status);\n\t\tsky2_write32(hw, CPU_WDOG, 0);\n\t} else\n\t\tsky2_write8(hw, B28_Y2_ASF_STAT_CMD, Y2_ASF_RESET);\n\tsky2_write16(hw, B0_CTST, Y2_ASF_DISABLE);\n\n\t/* do a SW reset */\n\tsky2_write8(hw, B0_CTST, CS_RST_SET);\n\tsky2_write8(hw, B0_CTST, CS_RST_CLR);\n\n\t/* allow writes to PCI config */\n\tsky2_write8(hw, B2_TST_CTRL1, TST_CFG_WRITE_ON);\n\n\t/* clear PCI errors, if any */\n\tstatus = sky2_pci_read16(hw, PCI_STATUS);\n\tstatus |= PCI_STATUS_ERROR_BITS;\n\tsky2_pci_write16(hw, PCI_STATUS, status);\n\n\tsky2_write8(hw, B0_CTST, CS_MRST_CLR);\n\n\tif (pci_is_pcie(pdev)) {\n\t\tsky2_write32(hw, Y2_CFG_AER + PCI_ERR_UNCOR_STATUS,\n\t\t\t     0xfffffffful);\n\n\t\t/* If error bit is stuck on ignore it */\n\t\tif (sky2_read32(hw, B0_HWE_ISRC) & Y2_IS_PCI_EXP)\n\t\t\tdev_info(&pdev->dev, \"ignoring stuck error report bit\\n\");\n\t\telse\n\t\t\thwe_mask |= Y2_IS_PCI_EXP;\n\t}\n\n\tsky2_power_on(hw);\n\tsky2_write8(hw, B2_TST_CTRL1, TST_CFG_WRITE_OFF);\n\n\tfor (i = 0; i < hw->ports; i++) {\n\t\tsky2_write8(hw, SK_REG(i, GMAC_LINK_CTRL), GMLC_RST_SET);\n\t\tsky2_write8(hw, SK_REG(i, GMAC_LINK_CTRL), GMLC_RST_CLR);\n\n\t\tif (hw->chip_id == CHIP_ID_YUKON_EX ||\n\t\t    hw->chip_id == CHIP_ID_YUKON_SUPR)\n\t\t\tsky2_write16(hw, SK_REG(i, GMAC_CTRL),\n\t\t\t\t     GMC_BYP_MACSECRX_ON | GMC_BYP_MACSECTX_ON\n\t\t\t\t     | GMC_BYP_RETR_ON);\n\n\t}\n\n\tif (hw->chip_id == CHIP_ID_YUKON_SUPR && hw->chip_rev > CHIP_REV_YU_SU_B0) {\n\t\t/* enable MACSec clock gating */\n\t\tsky2_pci_write32(hw, PCI_DEV_REG3, P_CLK_MACSEC_DIS);\n\t}\n\n\tif (hw->chip_id == CHIP_ID_YUKON_OPT ||\n\t    hw->chip_id == CHIP_ID_YUKON_PRM ||\n\t    hw->chip_id == CHIP_ID_YUKON_OP_2) {\n\t\tu16 reg;\n\n\t\tif (hw->chip_id == CHIP_ID_YUKON_OPT && hw->chip_rev == 0) {\n\t\t\t/* disable PCI-E PHY power down (set PHY reg 0x80, bit 7 */\n\t\t\tsky2_write32(hw, Y2_PEX_PHY_DATA, (0x80UL << 16) | (1 << 7));\n\n\t\t\t/* set PHY Link Detect Timer to 1.1 second (11x 100ms) */\n\t\t\treg = 10;\n\n\t\t\t/* re-enable PEX PM in PEX PHY debug reg. 8 (clear bit 12) */\n\t\t\tsky2_write32(hw, Y2_PEX_PHY_DATA, PEX_DB_ACCESS | (0x08UL << 16));\n\t\t} else {\n\t\t\t/* set PHY Link Detect Timer to 0.4 second (4x 100ms) */\n\t\t\treg = 3;\n\t\t}\n\n\t\treg <<= PSM_CONFIG_REG4_TIMER_PHY_LINK_DETECT_BASE;\n\t\treg |= PSM_CONFIG_REG4_RST_PHY_LINK_DETECT;\n\n\t\t/* reset PHY Link Detect */\n\t\tsky2_write8(hw, B2_TST_CTRL1, TST_CFG_WRITE_ON);\n\t\tsky2_pci_write16(hw, PSM_CONFIG_REG4, reg);\n\n\t\t/* check if PSMv2 was running before */\n\t\treg = sky2_pci_read16(hw, PSM_CONFIG_REG3);\n\t\tif (reg & PCI_EXP_LNKCTL_ASPMC)\n\t\t\t/* restore the PCIe Link Control register */\n\t\t\tsky2_pci_write16(hw, pdev->pcie_cap + PCI_EXP_LNKCTL,\n\t\t\t\t\t reg);\n\n\t\tif (hw->chip_id == CHIP_ID_YUKON_PRM &&\n\t\t\thw->chip_rev == CHIP_REV_YU_PRM_A0) {\n\t\t\t/* change PHY Interrupt polarity to low active */\n\t\t\treg = sky2_read16(hw, GPHY_CTRL);\n\t\t\tsky2_write16(hw, GPHY_CTRL, reg | GPC_INTPOL);\n\n\t\t\t/* adapt HW for low active PHY Interrupt */\n\t\t\treg = sky2_read16(hw, Y2_CFG_SPC + PCI_LDO_CTRL);\n\t\t\tsky2_write16(hw, Y2_CFG_SPC + PCI_LDO_CTRL, reg | PHY_M_UNDOC1);\n\t\t}\n\n\t\tsky2_write8(hw, B2_TST_CTRL1, TST_CFG_WRITE_OFF);\n\n\t\t/* re-enable PEX PM in PEX PHY debug reg. 8 (clear bit 12) */\n\t\tsky2_write32(hw, Y2_PEX_PHY_DATA, PEX_DB_ACCESS | (0x08UL << 16));\n\t}\n\n\t/* Clear I2C IRQ noise */\n\tsky2_write32(hw, B2_I2C_IRQ, 1);\n\n\t/* turn off hardware timer (unused) */\n\tsky2_write8(hw, B2_TI_CTRL, TIM_STOP);\n\tsky2_write8(hw, B2_TI_CTRL, TIM_CLR_IRQ);\n\n\t/* Turn off descriptor polling */\n\tsky2_write32(hw, B28_DPT_CTRL, DPT_STOP);\n\n\t/* Turn off receive timestamp */\n\tsky2_write8(hw, GMAC_TI_ST_CTRL, GMT_ST_STOP);\n\tsky2_write8(hw, GMAC_TI_ST_CTRL, GMT_ST_CLR_IRQ);\n\n\t/* enable the Tx Arbiters */\n\tfor (i = 0; i < hw->ports; i++)\n\t\tsky2_write8(hw, SK_REG(i, TXA_CTRL), TXA_ENA_ARB);\n\n\t/* Initialize ram interface */\n\tfor (i = 0; i < hw->ports; i++) {\n\t\tsky2_write8(hw, RAM_BUFFER(i, B3_RI_CTRL), RI_RST_CLR);\n\n\t\tsky2_write8(hw, RAM_BUFFER(i, B3_RI_WTO_R1), SK_RI_TO_53);\n\t\tsky2_write8(hw, RAM_BUFFER(i, B3_RI_WTO_XA1), SK_RI_TO_53);\n\t\tsky2_write8(hw, RAM_BUFFER(i, B3_RI_WTO_XS1), SK_RI_TO_53);\n\t\tsky2_write8(hw, RAM_BUFFER(i, B3_RI_RTO_R1), SK_RI_TO_53);\n\t\tsky2_write8(hw, RAM_BUFFER(i, B3_RI_RTO_XA1), SK_RI_TO_53);\n\t\tsky2_write8(hw, RAM_BUFFER(i, B3_RI_RTO_XS1), SK_RI_TO_53);\n\t\tsky2_write8(hw, RAM_BUFFER(i, B3_RI_WTO_R2), SK_RI_TO_53);\n\t\tsky2_write8(hw, RAM_BUFFER(i, B3_RI_WTO_XA2), SK_RI_TO_53);\n\t\tsky2_write8(hw, RAM_BUFFER(i, B3_RI_WTO_XS2), SK_RI_TO_53);\n\t\tsky2_write8(hw, RAM_BUFFER(i, B3_RI_RTO_R2), SK_RI_TO_53);\n\t\tsky2_write8(hw, RAM_BUFFER(i, B3_RI_RTO_XA2), SK_RI_TO_53);\n\t\tsky2_write8(hw, RAM_BUFFER(i, B3_RI_RTO_XS2), SK_RI_TO_53);\n\t}\n\n\tsky2_write32(hw, B0_HWE_IMSK, hwe_mask);\n\n\tfor (i = 0; i < hw->ports; i++)\n\t\tsky2_gmac_reset(hw, i);\n\n\tmemset(hw->st_le, 0, hw->st_size * sizeof(struct sky2_status_le));\n\thw->st_idx = 0;\n\n\tsky2_write32(hw, STAT_CTRL, SC_STAT_RST_SET);\n\tsky2_write32(hw, STAT_CTRL, SC_STAT_RST_CLR);\n\n\tsky2_write32(hw, STAT_LIST_ADDR_LO, hw->st_dma);\n\tsky2_write32(hw, STAT_LIST_ADDR_HI, (u64) hw->st_dma >> 32);\n\n\t/* Set the list last index */\n\tsky2_write16(hw, STAT_LAST_IDX, hw->st_size - 1);\n\n\tsky2_write16(hw, STAT_TX_IDX_TH, 10);\n\tsky2_write8(hw, STAT_FIFO_WM, 16);\n\n\t/* set Status-FIFO ISR watermark */\n\tif (hw->chip_id == CHIP_ID_YUKON_XL && hw->chip_rev == 0)\n\t\tsky2_write8(hw, STAT_FIFO_ISR_WM, 4);\n\telse\n\t\tsky2_write8(hw, STAT_FIFO_ISR_WM, 16);\n\n\tsky2_write32(hw, STAT_TX_TIMER_INI, sky2_us2clk(hw, 1000));\n\tsky2_write32(hw, STAT_ISR_TIMER_INI, sky2_us2clk(hw, 20));\n\tsky2_write32(hw, STAT_LEV_TIMER_INI, sky2_us2clk(hw, 100));\n\n\t/* enable status unit */\n\tsky2_write32(hw, STAT_CTRL, SC_STAT_OP_ON);\n\n\tsky2_write8(hw, STAT_TX_TIMER_CTRL, TIM_START);\n\tsky2_write8(hw, STAT_LEV_TIMER_CTRL, TIM_START);\n\tsky2_write8(hw, STAT_ISR_TIMER_CTRL, TIM_START);\n}\n\n/* Take device down (offline).\n * Equivalent to doing dev_stop() but this does not\n * inform upper layers of the transition.\n */\nstatic void sky2_detach(struct net_device *dev)\n{\n\tif (netif_running(dev)) {\n\t\tnetif_tx_lock(dev);\n\t\tnetif_device_detach(dev);\t/* stop txq */\n\t\tnetif_tx_unlock(dev);\n\t\tsky2_close(dev);\n\t}\n}\n\n/* Bring device back after doing sky2_detach */\nstatic int sky2_reattach(struct net_device *dev)\n{\n\tint err = 0;\n\n\tif (netif_running(dev)) {\n\t\terr = sky2_open(dev);\n\t\tif (err) {\n\t\t\tnetdev_info(dev, \"could not restart %d\\n\", err);\n\t\t\tdev_close(dev);\n\t\t} else {\n\t\t\tnetif_device_attach(dev);\n\t\t\tsky2_set_multicast(dev);\n\t\t}\n\t}\n\n\treturn err;\n}\n\nstatic void sky2_all_down(struct sky2_hw *hw)\n{\n\tint i;\n\n\tif (hw->flags & SKY2_HW_IRQ_SETUP) {\n\t\tsky2_write32(hw, B0_IMSK, 0);\n\t\tsky2_read32(hw, B0_IMSK);\n\n\t\tsynchronize_irq(hw->pdev->irq);\n\t\tnapi_disable(&hw->napi);\n\t}\n\n\tfor (i = 0; i < hw->ports; i++) {\n\t\tstruct net_device *dev = hw->dev[i];\n\t\tstruct sky2_port *sky2 = netdev_priv(dev);\n\n\t\tif (!netif_running(dev))\n\t\t\tcontinue;\n\n\t\tnetif_carrier_off(dev);\n\t\tnetif_tx_disable(dev);\n\t\tsky2_hw_down(sky2);\n\t}\n}\n\nstatic void sky2_all_up(struct sky2_hw *hw)\n{\n\tu32 imask = Y2_IS_BASE;\n\tint i;\n\n\tfor (i = 0; i < hw->ports; i++) {\n\t\tstruct net_device *dev = hw->dev[i];\n\t\tstruct sky2_port *sky2 = netdev_priv(dev);\n\n\t\tif (!netif_running(dev))\n\t\t\tcontinue;\n\n\t\tsky2_hw_up(sky2);\n\t\tsky2_set_multicast(dev);\n\t\timask |= portirq_msk[i];\n\t\tnetif_wake_queue(dev);\n\t}\n\n\tif (hw->flags & SKY2_HW_IRQ_SETUP) {\n\t\tsky2_write32(hw, B0_IMSK, imask);\n\t\tsky2_read32(hw, B0_IMSK);\n\t\tsky2_read32(hw, B0_Y2_SP_LISR);\n\t\tnapi_enable(&hw->napi);\n\t}\n}\n\nstatic void sky2_restart(struct work_struct *work)\n{\n\tstruct sky2_hw *hw = container_of(work, struct sky2_hw, restart_work);\n\n\trtnl_lock();\n\n\tsky2_all_down(hw);\n\tsky2_reset(hw);\n\tsky2_all_up(hw);\n\n\trtnl_unlock();\n}\n\nstatic inline u8 sky2_wol_supported(const struct sky2_hw *hw)\n{\n\treturn sky2_is_copper(hw) ? (WAKE_PHY | WAKE_MAGIC) : 0;\n}\n\nstatic void sky2_get_wol(struct net_device *dev, struct ethtool_wolinfo *wol)\n{\n\tconst struct sky2_port *sky2 = netdev_priv(dev);\n\n\twol->supported = sky2_wol_supported(sky2->hw);\n\twol->wolopts = sky2->wol;\n}\n\nstatic int sky2_set_wol(struct net_device *dev, struct ethtool_wolinfo *wol)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tstruct sky2_hw *hw = sky2->hw;\n\tbool enable_wakeup = false;\n\tint i;\n\n\tif ((wol->wolopts & ~sky2_wol_supported(sky2->hw)) ||\n\t    !device_can_wakeup(&hw->pdev->dev))\n\t\treturn -EOPNOTSUPP;\n\n\tsky2->wol = wol->wolopts;\n\n\tfor (i = 0; i < hw->ports; i++) {\n\t\tstruct net_device *dev = hw->dev[i];\n\t\tstruct sky2_port *sky2 = netdev_priv(dev);\n\n\t\tif (sky2->wol)\n\t\t\tenable_wakeup = true;\n\t}\n\tdevice_set_wakeup_enable(&hw->pdev->dev, enable_wakeup);\n\n\treturn 0;\n}\n\nstatic u32 sky2_supported_modes(const struct sky2_hw *hw)\n{\n\tif (sky2_is_copper(hw)) {\n\t\tu32 modes = SUPPORTED_10baseT_Half\n\t\t\t| SUPPORTED_10baseT_Full\n\t\t\t| SUPPORTED_100baseT_Half\n\t\t\t| SUPPORTED_100baseT_Full;\n\n\t\tif (hw->flags & SKY2_HW_GIGABIT)\n\t\t\tmodes |= SUPPORTED_1000baseT_Half\n\t\t\t\t| SUPPORTED_1000baseT_Full;\n\t\treturn modes;\n\t} else\n\t\treturn SUPPORTED_1000baseT_Half\n\t\t\t| SUPPORTED_1000baseT_Full;\n}\n\nstatic int sky2_get_link_ksettings(struct net_device *dev,\n\t\t\t\t   struct ethtool_link_ksettings *cmd)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tstruct sky2_hw *hw = sky2->hw;\n\tu32 supported, advertising;\n\n\tsupported = sky2_supported_modes(hw);\n\tcmd->base.phy_address = PHY_ADDR_MARV;\n\tif (sky2_is_copper(hw)) {\n\t\tcmd->base.port = PORT_TP;\n\t\tcmd->base.speed = sky2->speed;\n\t\tsupported |=  SUPPORTED_Autoneg | SUPPORTED_TP;\n\t} else {\n\t\tcmd->base.speed = SPEED_1000;\n\t\tcmd->base.port = PORT_FIBRE;\n\t\tsupported |=  SUPPORTED_Autoneg | SUPPORTED_FIBRE;\n\t}\n\n\tadvertising = sky2->advertising;\n\tcmd->base.autoneg = (sky2->flags & SKY2_FLAG_AUTO_SPEED)\n\t\t? AUTONEG_ENABLE : AUTONEG_DISABLE;\n\tcmd->base.duplex = sky2->duplex;\n\n\tethtool_convert_legacy_u32_to_link_mode(cmd->link_modes.supported,\n\t\t\t\t\t\tsupported);\n\tethtool_convert_legacy_u32_to_link_mode(cmd->link_modes.advertising,\n\t\t\t\t\t\tadvertising);\n\n\treturn 0;\n}\n\nstatic int sky2_set_link_ksettings(struct net_device *dev,\n\t\t\t\t   const struct ethtool_link_ksettings *cmd)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tconst struct sky2_hw *hw = sky2->hw;\n\tu32 supported = sky2_supported_modes(hw);\n\tu32 new_advertising;\n\n\tethtool_convert_link_mode_to_legacy_u32(&new_advertising,\n\t\t\t\t\t\tcmd->link_modes.advertising);\n\n\tif (cmd->base.autoneg == AUTONEG_ENABLE) {\n\t\tif (new_advertising & ~supported)\n\t\t\treturn -EINVAL;\n\n\t\tif (sky2_is_copper(hw))\n\t\t\tsky2->advertising = new_advertising |\n\t\t\t\t\t    ADVERTISED_TP |\n\t\t\t\t\t    ADVERTISED_Autoneg;\n\t\telse\n\t\t\tsky2->advertising = new_advertising |\n\t\t\t\t\t    ADVERTISED_FIBRE |\n\t\t\t\t\t    ADVERTISED_Autoneg;\n\n\t\tsky2->flags |= SKY2_FLAG_AUTO_SPEED;\n\t\tsky2->duplex = -1;\n\t\tsky2->speed = -1;\n\t} else {\n\t\tu32 setting;\n\t\tu32 speed = cmd->base.speed;\n\n\t\tswitch (speed) {\n\t\tcase SPEED_1000:\n\t\t\tif (cmd->base.duplex == DUPLEX_FULL)\n\t\t\t\tsetting = SUPPORTED_1000baseT_Full;\n\t\t\telse if (cmd->base.duplex == DUPLEX_HALF)\n\t\t\t\tsetting = SUPPORTED_1000baseT_Half;\n\t\t\telse\n\t\t\t\treturn -EINVAL;\n\t\t\tbreak;\n\t\tcase SPEED_100:\n\t\t\tif (cmd->base.duplex == DUPLEX_FULL)\n\t\t\t\tsetting = SUPPORTED_100baseT_Full;\n\t\t\telse if (cmd->base.duplex == DUPLEX_HALF)\n\t\t\t\tsetting = SUPPORTED_100baseT_Half;\n\t\t\telse\n\t\t\t\treturn -EINVAL;\n\t\t\tbreak;\n\n\t\tcase SPEED_10:\n\t\t\tif (cmd->base.duplex == DUPLEX_FULL)\n\t\t\t\tsetting = SUPPORTED_10baseT_Full;\n\t\t\telse if (cmd->base.duplex == DUPLEX_HALF)\n\t\t\t\tsetting = SUPPORTED_10baseT_Half;\n\t\t\telse\n\t\t\t\treturn -EINVAL;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tif ((setting & supported) == 0)\n\t\t\treturn -EINVAL;\n\n\t\tsky2->speed = speed;\n\t\tsky2->duplex = cmd->base.duplex;\n\t\tsky2->flags &= ~SKY2_FLAG_AUTO_SPEED;\n\t}\n\n\tif (netif_running(dev)) {\n\t\tsky2_phy_reinit(sky2);\n\t\tsky2_set_multicast(dev);\n\t}\n\n\treturn 0;\n}\n\nstatic void sky2_get_drvinfo(struct net_device *dev,\n\t\t\t     struct ethtool_drvinfo *info)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\n\tstrlcpy(info->driver, DRV_NAME, sizeof(info->driver));\n\tstrlcpy(info->version, DRV_VERSION, sizeof(info->version));\n\tstrlcpy(info->bus_info, pci_name(sky2->hw->pdev),\n\t\tsizeof(info->bus_info));\n}\n\nstatic const struct sky2_stat {\n\tchar name[ETH_GSTRING_LEN];\n\tu16 offset;\n} sky2_stats[] = {\n\t{ \"tx_bytes\",\t   GM_TXO_OK_HI },\n\t{ \"rx_bytes\",\t   GM_RXO_OK_HI },\n\t{ \"tx_broadcast\",  GM_TXF_BC_OK },\n\t{ \"rx_broadcast\",  GM_RXF_BC_OK },\n\t{ \"tx_multicast\",  GM_TXF_MC_OK },\n\t{ \"rx_multicast\",  GM_RXF_MC_OK },\n\t{ \"tx_unicast\",    GM_TXF_UC_OK },\n\t{ \"rx_unicast\",    GM_RXF_UC_OK },\n\t{ \"tx_mac_pause\",  GM_TXF_MPAUSE },\n\t{ \"rx_mac_pause\",  GM_RXF_MPAUSE },\n\t{ \"collisions\",    GM_TXF_COL },\n\t{ \"late_collision\",GM_TXF_LAT_COL },\n\t{ \"aborted\", \t   GM_TXF_ABO_COL },\n\t{ \"single_collisions\", GM_TXF_SNG_COL },\n\t{ \"multi_collisions\", GM_TXF_MUL_COL },\n\n\t{ \"rx_short\",      GM_RXF_SHT },\n\t{ \"rx_runt\", \t   GM_RXE_FRAG },\n\t{ \"rx_64_byte_packets\", GM_RXF_64B },\n\t{ \"rx_65_to_127_byte_packets\", GM_RXF_127B },\n\t{ \"rx_128_to_255_byte_packets\", GM_RXF_255B },\n\t{ \"rx_256_to_511_byte_packets\", GM_RXF_511B },\n\t{ \"rx_512_to_1023_byte_packets\", GM_RXF_1023B },\n\t{ \"rx_1024_to_1518_byte_packets\", GM_RXF_1518B },\n\t{ \"rx_1518_to_max_byte_packets\", GM_RXF_MAX_SZ },\n\t{ \"rx_too_long\",   GM_RXF_LNG_ERR },\n\t{ \"rx_fifo_overflow\", GM_RXE_FIFO_OV },\n\t{ \"rx_jabber\",     GM_RXF_JAB_PKT },\n\t{ \"rx_fcs_error\",   GM_RXF_FCS_ERR },\n\n\t{ \"tx_64_byte_packets\", GM_TXF_64B },\n\t{ \"tx_65_to_127_byte_packets\", GM_TXF_127B },\n\t{ \"tx_128_to_255_byte_packets\", GM_TXF_255B },\n\t{ \"tx_256_to_511_byte_packets\", GM_TXF_511B },\n\t{ \"tx_512_to_1023_byte_packets\", GM_TXF_1023B },\n\t{ \"tx_1024_to_1518_byte_packets\", GM_TXF_1518B },\n\t{ \"tx_1519_to_max_byte_packets\", GM_TXF_MAX_SZ },\n\t{ \"tx_fifo_underrun\", GM_TXE_FIFO_UR },\n};\n\nstatic u32 sky2_get_msglevel(struct net_device *netdev)\n{\n\tstruct sky2_port *sky2 = netdev_priv(netdev);\n\treturn sky2->msg_enable;\n}\n\nstatic int sky2_nway_reset(struct net_device *dev)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\n\tif (!netif_running(dev) || !(sky2->flags & SKY2_FLAG_AUTO_SPEED))\n\t\treturn -EINVAL;\n\n\tsky2_phy_reinit(sky2);\n\tsky2_set_multicast(dev);\n\n\treturn 0;\n}\n\nstatic void sky2_phy_stats(struct sky2_port *sky2, u64 * data, unsigned count)\n{\n\tstruct sky2_hw *hw = sky2->hw;\n\tunsigned port = sky2->port;\n\tint i;\n\n\tdata[0] = get_stats64(hw, port, GM_TXO_OK_LO);\n\tdata[1] = get_stats64(hw, port, GM_RXO_OK_LO);\n\n\tfor (i = 2; i < count; i++)\n\t\tdata[i] = get_stats32(hw, port, sky2_stats[i].offset);\n}\n\nstatic void sky2_set_msglevel(struct net_device *netdev, u32 value)\n{\n\tstruct sky2_port *sky2 = netdev_priv(netdev);\n\tsky2->msg_enable = value;\n}\n\nstatic int sky2_get_sset_count(struct net_device *dev, int sset)\n{\n\tswitch (sset) {\n\tcase ETH_SS_STATS:\n\t\treturn ARRAY_SIZE(sky2_stats);\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic void sky2_get_ethtool_stats(struct net_device *dev,\n\t\t\t\t   struct ethtool_stats *stats, u64 * data)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\n\tsky2_phy_stats(sky2, data, ARRAY_SIZE(sky2_stats));\n}\n\nstatic void sky2_get_strings(struct net_device *dev, u32 stringset, u8 * data)\n{\n\tint i;\n\n\tswitch (stringset) {\n\tcase ETH_SS_STATS:\n\t\tfor (i = 0; i < ARRAY_SIZE(sky2_stats); i++)\n\t\t\tmemcpy(data + i * ETH_GSTRING_LEN,\n\t\t\t       sky2_stats[i].name, ETH_GSTRING_LEN);\n\t\tbreak;\n\t}\n}\n\nstatic int sky2_set_mac_address(struct net_device *dev, void *p)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tstruct sky2_hw *hw = sky2->hw;\n\tunsigned port = sky2->port;\n\tconst struct sockaddr *addr = p;\n\n\tif (!is_valid_ether_addr(addr->sa_data))\n\t\treturn -EADDRNOTAVAIL;\n\n\tmemcpy(dev->dev_addr, addr->sa_data, ETH_ALEN);\n\tmemcpy_toio(hw->regs + B2_MAC_1 + port * 8,\n\t\t    dev->dev_addr, ETH_ALEN);\n\tmemcpy_toio(hw->regs + B2_MAC_2 + port * 8,\n\t\t    dev->dev_addr, ETH_ALEN);\n\n\t/* virtual address for data */\n\tgma_set_addr(hw, port, GM_SRC_ADDR_2L, dev->dev_addr);\n\n\t/* physical address: used for pause frames */\n\tgma_set_addr(hw, port, GM_SRC_ADDR_1L, dev->dev_addr);\n\n\treturn 0;\n}\n\nstatic inline void sky2_add_filter(u8 filter[8], const u8 *addr)\n{\n\tu32 bit;\n\n\tbit = ether_crc(ETH_ALEN, addr) & 63;\n\tfilter[bit >> 3] |= 1 << (bit & 7);\n}\n\nstatic void sky2_set_multicast(struct net_device *dev)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tstruct sky2_hw *hw = sky2->hw;\n\tunsigned port = sky2->port;\n\tstruct netdev_hw_addr *ha;\n\tu16 reg;\n\tu8 filter[8];\n\tint rx_pause;\n\tstatic const u8 pause_mc_addr[ETH_ALEN] = { 0x1, 0x80, 0xc2, 0x0, 0x0, 0x1 };\n\n\trx_pause = (sky2->flow_status == FC_RX || sky2->flow_status == FC_BOTH);\n\tmemset(filter, 0, sizeof(filter));\n\n\treg = gma_read16(hw, port, GM_RX_CTRL);\n\treg |= GM_RXCR_UCF_ENA;\n\n\tif (dev->flags & IFF_PROMISC)\t/* promiscuous */\n\t\treg &= ~(GM_RXCR_UCF_ENA | GM_RXCR_MCF_ENA);\n\telse if (dev->flags & IFF_ALLMULTI)\n\t\tmemset(filter, 0xff, sizeof(filter));\n\telse if (netdev_mc_empty(dev) && !rx_pause)\n\t\treg &= ~GM_RXCR_MCF_ENA;\n\telse {\n\t\treg |= GM_RXCR_MCF_ENA;\n\n\t\tif (rx_pause)\n\t\t\tsky2_add_filter(filter, pause_mc_addr);\n\n\t\tnetdev_for_each_mc_addr(ha, dev)\n\t\t\tsky2_add_filter(filter, ha->addr);\n\t}\n\n\tgma_write16(hw, port, GM_MC_ADDR_H1,\n\t\t    (u16) filter[0] | ((u16) filter[1] << 8));\n\tgma_write16(hw, port, GM_MC_ADDR_H2,\n\t\t    (u16) filter[2] | ((u16) filter[3] << 8));\n\tgma_write16(hw, port, GM_MC_ADDR_H3,\n\t\t    (u16) filter[4] | ((u16) filter[5] << 8));\n\tgma_write16(hw, port, GM_MC_ADDR_H4,\n\t\t    (u16) filter[6] | ((u16) filter[7] << 8));\n\n\tgma_write16(hw, port, GM_RX_CTRL, reg);\n}\n\nstatic void sky2_get_stats(struct net_device *dev,\n\t\t\t   struct rtnl_link_stats64 *stats)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tstruct sky2_hw *hw = sky2->hw;\n\tunsigned port = sky2->port;\n\tunsigned int start;\n\tu64 _bytes, _packets;\n\n\tdo {\n\t\tstart = u64_stats_fetch_begin_irq(&sky2->rx_stats.syncp);\n\t\t_bytes = sky2->rx_stats.bytes;\n\t\t_packets = sky2->rx_stats.packets;\n\t} while (u64_stats_fetch_retry_irq(&sky2->rx_stats.syncp, start));\n\n\tstats->rx_packets = _packets;\n\tstats->rx_bytes = _bytes;\n\n\tdo {\n\t\tstart = u64_stats_fetch_begin_irq(&sky2->tx_stats.syncp);\n\t\t_bytes = sky2->tx_stats.bytes;\n\t\t_packets = sky2->tx_stats.packets;\n\t} while (u64_stats_fetch_retry_irq(&sky2->tx_stats.syncp, start));\n\n\tstats->tx_packets = _packets;\n\tstats->tx_bytes = _bytes;\n\n\tstats->multicast = get_stats32(hw, port, GM_RXF_MC_OK)\n\t\t+ get_stats32(hw, port, GM_RXF_BC_OK);\n\n\tstats->collisions = get_stats32(hw, port, GM_TXF_COL);\n\n\tstats->rx_length_errors = get_stats32(hw, port, GM_RXF_LNG_ERR);\n\tstats->rx_crc_errors = get_stats32(hw, port, GM_RXF_FCS_ERR);\n\tstats->rx_frame_errors = get_stats32(hw, port, GM_RXF_SHT)\n\t\t+ get_stats32(hw, port, GM_RXE_FRAG);\n\tstats->rx_over_errors = get_stats32(hw, port, GM_RXE_FIFO_OV);\n\n\tstats->rx_dropped = dev->stats.rx_dropped;\n\tstats->rx_fifo_errors = dev->stats.rx_fifo_errors;\n\tstats->tx_fifo_errors = dev->stats.tx_fifo_errors;\n}\n\n/* Can have one global because blinking is controlled by\n * ethtool and that is always under RTNL mutex\n */\nstatic void sky2_led(struct sky2_port *sky2, enum led_mode mode)\n{\n\tstruct sky2_hw *hw = sky2->hw;\n\tunsigned port = sky2->port;\n\n\tspin_lock_bh(&sky2->phy_lock);\n\tif (hw->chip_id == CHIP_ID_YUKON_EC_U ||\n\t    hw->chip_id == CHIP_ID_YUKON_EX ||\n\t    hw->chip_id == CHIP_ID_YUKON_SUPR) {\n\t\tu16 pg;\n\t\tpg = gm_phy_read(hw, port, PHY_MARV_EXT_ADR);\n\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, 3);\n\n\t\tswitch (mode) {\n\t\tcase MO_LED_OFF:\n\t\t\tgm_phy_write(hw, port, PHY_MARV_PHY_CTRL,\n\t\t\t\t     PHY_M_LEDC_LOS_CTRL(8) |\n\t\t\t\t     PHY_M_LEDC_INIT_CTRL(8) |\n\t\t\t\t     PHY_M_LEDC_STA1_CTRL(8) |\n\t\t\t\t     PHY_M_LEDC_STA0_CTRL(8));\n\t\t\tbreak;\n\t\tcase MO_LED_ON:\n\t\t\tgm_phy_write(hw, port, PHY_MARV_PHY_CTRL,\n\t\t\t\t     PHY_M_LEDC_LOS_CTRL(9) |\n\t\t\t\t     PHY_M_LEDC_INIT_CTRL(9) |\n\t\t\t\t     PHY_M_LEDC_STA1_CTRL(9) |\n\t\t\t\t     PHY_M_LEDC_STA0_CTRL(9));\n\t\t\tbreak;\n\t\tcase MO_LED_BLINK:\n\t\t\tgm_phy_write(hw, port, PHY_MARV_PHY_CTRL,\n\t\t\t\t     PHY_M_LEDC_LOS_CTRL(0xa) |\n\t\t\t\t     PHY_M_LEDC_INIT_CTRL(0xa) |\n\t\t\t\t     PHY_M_LEDC_STA1_CTRL(0xa) |\n\t\t\t\t     PHY_M_LEDC_STA0_CTRL(0xa));\n\t\t\tbreak;\n\t\tcase MO_LED_NORM:\n\t\t\tgm_phy_write(hw, port, PHY_MARV_PHY_CTRL,\n\t\t\t\t     PHY_M_LEDC_LOS_CTRL(1) |\n\t\t\t\t     PHY_M_LEDC_INIT_CTRL(8) |\n\t\t\t\t     PHY_M_LEDC_STA1_CTRL(7) |\n\t\t\t\t     PHY_M_LEDC_STA0_CTRL(7));\n\t\t}\n\n\t\tgm_phy_write(hw, port, PHY_MARV_EXT_ADR, pg);\n\t} else\n\t\tgm_phy_write(hw, port, PHY_MARV_LED_OVER,\n\t\t\t\t     PHY_M_LED_MO_DUP(mode) |\n\t\t\t\t     PHY_M_LED_MO_10(mode) |\n\t\t\t\t     PHY_M_LED_MO_100(mode) |\n\t\t\t\t     PHY_M_LED_MO_1000(mode) |\n\t\t\t\t     PHY_M_LED_MO_RX(mode) |\n\t\t\t\t     PHY_M_LED_MO_TX(mode));\n\n\tspin_unlock_bh(&sky2->phy_lock);\n}\n\n/* blink LED's for finding board */\nstatic int sky2_set_phys_id(struct net_device *dev,\n\t\t\t    enum ethtool_phys_id_state state)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\n\tswitch (state) {\n\tcase ETHTOOL_ID_ACTIVE:\n\t\treturn 1;\t/* cycle on/off once per second */\n\tcase ETHTOOL_ID_INACTIVE:\n\t\tsky2_led(sky2, MO_LED_NORM);\n\t\tbreak;\n\tcase ETHTOOL_ID_ON:\n\t\tsky2_led(sky2, MO_LED_ON);\n\t\tbreak;\n\tcase ETHTOOL_ID_OFF:\n\t\tsky2_led(sky2, MO_LED_OFF);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic void sky2_get_pauseparam(struct net_device *dev,\n\t\t\t\tstruct ethtool_pauseparam *ecmd)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\n\tswitch (sky2->flow_mode) {\n\tcase FC_NONE:\n\t\tecmd->tx_pause = ecmd->rx_pause = 0;\n\t\tbreak;\n\tcase FC_TX:\n\t\tecmd->tx_pause = 1, ecmd->rx_pause = 0;\n\t\tbreak;\n\tcase FC_RX:\n\t\tecmd->tx_pause = 0, ecmd->rx_pause = 1;\n\t\tbreak;\n\tcase FC_BOTH:\n\t\tecmd->tx_pause = ecmd->rx_pause = 1;\n\t}\n\n\tecmd->autoneg = (sky2->flags & SKY2_FLAG_AUTO_PAUSE)\n\t\t? AUTONEG_ENABLE : AUTONEG_DISABLE;\n}\n\nstatic int sky2_set_pauseparam(struct net_device *dev,\n\t\t\t       struct ethtool_pauseparam *ecmd)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\n\tif (ecmd->autoneg == AUTONEG_ENABLE)\n\t\tsky2->flags |= SKY2_FLAG_AUTO_PAUSE;\n\telse\n\t\tsky2->flags &= ~SKY2_FLAG_AUTO_PAUSE;\n\n\tsky2->flow_mode = sky2_flow(ecmd->rx_pause, ecmd->tx_pause);\n\n\tif (netif_running(dev))\n\t\tsky2_phy_reinit(sky2);\n\n\treturn 0;\n}\n\nstatic int sky2_get_coalesce(struct net_device *dev,\n\t\t\t     struct ethtool_coalesce *ecmd)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tstruct sky2_hw *hw = sky2->hw;\n\n\tif (sky2_read8(hw, STAT_TX_TIMER_CTRL) == TIM_STOP)\n\t\tecmd->tx_coalesce_usecs = 0;\n\telse {\n\t\tu32 clks = sky2_read32(hw, STAT_TX_TIMER_INI);\n\t\tecmd->tx_coalesce_usecs = sky2_clk2us(hw, clks);\n\t}\n\tecmd->tx_max_coalesced_frames = sky2_read16(hw, STAT_TX_IDX_TH);\n\n\tif (sky2_read8(hw, STAT_LEV_TIMER_CTRL) == TIM_STOP)\n\t\tecmd->rx_coalesce_usecs = 0;\n\telse {\n\t\tu32 clks = sky2_read32(hw, STAT_LEV_TIMER_INI);\n\t\tecmd->rx_coalesce_usecs = sky2_clk2us(hw, clks);\n\t}\n\tecmd->rx_max_coalesced_frames = sky2_read8(hw, STAT_FIFO_WM);\n\n\tif (sky2_read8(hw, STAT_ISR_TIMER_CTRL) == TIM_STOP)\n\t\tecmd->rx_coalesce_usecs_irq = 0;\n\telse {\n\t\tu32 clks = sky2_read32(hw, STAT_ISR_TIMER_INI);\n\t\tecmd->rx_coalesce_usecs_irq = sky2_clk2us(hw, clks);\n\t}\n\n\tecmd->rx_max_coalesced_frames_irq = sky2_read8(hw, STAT_FIFO_ISR_WM);\n\n\treturn 0;\n}\n\n/* Note: this affect both ports */\nstatic int sky2_set_coalesce(struct net_device *dev,\n\t\t\t     struct ethtool_coalesce *ecmd)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tstruct sky2_hw *hw = sky2->hw;\n\tconst u32 tmax = sky2_clk2us(hw, 0x0ffffff);\n\n\tif (ecmd->tx_coalesce_usecs > tmax ||\n\t    ecmd->rx_coalesce_usecs > tmax ||\n\t    ecmd->rx_coalesce_usecs_irq > tmax)\n\t\treturn -EINVAL;\n\n\tif (ecmd->tx_max_coalesced_frames >= sky2->tx_ring_size-1)\n\t\treturn -EINVAL;\n\tif (ecmd->rx_max_coalesced_frames > RX_MAX_PENDING)\n\t\treturn -EINVAL;\n\tif (ecmd->rx_max_coalesced_frames_irq > RX_MAX_PENDING)\n\t\treturn -EINVAL;\n\n\tif (ecmd->tx_coalesce_usecs == 0)\n\t\tsky2_write8(hw, STAT_TX_TIMER_CTRL, TIM_STOP);\n\telse {\n\t\tsky2_write32(hw, STAT_TX_TIMER_INI,\n\t\t\t     sky2_us2clk(hw, ecmd->tx_coalesce_usecs));\n\t\tsky2_write8(hw, STAT_TX_TIMER_CTRL, TIM_START);\n\t}\n\tsky2_write16(hw, STAT_TX_IDX_TH, ecmd->tx_max_coalesced_frames);\n\n\tif (ecmd->rx_coalesce_usecs == 0)\n\t\tsky2_write8(hw, STAT_LEV_TIMER_CTRL, TIM_STOP);\n\telse {\n\t\tsky2_write32(hw, STAT_LEV_TIMER_INI,\n\t\t\t     sky2_us2clk(hw, ecmd->rx_coalesce_usecs));\n\t\tsky2_write8(hw, STAT_LEV_TIMER_CTRL, TIM_START);\n\t}\n\tsky2_write8(hw, STAT_FIFO_WM, ecmd->rx_max_coalesced_frames);\n\n\tif (ecmd->rx_coalesce_usecs_irq == 0)\n\t\tsky2_write8(hw, STAT_ISR_TIMER_CTRL, TIM_STOP);\n\telse {\n\t\tsky2_write32(hw, STAT_ISR_TIMER_INI,\n\t\t\t     sky2_us2clk(hw, ecmd->rx_coalesce_usecs_irq));\n\t\tsky2_write8(hw, STAT_ISR_TIMER_CTRL, TIM_START);\n\t}\n\tsky2_write8(hw, STAT_FIFO_ISR_WM, ecmd->rx_max_coalesced_frames_irq);\n\treturn 0;\n}\n\n/*\n * Hardware is limited to min of 128 and max of 2048 for ring size\n * and  rounded up to next power of two\n * to avoid division in modulus calclation\n */\nstatic unsigned long roundup_ring_size(unsigned long pending)\n{\n\treturn max(128ul, roundup_pow_of_two(pending+1));\n}\n\nstatic void sky2_get_ringparam(struct net_device *dev,\n\t\t\t       struct ethtool_ringparam *ering)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\n\tering->rx_max_pending = RX_MAX_PENDING;\n\tering->tx_max_pending = TX_MAX_PENDING;\n\n\tering->rx_pending = sky2->rx_pending;\n\tering->tx_pending = sky2->tx_pending;\n}\n\nstatic int sky2_set_ringparam(struct net_device *dev,\n\t\t\t      struct ethtool_ringparam *ering)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\n\tif (ering->rx_pending > RX_MAX_PENDING ||\n\t    ering->rx_pending < 8 ||\n\t    ering->tx_pending < TX_MIN_PENDING ||\n\t    ering->tx_pending > TX_MAX_PENDING)\n\t\treturn -EINVAL;\n\n\tsky2_detach(dev);\n\n\tsky2->rx_pending = ering->rx_pending;\n\tsky2->tx_pending = ering->tx_pending;\n\tsky2->tx_ring_size = roundup_ring_size(sky2->tx_pending);\n\n\treturn sky2_reattach(dev);\n}\n\nstatic int sky2_get_regs_len(struct net_device *dev)\n{\n\treturn 0x4000;\n}\n\nstatic int sky2_reg_access_ok(struct sky2_hw *hw, unsigned int b)\n{\n\t/* This complicated switch statement is to make sure and\n\t * only access regions that are unreserved.\n\t * Some blocks are only valid on dual port cards.\n\t */\n\tswitch (b) {\n\t/* second port */\n\tcase 5:\t\t/* Tx Arbiter 2 */\n\tcase 9:\t\t/* RX2 */\n\tcase 14 ... 15:\t/* TX2 */\n\tcase 17: case 19: /* Ram Buffer 2 */\n\tcase 22 ... 23: /* Tx Ram Buffer 2 */\n\tcase 25:\t/* Rx MAC Fifo 1 */\n\tcase 27:\t/* Tx MAC Fifo 2 */\n\tcase 31:\t/* GPHY 2 */\n\tcase 40 ... 47: /* Pattern Ram 2 */\n\tcase 52: case 54: /* TCP Segmentation 2 */\n\tcase 112 ... 116: /* GMAC 2 */\n\t\treturn hw->ports > 1;\n\n\tcase 0:\t\t/* Control */\n\tcase 2:\t\t/* Mac address */\n\tcase 4:\t\t/* Tx Arbiter 1 */\n\tcase 7:\t\t/* PCI express reg */\n\tcase 8:\t\t/* RX1 */\n\tcase 12 ... 13: /* TX1 */\n\tcase 16: case 18:/* Rx Ram Buffer 1 */\n\tcase 20 ... 21: /* Tx Ram Buffer 1 */\n\tcase 24:\t/* Rx MAC Fifo 1 */\n\tcase 26:\t/* Tx MAC Fifo 1 */\n\tcase 28 ... 29: /* Descriptor and status unit */\n\tcase 30:\t/* GPHY 1*/\n\tcase 32 ... 39: /* Pattern Ram 1 */\n\tcase 48: case 50: /* TCP Segmentation 1 */\n\tcase 56 ... 60:\t/* PCI space */\n\tcase 80 ... 84:\t/* GMAC 1 */\n\t\treturn 1;\n\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\n/*\n * Returns copy of control register region\n * Note: ethtool_get_regs always provides full size (16k) buffer\n */\nstatic void sky2_get_regs(struct net_device *dev, struct ethtool_regs *regs,\n\t\t\t  void *p)\n{\n\tconst struct sky2_port *sky2 = netdev_priv(dev);\n\tconst void __iomem *io = sky2->hw->regs;\n\tunsigned int b;\n\n\tregs->version = 1;\n\n\tfor (b = 0; b < 128; b++) {\n\t\t/* skip poisonous diagnostic ram region in block 3 */\n\t\tif (b == 3)\n\t\t\tmemcpy_fromio(p + 0x10, io + 0x10, 128 - 0x10);\n\t\telse if (sky2_reg_access_ok(sky2->hw, b))\n\t\t\tmemcpy_fromio(p, io, 128);\n\t\telse\n\t\t\tmemset(p, 0, 128);\n\n\t\tp += 128;\n\t\tio += 128;\n\t}\n}\n\nstatic int sky2_get_eeprom_len(struct net_device *dev)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tstruct sky2_hw *hw = sky2->hw;\n\tu16 reg2;\n\n\treg2 = sky2_pci_read16(hw, PCI_DEV_REG2);\n\treturn 1 << ( ((reg2 & PCI_VPD_ROM_SZ) >> 14) + 8);\n}\n\nstatic int sky2_vpd_wait(const struct sky2_hw *hw, int cap, u16 busy)\n{\n\tunsigned long start = jiffies;\n\n\twhile ( (sky2_pci_read16(hw, cap + PCI_VPD_ADDR) & PCI_VPD_ADDR_F) == busy) {\n\t\t/* Can take up to 10.6 ms for write */\n\t\tif (time_after(jiffies, start + HZ/4)) {\n\t\t\tdev_err(&hw->pdev->dev, \"VPD cycle timed out\\n\");\n\t\t\treturn -ETIMEDOUT;\n\t\t}\n\t\tmsleep(1);\n\t}\n\n\treturn 0;\n}\n\nstatic int sky2_vpd_read(struct sky2_hw *hw, int cap, void *data,\n\t\t\t u16 offset, size_t length)\n{\n\tint rc = 0;\n\n\twhile (length > 0) {\n\t\tu32 val;\n\n\t\tsky2_pci_write16(hw, cap + PCI_VPD_ADDR, offset);\n\t\trc = sky2_vpd_wait(hw, cap, 0);\n\t\tif (rc)\n\t\t\tbreak;\n\n\t\tval = sky2_pci_read32(hw, cap + PCI_VPD_DATA);\n\n\t\tmemcpy(data, &val, min(sizeof(val), length));\n\t\toffset += sizeof(u32);\n\t\tdata += sizeof(u32);\n\t\tlength -= sizeof(u32);\n\t}\n\n\treturn rc;\n}\n\nstatic int sky2_vpd_write(struct sky2_hw *hw, int cap, const void *data,\n\t\t\t  u16 offset, unsigned int length)\n{\n\tunsigned int i;\n\tint rc = 0;\n\n\tfor (i = 0; i < length; i += sizeof(u32)) {\n\t\tu32 val = *(u32 *)(data + i);\n\n\t\tsky2_pci_write32(hw, cap + PCI_VPD_DATA, val);\n\t\tsky2_pci_write32(hw, cap + PCI_VPD_ADDR, offset | PCI_VPD_ADDR_F);\n\n\t\trc = sky2_vpd_wait(hw, cap, PCI_VPD_ADDR_F);\n\t\tif (rc)\n\t\t\tbreak;\n\t}\n\treturn rc;\n}\n\nstatic int sky2_get_eeprom(struct net_device *dev, struct ethtool_eeprom *eeprom,\n\t\t\t   u8 *data)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tint cap = pci_find_capability(sky2->hw->pdev, PCI_CAP_ID_VPD);\n\n\tif (!cap)\n\t\treturn -EINVAL;\n\n\teeprom->magic = SKY2_EEPROM_MAGIC;\n\n\treturn sky2_vpd_read(sky2->hw, cap, data, eeprom->offset, eeprom->len);\n}\n\nstatic int sky2_set_eeprom(struct net_device *dev, struct ethtool_eeprom *eeprom,\n\t\t\t   u8 *data)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tint cap = pci_find_capability(sky2->hw->pdev, PCI_CAP_ID_VPD);\n\n\tif (!cap)\n\t\treturn -EINVAL;\n\n\tif (eeprom->magic != SKY2_EEPROM_MAGIC)\n\t\treturn -EINVAL;\n\n\t/* Partial writes not supported */\n\tif ((eeprom->offset & 3) || (eeprom->len & 3))\n\t\treturn -EINVAL;\n\n\treturn sky2_vpd_write(sky2->hw, cap, data, eeprom->offset, eeprom->len);\n}\n\nstatic netdev_features_t sky2_fix_features(struct net_device *dev,\n\tnetdev_features_t features)\n{\n\tconst struct sky2_port *sky2 = netdev_priv(dev);\n\tconst struct sky2_hw *hw = sky2->hw;\n\n\t/* In order to do Jumbo packets on these chips, need to turn off the\n\t * transmit store/forward. Therefore checksum offload won't work.\n\t */\n\tif (dev->mtu > ETH_DATA_LEN && hw->chip_id == CHIP_ID_YUKON_EC_U) {\n\t\tnetdev_info(dev, \"checksum offload not possible with jumbo frames\\n\");\n\t\tfeatures &= ~(NETIF_F_TSO | NETIF_F_SG | NETIF_F_CSUM_MASK);\n\t}\n\n\t/* Some hardware requires receive checksum for RSS to work. */\n\tif ( (features & NETIF_F_RXHASH) &&\n\t     !(features & NETIF_F_RXCSUM) &&\n\t     (sky2->hw->flags & SKY2_HW_RSS_CHKSUM)) {\n\t\tnetdev_info(dev, \"receive hashing forces receive checksum\\n\");\n\t\tfeatures |= NETIF_F_RXCSUM;\n\t}\n\n\treturn features;\n}\n\nstatic int sky2_set_features(struct net_device *dev, netdev_features_t features)\n{\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\tnetdev_features_t changed = dev->features ^ features;\n\n\tif ((changed & NETIF_F_RXCSUM) &&\n\t    !(sky2->hw->flags & SKY2_HW_NEW_LE)) {\n\t\tsky2_write32(sky2->hw,\n\t\t\t     Q_ADDR(rxqaddr[sky2->port], Q_CSR),\n\t\t\t     (features & NETIF_F_RXCSUM)\n\t\t\t     ? BMU_ENA_RX_CHKSUM : BMU_DIS_RX_CHKSUM);\n\t}\n\n\tif (changed & NETIF_F_RXHASH)\n\t\trx_set_rss(dev, features);\n\n\tif (changed & (NETIF_F_HW_VLAN_CTAG_TX|NETIF_F_HW_VLAN_CTAG_RX))\n\t\tsky2_vlan_mode(dev, features);\n\n\treturn 0;\n}\n\nstatic const struct ethtool_ops sky2_ethtool_ops = {\n\t.supported_coalesce_params = ETHTOOL_COALESCE_USECS |\n\t\t\t\t     ETHTOOL_COALESCE_MAX_FRAMES |\n\t\t\t\t     ETHTOOL_COALESCE_RX_USECS_IRQ |\n\t\t\t\t     ETHTOOL_COALESCE_RX_MAX_FRAMES_IRQ,\n\t.get_drvinfo\t= sky2_get_drvinfo,\n\t.get_wol\t= sky2_get_wol,\n\t.set_wol\t= sky2_set_wol,\n\t.get_msglevel\t= sky2_get_msglevel,\n\t.set_msglevel\t= sky2_set_msglevel,\n\t.nway_reset\t= sky2_nway_reset,\n\t.get_regs_len\t= sky2_get_regs_len,\n\t.get_regs\t= sky2_get_regs,\n\t.get_link\t= ethtool_op_get_link,\n\t.get_eeprom_len\t= sky2_get_eeprom_len,\n\t.get_eeprom\t= sky2_get_eeprom,\n\t.set_eeprom\t= sky2_set_eeprom,\n\t.get_strings\t= sky2_get_strings,\n\t.get_coalesce\t= sky2_get_coalesce,\n\t.set_coalesce\t= sky2_set_coalesce,\n\t.get_ringparam\t= sky2_get_ringparam,\n\t.set_ringparam\t= sky2_set_ringparam,\n\t.get_pauseparam = sky2_get_pauseparam,\n\t.set_pauseparam = sky2_set_pauseparam,\n\t.set_phys_id\t= sky2_set_phys_id,\n\t.get_sset_count = sky2_get_sset_count,\n\t.get_ethtool_stats = sky2_get_ethtool_stats,\n\t.get_link_ksettings = sky2_get_link_ksettings,\n\t.set_link_ksettings = sky2_set_link_ksettings,\n};\n\n#ifdef CONFIG_SKY2_DEBUG\n\nstatic struct dentry *sky2_debug;\n\n\n/*\n * Read and parse the first part of Vital Product Data\n */\n#define VPD_SIZE\t128\n#define VPD_MAGIC\t0x82\n\nstatic const struct vpd_tag {\n\tchar tag[2];\n\tchar *label;\n} vpd_tags[] = {\n\t{ \"PN\",\t\"Part Number\" },\n\t{ \"EC\", \"Engineering Level\" },\n\t{ \"MN\", \"Manufacturer\" },\n\t{ \"SN\", \"Serial Number\" },\n\t{ \"YA\", \"Asset Tag\" },\n\t{ \"VL\", \"First Error Log Message\" },\n\t{ \"VF\", \"Second Error Log Message\" },\n\t{ \"VB\", \"Boot Agent ROM Configuration\" },\n\t{ \"VE\", \"EFI UNDI Configuration\" },\n};\n\nstatic void sky2_show_vpd(struct seq_file *seq, struct sky2_hw *hw)\n{\n\tsize_t vpd_size;\n\tloff_t offs;\n\tu8 len;\n\tunsigned char *buf;\n\tu16 reg2;\n\n\treg2 = sky2_pci_read16(hw, PCI_DEV_REG2);\n\tvpd_size = 1 << ( ((reg2 & PCI_VPD_ROM_SZ) >> 14) + 8);\n\n\tseq_printf(seq, \"%s Product Data\\n\", pci_name(hw->pdev));\n\tbuf = kmalloc(vpd_size, GFP_KERNEL);\n\tif (!buf) {\n\t\tseq_puts(seq, \"no memory!\\n\");\n\t\treturn;\n\t}\n\n\tif (pci_read_vpd(hw->pdev, 0, vpd_size, buf) < 0) {\n\t\tseq_puts(seq, \"VPD read failed\\n\");\n\t\tgoto out;\n\t}\n\n\tif (buf[0] != VPD_MAGIC) {\n\t\tseq_printf(seq, \"VPD tag mismatch: %#x\\n\", buf[0]);\n\t\tgoto out;\n\t}\n\tlen = buf[1];\n\tif (len == 0 || len > vpd_size - 4) {\n\t\tseq_printf(seq, \"Invalid id length: %d\\n\", len);\n\t\tgoto out;\n\t}\n\n\tseq_printf(seq, \"%.*s\\n\", len, buf + 3);\n\toffs = len + 3;\n\n\twhile (offs < vpd_size - 4) {\n\t\tint i;\n\n\t\tif (!memcmp(\"RW\", buf + offs, 2))\t/* end marker */\n\t\t\tbreak;\n\t\tlen = buf[offs + 2];\n\t\tif (offs + len + 3 >= vpd_size)\n\t\t\tbreak;\n\n\t\tfor (i = 0; i < ARRAY_SIZE(vpd_tags); i++) {\n\t\t\tif (!memcmp(vpd_tags[i].tag, buf + offs, 2)) {\n\t\t\t\tseq_printf(seq, \" %s: %.*s\\n\",\n\t\t\t\t\t   vpd_tags[i].label, len, buf + offs + 3);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\toffs += len + 3;\n\t}\nout:\n\tkfree(buf);\n}\n\nstatic int sky2_debug_show(struct seq_file *seq, void *v)\n{\n\tstruct net_device *dev = seq->private;\n\tconst struct sky2_port *sky2 = netdev_priv(dev);\n\tstruct sky2_hw *hw = sky2->hw;\n\tunsigned port = sky2->port;\n\tunsigned idx, last;\n\tint sop;\n\n\tsky2_show_vpd(seq, hw);\n\n\tseq_printf(seq, \"\\nIRQ src=%x mask=%x control=%x\\n\",\n\t\t   sky2_read32(hw, B0_ISRC),\n\t\t   sky2_read32(hw, B0_IMSK),\n\t\t   sky2_read32(hw, B0_Y2_SP_ICR));\n\n\tif (!netif_running(dev)) {\n\t\tseq_puts(seq, \"network not running\\n\");\n\t\treturn 0;\n\t}\n\n\tnapi_disable(&hw->napi);\n\tlast = sky2_read16(hw, STAT_PUT_IDX);\n\n\tseq_printf(seq, \"Status ring %u\\n\", hw->st_size);\n\tif (hw->st_idx == last)\n\t\tseq_puts(seq, \"Status ring (empty)\\n\");\n\telse {\n\t\tseq_puts(seq, \"Status ring\\n\");\n\t\tfor (idx = hw->st_idx; idx != last && idx < hw->st_size;\n\t\t     idx = RING_NEXT(idx, hw->st_size)) {\n\t\t\tconst struct sky2_status_le *le = hw->st_le + idx;\n\t\t\tseq_printf(seq, \"[%d] %#x %d %#x\\n\",\n\t\t\t\t   idx, le->opcode, le->length, le->status);\n\t\t}\n\t\tseq_puts(seq, \"\\n\");\n\t}\n\n\tseq_printf(seq, \"Tx ring pending=%u...%u report=%d done=%d\\n\",\n\t\t   sky2->tx_cons, sky2->tx_prod,\n\t\t   sky2_read16(hw, port == 0 ? STAT_TXA1_RIDX : STAT_TXA2_RIDX),\n\t\t   sky2_read16(hw, Q_ADDR(txqaddr[port], Q_DONE)));\n\n\t/* Dump contents of tx ring */\n\tsop = 1;\n\tfor (idx = sky2->tx_next; idx != sky2->tx_prod && idx < sky2->tx_ring_size;\n\t     idx = RING_NEXT(idx, sky2->tx_ring_size)) {\n\t\tconst struct sky2_tx_le *le = sky2->tx_le + idx;\n\t\tu32 a = le32_to_cpu(le->addr);\n\n\t\tif (sop)\n\t\t\tseq_printf(seq, \"%u:\", idx);\n\t\tsop = 0;\n\n\t\tswitch (le->opcode & ~HW_OWNER) {\n\t\tcase OP_ADDR64:\n\t\t\tseq_printf(seq, \" %#x:\", a);\n\t\t\tbreak;\n\t\tcase OP_LRGLEN:\n\t\t\tseq_printf(seq, \" mtu=%d\", a);\n\t\t\tbreak;\n\t\tcase OP_VLAN:\n\t\t\tseq_printf(seq, \" vlan=%d\", be16_to_cpu(le->length));\n\t\t\tbreak;\n\t\tcase OP_TCPLISW:\n\t\t\tseq_printf(seq, \" csum=%#x\", a);\n\t\t\tbreak;\n\t\tcase OP_LARGESEND:\n\t\t\tseq_printf(seq, \" tso=%#x(%d)\", a, le16_to_cpu(le->length));\n\t\t\tbreak;\n\t\tcase OP_PACKET:\n\t\t\tseq_printf(seq, \" %#x(%d)\", a, le16_to_cpu(le->length));\n\t\t\tbreak;\n\t\tcase OP_BUFFER:\n\t\t\tseq_printf(seq, \" frag=%#x(%d)\", a, le16_to_cpu(le->length));\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tseq_printf(seq, \" op=%#x,%#x(%d)\", le->opcode,\n\t\t\t\t   a, le16_to_cpu(le->length));\n\t\t}\n\n\t\tif (le->ctrl & EOP) {\n\t\t\tseq_putc(seq, '\\n');\n\t\t\tsop = 1;\n\t\t}\n\t}\n\n\tseq_printf(seq, \"\\nRx ring hw get=%d put=%d last=%d\\n\",\n\t\t   sky2_read16(hw, Y2_QADDR(rxqaddr[port], PREF_UNIT_GET_IDX)),\n\t\t   sky2_read16(hw, Y2_QADDR(rxqaddr[port], PREF_UNIT_PUT_IDX)),\n\t\t   sky2_read16(hw, Y2_QADDR(rxqaddr[port], PREF_UNIT_LAST_IDX)));\n\n\tsky2_read32(hw, B0_Y2_SP_LISR);\n\tnapi_enable(&hw->napi);\n\treturn 0;\n}\nDEFINE_SHOW_ATTRIBUTE(sky2_debug);\n\n/*\n * Use network device events to create/remove/rename\n * debugfs file entries\n */\nstatic int sky2_device_event(struct notifier_block *unused,\n\t\t\t     unsigned long event, void *ptr)\n{\n\tstruct net_device *dev = netdev_notifier_info_to_dev(ptr);\n\tstruct sky2_port *sky2 = netdev_priv(dev);\n\n\tif (dev->netdev_ops->ndo_open != sky2_open || !sky2_debug)\n\t\treturn NOTIFY_DONE;\n\n\tswitch (event) {\n\tcase NETDEV_CHANGENAME:\n\t\tif (sky2->debugfs) {\n\t\t\tsky2->debugfs = debugfs_rename(sky2_debug, sky2->debugfs,\n\t\t\t\t\t\t       sky2_debug, dev->name);\n\t\t}\n\t\tbreak;\n\n\tcase NETDEV_GOING_DOWN:\n\t\tif (sky2->debugfs) {\n\t\t\tnetdev_printk(KERN_DEBUG, dev, \"remove debugfs\\n\");\n\t\t\tdebugfs_remove(sky2->debugfs);\n\t\t\tsky2->debugfs = NULL;\n\t\t}\n\t\tbreak;\n\n\tcase NETDEV_UP:\n\t\tsky2->debugfs = debugfs_create_file(dev->name, 0444,\n\t\t\t\t\t\t    sky2_debug, dev,\n\t\t\t\t\t\t    &sky2_debug_fops);\n\t\tif (IS_ERR(sky2->debugfs))\n\t\t\tsky2->debugfs = NULL;\n\t}\n\n\treturn NOTIFY_DONE;\n}\n\nstatic struct notifier_block sky2_notifier = {\n\t.notifier_call = sky2_device_event,\n};\n\n\nstatic __init void sky2_debug_init(void)\n{\n\tstruct dentry *ent;\n\n\tent = debugfs_create_dir(\"sky2\", NULL);\n\tif (!ent || IS_ERR(ent))\n\t\treturn;\n\n\tsky2_debug = ent;\n\tregister_netdevice_notifier(&sky2_notifier);\n}\n\nstatic __exit void sky2_debug_cleanup(void)\n{\n\tif (sky2_debug) {\n\t\tunregister_netdevice_notifier(&sky2_notifier);\n\t\tdebugfs_remove(sky2_debug);\n\t\tsky2_debug = NULL;\n\t}\n}\n\n#else\n#define sky2_debug_init()\n#define sky2_debug_cleanup()\n#endif\n\n/* Two copies of network device operations to handle special case of\n   not allowing netpoll on second port */\nstatic const struct net_device_ops sky2_netdev_ops[2] = {\n  {\n\t.ndo_open\t\t= sky2_open,\n\t.ndo_stop\t\t= sky2_close,\n\t.ndo_start_xmit\t\t= sky2_xmit_frame,\n\t.ndo_do_ioctl\t\t= sky2_ioctl,\n\t.ndo_validate_addr\t= eth_validate_addr,\n\t.ndo_set_mac_address\t= sky2_set_mac_address,\n\t.ndo_set_rx_mode\t= sky2_set_multicast,\n\t.ndo_change_mtu\t\t= sky2_change_mtu,\n\t.ndo_fix_features\t= sky2_fix_features,\n\t.ndo_set_features\t= sky2_set_features,\n\t.ndo_tx_timeout\t\t= sky2_tx_timeout,\n\t.ndo_get_stats64\t= sky2_get_stats,\n#ifdef CONFIG_NET_POLL_CONTROLLER\n\t.ndo_poll_controller\t= sky2_netpoll,\n#endif\n  },\n  {\n\t.ndo_open\t\t= sky2_open,\n\t.ndo_stop\t\t= sky2_close,\n\t.ndo_start_xmit\t\t= sky2_xmit_frame,\n\t.ndo_do_ioctl\t\t= sky2_ioctl,\n\t.ndo_validate_addr\t= eth_validate_addr,\n\t.ndo_set_mac_address\t= sky2_set_mac_address,\n\t.ndo_set_rx_mode\t= sky2_set_multicast,\n\t.ndo_change_mtu\t\t= sky2_change_mtu,\n\t.ndo_fix_features\t= sky2_fix_features,\n\t.ndo_set_features\t= sky2_set_features,\n\t.ndo_tx_timeout\t\t= sky2_tx_timeout,\n\t.ndo_get_stats64\t= sky2_get_stats,\n  },\n};\n\n/* Initialize network device */\nstatic struct net_device *sky2_init_netdev(struct sky2_hw *hw, unsigned port,\n\t\t\t\t\t   int highmem, int wol)\n{\n\tstruct sky2_port *sky2;\n\tstruct net_device *dev = alloc_etherdev(sizeof(*sky2));\n\tconst void *iap;\n\n\tif (!dev)\n\t\treturn NULL;\n\n\tSET_NETDEV_DEV(dev, &hw->pdev->dev);\n\tdev->irq = hw->pdev->irq;\n\tdev->ethtool_ops = &sky2_ethtool_ops;\n\tdev->watchdog_timeo = TX_WATCHDOG;\n\tdev->netdev_ops = &sky2_netdev_ops[port];\n\n\tsky2 = netdev_priv(dev);\n\tsky2->netdev = dev;\n\tsky2->hw = hw;\n\tsky2->msg_enable = netif_msg_init(debug, default_msg);\n\n\tu64_stats_init(&sky2->tx_stats.syncp);\n\tu64_stats_init(&sky2->rx_stats.syncp);\n\n\t/* Auto speed and flow control */\n\tsky2->flags = SKY2_FLAG_AUTO_SPEED | SKY2_FLAG_AUTO_PAUSE;\n\tif (hw->chip_id != CHIP_ID_YUKON_XL)\n\t\tdev->hw_features |= NETIF_F_RXCSUM;\n\n\tsky2->flow_mode = FC_BOTH;\n\n\tsky2->duplex = -1;\n\tsky2->speed = -1;\n\tsky2->advertising = sky2_supported_modes(hw);\n\tsky2->wol = wol;\n\n\tspin_lock_init(&sky2->phy_lock);\n\n\tsky2->tx_pending = TX_DEF_PENDING;\n\tsky2->tx_ring_size = roundup_ring_size(TX_DEF_PENDING);\n\tsky2->rx_pending = RX_DEF_PENDING;\n\n\thw->dev[port] = dev;\n\n\tsky2->port = port;\n\n\tdev->hw_features |= NETIF_F_IP_CSUM | NETIF_F_SG | NETIF_F_TSO;\n\n\tif (highmem)\n\t\tdev->features |= NETIF_F_HIGHDMA;\n\n\t/* Enable receive hashing unless hardware is known broken */\n\tif (!(hw->flags & SKY2_HW_RSS_BROKEN))\n\t\tdev->hw_features |= NETIF_F_RXHASH;\n\n\tif (!(hw->flags & SKY2_HW_VLAN_BROKEN)) {\n\t\tdev->hw_features |= NETIF_F_HW_VLAN_CTAG_TX |\n\t\t\t\t    NETIF_F_HW_VLAN_CTAG_RX;\n\t\tdev->vlan_features |= SKY2_VLAN_OFFLOADS;\n\t}\n\n\tdev->features |= dev->hw_features;\n\n\t/* MTU range: 60 - 1500 or 9000 */\n\tdev->min_mtu = ETH_ZLEN;\n\tif (hw->chip_id == CHIP_ID_YUKON_FE ||\n\t    hw->chip_id == CHIP_ID_YUKON_FE_P)\n\t\tdev->max_mtu = ETH_DATA_LEN;\n\telse\n\t\tdev->max_mtu = ETH_JUMBO_MTU;\n\n\t/* try to get mac address in the following order:\n\t * 1) from device tree data\n\t * 2) from internal registers set by bootloader\n\t */\n\tiap = of_get_mac_address(hw->pdev->dev.of_node);\n\tif (!IS_ERR(iap))\n\t\tether_addr_copy(dev->dev_addr, iap);\n\telse\n\t\tmemcpy_fromio(dev->dev_addr, hw->regs + B2_MAC_1 + port * 8,\n\t\t\t      ETH_ALEN);\n\n\t/* if the address is invalid, use a random value */\n\tif (!is_valid_ether_addr(dev->dev_addr)) {\n\t\tstruct sockaddr sa = { AF_UNSPEC };\n\n\t\tnetdev_warn(dev,\n\t\t\t    \"Invalid MAC address, defaulting to random\\n\");\n\t\teth_hw_addr_random(dev);\n\t\tmemcpy(sa.sa_data, dev->dev_addr, ETH_ALEN);\n\t\tif (sky2_set_mac_address(dev, &sa))\n\t\t\tnetdev_warn(dev, \"Failed to set MAC address.\\n\");\n\t}\n\n\treturn dev;\n}\n\nstatic void sky2_show_addr(struct net_device *dev)\n{\n\tconst struct sky2_port *sky2 = netdev_priv(dev);\n\n\tnetif_info(sky2, probe, dev, \"addr %pM\\n\", dev->dev_addr);\n}\n\n/* Handle software interrupt used during MSI test */\nstatic irqreturn_t sky2_test_intr(int irq, void *dev_id)\n{\n\tstruct sky2_hw *hw = dev_id;\n\tu32 status = sky2_read32(hw, B0_Y2_SP_ISRC2);\n\n\tif (status == 0)\n\t\treturn IRQ_NONE;\n\n\tif (status & Y2_IS_IRQ_SW) {\n\t\thw->flags |= SKY2_HW_USE_MSI;\n\t\twake_up(&hw->msi_wait);\n\t\tsky2_write8(hw, B0_CTST, CS_CL_SW_IRQ);\n\t}\n\tsky2_write32(hw, B0_Y2_SP_ICR, 2);\n\n\treturn IRQ_HANDLED;\n}\n\n/* Test interrupt path by forcing a a software IRQ */\nstatic int sky2_test_msi(struct sky2_hw *hw)\n{\n\tstruct pci_dev *pdev = hw->pdev;\n\tint err;\n\n\tinit_waitqueue_head(&hw->msi_wait);\n\n\terr = request_irq(pdev->irq, sky2_test_intr, 0, DRV_NAME, hw);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"cannot assign irq %d\\n\", pdev->irq);\n\t\treturn err;\n\t}\n\n\tsky2_write32(hw, B0_IMSK, Y2_IS_IRQ_SW);\n\n\tsky2_write8(hw, B0_CTST, CS_ST_SW_IRQ);\n\tsky2_read8(hw, B0_CTST);\n\n\twait_event_timeout(hw->msi_wait, (hw->flags & SKY2_HW_USE_MSI), HZ/10);\n\n\tif (!(hw->flags & SKY2_HW_USE_MSI)) {\n\t\t/* MSI test failed, go back to INTx mode */\n\t\tdev_info(&pdev->dev, \"No interrupt generated using MSI, \"\n\t\t\t \"switching to INTx mode.\\n\");\n\n\t\terr = -EOPNOTSUPP;\n\t\tsky2_write8(hw, B0_CTST, CS_CL_SW_IRQ);\n\t}\n\n\tsky2_write32(hw, B0_IMSK, 0);\n\tsky2_read32(hw, B0_IMSK);\n\n\tfree_irq(pdev->irq, hw);\n\n\treturn err;\n}\n\n/* This driver supports yukon2 chipset only */\nstatic const char *sky2_name(u8 chipid, char *buf, int sz)\n{\n\tconst char *name[] = {\n\t\t\"XL\",\t\t/* 0xb3 */\n\t\t\"EC Ultra\", \t/* 0xb4 */\n\t\t\"Extreme\",\t/* 0xb5 */\n\t\t\"EC\",\t\t/* 0xb6 */\n\t\t\"FE\",\t\t/* 0xb7 */\n\t\t\"FE+\",\t\t/* 0xb8 */\n\t\t\"Supreme\",\t/* 0xb9 */\n\t\t\"UL 2\",\t\t/* 0xba */\n\t\t\"Unknown\",\t/* 0xbb */\n\t\t\"Optima\",\t/* 0xbc */\n\t\t\"OptimaEEE\",    /* 0xbd */\n\t\t\"Optima 2\",\t/* 0xbe */\n\t};\n\n\tif (chipid >= CHIP_ID_YUKON_XL && chipid <= CHIP_ID_YUKON_OP_2)\n\t\tsnprintf(buf, sz, \"%s\", name[chipid - CHIP_ID_YUKON_XL]);\n\telse\n\t\tsnprintf(buf, sz, \"(chip %#x)\", chipid);\n\treturn buf;\n}\n\nstatic const struct dmi_system_id msi_blacklist[] = {\n\t{\n\t\t.ident = \"Dell Inspiron 1545\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"Inspiron 1545\"),\n\t\t},\n\t},\n\t{\n\t\t.ident = \"Gateway P-79\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Gateway\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"P-79\"),\n\t\t},\n\t},\n\t{\n\t\t.ident = \"ASUS P5W DH Deluxe\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"ASUSTEK COMPUTER INC\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"P5W DH Deluxe\"),\n\t\t},\n\t},\n\t{\n\t\t.ident = \"ASUS P6T\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_BOARD_VENDOR, \"ASUSTeK Computer INC.\"),\n\t\t\tDMI_MATCH(DMI_BOARD_NAME, \"P6T\"),\n\t\t},\n\t},\n\t{\n\t\t.ident = \"ASUS P6X\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_BOARD_VENDOR, \"ASUSTeK Computer INC.\"),\n\t\t\tDMI_MATCH(DMI_BOARD_NAME, \"P6X\"),\n\t\t},\n\t},\n\t{}\n};\n\nstatic int sky2_probe(struct pci_dev *pdev, const struct pci_device_id *ent)\n{\n\tstruct net_device *dev, *dev1;\n\tstruct sky2_hw *hw;\n\tint err, using_dac = 0, wol_default;\n\tu32 reg;\n\tchar buf1[16];\n\n\terr = pci_enable_device(pdev);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"cannot enable PCI device\\n\");\n\t\tgoto err_out;\n\t}\n\n\t/* Get configuration information\n\t * Note: only regular PCI config access once to test for HW issues\n\t *       other PCI access through shared memory for speed and to\n\t *\t avoid MMCONFIG problems.\n\t */\n\terr = pci_read_config_dword(pdev, PCI_DEV_REG2, &reg);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"PCI read config failed\\n\");\n\t\tgoto err_out_disable;\n\t}\n\n\tif (~reg == 0) {\n\t\tdev_err(&pdev->dev, \"PCI configuration read error\\n\");\n\t\terr = -EIO;\n\t\tgoto err_out_disable;\n\t}\n\n\terr = pci_request_regions(pdev, DRV_NAME);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"cannot obtain PCI resources\\n\");\n\t\tgoto err_out_disable;\n\t}\n\n\tpci_set_master(pdev);\n\n\tif (sizeof(dma_addr_t) > sizeof(u32) &&\n\t    !(err = dma_set_mask(&pdev->dev, DMA_BIT_MASK(64)))) {\n\t\tusing_dac = 1;\n\t\terr = dma_set_coherent_mask(&pdev->dev, DMA_BIT_MASK(64));\n\t\tif (err < 0) {\n\t\t\tdev_err(&pdev->dev, \"unable to obtain 64 bit DMA \"\n\t\t\t\t\"for consistent allocations\\n\");\n\t\t\tgoto err_out_free_regions;\n\t\t}\n\t} else {\n\t\terr = dma_set_mask(&pdev->dev, DMA_BIT_MASK(32));\n\t\tif (err) {\n\t\t\tdev_err(&pdev->dev, \"no usable DMA configuration\\n\");\n\t\t\tgoto err_out_free_regions;\n\t\t}\n\t}\n\n\n#ifdef __BIG_ENDIAN\n\t/* The sk98lin vendor driver uses hardware byte swapping but\n\t * this driver uses software swapping.\n\t */\n\treg &= ~PCI_REV_DESC;\n\terr = pci_write_config_dword(pdev, PCI_DEV_REG2, reg);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"PCI write config failed\\n\");\n\t\tgoto err_out_free_regions;\n\t}\n#endif\n\n\twol_default = device_may_wakeup(&pdev->dev) ? WAKE_MAGIC : 0;\n\n\terr = -ENOMEM;\n\n\thw = kzalloc(sizeof(*hw) + strlen(DRV_NAME \"@pci:\")\n\t\t     + strlen(pci_name(pdev)) + 1, GFP_KERNEL);\n\tif (!hw)\n\t\tgoto err_out_free_regions;\n\n\thw->pdev = pdev;\n\tsprintf(hw->irq_name, DRV_NAME \"@pci:%s\", pci_name(pdev));\n\n\thw->regs = ioremap(pci_resource_start(pdev, 0), 0x4000);\n\tif (!hw->regs) {\n\t\tdev_err(&pdev->dev, \"cannot map device registers\\n\");\n\t\tgoto err_out_free_hw;\n\t}\n\n\terr = sky2_init(hw);\n\tif (err)\n\t\tgoto err_out_iounmap;\n\n\t/* ring for status responses */\n\thw->st_size = hw->ports * roundup_pow_of_two(3*RX_MAX_PENDING + TX_MAX_PENDING);\n\thw->st_le = dma_alloc_coherent(&pdev->dev,\n\t\t\t\t       hw->st_size * sizeof(struct sky2_status_le),\n\t\t\t\t       &hw->st_dma, GFP_KERNEL);\n\tif (!hw->st_le) {\n\t\terr = -ENOMEM;\n\t\tgoto err_out_reset;\n\t}\n\n\tdev_info(&pdev->dev, \"Yukon-2 %s chip revision %d\\n\",\n\t\t sky2_name(hw->chip_id, buf1, sizeof(buf1)), hw->chip_rev);\n\n\tsky2_reset(hw);\n\n\tdev = sky2_init_netdev(hw, 0, using_dac, wol_default);\n\tif (!dev) {\n\t\terr = -ENOMEM;\n\t\tgoto err_out_free_pci;\n\t}\n\n\tif (disable_msi == -1)\n\t\tdisable_msi = !!dmi_check_system(msi_blacklist);\n\n\tif (!disable_msi && pci_enable_msi(pdev) == 0) {\n\t\terr = sky2_test_msi(hw);\n\t\tif (err) {\n \t\t\tpci_disable_msi(pdev);\n\t\t\tif (err != -EOPNOTSUPP)\n\t\t\t\tgoto err_out_free_netdev;\n\t\t}\n \t}\n\n\tnetif_napi_add(dev, &hw->napi, sky2_poll, NAPI_WEIGHT);\n\n\terr = register_netdev(dev);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"cannot register net device\\n\");\n\t\tgoto err_out_free_netdev;\n\t}\n\n\tnetif_carrier_off(dev);\n\n\tsky2_show_addr(dev);\n\n\tif (hw->ports > 1) {\n\t\tdev1 = sky2_init_netdev(hw, 1, using_dac, wol_default);\n\t\tif (!dev1) {\n\t\t\terr = -ENOMEM;\n\t\t\tgoto err_out_unregister;\n\t\t}\n\n\t\terr = register_netdev(dev1);\n\t\tif (err) {\n\t\t\tdev_err(&pdev->dev, \"cannot register second net device\\n\");\n\t\t\tgoto err_out_free_dev1;\n\t\t}\n\n\t\terr = sky2_setup_irq(hw, hw->irq_name);\n\t\tif (err)\n\t\t\tgoto err_out_unregister_dev1;\n\n\t\tsky2_show_addr(dev1);\n\t}\n\n\ttimer_setup(&hw->watchdog_timer, sky2_watchdog, 0);\n\tINIT_WORK(&hw->restart_work, sky2_restart);\n\n\tpci_set_drvdata(pdev, hw);\n\tpdev->d3hot_delay = 300;\n\n\treturn 0;\n\nerr_out_unregister_dev1:\n\tunregister_netdev(dev1);\nerr_out_free_dev1:\n\tfree_netdev(dev1);\nerr_out_unregister:\n\tunregister_netdev(dev);\nerr_out_free_netdev:\n\tif (hw->flags & SKY2_HW_USE_MSI)\n\t\tpci_disable_msi(pdev);\n\tfree_netdev(dev);\nerr_out_free_pci:\n\tdma_free_coherent(&pdev->dev,\n\t\t\t  hw->st_size * sizeof(struct sky2_status_le),\n\t\t\t  hw->st_le, hw->st_dma);\nerr_out_reset:\n\tsky2_write8(hw, B0_CTST, CS_RST_SET);\nerr_out_iounmap:\n\tiounmap(hw->regs);\nerr_out_free_hw:\n\tkfree(hw);\nerr_out_free_regions:\n\tpci_release_regions(pdev);\nerr_out_disable:\n\tpci_disable_device(pdev);\nerr_out:\n\treturn err;\n}\n\nstatic void sky2_remove(struct pci_dev *pdev)\n{\n\tstruct sky2_hw *hw = pci_get_drvdata(pdev);\n\tint i;\n\n\tif (!hw)\n\t\treturn;\n\n\tdel_timer_sync(&hw->watchdog_timer);\n\tcancel_work_sync(&hw->restart_work);\n\n\tfor (i = hw->ports-1; i >= 0; --i)\n\t\tunregister_netdev(hw->dev[i]);\n\n\tsky2_write32(hw, B0_IMSK, 0);\n\tsky2_read32(hw, B0_IMSK);\n\n\tsky2_power_aux(hw);\n\n\tsky2_write8(hw, B0_CTST, CS_RST_SET);\n\tsky2_read8(hw, B0_CTST);\n\n\tif (hw->ports > 1) {\n\t\tnapi_disable(&hw->napi);\n\t\tfree_irq(pdev->irq, hw);\n\t}\n\n\tif (hw->flags & SKY2_HW_USE_MSI)\n\t\tpci_disable_msi(pdev);\n\tdma_free_coherent(&pdev->dev,\n\t\t\t  hw->st_size * sizeof(struct sky2_status_le),\n\t\t\t  hw->st_le, hw->st_dma);\n\tpci_release_regions(pdev);\n\tpci_disable_device(pdev);\n\n\tfor (i = hw->ports-1; i >= 0; --i)\n\t\tfree_netdev(hw->dev[i]);\n\n\tiounmap(hw->regs);\n\tkfree(hw);\n}\n\nstatic int sky2_suspend(struct device *dev)\n{\n\tstruct sky2_hw *hw = dev_get_drvdata(dev);\n\tint i;\n\n\tif (!hw)\n\t\treturn 0;\n\n\tdel_timer_sync(&hw->watchdog_timer);\n\tcancel_work_sync(&hw->restart_work);\n\n\trtnl_lock();\n\n\tsky2_all_down(hw);\n\tfor (i = 0; i < hw->ports; i++) {\n\t\tstruct net_device *dev = hw->dev[i];\n\t\tstruct sky2_port *sky2 = netdev_priv(dev);\n\n\t\tif (sky2->wol)\n\t\t\tsky2_wol_init(sky2);\n\t}\n\n\tsky2_power_aux(hw);\n\trtnl_unlock();\n\n\treturn 0;\n}\n\n#ifdef CONFIG_PM_SLEEP\nstatic int sky2_resume(struct device *dev)\n{\n\tstruct pci_dev *pdev = to_pci_dev(dev);\n\tstruct sky2_hw *hw = pci_get_drvdata(pdev);\n\tint err;\n\n\tif (!hw)\n\t\treturn 0;\n\n\t/* Re-enable all clocks */\n\terr = pci_write_config_dword(pdev, PCI_DEV_REG3, 0);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"PCI write config failed\\n\");\n\t\tgoto out;\n\t}\n\n\trtnl_lock();\n\tsky2_reset(hw);\n\tsky2_all_up(hw);\n\trtnl_unlock();\n\n\treturn 0;\nout:\n\n\tdev_err(&pdev->dev, \"resume failed (%d)\\n\", err);\n\tpci_disable_device(pdev);\n\treturn err;\n}\n\nstatic SIMPLE_DEV_PM_OPS(sky2_pm_ops, sky2_suspend, sky2_resume);\n#define SKY2_PM_OPS (&sky2_pm_ops)\n\n#else\n\n#define SKY2_PM_OPS NULL\n#endif\n\nstatic void sky2_shutdown(struct pci_dev *pdev)\n{\n\tstruct sky2_hw *hw = pci_get_drvdata(pdev);\n\tint port;\n\n\tfor (port = 0; port < hw->ports; port++) {\n\t\tstruct net_device *ndev = hw->dev[port];\n\n\t\trtnl_lock();\n\t\tif (netif_running(ndev)) {\n\t\t\tdev_close(ndev);\n\t\t\tnetif_device_detach(ndev);\n\t\t}\n\t\trtnl_unlock();\n\t}\n\tsky2_suspend(&pdev->dev);\n\tpci_wake_from_d3(pdev, device_may_wakeup(&pdev->dev));\n\tpci_set_power_state(pdev, PCI_D3hot);\n}\n\nstatic struct pci_driver sky2_driver = {\n\t.name = DRV_NAME,\n\t.id_table = sky2_id_table,\n\t.probe = sky2_probe,\n\t.remove = sky2_remove,\n\t.shutdown = sky2_shutdown,\n\t.driver.pm = SKY2_PM_OPS,\n};\n\nstatic int __init sky2_init_module(void)\n{\n\tpr_info(\"driver version \" DRV_VERSION \"\\n\");\n\n\tsky2_debug_init();\n\treturn pci_register_driver(&sky2_driver);\n}\n\nstatic void __exit sky2_cleanup_module(void)\n{\n\tpci_unregister_driver(&sky2_driver);\n\tsky2_debug_cleanup();\n}\n\nmodule_init(sky2_init_module);\nmodule_exit(sky2_cleanup_module);\n\nMODULE_DESCRIPTION(\"Marvell Yukon 2 Gigabit Ethernet driver\");\nMODULE_AUTHOR(\"Stephen Hemminger <shemminger@linux-foundation.org>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_VERSION(DRV_VERSION);\n"}, "1": {"id": 1, "path": "/src/include/linux/kernel.h", "content": "/* SPDX-License-Identifier: GPL-2.0 */\n#ifndef _LINUX_KERNEL_H\n#define _LINUX_KERNEL_H\n\n#include <stdarg.h>\n#include <linux/limits.h>\n#include <linux/linkage.h>\n#include <linux/stddef.h>\n#include <linux/types.h>\n#include <linux/compiler.h>\n#include <linux/bitops.h>\n#include <linux/log2.h>\n#include <linux/math.h>\n#include <linux/minmax.h>\n#include <linux/typecheck.h>\n#include <linux/printk.h>\n#include <linux/build_bug.h>\n#include <linux/static_call_types.h>\n#include <asm/byteorder.h>\n\n#include <uapi/linux/kernel.h>\n\n#define STACK_MAGIC\t0xdeadbeef\n\n/**\n * REPEAT_BYTE - repeat the value @x multiple times as an unsigned long value\n * @x: value to repeat\n *\n * NOTE: @x is not checked for > 0xff; larger values produce odd results.\n */\n#define REPEAT_BYTE(x)\t((~0ul / 0xff) * (x))\n\n/* @a is a power of 2 value */\n#define ALIGN(x, a)\t\t__ALIGN_KERNEL((x), (a))\n#define ALIGN_DOWN(x, a)\t__ALIGN_KERNEL((x) - ((a) - 1), (a))\n#define __ALIGN_MASK(x, mask)\t__ALIGN_KERNEL_MASK((x), (mask))\n#define PTR_ALIGN(p, a)\t\t((typeof(p))ALIGN((unsigned long)(p), (a)))\n#define PTR_ALIGN_DOWN(p, a)\t((typeof(p))ALIGN_DOWN((unsigned long)(p), (a)))\n#define IS_ALIGNED(x, a)\t\t(((x) & ((typeof(x))(a) - 1)) == 0)\n\n/* generic data direction definitions */\n#define READ\t\t\t0\n#define WRITE\t\t\t1\n\n/**\n * ARRAY_SIZE - get the number of elements in array @arr\n * @arr: array to be sized\n */\n#define ARRAY_SIZE(arr) (sizeof(arr) / sizeof((arr)[0]) + __must_be_array(arr))\n\n#define u64_to_user_ptr(x) (\t\t\\\n{\t\t\t\t\t\\\n\ttypecheck(u64, (x));\t\t\\\n\t(void __user *)(uintptr_t)(x);\t\\\n}\t\t\t\t\t\\\n)\n\n#define typeof_member(T, m)\ttypeof(((T*)0)->m)\n\n#define _RET_IP_\t\t(unsigned long)__builtin_return_address(0)\n#define _THIS_IP_  ({ __label__ __here; __here: (unsigned long)&&__here; })\n\n/**\n * upper_32_bits - return bits 32-63 of a number\n * @n: the number we're accessing\n *\n * A basic shift-right of a 64- or 32-bit quantity.  Use this to suppress\n * the \"right shift count >= width of type\" warning when that quantity is\n * 32-bits.\n */\n#define upper_32_bits(n) ((u32)(((n) >> 16) >> 16))\n\n/**\n * lower_32_bits - return bits 0-31 of a number\n * @n: the number we're accessing\n */\n#define lower_32_bits(n) ((u32)((n) & 0xffffffff))\n\nstruct completion;\nstruct pt_regs;\nstruct user;\n\n#ifdef CONFIG_PREEMPT_VOLUNTARY\n\nextern int __cond_resched(void);\n# define might_resched() __cond_resched()\n\n#elif defined(CONFIG_PREEMPT_DYNAMIC)\n\nextern int __cond_resched(void);\n\nDECLARE_STATIC_CALL(might_resched, __cond_resched);\n\nstatic __always_inline void might_resched(void)\n{\n\tstatic_call_mod(might_resched)();\n}\n\n#else\n\n# define might_resched() do { } while (0)\n\n#endif /* CONFIG_PREEMPT_* */\n\n#ifdef CONFIG_DEBUG_ATOMIC_SLEEP\nextern void ___might_sleep(const char *file, int line, int preempt_offset);\nextern void __might_sleep(const char *file, int line, int preempt_offset);\nextern void __cant_sleep(const char *file, int line, int preempt_offset);\nextern void __cant_migrate(const char *file, int line);\n\n/**\n * might_sleep - annotation for functions that can sleep\n *\n * this macro will print a stack trace if it is executed in an atomic\n * context (spinlock, irq-handler, ...). Additional sections where blocking is\n * not allowed can be annotated with non_block_start() and non_block_end()\n * pairs.\n *\n * This is a useful debugging help to be able to catch problems early and not\n * be bitten later when the calling function happens to sleep when it is not\n * supposed to.\n */\n# define might_sleep() \\\n\tdo { __might_sleep(__FILE__, __LINE__, 0); might_resched(); } while (0)\n/**\n * cant_sleep - annotation for functions that cannot sleep\n *\n * this macro will print a stack trace if it is executed with preemption enabled\n */\n# define cant_sleep() \\\n\tdo { __cant_sleep(__FILE__, __LINE__, 0); } while (0)\n# define sched_annotate_sleep()\t(current->task_state_change = 0)\n\n/**\n * cant_migrate - annotation for functions that cannot migrate\n *\n * Will print a stack trace if executed in code which is migratable\n */\n# define cant_migrate()\t\t\t\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\t\\\n\t\tif (IS_ENABLED(CONFIG_SMP))\t\t\t\t\\\n\t\t\t__cant_migrate(__FILE__, __LINE__);\t\t\\\n\t} while (0)\n\n/**\n * non_block_start - annotate the start of section where sleeping is prohibited\n *\n * This is on behalf of the oom reaper, specifically when it is calling the mmu\n * notifiers. The problem is that if the notifier were to block on, for example,\n * mutex_lock() and if the process which holds that mutex were to perform a\n * sleeping memory allocation, the oom reaper is now blocked on completion of\n * that memory allocation. Other blocking calls like wait_event() pose similar\n * issues.\n */\n# define non_block_start() (current->non_block_count++)\n/**\n * non_block_end - annotate the end of section where sleeping is prohibited\n *\n * Closes a section opened by non_block_start().\n */\n# define non_block_end() WARN_ON(current->non_block_count-- == 0)\n#else\n  static inline void ___might_sleep(const char *file, int line,\n\t\t\t\t   int preempt_offset) { }\n  static inline void __might_sleep(const char *file, int line,\n\t\t\t\t   int preempt_offset) { }\n# define might_sleep() do { might_resched(); } while (0)\n# define cant_sleep() do { } while (0)\n# define cant_migrate()\t\tdo { } while (0)\n# define sched_annotate_sleep() do { } while (0)\n# define non_block_start() do { } while (0)\n# define non_block_end() do { } while (0)\n#endif\n\n#define might_sleep_if(cond) do { if (cond) might_sleep(); } while (0)\n\n#if defined(CONFIG_MMU) && \\\n\t(defined(CONFIG_PROVE_LOCKING) || defined(CONFIG_DEBUG_ATOMIC_SLEEP))\n#define might_fault() __might_fault(__FILE__, __LINE__)\nvoid __might_fault(const char *file, int line);\n#else\nstatic inline void might_fault(void) { }\n#endif\n\nextern struct atomic_notifier_head panic_notifier_list;\nextern long (*panic_blink)(int state);\n__printf(1, 2)\nvoid panic(const char *fmt, ...) __noreturn __cold;\nvoid nmi_panic(struct pt_regs *regs, const char *msg);\nextern void oops_enter(void);\nextern void oops_exit(void);\nextern bool oops_may_print(void);\nvoid do_exit(long error_code) __noreturn;\nvoid complete_and_exit(struct completion *, long) __noreturn;\n\n/* Internal, do not use. */\nint __must_check _kstrtoul(const char *s, unsigned int base, unsigned long *res);\nint __must_check _kstrtol(const char *s, unsigned int base, long *res);\n\nint __must_check kstrtoull(const char *s, unsigned int base, unsigned long long *res);\nint __must_check kstrtoll(const char *s, unsigned int base, long long *res);\n\n/**\n * kstrtoul - convert a string to an unsigned long\n * @s: The start of the string. The string must be null-terminated, and may also\n *  include a single newline before its terminating null. The first character\n *  may also be a plus sign, but not a minus sign.\n * @base: The number base to use. The maximum supported base is 16. If base is\n *  given as 0, then the base of the string is automatically detected with the\n *  conventional semantics - If it begins with 0x the number will be parsed as a\n *  hexadecimal (case insensitive), if it otherwise begins with 0, it will be\n *  parsed as an octal number. Otherwise it will be parsed as a decimal.\n * @res: Where to write the result of the conversion on success.\n *\n * Returns 0 on success, -ERANGE on overflow and -EINVAL on parsing error.\n * Preferred over simple_strtoul(). Return code must be checked.\n*/\nstatic inline int __must_check kstrtoul(const char *s, unsigned int base, unsigned long *res)\n{\n\t/*\n\t * We want to shortcut function call, but\n\t * __builtin_types_compatible_p(unsigned long, unsigned long long) = 0.\n\t */\n\tif (sizeof(unsigned long) == sizeof(unsigned long long) &&\n\t    __alignof__(unsigned long) == __alignof__(unsigned long long))\n\t\treturn kstrtoull(s, base, (unsigned long long *)res);\n\telse\n\t\treturn _kstrtoul(s, base, res);\n}\n\n/**\n * kstrtol - convert a string to a long\n * @s: The start of the string. The string must be null-terminated, and may also\n *  include a single newline before its terminating null. The first character\n *  may also be a plus sign or a minus sign.\n * @base: The number base to use. The maximum supported base is 16. If base is\n *  given as 0, then the base of the string is automatically detected with the\n *  conventional semantics - If it begins with 0x the number will be parsed as a\n *  hexadecimal (case insensitive), if it otherwise begins with 0, it will be\n *  parsed as an octal number. Otherwise it will be parsed as a decimal.\n * @res: Where to write the result of the conversion on success.\n *\n * Returns 0 on success, -ERANGE on overflow and -EINVAL on parsing error.\n * Preferred over simple_strtol(). Return code must be checked.\n */\nstatic inline int __must_check kstrtol(const char *s, unsigned int base, long *res)\n{\n\t/*\n\t * We want to shortcut function call, but\n\t * __builtin_types_compatible_p(long, long long) = 0.\n\t */\n\tif (sizeof(long) == sizeof(long long) &&\n\t    __alignof__(long) == __alignof__(long long))\n\t\treturn kstrtoll(s, base, (long long *)res);\n\telse\n\t\treturn _kstrtol(s, base, res);\n}\n\nint __must_check kstrtouint(const char *s, unsigned int base, unsigned int *res);\nint __must_check kstrtoint(const char *s, unsigned int base, int *res);\n\nstatic inline int __must_check kstrtou64(const char *s, unsigned int base, u64 *res)\n{\n\treturn kstrtoull(s, base, res);\n}\n\nstatic inline int __must_check kstrtos64(const char *s, unsigned int base, s64 *res)\n{\n\treturn kstrtoll(s, base, res);\n}\n\nstatic inline int __must_check kstrtou32(const char *s, unsigned int base, u32 *res)\n{\n\treturn kstrtouint(s, base, res);\n}\n\nstatic inline int __must_check kstrtos32(const char *s, unsigned int base, s32 *res)\n{\n\treturn kstrtoint(s, base, res);\n}\n\nint __must_check kstrtou16(const char *s, unsigned int base, u16 *res);\nint __must_check kstrtos16(const char *s, unsigned int base, s16 *res);\nint __must_check kstrtou8(const char *s, unsigned int base, u8 *res);\nint __must_check kstrtos8(const char *s, unsigned int base, s8 *res);\nint __must_check kstrtobool(const char *s, bool *res);\n\nint __must_check kstrtoull_from_user(const char __user *s, size_t count, unsigned int base, unsigned long long *res);\nint __must_check kstrtoll_from_user(const char __user *s, size_t count, unsigned int base, long long *res);\nint __must_check kstrtoul_from_user(const char __user *s, size_t count, unsigned int base, unsigned long *res);\nint __must_check kstrtol_from_user(const char __user *s, size_t count, unsigned int base, long *res);\nint __must_check kstrtouint_from_user(const char __user *s, size_t count, unsigned int base, unsigned int *res);\nint __must_check kstrtoint_from_user(const char __user *s, size_t count, unsigned int base, int *res);\nint __must_check kstrtou16_from_user(const char __user *s, size_t count, unsigned int base, u16 *res);\nint __must_check kstrtos16_from_user(const char __user *s, size_t count, unsigned int base, s16 *res);\nint __must_check kstrtou8_from_user(const char __user *s, size_t count, unsigned int base, u8 *res);\nint __must_check kstrtos8_from_user(const char __user *s, size_t count, unsigned int base, s8 *res);\nint __must_check kstrtobool_from_user(const char __user *s, size_t count, bool *res);\n\nstatic inline int __must_check kstrtou64_from_user(const char __user *s, size_t count, unsigned int base, u64 *res)\n{\n\treturn kstrtoull_from_user(s, count, base, res);\n}\n\nstatic inline int __must_check kstrtos64_from_user(const char __user *s, size_t count, unsigned int base, s64 *res)\n{\n\treturn kstrtoll_from_user(s, count, base, res);\n}\n\nstatic inline int __must_check kstrtou32_from_user(const char __user *s, size_t count, unsigned int base, u32 *res)\n{\n\treturn kstrtouint_from_user(s, count, base, res);\n}\n\nstatic inline int __must_check kstrtos32_from_user(const char __user *s, size_t count, unsigned int base, s32 *res)\n{\n\treturn kstrtoint_from_user(s, count, base, res);\n}\n\n/*\n * Use kstrto<foo> instead.\n *\n * NOTE: simple_strto<foo> does not check for the range overflow and,\n *\t depending on the input, may give interesting results.\n *\n * Use these functions if and only if you cannot use kstrto<foo>, because\n * the conversion ends on the first non-digit character, which may be far\n * beyond the supported range. It might be useful to parse the strings like\n * 10x50 or 12:21 without altering original string or temporary buffer in use.\n * Keep in mind above caveat.\n */\n\nextern unsigned long simple_strtoul(const char *,char **,unsigned int);\nextern long simple_strtol(const char *,char **,unsigned int);\nextern unsigned long long simple_strtoull(const char *,char **,unsigned int);\nextern long long simple_strtoll(const char *,char **,unsigned int);\n\nextern int num_to_str(char *buf, int size,\n\t\t      unsigned long long num, unsigned int width);\n\n/* lib/printf utilities */\n\nextern __printf(2, 3) int sprintf(char *buf, const char * fmt, ...);\nextern __printf(2, 0) int vsprintf(char *buf, const char *, va_list);\nextern __printf(3, 4)\nint snprintf(char *buf, size_t size, const char *fmt, ...);\nextern __printf(3, 0)\nint vsnprintf(char *buf, size_t size, const char *fmt, va_list args);\nextern __printf(3, 4)\nint scnprintf(char *buf, size_t size, const char *fmt, ...);\nextern __printf(3, 0)\nint vscnprintf(char *buf, size_t size, const char *fmt, va_list args);\nextern __printf(2, 3) __malloc\nchar *kasprintf(gfp_t gfp, const char *fmt, ...);\nextern __printf(2, 0) __malloc\nchar *kvasprintf(gfp_t gfp, const char *fmt, va_list args);\nextern __printf(2, 0)\nconst char *kvasprintf_const(gfp_t gfp, const char *fmt, va_list args);\n\nextern __scanf(2, 3)\nint sscanf(const char *, const char *, ...);\nextern __scanf(2, 0)\nint vsscanf(const char *, const char *, va_list);\n\nextern int get_option(char **str, int *pint);\nextern char *get_options(const char *str, int nints, int *ints);\nextern unsigned long long memparse(const char *ptr, char **retptr);\nextern bool parse_option_str(const char *str, const char *option);\nextern char *next_arg(char *args, char **param, char **val);\n\nextern int core_kernel_text(unsigned long addr);\nextern int init_kernel_text(unsigned long addr);\nextern int core_kernel_data(unsigned long addr);\nextern int __kernel_text_address(unsigned long addr);\nextern int kernel_text_address(unsigned long addr);\nextern int func_ptr_is_kernel_text(void *ptr);\n\n#ifdef CONFIG_SMP\nextern unsigned int sysctl_oops_all_cpu_backtrace;\n#else\n#define sysctl_oops_all_cpu_backtrace 0\n#endif /* CONFIG_SMP */\n\nextern void bust_spinlocks(int yes);\nextern int panic_timeout;\nextern unsigned long panic_print;\nextern int panic_on_oops;\nextern int panic_on_unrecovered_nmi;\nextern int panic_on_io_nmi;\nextern int panic_on_warn;\nextern unsigned long panic_on_taint;\nextern bool panic_on_taint_nousertaint;\nextern int sysctl_panic_on_rcu_stall;\nextern int sysctl_max_rcu_stall_to_panic;\nextern int sysctl_panic_on_stackoverflow;\n\nextern bool crash_kexec_post_notifiers;\n\n/*\n * panic_cpu is used for synchronizing panic() and crash_kexec() execution. It\n * holds a CPU number which is executing panic() currently. A value of\n * PANIC_CPU_INVALID means no CPU has entered panic() or crash_kexec().\n */\nextern atomic_t panic_cpu;\n#define PANIC_CPU_INVALID\t-1\n\n/*\n * Only to be used by arch init code. If the user over-wrote the default\n * CONFIG_PANIC_TIMEOUT, honor it.\n */\nstatic inline void set_arch_panic_timeout(int timeout, int arch_default_timeout)\n{\n\tif (panic_timeout == arch_default_timeout)\n\t\tpanic_timeout = timeout;\n}\nextern const char *print_tainted(void);\nenum lockdep_ok {\n\tLOCKDEP_STILL_OK,\n\tLOCKDEP_NOW_UNRELIABLE\n};\nextern void add_taint(unsigned flag, enum lockdep_ok);\nextern int test_taint(unsigned flag);\nextern unsigned long get_taint(void);\nextern int root_mountflags;\n\nextern bool early_boot_irqs_disabled;\n\n/*\n * Values used for system_state. Ordering of the states must not be changed\n * as code checks for <, <=, >, >= STATE.\n */\nextern enum system_states {\n\tSYSTEM_BOOTING,\n\tSYSTEM_SCHEDULING,\n\tSYSTEM_RUNNING,\n\tSYSTEM_HALT,\n\tSYSTEM_POWER_OFF,\n\tSYSTEM_RESTART,\n\tSYSTEM_SUSPEND,\n} system_state;\n\n/* This cannot be an enum because some may be used in assembly source. */\n#define TAINT_PROPRIETARY_MODULE\t0\n#define TAINT_FORCED_MODULE\t\t1\n#define TAINT_CPU_OUT_OF_SPEC\t\t2\n#define TAINT_FORCED_RMMOD\t\t3\n#define TAINT_MACHINE_CHECK\t\t4\n#define TAINT_BAD_PAGE\t\t\t5\n#define TAINT_USER\t\t\t6\n#define TAINT_DIE\t\t\t7\n#define TAINT_OVERRIDDEN_ACPI_TABLE\t8\n#define TAINT_WARN\t\t\t9\n#define TAINT_CRAP\t\t\t10\n#define TAINT_FIRMWARE_WORKAROUND\t11\n#define TAINT_OOT_MODULE\t\t12\n#define TAINT_UNSIGNED_MODULE\t\t13\n#define TAINT_SOFTLOCKUP\t\t14\n#define TAINT_LIVEPATCH\t\t\t15\n#define TAINT_AUX\t\t\t16\n#define TAINT_RANDSTRUCT\t\t17\n#define TAINT_FLAGS_COUNT\t\t18\n#define TAINT_FLAGS_MAX\t\t\t((1UL << TAINT_FLAGS_COUNT) - 1)\n\nstruct taint_flag {\n\tchar c_true;\t/* character printed when tainted */\n\tchar c_false;\t/* character printed when not tainted */\n\tbool module;\t/* also show as a per-module taint flag */\n};\n\nextern const struct taint_flag taint_flags[TAINT_FLAGS_COUNT];\n\nextern const char hex_asc[];\n#define hex_asc_lo(x)\thex_asc[((x) & 0x0f)]\n#define hex_asc_hi(x)\thex_asc[((x) & 0xf0) >> 4]\n\nstatic inline char *hex_byte_pack(char *buf, u8 byte)\n{\n\t*buf++ = hex_asc_hi(byte);\n\t*buf++ = hex_asc_lo(byte);\n\treturn buf;\n}\n\nextern const char hex_asc_upper[];\n#define hex_asc_upper_lo(x)\thex_asc_upper[((x) & 0x0f)]\n#define hex_asc_upper_hi(x)\thex_asc_upper[((x) & 0xf0) >> 4]\n\nstatic inline char *hex_byte_pack_upper(char *buf, u8 byte)\n{\n\t*buf++ = hex_asc_upper_hi(byte);\n\t*buf++ = hex_asc_upper_lo(byte);\n\treturn buf;\n}\n\nextern int hex_to_bin(char ch);\nextern int __must_check hex2bin(u8 *dst, const char *src, size_t count);\nextern char *bin2hex(char *dst, const void *src, size_t count);\n\nbool mac_pton(const char *s, u8 *mac);\n\n/*\n * General tracing related utility functions - trace_printk(),\n * tracing_on/tracing_off and tracing_start()/tracing_stop\n *\n * Use tracing_on/tracing_off when you want to quickly turn on or off\n * tracing. It simply enables or disables the recording of the trace events.\n * This also corresponds to the user space /sys/kernel/debug/tracing/tracing_on\n * file, which gives a means for the kernel and userspace to interact.\n * Place a tracing_off() in the kernel where you want tracing to end.\n * From user space, examine the trace, and then echo 1 > tracing_on\n * to continue tracing.\n *\n * tracing_stop/tracing_start has slightly more overhead. It is used\n * by things like suspend to ram where disabling the recording of the\n * trace is not enough, but tracing must actually stop because things\n * like calling smp_processor_id() may crash the system.\n *\n * Most likely, you want to use tracing_on/tracing_off.\n */\n\nenum ftrace_dump_mode {\n\tDUMP_NONE,\n\tDUMP_ALL,\n\tDUMP_ORIG,\n};\n\n#ifdef CONFIG_TRACING\nvoid tracing_on(void);\nvoid tracing_off(void);\nint tracing_is_on(void);\nvoid tracing_snapshot(void);\nvoid tracing_snapshot_alloc(void);\n\nextern void tracing_start(void);\nextern void tracing_stop(void);\n\nstatic inline __printf(1, 2)\nvoid ____trace_printk_check_format(const char *fmt, ...)\n{\n}\n#define __trace_printk_check_format(fmt, args...)\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tif (0)\t\t\t\t\t\t\t\t\\\n\t\t____trace_printk_check_format(fmt, ##args);\t\t\\\n} while (0)\n\n/**\n * trace_printk - printf formatting in the ftrace buffer\n * @fmt: the printf format for printing\n *\n * Note: __trace_printk is an internal function for trace_printk() and\n *       the @ip is passed in via the trace_printk() macro.\n *\n * This function allows a kernel developer to debug fast path sections\n * that printk is not appropriate for. By scattering in various\n * printk like tracing in the code, a developer can quickly see\n * where problems are occurring.\n *\n * This is intended as a debugging tool for the developer only.\n * Please refrain from leaving trace_printks scattered around in\n * your code. (Extra memory is used for special buffers that are\n * allocated when trace_printk() is used.)\n *\n * A little optimization trick is done here. If there's only one\n * argument, there's no need to scan the string for printf formats.\n * The trace_puts() will suffice. But how can we take advantage of\n * using trace_puts() when trace_printk() has only one argument?\n * By stringifying the args and checking the size we can tell\n * whether or not there are args. __stringify((__VA_ARGS__)) will\n * turn into \"()\\0\" with a size of 3 when there are no args, anything\n * else will be bigger. All we need to do is define a string to this,\n * and then take its size and compare to 3. If it's bigger, use\n * do_trace_printk() otherwise, optimize it to trace_puts(). Then just\n * let gcc optimize the rest.\n */\n\n#define trace_printk(fmt, ...)\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\\\n\tchar _______STR[] = __stringify((__VA_ARGS__));\t\\\n\tif (sizeof(_______STR) > 3)\t\t\t\\\n\t\tdo_trace_printk(fmt, ##__VA_ARGS__);\t\\\n\telse\t\t\t\t\t\t\\\n\t\ttrace_puts(fmt);\t\t\t\\\n} while (0)\n\n#define do_trace_printk(fmt, args...)\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tstatic const char *trace_printk_fmt __used\t\t\t\\\n\t\t__section(\"__trace_printk_fmt\") =\t\t\t\\\n\t\t__builtin_constant_p(fmt) ? fmt : NULL;\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\t__trace_printk_check_format(fmt, ##args);\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\tif (__builtin_constant_p(fmt))\t\t\t\t\t\\\n\t\t__trace_bprintk(_THIS_IP_, trace_printk_fmt, ##args);\t\\\n\telse\t\t\t\t\t\t\t\t\\\n\t\t__trace_printk(_THIS_IP_, fmt, ##args);\t\t\t\\\n} while (0)\n\nextern __printf(2, 3)\nint __trace_bprintk(unsigned long ip, const char *fmt, ...);\n\nextern __printf(2, 3)\nint __trace_printk(unsigned long ip, const char *fmt, ...);\n\n/**\n * trace_puts - write a string into the ftrace buffer\n * @str: the string to record\n *\n * Note: __trace_bputs is an internal function for trace_puts and\n *       the @ip is passed in via the trace_puts macro.\n *\n * This is similar to trace_printk() but is made for those really fast\n * paths that a developer wants the least amount of \"Heisenbug\" effects,\n * where the processing of the print format is still too much.\n *\n * This function allows a kernel developer to debug fast path sections\n * that printk is not appropriate for. By scattering in various\n * printk like tracing in the code, a developer can quickly see\n * where problems are occurring.\n *\n * This is intended as a debugging tool for the developer only.\n * Please refrain from leaving trace_puts scattered around in\n * your code. (Extra memory is used for special buffers that are\n * allocated when trace_puts() is used.)\n *\n * Returns: 0 if nothing was written, positive # if string was.\n *  (1 when __trace_bputs is used, strlen(str) when __trace_puts is used)\n */\n\n#define trace_puts(str) ({\t\t\t\t\t\t\\\n\tstatic const char *trace_printk_fmt __used\t\t\t\\\n\t\t__section(\"__trace_printk_fmt\") =\t\t\t\\\n\t\t__builtin_constant_p(str) ? str : NULL;\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\tif (__builtin_constant_p(str))\t\t\t\t\t\\\n\t\t__trace_bputs(_THIS_IP_, trace_printk_fmt);\t\t\\\n\telse\t\t\t\t\t\t\t\t\\\n\t\t__trace_puts(_THIS_IP_, str, strlen(str));\t\t\\\n})\nextern int __trace_bputs(unsigned long ip, const char *str);\nextern int __trace_puts(unsigned long ip, const char *str, int size);\n\nextern void trace_dump_stack(int skip);\n\n/*\n * The double __builtin_constant_p is because gcc will give us an error\n * if we try to allocate the static variable to fmt if it is not a\n * constant. Even with the outer if statement.\n */\n#define ftrace_vprintk(fmt, vargs)\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tif (__builtin_constant_p(fmt)) {\t\t\t\t\\\n\t\tstatic const char *trace_printk_fmt __used\t\t\\\n\t\t  __section(\"__trace_printk_fmt\") =\t\t\t\\\n\t\t\t__builtin_constant_p(fmt) ? fmt : NULL;\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\t\t__ftrace_vbprintk(_THIS_IP_, trace_printk_fmt, vargs);\t\\\n\t} else\t\t\t\t\t\t\t\t\\\n\t\t__ftrace_vprintk(_THIS_IP_, fmt, vargs);\t\t\\\n} while (0)\n\nextern __printf(2, 0) int\n__ftrace_vbprintk(unsigned long ip, const char *fmt, va_list ap);\n\nextern __printf(2, 0) int\n__ftrace_vprintk(unsigned long ip, const char *fmt, va_list ap);\n\nextern void ftrace_dump(enum ftrace_dump_mode oops_dump_mode);\n#else\nstatic inline void tracing_start(void) { }\nstatic inline void tracing_stop(void) { }\nstatic inline void trace_dump_stack(int skip) { }\n\nstatic inline void tracing_on(void) { }\nstatic inline void tracing_off(void) { }\nstatic inline int tracing_is_on(void) { return 0; }\nstatic inline void tracing_snapshot(void) { }\nstatic inline void tracing_snapshot_alloc(void) { }\n\nstatic inline __printf(1, 2)\nint trace_printk(const char *fmt, ...)\n{\n\treturn 0;\n}\nstatic __printf(1, 0) inline int\nftrace_vprintk(const char *fmt, va_list ap)\n{\n\treturn 0;\n}\nstatic inline void ftrace_dump(enum ftrace_dump_mode oops_dump_mode) { }\n#endif /* CONFIG_TRACING */\n\n/* This counts to 12. Any more, it will return 13th argument. */\n#define __COUNT_ARGS(_0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, _n, X...) _n\n#define COUNT_ARGS(X...) __COUNT_ARGS(, ##X, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0)\n\n#define __CONCAT(a, b) a ## b\n#define CONCATENATE(a, b) __CONCAT(a, b)\n\n/**\n * container_of - cast a member of a structure out to the containing structure\n * @ptr:\tthe pointer to the member.\n * @type:\tthe type of the container struct this is embedded in.\n * @member:\tthe name of the member within the struct.\n *\n */\n#define container_of(ptr, type, member) ({\t\t\t\t\\\n\tvoid *__mptr = (void *)(ptr);\t\t\t\t\t\\\n\tBUILD_BUG_ON_MSG(!__same_type(*(ptr), ((type *)0)->member) &&\t\\\n\t\t\t !__same_type(*(ptr), void),\t\t\t\\\n\t\t\t \"pointer type mismatch in container_of()\");\t\\\n\t((type *)(__mptr - offsetof(type, member))); })\n\n/**\n * container_of_safe - cast a member of a structure out to the containing structure\n * @ptr:\tthe pointer to the member.\n * @type:\tthe type of the container struct this is embedded in.\n * @member:\tthe name of the member within the struct.\n *\n * If IS_ERR_OR_NULL(ptr), ptr is returned unchanged.\n */\n#define container_of_safe(ptr, type, member) ({\t\t\t\t\\\n\tvoid *__mptr = (void *)(ptr);\t\t\t\t\t\\\n\tBUILD_BUG_ON_MSG(!__same_type(*(ptr), ((type *)0)->member) &&\t\\\n\t\t\t !__same_type(*(ptr), void),\t\t\t\\\n\t\t\t \"pointer type mismatch in container_of()\");\t\\\n\tIS_ERR_OR_NULL(__mptr) ? ERR_CAST(__mptr) :\t\t\t\\\n\t\t((type *)(__mptr - offsetof(type, member))); })\n\n/* Rebuild everything on CONFIG_FTRACE_MCOUNT_RECORD */\n#ifdef CONFIG_FTRACE_MCOUNT_RECORD\n# define REBUILD_DUE_TO_FTRACE_MCOUNT_RECORD\n#endif\n\n/* Permissions on a sysfs file: you didn't miss the 0 prefix did you? */\n#define VERIFY_OCTAL_PERMISSIONS(perms)\t\t\t\t\t\t\\\n\t(BUILD_BUG_ON_ZERO((perms) < 0) +\t\t\t\t\t\\\n\t BUILD_BUG_ON_ZERO((perms) > 0777) +\t\t\t\t\t\\\n\t /* USER_READABLE >= GROUP_READABLE >= OTHER_READABLE */\t\t\\\n\t BUILD_BUG_ON_ZERO((((perms) >> 6) & 4) < (((perms) >> 3) & 4)) +\t\\\n\t BUILD_BUG_ON_ZERO((((perms) >> 3) & 4) < ((perms) & 4)) +\t\t\\\n\t /* USER_WRITABLE >= GROUP_WRITABLE */\t\t\t\t\t\\\n\t BUILD_BUG_ON_ZERO((((perms) >> 6) & 2) < (((perms) >> 3) & 2)) +\t\\\n\t /* OTHER_WRITABLE?  Generally considered a bad idea. */\t\t\\\n\t BUILD_BUG_ON_ZERO((perms) & 2) +\t\t\t\t\t\\\n\t (perms))\n#endif\n"}, "2": {"id": 2, "path": "/src/include/linux/build_bug.h", "content": "/* SPDX-License-Identifier: GPL-2.0 */\n#ifndef _LINUX_BUILD_BUG_H\n#define _LINUX_BUILD_BUG_H\n\n#include <linux/compiler.h>\n\n#ifdef __CHECKER__\n#define BUILD_BUG_ON_ZERO(e) (0)\n#else /* __CHECKER__ */\n/*\n * Force a compilation error if condition is true, but also produce a\n * result (of value 0 and type int), so the expression can be used\n * e.g. in a structure initializer (or where-ever else comma expressions\n * aren't permitted).\n */\n#define BUILD_BUG_ON_ZERO(e) ((int)(sizeof(struct { int:(-!!(e)); })))\n#endif /* __CHECKER__ */\n\n/* Force a compilation error if a constant expression is not a power of 2 */\n#define __BUILD_BUG_ON_NOT_POWER_OF_2(n)\t\\\n\tBUILD_BUG_ON(((n) & ((n) - 1)) != 0)\n#define BUILD_BUG_ON_NOT_POWER_OF_2(n)\t\t\t\\\n\tBUILD_BUG_ON((n) == 0 || (((n) & ((n) - 1)) != 0))\n\n/*\n * BUILD_BUG_ON_INVALID() permits the compiler to check the validity of the\n * expression but avoids the generation of any code, even if that expression\n * has side-effects.\n */\n#define BUILD_BUG_ON_INVALID(e) ((void)(sizeof((__force long)(e))))\n\n/**\n * BUILD_BUG_ON_MSG - break compile if a condition is true & emit supplied\n *\t\t      error message.\n * @condition: the condition which the compiler should know is false.\n *\n * See BUILD_BUG_ON for description.\n */\n#define BUILD_BUG_ON_MSG(cond, msg) compiletime_assert(!(cond), msg)\n\n/**\n * BUILD_BUG_ON - break compile if a condition is true.\n * @condition: the condition which the compiler should know is false.\n *\n * If you have some code which relies on certain constants being equal, or\n * some other compile-time-evaluated condition, you should use BUILD_BUG_ON to\n * detect if someone changes it.\n */\n#define BUILD_BUG_ON(condition) \\\n\tBUILD_BUG_ON_MSG(condition, \"BUILD_BUG_ON failed: \" #condition)\n\n/**\n * BUILD_BUG - break compile if used.\n *\n * If you have some code that you expect the compiler to eliminate at\n * build time, you should use BUILD_BUG to detect if it is\n * unexpectedly used.\n */\n#define BUILD_BUG() BUILD_BUG_ON_MSG(1, \"BUILD_BUG failed\")\n\n/**\n * static_assert - check integer constant expression at build time\n *\n * static_assert() is a wrapper for the C11 _Static_assert, with a\n * little macro magic to make the message optional (defaulting to the\n * stringification of the tested expression).\n *\n * Contrary to BUILD_BUG_ON(), static_assert() can be used at global\n * scope, but requires the expression to be an integer constant\n * expression (i.e., it is not enough that __builtin_constant_p() is\n * true for expr).\n *\n * Also note that BUILD_BUG_ON() fails the build if the condition is\n * true, while static_assert() fails the build if the expression is\n * false.\n */\n#define static_assert(expr, ...) __static_assert(expr, ##__VA_ARGS__, #expr)\n#define __static_assert(expr, msg, ...) _Static_assert(expr, msg)\n\n#endif\t/* _LINUX_BUILD_BUG_H */\n"}, "3": {"id": 3, "path": "/src/include/linux/compiler_types.h", "content": "/* SPDX-License-Identifier: GPL-2.0 */\n#ifndef __LINUX_COMPILER_TYPES_H\n#define __LINUX_COMPILER_TYPES_H\n\n#ifndef __ASSEMBLY__\n\n#ifdef __CHECKER__\n/* address spaces */\n# define __kernel\t__attribute__((address_space(0)))\n# define __user\t\t__attribute__((noderef, address_space(__user)))\n# define __iomem\t__attribute__((noderef, address_space(__iomem)))\n# define __percpu\t__attribute__((noderef, address_space(__percpu)))\n# define __rcu\t\t__attribute__((noderef, address_space(__rcu)))\nstatic inline void __chk_user_ptr(const volatile void __user *ptr) { }\nstatic inline void __chk_io_ptr(const volatile void __iomem *ptr) { }\n/* context/locking */\n# define __must_hold(x)\t__attribute__((context(x,1,1)))\n# define __acquires(x)\t__attribute__((context(x,0,1)))\n# define __releases(x)\t__attribute__((context(x,1,0)))\n# define __acquire(x)\t__context__(x,1)\n# define __release(x)\t__context__(x,-1)\n# define __cond_lock(x,c)\t((c) ? ({ __acquire(x); 1; }) : 0)\n/* other */\n# define __force\t__attribute__((force))\n# define __nocast\t__attribute__((nocast))\n# define __safe\t\t__attribute__((safe))\n# define __private\t__attribute__((noderef))\n# define ACCESS_PRIVATE(p, member) (*((typeof((p)->member) __force *) &(p)->member))\n#else /* __CHECKER__ */\n/* address spaces */\n# define __kernel\n# ifdef STRUCTLEAK_PLUGIN\n#  define __user\t__attribute__((user))\n# else\n#  define __user\n# endif\n# define __iomem\n# define __percpu\n# define __rcu\n# define __chk_user_ptr(x)\t(void)0\n# define __chk_io_ptr(x)\t(void)0\n/* context/locking */\n# define __must_hold(x)\n# define __acquires(x)\n# define __releases(x)\n# define __acquire(x)\t(void)0\n# define __release(x)\t(void)0\n# define __cond_lock(x,c) (c)\n/* other */\n# define __force\n# define __nocast\n# define __safe\n# define __private\n# define ACCESS_PRIVATE(p, member) ((p)->member)\n# define __builtin_warning(x, y...) (1)\n#endif /* __CHECKER__ */\n\n/* Indirect macros required for expanded argument pasting, eg. __LINE__. */\n#define ___PASTE(a,b) a##b\n#define __PASTE(a,b) ___PASTE(a,b)\n\n#ifdef __KERNEL__\n\n/* Attributes */\n#include <linux/compiler_attributes.h>\n\n/* Builtins */\n\n/*\n * __has_builtin is supported on gcc >= 10, clang >= 3 and icc >= 21.\n * In the meantime, to support gcc < 10, we implement __has_builtin\n * by hand.\n */\n#ifndef __has_builtin\n#define __has_builtin(x) (0)\n#endif\n\n/* Compiler specific macros. */\n#ifdef __clang__\n#include <linux/compiler-clang.h>\n#elif defined(__INTEL_COMPILER)\n#include <linux/compiler-intel.h>\n#elif defined(__GNUC__)\n/* The above compilers also define __GNUC__, so order is important here. */\n#include <linux/compiler-gcc.h>\n#else\n#error \"Unknown compiler\"\n#endif\n\n/*\n * Some architectures need to provide custom definitions of macros provided\n * by linux/compiler-*.h, and can do so using asm/compiler.h. We include that\n * conditionally rather than using an asm-generic wrapper in order to avoid\n * build failures if any C compilation, which will include this file via an\n * -include argument in c_flags, occurs prior to the asm-generic wrappers being\n * generated.\n */\n#ifdef CONFIG_HAVE_ARCH_COMPILER_H\n#include <asm/compiler.h>\n#endif\n\nstruct ftrace_branch_data {\n\tconst char *func;\n\tconst char *file;\n\tunsigned line;\n\tunion {\n\t\tstruct {\n\t\t\tunsigned long correct;\n\t\t\tunsigned long incorrect;\n\t\t};\n\t\tstruct {\n\t\t\tunsigned long miss;\n\t\t\tunsigned long hit;\n\t\t};\n\t\tunsigned long miss_hit[2];\n\t};\n};\n\nstruct ftrace_likely_data {\n\tstruct ftrace_branch_data\tdata;\n\tunsigned long\t\t\tconstant;\n};\n\n#if defined(CC_USING_HOTPATCH)\n#define notrace\t\t\t__attribute__((hotpatch(0, 0)))\n#elif defined(CC_USING_PATCHABLE_FUNCTION_ENTRY)\n#define notrace\t\t\t__attribute__((patchable_function_entry(0, 0)))\n#else\n#define notrace\t\t\t__attribute__((__no_instrument_function__))\n#endif\n\n/*\n * it doesn't make sense on ARM (currently the only user of __naked)\n * to trace naked functions because then mcount is called without\n * stack and frame pointer being set up and there is no chance to\n * restore the lr register to the value before mcount was called.\n */\n#define __naked\t\t\t__attribute__((__naked__)) notrace\n\n#define __compiler_offsetof(a, b)\t__builtin_offsetof(a, b)\n\n/*\n * Prefer gnu_inline, so that extern inline functions do not emit an\n * externally visible function. This makes extern inline behave as per gnu89\n * semantics rather than c99. This prevents multiple symbol definition errors\n * of extern inline functions at link time.\n * A lot of inline functions can cause havoc with function tracing.\n */\n#define inline inline __gnu_inline __inline_maybe_unused notrace\n\n/*\n * gcc provides both __inline__ and __inline as alternate spellings of\n * the inline keyword, though the latter is undocumented. New kernel\n * code should only use the inline spelling, but some existing code\n * uses __inline__. Since we #define inline above, to ensure\n * __inline__ has the same semantics, we need this #define.\n *\n * However, the spelling __inline is strictly reserved for referring\n * to the bare keyword.\n */\n#define __inline__ inline\n\n/*\n * GCC does not warn about unused static inline functions for -Wunused-function.\n * Suppress the warning in clang as well by using __maybe_unused, but enable it\n * for W=1 build. This will allow clang to find unused functions. Remove the\n * __inline_maybe_unused entirely after fixing most of -Wunused-function warnings.\n */\n#ifdef KBUILD_EXTRA_WARN1\n#define __inline_maybe_unused\n#else\n#define __inline_maybe_unused __maybe_unused\n#endif\n\n/*\n * Rather then using noinline to prevent stack consumption, use\n * noinline_for_stack instead.  For documentation reasons.\n */\n#define noinline_for_stack noinline\n\n/*\n * Sanitizer helper attributes: Because using __always_inline and\n * __no_sanitize_* conflict, provide helper attributes that will either expand\n * to __no_sanitize_* in compilation units where instrumentation is enabled\n * (__SANITIZE_*__), or __always_inline in compilation units without\n * instrumentation (__SANITIZE_*__ undefined).\n */\n#ifdef __SANITIZE_ADDRESS__\n/*\n * We can't declare function 'inline' because __no_sanitize_address conflicts\n * with inlining. Attempt to inline it may cause a build failure.\n *     https://gcc.gnu.org/bugzilla/show_bug.cgi?id=67368\n * '__maybe_unused' allows us to avoid defined-but-not-used warnings.\n */\n# define __no_kasan_or_inline __no_sanitize_address notrace __maybe_unused\n# define __no_sanitize_or_inline __no_kasan_or_inline\n#else\n# define __no_kasan_or_inline __always_inline\n#endif\n\n#define __no_kcsan __no_sanitize_thread\n#ifdef __SANITIZE_THREAD__\n# define __no_sanitize_or_inline __no_kcsan notrace __maybe_unused\n#endif\n\n#ifndef __no_sanitize_or_inline\n#define __no_sanitize_or_inline __always_inline\n#endif\n\n/* Section for code which can't be instrumented at all */\n#define noinstr\t\t\t\t\t\t\t\t\\\n\tnoinline notrace __attribute((__section__(\".noinstr.text\")))\t\\\n\t__no_kcsan __no_sanitize_address\n\n#endif /* __KERNEL__ */\n\n#endif /* __ASSEMBLY__ */\n\n/*\n * The below symbols may be defined for one or more, but not ALL, of the above\n * compilers. We don't consider that to be an error, so set them to nothing.\n * For example, some of them are for compiler specific plugins.\n */\n#ifndef __latent_entropy\n# define __latent_entropy\n#endif\n\n#ifndef __randomize_layout\n# define __randomize_layout __designated_init\n#endif\n\n#ifndef __no_randomize_layout\n# define __no_randomize_layout\n#endif\n\n#ifndef randomized_struct_fields_start\n# define randomized_struct_fields_start\n# define randomized_struct_fields_end\n#endif\n\n#ifndef __noscs\n# define __noscs\n#endif\n\n#ifndef asm_volatile_goto\n#define asm_volatile_goto(x...) asm goto(x)\n#endif\n\n#ifdef CONFIG_CC_HAS_ASM_INLINE\n#define asm_inline asm __inline\n#else\n#define asm_inline asm\n#endif\n\n/* Are two types/vars the same type (ignoring qualifiers)? */\n#define __same_type(a, b) __builtin_types_compatible_p(typeof(a), typeof(b))\n\n/*\n * __unqual_scalar_typeof(x) - Declare an unqualified scalar type, leaving\n *\t\t\t       non-scalar types unchanged.\n */\n/*\n * Prefer C11 _Generic for better compile-times and simpler code. Note: 'char'\n * is not type-compatible with 'signed char', and we define a separate case.\n */\n#define __scalar_type_to_expr_cases(type)\t\t\t\t\\\n\t\tunsigned type:\t(unsigned type)0,\t\t\t\\\n\t\tsigned type:\t(signed type)0\n\n#define __unqual_scalar_typeof(x) typeof(\t\t\t\t\\\n\t\t_Generic((x),\t\t\t\t\t\t\\\n\t\t\t char:\t(char)0,\t\t\t\t\\\n\t\t\t __scalar_type_to_expr_cases(char),\t\t\\\n\t\t\t __scalar_type_to_expr_cases(short),\t\t\\\n\t\t\t __scalar_type_to_expr_cases(int),\t\t\\\n\t\t\t __scalar_type_to_expr_cases(long),\t\t\\\n\t\t\t __scalar_type_to_expr_cases(long long),\t\\\n\t\t\t default: (x)))\n\n/* Is this type a native word size -- useful for atomic operations */\n#define __native_word(t) \\\n\t(sizeof(t) == sizeof(char) || sizeof(t) == sizeof(short) || \\\n\t sizeof(t) == sizeof(int) || sizeof(t) == sizeof(long))\n\n/* Compile time object size, -1 for unknown */\n#ifndef __compiletime_object_size\n# define __compiletime_object_size(obj) -1\n#endif\n#ifndef __compiletime_warning\n# define __compiletime_warning(message)\n#endif\n#ifndef __compiletime_error\n# define __compiletime_error(message)\n#endif\n\n#ifdef __OPTIMIZE__\n# define __compiletime_assert(condition, msg, prefix, suffix)\t\t\\\n\tdo {\t\t\t\t\t\t\t\t\\\n\t\textern void prefix ## suffix(void) __compiletime_error(msg); \\\n\t\tif (!(condition))\t\t\t\t\t\\\n\t\t\tprefix ## suffix();\t\t\t\t\\\n\t} while (0)\n#else\n# define __compiletime_assert(condition, msg, prefix, suffix) do { } while (0)\n#endif\n\n#define _compiletime_assert(condition, msg, prefix, suffix) \\\n\t__compiletime_assert(condition, msg, prefix, suffix)\n\n/**\n * compiletime_assert - break build and emit msg if condition is false\n * @condition: a compile-time constant condition to check\n * @msg:       a message to emit if condition is false\n *\n * In tradition of POSIX assert, this macro will break the build if the\n * supplied condition is *false*, emitting the supplied error message if the\n * compiler has support to do so.\n */\n#define compiletime_assert(condition, msg) \\\n\t_compiletime_assert(condition, msg, __compiletime_assert_, __COUNTER__)\n\n#define compiletime_assert_atomic_type(t)\t\t\t\t\\\n\tcompiletime_assert(__native_word(t),\t\t\t\t\\\n\t\t\"Need native word sized stores/loads for atomicity.\")\n\n/* Helpers for emitting diagnostics in pragmas. */\n#ifndef __diag\n#define __diag(string)\n#endif\n\n#ifndef __diag_GCC\n#define __diag_GCC(version, severity, string)\n#endif\n\n#define __diag_push()\t__diag(push)\n#define __diag_pop()\t__diag(pop)\n\n#define __diag_ignore(compiler, version, option, comment) \\\n\t__diag_ ## compiler(version, ignore, option)\n#define __diag_warn(compiler, version, option, comment) \\\n\t__diag_ ## compiler(version, warn, option)\n#define __diag_error(compiler, version, option, comment) \\\n\t__diag_ ## compiler(version, error, option)\n\n#endif /* __LINUX_COMPILER_TYPES_H */\n"}}, "reports": [{"events": [{"location": {"col": 23, "file": 0, "line": 3509}, "message": "Left side of '&&' is false"}, {"location": {"col": 61, "file": 1, "line": 709}, "message": "expanded from macro 'container_of'"}, {"location": {"col": 23, "file": 0, "line": 3509}, "message": "Taking false branch"}, {"location": {"col": 2, "file": 1, "line": 709}, "message": "expanded from macro 'container_of'"}, {"location": {"col": 37, "file": 2, "line": 39}, "message": "expanded from macro 'BUILD_BUG_ON_MSG'"}, {"location": {"col": 2, "file": 3, "line": 320}, "message": "expanded from macro 'compiletime_assert'"}, {"location": {"col": 2, "file": 3, "line": 308}, "message": "expanded from macro '_compiletime_assert'"}, {"location": {"col": 3, "file": 3, "line": 300}, "message": "expanded from macro '__compiletime_assert'"}, {"location": {"col": 23, "file": 0, "line": 3509}, "message": "Loop condition is false.  Exiting loop"}, {"location": {"col": 2, "file": 1, "line": 709}, "message": "expanded from macro 'container_of'"}, {"location": {"col": 37, "file": 2, "line": 39}, "message": "expanded from macro 'BUILD_BUG_ON_MSG'"}, {"location": {"col": 2, "file": 3, "line": 320}, "message": "expanded from macro 'compiletime_assert'"}, {"location": {"col": 2, "file": 3, "line": 308}, "message": "expanded from macro '_compiletime_assert'"}, {"location": {"col": 2, "file": 3, "line": 298}, "message": "expanded from macro '__compiletime_assert'"}, {"location": {"col": 2, "file": 0, "line": 3515}, "message": "Calling 'sky2_all_up'"}, {"location": {"col": 14, "file": 0, "line": 3486}, "message": "Assuming 'i' is < field 'ports'"}, {"location": {"col": 2, "file": 0, "line": 3486}, "message": "Loop condition is true.  Entering loop body"}, {"location": {"col": 7, "file": 0, "line": 3490}, "message": "Assuming the condition is true"}, {"location": {"col": 3, "file": 0, "line": 3490}, "message": "Taking true branch"}, {"location": {"col": 4, "file": 0, "line": 3491}, "message": "Execution continues on line 3486"}, {"location": {"col": 14, "file": 0, "line": 3486}, "message": "Assuming 'i' is < field 'ports'"}, {"location": {"col": 2, "file": 0, "line": 3486}, "message": "Loop condition is true.  Entering loop body"}, {"location": {"col": 7, "file": 0, "line": 3490}, "message": "Assuming the condition is true"}, {"location": {"col": 3, "file": 0, "line": 3490}, "message": "Taking true branch"}, {"location": {"col": 4, "file": 0, "line": 3491}, "message": "Execution continues on line 3486"}, {"location": {"col": 29, "file": 0, "line": 3486}, "message": "The value 2 is assigned to 'i'"}, {"location": {"col": 14, "file": 0, "line": 3486}, "message": "Assuming 'i' is < field 'ports'"}, {"location": {"col": 2, "file": 0, "line": 3486}, "message": "Loop condition is true.  Entering loop body"}, {"location": {"col": 7, "file": 0, "line": 3490}, "message": "Assuming the condition is false"}, {"location": {"col": 3, "file": 0, "line": 3490}, "message": "Taking false branch"}, {"location": {"col": 9, "file": 0, "line": 3495}, "message": "Assigned value is garbage or undefined"}, {"location": {"col": 9, "file": 0, "line": 3495}, "message": "Assigned value is garbage or undefined"}], "macros": [], "notes": [], "path": "/src/drivers/net/ethernet/marvell/sky2.c", "reportHash": "2d18e76bb9e629a92fd726b587607982", "checkerName": "clang-analyzer-core.uninitialized.Assign", "reviewStatus": null, "severity": "UNSPECIFIED"}, {"events": [{"location": {"col": 8, "file": 0, "line": 4988}, "message": "Although the value stored to 'err' is used in the enclosing expression, the value is never actually read from 'err'"}, {"location": {"col": 8, "file": 0, "line": 4988}, "message": "Although the value stored to 'err' is used in the enclosing expression, the value is never actually read from 'err'"}], "macros": [], "notes": [], "path": "/src/drivers/net/ethernet/marvell/sky2.c", "reportHash": "2af3574e4fe8814becd033063a676253", "checkerName": "clang-analyzer-deadcode.DeadStores", "reviewStatus": null, "severity": "UNSPECIFIED"}]};
      window.onload = function() {
        if (!browserCompatible) {
          setNonCompatibleBrowserMessage();
        } else {
          BugViewer.init(data.files, data.reports);
          BugViewer.create();
          BugViewer.initByUrl();
        }
      };
    </script>
  </head>
  <body>
  <div class="container">
    <div id="content">
      <div id="side-bar">
        <div class="header">
          <a href="index.html" class="button">&#8249; Return to List</a>
        </div>
        <div id="report-nav">
          <div class="header">Reports</div>
        </div>
      </div>
      <div id="editor-wrapper">
        <div class="header">
          <div id="file">
            <span class="label">File:</span>
            <span id="file-path"></span>
          </div>
          <div id="checker">
            <span class="label">Checker name:</span>
            <span id="checker-name"></span>
          </div>
          <div id="review-status-wrapper">
            <span class="label">Review status:</span>
            <span id="review-status"></span>
          </div>
        </div>
        <div id="editor"></div>
      </div>
    </div>
  </div>
  </body>
</html>
