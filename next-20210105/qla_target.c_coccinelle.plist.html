<!DOCTYPE html>
<html>
  <head>
    <title>Plist HTML Viewer</title>

    <meta charset="UTF-8">

    <style type="text/css">
      .CodeMirror{font-family:monospace;height:300px;color:#000;direction:ltr}.CodeMirror-lines{padding:4px 0}.CodeMirror pre{padding:0 4px}.CodeMirror-gutter-filler,.CodeMirror-scrollbar-filler{background-color:#fff}.CodeMirror-gutters{border-right:1px solid #ddd;background-color:#f7f7f7;white-space:nowrap}.CodeMirror-linenumber{padding:0 3px 0 5px;min-width:20px;text-align:right;color:#999;white-space:nowrap}.CodeMirror-guttermarker{color:#000}.CodeMirror-guttermarker-subtle{color:#999}.CodeMirror-cursor{border-left:1px solid #000;border-right:none;width:0}.CodeMirror div.CodeMirror-secondarycursor{border-left:1px solid silver}.cm-fat-cursor .CodeMirror-cursor{width:auto;border:0!important;background:#7e7}.cm-fat-cursor div.CodeMirror-cursors{z-index:1}.cm-animate-fat-cursor{width:auto;border:0;-webkit-animation:blink 1.06s steps(1) infinite;-moz-animation:blink 1.06s steps(1) infinite;animation:blink 1.06s steps(1) infinite;background-color:#7e7}@-moz-keyframes blink{50%{background-color:transparent}}@-webkit-keyframes blink{50%{background-color:transparent}}@keyframes blink{50%{background-color:transparent}}.cm-tab{display:inline-block;text-decoration:inherit}.CodeMirror-rulers{position:absolute;left:0;right:0;top:-50px;bottom:-20px;overflow:hidden}.CodeMirror-ruler{border-left:1px solid #ccc;top:0;bottom:0;position:absolute}.cm-s-default .cm-header{color:#00f}.cm-s-default .cm-quote{color:#090}.cm-negative{color:#d44}.cm-positive{color:#292}.cm-header,.cm-strong{font-weight:700}.cm-em{font-style:italic}.cm-link{text-decoration:underline}.cm-strikethrough{text-decoration:line-through}.cm-s-default .cm-keyword{color:#708}.cm-s-default .cm-atom{color:#219}.cm-s-default .cm-number{color:#164}.cm-s-default .cm-def{color:#00f}.cm-s-default .cm-variable-2{color:#05a}.cm-s-default .cm-type,.cm-s-default .cm-variable-3{color:#085}.cm-s-default .cm-comment{color:#a50}.cm-s-default .cm-string{color:#a11}.cm-s-default .cm-string-2{color:#f50}.cm-s-default .cm-meta{color:#555}.cm-s-default .cm-qualifier{color:#555}.cm-s-default .cm-builtin{color:#30a}.cm-s-default .cm-bracket{color:#997}.cm-s-default .cm-tag{color:#170}.cm-s-default .cm-attribute{color:#00c}.cm-s-default .cm-hr{color:#999}.cm-s-default .cm-link{color:#00c}.cm-s-default .cm-error{color:red}.cm-invalidchar{color:red}.CodeMirror-composing{border-bottom:2px solid}div.CodeMirror span.CodeMirror-matchingbracket{color:#0f0}div.CodeMirror span.CodeMirror-nonmatchingbracket{color:#f22}.CodeMirror-matchingtag{background:rgba(255,150,0,.3)}.CodeMirror-activeline-background{background:#e8f2ff}.CodeMirror{position:relative;overflow:hidden;background:#fff}.CodeMirror-scroll{overflow:scroll!important;margin-bottom:-30px;margin-right:-30px;padding-bottom:30px;height:100%;outline:0;position:relative}.CodeMirror-sizer{position:relative;border-right:30px solid transparent}.CodeMirror-gutter-filler,.CodeMirror-hscrollbar,.CodeMirror-scrollbar-filler,.CodeMirror-vscrollbar{position:absolute;z-index:6;display:none}.CodeMirror-vscrollbar{right:0;top:0;overflow-x:hidden;overflow-y:scroll}.CodeMirror-hscrollbar{bottom:0;left:0;overflow-y:hidden;overflow-x:scroll}.CodeMirror-scrollbar-filler{right:0;bottom:0}.CodeMirror-gutter-filler{left:0;bottom:0}.CodeMirror-gutters{position:absolute;left:0;top:0;min-height:100%;z-index:3}.CodeMirror-gutter{white-space:normal;height:100%;display:inline-block;vertical-align:top;margin-bottom:-30px}.CodeMirror-gutter-wrapper{position:absolute;z-index:4;background:0 0!important;border:none!important}.CodeMirror-gutter-background{position:absolute;top:0;bottom:0;z-index:4}.CodeMirror-gutter-elt{position:absolute;cursor:default;z-index:4}.CodeMirror-gutter-wrapper ::selection{background-color:transparent}.CodeMirror-gutter-wrapper ::-moz-selection{background-color:transparent}.CodeMirror-lines{cursor:text;min-height:1px}.CodeMirror pre{-moz-border-radius:0;-webkit-border-radius:0;border-radius:0;border-width:0;background:0 0;font-family:inherit;font-size:inherit;margin:0;white-space:pre;word-wrap:normal;line-height:inherit;color:inherit;z-index:2;position:relative;overflow:visible;-webkit-tap-highlight-color:transparent;-webkit-font-variant-ligatures:contextual;font-variant-ligatures:contextual}.CodeMirror-wrap pre{word-wrap:break-word;white-space:pre-wrap;word-break:normal}.CodeMirror-linebackground{position:absolute;left:0;right:0;top:0;bottom:0;z-index:0}.CodeMirror-linewidget{position:relative;z-index:2;overflow:auto}.CodeMirror-rtl pre{direction:rtl}.CodeMirror-code{outline:0}.CodeMirror-gutter,.CodeMirror-gutters,.CodeMirror-linenumber,.CodeMirror-scroll,.CodeMirror-sizer{-moz-box-sizing:content-box;box-sizing:content-box}.CodeMirror-measure{position:absolute;width:100%;height:0;overflow:hidden;visibility:hidden}.CodeMirror-cursor{position:absolute;pointer-events:none}.CodeMirror-measure pre{position:static}div.CodeMirror-cursors{visibility:hidden;position:relative;z-index:3}div.CodeMirror-dragcursors{visibility:visible}.CodeMirror-focused div.CodeMirror-cursors{visibility:visible}.CodeMirror-selected{background:#d9d9d9}.CodeMirror-focused .CodeMirror-selected{background:#d7d4f0}.CodeMirror-crosshair{cursor:crosshair}.CodeMirror-line::selection,.CodeMirror-line>span::selection,.CodeMirror-line>span>span::selection{background:#d7d4f0}.CodeMirror-line::-moz-selection,.CodeMirror-line>span::-moz-selection,.CodeMirror-line>span>span::-moz-selection{background:#d7d4f0}.cm-searching{background-color:#ffa;background-color:rgba(255,255,0,.4)}.cm-force-border{padding-right:.1px}@media print{.CodeMirror div.CodeMirror-cursors{visibility:hidden}}.cm-tab-wrap-hack:after{content:''}span.CodeMirror-selectedtext{background:0 0}
/*# sourceMappingURL=codemirror.min.css.map */

      .severity-low {
  background-color: #669603;
}

.severity-low:after {
  content : 'L';
}

.severity-unspecified {
  background-color: #666666;
}

.severity-unspecified:after {
  content : 'U';
}

.severity-style {
  background-color: #9932cc;
}

.severity-style:after {
  content : 'S';
}

.severity-medium {
  background-color: #a9d323;
  color: black;
}

.severity-medium:after {
  content : 'M';
}

.severity-high {
  background-color: #ffa800;
}

.severity-high:after {
  content : 'H';
}

.severity-critical {
  background-color: #e92625;
}

.severity-critical:after {
  content : 'C';
}

i[class*="severity-"] {
  line-height: normal;
  text-transform: capitalize;
  font-size: 0.8em;
  font-weight: bold;
  color: white;
  display: inline-block;
  width: 16px;
  height: 16px;
  text-align: center;
  font-family: sans-serif;
}

      html, body {
  width: 100%;
  height: 100%;
  padding: 0px;
  margin: 0px;
}

div.container {
  padding: 10px;
}

#content {
  height: 100%;
  display: block;
  overflow: hidden;
}

#content > div {
  margin: 10px;
  overflow: hidden;
  border: 1px solid #ddd;
  border-radius: 3px;
  overflow: hidden;
  height: 97%;
}

.button {
  background-color: #f1f1f1;
  text-decoration: none;
  display: inline-block;
  padding: 8px 16px;
  color: black;
  cursor: pointer;
}

.button:hover {
  background-color: #ddd;
  color: black;
}

.review-status {
  color: white;
  text-align: center;
}

.review-status-confirmed {
  background-color: #e92625;
}

.review-status-false-positive {
  background-color: grey;
}

.review-status-intentional {
  background-color: #669603;
}

      div.container {
  width: 100%;
  height: 100%;
  padding: 0px;
}

#editor-wrapper {
  margin: 10px;
}

#side-bar {
  float: left;
  width: 260px;
  margin: 0px;
}

#report-nav ul {
  list-style-type: none;
  padding: 0;
  margin: 0;
  overflow-y: auto;
  height: 100%;
}

#report-nav ul > li {
  padding: .4em;
  background-color: #fff;
  border-bottom: 1px solid rgba(0,0,0,.125);
  text-align: left;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

#report-nav ul > li.active {
  background-color: #427ea9;
  color: white;
}

#report-nav ul > li:hover {
  background-color: #427ea9;
  color: white;
  cursor: pointer;
}

#report-nav ul a {
  text-decoration: none;
}

#report-nav i[class*="severity-"] {
  margin-right: 5px;
}

.header {
  border-bottom: 1px solid lightgrey;
  font-family: monospace;
  padding: 10px;
  background-color: #fafbfc;
  border-bottom: 1px solid #e1e4e8;
  border-top-left-radius: 2px;
  border-top-right-radius: 2px;
}

#report-nav .header {
  font-weight: bold;
}

#editor-wrapper .header > div {
  padding-top: 2px;
}

#file-path,
#checker-name {
  color: #195ea2;
}

#review-status {
  padding: 0px 5px;
}

#file-path {
  font-family: monospace;
}

.check-msg {
  display: inline-block;
  padding: 3px 6px;
  margin: 1px;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
  border-radius: 5px;
}

.check-msg.info {
  color: #00546f;
  background-color: #bfdfe9;
  border: 1px solid #87a8b3;
}

.check-msg.error {
  background-color: #f2dede;
  color: #a94442;
  border: 1px solid #ebcccc;
}

.check-msg.macro {
  background-color: #d7dac2;
  color: #4f5c6d;
  border: 1px solid #d7dac2;
}

.check-msg.note {
  background-color: #d7d7d7;
  color: #4f5c6d;
  border: 1px solid #bfbfbf;
}

.check-msg.current {
  border: 2px dashed #3692ff;
}

.check-msg .tag {
  padding: 1px 5px;
  text-align: center;
  border-radius: 2px;
  margin-right: 5px;
  text-decoration: inherit;
}

.check-msg .tag.macro {
  background-color: #83876a;
  color: white;
  text-transform: capitalize;
}

.check-msg .tag.note {
  background-color: #9299a1;
  color: white;
  text-transform: capitalize;
}

.checker-enum {
  color: white;
  padding: 1px 5px;
  text-align: center;
  border-radius: 25px;
  margin-right: 5px;
  text-decoration: inherit;
}

.checker-enum.info {
  background-color: #427ea9;
}

.checker-enum.error {
  background-color: #a94442;
}

.arrow {
  border: solid black;
  border-width: 0 3px 3px 0;
  display: inline-block;
  padding: 3px;
  cursor: pointer;
  margin: 0px 5px;
}

.arrow:hover {
  border: solid #437ea8;
  border-width: 0 3px 3px 0;
}

.left-arrow {
  transform: rotate(135deg);
  -webkit-transform: rotate(135deg);
}

.right-arrow {
  transform: rotate(-45deg);
  -webkit-transform: rotate(-45deg);
}

    </style>

    <script type="text/javascript">
      function setNonCompatibleBrowserMessage() {
  document.body.innerHTML =
    '<h2 style="margin-left: 20px;">Your browser is not compatible with CodeChecker Viewer!</h2> \
     <p style="margin-left: 20px;">The version required for the following browsers are:</p> \
     <ul style="margin-left: 20px;"> \
     <li>Internet Explorer: version 9 or newer</li> \
     <li>Firefox: version 22.0 or newer</li> \
     </ul>';
}

// http://stackoverflow.com/questions/5916900/how-can-you-detect-the-version-of-a-browser
var browserVersion = (function(){
  var ua = navigator.userAgent, tem,
    M = ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];

  if (/trident/i.test(M[1])) {
    tem = /\brv[ :]+(\d+)/g.exec(ua) || [];
    return 'IE ' + (tem[1] || '');
  }

  if (M[1] === 'Chrome') {
    tem = ua.match(/\b(OPR|Edge)\/(\d+)/);
    if (tem != null) return tem.slice(1).join(' ').replace('OPR', 'Opera');
  }

  M = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, '-?'];
  if ((tem = ua.match(/version\/(\d+)/i)) != null) M.splice(1, 1, tem[1]);
    return M.join(' ');
})();

var pos = browserVersion.indexOf(' ');
var browser = browserVersion.substr(0, pos);
var version = parseInt(browserVersion.substr(pos + 1));

var browserCompatible
  = browser === 'Firefox'
  ? version >= 22
  : browser === 'IE'
  ? version >= 9
  : true;


      /* MIT License

Copyright (C) 2017 by Marijn Haverbeke <marijnh@gmail.com> and others

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
 */
      !function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.CodeMirror=t()}(this,function(){"use strict";function e(e){return new RegExp("(^|\\s)"+e+"(?:$|\\s)\\s*")}function t(e){for(var t=e.childNodes.length;t>0;--t)e.removeChild(e.firstChild);return e}function r(e,r){return t(e).appendChild(r)}function n(e,t,r,n){var i=document.createElement(e);if(r&&(i.className=r),n&&(i.style.cssText=n),"string"==typeof t)i.appendChild(document.createTextNode(t));else if(t)for(var o=0;o<t.length;++o)i.appendChild(t[o]);return i}function i(e,t,r,i){var o=n(e,t,r,i);return o.setAttribute("role","presentation"),o}function o(e,t){if(3==t.nodeType&&(t=t.parentNode),e.contains)return e.contains(t);do{if(11==t.nodeType&&(t=t.host),t==e)return!0}while(t=t.parentNode)}function l(){var e;try{e=document.activeElement}catch(t){e=document.body||null}for(;e&&e.shadowRoot&&e.shadowRoot.activeElement;)e=e.shadowRoot.activeElement;return e}function s(t,r){var n=t.className;e(r).test(n)||(t.className+=(n?" ":"")+r)}function a(t,r){for(var n=t.split(" "),i=0;i<n.length;i++)n[i]&&!e(n[i]).test(r)&&(r+=" "+n[i]);return r}function u(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t)}}function c(e,t,r){t||(t={});for(var n in e)!e.hasOwnProperty(n)||!1===r&&t.hasOwnProperty(n)||(t[n]=e[n]);return t}function f(e,t,r,n,i){null==t&&-1==(t=e.search(/[^\s\u00a0]/))&&(t=e.length);for(var o=n||0,l=i||0;;){var s=e.indexOf("\t",o);if(s<0||s>=t)return l+(t-o);l+=s-o,l+=r-l%r,o=s+1}}function h(e,t){for(var r=0;r<e.length;++r)if(e[r]==t)return r;return-1}function d(e,t,r){for(var n=0,i=0;;){var o=e.indexOf("\t",n);-1==o&&(o=e.length);var l=o-n;if(o==e.length||i+l>=t)return n+Math.min(l,t-i);if(i+=o-n,i+=r-i%r,n=o+1,i>=t)return n}}function p(e){for(;Kl.length<=e;)Kl.push(g(Kl)+" ");return Kl[e]}function g(e){return e[e.length-1]}function v(e,t){for(var r=[],n=0;n<e.length;n++)r[n]=t(e[n],n);return r}function m(e,t,r){for(var n=0,i=r(t);n<e.length&&r(e[n])<=i;)n++;e.splice(n,0,t)}function y(){}function b(e,t){var r;return Object.create?r=Object.create(e):(y.prototype=e,r=new y),t&&c(t,r),r}function w(e){return/\w/.test(e)||e>""&&(e.toUpperCase()!=e.toLowerCase()||jl.test(e))}function x(e,t){return t?!!(t.source.indexOf("\\w")>-1&&w(e))||t.test(e):w(e)}function C(e){for(var t in e)if(e.hasOwnProperty(t)&&e[t])return!1;return!0}function S(e){return e.charCodeAt(0)>=768&&Xl.test(e)}function L(e,t,r){for(;(r<0?t>0:t<e.length)&&S(e.charAt(t));)t+=r;return t}function k(e,t,r){for(var n=t>r?-1:1;;){if(t==r)return t;var i=(t+r)/2,o=n<0?Math.ceil(i):Math.floor(i);if(o==t)return e(o)?t:r;e(o)?r=o:t=o+n}}function T(e,t,r){var o=this;this.input=r,o.scrollbarFiller=n("div",null,"CodeMirror-scrollbar-filler"),o.scrollbarFiller.setAttribute("cm-not-content","true"),o.gutterFiller=n("div",null,"CodeMirror-gutter-filler"),o.gutterFiller.setAttribute("cm-not-content","true"),o.lineDiv=i("div",null,"CodeMirror-code"),o.selectionDiv=n("div",null,null,"position: relative; z-index: 1"),o.cursorDiv=n("div",null,"CodeMirror-cursors"),o.measure=n("div",null,"CodeMirror-measure"),o.lineMeasure=n("div",null,"CodeMirror-measure"),o.lineSpace=i("div",[o.measure,o.lineMeasure,o.selectionDiv,o.cursorDiv,o.lineDiv],null,"position: relative; outline: none");var l=i("div",[o.lineSpace],"CodeMirror-lines");o.mover=n("div",[l],null,"position: relative"),o.sizer=n("div",[o.mover],"CodeMirror-sizer"),o.sizerWidth=null,o.heightForcer=n("div",null,null,"position: absolute; height: "+Rl+"px; width: 1px;"),o.gutters=n("div",null,"CodeMirror-gutters"),o.lineGutter=null,o.scroller=n("div",[o.sizer,o.heightForcer,o.gutters],"CodeMirror-scroll"),o.scroller.setAttribute("tabIndex","-1"),o.wrapper=n("div",[o.scrollbarFiller,o.gutterFiller,o.scroller],"CodeMirror"),gl&&vl<8&&(o.gutters.style.zIndex=-1,o.scroller.style.paddingRight=0),ml||fl&&Tl||(o.scroller.draggable=!0),e&&(e.appendChild?e.appendChild(o.wrapper):e(o.wrapper)),o.viewFrom=o.viewTo=t.first,o.reportedViewFrom=o.reportedViewTo=t.first,o.view=[],o.renderedView=null,o.externalMeasured=null,o.viewOffset=0,o.lastWrapHeight=o.lastWrapWidth=0,o.updateLineNumbers=null,o.nativeBarWidth=o.barHeight=o.barWidth=0,o.scrollbarsClipped=!1,o.lineNumWidth=o.lineNumInnerWidth=o.lineNumChars=null,o.alignWidgets=!1,o.cachedCharWidth=o.cachedTextHeight=o.cachedPaddingH=null,o.maxLine=null,o.maxLineLength=0,o.maxLineChanged=!1,o.wheelDX=o.wheelDY=o.wheelStartX=o.wheelStartY=null,o.shift=!1,o.selForContextMenu=null,o.activeTouch=null,r.init(o)}function M(e,t){if((t-=e.first)<0||t>=e.size)throw new Error("There is no line "+(t+e.first)+" in the document.");for(var r=e;!r.lines;)for(var n=0;;++n){var i=r.children[n],o=i.chunkSize();if(t<o){r=i;break}t-=o}return r.lines[t]}function N(e,t,r){var n=[],i=t.line;return e.iter(t.line,r.line+1,function(e){var o=e.text;i==r.line&&(o=o.slice(0,r.ch)),i==t.line&&(o=o.slice(t.ch)),n.push(o),++i}),n}function O(e,t,r){var n=[];return e.iter(t,r,function(e){n.push(e.text)}),n}function A(e,t){var r=t-e.height;if(r)for(var n=e;n;n=n.parent)n.height+=r}function W(e){if(null==e.parent)return null;for(var t=e.parent,r=h(t.lines,e),n=t.parent;n;t=n,n=n.parent)for(var i=0;n.children[i]!=t;++i)r+=n.children[i].chunkSize();return r+t.first}function D(e,t){var r=e.first;e:do{for(var n=0;n<e.children.length;++n){var i=e.children[n],o=i.height;if(t<o){e=i;continue e}t-=o,r+=i.chunkSize()}return r}while(!e.lines);for(var l=0;l<e.lines.length;++l){var s=e.lines[l].height;if(t<s)break;t-=s}return r+l}function H(e,t){return t>=e.first&&t<e.first+e.size}function F(e,t){return String(e.lineNumberFormatter(t+e.firstLineNumber))}function E(e,t,r){if(void 0===r&&(r=null),!(this instanceof E))return new E(e,t,r);this.line=e,this.ch=t,this.sticky=r}function P(e,t){return e.line-t.line||e.ch-t.ch}function I(e,t){return e.sticky==t.sticky&&0==P(e,t)}function z(e){return E(e.line,e.ch)}function R(e,t){return P(e,t)<0?t:e}function B(e,t){return P(e,t)<0?e:t}function G(e,t){return Math.max(e.first,Math.min(t,e.first+e.size-1))}function U(e,t){if(t.line<e.first)return E(e.first,0);var r=e.first+e.size-1;return t.line>r?E(r,M(e,r).text.length):V(t,M(e,t.line).text.length)}function V(e,t){var r=e.ch;return null==r||r>t?E(e.line,t):r<0?E(e.line,0):e}function K(e,t){for(var r=[],n=0;n<t.length;n++)r[n]=U(e,t[n]);return r}function j(){Yl=!0}function X(){_l=!0}function Y(e,t,r){this.marker=e,this.from=t,this.to=r}function _(e,t){if(e)for(var r=0;r<e.length;++r){var n=e[r];if(n.marker==t)return n}}function $(e,t){for(var r,n=0;n<e.length;++n)e[n]!=t&&(r||(r=[])).push(e[n]);return r}function q(e,t){e.markedSpans=e.markedSpans?e.markedSpans.concat([t]):[t],t.marker.attachLine(e)}function Z(e,t,r){var n;if(e)for(var i=0;i<e.length;++i){var o=e[i],l=o.marker;if(null==o.from||(l.inclusiveLeft?o.from<=t:o.from<t)||o.from==t&&"bookmark"==l.type&&(!r||!o.marker.insertLeft)){var s=null==o.to||(l.inclusiveRight?o.to>=t:o.to>t);(n||(n=[])).push(new Y(l,o.from,s?null:o.to))}}return n}function Q(e,t,r){var n;if(e)for(var i=0;i<e.length;++i){var o=e[i],l=o.marker;if(null==o.to||(l.inclusiveRight?o.to>=t:o.to>t)||o.from==t&&"bookmark"==l.type&&(!r||o.marker.insertLeft)){var s=null==o.from||(l.inclusiveLeft?o.from<=t:o.from<t);(n||(n=[])).push(new Y(l,s?null:o.from-t,null==o.to?null:o.to-t))}}return n}function J(e,t){if(t.full)return null;var r=H(e,t.from.line)&&M(e,t.from.line).markedSpans,n=H(e,t.to.line)&&M(e,t.to.line).markedSpans;if(!r&&!n)return null;var i=t.from.ch,o=t.to.ch,l=0==P(t.from,t.to),s=Z(r,i,l),a=Q(n,o,l),u=1==t.text.length,c=g(t.text).length+(u?i:0);if(s)for(var f=0;f<s.length;++f){var h=s[f];if(null==h.to){var d=_(a,h.marker);d?u&&(h.to=null==d.to?null:d.to+c):h.to=i}}if(a)for(var p=0;p<a.length;++p){var v=a[p];null!=v.to&&(v.to+=c),null==v.from?_(s,v.marker)||(v.from=c,u&&(s||(s=[])).push(v)):(v.from+=c,u&&(s||(s=[])).push(v))}s&&(s=ee(s)),a&&a!=s&&(a=ee(a));var m=[s];if(!u){var y,b=t.text.length-2;if(b>0&&s)for(var w=0;w<s.length;++w)null==s[w].to&&(y||(y=[])).push(new Y(s[w].marker,null,null));for(var x=0;x<b;++x)m.push(y);m.push(a)}return m}function ee(e){for(var t=0;t<e.length;++t){var r=e[t];null!=r.from&&r.from==r.to&&!1!==r.marker.clearWhenEmpty&&e.splice(t--,1)}return e.length?e:null}function te(e,t,r){var n=null;if(e.iter(t.line,r.line+1,function(e){if(e.markedSpans)for(var t=0;t<e.markedSpans.length;++t){var r=e.markedSpans[t].marker;!r.readOnly||n&&-1!=h(n,r)||(n||(n=[])).push(r)}}),!n)return null;for(var i=[{from:t,to:r}],o=0;o<n.length;++o)for(var l=n[o],s=l.find(0),a=0;a<i.length;++a){var u=i[a];if(!(P(u.to,s.from)<0||P(u.from,s.to)>0)){var c=[a,1],f=P(u.from,s.from),d=P(u.to,s.to);(f<0||!l.inclusiveLeft&&!f)&&c.push({from:u.from,to:s.from}),(d>0||!l.inclusiveRight&&!d)&&c.push({from:s.to,to:u.to}),i.splice.apply(i,c),a+=c.length-3}}return i}function re(e){var t=e.markedSpans;if(t){for(var r=0;r<t.length;++r)t[r].marker.detachLine(e);e.markedSpans=null}}function ne(e,t){if(t){for(var r=0;r<t.length;++r)t[r].marker.attachLine(e);e.markedSpans=t}}function ie(e){return e.inclusiveLeft?-1:0}function oe(e){return e.inclusiveRight?1:0}function le(e,t){var r=e.lines.length-t.lines.length;if(0!=r)return r;var n=e.find(),i=t.find(),o=P(n.from,i.from)||ie(e)-ie(t);if(o)return-o;var l=P(n.to,i.to)||oe(e)-oe(t);return l||t.id-e.id}function se(e,t){var r,n=_l&&e.markedSpans;if(n)for(var i=void 0,o=0;o<n.length;++o)(i=n[o]).marker.collapsed&&null==(t?i.from:i.to)&&(!r||le(r,i.marker)<0)&&(r=i.marker);return r}function ae(e){return se(e,!0)}function ue(e){return se(e,!1)}function ce(e,t,r,n,i){var o=M(e,t),l=_l&&o.markedSpans;if(l)for(var s=0;s<l.length;++s){var a=l[s];if(a.marker.collapsed){var u=a.marker.find(0),c=P(u.from,r)||ie(a.marker)-ie(i),f=P(u.to,n)||oe(a.marker)-oe(i);if(!(c>=0&&f<=0||c<=0&&f>=0)&&(c<=0&&(a.marker.inclusiveRight&&i.inclusiveLeft?P(u.to,r)>=0:P(u.to,r)>0)||c>=0&&(a.marker.inclusiveRight&&i.inclusiveLeft?P(u.from,n)<=0:P(u.from,n)<0)))return!0}}}function fe(e){for(var t;t=ae(e);)e=t.find(-1,!0).line;return e}function he(e){for(var t;t=ue(e);)e=t.find(1,!0).line;return e}function de(e){for(var t,r;t=ue(e);)e=t.find(1,!0).line,(r||(r=[])).push(e);return r}function pe(e,t){var r=M(e,t),n=fe(r);return r==n?t:W(n)}function ge(e,t){if(t>e.lastLine())return t;var r,n=M(e,t);if(!ve(e,n))return t;for(;r=ue(n);)n=r.find(1,!0).line;return W(n)+1}function ve(e,t){var r=_l&&t.markedSpans;if(r)for(var n=void 0,i=0;i<r.length;++i)if((n=r[i]).marker.collapsed){if(null==n.from)return!0;if(!n.marker.widgetNode&&0==n.from&&n.marker.inclusiveLeft&&me(e,t,n))return!0}}function me(e,t,r){if(null==r.to){var n=r.marker.find(1,!0);return me(e,n.line,_(n.line.markedSpans,r.marker))}if(r.marker.inclusiveRight&&r.to==t.text.length)return!0;for(var i=void 0,o=0;o<t.markedSpans.length;++o)if((i=t.markedSpans[o]).marker.collapsed&&!i.marker.widgetNode&&i.from==r.to&&(null==i.to||i.to!=r.from)&&(i.marker.inclusiveLeft||r.marker.inclusiveRight)&&me(e,t,i))return!0}function ye(e){for(var t=0,r=(e=fe(e)).parent,n=0;n<r.lines.length;++n){var i=r.lines[n];if(i==e)break;t+=i.height}for(var o=r.parent;o;r=o,o=r.parent)for(var l=0;l<o.children.length;++l){var s=o.children[l];if(s==r)break;t+=s.height}return t}function be(e){if(0==e.height)return 0;for(var t,r=e.text.length,n=e;t=ae(n);){var i=t.find(0,!0);n=i.from.line,r+=i.from.ch-i.to.ch}for(n=e;t=ue(n);){var o=t.find(0,!0);r-=n.text.length-o.from.ch,r+=(n=o.to.line).text.length-o.to.ch}return r}function we(e){var t=e.display,r=e.doc;t.maxLine=M(r,r.first),t.maxLineLength=be(t.maxLine),t.maxLineChanged=!0,r.iter(function(e){var r=be(e);r>t.maxLineLength&&(t.maxLineLength=r,t.maxLine=e)})}function xe(e,t,r,n){if(!e)return n(t,r,"ltr",0);for(var i=!1,o=0;o<e.length;++o){var l=e[o];(l.from<r&&l.to>t||t==r&&l.to==t)&&(n(Math.max(l.from,t),Math.min(l.to,r),1==l.level?"rtl":"ltr",o),i=!0)}i||n(t,r,"ltr")}function Ce(e,t,r){var n;$l=null;for(var i=0;i<e.length;++i){var o=e[i];if(o.from<t&&o.to>t)return i;o.to==t&&(o.from!=o.to&&"before"==r?n=i:$l=i),o.from==t&&(o.from!=o.to&&"before"!=r?n=i:$l=i)}return null!=n?n:$l}function Se(e,t){var r=e.order;return null==r&&(r=e.order=ql(e.text,t)),r}function Le(e,t){return e._handlers&&e._handlers[t]||Zl}function ke(e,t,r){if(e.removeEventListener)e.removeEventListener(t,r,!1);else if(e.detachEvent)e.detachEvent("on"+t,r);else{var n=e._handlers,i=n&&n[t];if(i){var o=h(i,r);o>-1&&(n[t]=i.slice(0,o).concat(i.slice(o+1)))}}}function Te(e,t){var r=Le(e,t);if(r.length)for(var n=Array.prototype.slice.call(arguments,2),i=0;i<r.length;++i)r[i].apply(null,n)}function Me(e,t,r){return"string"==typeof t&&(t={type:t,preventDefault:function(){this.defaultPrevented=!0}}),Te(e,r||t.type,e,t),He(t)||t.codemirrorIgnore}function Ne(e){var t=e._handlers&&e._handlers.cursorActivity;if(t)for(var r=e.curOp.cursorActivityHandlers||(e.curOp.cursorActivityHandlers=[]),n=0;n<t.length;++n)-1==h(r,t[n])&&r.push(t[n])}function Oe(e,t){return Le(e,t).length>0}function Ae(e){e.prototype.on=function(e,t){Ql(this,e,t)},e.prototype.off=function(e,t){ke(this,e,t)}}function We(e){e.preventDefault?e.preventDefault():e.returnValue=!1}function De(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}function He(e){return null!=e.defaultPrevented?e.defaultPrevented:0==e.returnValue}function Fe(e){We(e),De(e)}function Ee(e){return e.target||e.srcElement}function Pe(e){var t=e.which;return null==t&&(1&e.button?t=1:2&e.button?t=3:4&e.button&&(t=2)),Ml&&e.ctrlKey&&1==t&&(t=3),t}function Ie(e){if(null==Il){var t=n("span","​");r(e,n("span",[t,document.createTextNode("x")])),0!=e.firstChild.offsetHeight&&(Il=t.offsetWidth<=1&&t.offsetHeight>2&&!(gl&&vl<8))}var i=Il?n("span","​"):n("span"," ",null,"display: inline-block; width: 1px; margin-right: -1px");return i.setAttribute("cm-text",""),i}function ze(e){if(null!=zl)return zl;var n=r(e,document.createTextNode("AخA")),i=Wl(n,0,1).getBoundingClientRect(),o=Wl(n,1,2).getBoundingClientRect();return t(e),!(!i||i.left==i.right)&&(zl=o.right-i.right<3)}function Re(e){if(null!=ns)return ns;var t=r(e,n("span","x")),i=t.getBoundingClientRect(),o=Wl(t,0,1).getBoundingClientRect();return ns=Math.abs(i.left-o.left)>1}function Be(e,t){arguments.length>2&&(t.dependencies=Array.prototype.slice.call(arguments,2)),is[e]=t}function Ge(e){if("string"==typeof e&&os.hasOwnProperty(e))e=os[e];else if(e&&"string"==typeof e.name&&os.hasOwnProperty(e.name)){var t=os[e.name];"string"==typeof t&&(t={name:t}),(e=b(t,e)).name=t.name}else{if("string"==typeof e&&/^[\w\-]+\/[\w\-]+\+xml$/.test(e))return Ge("application/xml");if("string"==typeof e&&/^[\w\-]+\/[\w\-]+\+json$/.test(e))return Ge("application/json")}return"string"==typeof e?{name:e}:e||{name:"null"}}function Ue(e,t){t=Ge(t);var r=is[t.name];if(!r)return Ue(e,"text/plain");var n=r(e,t);if(ls.hasOwnProperty(t.name)){var i=ls[t.name];for(var o in i)i.hasOwnProperty(o)&&(n.hasOwnProperty(o)&&(n["_"+o]=n[o]),n[o]=i[o])}if(n.name=t.name,t.helperType&&(n.helperType=t.helperType),t.modeProps)for(var l in t.modeProps)n[l]=t.modeProps[l];return n}function Ve(e,t){c(t,ls.hasOwnProperty(e)?ls[e]:ls[e]={})}function Ke(e,t){if(!0===t)return t;if(e.copyState)return e.copyState(t);var r={};for(var n in t){var i=t[n];i instanceof Array&&(i=i.concat([])),r[n]=i}return r}function je(e,t){for(var r;e.innerMode&&(r=e.innerMode(t))&&r.mode!=e;)t=r.state,e=r.mode;return r||{mode:e,state:t}}function Xe(e,t,r){return!e.startState||e.startState(t,r)}function Ye(e,t,r,n){var i=[e.state.modeGen],o={};tt(e,t.text,e.doc.mode,r,function(e,t){return i.push(e,t)},o,n);for(var l=r.state,s=0;s<e.state.overlays.length;++s)!function(n){var l=e.state.overlays[n],s=1,a=0;r.state=!0,tt(e,t.text,l.mode,r,function(e,t){for(var r=s;a<e;){var n=i[s];n>e&&i.splice(s,1,e,i[s+1],n),s+=2,a=Math.min(e,n)}if(t)if(l.opaque)i.splice(r,s-r,e,"overlay "+t),s=r+2;else for(;r<s;r+=2){var o=i[r+1];i[r+1]=(o?o+" ":"")+"overlay "+t}},o)}(s);return r.state=l,{styles:i,classes:o.bgClass||o.textClass?o:null}}function _e(e,t,r){if(!t.styles||t.styles[0]!=e.state.modeGen){var n=$e(e,W(t)),i=t.text.length>e.options.maxHighlightLength&&Ke(e.doc.mode,n.state),o=Ye(e,t,n);i&&(n.state=i),t.stateAfter=n.save(!i),t.styles=o.styles,o.classes?t.styleClasses=o.classes:t.styleClasses&&(t.styleClasses=null),r===e.doc.highlightFrontier&&(e.doc.modeFrontier=Math.max(e.doc.modeFrontier,++e.doc.highlightFrontier))}return t.styles}function $e(e,t,r){var n=e.doc,i=e.display;if(!n.mode.startState)return new us(n,!0,t);var o=rt(e,t,r),l=o>n.first&&M(n,o-1).stateAfter,s=l?us.fromSaved(n,l,o):new us(n,Xe(n.mode),o);return n.iter(o,t,function(r){qe(e,r.text,s);var n=s.line;r.stateAfter=n==t-1||n%5==0||n>=i.viewFrom&&n<i.viewTo?s.save():null,s.nextLine()}),r&&(n.modeFrontier=s.line),s}function qe(e,t,r,n){var i=e.doc.mode,o=new ss(t,e.options.tabSize,r);for(o.start=o.pos=n||0,""==t&&Ze(i,r.state);!o.eol();)Qe(i,o,r.state),o.start=o.pos}function Ze(e,t){if(e.blankLine)return e.blankLine(t);if(e.innerMode){var r=je(e,t);return r.mode.blankLine?r.mode.blankLine(r.state):void 0}}function Qe(e,t,r,n){for(var i=0;i<10;i++){n&&(n[0]=je(e,r).mode);var o=e.token(t,r);if(t.pos>t.start)return o}throw new Error("Mode "+e.name+" failed to advance stream.")}function Je(e,t,r,n){var i,o,l=e.doc,s=l.mode,a=M(l,(t=U(l,t)).line),u=$e(e,t.line,r),c=new ss(a.text,e.options.tabSize,u);for(n&&(o=[]);(n||c.pos<t.ch)&&!c.eol();)c.start=c.pos,i=Qe(s,c,u.state),n&&o.push(new cs(c,i,Ke(l.mode,u.state)));return n?o:new cs(c,i,u.state)}function et(e,t){if(e)for(;;){var r=e.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!r)break;e=e.slice(0,r.index)+e.slice(r.index+r[0].length);var n=r[1]?"bgClass":"textClass";null==t[n]?t[n]=r[2]:new RegExp("(?:^|s)"+r[2]+"(?:$|s)").test(t[n])||(t[n]+=" "+r[2])}return e}function tt(e,t,r,n,i,o,l){var s=r.flattenSpans;null==s&&(s=e.options.flattenSpans);var a,u=0,c=null,f=new ss(t,e.options.tabSize,n),h=e.options.addModeClass&&[null];for(""==t&&et(Ze(r,n.state),o);!f.eol();){if(f.pos>e.options.maxHighlightLength?(s=!1,l&&qe(e,t,n,f.pos),f.pos=t.length,a=null):a=et(Qe(r,f,n.state,h),o),h){var d=h[0].name;d&&(a="m-"+(a?d+" "+a:d))}if(!s||c!=a){for(;u<f.start;)i(u=Math.min(f.start,u+5e3),c);c=a}f.start=f.pos}for(;u<f.pos;){var p=Math.min(f.pos,u+5e3);i(p,c),u=p}}function rt(e,t,r){for(var n,i,o=e.doc,l=r?-1:t-(e.doc.mode.innerMode?1e3:100),s=t;s>l;--s){if(s<=o.first)return o.first;var a=M(o,s-1),u=a.stateAfter;if(u&&(!r||s+(u instanceof as?u.lookAhead:0)<=o.modeFrontier))return s;var c=f(a.text,null,e.options.tabSize);(null==i||n>c)&&(i=s-1,n=c)}return i}function nt(e,t){if(e.modeFrontier=Math.min(e.modeFrontier,t),!(e.highlightFrontier<t-10)){for(var r=e.first,n=t-1;n>r;n--){var i=M(e,n).stateAfter;if(i&&(!(i instanceof as)||n+i.lookAhead<t)){r=n+1;break}}e.highlightFrontier=Math.min(e.highlightFrontier,r)}}function it(e,t,r,n){e.text=t,e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null),null!=e.order&&(e.order=null),re(e),ne(e,r);var i=n?n(e):1;i!=e.height&&A(e,i)}function ot(e){e.parent=null,re(e)}function lt(e,t){if(!e||/^\s*$/.test(e))return null;var r=t.addModeClass?ps:ds;return r[e]||(r[e]=e.replace(/\S+/g,"cm-$&"))}function st(e,t){var r=i("span",null,null,ml?"padding-right: .1px":null),n={pre:i("pre",[r],"CodeMirror-line"),content:r,col:0,pos:0,cm:e,trailingSpace:!1,splitSpaces:(gl||ml)&&e.getOption("lineWrapping")};t.measure={};for(var o=0;o<=(t.rest?t.rest.length:0);o++){var l=o?t.rest[o-1]:t.line,s=void 0;n.pos=0,n.addToken=ut,ze(e.display.measure)&&(s=Se(l,e.doc.direction))&&(n.addToken=ft(n.addToken,s)),n.map=[],dt(l,n,_e(e,l,t!=e.display.externalMeasured&&W(l))),l.styleClasses&&(l.styleClasses.bgClass&&(n.bgClass=a(l.styleClasses.bgClass,n.bgClass||"")),l.styleClasses.textClass&&(n.textClass=a(l.styleClasses.textClass,n.textClass||""))),0==n.map.length&&n.map.push(0,0,n.content.appendChild(Ie(e.display.measure))),0==o?(t.measure.map=n.map,t.measure.cache={}):((t.measure.maps||(t.measure.maps=[])).push(n.map),(t.measure.caches||(t.measure.caches=[])).push({}))}if(ml){var u=n.content.lastChild;(/\bcm-tab\b/.test(u.className)||u.querySelector&&u.querySelector(".cm-tab"))&&(n.content.className="cm-tab-wrap-hack")}return Te(e,"renderLine",e,t.line,n.pre),n.pre.className&&(n.textClass=a(n.pre.className,n.textClass||"")),n}function at(e){var t=n("span","•","cm-invalidchar");return t.title="\\u"+e.charCodeAt(0).toString(16),t.setAttribute("aria-label",t.title),t}function ut(e,t,r,i,o,l,s){if(t){var a,u=e.splitSpaces?ct(t,e.trailingSpace):t,c=e.cm.state.specialChars,f=!1;if(c.test(t)){a=document.createDocumentFragment();for(var h=0;;){c.lastIndex=h;var d=c.exec(t),g=d?d.index-h:t.length-h;if(g){var v=document.createTextNode(u.slice(h,h+g));gl&&vl<9?a.appendChild(n("span",[v])):a.appendChild(v),e.map.push(e.pos,e.pos+g,v),e.col+=g,e.pos+=g}if(!d)break;h+=g+1;var m=void 0;if("\t"==d[0]){var y=e.cm.options.tabSize,b=y-e.col%y;(m=a.appendChild(n("span",p(b),"cm-tab"))).setAttribute("role","presentation"),m.setAttribute("cm-text","\t"),e.col+=b}else"\r"==d[0]||"\n"==d[0]?((m=a.appendChild(n("span","\r"==d[0]?"␍":"␤","cm-invalidchar"))).setAttribute("cm-text",d[0]),e.col+=1):((m=e.cm.options.specialCharPlaceholder(d[0])).setAttribute("cm-text",d[0]),gl&&vl<9?a.appendChild(n("span",[m])):a.appendChild(m),e.col+=1);e.map.push(e.pos,e.pos+1,m),e.pos++}}else e.col+=t.length,a=document.createTextNode(u),e.map.push(e.pos,e.pos+t.length,a),gl&&vl<9&&(f=!0),e.pos+=t.length;if(e.trailingSpace=32==u.charCodeAt(t.length-1),r||i||o||f||s){var w=r||"";i&&(w+=i),o&&(w+=o);var x=n("span",[a],w,s);return l&&(x.title=l),e.content.appendChild(x)}e.content.appendChild(a)}}function ct(e,t){if(e.length>1&&!/  /.test(e))return e;for(var r=t,n="",i=0;i<e.length;i++){var o=e.charAt(i);" "!=o||!r||i!=e.length-1&&32!=e.charCodeAt(i+1)||(o=" "),n+=o,r=" "==o}return n}function ft(e,t){return function(r,n,i,o,l,s,a){i=i?i+" cm-force-border":"cm-force-border";for(var u=r.pos,c=u+n.length;;){for(var f=void 0,h=0;h<t.length&&!((f=t[h]).to>u&&f.from<=u);h++);if(f.to>=c)return e(r,n,i,o,l,s,a);e(r,n.slice(0,f.to-u),i,o,null,s,a),o=null,n=n.slice(f.to-u),u=f.to}}}function ht(e,t,r,n){var i=!n&&r.widgetNode;i&&e.map.push(e.pos,e.pos+t,i),!n&&e.cm.display.input.needsContentAttribute&&(i||(i=e.content.appendChild(document.createElement("span"))),i.setAttribute("cm-marker",r.id)),i&&(e.cm.display.input.setUneditable(i),e.content.appendChild(i)),e.pos+=t,e.trailingSpace=!1}function dt(e,t,r){var n=e.markedSpans,i=e.text,o=0;if(n)for(var l,s,a,u,c,f,h,d=i.length,p=0,g=1,v="",m=0;;){if(m==p){a=u=c=f=s="",h=null,m=1/0;for(var y=[],b=void 0,w=0;w<n.length;++w){var x=n[w],C=x.marker;"bookmark"==C.type&&x.from==p&&C.widgetNode?y.push(C):x.from<=p&&(null==x.to||x.to>p||C.collapsed&&x.to==p&&x.from==p)?(null!=x.to&&x.to!=p&&m>x.to&&(m=x.to,u=""),C.className&&(a+=" "+C.className),C.css&&(s=(s?s+";":"")+C.css),C.startStyle&&x.from==p&&(c+=" "+C.startStyle),C.endStyle&&x.to==m&&(b||(b=[])).push(C.endStyle,x.to),C.title&&!f&&(f=C.title),C.collapsed&&(!h||le(h.marker,C)<0)&&(h=x)):x.from>p&&m>x.from&&(m=x.from)}if(b)for(var S=0;S<b.length;S+=2)b[S+1]==m&&(u+=" "+b[S]);if(!h||h.from==p)for(var L=0;L<y.length;++L)ht(t,0,y[L]);if(h&&(h.from||0)==p){if(ht(t,(null==h.to?d+1:h.to)-p,h.marker,null==h.from),null==h.to)return;h.to==p&&(h=!1)}}if(p>=d)break;for(var k=Math.min(d,m);;){if(v){var T=p+v.length;if(!h){var M=T>k?v.slice(0,k-p):v;t.addToken(t,M,l?l+a:a,c,p+M.length==m?u:"",f,s)}if(T>=k){v=v.slice(k-p),p=k;break}p=T,c=""}v=i.slice(o,o=r[g++]),l=lt(r[g++],t.cm.options)}}else for(var N=1;N<r.length;N+=2)t.addToken(t,i.slice(o,o=r[N]),lt(r[N+1],t.cm.options))}function pt(e,t,r){this.line=t,this.rest=de(t),this.size=this.rest?W(g(this.rest))-r+1:1,this.node=this.text=null,this.hidden=ve(e,t)}function gt(e,t,r){for(var n,i=[],o=t;o<r;o=n){var l=new pt(e.doc,M(e.doc,o),o);n=o+l.size,i.push(l)}return i}function vt(e){gs?gs.ops.push(e):e.ownsGroup=gs={ops:[e],delayedCallbacks:[]}}function mt(e){var t=e.delayedCallbacks,r=0;do{for(;r<t.length;r++)t[r].call(null);for(var n=0;n<e.ops.length;n++){var i=e.ops[n];if(i.cursorActivityHandlers)for(;i.cursorActivityCalled<i.cursorActivityHandlers.length;)i.cursorActivityHandlers[i.cursorActivityCalled++].call(null,i.cm)}}while(r<t.length)}function yt(e,t){var r=e.ownsGroup;if(r)try{mt(r)}finally{gs=null,t(r)}}function bt(e,t){var r=Le(e,t);if(r.length){var n,i=Array.prototype.slice.call(arguments,2);gs?n=gs.delayedCallbacks:vs?n=vs:(n=vs=[],setTimeout(wt,0));for(var o=0;o<r.length;++o)!function(e){n.push(function(){return r[e].apply(null,i)})}(o)}}function wt(){var e=vs;vs=null;for(var t=0;t<e.length;++t)e[t]()}function xt(e,t,r,n){for(var i=0;i<t.changes.length;i++){var o=t.changes[i];"text"==o?kt(e,t):"gutter"==o?Mt(e,t,r,n):"class"==o?Tt(e,t):"widget"==o&&Nt(e,t,n)}t.changes=null}function Ct(e){return e.node==e.text&&(e.node=n("div",null,null,"position: relative"),e.text.parentNode&&e.text.parentNode.replaceChild(e.node,e.text),e.node.appendChild(e.text),gl&&vl<8&&(e.node.style.zIndex=2)),e.node}function St(e,t){var r=t.bgClass?t.bgClass+" "+(t.line.bgClass||""):t.line.bgClass;if(r&&(r+=" CodeMirror-linebackground"),t.background)r?t.background.className=r:(t.background.parentNode.removeChild(t.background),t.background=null);else if(r){var i=Ct(t);t.background=i.insertBefore(n("div",null,r),i.firstChild),e.display.input.setUneditable(t.background)}}function Lt(e,t){var r=e.display.externalMeasured;return r&&r.line==t.line?(e.display.externalMeasured=null,t.measure=r.measure,r.built):st(e,t)}function kt(e,t){var r=t.text.className,n=Lt(e,t);t.text==t.node&&(t.node=n.pre),t.text.parentNode.replaceChild(n.pre,t.text),t.text=n.pre,n.bgClass!=t.bgClass||n.textClass!=t.textClass?(t.bgClass=n.bgClass,t.textClass=n.textClass,Tt(e,t)):r&&(t.text.className=r)}function Tt(e,t){St(e,t),t.line.wrapClass?Ct(t).className=t.line.wrapClass:t.node!=t.text&&(t.node.className="");var r=t.textClass?t.textClass+" "+(t.line.textClass||""):t.line.textClass;t.text.className=r||""}function Mt(e,t,r,i){if(t.gutter&&(t.node.removeChild(t.gutter),t.gutter=null),t.gutterBackground&&(t.node.removeChild(t.gutterBackground),t.gutterBackground=null),t.line.gutterClass){var o=Ct(t);t.gutterBackground=n("div",null,"CodeMirror-gutter-background "+t.line.gutterClass,"left: "+(e.options.fixedGutter?i.fixedPos:-i.gutterTotalWidth)+"px; width: "+i.gutterTotalWidth+"px"),e.display.input.setUneditable(t.gutterBackground),o.insertBefore(t.gutterBackground,t.text)}var l=t.line.gutterMarkers;if(e.options.lineNumbers||l){var s=Ct(t),a=t.gutter=n("div",null,"CodeMirror-gutter-wrapper","left: "+(e.options.fixedGutter?i.fixedPos:-i.gutterTotalWidth)+"px");if(e.display.input.setUneditable(a),s.insertBefore(a,t.text),t.line.gutterClass&&(a.className+=" "+t.line.gutterClass),!e.options.lineNumbers||l&&l["CodeMirror-linenumbers"]||(t.lineNumber=a.appendChild(n("div",F(e.options,r),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+i.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+e.display.lineNumInnerWidth+"px"))),l)for(var u=0;u<e.options.gutters.length;++u){var c=e.options.gutters[u],f=l.hasOwnProperty(c)&&l[c];f&&a.appendChild(n("div",[f],"CodeMirror-gutter-elt","left: "+i.gutterLeft[c]+"px; width: "+i.gutterWidth[c]+"px"))}}}function Nt(e,t,r){t.alignable&&(t.alignable=null);for(var n=t.node.firstChild,i=void 0;n;n=i)i=n.nextSibling,"CodeMirror-linewidget"==n.className&&t.node.removeChild(n);At(e,t,r)}function Ot(e,t,r,n){var i=Lt(e,t);return t.text=t.node=i.pre,i.bgClass&&(t.bgClass=i.bgClass),i.textClass&&(t.textClass=i.textClass),Tt(e,t),Mt(e,t,r,n),At(e,t,n),t.node}function At(e,t,r){if(Wt(e,t.line,t,r,!0),t.rest)for(var n=0;n<t.rest.length;n++)Wt(e,t.rest[n],t,r,!1)}function Wt(e,t,r,i,o){if(t.widgets)for(var l=Ct(r),s=0,a=t.widgets;s<a.length;++s){var u=a[s],c=n("div",[u.node],"CodeMirror-linewidget");u.handleMouseEvents||c.setAttribute("cm-ignore-events","true"),Dt(u,c,r,i),e.display.input.setUneditable(c),o&&u.above?l.insertBefore(c,r.gutter||r.text):l.appendChild(c),bt(u,"redraw")}}function Dt(e,t,r,n){if(e.noHScroll){(r.alignable||(r.alignable=[])).push(t);var i=n.wrapperWidth;t.style.left=n.fixedPos+"px",e.coverGutter||(i-=n.gutterTotalWidth,t.style.paddingLeft=n.gutterTotalWidth+"px"),t.style.width=i+"px"}e.coverGutter&&(t.style.zIndex=5,t.style.position="relative",e.noHScroll||(t.style.marginLeft=-n.gutterTotalWidth+"px"))}function Ht(e){if(null!=e.height)return e.height;var t=e.doc.cm;if(!t)return 0;if(!o(document.body,e.node)){var i="position: relative;";e.coverGutter&&(i+="margin-left: -"+t.display.gutters.offsetWidth+"px;"),e.noHScroll&&(i+="width: "+t.display.wrapper.clientWidth+"px;"),r(t.display.measure,n("div",[e.node],null,i))}return e.height=e.node.parentNode.offsetHeight}function Ft(e,t){for(var r=Ee(t);r!=e.wrapper;r=r.parentNode)if(!r||1==r.nodeType&&"true"==r.getAttribute("cm-ignore-events")||r.parentNode==e.sizer&&r!=e.mover)return!0}function Et(e){return e.lineSpace.offsetTop}function Pt(e){return e.mover.offsetHeight-e.lineSpace.offsetHeight}function It(e){if(e.cachedPaddingH)return e.cachedPaddingH;var t=r(e.measure,n("pre","x")),i=window.getComputedStyle?window.getComputedStyle(t):t.currentStyle,o={left:parseInt(i.paddingLeft),right:parseInt(i.paddingRight)};return isNaN(o.left)||isNaN(o.right)||(e.cachedPaddingH=o),o}function zt(e){return Rl-e.display.nativeBarWidth}function Rt(e){return e.display.scroller.clientWidth-zt(e)-e.display.barWidth}function Bt(e){return e.display.scroller.clientHeight-zt(e)-e.display.barHeight}function Gt(e,t,r){var n=e.options.lineWrapping,i=n&&Rt(e);if(!t.measure.heights||n&&t.measure.width!=i){var o=t.measure.heights=[];if(n){t.measure.width=i;for(var l=t.text.firstChild.getClientRects(),s=0;s<l.length-1;s++){var a=l[s],u=l[s+1];Math.abs(a.bottom-u.bottom)>2&&o.push((a.bottom+u.top)/2-r.top)}}o.push(r.bottom-r.top)}}function Ut(e,t,r){if(e.line==t)return{map:e.measure.map,cache:e.measure.cache};for(var n=0;n<e.rest.length;n++)if(e.rest[n]==t)return{map:e.measure.maps[n],cache:e.measure.caches[n]};for(var i=0;i<e.rest.length;i++)if(W(e.rest[i])>r)return{map:e.measure.maps[i],cache:e.measure.caches[i],before:!0}}function Vt(e,t){var n=W(t=fe(t)),i=e.display.externalMeasured=new pt(e.doc,t,n);i.lineN=n;var o=i.built=st(e,i);return i.text=o.pre,r(e.display.lineMeasure,o.pre),i}function Kt(e,t,r,n){return Yt(e,Xt(e,t),r,n)}function jt(e,t){if(t>=e.display.viewFrom&&t<e.display.viewTo)return e.display.view[Lr(e,t)];var r=e.display.externalMeasured;return r&&t>=r.lineN&&t<r.lineN+r.size?r:void 0}function Xt(e,t){var r=W(t),n=jt(e,r);n&&!n.text?n=null:n&&n.changes&&(xt(e,n,r,br(e)),e.curOp.forceUpdate=!0),n||(n=Vt(e,t));var i=Ut(n,t,r);return{line:t,view:n,rect:null,map:i.map,cache:i.cache,before:i.before,hasHeights:!1}}function Yt(e,t,r,n,i){t.before&&(r=-1);var o,l=r+(n||"");return t.cache.hasOwnProperty(l)?o=t.cache[l]:(t.rect||(t.rect=t.view.text.getBoundingClientRect()),t.hasHeights||(Gt(e,t.view,t.rect),t.hasHeights=!0),(o=qt(e,t,r,n)).bogus||(t.cache[l]=o)),{left:o.left,right:o.right,top:i?o.rtop:o.top,bottom:i?o.rbottom:o.bottom}}function _t(e,t,r){for(var n,i,o,l,s,a,u=0;u<e.length;u+=3)if(s=e[u],a=e[u+1],t<s?(i=0,o=1,l="left"):t<a?o=(i=t-s)+1:(u==e.length-3||t==a&&e[u+3]>t)&&(i=(o=a-s)-1,t>=a&&(l="right")),null!=i){if(n=e[u+2],s==a&&r==(n.insertLeft?"left":"right")&&(l=r),"left"==r&&0==i)for(;u&&e[u-2]==e[u-3]&&e[u-1].insertLeft;)n=e[2+(u-=3)],l="left";if("right"==r&&i==a-s)for(;u<e.length-3&&e[u+3]==e[u+4]&&!e[u+5].insertLeft;)n=e[(u+=3)+2],l="right";break}return{node:n,start:i,end:o,collapse:l,coverStart:s,coverEnd:a}}function $t(e,t){var r=ms;if("left"==t)for(var n=0;n<e.length&&(r=e[n]).left==r.right;n++);else for(var i=e.length-1;i>=0&&(r=e[i]).left==r.right;i--);return r}function qt(e,t,r,n){var i,o=_t(t.map,r,n),l=o.node,s=o.start,a=o.end,u=o.collapse;if(3==l.nodeType){for(var c=0;c<4;c++){for(;s&&S(t.line.text.charAt(o.coverStart+s));)--s;for(;o.coverStart+a<o.coverEnd&&S(t.line.text.charAt(o.coverStart+a));)++a;if((i=gl&&vl<9&&0==s&&a==o.coverEnd-o.coverStart?l.parentNode.getBoundingClientRect():$t(Wl(l,s,a).getClientRects(),n)).left||i.right||0==s)break;a=s,s-=1,u="right"}gl&&vl<11&&(i=Zt(e.display.measure,i))}else{s>0&&(u=n="right");var f;i=e.options.lineWrapping&&(f=l.getClientRects()).length>1?f["right"==n?f.length-1:0]:l.getBoundingClientRect()}if(gl&&vl<9&&!s&&(!i||!i.left&&!i.right)){var h=l.parentNode.getClientRects()[0];i=h?{left:h.left,right:h.left+yr(e.display),top:h.top,bottom:h.bottom}:ms}for(var d=i.top-t.rect.top,p=i.bottom-t.rect.top,g=(d+p)/2,v=t.view.measure.heights,m=0;m<v.length-1&&!(g<v[m]);m++);var y=m?v[m-1]:0,b=v[m],w={left:("right"==u?i.right:i.left)-t.rect.left,right:("left"==u?i.left:i.right)-t.rect.left,top:y,bottom:b};return i.left||i.right||(w.bogus=!0),e.options.singleCursorHeightPerLine||(w.rtop=d,w.rbottom=p),w}function Zt(e,t){if(!window.screen||null==screen.logicalXDPI||screen.logicalXDPI==screen.deviceXDPI||!Re(e))return t;var r=screen.logicalXDPI/screen.deviceXDPI,n=screen.logicalYDPI/screen.deviceYDPI;return{left:t.left*r,right:t.right*r,top:t.top*n,bottom:t.bottom*n}}function Qt(e){if(e.measure&&(e.measure.cache={},e.measure.heights=null,e.rest))for(var t=0;t<e.rest.length;t++)e.measure.caches[t]={}}function Jt(e){e.display.externalMeasure=null,t(e.display.lineMeasure);for(var r=0;r<e.display.view.length;r++)Qt(e.display.view[r])}function er(e){Jt(e),e.display.cachedCharWidth=e.display.cachedTextHeight=e.display.cachedPaddingH=null,e.options.lineWrapping||(e.display.maxLineChanged=!0),e.display.lineNumChars=null}function tr(){return bl&&kl?-(document.body.getBoundingClientRect().left-parseInt(getComputedStyle(document.body).marginLeft)):window.pageXOffset||(document.documentElement||document.body).scrollLeft}function rr(){return bl&&kl?-(document.body.getBoundingClientRect().top-parseInt(getComputedStyle(document.body).marginTop)):window.pageYOffset||(document.documentElement||document.body).scrollTop}function nr(e){var t=0;if(e.widgets)for(var r=0;r<e.widgets.length;++r)e.widgets[r].above&&(t+=Ht(e.widgets[r]));return t}function ir(e,t,r,n,i){if(!i){var o=nr(t);r.top+=o,r.bottom+=o}if("line"==n)return r;n||(n="local");var l=ye(t);if("local"==n?l+=Et(e.display):l-=e.display.viewOffset,"page"==n||"window"==n){var s=e.display.lineSpace.getBoundingClientRect();l+=s.top+("window"==n?0:rr());var a=s.left+("window"==n?0:tr());r.left+=a,r.right+=a}return r.top+=l,r.bottom+=l,r}function or(e,t,r){if("div"==r)return t;var n=t.left,i=t.top;if("page"==r)n-=tr(),i-=rr();else if("local"==r||!r){var o=e.display.sizer.getBoundingClientRect();n+=o.left,i+=o.top}var l=e.display.lineSpace.getBoundingClientRect();return{left:n-l.left,top:i-l.top}}function lr(e,t,r,n,i){return n||(n=M(e.doc,t.line)),ir(e,n,Kt(e,n,t.ch,i),r)}function sr(e,t,r,n,i,o){function l(t,l){var s=Yt(e,i,t,l?"right":"left",o);return l?s.left=s.right:s.right=s.left,ir(e,n,s,r)}function s(e,t,r){var n=1==a[t].level;return l(r?e-1:e,n!=r)}n=n||M(e.doc,t.line),i||(i=Xt(e,n));var a=Se(n,e.doc.direction),u=t.ch,c=t.sticky;if(u>=n.text.length?(u=n.text.length,c="before"):u<=0&&(u=0,c="after"),!a)return l("before"==c?u-1:u,"before"==c);var f=Ce(a,u,c),h=$l,d=s(u,f,"before"==c);return null!=h&&(d.other=s(u,h,"before"!=c)),d}function ar(e,t){var r=0;t=U(e.doc,t),e.options.lineWrapping||(r=yr(e.display)*t.ch);var n=M(e.doc,t.line),i=ye(n)+Et(e.display);return{left:r,right:r,top:i,bottom:i+n.height}}function ur(e,t,r,n,i){var o=E(e,t,r);return o.xRel=i,n&&(o.outside=!0),o}function cr(e,t,r){var n=e.doc;if((r+=e.display.viewOffset)<0)return ur(n.first,0,null,!0,-1);var i=D(n,r),o=n.first+n.size-1;if(i>o)return ur(n.first+n.size-1,M(n,o).text.length,null,!0,1);t<0&&(t=0);for(var l=M(n,i);;){var s=pr(e,l,i,t,r),a=ue(l),u=a&&a.find(0,!0);if(!a||!(s.ch>u.from.ch||s.ch==u.from.ch&&s.xRel>0))return s;i=W(l=u.to.line)}}function fr(e,t,r,n){n-=nr(t);var i=t.text.length,o=k(function(t){return Yt(e,r,t-1).bottom<=n},i,0);return i=k(function(t){return Yt(e,r,t).top>n},o,i),{begin:o,end:i}}function hr(e,t,r,n){return r||(r=Xt(e,t)),fr(e,t,r,ir(e,t,Yt(e,r,n),"line").top)}function dr(e,t,r,n){return!(e.bottom<=r)&&(e.top>r||(n?e.left:e.right)>t)}function pr(e,t,r,n,i){i-=ye(t);var o=Xt(e,t),l=nr(t),s=0,a=t.text.length,u=!0,c=Se(t,e.doc.direction);if(c){var f=(e.options.lineWrapping?vr:gr)(e,t,r,o,c,n,i);s=(u=1!=f.level)?f.from:f.to-1,a=u?f.to:f.from-1}var h,d,p=null,g=null,v=k(function(t){var r=Yt(e,o,t);return r.top+=l,r.bottom+=l,!!dr(r,n,i,!1)&&(r.top<=i&&r.left<=n&&(p=t,g=r),!0)},s,a),m=!1;if(g){var y=n-g.left<g.right-n,b=y==u;v=p+(b?0:1),d=b?"after":"before",h=y?g.left:g.right}else{u||v!=a&&v!=s||v++,d=0==v?"after":v==t.text.length?"before":Yt(e,o,v-(u?1:0)).bottom+l<=i==u?"after":"before";var w=sr(e,E(r,v,d),"line",t,o);h=w.left,m=i<w.top||i>=w.bottom}return v=L(t.text,v,1),ur(r,v,d,m,n-h)}function gr(e,t,r,n,i,o,l){var s=k(function(s){var a=i[s],u=1!=a.level;return dr(sr(e,E(r,u?a.to:a.from,u?"before":"after"),"line",t,n),o,l,!0)},0,i.length-1),a=i[s];if(s>0){var u=1!=a.level,c=sr(e,E(r,u?a.from:a.to,u?"after":"before"),"line",t,n);dr(c,o,l,!0)&&c.top>l&&(a=i[s-1])}return a}function vr(e,t,r,n,i,o,l){for(var s=fr(e,t,n,l),a=s.begin,u=s.end,c=null,f=null,h=0;h<i.length;h++){var d=i[h];if(!(d.from>=u||d.to<=a)){var p=Yt(e,n,1!=d.level?Math.min(u,d.to)-1:Math.max(a,d.from)).right,g=p<o?o-p+1e9:p-o;(!c||f>g)&&(c=d,f=g)}}return c||(c=i[i.length-1]),c.from<a&&(c={from:a,to:c.to,level:c.level}),c.to>u&&(c={from:c.from,to:u,level:c.level}),c}function mr(e){if(null!=e.cachedTextHeight)return e.cachedTextHeight;if(null==hs){hs=n("pre");for(var i=0;i<49;++i)hs.appendChild(document.createTextNode("x")),hs.appendChild(n("br"));hs.appendChild(document.createTextNode("x"))}r(e.measure,hs);var o=hs.offsetHeight/50;return o>3&&(e.cachedTextHeight=o),t(e.measure),o||1}function yr(e){if(null!=e.cachedCharWidth)return e.cachedCharWidth;var t=n("span","xxxxxxxxxx"),i=n("pre",[t]);r(e.measure,i);var o=t.getBoundingClientRect(),l=(o.right-o.left)/10;return l>2&&(e.cachedCharWidth=l),l||10}function br(e){for(var t=e.display,r={},n={},i=t.gutters.clientLeft,o=t.gutters.firstChild,l=0;o;o=o.nextSibling,++l)r[e.options.gutters[l]]=o.offsetLeft+o.clientLeft+i,n[e.options.gutters[l]]=o.clientWidth;return{fixedPos:wr(t),gutterTotalWidth:t.gutters.offsetWidth,gutterLeft:r,gutterWidth:n,wrapperWidth:t.wrapper.clientWidth}}function wr(e){return e.scroller.getBoundingClientRect().left-e.sizer.getBoundingClientRect().left}function xr(e){var t=mr(e.display),r=e.options.lineWrapping,n=r&&Math.max(5,e.display.scroller.clientWidth/yr(e.display)-3);return function(i){if(ve(e.doc,i))return 0;var o=0;if(i.widgets)for(var l=0;l<i.widgets.length;l++)i.widgets[l].height&&(o+=i.widgets[l].height);return r?o+(Math.ceil(i.text.length/n)||1)*t:o+t}}function Cr(e){var t=e.doc,r=xr(e);t.iter(function(e){var t=r(e);t!=e.height&&A(e,t)})}function Sr(e,t,r,n){var i=e.display;if(!r&&"true"==Ee(t).getAttribute("cm-not-content"))return null;var o,l,s=i.lineSpace.getBoundingClientRect();try{o=t.clientX-s.left,l=t.clientY-s.top}catch(t){return null}var a,u=cr(e,o,l);if(n&&1==u.xRel&&(a=M(e.doc,u.line).text).length==u.ch){var c=f(a,a.length,e.options.tabSize)-a.length;u=E(u.line,Math.max(0,Math.round((o-It(e.display).left)/yr(e.display))-c))}return u}function Lr(e,t){if(t>=e.display.viewTo)return null;if((t-=e.display.viewFrom)<0)return null;for(var r=e.display.view,n=0;n<r.length;n++)if((t-=r[n].size)<0)return n}function kr(e){e.display.input.showSelection(e.display.input.prepareSelection())}function Tr(e,t){void 0===t&&(t=!0);for(var r=e.doc,n={},i=n.cursors=document.createDocumentFragment(),o=n.selection=document.createDocumentFragment(),l=0;l<r.sel.ranges.length;l++)if(t||l!=r.sel.primIndex){var s=r.sel.ranges[l];if(!(s.from().line>=e.display.viewTo||s.to().line<e.display.viewFrom)){var a=s.empty();(a||e.options.showCursorWhenSelecting)&&Mr(e,s.head,i),a||Or(e,s,o)}}return n}function Mr(e,t,r){var i=sr(e,t,"div",null,null,!e.options.singleCursorHeightPerLine),o=r.appendChild(n("div"," ","CodeMirror-cursor"));if(o.style.left=i.left+"px",o.style.top=i.top+"px",o.style.height=Math.max(0,i.bottom-i.top)*e.options.cursorHeight+"px",i.other){var l=r.appendChild(n("div"," ","CodeMirror-cursor CodeMirror-secondarycursor"));l.style.display="",l.style.left=i.other.left+"px",l.style.top=i.other.top+"px",l.style.height=.85*(i.other.bottom-i.other.top)+"px"}}function Nr(e,t){return e.top-t.top||e.left-t.left}function Or(e,t,r){function i(e,t,r,i){t<0&&(t=0),t=Math.round(t),i=Math.round(i),a.appendChild(n("div",null,"CodeMirror-selected","position: absolute; left: "+e+"px;\n                             top: "+t+"px; width: "+(null==r?f-e:r)+"px;\n                             height: "+(i-t)+"px"))}function o(t,r,n){function o(r,n){return lr(e,E(t,r),"div",u,n)}var l,a,u=M(s,t),h=u.text.length,d=Se(u,s.direction);return xe(d,r||0,null==n?h:n,function(t,s,p,g){var v=o(t,"ltr"==p?"left":"right"),m=o(s-1,"ltr"==p?"right":"left");if("ltr"==p){var y=null==r&&0==t?c:v.left,b=null==n&&s==h?f:m.right;m.top-v.top<=3?i(y,m.top,b-y,m.bottom):(i(y,v.top,null,v.bottom),v.bottom<m.top&&i(c,v.bottom,null,m.top),i(c,m.top,m.right,m.bottom))}else if(t<s){var w=null==r&&0==t?f:v.right,x=null==n&&s==h?c:m.left;if(m.top-v.top<=3)i(x,m.top,w-x,m.bottom);else{var C=c;if(g){var S=hr(e,u,null,t).end;C=o(S-(/\s/.test(u.text.charAt(S-1))?2:1),"left").left}i(C,v.top,w-C,v.bottom),v.bottom<m.top&&i(c,v.bottom,null,m.top);var L=null;d.length,L=o(hr(e,u,null,s).begin,"right").right-x,i(x,m.top,L,m.bottom)}}(!l||Nr(v,l)<0)&&(l=v),Nr(m,l)<0&&(l=m),(!a||Nr(v,a)<0)&&(a=v),Nr(m,a)<0&&(a=m)}),{start:l,end:a}}var l=e.display,s=e.doc,a=document.createDocumentFragment(),u=It(e.display),c=u.left,f=Math.max(l.sizerWidth,Rt(e)-l.sizer.offsetLeft)-u.right,h=t.from(),d=t.to();if(h.line==d.line)o(h.line,h.ch,d.ch);else{var p=M(s,h.line),g=M(s,d.line),v=fe(p)==fe(g),m=o(h.line,h.ch,v?p.text.length+1:null).end,y=o(d.line,v?0:null,d.ch).start;v&&(m.top<y.top-2?(i(m.right,m.top,null,m.bottom),i(c,y.top,y.left,y.bottom)):i(m.right,m.top,y.left-m.right,m.bottom)),m.bottom<y.top&&i(c,m.bottom,null,y.top)}r.appendChild(a)}function Ar(e){if(e.state.focused){var t=e.display;clearInterval(t.blinker);var r=!0;t.cursorDiv.style.visibility="",e.options.cursorBlinkRate>0?t.blinker=setInterval(function(){return t.cursorDiv.style.visibility=(r=!r)?"":"hidden"},e.options.cursorBlinkRate):e.options.cursorBlinkRate<0&&(t.cursorDiv.style.visibility="hidden")}}function Wr(e){e.state.focused||(e.display.input.focus(),Hr(e))}function Dr(e){e.state.delayingBlurEvent=!0,setTimeout(function(){e.state.delayingBlurEvent&&(e.state.delayingBlurEvent=!1,Fr(e))},100)}function Hr(e,t){e.state.delayingBlurEvent&&(e.state.delayingBlurEvent=!1),"nocursor"!=e.options.readOnly&&(e.state.focused||(Te(e,"focus",e,t),e.state.focused=!0,s(e.display.wrapper,"CodeMirror-focused"),e.curOp||e.display.selForContextMenu==e.doc.sel||(e.display.input.reset(),ml&&setTimeout(function(){return e.display.input.reset(!0)},20)),e.display.input.receivedFocus()),Ar(e))}function Fr(e,t){e.state.delayingBlurEvent||(e.state.focused&&(Te(e,"blur",e,t),e.state.focused=!1,Fl(e.display.wrapper,"CodeMirror-focused")),clearInterval(e.display.blinker),setTimeout(function(){e.state.focused||(e.display.shift=!1)},150))}function Er(e){for(var t=e.display,r=t.lineDiv.offsetTop,n=0;n<t.view.length;n++){var i=t.view[n],o=void 0;if(!i.hidden){if(gl&&vl<8){var l=i.node.offsetTop+i.node.offsetHeight;o=l-r,r=l}else{var s=i.node.getBoundingClientRect();o=s.bottom-s.top}var a=i.line.height-o;if(o<2&&(o=mr(t)),(a>.005||a<-.005)&&(A(i.line,o),Pr(i.line),i.rest))for(var u=0;u<i.rest.length;u++)Pr(i.rest[u])}}}function Pr(e){if(e.widgets)for(var t=0;t<e.widgets.length;++t)e.widgets[t].height=e.widgets[t].node.parentNode.offsetHeight}function Ir(e,t,r){var n=r&&null!=r.top?Math.max(0,r.top):e.scroller.scrollTop;n=Math.floor(n-Et(e));var i=r&&null!=r.bottom?r.bottom:n+e.wrapper.clientHeight,o=D(t,n),l=D(t,i);if(r&&r.ensure){var s=r.ensure.from.line,a=r.ensure.to.line;s<o?(o=s,l=D(t,ye(M(t,s))+e.wrapper.clientHeight)):Math.min(a,t.lastLine())>=l&&(o=D(t,ye(M(t,a))-e.wrapper.clientHeight),l=a)}return{from:o,to:Math.max(l,o+1)}}function zr(e){var t=e.display,r=t.view;if(t.alignWidgets||t.gutters.firstChild&&e.options.fixedGutter){for(var n=wr(t)-t.scroller.scrollLeft+e.doc.scrollLeft,i=t.gutters.offsetWidth,o=n+"px",l=0;l<r.length;l++)if(!r[l].hidden){e.options.fixedGutter&&(r[l].gutter&&(r[l].gutter.style.left=o),r[l].gutterBackground&&(r[l].gutterBackground.style.left=o));var s=r[l].alignable;if(s)for(var a=0;a<s.length;a++)s[a].style.left=o}e.options.fixedGutter&&(t.gutters.style.left=n+i+"px")}}function Rr(e){if(!e.options.lineNumbers)return!1;var t=e.doc,r=F(e.options,t.first+t.size-1),i=e.display;if(r.length!=i.lineNumChars){var o=i.measure.appendChild(n("div",[n("div",r)],"CodeMirror-linenumber CodeMirror-gutter-elt")),l=o.firstChild.offsetWidth,s=o.offsetWidth-l;return i.lineGutter.style.width="",i.lineNumInnerWidth=Math.max(l,i.lineGutter.offsetWidth-s)+1,i.lineNumWidth=i.lineNumInnerWidth+s,i.lineNumChars=i.lineNumInnerWidth?r.length:-1,i.lineGutter.style.width=i.lineNumWidth+"px",Wn(e),!0}return!1}function Br(e,t){if(!Me(e,"scrollCursorIntoView")){var r=e.display,i=r.sizer.getBoundingClientRect(),o=null;if(t.top+i.top<0?o=!0:t.bottom+i.top>(window.innerHeight||document.documentElement.clientHeight)&&(o=!1),null!=o&&!Sl){var l=n("div","​",null,"position: absolute;\n                         top: "+(t.top-r.viewOffset-Et(e.display))+"px;\n                         height: "+(t.bottom-t.top+zt(e)+r.barHeight)+"px;\n                         left: "+t.left+"px; width: "+Math.max(2,t.right-t.left)+"px;");e.display.lineSpace.appendChild(l),l.scrollIntoView(o),e.display.lineSpace.removeChild(l)}}}function Gr(e,t,r,n){null==n&&(n=0);var i;e.options.lineWrapping||t!=r||(r="before"==(t=t.ch?E(t.line,"before"==t.sticky?t.ch-1:t.ch,"after"):t).sticky?E(t.line,t.ch+1,"before"):t);for(var o=0;o<5;o++){var l=!1,s=sr(e,t),a=r&&r!=t?sr(e,r):s,u=Vr(e,i={left:Math.min(s.left,a.left),top:Math.min(s.top,a.top)-n,right:Math.max(s.left,a.left),bottom:Math.max(s.bottom,a.bottom)+n}),c=e.doc.scrollTop,f=e.doc.scrollLeft;if(null!=u.scrollTop&&(qr(e,u.scrollTop),Math.abs(e.doc.scrollTop-c)>1&&(l=!0)),null!=u.scrollLeft&&(Qr(e,u.scrollLeft),Math.abs(e.doc.scrollLeft-f)>1&&(l=!0)),!l)break}return i}function Ur(e,t){var r=Vr(e,t);null!=r.scrollTop&&qr(e,r.scrollTop),null!=r.scrollLeft&&Qr(e,r.scrollLeft)}function Vr(e,t){var r=e.display,n=mr(e.display);t.top<0&&(t.top=0);var i=e.curOp&&null!=e.curOp.scrollTop?e.curOp.scrollTop:r.scroller.scrollTop,o=Bt(e),l={};t.bottom-t.top>o&&(t.bottom=t.top+o);var s=e.doc.height+Pt(r),a=t.top<n,u=t.bottom>s-n;if(t.top<i)l.scrollTop=a?0:t.top;else if(t.bottom>i+o){var c=Math.min(t.top,(u?s:t.bottom)-o);c!=i&&(l.scrollTop=c)}var f=e.curOp&&null!=e.curOp.scrollLeft?e.curOp.scrollLeft:r.scroller.scrollLeft,h=Rt(e)-(e.options.fixedGutter?r.gutters.offsetWidth:0),d=t.right-t.left>h;return d&&(t.right=t.left+h),t.left<10?l.scrollLeft=0:t.left<f?l.scrollLeft=Math.max(0,t.left-(d?0:10)):t.right>h+f-3&&(l.scrollLeft=t.right+(d?0:10)-h),l}function Kr(e,t){null!=t&&(_r(e),e.curOp.scrollTop=(null==e.curOp.scrollTop?e.doc.scrollTop:e.curOp.scrollTop)+t)}function jr(e){_r(e);var t=e.getCursor();e.curOp.scrollToPos={from:t,to:t,margin:e.options.cursorScrollMargin}}function Xr(e,t,r){null==t&&null==r||_r(e),null!=t&&(e.curOp.scrollLeft=t),null!=r&&(e.curOp.scrollTop=r)}function Yr(e,t){_r(e),e.curOp.scrollToPos=t}function _r(e){var t=e.curOp.scrollToPos;t&&(e.curOp.scrollToPos=null,$r(e,ar(e,t.from),ar(e,t.to),t.margin))}function $r(e,t,r,n){var i=Vr(e,{left:Math.min(t.left,r.left),top:Math.min(t.top,r.top)-n,right:Math.max(t.right,r.right),bottom:Math.max(t.bottom,r.bottom)+n});Xr(e,i.scrollLeft,i.scrollTop)}function qr(e,t){Math.abs(e.doc.scrollTop-t)<2||(fl||On(e,{top:t}),Zr(e,t,!0),fl&&On(e),Cn(e,100))}function Zr(e,t,r){t=Math.min(e.display.scroller.scrollHeight-e.display.scroller.clientHeight,t),(e.display.scroller.scrollTop!=t||r)&&(e.doc.scrollTop=t,e.display.scrollbars.setScrollTop(t),e.display.scroller.scrollTop!=t&&(e.display.scroller.scrollTop=t))}function Qr(e,t,r,n){t=Math.min(t,e.display.scroller.scrollWidth-e.display.scroller.clientWidth),(r?t==e.doc.scrollLeft:Math.abs(e.doc.scrollLeft-t)<2)&&!n||(e.doc.scrollLeft=t,zr(e),e.display.scroller.scrollLeft!=t&&(e.display.scroller.scrollLeft=t),e.display.scrollbars.setScrollLeft(t))}function Jr(e){var t=e.display,r=t.gutters.offsetWidth,n=Math.round(e.doc.height+Pt(e.display));return{clientHeight:t.scroller.clientHeight,viewHeight:t.wrapper.clientHeight,scrollWidth:t.scroller.scrollWidth,clientWidth:t.scroller.clientWidth,viewWidth:t.wrapper.clientWidth,barLeft:e.options.fixedGutter?r:0,docHeight:n,scrollHeight:n+zt(e)+t.barHeight,nativeBarWidth:t.nativeBarWidth,gutterWidth:r}}function en(e,t){t||(t=Jr(e));var r=e.display.barWidth,n=e.display.barHeight;tn(e,t);for(var i=0;i<4&&r!=e.display.barWidth||n!=e.display.barHeight;i++)r!=e.display.barWidth&&e.options.lineWrapping&&Er(e),tn(e,Jr(e)),r=e.display.barWidth,n=e.display.barHeight}function tn(e,t){var r=e.display,n=r.scrollbars.update(t);r.sizer.style.paddingRight=(r.barWidth=n.right)+"px",r.sizer.style.paddingBottom=(r.barHeight=n.bottom)+"px",r.heightForcer.style.borderBottom=n.bottom+"px solid transparent",n.right&&n.bottom?(r.scrollbarFiller.style.display="block",r.scrollbarFiller.style.height=n.bottom+"px",r.scrollbarFiller.style.width=n.right+"px"):r.scrollbarFiller.style.display="",n.bottom&&e.options.coverGutterNextToScrollbar&&e.options.fixedGutter?(r.gutterFiller.style.display="block",r.gutterFiller.style.height=n.bottom+"px",r.gutterFiller.style.width=t.gutterWidth+"px"):r.gutterFiller.style.display=""}function rn(e){e.display.scrollbars&&(e.display.scrollbars.clear(),e.display.scrollbars.addClass&&Fl(e.display.wrapper,e.display.scrollbars.addClass)),e.display.scrollbars=new ws[e.options.scrollbarStyle](function(t){e.display.wrapper.insertBefore(t,e.display.scrollbarFiller),Ql(t,"mousedown",function(){e.state.focused&&setTimeout(function(){return e.display.input.focus()},0)}),t.setAttribute("cm-not-content","true")},function(t,r){"horizontal"==r?Qr(e,t):qr(e,t)},e),e.display.scrollbars.addClass&&s(e.display.wrapper,e.display.scrollbars.addClass)}function nn(e){e.curOp={cm:e,viewChanged:!1,startHeight:e.doc.height,forceUpdate:!1,updateInput:null,typing:!1,changeObjs:null,cursorActivityHandlers:null,cursorActivityCalled:0,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,focus:!1,id:++xs},vt(e.curOp)}function on(e){yt(e.curOp,function(e){for(var t=0;t<e.ops.length;t++)e.ops[t].cm.curOp=null;ln(e)})}function ln(e){for(var t=e.ops,r=0;r<t.length;r++)sn(t[r]);for(var n=0;n<t.length;n++)an(t[n]);for(var i=0;i<t.length;i++)un(t[i]);for(var o=0;o<t.length;o++)cn(t[o]);for(var l=0;l<t.length;l++)fn(t[l])}function sn(e){var t=e.cm,r=t.display;Ln(t),e.updateMaxLine&&we(t),e.mustUpdate=e.viewChanged||e.forceUpdate||null!=e.scrollTop||e.scrollToPos&&(e.scrollToPos.from.line<r.viewFrom||e.scrollToPos.to.line>=r.viewTo)||r.maxLineChanged&&t.options.lineWrapping,e.update=e.mustUpdate&&new Cs(t,e.mustUpdate&&{top:e.scrollTop,ensure:e.scrollToPos},e.forceUpdate)}function an(e){e.updatedDisplay=e.mustUpdate&&Mn(e.cm,e.update)}function un(e){var t=e.cm,r=t.display;e.updatedDisplay&&Er(t),e.barMeasure=Jr(t),r.maxLineChanged&&!t.options.lineWrapping&&(e.adjustWidthTo=Kt(t,r.maxLine,r.maxLine.text.length).left+3,t.display.sizerWidth=e.adjustWidthTo,e.barMeasure.scrollWidth=Math.max(r.scroller.clientWidth,r.sizer.offsetLeft+e.adjustWidthTo+zt(t)+t.display.barWidth),e.maxScrollLeft=Math.max(0,r.sizer.offsetLeft+e.adjustWidthTo-Rt(t))),(e.updatedDisplay||e.selectionChanged)&&(e.preparedSelection=r.input.prepareSelection())}function cn(e){var t=e.cm;null!=e.adjustWidthTo&&(t.display.sizer.style.minWidth=e.adjustWidthTo+"px",e.maxScrollLeft<t.doc.scrollLeft&&Qr(t,Math.min(t.display.scroller.scrollLeft,e.maxScrollLeft),!0),t.display.maxLineChanged=!1);var r=e.focus&&e.focus==l();e.preparedSelection&&t.display.input.showSelection(e.preparedSelection,r),(e.updatedDisplay||e.startHeight!=t.doc.height)&&en(t,e.barMeasure),e.updatedDisplay&&Dn(t,e.barMeasure),e.selectionChanged&&Ar(t),t.state.focused&&e.updateInput&&t.display.input.reset(e.typing),r&&Wr(e.cm)}function fn(e){var t=e.cm,r=t.display,n=t.doc;e.updatedDisplay&&Nn(t,e.update),null==r.wheelStartX||null==e.scrollTop&&null==e.scrollLeft&&!e.scrollToPos||(r.wheelStartX=r.wheelStartY=null),null!=e.scrollTop&&Zr(t,e.scrollTop,e.forceScroll),null!=e.scrollLeft&&Qr(t,e.scrollLeft,!0,!0),e.scrollToPos&&Br(t,Gr(t,U(n,e.scrollToPos.from),U(n,e.scrollToPos.to),e.scrollToPos.margin));var i=e.maybeHiddenMarkers,o=e.maybeUnhiddenMarkers;if(i)for(var l=0;l<i.length;++l)i[l].lines.length||Te(i[l],"hide");if(o)for(var s=0;s<o.length;++s)o[s].lines.length&&Te(o[s],"unhide");r.wrapper.offsetHeight&&(n.scrollTop=t.display.scroller.scrollTop),e.changeObjs&&Te(t,"changes",t,e.changeObjs),e.update&&e.update.finish()}function hn(e,t){if(e.curOp)return t();nn(e);try{return t()}finally{on(e)}}function dn(e,t){return function(){if(e.curOp)return t.apply(e,arguments);nn(e);try{return t.apply(e,arguments)}finally{on(e)}}}function pn(e){return function(){if(this.curOp)return e.apply(this,arguments);nn(this);try{return e.apply(this,arguments)}finally{on(this)}}}function gn(e){return function(){var t=this.cm;if(!t||t.curOp)return e.apply(this,arguments);nn(t);try{return e.apply(this,arguments)}finally{on(t)}}}function vn(e,t,r,n){null==t&&(t=e.doc.first),null==r&&(r=e.doc.first+e.doc.size),n||(n=0);var i=e.display;if(n&&r<i.viewTo&&(null==i.updateLineNumbers||i.updateLineNumbers>t)&&(i.updateLineNumbers=t),e.curOp.viewChanged=!0,t>=i.viewTo)_l&&pe(e.doc,t)<i.viewTo&&yn(e);else if(r<=i.viewFrom)_l&&ge(e.doc,r+n)>i.viewFrom?yn(e):(i.viewFrom+=n,i.viewTo+=n);else if(t<=i.viewFrom&&r>=i.viewTo)yn(e);else if(t<=i.viewFrom){var o=bn(e,r,r+n,1);o?(i.view=i.view.slice(o.index),i.viewFrom=o.lineN,i.viewTo+=n):yn(e)}else if(r>=i.viewTo){var l=bn(e,t,t,-1);l?(i.view=i.view.slice(0,l.index),i.viewTo=l.lineN):yn(e)}else{var s=bn(e,t,t,-1),a=bn(e,r,r+n,1);s&&a?(i.view=i.view.slice(0,s.index).concat(gt(e,s.lineN,a.lineN)).concat(i.view.slice(a.index)),i.viewTo+=n):yn(e)}var u=i.externalMeasured;u&&(r<u.lineN?u.lineN+=n:t<u.lineN+u.size&&(i.externalMeasured=null))}function mn(e,t,r){e.curOp.viewChanged=!0;var n=e.display,i=e.display.externalMeasured;if(i&&t>=i.lineN&&t<i.lineN+i.size&&(n.externalMeasured=null),!(t<n.viewFrom||t>=n.viewTo)){var o=n.view[Lr(e,t)];if(null!=o.node){var l=o.changes||(o.changes=[]);-1==h(l,r)&&l.push(r)}}}function yn(e){e.display.viewFrom=e.display.viewTo=e.doc.first,e.display.view=[],e.display.viewOffset=0}function bn(e,t,r,n){var i,o=Lr(e,t),l=e.display.view;if(!_l||r==e.doc.first+e.doc.size)return{index:o,lineN:r};for(var s=e.display.viewFrom,a=0;a<o;a++)s+=l[a].size;if(s!=t){if(n>0){if(o==l.length-1)return null;i=s+l[o].size-t,o++}else i=s-t;t+=i,r+=i}for(;pe(e.doc,r)!=r;){if(o==(n<0?0:l.length-1))return null;r+=n*l[o-(n<0?1:0)].size,o+=n}return{index:o,lineN:r}}function wn(e,t,r){var n=e.display;0==n.view.length||t>=n.viewTo||r<=n.viewFrom?(n.view=gt(e,t,r),n.viewFrom=t):(n.viewFrom>t?n.view=gt(e,t,n.viewFrom).concat(n.view):n.viewFrom<t&&(n.view=n.view.slice(Lr(e,t))),n.viewFrom=t,n.viewTo<r?n.view=n.view.concat(gt(e,n.viewTo,r)):n.viewTo>r&&(n.view=n.view.slice(0,Lr(e,r)))),n.viewTo=r}function xn(e){for(var t=e.display.view,r=0,n=0;n<t.length;n++){var i=t[n];i.hidden||i.node&&!i.changes||++r}return r}function Cn(e,t){e.doc.highlightFrontier<e.display.viewTo&&e.state.highlight.set(t,u(Sn,e))}function Sn(e){var t=e.doc;if(!(t.highlightFrontier>=e.display.viewTo)){var r=+new Date+e.options.workTime,n=$e(e,t.highlightFrontier),i=[];t.iter(n.line,Math.min(t.first+t.size,e.display.viewTo+500),function(o){if(n.line>=e.display.viewFrom){var l=o.styles,s=o.text.length>e.options.maxHighlightLength?Ke(t.mode,n.state):null,a=Ye(e,o,n,!0);s&&(n.state=s),o.styles=a.styles;var u=o.styleClasses,c=a.classes;c?o.styleClasses=c:u&&(o.styleClasses=null);for(var f=!l||l.length!=o.styles.length||u!=c&&(!u||!c||u.bgClass!=c.bgClass||u.textClass!=c.textClass),h=0;!f&&h<l.length;++h)f=l[h]!=o.styles[h];f&&i.push(n.line),o.stateAfter=n.save(),n.nextLine()}else o.text.length<=e.options.maxHighlightLength&&qe(e,o.text,n),o.stateAfter=n.line%5==0?n.save():null,n.nextLine();if(+new Date>r)return Cn(e,e.options.workDelay),!0}),t.highlightFrontier=n.line,t.modeFrontier=Math.max(t.modeFrontier,n.line),i.length&&hn(e,function(){for(var t=0;t<i.length;t++)mn(e,i[t],"text")})}}function Ln(e){var t=e.display;!t.scrollbarsClipped&&t.scroller.offsetWidth&&(t.nativeBarWidth=t.scroller.offsetWidth-t.scroller.clientWidth,t.heightForcer.style.height=zt(e)+"px",t.sizer.style.marginBottom=-t.nativeBarWidth+"px",t.sizer.style.borderRightWidth=zt(e)+"px",t.scrollbarsClipped=!0)}function kn(e){if(e.hasFocus())return null;var t=l();if(!t||!o(e.display.lineDiv,t))return null;var r={activeElt:t};if(window.getSelection){var n=window.getSelection();n.anchorNode&&n.extend&&o(e.display.lineDiv,n.anchorNode)&&(r.anchorNode=n.anchorNode,r.anchorOffset=n.anchorOffset,r.focusNode=n.focusNode,r.focusOffset=n.focusOffset)}return r}function Tn(e){if(e&&e.activeElt&&e.activeElt!=l()&&(e.activeElt.focus(),e.anchorNode&&o(document.body,e.anchorNode)&&o(document.body,e.focusNode))){var t=window.getSelection(),r=document.createRange();r.setEnd(e.anchorNode,e.anchorOffset),r.collapse(!1),t.removeAllRanges(),t.addRange(r),t.extend(e.focusNode,e.focusOffset)}}function Mn(e,r){var n=e.display,i=e.doc;if(r.editorIsHidden)return yn(e),!1;if(!r.force&&r.visible.from>=n.viewFrom&&r.visible.to<=n.viewTo&&(null==n.updateLineNumbers||n.updateLineNumbers>=n.viewTo)&&n.renderedView==n.view&&0==xn(e))return!1;Rr(e)&&(yn(e),r.dims=br(e));var o=i.first+i.size,l=Math.max(r.visible.from-e.options.viewportMargin,i.first),s=Math.min(o,r.visible.to+e.options.viewportMargin);n.viewFrom<l&&l-n.viewFrom<20&&(l=Math.max(i.first,n.viewFrom)),n.viewTo>s&&n.viewTo-s<20&&(s=Math.min(o,n.viewTo)),_l&&(l=pe(e.doc,l),s=ge(e.doc,s));var a=l!=n.viewFrom||s!=n.viewTo||n.lastWrapHeight!=r.wrapperHeight||n.lastWrapWidth!=r.wrapperWidth;wn(e,l,s),n.viewOffset=ye(M(e.doc,n.viewFrom)),e.display.mover.style.top=n.viewOffset+"px";var u=xn(e);if(!a&&0==u&&!r.force&&n.renderedView==n.view&&(null==n.updateLineNumbers||n.updateLineNumbers>=n.viewTo))return!1;var c=kn(e);return u>4&&(n.lineDiv.style.display="none"),An(e,n.updateLineNumbers,r.dims),u>4&&(n.lineDiv.style.display=""),n.renderedView=n.view,Tn(c),t(n.cursorDiv),t(n.selectionDiv),n.gutters.style.height=n.sizer.style.minHeight=0,a&&(n.lastWrapHeight=r.wrapperHeight,n.lastWrapWidth=r.wrapperWidth,Cn(e,400)),n.updateLineNumbers=null,!0}function Nn(e,t){for(var r=t.viewport,n=!0;(n&&e.options.lineWrapping&&t.oldDisplayWidth!=Rt(e)||(r&&null!=r.top&&(r={top:Math.min(e.doc.height+Pt(e.display)-Bt(e),r.top)}),t.visible=Ir(e.display,e.doc,r),!(t.visible.from>=e.display.viewFrom&&t.visible.to<=e.display.viewTo)))&&Mn(e,t);n=!1){Er(e);var i=Jr(e);kr(e),en(e,i),Dn(e,i),t.force=!1}t.signal(e,"update",e),e.display.viewFrom==e.display.reportedViewFrom&&e.display.viewTo==e.display.reportedViewTo||(t.signal(e,"viewportChange",e,e.display.viewFrom,e.display.viewTo),e.display.reportedViewFrom=e.display.viewFrom,e.display.reportedViewTo=e.display.viewTo)}function On(e,t){var r=new Cs(e,t);if(Mn(e,r)){Er(e),Nn(e,r);var n=Jr(e);kr(e),en(e,n),Dn(e,n),r.finish()}}function An(e,r,n){function i(t){var r=t.nextSibling;return ml&&Ml&&e.display.currentWheelTarget==t?t.style.display="none":t.parentNode.removeChild(t),r}for(var o=e.display,l=e.options.lineNumbers,s=o.lineDiv,a=s.firstChild,u=o.view,c=o.viewFrom,f=0;f<u.length;f++){var d=u[f];if(d.hidden);else if(d.node&&d.node.parentNode==s){for(;a!=d.node;)a=i(a);var p=l&&null!=r&&r<=c&&d.lineNumber;d.changes&&(h(d.changes,"gutter")>-1&&(p=!1),xt(e,d,c,n)),p&&(t(d.lineNumber),d.lineNumber.appendChild(document.createTextNode(F(e.options,c)))),a=d.node.nextSibling}else{var g=Ot(e,d,c,n);s.insertBefore(g,a)}c+=d.size}for(;a;)a=i(a)}function Wn(e){var t=e.display.gutters.offsetWidth;e.display.sizer.style.marginLeft=t+"px"}function Dn(e,t){e.display.sizer.style.minHeight=t.docHeight+"px",e.display.heightForcer.style.top=t.docHeight+"px",e.display.gutters.style.height=t.docHeight+e.display.barHeight+zt(e)+"px"}function Hn(e){var r=e.display.gutters,i=e.options.gutters;t(r);for(var o=0;o<i.length;++o){var l=i[o],s=r.appendChild(n("div",null,"CodeMirror-gutter "+l));"CodeMirror-linenumbers"==l&&(e.display.lineGutter=s,s.style.width=(e.display.lineNumWidth||1)+"px")}r.style.display=o?"":"none",Wn(e)}function Fn(e){var t=h(e.gutters,"CodeMirror-linenumbers");-1==t&&e.lineNumbers?e.gutters=e.gutters.concat(["CodeMirror-linenumbers"]):t>-1&&!e.lineNumbers&&(e.gutters=e.gutters.slice(0),e.gutters.splice(t,1))}function En(e){var t=e.wheelDeltaX,r=e.wheelDeltaY;return null==t&&e.detail&&e.axis==e.HORIZONTAL_AXIS&&(t=e.detail),null==r&&e.detail&&e.axis==e.VERTICAL_AXIS?r=e.detail:null==r&&(r=e.wheelDelta),{x:t,y:r}}function Pn(e){var t=En(e);return t.x*=Ls,t.y*=Ls,t}function In(e,t){var r=En(t),n=r.x,i=r.y,o=e.display,l=o.scroller,s=l.scrollWidth>l.clientWidth,a=l.scrollHeight>l.clientHeight;if(n&&s||i&&a){if(i&&Ml&&ml)e:for(var u=t.target,c=o.view;u!=l;u=u.parentNode)for(var f=0;f<c.length;f++)if(c[f].node==u){e.display.currentWheelTarget=u;break e}if(n&&!fl&&!wl&&null!=Ls)return i&&a&&qr(e,Math.max(0,l.scrollTop+i*Ls)),Qr(e,Math.max(0,l.scrollLeft+n*Ls)),(!i||i&&a)&&We(t),void(o.wheelStartX=null);if(i&&null!=Ls){var h=i*Ls,d=e.doc.scrollTop,p=d+o.wrapper.clientHeight;h<0?d=Math.max(0,d+h-50):p=Math.min(e.doc.height,p+h+50),On(e,{top:d,bottom:p})}Ss<20&&(null==o.wheelStartX?(o.wheelStartX=l.scrollLeft,o.wheelStartY=l.scrollTop,o.wheelDX=n,o.wheelDY=i,setTimeout(function(){if(null!=o.wheelStartX){var e=l.scrollLeft-o.wheelStartX,t=l.scrollTop-o.wheelStartY,r=t&&o.wheelDY&&t/o.wheelDY||e&&o.wheelDX&&e/o.wheelDX;o.wheelStartX=o.wheelStartY=null,r&&(Ls=(Ls*Ss+r)/(Ss+1),++Ss)}},200)):(o.wheelDX+=n,o.wheelDY+=i))}}function zn(e,t){var r=e[t];e.sort(function(e,t){return P(e.from(),t.from())}),t=h(e,r);for(var n=1;n<e.length;n++){var i=e[n],o=e[n-1];if(P(o.to(),i.from())>=0){var l=B(o.from(),i.from()),s=R(o.to(),i.to()),a=o.empty()?i.from()==i.head:o.from()==o.head;n<=t&&--t,e.splice(--n,2,new Ts(a?s:l,a?l:s))}}return new ks(e,t)}function Rn(e,t){return new ks([new Ts(e,t||e)],0)}function Bn(e){return e.text?E(e.from.line+e.text.length-1,g(e.text).length+(1==e.text.length?e.from.ch:0)):e.to}function Gn(e,t){if(P(e,t.from)<0)return e;if(P(e,t.to)<=0)return Bn(t);var r=e.line+t.text.length-(t.to.line-t.from.line)-1,n=e.ch;return e.line==t.to.line&&(n+=Bn(t).ch-t.to.ch),E(r,n)}function Un(e,t){for(var r=[],n=0;n<e.sel.ranges.length;n++){var i=e.sel.ranges[n];r.push(new Ts(Gn(i.anchor,t),Gn(i.head,t)))}return zn(r,e.sel.primIndex)}function Vn(e,t,r){return e.line==t.line?E(r.line,e.ch-t.ch+r.ch):E(r.line+(e.line-t.line),e.ch)}function Kn(e,t,r){for(var n=[],i=E(e.first,0),o=i,l=0;l<t.length;l++){var s=t[l],a=Vn(s.from,i,o),u=Vn(Bn(s),i,o);if(i=s.to,o=u,"around"==r){var c=e.sel.ranges[l],f=P(c.head,c.anchor)<0;n[l]=new Ts(f?u:a,f?a:u)}else n[l]=new Ts(a,a)}return new ks(n,e.sel.primIndex)}function jn(e){e.doc.mode=Ue(e.options,e.doc.modeOption),Xn(e)}function Xn(e){e.doc.iter(function(e){e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null)}),e.doc.modeFrontier=e.doc.highlightFrontier=e.doc.first,Cn(e,100),e.state.modeGen++,e.curOp&&vn(e)}function Yn(e,t){return 0==t.from.ch&&0==t.to.ch&&""==g(t.text)&&(!e.cm||e.cm.options.wholeLineUpdateBefore)}function _n(e,t,r,n){function i(e){return r?r[e]:null}function o(e,r,i){it(e,r,i,n),bt(e,"change",e,t)}function l(e,t){for(var r=[],o=e;o<t;++o)r.push(new fs(u[o],i(o),n));return r}var s=t.from,a=t.to,u=t.text,c=M(e,s.line),f=M(e,a.line),h=g(u),d=i(u.length-1),p=a.line-s.line;if(t.full)e.insert(0,l(0,u.length)),e.remove(u.length,e.size-u.length);else if(Yn(e,t)){var v=l(0,u.length-1);o(f,f.text,d),p&&e.remove(s.line,p),v.length&&e.insert(s.line,v)}else if(c==f)if(1==u.length)o(c,c.text.slice(0,s.ch)+h+c.text.slice(a.ch),d);else{var m=l(1,u.length-1);m.push(new fs(h+c.text.slice(a.ch),d,n)),o(c,c.text.slice(0,s.ch)+u[0],i(0)),e.insert(s.line+1,m)}else if(1==u.length)o(c,c.text.slice(0,s.ch)+u[0]+f.text.slice(a.ch),i(0)),e.remove(s.line+1,p);else{o(c,c.text.slice(0,s.ch)+u[0],i(0)),o(f,h+f.text.slice(a.ch),d);var y=l(1,u.length-1);p>1&&e.remove(s.line+1,p-1),e.insert(s.line+1,y)}bt(e,"change",e,t)}function $n(e,t,r){function n(e,i,o){if(e.linked)for(var l=0;l<e.linked.length;++l){var s=e.linked[l];if(s.doc!=i){var a=o&&s.sharedHist;r&&!a||(t(s.doc,a),n(s.doc,e,a))}}}n(e,null,!0)}function qn(e,t){if(t.cm)throw new Error("This document is already in use.");e.doc=t,t.cm=e,Cr(e),jn(e),Zn(e),e.options.lineWrapping||we(e),e.options.mode=t.modeOption,vn(e)}function Zn(e){("rtl"==e.doc.direction?s:Fl)(e.display.lineDiv,"CodeMirror-rtl")}function Qn(e){hn(e,function(){Zn(e),vn(e)})}function Jn(e){this.done=[],this.undone=[],this.undoDepth=1/0,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=e||1}function ei(e,t){var r={from:z(t.from),to:Bn(t),text:N(e,t.from,t.to)};return si(e,r,t.from.line,t.to.line+1),$n(e,function(e){return si(e,r,t.from.line,t.to.line+1)},!0),r}function ti(e){for(;e.length&&g(e).ranges;)e.pop()}function ri(e,t){return t?(ti(e.done),g(e.done)):e.done.length&&!g(e.done).ranges?g(e.done):e.done.length>1&&!e.done[e.done.length-2].ranges?(e.done.pop(),g(e.done)):void 0}function ni(e,t,r,n){var i=e.history;i.undone.length=0;var o,l,s=+new Date;if((i.lastOp==n||i.lastOrigin==t.origin&&t.origin&&("+"==t.origin.charAt(0)&&e.cm&&i.lastModTime>s-e.cm.options.historyEventDelay||"*"==t.origin.charAt(0)))&&(o=ri(i,i.lastOp==n)))l=g(o.changes),0==P(t.from,t.to)&&0==P(t.from,l.to)?l.to=Bn(t):o.changes.push(ei(e,t));else{var a=g(i.done);for(a&&a.ranges||li(e.sel,i.done),o={changes:[ei(e,t)],generation:i.generation},i.done.push(o);i.done.length>i.undoDepth;)i.done.shift(),i.done[0].ranges||i.done.shift()}i.done.push(r),i.generation=++i.maxGeneration,i.lastModTime=i.lastSelTime=s,i.lastOp=i.lastSelOp=n,i.lastOrigin=i.lastSelOrigin=t.origin,l||Te(e,"historyAdded")}function ii(e,t,r,n){var i=t.charAt(0);return"*"==i||"+"==i&&r.ranges.length==n.ranges.length&&r.somethingSelected()==n.somethingSelected()&&new Date-e.history.lastSelTime<=(e.cm?e.cm.options.historyEventDelay:500)}function oi(e,t,r,n){var i=e.history,o=n&&n.origin;r==i.lastSelOp||o&&i.lastSelOrigin==o&&(i.lastModTime==i.lastSelTime&&i.lastOrigin==o||ii(e,o,g(i.done),t))?i.done[i.done.length-1]=t:li(t,i.done),i.lastSelTime=+new Date,i.lastSelOrigin=o,i.lastSelOp=r,n&&!1!==n.clearRedo&&ti(i.undone)}function li(e,t){var r=g(t);r&&r.ranges&&r.equals(e)||t.push(e)}function si(e,t,r,n){var i=t["spans_"+e.id],o=0;e.iter(Math.max(e.first,r),Math.min(e.first+e.size,n),function(r){r.markedSpans&&((i||(i=t["spans_"+e.id]={}))[o]=r.markedSpans),++o})}function ai(e){if(!e)return null;for(var t,r=0;r<e.length;++r)e[r].marker.explicitlyCleared?t||(t=e.slice(0,r)):t&&t.push(e[r]);return t?t.length?t:null:e}function ui(e,t){var r=t["spans_"+e.id];if(!r)return null;for(var n=[],i=0;i<t.text.length;++i)n.push(ai(r[i]));return n}function ci(e,t){var r=ui(e,t),n=J(e,t);if(!r)return n;if(!n)return r;for(var i=0;i<r.length;++i){var o=r[i],l=n[i];if(o&&l)e:for(var s=0;s<l.length;++s){for(var a=l[s],u=0;u<o.length;++u)if(o[u].marker==a.marker)continue e;o.push(a)}else l&&(r[i]=l)}return r}function fi(e,t,r){for(var n=[],i=0;i<e.length;++i){var o=e[i];if(o.ranges)n.push(r?ks.prototype.deepCopy.call(o):o);else{var l=o.changes,s=[];n.push({changes:s});for(var a=0;a<l.length;++a){var u=l[a],c=void 0;if(s.push({from:u.from,to:u.to,text:u.text}),t)for(var f in u)(c=f.match(/^spans_(\d+)$/))&&h(t,Number(c[1]))>-1&&(g(s)[f]=u[f],delete u[f])}}}return n}function hi(e,t,r,n){if(n){var i=e.anchor;if(r){var o=P(t,i)<0;o!=P(r,i)<0?(i=t,t=r):o!=P(t,r)<0&&(t=r)}return new Ts(i,t)}return new Ts(r||t,t)}function di(e,t,r,n,i){null==i&&(i=e.cm&&(e.cm.display.shift||e.extend)),bi(e,new ks([hi(e.sel.primary(),t,r,i)],0),n)}function pi(e,t,r){for(var n=[],i=e.cm&&(e.cm.display.shift||e.extend),o=0;o<e.sel.ranges.length;o++)n[o]=hi(e.sel.ranges[o],t[o],null,i);bi(e,zn(n,e.sel.primIndex),r)}function gi(e,t,r,n){var i=e.sel.ranges.slice(0);i[t]=r,bi(e,zn(i,e.sel.primIndex),n)}function vi(e,t,r,n){bi(e,Rn(t,r),n)}function mi(e,t,r){var n={ranges:t.ranges,update:function(t){var r=this;this.ranges=[];for(var n=0;n<t.length;n++)r.ranges[n]=new Ts(U(e,t[n].anchor),U(e,t[n].head))},origin:r&&r.origin};return Te(e,"beforeSelectionChange",e,n),e.cm&&Te(e.cm,"beforeSelectionChange",e.cm,n),n.ranges!=t.ranges?zn(n.ranges,n.ranges.length-1):t}function yi(e,t,r){var n=e.history.done,i=g(n);i&&i.ranges?(n[n.length-1]=t,wi(e,t,r)):bi(e,t,r)}function bi(e,t,r){wi(e,t,r),oi(e,e.sel,e.cm?e.cm.curOp.id:NaN,r)}function wi(e,t,r){(Oe(e,"beforeSelectionChange")||e.cm&&Oe(e.cm,"beforeSelectionChange"))&&(t=mi(e,t,r)),xi(e,Si(e,t,r&&r.bias||(P(t.primary().head,e.sel.primary().head)<0?-1:1),!0)),r&&!1===r.scroll||!e.cm||jr(e.cm)}function xi(e,t){t.equals(e.sel)||(e.sel=t,e.cm&&(e.cm.curOp.updateInput=e.cm.curOp.selectionChanged=!0,Ne(e.cm)),bt(e,"cursorActivity",e))}function Ci(e){xi(e,Si(e,e.sel,null,!1))}function Si(e,t,r,n){for(var i,o=0;o<t.ranges.length;o++){var l=t.ranges[o],s=t.ranges.length==e.sel.ranges.length&&e.sel.ranges[o],a=ki(e,l.anchor,s&&s.anchor,r,n),u=ki(e,l.head,s&&s.head,r,n);(i||a!=l.anchor||u!=l.head)&&(i||(i=t.ranges.slice(0,o)),i[o]=new Ts(a,u))}return i?zn(i,t.primIndex):t}function Li(e,t,r,n,i){var o=M(e,t.line);if(o.markedSpans)for(var l=0;l<o.markedSpans.length;++l){var s=o.markedSpans[l],a=s.marker;if((null==s.from||(a.inclusiveLeft?s.from<=t.ch:s.from<t.ch))&&(null==s.to||(a.inclusiveRight?s.to>=t.ch:s.to>t.ch))){if(i&&(Te(a,"beforeCursorEnter"),a.explicitlyCleared)){if(o.markedSpans){--l;continue}break}if(!a.atomic)continue;if(r){var u=a.find(n<0?1:-1),c=void 0;if((n<0?a.inclusiveRight:a.inclusiveLeft)&&(u=Ti(e,u,-n,u&&u.line==t.line?o:null)),u&&u.line==t.line&&(c=P(u,r))&&(n<0?c<0:c>0))return Li(e,u,t,n,i)}var f=a.find(n<0?-1:1);return(n<0?a.inclusiveLeft:a.inclusiveRight)&&(f=Ti(e,f,n,f.line==t.line?o:null)),f?Li(e,f,t,n,i):null}}return t}function ki(e,t,r,n,i){var o=n||1,l=Li(e,t,r,o,i)||!i&&Li(e,t,r,o,!0)||Li(e,t,r,-o,i)||!i&&Li(e,t,r,-o,!0);return l||(e.cantEdit=!0,E(e.first,0))}function Ti(e,t,r,n){return r<0&&0==t.ch?t.line>e.first?U(e,E(t.line-1)):null:r>0&&t.ch==(n||M(e,t.line)).text.length?t.line<e.first+e.size-1?E(t.line+1,0):null:new E(t.line,t.ch+r)}function Mi(e){e.setSelection(E(e.firstLine(),0),E(e.lastLine()),Gl)}function Ni(e,t,r){var n={canceled:!1,from:t.from,to:t.to,text:t.text,origin:t.origin,cancel:function(){return n.canceled=!0}};return r&&(n.update=function(t,r,i,o){t&&(n.from=U(e,t)),r&&(n.to=U(e,r)),i&&(n.text=i),void 0!==o&&(n.origin=o)}),Te(e,"beforeChange",e,n),e.cm&&Te(e.cm,"beforeChange",e.cm,n),n.canceled?null:{from:n.from,to:n.to,text:n.text,origin:n.origin}}function Oi(e,t,r){if(e.cm){if(!e.cm.curOp)return dn(e.cm,Oi)(e,t,r);if(e.cm.state.suppressEdits)return}if(!(Oe(e,"beforeChange")||e.cm&&Oe(e.cm,"beforeChange"))||(t=Ni(e,t,!0))){var n=Yl&&!r&&te(e,t.from,t.to);if(n)for(var i=n.length-1;i>=0;--i)Ai(e,{from:n[i].from,to:n[i].to,text:i?[""]:t.text,origin:t.origin});else Ai(e,t)}}function Ai(e,t){if(1!=t.text.length||""!=t.text[0]||0!=P(t.from,t.to)){var r=Un(e,t);ni(e,t,r,e.cm?e.cm.curOp.id:NaN),Hi(e,t,r,J(e,t));var n=[];$n(e,function(e,r){r||-1!=h(n,e.history)||(zi(e.history,t),n.push(e.history)),Hi(e,t,null,J(e,t))})}}function Wi(e,t,r){if(!e.cm||!e.cm.state.suppressEdits||r){for(var n,i=e.history,o=e.sel,l="undo"==t?i.done:i.undone,s="undo"==t?i.undone:i.done,a=0;a<l.length&&(n=l[a],r?!n.ranges||n.equals(e.sel):n.ranges);a++);if(a!=l.length){for(i.lastOrigin=i.lastSelOrigin=null;(n=l.pop()).ranges;){if(li(n,s),r&&!n.equals(e.sel))return void bi(e,n,{clearRedo:!1});o=n}var u=[];li(o,s),s.push({changes:u,generation:i.generation}),i.generation=n.generation||++i.maxGeneration;for(var c=Oe(e,"beforeChange")||e.cm&&Oe(e.cm,"beforeChange"),f=n.changes.length-1;f>=0;--f){var d=function(r){var i=n.changes[r];if(i.origin=t,c&&!Ni(e,i,!1))return l.length=0,{};u.push(ei(e,i));var o=r?Un(e,i):g(l);Hi(e,i,o,ci(e,i)),!r&&e.cm&&e.cm.scrollIntoView({from:i.from,to:Bn(i)});var s=[];$n(e,function(e,t){t||-1!=h(s,e.history)||(zi(e.history,i),s.push(e.history)),Hi(e,i,null,ci(e,i))})}(f);if(d)return d.v}}}}function Di(e,t){if(0!=t&&(e.first+=t,e.sel=new ks(v(e.sel.ranges,function(e){return new Ts(E(e.anchor.line+t,e.anchor.ch),E(e.head.line+t,e.head.ch))}),e.sel.primIndex),e.cm)){vn(e.cm,e.first,e.first-t,t);for(var r=e.cm.display,n=r.viewFrom;n<r.viewTo;n++)mn(e.cm,n,"gutter")}}function Hi(e,t,r,n){if(e.cm&&!e.cm.curOp)return dn(e.cm,Hi)(e,t,r,n);if(t.to.line<e.first)Di(e,t.text.length-1-(t.to.line-t.from.line));else if(!(t.from.line>e.lastLine())){if(t.from.line<e.first){var i=t.text.length-1-(e.first-t.from.line);Di(e,i),t={from:E(e.first,0),to:E(t.to.line+i,t.to.ch),text:[g(t.text)],origin:t.origin}}var o=e.lastLine();t.to.line>o&&(t={from:t.from,to:E(o,M(e,o).text.length),text:[t.text[0]],origin:t.origin}),t.removed=N(e,t.from,t.to),r||(r=Un(e,t)),e.cm?Fi(e.cm,t,n):_n(e,t,n),wi(e,r,Gl)}}function Fi(e,t,r){var n=e.doc,i=e.display,o=t.from,l=t.to,s=!1,a=o.line;e.options.lineWrapping||(a=W(fe(M(n,o.line))),n.iter(a,l.line+1,function(e){if(e==i.maxLine)return s=!0,!0})),n.sel.contains(t.from,t.to)>-1&&Ne(e),_n(n,t,r,xr(e)),e.options.lineWrapping||(n.iter(a,o.line+t.text.length,function(e){var t=be(e);t>i.maxLineLength&&(i.maxLine=e,i.maxLineLength=t,i.maxLineChanged=!0,s=!1)}),s&&(e.curOp.updateMaxLine=!0)),nt(n,o.line),Cn(e,400);var u=t.text.length-(l.line-o.line)-1;t.full?vn(e):o.line!=l.line||1!=t.text.length||Yn(e.doc,t)?vn(e,o.line,l.line+1,u):mn(e,o.line,"text");var c=Oe(e,"changes"),f=Oe(e,"change");if(f||c){var h={from:o,to:l,text:t.text,removed:t.removed,origin:t.origin};f&&bt(e,"change",e,h),c&&(e.curOp.changeObjs||(e.curOp.changeObjs=[])).push(h)}e.display.selForContextMenu=null}function Ei(e,t,r,n,i){if(n||(n=r),P(n,r)<0){var o;r=(o=[n,r])[0],n=o[1]}"string"==typeof t&&(t=e.splitLines(t)),Oi(e,{from:r,to:n,text:t,origin:i})}function Pi(e,t,r,n){r<e.line?e.line+=n:t<e.line&&(e.line=t,e.ch=0)}function Ii(e,t,r,n){for(var i=0;i<e.length;++i){var o=e[i],l=!0;if(o.ranges){o.copied||((o=e[i]=o.deepCopy()).copied=!0);for(var s=0;s<o.ranges.length;s++)Pi(o.ranges[s].anchor,t,r,n),Pi(o.ranges[s].head,t,r,n)}else{for(var a=0;a<o.changes.length;++a){var u=o.changes[a];if(r<u.from.line)u.from=E(u.from.line+n,u.from.ch),u.to=E(u.to.line+n,u.to.ch);else if(t<=u.to.line){l=!1;break}}l||(e.splice(0,i+1),i=0)}}}function zi(e,t){var r=t.from.line,n=t.to.line,i=t.text.length-(n-r)-1;Ii(e.done,r,n,i),Ii(e.undone,r,n,i)}function Ri(e,t,r,n){var i=t,o=t;return"number"==typeof t?o=M(e,G(e,t)):i=W(t),null==i?null:(n(o,i)&&e.cm&&mn(e.cm,i,r),o)}function Bi(e){var t=this;this.lines=e,this.parent=null;for(var r=0,n=0;n<e.length;++n)e[n].parent=t,r+=e[n].height;this.height=r}function Gi(e){var t=this;this.children=e;for(var r=0,n=0,i=0;i<e.length;++i){var o=e[i];r+=o.chunkSize(),n+=o.height,o.parent=t}this.size=r,this.height=n,this.parent=null}function Ui(e,t,r){ye(t)<(e.curOp&&e.curOp.scrollTop||e.doc.scrollTop)&&Kr(e,r)}function Vi(e,t,r,n){var i=new Ms(e,r,n),o=e.cm;return o&&i.noHScroll&&(o.display.alignWidgets=!0),Ri(e,t,"widget",function(t){var r=t.widgets||(t.widgets=[]);if(null==i.insertAt?r.push(i):r.splice(Math.min(r.length-1,Math.max(0,i.insertAt)),0,i),i.line=t,o&&!ve(e,t)){var n=ye(t)<e.scrollTop;A(t,t.height+Ht(i)),n&&Kr(o,i.height),o.curOp.forceUpdate=!0}return!0}),bt(o,"lineWidgetAdded",o,i,"number"==typeof t?t:W(t)),i}function Ki(e,t,r,n,o){if(n&&n.shared)return ji(e,t,r,n,o);if(e.cm&&!e.cm.curOp)return dn(e.cm,Ki)(e,t,r,n,o);var l=new Os(e,o),s=P(t,r);if(n&&c(n,l,!1),s>0||0==s&&!1!==l.clearWhenEmpty)return l;if(l.replacedWith&&(l.collapsed=!0,l.widgetNode=i("span",[l.replacedWith],"CodeMirror-widget"),n.handleMouseEvents||l.widgetNode.setAttribute("cm-ignore-events","true"),n.insertLeft&&(l.widgetNode.insertLeft=!0)),l.collapsed){if(ce(e,t.line,t,r,l)||t.line!=r.line&&ce(e,r.line,t,r,l))throw new Error("Inserting collapsed marker partially overlapping an existing one");X()}l.addToHistory&&ni(e,{from:t,to:r,origin:"markText"},e.sel,NaN);var a,u=t.line,f=e.cm;if(e.iter(u,r.line+1,function(e){f&&l.collapsed&&!f.options.lineWrapping&&fe(e)==f.display.maxLine&&(a=!0),l.collapsed&&u!=t.line&&A(e,0),q(e,new Y(l,u==t.line?t.ch:null,u==r.line?r.ch:null)),++u}),l.collapsed&&e.iter(t.line,r.line+1,function(t){ve(e,t)&&A(t,0)}),l.clearOnEnter&&Ql(l,"beforeCursorEnter",function(){return l.clear()}),l.readOnly&&(j(),(e.history.done.length||e.history.undone.length)&&e.clearHistory()),l.collapsed&&(l.id=++Ns,l.atomic=!0),f){if(a&&(f.curOp.updateMaxLine=!0),l.collapsed)vn(f,t.line,r.line+1);else if(l.className||l.title||l.startStyle||l.endStyle||l.css)for(var h=t.line;h<=r.line;h++)mn(f,h,"text");l.atomic&&Ci(f.doc),bt(f,"markerAdded",f,l)}return l}function ji(e,t,r,n,i){(n=c(n)).shared=!1;var o=[Ki(e,t,r,n,i)],l=o[0],s=n.widgetNode;return $n(e,function(e){s&&(n.widgetNode=s.cloneNode(!0)),o.push(Ki(e,U(e,t),U(e,r),n,i));for(var a=0;a<e.linked.length;++a)if(e.linked[a].isParent)return;l=g(o)}),new As(o,l)}function Xi(e){return e.findMarks(E(e.first,0),e.clipPos(E(e.lastLine())),function(e){return e.parent})}function Yi(e,t){for(var r=0;r<t.length;r++){var n=t[r],i=n.find(),o=e.clipPos(i.from),l=e.clipPos(i.to);if(P(o,l)){var s=Ki(e,o,l,n.primary,n.primary.type);n.markers.push(s),s.parent=n}}}function _i(e){for(var t=0;t<e.length;t++)!function(t){var r=e[t],n=[r.primary.doc];$n(r.primary.doc,function(e){return n.push(e)});for(var i=0;i<r.markers.length;i++){var o=r.markers[i];-1==h(n,o.doc)&&(o.parent=null,r.markers.splice(i--,1))}}(t)}function $i(e){var t=this;if(Qi(t),!Me(t,e)&&!Ft(t.display,e)){We(e),gl&&(Hs=+new Date);var r=Sr(t,e,!0),n=e.dataTransfer.files;if(r&&!t.isReadOnly())if(n&&n.length&&window.FileReader&&window.File)for(var i=n.length,o=Array(i),l=0,s=0;s<i;++s)!function(e,n){if(!t.options.allowDropFileTypes||-1!=h(t.options.allowDropFileTypes,e.type)){var s=new FileReader;s.onload=dn(t,function(){var e=s.result;if(/[\x00-\x08\x0e-\x1f]{2}/.test(e)&&(e=""),o[n]=e,++l==i){var a={from:r=U(t.doc,r),to:r,text:t.doc.splitLines(o.join(t.doc.lineSeparator())),origin:"paste"};Oi(t.doc,a),yi(t.doc,Rn(r,Bn(a)))}}),s.readAsText(e)}}(n[s],s);else{if(t.state.draggingText&&t.doc.sel.contains(r)>-1)return t.state.draggingText(e),void setTimeout(function(){return t.display.input.focus()},20);try{var a=e.dataTransfer.getData("Text");if(a){var u;if(t.state.draggingText&&!t.state.draggingText.copy&&(u=t.listSelections()),wi(t.doc,Rn(r,r)),u)for(var c=0;c<u.length;++c)Ei(t.doc,"",u[c].anchor,u[c].head,"drag");t.replaceSelection(a,"around","paste"),t.display.input.focus()}}catch(e){}}}}function qi(e,t){if(gl&&(!e.state.draggingText||+new Date-Hs<100))Fe(t);else if(!Me(e,t)&&!Ft(e.display,t)&&(t.dataTransfer.setData("Text",e.getSelection()),t.dataTransfer.effectAllowed="copyMove",t.dataTransfer.setDragImage&&!xl)){var r=n("img",null,null,"position: fixed; left: 0; top: 0;");r.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",wl&&(r.width=r.height=1,e.display.wrapper.appendChild(r),r._top=r.offsetTop),t.dataTransfer.setDragImage(r,0,0),wl&&r.parentNode.removeChild(r)}}function Zi(e,t){var i=Sr(e,t);if(i){var o=document.createDocumentFragment();Mr(e,i,o),e.display.dragCursor||(e.display.dragCursor=n("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),e.display.lineSpace.insertBefore(e.display.dragCursor,e.display.cursorDiv)),r(e.display.dragCursor,o)}}function Qi(e){e.display.dragCursor&&(e.display.lineSpace.removeChild(e.display.dragCursor),e.display.dragCursor=null)}function Ji(e){if(document.getElementsByClassName)for(var t=document.getElementsByClassName("CodeMirror"),r=0;r<t.length;r++){var n=t[r].CodeMirror;n&&e(n)}}function eo(){Fs||(to(),Fs=!0)}function to(){var e;Ql(window,"resize",function(){null==e&&(e=setTimeout(function(){e=null,Ji(ro)},100))}),Ql(window,"blur",function(){return Ji(Fr)})}function ro(e){var t=e.display;t.lastWrapHeight==t.wrapper.clientHeight&&t.lastWrapWidth==t.wrapper.clientWidth||(t.cachedCharWidth=t.cachedTextHeight=t.cachedPaddingH=null,t.scrollbarsClipped=!1,e.setSize())}function no(e){var t=e.split(/-(?!$)/);e=t[t.length-1];for(var r,n,i,o,l=0;l<t.length-1;l++){var s=t[l];if(/^(cmd|meta|m)$/i.test(s))o=!0;else if(/^a(lt)?$/i.test(s))r=!0;else if(/^(c|ctrl|control)$/i.test(s))n=!0;else{if(!/^s(hift)?$/i.test(s))throw new Error("Unrecognized modifier name: "+s);i=!0}}return r&&(e="Alt-"+e),n&&(e="Ctrl-"+e),o&&(e="Cmd-"+e),i&&(e="Shift-"+e),e}function io(e){var t={};for(var r in e)if(e.hasOwnProperty(r)){var n=e[r];if(/^(name|fallthrough|(de|at)tach)$/.test(r))continue;if("..."==n){delete e[r];continue}for(var i=v(r.split(" "),no),o=0;o<i.length;o++){var l=void 0,s=void 0;o==i.length-1?(s=i.join(" "),l=n):(s=i.slice(0,o+1).join(" "),l="...");var a=t[s];if(a){if(a!=l)throw new Error("Inconsistent bindings for "+s)}else t[s]=l}delete e[r]}for(var u in t)e[u]=t[u];return e}function oo(e,t,r,n){var i=(t=uo(t)).call?t.call(e,n):t[e];if(!1===i)return"nothing";if("..."===i)return"multi";if(null!=i&&r(i))return"handled";if(t.fallthrough){if("[object Array]"!=Object.prototype.toString.call(t.fallthrough))return oo(e,t.fallthrough,r,n);for(var o=0;o<t.fallthrough.length;o++){var l=oo(e,t.fallthrough[o],r,n);if(l)return l}}}function lo(e){var t="string"==typeof e?e:Es[e.keyCode];return"Ctrl"==t||"Alt"==t||"Shift"==t||"Mod"==t}function so(e,t,r){var n=e;return t.altKey&&"Alt"!=n&&(e="Alt-"+e),(Dl?t.metaKey:t.ctrlKey)&&"Ctrl"!=n&&(e="Ctrl-"+e),(Dl?t.ctrlKey:t.metaKey)&&"Cmd"!=n&&(e="Cmd-"+e),!r&&t.shiftKey&&"Shift"!=n&&(e="Shift-"+e),e}function ao(e,t){if(wl&&34==e.keyCode&&e.char)return!1;var r=Es[e.keyCode];return null!=r&&!e.altGraphKey&&so(r,e,t)}function uo(e){return"string"==typeof e?Rs[e]:e}function co(e,t){for(var r=e.doc.sel.ranges,n=[],i=0;i<r.length;i++){for(var o=t(r[i]);n.length&&P(o.from,g(n).to)<=0;){var l=n.pop();if(P(l.from,o.from)<0){o.from=l.from;break}}n.push(o)}hn(e,function(){for(var t=n.length-1;t>=0;t--)Ei(e.doc,"",n[t].from,n[t].to,"+delete");jr(e)})}function fo(e,t,r){var n=L(e.text,t+r,r);return n<0||n>e.text.length?null:n}function ho(e,t,r){var n=fo(e,t.ch,r);return null==n?null:new E(t.line,n,r<0?"after":"before")}function po(e,t,r,n,i){if(e){var o=Se(r,t.doc.direction);if(o){var l,s=i<0?g(o):o[0],a=i<0==(1==s.level)?"after":"before";if(s.level>0){var u=Xt(t,r);l=i<0?r.text.length-1:0;var c=Yt(t,u,l).top;l=k(function(e){return Yt(t,u,e).top==c},i<0==(1==s.level)?s.from:s.to-1,l),"before"==a&&(l=fo(r,l,1))}else l=i<0?s.to:s.from;return new E(n,l,a)}}return new E(n,i<0?r.text.length:0,i<0?"before":"after")}function go(e,t,r,n){var i=Se(t,e.doc.direction);if(!i)return ho(t,r,n);r.ch>=t.text.length?(r.ch=t.text.length,r.sticky="before"):r.ch<=0&&(r.ch=0,r.sticky="after");var o=Ce(i,r.ch,r.sticky),l=i[o];if("ltr"==e.doc.direction&&l.level%2==0&&(n>0?l.to>r.ch:l.from<r.ch))return ho(t,r,n);var s,a=function(e,r){return fo(t,e instanceof E?e.ch:e,r)},u=function(r){return e.options.lineWrapping?(s=s||Xt(e,t),hr(e,t,s,r)):{begin:0,end:t.text.length}},c=u("before"==r.sticky?a(r,-1):r.ch);if("rtl"==e.doc.direction||1==l.level){var f=1==l.level==n<0,h=a(r,f?1:-1);if(null!=h&&(f?h<=l.to&&h<=c.end:h>=l.from&&h>=c.begin)){var d=f?"before":"after";return new E(r.line,h,d)}}var p=function(e,t,n){for(var o=function(e,t){return t?new E(r.line,a(e,1),"before"):new E(r.line,e,"after")};e>=0&&e<i.length;e+=t){var l=i[e],s=t>0==(1!=l.level),u=s?n.begin:a(n.end,-1);if(l.from<=u&&u<l.to)return o(u,s);if(u=s?l.from:a(l.to,-1),n.begin<=u&&u<n.end)return o(u,s)}},g=p(o+n,n,c);if(g)return g;var v=n>0?c.end:a(c.begin,-1);return null==v||n>0&&v==t.text.length||!(g=p(n>0?0:i.length-1,n,u(v)))?null:g}function vo(e,t){var r=M(e.doc,t),n=fe(r);return n!=r&&(t=W(n)),po(!0,e,n,t,1)}function mo(e,t){var r=M(e.doc,t),n=he(r);return n!=r&&(t=W(n)),po(!0,e,r,t,-1)}function yo(e,t){var r=vo(e,t.line),n=M(e.doc,r.line),i=Se(n,e.doc.direction);if(!i||0==i[0].level){var o=Math.max(0,n.text.search(/\S/)),l=t.line==r.line&&t.ch<=o&&t.ch;return E(r.line,l?0:o,r.sticky)}return r}function bo(e,t,r){if("string"==typeof t&&!(t=Bs[t]))return!1;e.display.input.ensurePolled();var n=e.display.shift,i=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),r&&(e.display.shift=!1),i=t(e)!=Bl}finally{e.display.shift=n,e.state.suppressEdits=!1}return i}function wo(e,t,r){for(var n=0;n<e.state.keyMaps.length;n++){var i=oo(t,e.state.keyMaps[n],r,e);if(i)return i}return e.options.extraKeys&&oo(t,e.options.extraKeys,r,e)||oo(t,e.options.keyMap,r,e)}function xo(e,t,r,n){var i=e.state.keySeq;if(i){if(lo(t))return"handled";Gs.set(50,function(){e.state.keySeq==i&&(e.state.keySeq=null,e.display.input.reset())}),t=i+" "+t}var o=wo(e,t,n);return"multi"==o&&(e.state.keySeq=t),"handled"==o&&bt(e,"keyHandled",e,t,r),"handled"!=o&&"multi"!=o||(We(r),Ar(e)),i&&!o&&/\'$/.test(t)?(We(r),!0):!!o}function Co(e,t){var r=ao(t,!0);return!!r&&(t.shiftKey&&!e.state.keySeq?xo(e,"Shift-"+r,t,function(t){return bo(e,t,!0)})||xo(e,r,t,function(t){if("string"==typeof t?/^go[A-Z]/.test(t):t.motion)return bo(e,t)}):xo(e,r,t,function(t){return bo(e,t)}))}function So(e,t,r){return xo(e,"'"+r+"'",t,function(t){return bo(e,t,!0)})}function Lo(e){var t=this;if(t.curOp.focus=l(),!Me(t,e)){gl&&vl<11&&27==e.keyCode&&(e.returnValue=!1);var r=e.keyCode;t.display.shift=16==r||e.shiftKey;var n=Co(t,e);wl&&(Us=n?r:null,!n&&88==r&&!rs&&(Ml?e.metaKey:e.ctrlKey)&&t.replaceSelection("",null,"cut")),18!=r||/\bCodeMirror-crosshair\b/.test(t.display.lineDiv.className)||ko(t)}}function ko(e){function t(e){18!=e.keyCode&&e.altKey||(Fl(r,"CodeMirror-crosshair"),ke(document,"keyup",t),ke(document,"mouseover",t))}var r=e.display.lineDiv;s(r,"CodeMirror-crosshair"),Ql(document,"keyup",t),Ql(document,"mouseover",t)}function To(e){16==e.keyCode&&(this.doc.sel.shift=!1),Me(this,e)}function Mo(e){var t=this;if(!(Ft(t.display,e)||Me(t,e)||e.ctrlKey&&!e.altKey||Ml&&e.metaKey)){var r=e.keyCode,n=e.charCode;if(wl&&r==Us)return Us=null,void We(e);if(!wl||e.which&&!(e.which<10)||!Co(t,e)){var i=String.fromCharCode(null==n?r:n);"\b"!=i&&(So(t,e,i)||t.display.input.onKeyPress(e))}}}function No(e,t){var r=+new Date;return js&&js.compare(r,e,t)?(Ks=js=null,"triple"):Ks&&Ks.compare(r,e,t)?(js=new Vs(r,e,t),Ks=null,"double"):(Ks=new Vs(r,e,t),js=null,"single")}function Oo(e){var t=this,r=t.display;if(!(Me(t,e)||r.activeTouch&&r.input.supportsTouch()))if(r.input.ensurePolled(),r.shift=e.shiftKey,Ft(r,e))ml||(r.scroller.draggable=!1,setTimeout(function(){return r.scroller.draggable=!0},100));else if(!zo(t,e)){var n=Sr(t,e),i=Pe(e),o=n?No(n,i):"single";window.focus(),1==i&&t.state.selectingText&&t.state.selectingText(e),n&&Ao(t,i,n,o,e)||(1==i?n?Do(t,n,o,e):Ee(e)==r.scroller&&We(e):2==i?(n&&di(t.doc,n),setTimeout(function(){return r.input.focus()},20)):3==i&&(Hl?Ro(t,e):Dr(t)))}}function Ao(e,t,r,n,i){var o="Click";return"double"==n?o="Double"+o:"triple"==n&&(o="Triple"+o),o=(1==t?"Left":2==t?"Middle":"Right")+o,xo(e,so(o,i),i,function(t){if("string"==typeof t&&(t=Bs[t]),!t)return!1;var n=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),n=t(e,r)!=Bl}finally{e.state.suppressEdits=!1}return n})}function Wo(e,t,r){var n=e.getOption("configureMouse"),i=n?n(e,t,r):{};if(null==i.unit){var o=Nl?r.shiftKey&&r.metaKey:r.altKey;i.unit=o?"rectangle":"single"==t?"char":"double"==t?"word":"line"}return(null==i.extend||e.doc.extend)&&(i.extend=e.doc.extend||r.shiftKey),null==i.addNew&&(i.addNew=Ml?r.metaKey:r.ctrlKey),null==i.moveOnDrag&&(i.moveOnDrag=!(Ml?r.altKey:r.ctrlKey)),i}function Do(e,t,r,n){gl?setTimeout(u(Wr,e),0):e.curOp.focus=l();var i,o=Wo(e,r,n),s=e.doc.sel;e.options.dragDrop&&Jl&&!e.isReadOnly()&&"single"==r&&(i=s.contains(t))>-1&&(P((i=s.ranges[i]).from(),t)<0||t.xRel>0)&&(P(i.to(),t)>0||t.xRel<0)?Ho(e,n,t,o):Eo(e,n,t,o)}function Ho(e,t,r,n){var i=e.display,o=!1,l=dn(e,function(t){ml&&(i.scroller.draggable=!1),e.state.draggingText=!1,ke(document,"mouseup",l),ke(document,"mousemove",s),ke(i.scroller,"dragstart",a),ke(i.scroller,"drop",l),o||(We(t),n.addNew||di(e.doc,r,null,null,n.extend),ml||gl&&9==vl?setTimeout(function(){document.body.focus(),i.input.focus()},20):i.input.focus())}),s=function(e){o=o||Math.abs(t.clientX-e.clientX)+Math.abs(t.clientY-e.clientY)>=10},a=function(){return o=!0};ml&&(i.scroller.draggable=!0),e.state.draggingText=l,l.copy=!n.moveOnDrag,i.scroller.dragDrop&&i.scroller.dragDrop(),Ql(document,"mouseup",l),Ql(document,"mousemove",s),Ql(i.scroller,"dragstart",a),Ql(i.scroller,"drop",l),Dr(e),setTimeout(function(){return i.input.focus()},20)}function Fo(e,t,r){if("char"==r)return new Ts(t,t);if("word"==r)return e.findWordAt(t);if("line"==r)return new Ts(E(t.line,0),U(e.doc,E(t.line+1,0)));var n=r(e,t);return new Ts(n.from,n.to)}function Eo(e,t,r,n){function i(t){if(0!=P(m,t))if(m=t,"rectangle"==n.unit){for(var i=[],o=e.options.tabSize,l=f(M(u,r.line).text,r.ch,o),s=f(M(u,t.line).text,t.ch,o),a=Math.min(l,s),g=Math.max(l,s),v=Math.min(r.line,t.line),y=Math.min(e.lastLine(),Math.max(r.line,t.line));v<=y;v++){var b=M(u,v).text,w=d(b,a,o);a==g?i.push(new Ts(E(v,w),E(v,w))):b.length>w&&i.push(new Ts(E(v,w),E(v,d(b,g,o))))}i.length||i.push(new Ts(r,r)),bi(u,zn(p.ranges.slice(0,h).concat(i),h),{origin:"*mouse",scroll:!1}),e.scrollIntoView(t)}else{var x,C=c,S=Fo(e,t,n.unit),L=C.anchor;P(S.anchor,L)>0?(x=S.head,L=B(C.from(),S.anchor)):(x=S.anchor,L=R(C.to(),S.head));var k=p.ranges.slice(0);k[h]=Po(e,new Ts(U(u,L),x)),bi(u,zn(k,h),Ul)}}function o(t){var r=++b,s=Sr(e,t,!0,"rectangle"==n.unit);if(s)if(0!=P(s,m)){e.curOp.focus=l(),i(s);var c=Ir(a,u);(s.line>=c.to||s.line<c.from)&&setTimeout(dn(e,function(){b==r&&o(t)}),150)}else{var f=t.clientY<y.top?-20:t.clientY>y.bottom?20:0;f&&setTimeout(dn(e,function(){b==r&&(a.scroller.scrollTop+=f,o(t))}),50)}}function s(t){e.state.selectingText=!1,b=1/0,We(t),a.input.focus(),ke(document,"mousemove",w),ke(document,"mouseup",x),u.history.lastSelOrigin=null}var a=e.display,u=e.doc;We(t);var c,h,p=u.sel,g=p.ranges;if(n.addNew&&!n.extend?(h=u.sel.contains(r),c=h>-1?g[h]:new Ts(r,r)):(c=u.sel.primary(),h=u.sel.primIndex),"rectangle"==n.unit)n.addNew||(c=new Ts(r,r)),r=Sr(e,t,!0,!0),h=-1;else{var v=Fo(e,r,n.unit);c=n.extend?hi(c,v.anchor,v.head,n.extend):v}n.addNew?-1==h?(h=g.length,bi(u,zn(g.concat([c]),h),{scroll:!1,origin:"*mouse"})):g.length>1&&g[h].empty()&&"char"==n.unit&&!n.extend?(bi(u,zn(g.slice(0,h).concat(g.slice(h+1)),0),{scroll:!1,origin:"*mouse"}),p=u.sel):gi(u,h,c,Ul):(h=0,bi(u,new ks([c],0),Ul),p=u.sel);var m=r,y=a.wrapper.getBoundingClientRect(),b=0,w=dn(e,function(e){Pe(e)?o(e):s(e)}),x=dn(e,s);e.state.selectingText=x,Ql(document,"mousemove",w),Ql(document,"mouseup",x)}function Po(e,t){var r=t.anchor,n=t.head,i=M(e.doc,r.line);if(0==P(r,n)&&r.sticky==n.sticky)return t;var o=Se(i);if(!o)return t;var l=Ce(o,r.ch,r.sticky),s=o[l];if(s.from!=r.ch&&s.to!=r.ch)return t;var a=l+(s.from==r.ch==(1!=s.level)?0:1);if(0==a||a==o.length)return t;var u;if(n.line!=r.line)u=(n.line-r.line)*("ltr"==e.doc.direction?1:-1)>0;else{var c=Ce(o,n.ch,n.sticky),f=c-l||(n.ch-r.ch)*(1==s.level?-1:1);u=c==a-1||c==a?f<0:f>0}var h=o[a+(u?-1:0)],d=u==(1==h.level),p=d?h.from:h.to,g=d?"after":"before";return r.ch==p&&r.sticky==g?t:new Ts(new E(r.line,p,g),n)}function Io(e,t,r,n){var i,o;if(t.touches)i=t.touches[0].clientX,o=t.touches[0].clientY;else try{i=t.clientX,o=t.clientY}catch(t){return!1}if(i>=Math.floor(e.display.gutters.getBoundingClientRect().right))return!1;n&&We(t);var l=e.display,s=l.lineDiv.getBoundingClientRect();if(o>s.bottom||!Oe(e,r))return He(t);o-=s.top-l.viewOffset;for(var a=0;a<e.options.gutters.length;++a){var u=l.gutters.childNodes[a];if(u&&u.getBoundingClientRect().right>=i)return Te(e,r,e,D(e.doc,o),e.options.gutters[a],t),He(t)}}function zo(e,t){return Io(e,t,"gutterClick",!0)}function Ro(e,t){Ft(e.display,t)||Bo(e,t)||Me(e,t,"contextmenu")||e.display.input.onContextMenu(t)}function Bo(e,t){return!!Oe(e,"gutterContextMenu")&&Io(e,t,"gutterContextMenu",!1)}function Go(e){e.display.wrapper.className=e.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+e.options.theme.replace(/(^|\s)\s*/g," cm-s-"),er(e)}function Uo(e){Hn(e),vn(e),zr(e)}function Vo(e,t,r){if(!t!=!(r&&r!=Xs)){var n=e.display.dragFunctions,i=t?Ql:ke;i(e.display.scroller,"dragstart",n.start),i(e.display.scroller,"dragenter",n.enter),i(e.display.scroller,"dragover",n.over),i(e.display.scroller,"dragleave",n.leave),i(e.display.scroller,"drop",n.drop)}}function Ko(e){e.options.lineWrapping?(s(e.display.wrapper,"CodeMirror-wrap"),e.display.sizer.style.minWidth="",e.display.sizerWidth=null):(Fl(e.display.wrapper,"CodeMirror-wrap"),we(e)),Cr(e),vn(e),er(e),setTimeout(function(){return en(e)},100)}function jo(e,t){var r=this;if(!(this instanceof jo))return new jo(e,t);this.options=t=t?c(t):{},c(Ys,t,!1),Fn(t);var n=t.value;"string"==typeof n&&(n=new Ds(n,t.mode,null,t.lineSeparator,t.direction)),this.doc=n;var i=new jo.inputStyles[t.inputStyle](this),o=this.display=new T(e,n,i);o.wrapper.CodeMirror=this,Hn(this),Go(this),t.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),rn(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,delayingBlurEvent:!1,focused:!1,suppressEdits:!1,pasteIncoming:!1,cutIncoming:!1,selectingText:!1,draggingText:!1,highlight:new Pl,keySeq:null,specialChars:null},t.autofocus&&!Tl&&o.input.focus(),gl&&vl<11&&setTimeout(function(){return r.display.input.reset(!0)},20),Xo(this),eo(),nn(this),this.curOp.forceUpdate=!0,qn(this,n),t.autofocus&&!Tl||this.hasFocus()?setTimeout(u(Hr,this),20):Fr(this);for(var l in _s)_s.hasOwnProperty(l)&&_s[l](r,t[l],Xs);Rr(this),t.finishInit&&t.finishInit(this);for(var s=0;s<$s.length;++s)$s[s](r);on(this),ml&&t.lineWrapping&&"optimizelegibility"==getComputedStyle(o.lineDiv).textRendering&&(o.lineDiv.style.textRendering="auto")}function Xo(e){function t(){i.activeTouch&&(o=setTimeout(function(){return i.activeTouch=null},1e3),(l=i.activeTouch).end=+new Date)}function r(e){if(1!=e.touches.length)return!1;var t=e.touches[0];return t.radiusX<=1&&t.radiusY<=1}function n(e,t){if(null==t.left)return!0;var r=t.left-e.left,n=t.top-e.top;return r*r+n*n>400}var i=e.display;Ql(i.scroller,"mousedown",dn(e,Oo)),gl&&vl<11?Ql(i.scroller,"dblclick",dn(e,function(t){if(!Me(e,t)){var r=Sr(e,t);if(r&&!zo(e,t)&&!Ft(e.display,t)){We(t);var n=e.findWordAt(r);di(e.doc,n.anchor,n.head)}}})):Ql(i.scroller,"dblclick",function(t){return Me(e,t)||We(t)}),Hl||Ql(i.scroller,"contextmenu",function(t){return Ro(e,t)});var o,l={end:0};Ql(i.scroller,"touchstart",function(t){if(!Me(e,t)&&!r(t)&&!zo(e,t)){i.input.ensurePolled(),clearTimeout(o);var n=+new Date;i.activeTouch={start:n,moved:!1,prev:n-l.end<=300?l:null},1==t.touches.length&&(i.activeTouch.left=t.touches[0].pageX,i.activeTouch.top=t.touches[0].pageY)}}),Ql(i.scroller,"touchmove",function(){i.activeTouch&&(i.activeTouch.moved=!0)}),Ql(i.scroller,"touchend",function(r){var o=i.activeTouch;if(o&&!Ft(i,r)&&null!=o.left&&!o.moved&&new Date-o.start<300){var l,s=e.coordsChar(i.activeTouch,"page");l=!o.prev||n(o,o.prev)?new Ts(s,s):!o.prev.prev||n(o,o.prev.prev)?e.findWordAt(s):new Ts(E(s.line,0),U(e.doc,E(s.line+1,0))),e.setSelection(l.anchor,l.head),e.focus(),We(r)}t()}),Ql(i.scroller,"touchcancel",t),Ql(i.scroller,"scroll",function(){i.scroller.clientHeight&&(qr(e,i.scroller.scrollTop),Qr(e,i.scroller.scrollLeft,!0),Te(e,"scroll",e))}),Ql(i.scroller,"mousewheel",function(t){return In(e,t)}),Ql(i.scroller,"DOMMouseScroll",function(t){return In(e,t)}),Ql(i.wrapper,"scroll",function(){return i.wrapper.scrollTop=i.wrapper.scrollLeft=0}),i.dragFunctions={enter:function(t){Me(e,t)||Fe(t)},over:function(t){Me(e,t)||(Zi(e,t),Fe(t))},start:function(t){return qi(e,t)},drop:dn(e,$i),leave:function(t){Me(e,t)||Qi(e)}};var s=i.input.getField();Ql(s,"keyup",function(t){return To.call(e,t)}),Ql(s,"keydown",dn(e,Lo)),Ql(s,"keypress",dn(e,Mo)),Ql(s,"focus",function(t){return Hr(e,t)}),Ql(s,"blur",function(t){return Fr(e,t)})}function Yo(e,t,r,n){var i,o=e.doc;null==r&&(r="add"),"smart"==r&&(o.mode.indent?i=$e(e,t).state:r="prev");var l=e.options.tabSize,s=M(o,t),a=f(s.text,null,l);s.stateAfter&&(s.stateAfter=null);var u,c=s.text.match(/^\s*/)[0];if(n||/\S/.test(s.text)){if("smart"==r&&((u=o.mode.indent(i,s.text.slice(c.length),s.text))==Bl||u>150)){if(!n)return;r="prev"}}else u=0,r="not";"prev"==r?u=t>o.first?f(M(o,t-1).text,null,l):0:"add"==r?u=a+e.options.indentUnit:"subtract"==r?u=a-e.options.indentUnit:"number"==typeof r&&(u=a+r),u=Math.max(0,u);var h="",d=0;if(e.options.indentWithTabs)for(var g=Math.floor(u/l);g;--g)d+=l,h+="\t";if(d<u&&(h+=p(u-d)),h!=c)return Ei(o,h,E(t,0),E(t,c.length),"+input"),s.stateAfter=null,!0;for(var v=0;v<o.sel.ranges.length;v++){var m=o.sel.ranges[v];if(m.head.line==t&&m.head.ch<c.length){var y=E(t,c.length);gi(o,v,new Ts(y,y));break}}}function _o(e){qs=e}function $o(e,t,r,n,i){var o=e.doc;e.display.shift=!1,n||(n=o.sel);var l=e.state.pasteIncoming||"paste"==i,s=es(t),a=null;if(l&&n.ranges.length>1)if(qs&&qs.text.join("\n")==t){if(n.ranges.length%qs.text.length==0){a=[];for(var u=0;u<qs.text.length;u++)a.push(o.splitLines(qs.text[u]))}}else s.length==n.ranges.length&&e.options.pasteLinesPerSelection&&(a=v(s,function(e){return[e]}));for(var c,f=n.ranges.length-1;f>=0;f--){var h=n.ranges[f],d=h.from(),p=h.to();h.empty()&&(r&&r>0?d=E(d.line,d.ch-r):e.state.overwrite&&!l?p=E(p.line,Math.min(M(o,p.line).text.length,p.ch+g(s).length)):qs&&qs.lineWise&&qs.text.join("\n")==t&&(d=p=E(d.line,0))),c=e.curOp.updateInput;var m={from:d,to:p,text:a?a[f%a.length]:s,origin:i||(l?"paste":e.state.cutIncoming?"cut":"+input")};Oi(e.doc,m),bt(e,"inputRead",e,m)}t&&!l&&Zo(e,t),jr(e),e.curOp.updateInput=c,e.curOp.typing=!0,e.state.pasteIncoming=e.state.cutIncoming=!1}function qo(e,t){var r=e.clipboardData&&e.clipboardData.getData("Text");if(r)return e.preventDefault(),t.isReadOnly()||t.options.disableInput||hn(t,function(){return $o(t,r,0,null,"paste")}),!0}function Zo(e,t){if(e.options.electricChars&&e.options.smartIndent)for(var r=e.doc.sel,n=r.ranges.length-1;n>=0;n--){var i=r.ranges[n];if(!(i.head.ch>100||n&&r.ranges[n-1].head.line==i.head.line)){var o=e.getModeAt(i.head),l=!1;if(o.electricChars){for(var s=0;s<o.electricChars.length;s++)if(t.indexOf(o.electricChars.charAt(s))>-1){l=Yo(e,i.head.line,"smart");break}}else o.electricInput&&o.electricInput.test(M(e.doc,i.head.line).text.slice(0,i.head.ch))&&(l=Yo(e,i.head.line,"smart"));l&&bt(e,"electricInput",e,i.head.line)}}}function Qo(e){for(var t=[],r=[],n=0;n<e.doc.sel.ranges.length;n++){var i=e.doc.sel.ranges[n].head.line,o={anchor:E(i,0),head:E(i+1,0)};r.push(o),t.push(e.getRange(o.anchor,o.head))}return{text:t,ranges:r}}function Jo(e,t){e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!!t)}function el(){var e=n("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; outline: none"),t=n("div",[e],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return ml?e.style.width="1000px":e.setAttribute("wrap","off"),Ll&&(e.style.border="1px solid black"),Jo(e),t}function tl(e,t,r,n,i){function o(){var n=t.line+r;return!(n<e.first||n>=e.first+e.size)&&(t=new E(n,t.ch,t.sticky),u=M(e,n))}function l(n){var l;if(null==(l=i?go(e.cm,u,t,r):ho(u,t,r))){if(n||!o())return!1;t=po(i,e.cm,u,t.line,r)}else t=l;return!0}var s=t,a=r,u=M(e,t.line);if("char"==n)l();else if("column"==n)l(!0);else if("word"==n||"group"==n)for(var c=null,f="group"==n,h=e.cm&&e.cm.getHelper(t,"wordChars"),d=!0;!(r<0)||l(!d);d=!1){var p=u.text.charAt(t.ch)||"\n",g=x(p,h)?"w":f&&"\n"==p?"n":!f||/\s/.test(p)?null:"p";if(!f||d||g||(g="s"),c&&c!=g){r<0&&(r=1,l(),t.sticky="after");break}if(g&&(c=g),r>0&&!l(!d))break}var v=ki(e,t,s,a,!0);return I(s,v)&&(v.hitSide=!0),v}function rl(e,t,r,n){var i,o=e.doc,l=t.left;if("page"==n){var s=Math.min(e.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight),a=Math.max(s-.5*mr(e.display),3);i=(r>0?t.bottom:t.top)+r*a}else"line"==n&&(i=r>0?t.bottom+3:t.top-3);for(var u;(u=cr(e,l,i)).outside;){if(r<0?i<=0:i>=o.height){u.hitSide=!0;break}i+=5*r}return u}function nl(e,t){var r=jt(e,t.line);if(!r||r.hidden)return null;var n=M(e.doc,t.line),i=Ut(r,n,t.line),o=Se(n,e.doc.direction),l="left";o&&(l=Ce(o,t.ch)%2?"right":"left");var s=_t(i.map,t.ch,l);return s.offset="right"==s.collapse?s.end:s.start,s}function il(e){for(var t=e;t;t=t.parentNode)if(/CodeMirror-gutter-wrapper/.test(t.className))return!0;return!1}function ol(e,t){return t&&(e.bad=!0),e}function ll(e,t,r,n,i){function o(e){return function(t){return t.id==e}}function l(){c&&(u+=f,c=!1)}function s(e){e&&(l(),u+=e)}function a(t){if(1==t.nodeType){var r=t.getAttribute("cm-text");if(null!=r)return void s(r||t.textContent.replace(/\u200b/g,""));var u,h=t.getAttribute("cm-marker");if(h){var d=e.findMarks(E(n,0),E(i+1,0),o(+h));return void(d.length&&(u=d[0].find(0))&&s(N(e.doc,u.from,u.to).join(f)))}if("false"==t.getAttribute("contenteditable"))return;var p=/^(pre|div|p)$/i.test(t.nodeName);p&&l();for(var g=0;g<t.childNodes.length;g++)a(t.childNodes[g]);p&&(c=!0)}else 3==t.nodeType&&s(t.nodeValue)}for(var u="",c=!1,f=e.doc.lineSeparator();a(t),t!=r;)t=t.nextSibling;return u}function sl(e,t,r){var n;if(t==e.display.lineDiv){if(!(n=e.display.lineDiv.childNodes[r]))return ol(e.clipPos(E(e.display.viewTo-1)),!0);t=null,r=0}else for(n=t;;n=n.parentNode){if(!n||n==e.display.lineDiv)return null;if(n.parentNode&&n.parentNode==e.display.lineDiv)break}for(var i=0;i<e.display.view.length;i++){var o=e.display.view[i];if(o.node==n)return al(o,t,r)}}function al(e,t,r){function n(t,r,n){for(var i=-1;i<(f?f.length:0);i++)for(var o=i<0?c.map:f[i],l=0;l<o.length;l+=3){var s=o[l+2];if(s==t||s==r){var a=W(i<0?e.line:e.rest[i]),u=o[l]+n;return(n<0||s!=t)&&(u=o[l+(n?1:0)]),E(a,u)}}}var i=e.text.firstChild,l=!1;if(!t||!o(i,t))return ol(E(W(e.line),0),!0);if(t==i&&(l=!0,t=i.childNodes[r],r=0,!t)){var s=e.rest?g(e.rest):e.line;return ol(E(W(s),s.text.length),l)}var a=3==t.nodeType?t:null,u=t;for(a||1!=t.childNodes.length||3!=t.firstChild.nodeType||(a=t.firstChild,r&&(r=a.nodeValue.length));u.parentNode!=i;)u=u.parentNode;var c=e.measure,f=c.maps,h=n(a,u,r);if(h)return ol(h,l);for(var d=u.nextSibling,p=a?a.nodeValue.length-r:0;d;d=d.nextSibling){if(h=n(d,d.firstChild,0))return ol(E(h.line,h.ch-p),l);p+=d.textContent.length}for(var v=u.previousSibling,m=r;v;v=v.previousSibling){if(h=n(v,v.firstChild,-1))return ol(E(h.line,h.ch+m),l);m+=v.textContent.length}}var ul=navigator.userAgent,cl=navigator.platform,fl=/gecko\/\d/i.test(ul),hl=/MSIE \d/.test(ul),dl=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(ul),pl=/Edge\/(\d+)/.exec(ul),gl=hl||dl||pl,vl=gl&&(hl?document.documentMode||6:+(pl||dl)[1]),ml=!pl&&/WebKit\//.test(ul),yl=ml&&/Qt\/\d+\.\d+/.test(ul),bl=!pl&&/Chrome\//.test(ul),wl=/Opera\//.test(ul),xl=/Apple Computer/.test(navigator.vendor),Cl=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(ul),Sl=/PhantomJS/.test(ul),Ll=!pl&&/AppleWebKit/.test(ul)&&/Mobile\/\w+/.test(ul),kl=/Android/.test(ul),Tl=Ll||kl||/webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(ul),Ml=Ll||/Mac/.test(cl),Nl=/\bCrOS\b/.test(ul),Ol=/win/i.test(cl),Al=wl&&ul.match(/Version\/(\d*\.\d*)/);Al&&(Al=Number(Al[1])),Al&&Al>=15&&(wl=!1,ml=!0);var Wl,Dl=Ml&&(yl||wl&&(null==Al||Al<12.11)),Hl=fl||gl&&vl>=9,Fl=function(t,r){var n=t.className,i=e(r).exec(n);if(i){var o=n.slice(i.index+i[0].length);t.className=n.slice(0,i.index)+(o?i[1]+o:"")}};Wl=document.createRange?function(e,t,r,n){var i=document.createRange();return i.setEnd(n||e,r),i.setStart(e,t),i}:function(e,t,r){var n=document.body.createTextRange();try{n.moveToElementText(e.parentNode)}catch(e){return n}return n.collapse(!0),n.moveEnd("character",r),n.moveStart("character",t),n};var El=function(e){e.select()};Ll?El=function(e){e.selectionStart=0,e.selectionEnd=e.value.length}:gl&&(El=function(e){try{e.select()}catch(e){}});var Pl=function(){this.id=null};Pl.prototype.set=function(e,t){clearTimeout(this.id),this.id=setTimeout(t,e)};var Il,zl,Rl=30,Bl={toString:function(){return"CodeMirror.Pass"}},Gl={scroll:!1},Ul={origin:"*mouse"},Vl={origin:"+move"},Kl=[""],jl=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/,Xl=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/,Yl=!1,_l=!1,$l=null,ql=function(){function e(e){return e<=247?r.charAt(e):1424<=e&&e<=1524?"R":1536<=e&&e<=1785?n.charAt(e-1536):1774<=e&&e<=2220?"r":8192<=e&&e<=8203?"w":8204==e?"b":"L"}function t(e,t,r){this.level=e,this.from=t,this.to=r}var r="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",n="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111",i=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,o=/[stwN]/,l=/[LRr]/,s=/[Lb1n]/,a=/[1n]/;return function(r,n){var u="ltr"==n?"L":"R";if(0==r.length||"ltr"==n&&!i.test(r))return!1;for(var c=r.length,f=[],h=0;h<c;++h)f.push(e(r.charCodeAt(h)));for(var d=0,p=u;d<c;++d){var v=f[d];"m"==v?f[d]=p:p=v}for(var m=0,y=u;m<c;++m){var b=f[m];"1"==b&&"r"==y?f[m]="n":l.test(b)&&(y=b,"r"==b&&(f[m]="R"))}for(var w=1,x=f[0];w<c-1;++w){var C=f[w];"+"==C&&"1"==x&&"1"==f[w+1]?f[w]="1":","!=C||x!=f[w+1]||"1"!=x&&"n"!=x||(f[w]=x),x=C}for(var S=0;S<c;++S){var L=f[S];if(","==L)f[S]="N";else if("%"==L){var k=void 0;for(k=S+1;k<c&&"%"==f[k];++k);for(var T=S&&"!"==f[S-1]||k<c&&"1"==f[k]?"1":"N",M=S;M<k;++M)f[M]=T;S=k-1}}for(var N=0,O=u;N<c;++N){var A=f[N];"L"==O&&"1"==A?f[N]="L":l.test(A)&&(O=A)}for(var W=0;W<c;++W)if(o.test(f[W])){var D=void 0;for(D=W+1;D<c&&o.test(f[D]);++D);for(var H="L"==(W?f[W-1]:u),F=H==("L"==(D<c?f[D]:u))?H?"L":"R":u,E=W;E<D;++E)f[E]=F;W=D-1}for(var P,I=[],z=0;z<c;)if(s.test(f[z])){var R=z;for(++z;z<c&&s.test(f[z]);++z);I.push(new t(0,R,z))}else{var B=z,G=I.length;for(++z;z<c&&"L"!=f[z];++z);for(var U=B;U<z;)if(a.test(f[U])){B<U&&I.splice(G,0,new t(1,B,U));var V=U;for(++U;U<z&&a.test(f[U]);++U);I.splice(G,0,new t(2,V,U)),B=U}else++U;B<z&&I.splice(G,0,new t(1,B,z))}return 1==I[0].level&&(P=r.match(/^\s+/))&&(I[0].from=P[0].length,I.unshift(new t(0,0,P[0].length))),1==g(I).level&&(P=r.match(/\s+$/))&&(g(I).to-=P[0].length,I.push(new t(0,c-P[0].length,c))),"rtl"==n?I.reverse():I}}(),Zl=[],Ql=function(e,t,r){if(e.addEventListener)e.addEventListener(t,r,!1);else if(e.attachEvent)e.attachEvent("on"+t,r);else{var n=e._handlers||(e._handlers={});n[t]=(n[t]||Zl).concat(r)}},Jl=function(){if(gl&&vl<9)return!1;var e=n("div");return"draggable"in e||"dragDrop"in e}(),es=3!="\n\nb".split(/\n/).length?function(e){for(var t=0,r=[],n=e.length;t<=n;){var i=e.indexOf("\n",t);-1==i&&(i=e.length);var o=e.slice(t,"\r"==e.charAt(i-1)?i-1:i),l=o.indexOf("\r");-1!=l?(r.push(o.slice(0,l)),t+=l+1):(r.push(o),t=i+1)}return r}:function(e){return e.split(/\r\n?|\n/)},ts=window.getSelection?function(e){try{return e.selectionStart!=e.selectionEnd}catch(e){return!1}}:function(e){var t;try{t=e.ownerDocument.selection.createRange()}catch(e){}return!(!t||t.parentElement()!=e)&&0!=t.compareEndPoints("StartToEnd",t)},rs=function(){var e=n("div");return"oncopy"in e||(e.setAttribute("oncopy","return;"),"function"==typeof e.oncopy)}(),ns=null,is={},os={},ls={},ss=function(e,t,r){this.pos=this.start=0,this.string=e,this.tabSize=t||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0,this.lineOracle=r};ss.prototype.eol=function(){return this.pos>=this.string.length},ss.prototype.sol=function(){return this.pos==this.lineStart},ss.prototype.peek=function(){return this.string.charAt(this.pos)||void 0},ss.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},ss.prototype.eat=function(e){var t=this.string.charAt(this.pos);if("string"==typeof e?t==e:t&&(e.test?e.test(t):e(t)))return++this.pos,t},ss.prototype.eatWhile=function(e){for(var t=this.pos;this.eat(e););return this.pos>t},ss.prototype.eatSpace=function(){for(var e=this,t=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++e.pos;return this.pos>t},ss.prototype.skipToEnd=function(){this.pos=this.string.length},ss.prototype.skipTo=function(e){var t=this.string.indexOf(e,this.pos);if(t>-1)return this.pos=t,!0},ss.prototype.backUp=function(e){this.pos-=e},ss.prototype.column=function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=f(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?f(this.string,this.lineStart,this.tabSize):0)},ss.prototype.indentation=function(){return f(this.string,null,this.tabSize)-(this.lineStart?f(this.string,this.lineStart,this.tabSize):0)},ss.prototype.match=function(e,t,r){if("string"!=typeof e){var n=this.string.slice(this.pos).match(e);return n&&n.index>0?null:(n&&!1!==t&&(this.pos+=n[0].length),n)}var i=function(e){return r?e.toLowerCase():e};if(i(this.string.substr(this.pos,e.length))==i(e))return!1!==t&&(this.pos+=e.length),!0},ss.prototype.current=function(){return this.string.slice(this.start,this.pos)},ss.prototype.hideFirstChars=function(e,t){this.lineStart+=e;try{return t()}finally{this.lineStart-=e}},ss.prototype.lookAhead=function(e){var t=this.lineOracle;return t&&t.lookAhead(e)};var as=function(e,t){this.state=e,this.lookAhead=t},us=function(e,t,r,n){this.state=t,this.doc=e,this.line=r,this.maxLookAhead=n||0};us.prototype.lookAhead=function(e){var t=this.doc.getLine(this.line+e);return null!=t&&e>this.maxLookAhead&&(this.maxLookAhead=e),t},us.prototype.nextLine=function(){this.line++,this.maxLookAhead>0&&this.maxLookAhead--},us.fromSaved=function(e,t,r){return t instanceof as?new us(e,Ke(e.mode,t.state),r,t.lookAhead):new us(e,Ke(e.mode,t),r)},us.prototype.save=function(e){var t=!1!==e?Ke(this.doc.mode,this.state):this.state;return this.maxLookAhead>0?new as(t,this.maxLookAhead):t};var cs=function(e,t,r){this.start=e.start,this.end=e.pos,this.string=e.current(),this.type=t||null,this.state=r},fs=function(e,t,r){this.text=e,ne(this,t),this.height=r?r(this):1};fs.prototype.lineNo=function(){return W(this)},Ae(fs);var hs,ds={},ps={},gs=null,vs=null,ms={left:0,right:0,top:0,bottom:0},ys=function(e,t,r){this.cm=r;var i=this.vert=n("div",[n("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),o=this.horiz=n("div",[n("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");e(i),e(o),Ql(i,"scroll",function(){i.clientHeight&&t(i.scrollTop,"vertical")}),Ql(o,"scroll",function(){o.clientWidth&&t(o.scrollLeft,"horizontal")}),this.checkedZeroWidth=!1,gl&&vl<8&&(this.horiz.style.minHeight=this.vert.style.minWidth="18px")};ys.prototype.update=function(e){var t=e.scrollWidth>e.clientWidth+1,r=e.scrollHeight>e.clientHeight+1,n=e.nativeBarWidth;if(r){this.vert.style.display="block",this.vert.style.bottom=t?n+"px":"0";var i=e.viewHeight-(t?n:0);this.vert.firstChild.style.height=Math.max(0,e.scrollHeight-e.clientHeight+i)+"px"}else this.vert.style.display="",this.vert.firstChild.style.height="0";if(t){this.horiz.style.display="block",this.horiz.style.right=r?n+"px":"0",this.horiz.style.left=e.barLeft+"px";var o=e.viewWidth-e.barLeft-(r?n:0);this.horiz.firstChild.style.width=Math.max(0,e.scrollWidth-e.clientWidth+o)+"px"}else this.horiz.style.display="",this.horiz.firstChild.style.width="0";return!this.checkedZeroWidth&&e.clientHeight>0&&(0==n&&this.zeroWidthHack(),this.checkedZeroWidth=!0),{right:r?n:0,bottom:t?n:0}},ys.prototype.setScrollLeft=function(e){this.horiz.scrollLeft!=e&&(this.horiz.scrollLeft=e),this.disableHoriz&&this.enableZeroWidthBar(this.horiz,this.disableHoriz,"horiz")},ys.prototype.setScrollTop=function(e){this.vert.scrollTop!=e&&(this.vert.scrollTop=e),this.disableVert&&this.enableZeroWidthBar(this.vert,this.disableVert,"vert")},ys.prototype.zeroWidthHack=function(){var e=Ml&&!Cl?"12px":"18px";this.horiz.style.height=this.vert.style.width=e,this.horiz.style.pointerEvents=this.vert.style.pointerEvents="none",this.disableHoriz=new Pl,this.disableVert=new Pl},ys.prototype.enableZeroWidthBar=function(e,t,r){function n(){var i=e.getBoundingClientRect();("vert"==r?document.elementFromPoint(i.right-1,(i.top+i.bottom)/2):document.elementFromPoint((i.right+i.left)/2,i.bottom-1))!=e?e.style.pointerEvents="none":t.set(1e3,n)}e.style.pointerEvents="auto",t.set(1e3,n)},ys.prototype.clear=function(){var e=this.horiz.parentNode;e.removeChild(this.horiz),e.removeChild(this.vert)};var bs=function(){};bs.prototype.update=function(){return{bottom:0,right:0}},bs.prototype.setScrollLeft=function(){},bs.prototype.setScrollTop=function(){},bs.prototype.clear=function(){};var ws={native:ys,null:bs},xs=0,Cs=function(e,t,r){var n=e.display;this.viewport=t,this.visible=Ir(n,e.doc,t),this.editorIsHidden=!n.wrapper.offsetWidth,this.wrapperHeight=n.wrapper.clientHeight,this.wrapperWidth=n.wrapper.clientWidth,this.oldDisplayWidth=Rt(e),this.force=r,this.dims=br(e),this.events=[]};Cs.prototype.signal=function(e,t){Oe(e,t)&&this.events.push(arguments)},Cs.prototype.finish=function(){for(var e=this,t=0;t<this.events.length;t++)Te.apply(null,e.events[t])};var Ss=0,Ls=null;gl?Ls=-.53:fl?Ls=15:bl?Ls=-.7:xl&&(Ls=-1/3);var ks=function(e,t){this.ranges=e,this.primIndex=t};ks.prototype.primary=function(){return this.ranges[this.primIndex]},ks.prototype.equals=function(e){var t=this;if(e==this)return!0;if(e.primIndex!=this.primIndex||e.ranges.length!=this.ranges.length)return!1;for(var r=0;r<this.ranges.length;r++){var n=t.ranges[r],i=e.ranges[r];if(!I(n.anchor,i.anchor)||!I(n.head,i.head))return!1}return!0},ks.prototype.deepCopy=function(){for(var e=this,t=[],r=0;r<this.ranges.length;r++)t[r]=new Ts(z(e.ranges[r].anchor),z(e.ranges[r].head));return new ks(t,this.primIndex)},ks.prototype.somethingSelected=function(){for(var e=this,t=0;t<this.ranges.length;t++)if(!e.ranges[t].empty())return!0;return!1},ks.prototype.contains=function(e,t){var r=this;t||(t=e);for(var n=0;n<this.ranges.length;n++){var i=r.ranges[n];if(P(t,i.from())>=0&&P(e,i.to())<=0)return n}return-1};var Ts=function(e,t){this.anchor=e,this.head=t};Ts.prototype.from=function(){return B(this.anchor,this.head)},Ts.prototype.to=function(){return R(this.anchor,this.head)},Ts.prototype.empty=function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch},Bi.prototype={chunkSize:function(){return this.lines.length},removeInner:function(e,t){for(var r=this,n=e,i=e+t;n<i;++n){var o=r.lines[n];r.height-=o.height,ot(o),bt(o,"delete")}this.lines.splice(e,t)},collapse:function(e){e.push.apply(e,this.lines)},insertInner:function(e,t,r){var n=this;this.height+=r,this.lines=this.lines.slice(0,e).concat(t).concat(this.lines.slice(e));for(var i=0;i<t.length;++i)t[i].parent=n},iterN:function(e,t,r){for(var n=this,i=e+t;e<i;++e)if(r(n.lines[e]))return!0}},Gi.prototype={chunkSize:function(){return this.size},removeInner:function(e,t){var r=this;this.size-=t;for(var n=0;n<this.children.length;++n){var i=r.children[n],o=i.chunkSize();if(e<o){var l=Math.min(t,o-e),s=i.height;if(i.removeInner(e,l),r.height-=s-i.height,o==l&&(r.children.splice(n--,1),i.parent=null),0==(t-=l))break;e=0}else e-=o}if(this.size-t<25&&(this.children.length>1||!(this.children[0]instanceof Bi))){var a=[];this.collapse(a),this.children=[new Bi(a)],this.children[0].parent=this}},collapse:function(e){for(var t=this,r=0;r<this.children.length;++r)t.children[r].collapse(e)},insertInner:function(e,t,r){var n=this;this.size+=t.length,this.height+=r;for(var i=0;i<this.children.length;++i){var o=n.children[i],l=o.chunkSize();if(e<=l){if(o.insertInner(e,t,r),o.lines&&o.lines.length>50){for(var s=o.lines.length%25+25,a=s;a<o.lines.length;){var u=new Bi(o.lines.slice(a,a+=25));o.height-=u.height,n.children.splice(++i,0,u),u.parent=n}o.lines=o.lines.slice(0,s),n.maybeSpill()}break}e-=l}},maybeSpill:function(){if(!(this.children.length<=10)){var e=this;do{var t=new Gi(e.children.splice(e.children.length-5,5));if(e.parent){e.size-=t.size,e.height-=t.height;var r=h(e.parent.children,e);e.parent.children.splice(r+1,0,t)}else{var n=new Gi(e.children);n.parent=e,e.children=[n,t],e=n}t.parent=e.parent}while(e.children.length>10);e.parent.maybeSpill()}},iterN:function(e,t,r){for(var n=this,i=0;i<this.children.length;++i){var o=n.children[i],l=o.chunkSize();if(e<l){var s=Math.min(t,l-e);if(o.iterN(e,s,r))return!0;if(0==(t-=s))break;e=0}else e-=l}}};var Ms=function(e,t,r){var n=this;if(r)for(var i in r)r.hasOwnProperty(i)&&(n[i]=r[i]);this.doc=e,this.node=t};Ms.prototype.clear=function(){var e=this,t=this.doc.cm,r=this.line.widgets,n=this.line,i=W(n);if(null!=i&&r){for(var o=0;o<r.length;++o)r[o]==e&&r.splice(o--,1);r.length||(n.widgets=null);var l=Ht(this);A(n,Math.max(0,n.height-l)),t&&(hn(t,function(){Ui(t,n,-l),mn(t,i,"widget")}),bt(t,"lineWidgetCleared",t,this,i))}},Ms.prototype.changed=function(){var e=this,t=this.height,r=this.doc.cm,n=this.line;this.height=null;var i=Ht(this)-t;i&&(A(n,n.height+i),r&&hn(r,function(){r.curOp.forceUpdate=!0,Ui(r,n,i),bt(r,"lineWidgetChanged",r,e,W(n))}))},Ae(Ms);var Ns=0,Os=function(e,t){this.lines=[],this.type=t,this.doc=e,this.id=++Ns};Os.prototype.clear=function(){var e=this;if(!this.explicitlyCleared){var t=this.doc.cm,r=t&&!t.curOp;if(r&&nn(t),Oe(this,"clear")){var n=this.find();n&&bt(this,"clear",n.from,n.to)}for(var i=null,o=null,l=0;l<this.lines.length;++l){var s=e.lines[l],a=_(s.markedSpans,e);t&&!e.collapsed?mn(t,W(s),"text"):t&&(null!=a.to&&(o=W(s)),null!=a.from&&(i=W(s))),s.markedSpans=$(s.markedSpans,a),null==a.from&&e.collapsed&&!ve(e.doc,s)&&t&&A(s,mr(t.display))}if(t&&this.collapsed&&!t.options.lineWrapping)for(var u=0;u<this.lines.length;++u){var c=fe(e.lines[u]),f=be(c);f>t.display.maxLineLength&&(t.display.maxLine=c,t.display.maxLineLength=f,t.display.maxLineChanged=!0)}null!=i&&t&&this.collapsed&&vn(t,i,o+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,t&&Ci(t.doc)),t&&bt(t,"markerCleared",t,this,i,o),r&&on(t),this.parent&&this.parent.clear()}},Os.prototype.find=function(e,t){var r=this;null==e&&"bookmark"==this.type&&(e=1);for(var n,i,o=0;o<this.lines.length;++o){var l=r.lines[o],s=_(l.markedSpans,r);if(null!=s.from&&(n=E(t?l:W(l),s.from),-1==e))return n;if(null!=s.to&&(i=E(t?l:W(l),s.to),1==e))return i}return n&&{from:n,to:i}},Os.prototype.changed=function(){var e=this,t=this.find(-1,!0),r=this,n=this.doc.cm;t&&n&&hn(n,function(){var i=t.line,o=W(t.line),l=jt(n,o);if(l&&(Qt(l),n.curOp.selectionChanged=n.curOp.forceUpdate=!0),n.curOp.updateMaxLine=!0,!ve(r.doc,i)&&null!=r.height){var s=r.height;r.height=null;var a=Ht(r)-s;a&&A(i,i.height+a)}bt(n,"markerChanged",n,e)})},Os.prototype.attachLine=function(e){if(!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;t.maybeHiddenMarkers&&-1!=h(t.maybeHiddenMarkers,this)||(t.maybeUnhiddenMarkers||(t.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(e)},Os.prototype.detachLine=function(e){if(this.lines.splice(h(this.lines,e),1),!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;(t.maybeHiddenMarkers||(t.maybeHiddenMarkers=[])).push(this)}},Ae(Os);var As=function(e,t){var r=this;this.markers=e,this.primary=t;for(var n=0;n<e.length;++n)e[n].parent=r};As.prototype.clear=function(){var e=this;if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var t=0;t<this.markers.length;++t)e.markers[t].clear();bt(this,"clear")}},As.prototype.find=function(e,t){return this.primary.find(e,t)},Ae(As);var Ws=0,Ds=function(e,t,r,n,i){if(!(this instanceof Ds))return new Ds(e,t,r,n,i);null==r&&(r=0),Gi.call(this,[new Bi([new fs("",null)])]),this.first=r,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=r;var o=E(r,0);this.sel=Rn(o),this.history=new Jn(null),this.id=++Ws,this.modeOption=t,this.lineSep=n,this.direction="rtl"==i?"rtl":"ltr",this.extend=!1,"string"==typeof e&&(e=this.splitLines(e)),_n(this,{from:o,to:o,text:e}),bi(this,Rn(o),Gl)};Ds.prototype=b(Gi.prototype,{constructor:Ds,iter:function(e,t,r){r?this.iterN(e-this.first,t-e,r):this.iterN(this.first,this.first+this.size,e)},insert:function(e,t){for(var r=0,n=0;n<t.length;++n)r+=t[n].height;this.insertInner(e-this.first,t,r)},remove:function(e,t){this.removeInner(e-this.first,t)},getValue:function(e){var t=O(this,this.first,this.first+this.size);return!1===e?t:t.join(e||this.lineSeparator())},setValue:gn(function(e){var t=E(this.first,0),r=this.first+this.size-1;Oi(this,{from:t,to:E(r,M(this,r).text.length),text:this.splitLines(e),origin:"setValue",full:!0},!0),this.cm&&Xr(this.cm,0,0),bi(this,Rn(t),Gl)}),replaceRange:function(e,t,r,n){Ei(this,e,t=U(this,t),r=r?U(this,r):t,n)},getRange:function(e,t,r){var n=N(this,U(this,e),U(this,t));return!1===r?n:n.join(r||this.lineSeparator())},getLine:function(e){var t=this.getLineHandle(e);return t&&t.text},getLineHandle:function(e){if(H(this,e))return M(this,e)},getLineNumber:function(e){return W(e)},getLineHandleVisualStart:function(e){return"number"==typeof e&&(e=M(this,e)),fe(e)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(e){return U(this,e)},getCursor:function(e){var t=this.sel.primary();return null==e||"head"==e?t.head:"anchor"==e?t.anchor:"end"==e||"to"==e||!1===e?t.to():t.from()},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:gn(function(e,t,r){vi(this,U(this,"number"==typeof e?E(e,t||0):e),null,r)}),setSelection:gn(function(e,t,r){vi(this,U(this,e),U(this,t||e),r)}),extendSelection:gn(function(e,t,r){di(this,U(this,e),t&&U(this,t),r)}),extendSelections:gn(function(e,t){pi(this,K(this,e),t)}),extendSelectionsBy:gn(function(e,t){pi(this,K(this,v(this.sel.ranges,e)),t)}),setSelections:gn(function(e,t,r){var n=this;if(e.length){for(var i=[],o=0;o<e.length;o++)i[o]=new Ts(U(n,e[o].anchor),U(n,e[o].head));null==t&&(t=Math.min(e.length-1,this.sel.primIndex)),bi(this,zn(i,t),r)}}),addSelection:gn(function(e,t,r){var n=this.sel.ranges.slice(0);n.push(new Ts(U(this,e),U(this,t||e))),bi(this,zn(n,n.length-1),r)}),getSelection:function(e){for(var t,r=this,n=this.sel.ranges,i=0;i<n.length;i++){var o=N(r,n[i].from(),n[i].to());t=t?t.concat(o):o}return!1===e?t:t.join(e||this.lineSeparator())},getSelections:function(e){for(var t=this,r=[],n=this.sel.ranges,i=0;i<n.length;i++){var o=N(t,n[i].from(),n[i].to());!1!==e&&(o=o.join(e||t.lineSeparator())),r[i]=o}return r},replaceSelection:function(e,t,r){for(var n=[],i=0;i<this.sel.ranges.length;i++)n[i]=e;this.replaceSelections(n,t,r||"+input")},replaceSelections:gn(function(e,t,r){for(var n=this,i=[],o=this.sel,l=0;l<o.ranges.length;l++){var s=o.ranges[l];i[l]={from:s.from(),to:s.to(),text:n.splitLines(e[l]),origin:r}}for(var a=t&&"end"!=t&&Kn(this,i,t),u=i.length-1;u>=0;u--)Oi(n,i[u]);a?yi(this,a):this.cm&&jr(this.cm)}),undo:gn(function(){Wi(this,"undo")}),redo:gn(function(){Wi(this,"redo")}),undoSelection:gn(function(){Wi(this,"undo",!0)}),redoSelection:gn(function(){Wi(this,"redo",!0)}),setExtending:function(e){this.extend=e},getExtending:function(){return this.extend},historySize:function(){for(var e=this.history,t=0,r=0,n=0;n<e.done.length;n++)e.done[n].ranges||++t;for(var i=0;i<e.undone.length;i++)e.undone[i].ranges||++r;return{undo:t,redo:r}},clearHistory:function(){this.history=new Jn(this.history.maxGeneration)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(e){return e&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(e){return this.history.generation==(e||this.cleanGeneration)},getHistory:function(){return{done:fi(this.history.done),undone:fi(this.history.undone)}},setHistory:function(e){var t=this.history=new Jn(this.history.maxGeneration);t.done=fi(e.done.slice(0),null,!0),t.undone=fi(e.undone.slice(0),null,!0)},setGutterMarker:gn(function(e,t,r){return Ri(this,e,"gutter",function(e){var n=e.gutterMarkers||(e.gutterMarkers={});return n[t]=r,!r&&C(n)&&(e.gutterMarkers=null),!0})}),clearGutter:gn(function(e){var t=this;this.iter(function(r){r.gutterMarkers&&r.gutterMarkers[e]&&Ri(t,r,"gutter",function(){return r.gutterMarkers[e]=null,C(r.gutterMarkers)&&(r.gutterMarkers=null),!0})})}),lineInfo:function(e){var t;if("number"==typeof e){if(!H(this,e))return null;if(t=e,!(e=M(this,e)))return null}else if(null==(t=W(e)))return null;return{line:t,handle:e,text:e.text,gutterMarkers:e.gutterMarkers,textClass:e.textClass,bgClass:e.bgClass,wrapClass:e.wrapClass,widgets:e.widgets}},addLineClass:gn(function(t,r,n){return Ri(this,t,"gutter"==r?"gutter":"class",function(t){var i="text"==r?"textClass":"background"==r?"bgClass":"gutter"==r?"gutterClass":"wrapClass";if(t[i]){if(e(n).test(t[i]))return!1;t[i]+=" "+n}else t[i]=n;return!0})}),removeLineClass:gn(function(t,r,n){return Ri(this,t,"gutter"==r?"gutter":"class",function(t){var i="text"==r?"textClass":"background"==r?"bgClass":"gutter"==r?"gutterClass":"wrapClass",o=t[i];if(!o)return!1;if(null==n)t[i]=null;else{var l=o.match(e(n));if(!l)return!1;var s=l.index+l[0].length;t[i]=o.slice(0,l.index)+(l.index&&s!=o.length?" ":"")+o.slice(s)||null}return!0})}),addLineWidget:gn(function(e,t,r){return Vi(this,e,t,r)}),removeLineWidget:function(e){e.clear()},markText:function(e,t,r){return Ki(this,U(this,e),U(this,t),r,r&&r.type||"range")},setBookmark:function(e,t){var r={replacedWith:t&&(null==t.nodeType?t.widget:t),insertLeft:t&&t.insertLeft,clearWhenEmpty:!1,shared:t&&t.shared,handleMouseEvents:t&&t.handleMouseEvents};return e=U(this,e),Ki(this,e,e,r,"bookmark")},findMarksAt:function(e){var t=[],r=M(this,(e=U(this,e)).line).markedSpans;if(r)for(var n=0;n<r.length;++n){var i=r[n];(null==i.from||i.from<=e.ch)&&(null==i.to||i.to>=e.ch)&&t.push(i.marker.parent||i.marker)}return t},findMarks:function(e,t,r){e=U(this,e),t=U(this,t);var n=[],i=e.line;return this.iter(e.line,t.line+1,function(o){var l=o.markedSpans;if(l)for(var s=0;s<l.length;s++){var a=l[s];null!=a.to&&i==e.line&&e.ch>=a.to||null==a.from&&i!=e.line||null!=a.from&&i==t.line&&a.from>=t.ch||r&&!r(a.marker)||n.push(a.marker.parent||a.marker)}++i}),n},getAllMarks:function(){var e=[];return this.iter(function(t){var r=t.markedSpans;if(r)for(var n=0;n<r.length;++n)null!=r[n].from&&e.push(r[n].marker)}),e},posFromIndex:function(e){var t,r=this.first,n=this.lineSeparator().length;return this.iter(function(i){var o=i.text.length+n;if(o>e)return t=e,!0;e-=o,++r}),U(this,E(r,t))},indexFromPos:function(e){var t=(e=U(this,e)).ch;if(e.line<this.first||e.ch<0)return 0;var r=this.lineSeparator().length;return this.iter(this.first,e.line,function(e){t+=e.text.length+r}),t},copy:function(e){var t=new Ds(O(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return t.scrollTop=this.scrollTop,t.scrollLeft=this.scrollLeft,t.sel=this.sel,t.extend=!1,e&&(t.history.undoDepth=this.history.undoDepth,t.setHistory(this.getHistory())),t},linkedDoc:function(e){e||(e={});var t=this.first,r=this.first+this.size;null!=e.from&&e.from>t&&(t=e.from),null!=e.to&&e.to<r&&(r=e.to);var n=new Ds(O(this,t,r),e.mode||this.modeOption,t,this.lineSep,this.direction);return e.sharedHist&&(n.history=this.history),(this.linked||(this.linked=[])).push({doc:n,sharedHist:e.sharedHist}),n.linked=[{doc:this,isParent:!0,sharedHist:e.sharedHist}],Yi(n,Xi(this)),n},unlinkDoc:function(e){var t=this;if(e instanceof jo&&(e=e.doc),this.linked)for(var r=0;r<this.linked.length;++r)if(t.linked[r].doc==e){t.linked.splice(r,1),e.unlinkDoc(t),_i(Xi(t));break}if(e.history==this.history){var n=[e.id];$n(e,function(e){return n.push(e.id)},!0),e.history=new Jn(null),e.history.done=fi(this.history.done,n),e.history.undone=fi(this.history.undone,n)}},iterLinkedDocs:function(e){$n(this,e)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(e){return this.lineSep?e.split(this.lineSep):es(e)},lineSeparator:function(){return this.lineSep||"\n"},setDirection:gn(function(e){"rtl"!=e&&(e="ltr"),e!=this.direction&&(this.direction=e,this.iter(function(e){return e.order=null}),this.cm&&Qn(this.cm))})}),Ds.prototype.eachLine=Ds.prototype.iter;for(var Hs=0,Fs=!1,Es={3:"Enter",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",106:"*",107:"=",109:"-",110:".",111:"/",127:"Delete",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},Ps=0;Ps<10;Ps++)Es[Ps+48]=Es[Ps+96]=String(Ps);for(var Is=65;Is<=90;Is++)Es[Is]=String.fromCharCode(Is);for(var zs=1;zs<=12;zs++)Es[zs+111]=Es[zs+63235]="F"+zs;var Rs={};Rs.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},Rs.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Up":"goLineUp","Ctrl-Down":"goLineDown","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},Rs.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Alt-F":"goWordRight","Alt-B":"goWordLeft","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-D":"delWordAfter","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars","Ctrl-O":"openLine"},Rs.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Home":"goDocStart","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineLeft","Cmd-Right":"goLineRight","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delWrappedLineLeft","Cmd-Delete":"delWrappedLineRight","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd",fallthrough:["basic","emacsy"]},Rs.default=Ml?Rs.macDefault:Rs.pcDefault;var Bs={selectAll:Mi,singleSelection:function(e){return e.setSelection(e.getCursor("anchor"),e.getCursor("head"),Gl)},killLine:function(e){return co(e,function(t){if(t.empty()){var r=M(e.doc,t.head.line).text.length;return t.head.ch==r&&t.head.line<e.lastLine()?{from:t.head,to:E(t.head.line+1,0)}:{from:t.head,to:E(t.head.line,r)}}return{from:t.from(),to:t.to()}})},deleteLine:function(e){return co(e,function(t){return{from:E(t.from().line,0),to:U(e.doc,E(t.to().line+1,0))}})},delLineLeft:function(e){return co(e,function(e){return{from:E(e.from().line,0),to:e.from()}})},delWrappedLineLeft:function(e){return co(e,function(t){var r=e.charCoords(t.head,"div").top+5;return{from:e.coordsChar({left:0,top:r},"div"),to:t.from()}})},delWrappedLineRight:function(e){return co(e,function(t){var r=e.charCoords(t.head,"div").top+5,n=e.coordsChar({left:e.display.lineDiv.offsetWidth+100,top:r},"div");return{from:t.from(),to:n}})},undo:function(e){return e.undo()},redo:function(e){return e.redo()},undoSelection:function(e){return e.undoSelection()},redoSelection:function(e){return e.redoSelection()},goDocStart:function(e){return e.extendSelection(E(e.firstLine(),0))},goDocEnd:function(e){return e.extendSelection(E(e.lastLine()))},goLineStart:function(e){return e.extendSelectionsBy(function(t){return vo(e,t.head.line)},{origin:"+move",bias:1})},goLineStartSmart:function(e){return e.extendSelectionsBy(function(t){return yo(e,t.head)},{origin:"+move",bias:1})},goLineEnd:function(e){return e.extendSelectionsBy(function(t){return mo(e,t.head.line)},{origin:"+move",bias:-1})},goLineRight:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5;return e.coordsChar({left:e.display.lineDiv.offsetWidth+100,top:r},"div")},Vl)},goLineLeft:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5;return e.coordsChar({left:0,top:r},"div")},Vl)},goLineLeftSmart:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5,n=e.coordsChar({left:0,top:r},"div");return n.ch<e.getLine(n.line).search(/\S/)?yo(e,t.head):n},Vl)},goLineUp:function(e){return e.moveV(-1,"line")},goLineDown:function(e){return e.moveV(1,"line")},goPageUp:function(e){return e.moveV(-1,"page")},goPageDown:function(e){return e.moveV(1,"page")},goCharLeft:function(e){return e.moveH(-1,"char")},goCharRight:function(e){return e.moveH(1,"char")},goColumnLeft:function(e){return e.moveH(-1,"column")},goColumnRight:function(e){return e.moveH(1,"column")},goWordLeft:function(e){return e.moveH(-1,"word")},goGroupRight:function(e){return e.moveH(1,"group")},goGroupLeft:function(e){return e.moveH(-1,"group")},goWordRight:function(e){return e.moveH(1,"word")},delCharBefore:function(e){return e.deleteH(-1,"char")},delCharAfter:function(e){return e.deleteH(1,"char")},delWordBefore:function(e){return e.deleteH(-1,"word")},delWordAfter:function(e){return e.deleteH(1,"word")},delGroupBefore:function(e){return e.deleteH(-1,"group")},delGroupAfter:function(e){return e.deleteH(1,"group")},indentAuto:function(e){return e.indentSelection("smart")},indentMore:function(e){return e.indentSelection("add")},indentLess:function(e){return e.indentSelection("subtract")},insertTab:function(e){return e.replaceSelection("\t")},insertSoftTab:function(e){for(var t=[],r=e.listSelections(),n=e.options.tabSize,i=0;i<r.length;i++){var o=r[i].from(),l=f(e.getLine(o.line),o.ch,n);t.push(p(n-l%n))}e.replaceSelections(t)},defaultTab:function(e){e.somethingSelected()?e.indentSelection("add"):e.execCommand("insertTab")},transposeChars:function(e){return hn(e,function(){for(var t=e.listSelections(),r=[],n=0;n<t.length;n++)if(t[n].empty()){var i=t[n].head,o=M(e.doc,i.line).text;if(o)if(i.ch==o.length&&(i=new E(i.line,i.ch-1)),i.ch>0)i=new E(i.line,i.ch+1),e.replaceRange(o.charAt(i.ch-1)+o.charAt(i.ch-2),E(i.line,i.ch-2),i,"+transpose");else if(i.line>e.doc.first){var l=M(e.doc,i.line-1).text;l&&(i=new E(i.line,1),e.replaceRange(o.charAt(0)+e.doc.lineSeparator()+l.charAt(l.length-1),E(i.line-1,l.length-1),i,"+transpose"))}r.push(new Ts(i,i))}e.setSelections(r)})},newlineAndIndent:function(e){return hn(e,function(){for(var t=e.listSelections(),r=t.length-1;r>=0;r--)e.replaceRange(e.doc.lineSeparator(),t[r].anchor,t[r].head,"+input");t=e.listSelections();for(var n=0;n<t.length;n++)e.indentLine(t[n].from().line,null,!0);jr(e)})},openLine:function(e){return e.replaceSelection("\n","start")},toggleOverwrite:function(e){return e.toggleOverwrite()}},Gs=new Pl,Us=null,Vs=function(e,t,r){this.time=e,this.pos=t,this.button=r};Vs.prototype.compare=function(e,t,r){return this.time+400>e&&0==P(t,this.pos)&&r==this.button};var Ks,js,Xs={toString:function(){return"CodeMirror.Init"}},Ys={},_s={};jo.defaults=Ys,jo.optionHandlers=_s;var $s=[];jo.defineInitHook=function(e){return $s.push(e)};var qs=null,Zs=function(e){this.cm=e,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new Pl,this.composing=null,this.gracePeriod=!1,this.readDOMTimeout=null};Zs.prototype.init=function(e){function t(e){if(!Me(i,e)){if(i.somethingSelected())_o({lineWise:!1,text:i.getSelections()}),"cut"==e.type&&i.replaceSelection("",null,"cut");else{if(!i.options.lineWiseCopyCut)return;var t=Qo(i);_o({lineWise:!0,text:t.text}),"cut"==e.type&&i.operation(function(){i.setSelections(t.ranges,0,Gl),i.replaceSelection("",null,"cut")})}if(e.clipboardData){e.clipboardData.clearData();var r=qs.text.join("\n");if(e.clipboardData.setData("Text",r),e.clipboardData.getData("Text")==r)return void e.preventDefault()}var l=el(),s=l.firstChild;i.display.lineSpace.insertBefore(l,i.display.lineSpace.firstChild),s.value=qs.text.join("\n");var a=document.activeElement;El(s),setTimeout(function(){i.display.lineSpace.removeChild(l),a.focus(),a==o&&n.showPrimarySelection()},50)}}var r=this,n=this,i=n.cm,o=n.div=e.lineDiv;Jo(o,i.options.spellcheck),Ql(o,"paste",function(e){Me(i,e)||qo(e,i)||vl<=11&&setTimeout(dn(i,function(){return r.updateFromDOM()}),20)}),Ql(o,"compositionstart",function(e){r.composing={data:e.data,done:!1}}),Ql(o,"compositionupdate",function(e){r.composing||(r.composing={data:e.data,done:!1})}),Ql(o,"compositionend",function(e){r.composing&&(e.data!=r.composing.data&&r.readFromDOMSoon(),r.composing.done=!0)}),Ql(o,"touchstart",function(){return n.forceCompositionEnd()}),Ql(o,"input",function(){r.composing||r.readFromDOMSoon()}),Ql(o,"copy",t),Ql(o,"cut",t)},Zs.prototype.prepareSelection=function(){var e=Tr(this.cm,!1);return e.focus=this.cm.state.focused,e},Zs.prototype.showSelection=function(e,t){e&&this.cm.display.view.length&&((e.focus||t)&&this.showPrimarySelection(),this.showMultipleSelections(e))},Zs.prototype.showPrimarySelection=function(){var e=window.getSelection(),t=this.cm,r=t.doc.sel.primary(),n=r.from(),i=r.to();if(t.display.viewTo==t.display.viewFrom||n.line>=t.display.viewTo||i.line<t.display.viewFrom)e.removeAllRanges();else{var o=sl(t,e.anchorNode,e.anchorOffset),l=sl(t,e.focusNode,e.focusOffset);if(!o||o.bad||!l||l.bad||0!=P(B(o,l),n)||0!=P(R(o,l),i)){var s=t.display.view,a=n.line>=t.display.viewFrom&&nl(t,n)||{node:s[0].measure.map[2],offset:0},u=i.line<t.display.viewTo&&nl(t,i);if(!u){var c=s[s.length-1].measure,f=c.maps?c.maps[c.maps.length-1]:c.map;u={node:f[f.length-1],offset:f[f.length-2]-f[f.length-3]}}if(a&&u){var h,d=e.rangeCount&&e.getRangeAt(0);try{h=Wl(a.node,a.offset,u.offset,u.node)}catch(e){}h&&(!fl&&t.state.focused?(e.collapse(a.node,a.offset),h.collapsed||(e.removeAllRanges(),e.addRange(h))):(e.removeAllRanges(),e.addRange(h)),d&&null==e.anchorNode?e.addRange(d):fl&&this.startGracePeriod()),this.rememberSelection()}else e.removeAllRanges()}}},Zs.prototype.startGracePeriod=function(){var e=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout(function(){e.gracePeriod=!1,e.selectionChanged()&&e.cm.operation(function(){return e.cm.curOp.selectionChanged=!0})},20)},Zs.prototype.showMultipleSelections=function(e){r(this.cm.display.cursorDiv,e.cursors),r(this.cm.display.selectionDiv,e.selection)},Zs.prototype.rememberSelection=function(){var e=window.getSelection();this.lastAnchorNode=e.anchorNode,this.lastAnchorOffset=e.anchorOffset,this.lastFocusNode=e.focusNode,this.lastFocusOffset=e.focusOffset},Zs.prototype.selectionInEditor=function(){var e=window.getSelection();if(!e.rangeCount)return!1;var t=e.getRangeAt(0).commonAncestorContainer;return o(this.div,t)},Zs.prototype.focus=function(){"nocursor"!=this.cm.options.readOnly&&(this.selectionInEditor()||this.showSelection(this.prepareSelection(),!0),this.div.focus())},Zs.prototype.blur=function(){this.div.blur()},Zs.prototype.getField=function(){return this.div},Zs.prototype.supportsTouch=function(){return!0},Zs.prototype.receivedFocus=function(){function e(){t.cm.state.focused&&(t.pollSelection(),t.polling.set(t.cm.options.pollInterval,e))}var t=this;this.selectionInEditor()?this.pollSelection():hn(this.cm,function(){return t.cm.curOp.selectionChanged=!0}),this.polling.set(this.cm.options.pollInterval,e)},Zs.prototype.selectionChanged=function(){var e=window.getSelection();return e.anchorNode!=this.lastAnchorNode||e.anchorOffset!=this.lastAnchorOffset||e.focusNode!=this.lastFocusNode||e.focusOffset!=this.lastFocusOffset},Zs.prototype.pollSelection=function(){if(null==this.readDOMTimeout&&!this.gracePeriod&&this.selectionChanged()){var e=window.getSelection(),t=this.cm;if(kl&&bl&&this.cm.options.gutters.length&&il(e.anchorNode))return this.cm.triggerOnKeyDown({type:"keydown",keyCode:8,preventDefault:Math.abs}),this.blur(),void this.focus();if(!this.composing){this.rememberSelection();var r=sl(t,e.anchorNode,e.anchorOffset),n=sl(t,e.focusNode,e.focusOffset);r&&n&&hn(t,function(){bi(t.doc,Rn(r,n),Gl),(r.bad||n.bad)&&(t.curOp.selectionChanged=!0)})}}},Zs.prototype.pollContent=function(){null!=this.readDOMTimeout&&(clearTimeout(this.readDOMTimeout),this.readDOMTimeout=null);var e=this.cm,t=e.display,r=e.doc.sel.primary(),n=r.from(),i=r.to();if(0==n.ch&&n.line>e.firstLine()&&(n=E(n.line-1,M(e.doc,n.line-1).length)),i.ch==M(e.doc,i.line).text.length&&i.line<e.lastLine()&&(i=E(i.line+1,0)),n.line<t.viewFrom||i.line>t.viewTo-1)return!1;var o,l,s;n.line==t.viewFrom||0==(o=Lr(e,n.line))?(l=W(t.view[0].line),s=t.view[0].node):(l=W(t.view[o].line),s=t.view[o-1].node.nextSibling);var a,u,c=Lr(e,i.line);if(c==t.view.length-1?(a=t.viewTo-1,u=t.lineDiv.lastChild):(a=W(t.view[c+1].line)-1,u=t.view[c+1].node.previousSibling),!s)return!1;for(var f=e.doc.splitLines(ll(e,s,u,l,a)),h=N(e.doc,E(l,0),E(a,M(e.doc,a).text.length));f.length>1&&h.length>1;)if(g(f)==g(h))f.pop(),h.pop(),a--;else{if(f[0]!=h[0])break;f.shift(),h.shift(),l++}for(var d=0,p=0,v=f[0],m=h[0],y=Math.min(v.length,m.length);d<y&&v.charCodeAt(d)==m.charCodeAt(d);)++d;for(var b=g(f),w=g(h),x=Math.min(b.length-(1==f.length?d:0),w.length-(1==h.length?d:0));p<x&&b.charCodeAt(b.length-p-1)==w.charCodeAt(w.length-p-1);)++p;if(1==f.length&&1==h.length&&l==n.line)for(;d&&d>n.ch&&b.charCodeAt(b.length-p-1)==w.charCodeAt(w.length-p-1);)d--,p++;f[f.length-1]=b.slice(0,b.length-p).replace(/^\u200b+/,""),f[0]=f[0].slice(d).replace(/\u200b+$/,"");var C=E(l,d),S=E(a,h.length?g(h).length-p:0);return f.length>1||f[0]||P(C,S)?(Ei(e.doc,f,C,S,"+input"),!0):void 0},Zs.prototype.ensurePolled=function(){this.forceCompositionEnd()},Zs.prototype.reset=function(){this.forceCompositionEnd()},Zs.prototype.forceCompositionEnd=function(){this.composing&&(clearTimeout(this.readDOMTimeout),this.composing=null,this.updateFromDOM(),this.div.blur(),this.div.focus())},Zs.prototype.readFromDOMSoon=function(){var e=this;null==this.readDOMTimeout&&(this.readDOMTimeout=setTimeout(function(){if(e.readDOMTimeout=null,e.composing){if(!e.composing.done)return;e.composing=null}e.updateFromDOM()},80))},Zs.prototype.updateFromDOM=function(){var e=this;!this.cm.isReadOnly()&&this.pollContent()||hn(this.cm,function(){return vn(e.cm)})},Zs.prototype.setUneditable=function(e){e.contentEditable="false"},Zs.prototype.onKeyPress=function(e){0!=e.charCode&&(e.preventDefault(),this.cm.isReadOnly()||dn(this.cm,$o)(this.cm,String.fromCharCode(null==e.charCode?e.keyCode:e.charCode),0))},Zs.prototype.readOnlyChanged=function(e){this.div.contentEditable=String("nocursor"!=e)},Zs.prototype.onContextMenu=function(){},Zs.prototype.resetPosition=function(){},Zs.prototype.needsContentAttribute=!0;var Qs=function(e){this.cm=e,this.prevInput="",this.pollingFast=!1,this.polling=new Pl,this.hasSelection=!1,this.composing=null};Qs.prototype.init=function(e){function t(e){if(!Me(i,e)){if(i.somethingSelected())_o({lineWise:!1,text:i.getSelections()});else{if(!i.options.lineWiseCopyCut)return;var t=Qo(i);_o({lineWise:!0,text:t.text}),"cut"==e.type?i.setSelections(t.ranges,null,Gl):(n.prevInput="",l.value=t.text.join("\n"),El(l))}"cut"==e.type&&(i.state.cutIncoming=!0)}}var r=this,n=this,i=this.cm,o=this.wrapper=el(),l=this.textarea=o.firstChild;e.wrapper.insertBefore(o,e.wrapper.firstChild),Ll&&(l.style.width="0px"),Ql(l,"input",function(){gl&&vl>=9&&r.hasSelection&&(r.hasSelection=null),n.poll()}),Ql(l,"paste",function(e){Me(i,e)||qo(e,i)||(i.state.pasteIncoming=!0,n.fastPoll())}),Ql(l,"cut",t),Ql(l,"copy",t),Ql(e.scroller,"paste",function(t){Ft(e,t)||Me(i,t)||(i.state.pasteIncoming=!0,n.focus())}),Ql(e.lineSpace,"selectstart",function(t){Ft(e,t)||We(t)}),Ql(l,"compositionstart",function(){var e=i.getCursor("from");n.composing&&n.composing.range.clear(),n.composing={start:e,range:i.markText(e,i.getCursor("to"),{className:"CodeMirror-composing"})}}),Ql(l,"compositionend",function(){n.composing&&(n.poll(),n.composing.range.clear(),n.composing=null)})},Qs.prototype.prepareSelection=function(){var e=this.cm,t=e.display,r=e.doc,n=Tr(e);if(e.options.moveInputWithCursor){var i=sr(e,r.sel.primary().head,"div"),o=t.wrapper.getBoundingClientRect(),l=t.lineDiv.getBoundingClientRect();n.teTop=Math.max(0,Math.min(t.wrapper.clientHeight-10,i.top+l.top-o.top)),n.teLeft=Math.max(0,Math.min(t.wrapper.clientWidth-10,i.left+l.left-o.left))}return n},Qs.prototype.showSelection=function(e){var t=this.cm.display;r(t.cursorDiv,e.cursors),r(t.selectionDiv,e.selection),null!=e.teTop&&(this.wrapper.style.top=e.teTop+"px",this.wrapper.style.left=e.teLeft+"px")},Qs.prototype.reset=function(e){if(!this.contextMenuPending&&!this.composing){var t=this.cm;if(t.somethingSelected()){this.prevInput="";var r=t.getSelection();this.textarea.value=r,t.state.focused&&El(this.textarea),gl&&vl>=9&&(this.hasSelection=r)}else e||(this.prevInput=this.textarea.value="",gl&&vl>=9&&(this.hasSelection=null))}},Qs.prototype.getField=function(){return this.textarea},Qs.prototype.supportsTouch=function(){return!1},Qs.prototype.focus=function(){if("nocursor"!=this.cm.options.readOnly&&(!Tl||l()!=this.textarea))try{this.textarea.focus()}catch(e){}},Qs.prototype.blur=function(){this.textarea.blur()},Qs.prototype.resetPosition=function(){this.wrapper.style.top=this.wrapper.style.left=0},Qs.prototype.receivedFocus=function(){this.slowPoll()},Qs.prototype.slowPoll=function(){var e=this;this.pollingFast||this.polling.set(this.cm.options.pollInterval,function(){e.poll(),e.cm.state.focused&&e.slowPoll()})},Qs.prototype.fastPoll=function(){function e(){r.poll()||t?(r.pollingFast=!1,r.slowPoll()):(t=!0,r.polling.set(60,e))}var t=!1,r=this;r.pollingFast=!0,r.polling.set(20,e)},Qs.prototype.poll=function(){var e=this,t=this.cm,r=this.textarea,n=this.prevInput;if(this.contextMenuPending||!t.state.focused||ts(r)&&!n&&!this.composing||t.isReadOnly()||t.options.disableInput||t.state.keySeq)return!1;var i=r.value;if(i==n&&!t.somethingSelected())return!1;if(gl&&vl>=9&&this.hasSelection===i||Ml&&/[\uf700-\uf7ff]/.test(i))return t.display.input.reset(),!1;if(t.doc.sel==t.display.selForContextMenu){var o=i.charCodeAt(0);if(8203!=o||n||(n="​"),8666==o)return this.reset(),this.cm.execCommand("undo")}for(var l=0,s=Math.min(n.length,i.length);l<s&&n.charCodeAt(l)==i.charCodeAt(l);)++l;return hn(t,function(){$o(t,i.slice(l),n.length-l,null,e.composing?"*compose":null),i.length>1e3||i.indexOf("\n")>-1?r.value=e.prevInput="":e.prevInput=i,e.composing&&(e.composing.range.clear(),e.composing.range=t.markText(e.composing.start,t.getCursor("to"),{className:"CodeMirror-composing"}))}),!0},Qs.prototype.ensurePolled=function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},Qs.prototype.onKeyPress=function(){gl&&vl>=9&&(this.hasSelection=null),this.fastPoll()},Qs.prototype.onContextMenu=function(e){function t(){if(null!=l.selectionStart){var e=i.somethingSelected(),t="​"+(e?l.value:"");l.value="⇚",l.value=t,n.prevInput=e?"":"​",l.selectionStart=1,l.selectionEnd=t.length,o.selForContextMenu=i.doc.sel}}function r(){if(n.contextMenuPending=!1,n.wrapper.style.cssText=c,l.style.cssText=u,gl&&vl<9&&o.scrollbars.setScrollTop(o.scroller.scrollTop=a),null!=l.selectionStart){(!gl||gl&&vl<9)&&t();var e=0,r=function(){o.selForContextMenu==i.doc.sel&&0==l.selectionStart&&l.selectionEnd>0&&"​"==n.prevInput?dn(i,Mi)(i):e++<10?o.detectingSelectAll=setTimeout(r,500):(o.selForContextMenu=null,o.input.reset())};o.detectingSelectAll=setTimeout(r,200)}}var n=this,i=n.cm,o=i.display,l=n.textarea,s=Sr(i,e),a=o.scroller.scrollTop;if(s&&!wl){i.options.resetSelectionOnContextMenu&&-1==i.doc.sel.contains(s)&&dn(i,bi)(i.doc,Rn(s),Gl);var u=l.style.cssText,c=n.wrapper.style.cssText;n.wrapper.style.cssText="position: absolute";var f=n.wrapper.getBoundingClientRect();l.style.cssText="position: absolute; width: 30px; height: 30px;\n      top: "+(e.clientY-f.top-5)+"px; left: "+(e.clientX-f.left-5)+"px;\n      z-index: 1000; background: "+(gl?"rgba(255, 255, 255, .05)":"transparent")+";\n      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);";var h;if(ml&&(h=window.scrollY),o.input.focus(),ml&&window.scrollTo(null,h),o.input.reset(),i.somethingSelected()||(l.value=n.prevInput=" "),n.contextMenuPending=!0,o.selForContextMenu=i.doc.sel,clearTimeout(o.detectingSelectAll),gl&&vl>=9&&t(),Hl){Fe(e);var d=function(){ke(window,"mouseup",d),setTimeout(r,20)};Ql(window,"mouseup",d)}else setTimeout(r,50)}},Qs.prototype.readOnlyChanged=function(e){e||this.reset(),this.textarea.disabled="nocursor"==e},Qs.prototype.setUneditable=function(){},Qs.prototype.needsContentAttribute=!1,function(e){function t(t,n,i,o){e.defaults[t]=n,i&&(r[t]=o?function(e,t,r){r!=Xs&&i(e,t,r)}:i)}var r=e.optionHandlers;e.defineOption=t,e.Init=Xs,t("value","",function(e,t){return e.setValue(t)},!0),t("mode",null,function(e,t){e.doc.modeOption=t,jn(e)},!0),t("indentUnit",2,jn,!0),t("indentWithTabs",!1),t("smartIndent",!0),t("tabSize",4,function(e){Xn(e),er(e),vn(e)},!0),t("lineSeparator",null,function(e,t){if(e.doc.lineSep=t,t){var r=[],n=e.doc.first;e.doc.iter(function(e){for(var i=0;;){var o=e.text.indexOf(t,i);if(-1==o)break;i=o+t.length,r.push(E(n,o))}n++});for(var i=r.length-1;i>=0;i--)Ei(e.doc,t,r[i],E(r[i].line,r[i].ch+t.length))}}),t("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b-\u200f\u2028\u2029\ufeff]/g,function(e,t,r){e.state.specialChars=new RegExp(t.source+(t.test("\t")?"":"|\t"),"g"),r!=Xs&&e.refresh()}),t("specialCharPlaceholder",at,function(e){return e.refresh()},!0),t("electricChars",!0),t("inputStyle",Tl?"contenteditable":"textarea",function(){throw new Error("inputStyle can not (yet) be changed in a running editor")},!0),t("spellcheck",!1,function(e,t){return e.getInputField().spellcheck=t},!0),t("rtlMoveVisually",!Ol),t("wholeLineUpdateBefore",!0),t("theme","default",function(e){Go(e),Uo(e)},!0),t("keyMap","default",function(e,t,r){var n=uo(t),i=r!=Xs&&uo(r);i&&i.detach&&i.detach(e,n),n.attach&&n.attach(e,i||null)}),t("extraKeys",null),t("configureMouse",null),t("lineWrapping",!1,Ko,!0),t("gutters",[],function(e){Fn(e.options),Uo(e)},!0),t("fixedGutter",!0,function(e,t){e.display.gutters.style.left=t?wr(e.display)+"px":"0",e.refresh()},!0),t("coverGutterNextToScrollbar",!1,function(e){return en(e)},!0),t("scrollbarStyle","native",function(e){rn(e),en(e),e.display.scrollbars.setScrollTop(e.doc.scrollTop),e.display.scrollbars.setScrollLeft(e.doc.scrollLeft)},!0),t("lineNumbers",!1,function(e){Fn(e.options),Uo(e)},!0),t("firstLineNumber",1,Uo,!0),t("lineNumberFormatter",function(e){return e},Uo,!0),t("showCursorWhenSelecting",!1,kr,!0),t("resetSelectionOnContextMenu",!0),t("lineWiseCopyCut",!0),t("pasteLinesPerSelection",!0),t("readOnly",!1,function(e,t){"nocursor"==t&&(Fr(e),e.display.input.blur()),e.display.input.readOnlyChanged(t)}),t("disableInput",!1,function(e,t){t||e.display.input.reset()},!0),t("dragDrop",!0,Vo),t("allowDropFileTypes",null),t("cursorBlinkRate",530),t("cursorScrollMargin",0),t("cursorHeight",1,kr,!0),t("singleCursorHeightPerLine",!0,kr,!0),t("workTime",100),t("workDelay",100),t("flattenSpans",!0,Xn,!0),t("addModeClass",!1,Xn,!0),t("pollInterval",100),t("undoDepth",200,function(e,t){return e.doc.history.undoDepth=t}),t("historyEventDelay",1250),t("viewportMargin",10,function(e){return e.refresh()},!0),t("maxHighlightLength",1e4,Xn,!0),t("moveInputWithCursor",!0,function(e,t){t||e.display.input.resetPosition()}),t("tabindex",null,function(e,t){return e.display.input.getField().tabIndex=t||""}),t("autofocus",null),t("direction","ltr",function(e,t){return e.doc.setDirection(t)},!0)}(jo),function(e){var t=e.optionHandlers,r=e.helpers={};e.prototype={constructor:e,focus:function(){window.focus(),this.display.input.focus()},setOption:function(e,r){var n=this.options,i=n[e];n[e]==r&&"mode"!=e||(n[e]=r,t.hasOwnProperty(e)&&dn(this,t[e])(this,r,i),Te(this,"optionChange",this,e))},getOption:function(e){return this.options[e]},getDoc:function(){return this.doc},addKeyMap:function(e,t){this.state.keyMaps[t?"push":"unshift"](uo(e))},removeKeyMap:function(e){for(var t=this.state.keyMaps,r=0;r<t.length;++r)if(t[r]==e||t[r].name==e)return t.splice(r,1),!0},addOverlay:pn(function(t,r){var n=t.token?t:e.getMode(this.options,t);if(n.startState)throw new Error("Overlays may not be stateful.");m(this.state.overlays,{mode:n,modeSpec:t,opaque:r&&r.opaque,priority:r&&r.priority||0},function(e){return e.priority}),this.state.modeGen++,vn(this)}),removeOverlay:pn(function(e){for(var t=this,r=this.state.overlays,n=0;n<r.length;++n){var i=r[n].modeSpec;if(i==e||"string"==typeof e&&i.name==e)return r.splice(n,1),t.state.modeGen++,void vn(t)}}),indentLine:pn(function(e,t,r){"string"!=typeof t&&"number"!=typeof t&&(t=null==t?this.options.smartIndent?"smart":"prev":t?"add":"subtract"),H(this.doc,e)&&Yo(this,e,t,r)}),indentSelection:pn(function(e){for(var t=this,r=this.doc.sel.ranges,n=-1,i=0;i<r.length;i++){var o=r[i];if(o.empty())o.head.line>n&&(Yo(t,o.head.line,e,!0),n=o.head.line,i==t.doc.sel.primIndex&&jr(t));else{var l=o.from(),s=o.to(),a=Math.max(n,l.line);n=Math.min(t.lastLine(),s.line-(s.ch?0:1))+1;for(var u=a;u<n;++u)Yo(t,u,e);var c=t.doc.sel.ranges;0==l.ch&&r.length==c.length&&c[i].from().ch>0&&gi(t.doc,i,new Ts(l,c[i].to()),Gl)}}}),getTokenAt:function(e,t){return Je(this,e,t)},getLineTokens:function(e,t){return Je(this,E(e),t,!0)},getTokenTypeAt:function(e){e=U(this.doc,e);var t,r=_e(this,M(this.doc,e.line)),n=0,i=(r.length-1)/2,o=e.ch;if(0==o)t=r[2];else for(;;){var l=n+i>>1;if((l?r[2*l-1]:0)>=o)i=l;else{if(!(r[2*l+1]<o)){t=r[2*l+2];break}n=l+1}}var s=t?t.indexOf("overlay "):-1;return s<0?t:0==s?null:t.slice(0,s-1)},getModeAt:function(t){var r=this.doc.mode;return r.innerMode?e.innerMode(r,this.getTokenAt(t).state).mode:r},getHelper:function(e,t){return this.getHelpers(e,t)[0]},getHelpers:function(e,t){var n=this,i=[];if(!r.hasOwnProperty(t))return i;var o=r[t],l=this.getModeAt(e);if("string"==typeof l[t])o[l[t]]&&i.push(o[l[t]]);else if(l[t])for(var s=0;s<l[t].length;s++){var a=o[l[t][s]];a&&i.push(a)}else l.helperType&&o[l.helperType]?i.push(o[l.helperType]):o[l.name]&&i.push(o[l.name]);for(var u=0;u<o._global.length;u++){var c=o._global[u];c.pred(l,n)&&-1==h(i,c.val)&&i.push(c.val)}return i},getStateAfter:function(e,t){var r=this.doc;return e=G(r,null==e?r.first+r.size-1:e),$e(this,e+1,t).state},cursorCoords:function(e,t){var r,n=this.doc.sel.primary();return r=null==e?n.head:"object"==typeof e?U(this.doc,e):e?n.from():n.to(),sr(this,r,t||"page")},charCoords:function(e,t){return lr(this,U(this.doc,e),t||"page")},coordsChar:function(e,t){return e=or(this,e,t||"page"),cr(this,e.left,e.top)},lineAtHeight:function(e,t){return e=or(this,{top:e,left:0},t||"page").top,D(this.doc,e+this.display.viewOffset)},heightAtLine:function(e,t,r){var n,i=!1;if("number"==typeof e){var o=this.doc.first+this.doc.size-1;e<this.doc.first?e=this.doc.first:e>o&&(e=o,i=!0),n=M(this.doc,e)}else n=e;return ir(this,n,{top:0,left:0},t||"page",r||i).top+(i?this.doc.height-ye(n):0)},defaultTextHeight:function(){return mr(this.display)},defaultCharWidth:function(){return yr(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(e,t,r,n,i){var o=this.display,l=(e=sr(this,U(this.doc,e))).bottom,s=e.left;if(t.style.position="absolute",t.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(t),o.sizer.appendChild(t),"over"==n)l=e.top;else if("above"==n||"near"==n){var a=Math.max(o.wrapper.clientHeight,this.doc.height),u=Math.max(o.sizer.clientWidth,o.lineSpace.clientWidth);("above"==n||e.bottom+t.offsetHeight>a)&&e.top>t.offsetHeight?l=e.top-t.offsetHeight:e.bottom+t.offsetHeight<=a&&(l=e.bottom),s+t.offsetWidth>u&&(s=u-t.offsetWidth)}t.style.top=l+"px",t.style.left=t.style.right="","right"==i?(s=o.sizer.clientWidth-t.offsetWidth,t.style.right="0px"):("left"==i?s=0:"middle"==i&&(s=(o.sizer.clientWidth-t.offsetWidth)/2),t.style.left=s+"px"),r&&Ur(this,{left:s,top:l,right:s+t.offsetWidth,bottom:l+t.offsetHeight})},triggerOnKeyDown:pn(Lo),triggerOnKeyPress:pn(Mo),triggerOnKeyUp:To,triggerOnMouseDown:pn(Oo),execCommand:function(e){if(Bs.hasOwnProperty(e))return Bs[e].call(null,this)},triggerElectric:pn(function(e){Zo(this,e)}),findPosH:function(e,t,r,n){var i=this,o=1;t<0&&(o=-1,t=-t);for(var l=U(this.doc,e),s=0;s<t&&!(l=tl(i.doc,l,o,r,n)).hitSide;++s);return l},moveH:pn(function(e,t){var r=this;this.extendSelectionsBy(function(n){return r.display.shift||r.doc.extend||n.empty()?tl(r.doc,n.head,e,t,r.options.rtlMoveVisually):e<0?n.from():n.to()},Vl)}),deleteH:pn(function(e,t){var r=this.doc.sel,n=this.doc;r.somethingSelected()?n.replaceSelection("",null,"+delete"):co(this,function(r){var i=tl(n,r.head,e,t,!1);return e<0?{from:i,to:r.head}:{from:r.head,to:i}})}),findPosV:function(e,t,r,n){var i=this,o=1,l=n;t<0&&(o=-1,t=-t);for(var s=U(this.doc,e),a=0;a<t;++a){var u=sr(i,s,"div");if(null==l?l=u.left:u.left=l,(s=rl(i,u,o,r)).hitSide)break}return s},moveV:pn(function(e,t){var r=this,n=this.doc,i=[],o=!this.display.shift&&!n.extend&&n.sel.somethingSelected();if(n.extendSelectionsBy(function(l){if(o)return e<0?l.from():l.to();var s=sr(r,l.head,"div");null!=l.goalColumn&&(s.left=l.goalColumn),i.push(s.left);var a=rl(r,s,e,t);return"page"==t&&l==n.sel.primary()&&Kr(r,lr(r,a,"div").top-s.top),a},Vl),i.length)for(var l=0;l<n.sel.ranges.length;l++)n.sel.ranges[l].goalColumn=i[l]}),findWordAt:function(e){var t=M(this.doc,e.line).text,r=e.ch,n=e.ch;if(t){var i=this.getHelper(e,"wordChars");"before"!=e.sticky&&n!=t.length||!r?++n:--r;for(var o=t.charAt(r),l=x(o,i)?function(e){return x(e,i)}:/\s/.test(o)?function(e){return/\s/.test(e)}:function(e){return!/\s/.test(e)&&!x(e)};r>0&&l(t.charAt(r-1));)--r;for(;n<t.length&&l(t.charAt(n));)++n}return new Ts(E(e.line,r),E(e.line,n))},toggleOverwrite:function(e){null!=e&&e==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?s(this.display.cursorDiv,"CodeMirror-overwrite"):Fl(this.display.cursorDiv,"CodeMirror-overwrite"),Te(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==l()},isReadOnly:function(){return!(!this.options.readOnly&&!this.doc.cantEdit)},scrollTo:pn(function(e,t){Xr(this,e,t)}),getScrollInfo:function(){var e=this.display.scroller;return{left:e.scrollLeft,top:e.scrollTop,height:e.scrollHeight-zt(this)-this.display.barHeight,width:e.scrollWidth-zt(this)-this.display.barWidth,clientHeight:Bt(this),clientWidth:Rt(this)}},scrollIntoView:pn(function(e,t){null==e?(e={from:this.doc.sel.primary().head,to:null},null==t&&(t=this.options.cursorScrollMargin)):"number"==typeof e?e={from:E(e,0),to:null}:null==e.from&&(e={from:e,to:null}),e.to||(e.to=e.from),e.margin=t||0,null!=e.from.line?Yr(this,e):$r(this,e.from,e.to,e.margin)}),setSize:pn(function(e,t){var r=this,n=function(e){return"number"==typeof e||/^\d+$/.test(String(e))?e+"px":e};null!=e&&(this.display.wrapper.style.width=n(e)),null!=t&&(this.display.wrapper.style.height=n(t)),this.options.lineWrapping&&Jt(this);var i=this.display.viewFrom;this.doc.iter(i,this.display.viewTo,function(e){if(e.widgets)for(var t=0;t<e.widgets.length;t++)if(e.widgets[t].noHScroll){mn(r,i,"widget");break}++i}),this.curOp.forceUpdate=!0,Te(this,"refresh",this)}),operation:function(e){return hn(this,e)},startOperation:function(){return nn(this)},endOperation:function(){return on(this)},refresh:pn(function(){var e=this.display.cachedTextHeight;vn(this),this.curOp.forceUpdate=!0,er(this),Xr(this,this.doc.scrollLeft,this.doc.scrollTop),Wn(this),(null==e||Math.abs(e-mr(this.display))>.5)&&Cr(this),Te(this,"refresh",this)}),swapDoc:pn(function(e){var t=this.doc;return t.cm=null,qn(this,e),er(this),this.display.input.reset(),Xr(this,e.scrollLeft,e.scrollTop),this.curOp.forceScroll=!0,bt(this,"swapDoc",this,t),t}),getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},Ae(e),e.registerHelper=function(t,n,i){r.hasOwnProperty(t)||(r[t]=e[t]={_global:[]}),r[t][n]=i},e.registerGlobalHelper=function(t,n,i,o){e.registerHelper(t,n,o),r[t]._global.push({pred:i,val:o})}}(jo);var Js="iter insert remove copy getEditor constructor".split(" ");for(var ea in Ds.prototype)Ds.prototype.hasOwnProperty(ea)&&h(Js,ea)<0&&(jo.prototype[ea]=function(e){return function(){return e.apply(this.doc,arguments)}}(Ds.prototype[ea]));return Ae(Ds),jo.inputStyles={textarea:Qs,contenteditable:Zs},jo.defineMode=function(e){jo.defaults.mode||"null"==e||(jo.defaults.mode=e),Be.apply(this,arguments)},jo.defineMIME=function(e,t){os[e]=t},jo.defineMode("null",function(){return{token:function(e){return e.skipToEnd()}}}),jo.defineMIME("text/plain","null"),jo.defineExtension=function(e,t){jo.prototype[e]=t},jo.defineDocExtension=function(e,t){Ds.prototype[e]=t},jo.fromTextArea=function(e,t){function r(){e.value=a.getValue()}if(t=t?c(t):{},t.value=e.value,!t.tabindex&&e.tabIndex&&(t.tabindex=e.tabIndex),!t.placeholder&&e.placeholder&&(t.placeholder=e.placeholder),null==t.autofocus){var n=l();t.autofocus=n==e||null!=e.getAttribute("autofocus")&&n==document.body}var i;if(e.form&&(Ql(e.form,"submit",r),!t.leaveSubmitMethodAlone)){var o=e.form;i=o.submit;try{var s=o.submit=function(){r(),o.submit=i,o.submit(),o.submit=s}}catch(e){}}t.finishInit=function(t){t.save=r,t.getTextArea=function(){return e},t.toTextArea=function(){t.toTextArea=isNaN,r(),e.parentNode.removeChild(t.getWrapperElement()),e.style.display="",e.form&&(ke(e.form,"submit",r),"function"==typeof e.form.submit&&(e.form.submit=i))}},e.style.display="none";var a=jo(function(t){return e.parentNode.insertBefore(t,e.nextSibling)},t);return a},function(e){e.off=ke,e.on=Ql,e.wheelEventPixels=Pn,e.Doc=Ds,e.splitLines=es,e.countColumn=f,e.findColumn=d,e.isWordChar=w,e.Pass=Bl,e.signal=Te,e.Line=fs,e.changeEnd=Bn,e.scrollbarModel=ws,e.Pos=E,e.cmpPos=P,e.modes=is,e.mimeModes=os,e.resolveMode=Ge,e.getMode=Ue,e.modeExtensions=ls,e.extendMode=Ve,e.copyState=Ke,e.startState=Xe,e.innerMode=je,e.commands=Bs,e.keyMap=Rs,e.keyName=ao,e.isModifierKey=lo,e.lookupKey=oo,e.normalizeKeyMap=io,e.StringStream=ss,e.SharedTextMarker=As,e.TextMarker=Os,e.LineWidget=Ms,e.e_preventDefault=We,e.e_stopPropagation=De,e.e_stop=Fe,e.addClass=s,e.contains=o,e.rmClass=Fl,e.keyNames=Es}(jo),jo.version="5.30.0",jo});
      !function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){"use strict";function t(e,t,n,r,o,a){this.indented=e,this.column=t,this.type=n,this.info=r,this.align=o,this.prev=a}function n(e,n,r,o){var a=e.indented;return e.context&&"statement"==e.context.type&&"statement"!=r&&(a=e.context.indented),e.context=new t(a,n,r,o,null,e.context)}function r(e){var t=e.context.type;return")"!=t&&"]"!=t&&"}"!=t||(e.indented=e.context.indented),e.context=e.context.prev}function o(e,t,n){return"variable"==t.prevToken||"type"==t.prevToken||(!!/\S(?:[^- ]>|[*\]])\s*$|\*$/.test(e.string.slice(0,n))||(!(!t.typeAtEndOfLine||e.column()!=e.indentation())||void 0))}function a(e){for(;;){if(!e||"top"==e.type)return!0;if("}"==e.type&&"namespace"!=e.prev.info)return!1;e=e.prev}}function i(e){for(var t={},n=e.split(" "),r=0;r<n.length;++r)t[n[r]]=!0;return t}function l(e,t){return"function"==typeof e?e(t):e.propertyIsEnumerable(t)}function s(e,t){if(!t.startOfLine)return!1;for(var n,r=null;n=e.peek();){if("\\"==n&&e.match(/^.$/)){r=s;break}if("/"==n&&e.match(/^\/[\/\*]/,!1))break;e.next()}return t.tokenize=r,"meta"}function c(e,t){return"type"==t.prevToken&&"type"}function u(e){return e.eatWhile(/[\w\.']/),"number"}function d(e,t){if(e.backUp(1),e.match(/(R|u8R|uR|UR|LR)/)){var n=e.match(/"([^\s\\()]{0,16})\(/);return!!n&&(t.cpp11RawStringDelim=n[1],t.tokenize=m,m(e,t))}return e.match(/(u8|u|U|L)/)?!!e.match(/["']/,!1)&&"string":(e.next(),!1)}function f(e){var t=/(\w+)::~?(\w+)$/.exec(e);return t&&t[1]==t[2]}function p(e,t){for(var n;null!=(n=e.next());)if('"'==n&&!e.eat('"')){t.tokenize=null;break}return"string"}function m(e,t){var n=t.cpp11RawStringDelim.replace(/[^\w\s]/g,"\\$&");return e.match(new RegExp(".*?\\)"+n+'"'))?t.tokenize=null:e.skipToEnd(),"string"}function h(t,n){function r(e){if(e)for(var t in e)e.hasOwnProperty(t)&&o.push(t)}"string"==typeof t&&(t=[t]);var o=[];r(n.keywords),r(n.types),r(n.builtin),r(n.atoms),o.length&&(n.helperType=t[0],e.registerHelper("hintWords",t[0],o));for(var a=0;a<t.length;++a)e.defineMIME(t[a],n)}function g(e,t){for(var n=!1;!e.eol();){if(!n&&e.match('"""')){t.tokenize=null;break}n="\\"==e.next()&&!n}return"string"}function y(e){return function(t,n){for(var r,o=!1,a=!1;!t.eol();){if(!e&&!o&&t.match('"')){a=!0;break}if(e&&t.match('"""')){a=!0;break}r=t.next(),!o&&"$"==r&&t.match("{")&&t.skipTo("}"),o=!o&&"\\"==r&&!e}return!a&&e||(n.tokenize=null),"string"}}function x(e){return function(t,n){for(var r,o=!1,a=!1;!t.eol();){if(!o&&t.match('"')&&("single"==e||t.match('""'))){a=!0;break}if(!o&&t.match("``")){w=x(e),a=!0;break}r=t.next(),o="single"==e&&!o&&"\\"==r}return a&&(n.tokenize=null),"string"}}e.defineMode("clike",function(i,s){function c(e,t){var n=e.next();if(S[n]){var r=S[n](e,t);if(!1!==r)return r}if('"'==n||"'"==n)return t.tokenize=u(n),t.tokenize(e,t);if(D.test(n))return p=n,null;if(L.test(n)){if(e.backUp(1),e.match(I))return"number";e.next()}if("/"==n){if(e.eat("*"))return t.tokenize=d,d(e,t);if(e.eat("/"))return e.skipToEnd(),"comment"}if(F.test(n)){for(;!e.match(/^\/[\/*]/,!1)&&e.eat(F););return"operator"}if(e.eatWhile(z),P)for(;e.match(P);)e.eatWhile(z);var o=e.current();return l(x,o)?(l(w,o)&&(p="newstatement"),l(v,o)&&(m=!0),"keyword"):l(b,o)?"type":l(k,o)?(l(w,o)&&(p="newstatement"),"builtin"):l(_,o)?"atom":"variable"}function u(e){return function(t,n){for(var r,o=!1,a=!1;null!=(r=t.next());){if(r==e&&!o){a=!0;break}o=!o&&"\\"==r}return(a||!o&&!C)&&(n.tokenize=null),"string"}}function d(e,t){for(var n,r=!1;n=e.next();){if("/"==n&&r){t.tokenize=null;break}r="*"==n}return"comment"}function f(e,t){s.typeFirstDefinitions&&e.eol()&&a(t.context)&&(t.typeAtEndOfLine=o(e,t,e.pos))}var p,m,h=i.indentUnit,g=s.statementIndentUnit||h,y=s.dontAlignCalls,x=s.keywords||{},b=s.types||{},k=s.builtin||{},w=s.blockKeywords||{},v=s.defKeywords||{},_=s.atoms||{},S=s.hooks||{},C=s.multiLineStrings,T=!1!==s.indentStatements,M=!1!==s.indentSwitch,P=s.namespaceSeparator,D=s.isPunctuationChar||/[\[\]{}\(\),;\:\.]/,L=s.numberStart||/[\d\.]/,I=s.number||/^(?:0x[a-f\d]+|0b[01]+|(?:\d+\.?\d*|\.\d+)(?:e[-+]?\d+)?)(u|ll?|l|f)?/i,F=s.isOperatorChar||/[+\-*&%=<>!?|\/]/,z=s.isIdentifierChar||/[\w\$_\xa1-\uffff]/;return{startState:function(e){return{tokenize:null,context:new t((e||0)-h,0,"top",null,!1),indented:0,startOfLine:!0,prevToken:null}},token:function(e,t){var i=t.context;if(e.sol()&&(null==i.align&&(i.align=!1),t.indented=e.indentation(),t.startOfLine=!0),e.eatSpace())return f(e,t),null;p=m=null;var l=(t.tokenize||c)(e,t);if("comment"==l||"meta"==l)return l;if(null==i.align&&(i.align=!0),";"==p||":"==p||","==p&&e.match(/^\s*(?:\/\/.*)?$/,!1))for(;"statement"==t.context.type;)r(t);else if("{"==p)n(t,e.column(),"}");else if("["==p)n(t,e.column(),"]");else if("("==p)n(t,e.column(),")");else if("}"==p){for(;"statement"==i.type;)i=r(t);for("}"==i.type&&(i=r(t));"statement"==i.type;)i=r(t)}else p==i.type?r(t):T&&(("}"==i.type||"top"==i.type)&&";"!=p||"statement"==i.type&&"newstatement"==p)&&n(t,e.column(),"statement",e.current());if("variable"==l&&("def"==t.prevToken||s.typeFirstDefinitions&&o(e,t,e.start)&&a(t.context)&&e.match(/^\s*\(/,!1))&&(l="def"),S.token){var u=S.token(e,t,l);void 0!==u&&(l=u)}return"def"==l&&!1===s.styleDefs&&(l="variable"),t.startOfLine=!1,t.prevToken=m?"def":l||p,f(e,t),l},indent:function(t,n){if(t.tokenize!=c&&null!=t.tokenize||t.typeAtEndOfLine)return e.Pass;var r=t.context,o=n&&n.charAt(0);if("statement"==r.type&&"}"==o&&(r=r.prev),s.dontIndentStatements)for(;"statement"==r.type&&s.dontIndentStatements.test(r.info);)r=r.prev;if(S.indent){var a=S.indent(t,r,n);if("number"==typeof a)return a}var i=o==r.type,l=r.prev&&"switch"==r.prev.info;if(s.allmanIndentation&&/[{(]/.test(o)){for(;"top"!=r.type&&"}"!=r.type;)r=r.prev;return r.indented}return"statement"==r.type?r.indented+("{"==o?0:g):!r.align||y&&")"==r.type?")"!=r.type||i?r.indented+(i?0:h)+(i||!l||/^(?:case|default)\b/.test(n)?0:h):r.indented+g:r.column+(i?0:1)},electricInput:M?/^\s*(?:case .*?:|default:|\{\}?|\})$/:/^\s*[{}]$/,blockCommentStart:"/*",blockCommentEnd:"*/",lineComment:"//",fold:"brace"}});var b="auto if break case register continue return default do sizeof static else struct switch extern typedef union for goto while enum const volatile",k="int long char short double float unsigned signed void size_t ptrdiff_t";h(["text/x-csrc","text/x-c","text/x-chdr"],{name:"clike",keywords:i(b),types:i(k+" bool _Complex _Bool float_t double_t intptr_t intmax_t int8_t int16_t int32_t int64_t uintptr_t uintmax_t uint8_t uint16_t uint32_t uint64_t"),blockKeywords:i("case do else for if switch while struct"),defKeywords:i("struct"),typeFirstDefinitions:!0,atoms:i("null true false"),hooks:{"#":s,"*":c},modeProps:{fold:["brace","include"]}}),h(["text/x-c++src","text/x-c++hdr"],{name:"clike",keywords:i(b+" asm dynamic_cast namespace reinterpret_cast try explicit new static_cast typeid catch operator template typename class friend private this using const_cast inline public throw virtual delete mutable protected alignas alignof constexpr decltype nullptr noexcept thread_local final static_assert override"),types:i(k+" bool wchar_t"),blockKeywords:i("catch class do else finally for if struct switch try while"),defKeywords:i("class namespace struct enum union"),typeFirstDefinitions:!0,atoms:i("true false null"),dontIndentStatements:/^template$/,isIdentifierChar:/[\w\$_~\xa1-\uffff]/,hooks:{"#":s,"*":c,u:d,U:d,L:d,R:d,0:u,1:u,2:u,3:u,4:u,5:u,6:u,7:u,8:u,9:u,token:function(e,t,n){if("variable"==n&&"("==e.peek()&&(";"==t.prevToken||null==t.prevToken||"}"==t.prevToken)&&f(e.current()))return"def"}},namespaceSeparator:"::",modeProps:{fold:["brace","include"]}}),h("text/x-java",{name:"clike",keywords:i("abstract assert break case catch class const continue default do else enum extends final finally float for goto if implements import instanceof interface native new package private protected public return static strictfp super switch synchronized this throw throws transient try volatile while @interface"),types:i("byte short int long float double boolean char void Boolean Byte Character Double Float Integer Long Number Object Short String StringBuffer StringBuilder Void"),blockKeywords:i("catch class do else finally for if switch try while"),defKeywords:i("class interface package enum @interface"),typeFirstDefinitions:!0,atoms:i("true false null"),number:/^(?:0x[a-f\d_]+|0b[01_]+|(?:[\d_]+\.?\d*|\.\d+)(?:e[-+]?[\d_]+)?)(u|ll?|l|f)?/i,hooks:{"@":function(e){return!e.match("interface",!1)&&(e.eatWhile(/[\w\$_]/),"meta")}},modeProps:{fold:["brace","import"]}}),h("text/x-csharp",{name:"clike",keywords:i("abstract as async await base break case catch checked class const continue default delegate do else enum event explicit extern finally fixed for foreach goto if implicit in interface internal is lock namespace new operator out override params private protected public readonly ref return sealed sizeof stackalloc static struct switch this throw try typeof unchecked unsafe using virtual void volatile while add alias ascending descending dynamic from get global group into join let orderby partial remove select set value var yield"),types:i("Action Boolean Byte Char DateTime DateTimeOffset Decimal Double Func Guid Int16 Int32 Int64 Object SByte Single String Task TimeSpan UInt16 UInt32 UInt64 bool byte char decimal double short int long object sbyte float string ushort uint ulong"),blockKeywords:i("catch class do else finally for foreach if struct switch try while"),defKeywords:i("class interface namespace struct var"),typeFirstDefinitions:!0,atoms:i("true false null"),hooks:{"@":function(e,t){return e.eat('"')?(t.tokenize=p,p(e,t)):(e.eatWhile(/[\w\$_]/),"meta")}}}),h("text/x-scala",{name:"clike",keywords:i("abstract case catch class def do else extends final finally for forSome if implicit import lazy match new null object override package private protected return sealed super this throw trait try type val var while with yield _ assert assume require print println printf readLine readBoolean readByte readShort readChar readInt readLong readFloat readDouble"),types:i("AnyVal App Application Array BufferedIterator BigDecimal BigInt Char Console Either Enumeration Equiv Error Exception Fractional Function IndexedSeq Int Integral Iterable Iterator List Map Numeric Nil NotNull Option Ordered Ordering PartialFunction PartialOrdering Product Proxy Range Responder Seq Serializable Set Specializable Stream StringBuilder StringContext Symbol Throwable Traversable TraversableOnce Tuple Unit Vector Boolean Byte Character CharSequence Class ClassLoader Cloneable Comparable Compiler Double Exception Float Integer Long Math Number Object Package Pair Process Runtime Runnable SecurityManager Short StackTraceElement StrictMath String StringBuffer System Thread ThreadGroup ThreadLocal Throwable Triple Void"),multiLineStrings:!0,blockKeywords:i("catch class enum do else finally for forSome if match switch try while"),defKeywords:i("class enum def object package trait type val var"),atoms:i("true false null"),indentStatements:!1,indentSwitch:!1,isOperatorChar:/[+\-*&%=<>!?|\/#:@]/,hooks:{"@":function(e){return e.eatWhile(/[\w\$_]/),"meta"},'"':function(e,t){return!!e.match('""')&&(t.tokenize=g,t.tokenize(e,t))},"'":function(e){return e.eatWhile(/[\w\$_\xa1-\uffff]/),"atom"},"=":function(e,n){var r=n.context;return!("}"!=r.type||!r.align||!e.eat(">"))&&(n.context=new t(r.indented,r.column,r.type,r.info,null,r.prev),"operator")}},modeProps:{closeBrackets:{triples:'"'}}}),h("text/x-kotlin",{name:"clike",keywords:i("package as typealias class interface this super val var fun for is in This throw return break continue object if else while do try when !in !is as? file import where by get set abstract enum open inner override private public internal protected catch finally out final vararg reified dynamic companion constructor init sealed field property receiver param sparam lateinit data inline noinline tailrec external annotation crossinline const operator infix suspend"),types:i("Boolean Byte Character CharSequence Class ClassLoader Cloneable Comparable Compiler Double Exception Float Integer Long Math Number Object Package Pair Process Runtime Runnable SecurityManager Short StackTraceElement StrictMath String StringBuffer System Thread ThreadGroup ThreadLocal Throwable Triple Void"),intendSwitch:!1,indentStatements:!1,multiLineStrings:!0,number:/^(?:0x[a-f\d_]+|0b[01_]+|(?:[\d_]+\.?\d*|\.\d+)(?:e[-+]?[\d_]+)?)(u|ll?|l|f)?/i,blockKeywords:i("catch class do else finally for if where try while enum"),defKeywords:i("class val var object package interface fun"),atoms:i("true false null this"),hooks:{'"':function(e,t){return t.tokenize=y(e.match('""')),t.tokenize(e,t)}},modeProps:{closeBrackets:{triples:'"'}}}),h(["x-shader/x-vertex","x-shader/x-fragment"],{name:"clike",keywords:i("sampler1D sampler2D sampler3D samplerCube sampler1DShadow sampler2DShadow const attribute uniform varying break continue discard return for while do if else struct in out inout"),types:i("float int bool void vec2 vec3 vec4 ivec2 ivec3 ivec4 bvec2 bvec3 bvec4 mat2 mat3 mat4"),blockKeywords:i("for while do if else struct"),builtin:i("radians degrees sin cos tan asin acos atan pow exp log exp2 sqrt inversesqrt abs sign floor ceil fract mod min max clamp mix step smoothstep length distance dot cross normalize ftransform faceforward reflect refract matrixCompMult lessThan lessThanEqual greaterThan greaterThanEqual equal notEqual any all not texture1D texture1DProj texture1DLod texture1DProjLod texture2D texture2DProj texture2DLod texture2DProjLod texture3D texture3DProj texture3DLod texture3DProjLod textureCube textureCubeLod shadow1D shadow2D shadow1DProj shadow2DProj shadow1DLod shadow2DLod shadow1DProjLod shadow2DProjLod dFdx dFdy fwidth noise1 noise2 noise3 noise4"),atoms:i("true false gl_FragColor gl_SecondaryColor gl_Normal gl_Vertex gl_MultiTexCoord0 gl_MultiTexCoord1 gl_MultiTexCoord2 gl_MultiTexCoord3 gl_MultiTexCoord4 gl_MultiTexCoord5 gl_MultiTexCoord6 gl_MultiTexCoord7 gl_FogCoord gl_PointCoord gl_Position gl_PointSize gl_ClipVertex gl_FrontColor gl_BackColor gl_FrontSecondaryColor gl_BackSecondaryColor gl_TexCoord gl_FogFragCoord gl_FragCoord gl_FrontFacing gl_FragData gl_FragDepth gl_ModelViewMatrix gl_ProjectionMatrix gl_ModelViewProjectionMatrix gl_TextureMatrix gl_NormalMatrix gl_ModelViewMatrixInverse gl_ProjectionMatrixInverse gl_ModelViewProjectionMatrixInverse gl_TexureMatrixTranspose gl_ModelViewMatrixInverseTranspose gl_ProjectionMatrixInverseTranspose gl_ModelViewProjectionMatrixInverseTranspose gl_TextureMatrixInverseTranspose gl_NormalScale gl_DepthRange gl_ClipPlane gl_Point gl_FrontMaterial gl_BackMaterial gl_LightSource gl_LightModel gl_FrontLightModelProduct gl_BackLightModelProduct gl_TextureColor gl_EyePlaneS gl_EyePlaneT gl_EyePlaneR gl_EyePlaneQ gl_FogParameters gl_MaxLights gl_MaxClipPlanes gl_MaxTextureUnits gl_MaxTextureCoords gl_MaxVertexAttribs gl_MaxVertexUniformComponents gl_MaxVaryingFloats gl_MaxVertexTextureImageUnits gl_MaxTextureImageUnits gl_MaxFragmentUniformComponents gl_MaxCombineTextureImageUnits gl_MaxDrawBuffers"),indentSwitch:!1,hooks:{"#":s},modeProps:{fold:["brace","include"]}}),h("text/x-nesc",{name:"clike",keywords:i(b+"as atomic async call command component components configuration event generic implementation includes interface module new norace nx_struct nx_union post provides signal task uses abstract extends"),types:i(k),blockKeywords:i("case do else for if switch while struct"),atoms:i("null true false"),hooks:{"#":s},modeProps:{fold:["brace","include"]}}),h("text/x-objectivec",{name:"clike",keywords:i(b+"inline restrict _Bool _Complex _Imaginary BOOL Class bycopy byref id IMP in inout nil oneway out Protocol SEL self super atomic nonatomic retain copy readwrite readonly"),types:i(k),atoms:i("YES NO NULL NILL ON OFF true false"),hooks:{"@":function(e){return e.eatWhile(/[\w\$]/),"keyword"},"#":s,indent:function(e,t,n){if("statement"==t.type&&/^@\w/.test(n))return t.indented}},modeProps:{fold:"brace"}}),h("text/x-squirrel",{name:"clike",keywords:i("base break clone continue const default delete enum extends function in class foreach local resume return this throw typeof yield constructor instanceof static"),types:i(k),blockKeywords:i("case catch class else for foreach if switch try while"),defKeywords:i("function local class"),typeFirstDefinitions:!0,atoms:i("true false null"),hooks:{"#":s},modeProps:{fold:["brace","include"]}});var w=null;h("text/x-ceylon",{name:"clike",keywords:i("abstracts alias assembly assert assign break case catch class continue dynamic else exists extends finally for function given if import in interface is let module new nonempty object of out outer package return satisfies super switch then this throw try value void while"),types:function(e){var t=e.charAt(0);return t===t.toUpperCase()&&t!==t.toLowerCase()},blockKeywords:i("case catch class dynamic else finally for function if interface module new object switch try while"),defKeywords:i("class dynamic function interface module object package value"),builtin:i("abstract actual aliased annotation by default deprecated doc final formal late license native optional sealed see serializable shared suppressWarnings tagged throws variable"),isPunctuationChar:/[\[\]{}\(\),;\:\.`]/,isOperatorChar:/[+\-*&%=<>!?|^~:\/]/,numberStart:/[\d#$]/,number:/^(?:#[\da-fA-F_]+|\$[01_]+|[\d_]+[kMGTPmunpf]?|[\d_]+\.[\d_]+(?:[eE][-+]?\d+|[kMGTPmunpf]|)|)/i,multiLineStrings:!0,typeFirstDefinitions:!0,atoms:i("true false null larger smaller equal empty finished"),indentSwitch:!1,styleDefs:!1,hooks:{"@":function(e){return e.eatWhile(/[\w\$_]/),"meta"},'"':function(e,t){return t.tokenize=x(e.match('""')?"triple":"single"),t.tokenize(e,t)},"`":function(e,t){return!(!w||!e.match("`"))&&(t.tokenize=w,w=null,t.tokenize(e,t))},"'":function(e){return e.eatWhile(/[\w\$_\xa1-\uffff]/),"atom"},token:function(e,t,n){if(("variable"==n||"type"==n)&&"."==t.prevToken)return"variable-2"}},modeProps:{fold:["brace","import"],closeBrackets:{triples:'"'}}})});
      // -------------------------------------------------------------------------
//  Part of the CodeChecker project, under the Apache License v2.0 with
//  LLVM Exceptions. See LICENSE for license information.
//  SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
// -------------------------------------------------------------------------

var BugViewer = {
  _files : [],
  _reports : [],
  _lineWidgets : [],
  _navigationMenuItems : [],
  _sourceFileData : null,
  _currentReport : null,
  _lastBugEvent  : null,

  init : function (files, reports) {
    this._files = files;
    this._reports = reports;

    this.initEscapeChars();
  },

  initEscapeChars : function () {
    this.escapeChars = {
      ' ' : 'nbsp',
      '<' : 'lt',
      '>' : 'gt',
      '"' : 'quot',
      '&' : 'amp'
    };

    var regexString = '[';
    for (var key in this.escapeChars) {
      regexString += key;
    }
    regexString += ']';

    this.escapeRegExp = new RegExp( regexString, 'g');
  },

  escapeHTML : function (str) {
    var that = this;

    return str.replace(this.escapeRegExp, function (m) {
      return '&' + that.escapeChars[m] + ';';
    });
  },

  initByUrl : function () {
    if (!this._reports) return;

    var state = {};
    window.location.hash.substr(1).split('&').forEach(function (s) {
      var parts = s.split('=');
      state[parts[0]] = parts[1];
    });

    for (var key in this._reports) {
      var report = this._reports[key];
      if (report.reportHash === state['reportHash']) {
        this.navigate(report);
        return;
      }
    }

    this.navigate(this._reports[0]);
  },

  create : function () {
    this._content = document.getElementById('editor-wrapper');
    this._filepath = document.getElementById('file-path');
    this._checkerName = document.getElementById('checker-name');
    this._reviewStatusWrapper =
      document.getElementById('review-status-wrapper');
    this._reviewStatus = document.getElementById('review-status');
    this._editor = document.getElementById('editor');

    this._codeMirror = CodeMirror(this._editor, {
      mode: 'text/x-c++src',
      matchBrackets : true,
      lineNumbers : true,
      readOnly : true,
      foldGutter : true,
      extraKeys : {},
      viewportMargin : 100
    });

    this._createNavigationMenu();
  },

  navigate : function (report, item) {
    if (!item) {
      var items = this._navigationMenuItems.filter(function (navItem) {
        return navItem.report.reportHash === report.reportHash;
      });

      if (!items.length) return;

      item = items[0].widget;
    }

    this._selectedReport.classList.remove('active');
    this._selectedReport = item;
    this._selectedReport.classList.add('active');
    this.setReport(report);
  },

  _createNavigationMenu : function () {
    var that = this;

    var nav = document.getElementById('report-nav');
    var list = document.createElement('ul');
    this._reports.forEach(function (report) {
      var events = report['events'];
      var lastBugEvent = events[events.length - 1];
      var item = document.createElement('li');

      var severity = document.createElement('i');
      severity.className = 'severity-' + report.severity.toLowerCase();

      item.appendChild(severity);
      item.appendChild(document.createTextNode(lastBugEvent.message));

      item.addEventListener('click', function () {
        that.navigate(report, item);
      })
      list.appendChild(item);
      that._navigationMenuItems.push({ report : report, widget : item });
    });

    if (!this._selectedReport && list.childNodes.length) {
      this._selectedReport = list.childNodes[0];
      this._selectedReport.classList.add('active');
    }

    nav.appendChild(list);
  },

  setReport : function (report) {
    this._currentReport = report;
    var events = report['events'];
    var lastBugEvent = events[events.length - 1];
    this.setCurrentBugEvent(lastBugEvent, events.length - 1);
    this.setCheckerName(report.checkerName);
    this.setReviewStatus(report.reviewStatus);

    window.location.hash = '#reportHash=' + report.reportHash;
  },

  setCurrentBugEvent : function (event, idx) {
    this._currentBugEvent = event;
    this.setSourceFileData(this._files[event.location.file]);
    this.drawBugPath();

    this.jumpTo(event.location.line, 0);
    this.highlightBugEvent(event, idx);
  },

  highlightBugEvent : function (event, idx) {
    this._lineWidgets.forEach(function (widget) {
      var lineIdx = widget.node.getAttribute('idx');
      if (parseInt(lineIdx) === idx) {
        widget.node.classList.add('current');
      }
    });
  },

  setCheckerName : function (checkerName) {
    this._checkerName.innerHTML = checkerName;
  },

  setReviewStatus : function (status) {
    if (status) {
      var className =
        'review-status-' + status.toLowerCase().split(' ').join('-');
      this._reviewStatus.className = "review-status " + className;

      this._reviewStatus.innerHTML = status;
      this._reviewStatusWrapper.style.display = 'block';
    } else {
      this._reviewStatusWrapper.style.display = 'none';
    }
  },

  setSourceFileData : function (file) {
    if (this._sourceFileData && file.id === this._sourceFileData.id) {
      return;
    }

    this._sourceFileData = file;
    this._filepath.innerHTML = file.path;
    this._codeMirror.doc.setValue(file.content);
    this._refresh();
  },

  _refresh : function () {
    var that = this;
    setTimeout(function () {
      var fullHeight = parseInt(that._content.clientHeight);
      var headerHeight = that._filepath.clientHeight;

      that._codeMirror.setSize('auto', fullHeight - headerHeight);
      that._codeMirror.refresh();
    }, 200);
  },

  clearBubbles : function () {
    this._lineWidgets.forEach(function (widget) { widget.clear(); });
    this._lineWidgets = [];
  },

  getMessage : function (event, kind) {
    if (kind === 'macro') {
      var name = 'macro expansion' + (event.name ? ': ' + event.name : '');

      return '<span class="tag macro">' + name + '</span>'
        + this.escapeHTML(event.expansion).replace(/(?:\r\n|\r|\n)/g, '<br>');
    } else if (kind === 'note') {
      return '<span class="tag note">note</span>'
        +  this.escapeHTML(event.message).replace(/(?:\r\n|\r|\n)/g, '<br>');
    }
  },

  addExtraPathEvents : function (events, kind) {
    var that = this;

    if (!events) {
      return;
    }

    events.forEach(function (event) {
      if (event.location.file !== that._currentBugEvent.location.file) {
        return;
      }

      var left =
        that._codeMirror.defaultCharWidth() * event.location.col + 'px';

      var element = document.createElement('div');
      element.setAttribute('style', 'margin-left: ' + left);
      element.setAttribute('class', 'check-msg ' + kind);

      var msg = document.createElement('span');
      msg.innerHTML = that.getMessage(event, kind);
      element.appendChild(msg);

      that._lineWidgets.push(that._codeMirror.addLineWidget(
        event.location.line - 1, element));
    });
  },

  drawBugPath : function () {
    var that = this;

    this.clearBubbles();

    this.addExtraPathEvents(this._currentReport.macros, 'macro');
    this.addExtraPathEvents(this._currentReport.notes, 'note');

    // Processing bug path events.
    var currentEvents = this._currentReport.events;
    currentEvents.forEach(function (event, step) {
      if (event.location.file !== that._currentBugEvent.location.file)
        return;

      var left =
        that._codeMirror.defaultCharWidth() * event.location.col + 'px';
      var type = step === currentEvents.length - 1 ? 'error' : 'info';

      var element = document.createElement('div');
      element.setAttribute('style', 'margin-left: ' + left);
      element.setAttribute('class', 'check-msg ' + type);
      element.setAttribute('idx', step);

      var enumeration = document.createElement('span');
      enumeration.setAttribute('class', 'checker-enum ' + type);
      enumeration.innerHTML = step + 1;

      if (currentEvents.length > 1)
        element.appendChild(enumeration);

      var prevBugEvent = step - 1;
      if (step > 0) {
        var prevBug = document.createElement('span');
        prevBug.setAttribute('class', 'arrow left-arrow');
        prevBug.addEventListener('click', function () {
          var event = currentEvents[prevBugEvent];
          that.setCurrentBugEvent(event, prevBugEvent);
        });
        element.appendChild(prevBug);
      }

      var msg = document.createElement('span');
      msg.innerHTML = that.escapeHTML(event.message)
        .replace(/(?:\r\n|\r|\n)/g, '<br>');

      element.appendChild(msg);

      var nextBugEvent = step + 1;
      if (nextBugEvent < currentEvents.length) {
        var nextBug = document.createElement('span');
        nextBug.setAttribute('class', 'arrow right-arrow');
        nextBug.addEventListener('click', function () {
          var event = currentEvents[nextBugEvent];
          that.setCurrentBugEvent(event, nextBugEvent);
        });
        element.appendChild(nextBug);
      }


      that._lineWidgets.push(that._codeMirror.addLineWidget(
        event.location.line - 1, element));
    });
  },

  jumpTo : function (line, column) {
    var that = this;

    setTimeout(function () {
      var selPosPixel
        = that._codeMirror.charCoords({ line : line, ch : column }, 'local');
      var editorSize = {
        width  : that._editor.clientWidth,
        height : that._editor.clientHeight
      };

      that._codeMirror.scrollIntoView({
        top    : selPosPixel.top - 100,
        bottom : selPosPixel.top + editorSize.height - 150,
        left   : selPosPixel.left < editorSize.width - 100
               ? 0
               : selPosPixel.left - 50,
        right  : selPosPixel.left < editorSize.width - 100
               ? 10
               : selPosPixel.left + editorSize.width - 100
      });
    }, 0);
  }
}


      var data = {"files": {"0": {"id": 0, "path": "/src/drivers/scsi/qla2xxx/qla_target.c", "content": "// SPDX-License-Identifier: GPL-2.0-only\n/*\n *  qla_target.c SCSI LLD infrastructure for QLogic 22xx/23xx/24xx/25xx\n *\n *  based on qla2x00t.c code:\n *\n *  Copyright (C) 2004 - 2010 Vladislav Bolkhovitin <vst@vlnb.net>\n *  Copyright (C) 2004 - 2005 Leonid Stoljar\n *  Copyright (C) 2006 Nathaniel Clark <nate@misrule.us>\n *  Copyright (C) 2006 - 2010 ID7 Ltd.\n *\n *  Forward port and refactoring to modern qla2xxx and target/configfs\n *\n *  Copyright (C) 2010-2013 Nicholas A. Bellinger <nab@kernel.org>\n */\n\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/types.h>\n#include <linux/blkdev.h>\n#include <linux/interrupt.h>\n#include <linux/pci.h>\n#include <linux/delay.h>\n#include <linux/list.h>\n#include <linux/workqueue.h>\n#include <asm/unaligned.h>\n#include <scsi/scsi.h>\n#include <scsi/scsi_host.h>\n#include <scsi/scsi_tcq.h>\n\n#include \"qla_def.h\"\n#include \"qla_target.h\"\n\nstatic int ql2xtgt_tape_enable;\nmodule_param(ql2xtgt_tape_enable, int, S_IRUGO|S_IWUSR);\nMODULE_PARM_DESC(ql2xtgt_tape_enable,\n\t\t\"Enables Sequence level error recovery (aka FC Tape). Default is 0 - no SLER. 1 - Enable SLER.\");\n\nstatic char *qlini_mode = QLA2XXX_INI_MODE_STR_ENABLED;\nmodule_param(qlini_mode, charp, S_IRUGO);\nMODULE_PARM_DESC(qlini_mode,\n\t\"Determines when initiator mode will be enabled. Possible values: \"\n\t\"\\\"exclusive\\\" - initiator mode will be enabled on load, \"\n\t\"disabled on enabling target mode and then on disabling target mode \"\n\t\"enabled back; \"\n\t\"\\\"disabled\\\" - initiator mode will never be enabled; \"\n\t\"\\\"dual\\\" - Initiator Modes will be enabled. Target Mode can be activated \"\n\t\"when ready \"\n\t\"\\\"enabled\\\" (default) - initiator mode will always stay enabled.\");\n\nstatic int ql_dm_tgt_ex_pct = 0;\nmodule_param(ql_dm_tgt_ex_pct, int, S_IRUGO|S_IWUSR);\nMODULE_PARM_DESC(ql_dm_tgt_ex_pct,\n\t\"For Dual Mode (qlini_mode=dual), this parameter determines \"\n\t\"the percentage of exchanges/cmds FW will allocate resources \"\n\t\"for Target mode.\");\n\nint ql2xuctrlirq = 1;\nmodule_param(ql2xuctrlirq, int, 0644);\nMODULE_PARM_DESC(ql2xuctrlirq,\n    \"User to control IRQ placement via smp_affinity.\"\n    \"Valid with qlini_mode=disabled.\"\n    \"1(default): enable\");\n\nint ql2x_ini_mode = QLA2XXX_INI_MODE_EXCLUSIVE;\n\nstatic int qla_sam_status = SAM_STAT_BUSY;\nstatic int tc_sam_status = SAM_STAT_TASK_SET_FULL; /* target core */\n\n/*\n * From scsi/fc/fc_fcp.h\n */\nenum fcp_resp_rsp_codes {\n\tFCP_TMF_CMPL = 0,\n\tFCP_DATA_LEN_INVALID = 1,\n\tFCP_CMND_FIELDS_INVALID = 2,\n\tFCP_DATA_PARAM_MISMATCH = 3,\n\tFCP_TMF_REJECTED = 4,\n\tFCP_TMF_FAILED = 5,\n\tFCP_TMF_INVALID_LUN = 9,\n};\n\n/*\n * fc_pri_ta from scsi/fc/fc_fcp.h\n */\n#define FCP_PTA_SIMPLE      0   /* simple task attribute */\n#define FCP_PTA_HEADQ       1   /* head of queue task attribute */\n#define FCP_PTA_ORDERED     2   /* ordered task attribute */\n#define FCP_PTA_ACA         4   /* auto. contingent allegiance */\n#define FCP_PTA_MASK        7   /* mask for task attribute field */\n#define FCP_PRI_SHIFT       3   /* priority field starts in bit 3 */\n#define FCP_PRI_RESVD_MASK  0x80        /* reserved bits in priority field */\n\n/*\n * This driver calls qla2x00_alloc_iocbs() and qla2x00_issue_marker(), which\n * must be called under HW lock and could unlock/lock it inside.\n * It isn't an issue, since in the current implementation on the time when\n * those functions are called:\n *\n *   - Either context is IRQ and only IRQ handler can modify HW data,\n *     including rings related fields,\n *\n *   - Or access to target mode variables from struct qla_tgt doesn't\n *     cross those functions boundaries, except tgt_stop, which\n *     additionally protected by irq_cmd_count.\n */\n/* Predefs for callbacks handed to qla2xxx LLD */\nstatic void qlt_24xx_atio_pkt(struct scsi_qla_host *ha,\n\tstruct atio_from_isp *pkt, uint8_t);\nstatic void qlt_response_pkt(struct scsi_qla_host *ha, struct rsp_que *rsp,\n\tresponse_t *pkt);\nstatic int qlt_issue_task_mgmt(struct fc_port *sess, u64 lun,\n\tint fn, void *iocb, int flags);\nstatic void qlt_send_term_exchange(struct qla_qpair *, struct qla_tgt_cmd\n\t*cmd, struct atio_from_isp *atio, int ha_locked, int ul_abort);\nstatic void qlt_alloc_qfull_cmd(struct scsi_qla_host *vha,\n\tstruct atio_from_isp *atio, uint16_t status, int qfull);\nstatic void qlt_disable_vha(struct scsi_qla_host *vha);\nstatic void qlt_clear_tgt_db(struct qla_tgt *tgt);\nstatic void qlt_send_notify_ack(struct qla_qpair *qpair,\n\tstruct imm_ntfy_from_isp *ntfy,\n\tuint32_t add_flags, uint16_t resp_code, int resp_code_valid,\n\tuint16_t srr_flags, uint16_t srr_reject_code, uint8_t srr_explan);\nstatic void qlt_send_term_imm_notif(struct scsi_qla_host *vha,\n\tstruct imm_ntfy_from_isp *imm, int ha_locked);\nstatic struct fc_port *qlt_create_sess(struct scsi_qla_host *vha,\n\tfc_port_t *fcport, bool local);\nvoid qlt_unreg_sess(struct fc_port *sess);\nstatic void qlt_24xx_handle_abts(struct scsi_qla_host *,\n\tstruct abts_recv_from_24xx *);\nstatic void qlt_send_busy(struct qla_qpair *, struct atio_from_isp *,\n    uint16_t);\nstatic int qlt_check_reserve_free_req(struct qla_qpair *qpair, uint32_t);\nstatic inline uint32_t qlt_make_handle(struct qla_qpair *);\n\n/*\n * Global Variables\n */\nstatic struct kmem_cache *qla_tgt_mgmt_cmd_cachep;\nstruct kmem_cache *qla_tgt_plogi_cachep;\nstatic mempool_t *qla_tgt_mgmt_cmd_mempool;\nstatic struct workqueue_struct *qla_tgt_wq;\nstatic DEFINE_MUTEX(qla_tgt_mutex);\nstatic LIST_HEAD(qla_tgt_glist);\n\nstatic const char *prot_op_str(u32 prot_op)\n{\n\tswitch (prot_op) {\n\tcase TARGET_PROT_NORMAL:\treturn \"NORMAL\";\n\tcase TARGET_PROT_DIN_INSERT:\treturn \"DIN_INSERT\";\n\tcase TARGET_PROT_DOUT_INSERT:\treturn \"DOUT_INSERT\";\n\tcase TARGET_PROT_DIN_STRIP:\treturn \"DIN_STRIP\";\n\tcase TARGET_PROT_DOUT_STRIP:\treturn \"DOUT_STRIP\";\n\tcase TARGET_PROT_DIN_PASS:\treturn \"DIN_PASS\";\n\tcase TARGET_PROT_DOUT_PASS:\treturn \"DOUT_PASS\";\n\tdefault:\t\t\treturn \"UNKNOWN\";\n\t}\n}\n\n/* This API intentionally takes dest as a parameter, rather than returning\n * int value to avoid caller forgetting to issue wmb() after the store */\nvoid qlt_do_generation_tick(struct scsi_qla_host *vha, int *dest)\n{\n\tscsi_qla_host_t *base_vha = pci_get_drvdata(vha->hw->pdev);\n\t*dest = atomic_inc_return(&base_vha->generation_tick);\n\t/* memory barrier */\n\twmb();\n}\n\n/* Might release hw lock, then reaquire!! */\nstatic inline int qlt_issue_marker(struct scsi_qla_host *vha, int vha_locked)\n{\n\t/* Send marker if required */\n\tif (unlikely(vha->marker_needed != 0)) {\n\t\tint rc = qla2x00_issue_marker(vha, vha_locked);\n\n\t\tif (rc != QLA_SUCCESS) {\n\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe03d,\n\t\t\t    \"qla_target(%d): issue_marker() failed\\n\",\n\t\t\t    vha->vp_idx);\n\t\t}\n\t\treturn rc;\n\t}\n\treturn QLA_SUCCESS;\n}\n\nstatic inline\nstruct scsi_qla_host *qlt_find_host_by_d_id(struct scsi_qla_host *vha,\n\t\t\t\t\t    be_id_t d_id)\n{\n\tstruct scsi_qla_host *host;\n\tuint32_t key;\n\n\tif (vha->d_id.b.area == d_id.area &&\n\t    vha->d_id.b.domain == d_id.domain &&\n\t    vha->d_id.b.al_pa == d_id.al_pa)\n\t\treturn vha;\n\n\tkey = be_to_port_id(d_id).b24;\n\n\thost = btree_lookup32(&vha->hw->tgt.host_map, key);\n\tif (!host)\n\t\tql_dbg(ql_dbg_tgt_mgt + ql_dbg_verbose, vha, 0xf005,\n\t\t    \"Unable to find host %06x\\n\", key);\n\n\treturn host;\n}\n\nstatic inline\nstruct scsi_qla_host *qlt_find_host_by_vp_idx(struct scsi_qla_host *vha,\n\tuint16_t vp_idx)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\n\tif (vha->vp_idx == vp_idx)\n\t\treturn vha;\n\n\tBUG_ON(ha->tgt.tgt_vp_map == NULL);\n\tif (likely(test_bit(vp_idx, ha->vp_idx_map)))\n\t\treturn ha->tgt.tgt_vp_map[vp_idx].vha;\n\n\treturn NULL;\n}\n\nstatic inline void qlt_incr_num_pend_cmds(struct scsi_qla_host *vha)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&vha->hw->tgt.q_full_lock, flags);\n\n\tvha->hw->tgt.num_pend_cmds++;\n\tif (vha->hw->tgt.num_pend_cmds > vha->qla_stats.stat_max_pend_cmds)\n\t\tvha->qla_stats.stat_max_pend_cmds =\n\t\t\tvha->hw->tgt.num_pend_cmds;\n\tspin_unlock_irqrestore(&vha->hw->tgt.q_full_lock, flags);\n}\nstatic inline void qlt_decr_num_pend_cmds(struct scsi_qla_host *vha)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&vha->hw->tgt.q_full_lock, flags);\n\tvha->hw->tgt.num_pend_cmds--;\n\tspin_unlock_irqrestore(&vha->hw->tgt.q_full_lock, flags);\n}\n\n\nstatic void qlt_queue_unknown_atio(scsi_qla_host_t *vha,\n\tstruct atio_from_isp *atio, uint8_t ha_locked)\n{\n\tstruct qla_tgt_sess_op *u;\n\tstruct qla_tgt *tgt = vha->vha_tgt.qla_tgt;\n\tunsigned long flags;\n\n\tif (tgt->tgt_stop) {\n\t\tql_dbg(ql_dbg_async, vha, 0x502c,\n\t\t    \"qla_target(%d): dropping unknown ATIO_TYPE7, because tgt is being stopped\",\n\t\t    vha->vp_idx);\n\t\tgoto out_term;\n\t}\n\n\tu = kzalloc(sizeof(*u), GFP_ATOMIC);\n\tif (u == NULL)\n\t\tgoto out_term;\n\n\tu->vha = vha;\n\tmemcpy(&u->atio, atio, sizeof(*atio));\n\tINIT_LIST_HEAD(&u->cmd_list);\n\n\tspin_lock_irqsave(&vha->cmd_list_lock, flags);\n\tlist_add_tail(&u->cmd_list, &vha->unknown_atio_list);\n\tspin_unlock_irqrestore(&vha->cmd_list_lock, flags);\n\n\tschedule_delayed_work(&vha->unknown_atio_work, 1);\n\nout:\n\treturn;\n\nout_term:\n\tqlt_send_term_exchange(vha->hw->base_qpair, NULL, atio, ha_locked, 0);\n\tgoto out;\n}\n\nstatic void qlt_try_to_dequeue_unknown_atios(struct scsi_qla_host *vha,\n\tuint8_t ha_locked)\n{\n\tstruct qla_tgt_sess_op *u, *t;\n\tscsi_qla_host_t *host;\n\tstruct qla_tgt *tgt = vha->vha_tgt.qla_tgt;\n\tunsigned long flags;\n\tuint8_t queued = 0;\n\n\tlist_for_each_entry_safe(u, t, &vha->unknown_atio_list, cmd_list) {\n\t\tif (u->aborted) {\n\t\t\tql_dbg(ql_dbg_async, vha, 0x502e,\n\t\t\t    \"Freeing unknown %s %p, because of Abort\\n\",\n\t\t\t    \"ATIO_TYPE7\", u);\n\t\t\tqlt_send_term_exchange(vha->hw->base_qpair, NULL,\n\t\t\t    &u->atio, ha_locked, 0);\n\t\t\tgoto abort;\n\t\t}\n\n\t\thost = qlt_find_host_by_d_id(vha, u->atio.u.isp24.fcp_hdr.d_id);\n\t\tif (host != NULL) {\n\t\t\tql_dbg(ql_dbg_async + ql_dbg_verbose, vha, 0x502f,\n\t\t\t    \"Requeuing unknown ATIO_TYPE7 %p\\n\", u);\n\t\t\tqlt_24xx_atio_pkt(host, &u->atio, ha_locked);\n\t\t} else if (tgt->tgt_stop) {\n\t\t\tql_dbg(ql_dbg_async + ql_dbg_verbose, vha, 0x503a,\n\t\t\t    \"Freeing unknown %s %p, because tgt is being stopped\\n\",\n\t\t\t    \"ATIO_TYPE7\", u);\n\t\t\tqlt_send_term_exchange(vha->hw->base_qpair, NULL,\n\t\t\t    &u->atio, ha_locked, 0);\n\t\t} else {\n\t\t\tql_dbg(ql_dbg_async + ql_dbg_verbose, vha, 0x503d,\n\t\t\t    \"Reschedule u %p, vha %p, host %p\\n\", u, vha, host);\n\t\t\tif (!queued) {\n\t\t\t\tqueued = 1;\n\t\t\t\tschedule_delayed_work(&vha->unknown_atio_work,\n\t\t\t\t    1);\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\nabort:\n\t\tspin_lock_irqsave(&vha->cmd_list_lock, flags);\n\t\tlist_del(&u->cmd_list);\n\t\tspin_unlock_irqrestore(&vha->cmd_list_lock, flags);\n\t\tkfree(u);\n\t}\n}\n\nvoid qlt_unknown_atio_work_fn(struct work_struct *work)\n{\n\tstruct scsi_qla_host *vha = container_of(to_delayed_work(work),\n\t    struct scsi_qla_host, unknown_atio_work);\n\n\tqlt_try_to_dequeue_unknown_atios(vha, 0);\n}\n\nstatic bool qlt_24xx_atio_pkt_all_vps(struct scsi_qla_host *vha,\n\tstruct atio_from_isp *atio, uint8_t ha_locked)\n{\n\tql_dbg(ql_dbg_tgt, vha, 0xe072,\n\t\t\"%s: qla_target(%d): type %x ox_id %04x\\n\",\n\t\t__func__, vha->vp_idx, atio->u.raw.entry_type,\n\t\tbe16_to_cpu(atio->u.isp24.fcp_hdr.ox_id));\n\n\tswitch (atio->u.raw.entry_type) {\n\tcase ATIO_TYPE7:\n\t{\n\t\tstruct scsi_qla_host *host = qlt_find_host_by_d_id(vha,\n\t\t    atio->u.isp24.fcp_hdr.d_id);\n\t\tif (unlikely(NULL == host)) {\n\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe03e,\n\t\t\t    \"qla_target(%d): Received ATIO_TYPE7 \"\n\t\t\t    \"with unknown d_id %x:%x:%x\\n\", vha->vp_idx,\n\t\t\t    atio->u.isp24.fcp_hdr.d_id.domain,\n\t\t\t    atio->u.isp24.fcp_hdr.d_id.area,\n\t\t\t    atio->u.isp24.fcp_hdr.d_id.al_pa);\n\n\n\t\t\tqlt_queue_unknown_atio(vha, atio, ha_locked);\n\t\t\tbreak;\n\t\t}\n\t\tif (unlikely(!list_empty(&vha->unknown_atio_list)))\n\t\t\tqlt_try_to_dequeue_unknown_atios(vha, ha_locked);\n\n\t\tqlt_24xx_atio_pkt(host, atio, ha_locked);\n\t\tbreak;\n\t}\n\n\tcase IMMED_NOTIFY_TYPE:\n\t{\n\t\tstruct scsi_qla_host *host = vha;\n\t\tstruct imm_ntfy_from_isp *entry =\n\t\t    (struct imm_ntfy_from_isp *)atio;\n\n\t\tqlt_issue_marker(vha, ha_locked);\n\n\t\tif ((entry->u.isp24.vp_index != 0xFF) &&\n\t\t    (entry->u.isp24.nport_handle != cpu_to_le16(0xFFFF))) {\n\t\t\thost = qlt_find_host_by_vp_idx(vha,\n\t\t\t    entry->u.isp24.vp_index);\n\t\t\tif (unlikely(!host)) {\n\t\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe03f,\n\t\t\t\t    \"qla_target(%d): Received \"\n\t\t\t\t    \"ATIO (IMMED_NOTIFY_TYPE) \"\n\t\t\t\t    \"with unknown vp_index %d\\n\",\n\t\t\t\t    vha->vp_idx, entry->u.isp24.vp_index);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tqlt_24xx_atio_pkt(host, atio, ha_locked);\n\t\tbreak;\n\t}\n\n\tcase VP_RPT_ID_IOCB_TYPE:\n\t\tqla24xx_report_id_acquisition(vha,\n\t\t\t(struct vp_rpt_id_entry_24xx *)atio);\n\t\tbreak;\n\n\tcase ABTS_RECV_24XX:\n\t{\n\t\tstruct abts_recv_from_24xx *entry =\n\t\t\t(struct abts_recv_from_24xx *)atio;\n\t\tstruct scsi_qla_host *host = qlt_find_host_by_vp_idx(vha,\n\t\t\tentry->vp_index);\n\t\tunsigned long flags;\n\n\t\tif (unlikely(!host)) {\n\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe00a,\n\t\t\t    \"qla_target(%d): Response pkt (ABTS_RECV_24XX) \"\n\t\t\t    \"received, with unknown vp_index %d\\n\",\n\t\t\t    vha->vp_idx, entry->vp_index);\n\t\t\tbreak;\n\t\t}\n\t\tif (!ha_locked)\n\t\t\tspin_lock_irqsave(&host->hw->hardware_lock, flags);\n\t\tqlt_24xx_handle_abts(host, (struct abts_recv_from_24xx *)atio);\n\t\tif (!ha_locked)\n\t\t\tspin_unlock_irqrestore(&host->hw->hardware_lock, flags);\n\t\tbreak;\n\t}\n\n\t/* case PUREX_IOCB_TYPE: ql2xmvasynctoatio */\n\n\tdefault:\n\t\tql_dbg(ql_dbg_tgt, vha, 0xe040,\n\t\t    \"qla_target(%d): Received unknown ATIO atio \"\n\t\t    \"type %x\\n\", vha->vp_idx, atio->u.raw.entry_type);\n\t\tbreak;\n\t}\n\n\treturn false;\n}\n\nvoid qlt_response_pkt_all_vps(struct scsi_qla_host *vha,\n\tstruct rsp_que *rsp, response_t *pkt)\n{\n\tswitch (pkt->entry_type) {\n\tcase CTIO_CRC2:\n\t\tql_dbg(ql_dbg_tgt, vha, 0xe073,\n\t\t\t\"qla_target(%d):%s: CRC2 Response pkt\\n\",\n\t\t\tvha->vp_idx, __func__);\n\t\tfallthrough;\n\tcase CTIO_TYPE7:\n\t{\n\t\tstruct ctio7_from_24xx *entry = (struct ctio7_from_24xx *)pkt;\n\t\tstruct scsi_qla_host *host = qlt_find_host_by_vp_idx(vha,\n\t\t    entry->vp_index);\n\t\tif (unlikely(!host)) {\n\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe041,\n\t\t\t    \"qla_target(%d): Response pkt (CTIO_TYPE7) \"\n\t\t\t    \"received, with unknown vp_index %d\\n\",\n\t\t\t    vha->vp_idx, entry->vp_index);\n\t\t\tbreak;\n\t\t}\n\t\tqlt_response_pkt(host, rsp, pkt);\n\t\tbreak;\n\t}\n\n\tcase IMMED_NOTIFY_TYPE:\n\t{\n\t\tstruct scsi_qla_host *host;\n\t\tstruct imm_ntfy_from_isp *entry =\n\t\t    (struct imm_ntfy_from_isp *)pkt;\n\n\t\thost = qlt_find_host_by_vp_idx(vha, entry->u.isp24.vp_index);\n\t\tif (unlikely(!host)) {\n\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe042,\n\t\t\t    \"qla_target(%d): Response pkt (IMMED_NOTIFY_TYPE) \"\n\t\t\t    \"received, with unknown vp_index %d\\n\",\n\t\t\t    vha->vp_idx, entry->u.isp24.vp_index);\n\t\t\tbreak;\n\t\t}\n\t\tqlt_response_pkt(host, rsp, pkt);\n\t\tbreak;\n\t}\n\n\tcase NOTIFY_ACK_TYPE:\n\t{\n\t\tstruct scsi_qla_host *host = vha;\n\t\tstruct nack_to_isp *entry = (struct nack_to_isp *)pkt;\n\n\t\tif (0xFF != entry->u.isp24.vp_index) {\n\t\t\thost = qlt_find_host_by_vp_idx(vha,\n\t\t\t    entry->u.isp24.vp_index);\n\t\t\tif (unlikely(!host)) {\n\t\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe043,\n\t\t\t\t    \"qla_target(%d): Response \"\n\t\t\t\t    \"pkt (NOTIFY_ACK_TYPE) \"\n\t\t\t\t    \"received, with unknown \"\n\t\t\t\t    \"vp_index %d\\n\", vha->vp_idx,\n\t\t\t\t    entry->u.isp24.vp_index);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tqlt_response_pkt(host, rsp, pkt);\n\t\tbreak;\n\t}\n\n\tcase ABTS_RECV_24XX:\n\t{\n\t\tstruct abts_recv_from_24xx *entry =\n\t\t    (struct abts_recv_from_24xx *)pkt;\n\t\tstruct scsi_qla_host *host = qlt_find_host_by_vp_idx(vha,\n\t\t    entry->vp_index);\n\t\tif (unlikely(!host)) {\n\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe044,\n\t\t\t    \"qla_target(%d): Response pkt \"\n\t\t\t    \"(ABTS_RECV_24XX) received, with unknown \"\n\t\t\t    \"vp_index %d\\n\", vha->vp_idx, entry->vp_index);\n\t\t\tbreak;\n\t\t}\n\t\tqlt_response_pkt(host, rsp, pkt);\n\t\tbreak;\n\t}\n\n\tcase ABTS_RESP_24XX:\n\t{\n\t\tstruct abts_resp_to_24xx *entry =\n\t\t    (struct abts_resp_to_24xx *)pkt;\n\t\tstruct scsi_qla_host *host = qlt_find_host_by_vp_idx(vha,\n\t\t    entry->vp_index);\n\t\tif (unlikely(!host)) {\n\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe045,\n\t\t\t    \"qla_target(%d): Response pkt \"\n\t\t\t    \"(ABTS_RECV_24XX) received, with unknown \"\n\t\t\t    \"vp_index %d\\n\", vha->vp_idx, entry->vp_index);\n\t\t\tbreak;\n\t\t}\n\t\tqlt_response_pkt(host, rsp, pkt);\n\t\tbreak;\n\t}\n\tdefault:\n\t\tqlt_response_pkt(vha, rsp, pkt);\n\t\tbreak;\n\t}\n\n}\n\n/*\n * All qlt_plogi_ack_t operations are protected by hardware_lock\n */\nstatic int qla24xx_post_nack_work(struct scsi_qla_host *vha, fc_port_t *fcport,\n\tstruct imm_ntfy_from_isp *ntfy, int type)\n{\n\tstruct qla_work_evt *e;\n\n\te = qla2x00_alloc_work(vha, QLA_EVT_NACK);\n\tif (!e)\n\t\treturn QLA_FUNCTION_FAILED;\n\n\te->u.nack.fcport = fcport;\n\te->u.nack.type = type;\n\tmemcpy(e->u.nack.iocb, ntfy, sizeof(struct imm_ntfy_from_isp));\n\treturn qla2x00_post_work(vha, e);\n}\n\nstatic void qla2x00_async_nack_sp_done(srb_t *sp, int res)\n{\n\tstruct scsi_qla_host *vha = sp->vha;\n\tunsigned long flags;\n\n\tql_dbg(ql_dbg_disc, vha, 0x20f2,\n\t    \"Async done-%s res %x %8phC  type %d\\n\",\n\t    sp->name, res, sp->fcport->port_name, sp->type);\n\n\tspin_lock_irqsave(&vha->hw->tgt.sess_lock, flags);\n\tsp->fcport->flags &= ~FCF_ASYNC_SENT;\n\tsp->fcport->chip_reset = vha->hw->base_qpair->chip_reset;\n\n\tswitch (sp->type) {\n\tcase SRB_NACK_PLOGI:\n\t\tsp->fcport->login_gen++;\n\t\tsp->fcport->fw_login_state = DSC_LS_PLOGI_COMP;\n\t\tsp->fcport->logout_on_delete = 1;\n\t\tsp->fcport->plogi_nack_done_deadline = jiffies + HZ;\n\t\tsp->fcport->send_els_logo = 0;\n\t\tbreak;\n\n\tcase SRB_NACK_PRLI:\n\t\tsp->fcport->fw_login_state = DSC_LS_PRLI_COMP;\n\t\tsp->fcport->deleted = 0;\n\t\tsp->fcport->send_els_logo = 0;\n\n\t\tif (!sp->fcport->login_succ &&\n\t\t    !IS_SW_RESV_ADDR(sp->fcport->d_id)) {\n\t\t\tsp->fcport->login_succ = 1;\n\n\t\t\tvha->fcport_count++;\n\t\t\tspin_unlock_irqrestore(&vha->hw->tgt.sess_lock, flags);\n\t\t\tqla24xx_sched_upd_fcport(sp->fcport);\n\t\t\tspin_lock_irqsave(&vha->hw->tgt.sess_lock, flags);\n\t\t} else {\n\t\t\tsp->fcport->login_retry = 0;\n\t\t\tqla2x00_set_fcport_disc_state(sp->fcport,\n\t\t\t    DSC_LOGIN_COMPLETE);\n\t\t\tsp->fcport->deleted = 0;\n\t\t\tsp->fcport->logout_on_delete = 1;\n\t\t}\n\t\tbreak;\n\n\tcase SRB_NACK_LOGO:\n\t\tsp->fcport->login_gen++;\n\t\tsp->fcport->fw_login_state = DSC_LS_PORT_UNAVAIL;\n\t\tqlt_logo_completion_handler(sp->fcport, MBS_COMMAND_COMPLETE);\n\t\tbreak;\n\t}\n\tspin_unlock_irqrestore(&vha->hw->tgt.sess_lock, flags);\n\n\tsp->free(sp);\n}\n\nint qla24xx_async_notify_ack(scsi_qla_host_t *vha, fc_port_t *fcport,\n\tstruct imm_ntfy_from_isp *ntfy, int type)\n{\n\tint rval = QLA_FUNCTION_FAILED;\n\tsrb_t *sp;\n\tchar *c = NULL;\n\n\tfcport->flags |= FCF_ASYNC_SENT;\n\tswitch (type) {\n\tcase SRB_NACK_PLOGI:\n\t\tfcport->fw_login_state = DSC_LS_PLOGI_PEND;\n\t\tc = \"PLOGI\";\n\t\tbreak;\n\tcase SRB_NACK_PRLI:\n\t\tfcport->fw_login_state = DSC_LS_PRLI_PEND;\n\t\tfcport->deleted = 0;\n\t\tc = \"PRLI\";\n\t\tbreak;\n\tcase SRB_NACK_LOGO:\n\t\tfcport->fw_login_state = DSC_LS_LOGO_PEND;\n\t\tc = \"LOGO\";\n\t\tbreak;\n\t}\n\n\tsp = qla2x00_get_sp(vha, fcport, GFP_ATOMIC);\n\tif (!sp)\n\t\tgoto done;\n\n\tsp->type = type;\n\tsp->name = \"nack\";\n\n\tsp->u.iocb_cmd.timeout = qla2x00_async_iocb_timeout;\n\tqla2x00_init_timer(sp, qla2x00_get_async_timeout(vha)+2);\n\n\tsp->u.iocb_cmd.u.nack.ntfy = ntfy;\n\tsp->done = qla2x00_async_nack_sp_done;\n\n\tql_dbg(ql_dbg_disc, vha, 0x20f4,\n\t    \"Async-%s %8phC hndl %x %s\\n\",\n\t    sp->name, fcport->port_name, sp->handle, c);\n\n\trval = qla2x00_start_sp(sp);\n\tif (rval != QLA_SUCCESS)\n\t\tgoto done_free_sp;\n\n\treturn rval;\n\ndone_free_sp:\n\tsp->free(sp);\ndone:\n\tfcport->flags &= ~FCF_ASYNC_SENT;\n\treturn rval;\n}\n\nvoid qla24xx_do_nack_work(struct scsi_qla_host *vha, struct qla_work_evt *e)\n{\n\tfc_port_t *t;\n\n\tswitch (e->u.nack.type) {\n\tcase SRB_NACK_PRLI:\n\t\tt = e->u.nack.fcport;\n\t\tflush_work(&t->del_work);\n\t\tflush_work(&t->free_work);\n\t\tmutex_lock(&vha->vha_tgt.tgt_mutex);\n\t\tt = qlt_create_sess(vha, e->u.nack.fcport, 0);\n\t\tmutex_unlock(&vha->vha_tgt.tgt_mutex);\n\t\tif (t) {\n\t\t\tql_log(ql_log_info, vha, 0xd034,\n\t\t\t    \"%s create sess success %p\", __func__, t);\n\t\t\t/* create sess has an extra kref */\n\t\t\tvha->hw->tgt.tgt_ops->put_sess(e->u.nack.fcport);\n\t\t}\n\t\tbreak;\n\t}\n\tqla24xx_async_notify_ack(vha, e->u.nack.fcport,\n\t    (struct imm_ntfy_from_isp *)e->u.nack.iocb, e->u.nack.type);\n}\n\nvoid qla24xx_delete_sess_fn(struct work_struct *work)\n{\n\tfc_port_t *fcport = container_of(work, struct fc_port, del_work);\n\tstruct qla_hw_data *ha = fcport->vha->hw;\n\n\tif (fcport->se_sess) {\n\t\tha->tgt.tgt_ops->shutdown_sess(fcport);\n\t\tha->tgt.tgt_ops->put_sess(fcport);\n\t} else {\n\t\tqlt_unreg_sess(fcport);\n\t}\n}\n\n/*\n * Called from qla2x00_reg_remote_port()\n */\nvoid qlt_fc_port_added(struct scsi_qla_host *vha, fc_port_t *fcport)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct qla_tgt *tgt = vha->vha_tgt.qla_tgt;\n\tstruct fc_port *sess = fcport;\n\tunsigned long flags;\n\n\tif (!vha->hw->tgt.tgt_ops)\n\t\treturn;\n\n\tspin_lock_irqsave(&ha->tgt.sess_lock, flags);\n\tif (tgt->tgt_stop) {\n\t\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\n\t\treturn;\n\t}\n\n\tif (fcport->disc_state == DSC_DELETE_PEND) {\n\t\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\n\t\treturn;\n\t}\n\n\tif (!sess->se_sess) {\n\t\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\n\n\t\tmutex_lock(&vha->vha_tgt.tgt_mutex);\n\t\tsess = qlt_create_sess(vha, fcport, false);\n\t\tmutex_unlock(&vha->vha_tgt.tgt_mutex);\n\n\t\tspin_lock_irqsave(&ha->tgt.sess_lock, flags);\n\t} else {\n\t\tif (fcport->fw_login_state == DSC_LS_PRLI_COMP) {\n\t\t\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\n\t\t\treturn;\n\t\t}\n\n\t\tif (!kref_get_unless_zero(&sess->sess_kref)) {\n\t\t\tql_dbg(ql_dbg_disc, vha, 0x2107,\n\t\t\t    \"%s: kref_get fail sess %8phC \\n\",\n\t\t\t    __func__, sess->port_name);\n\t\t\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\n\t\t\treturn;\n\t\t}\n\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf04c,\n\t\t    \"qla_target(%u): %ssession for port %8phC \"\n\t\t    \"(loop ID %d) reappeared\\n\", vha->vp_idx,\n\t\t    sess->local ? \"local \" : \"\", sess->port_name, sess->loop_id);\n\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf007,\n\t\t    \"Reappeared sess %p\\n\", sess);\n\n\t\tha->tgt.tgt_ops->update_sess(sess, fcport->d_id,\n\t\t    fcport->loop_id,\n\t\t    (fcport->flags & FCF_CONF_COMP_SUPPORTED));\n\t}\n\n\tif (sess && sess->local) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf04d,\n\t\t    \"qla_target(%u): local session for \"\n\t\t    \"port %8phC (loop ID %d) became global\\n\", vha->vp_idx,\n\t\t    fcport->port_name, sess->loop_id);\n\t\tsess->local = 0;\n\t}\n\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\n\n\tha->tgt.tgt_ops->put_sess(sess);\n}\n\n/*\n * This is a zero-base ref-counting solution, since hardware_lock\n * guarantees that ref_count is not modified concurrently.\n * Upon successful return content of iocb is undefined\n */\nstatic struct qlt_plogi_ack_t *\nqlt_plogi_ack_find_add(struct scsi_qla_host *vha, port_id_t *id,\n\t\t       struct imm_ntfy_from_isp *iocb)\n{\n\tstruct qlt_plogi_ack_t *pla;\n\n\tlockdep_assert_held(&vha->hw->hardware_lock);\n\n\tlist_for_each_entry(pla, &vha->plogi_ack_list, list) {\n\t\tif (pla->id.b24 == id->b24) {\n\t\t\tql_dbg(ql_dbg_disc + ql_dbg_verbose, vha, 0x210d,\n\t\t\t    \"%s %d %8phC Term INOT due to new INOT\",\n\t\t\t    __func__, __LINE__,\n\t\t\t    pla->iocb.u.isp24.port_name);\n\t\t\tqlt_send_term_imm_notif(vha, &pla->iocb, 1);\n\t\t\tmemcpy(&pla->iocb, iocb, sizeof(pla->iocb));\n\t\t\treturn pla;\n\t\t}\n\t}\n\n\tpla = kmem_cache_zalloc(qla_tgt_plogi_cachep, GFP_ATOMIC);\n\tif (!pla) {\n\t\tql_dbg(ql_dbg_async, vha, 0x5088,\n\t\t       \"qla_target(%d): Allocation of plogi_ack failed\\n\",\n\t\t       vha->vp_idx);\n\t\treturn NULL;\n\t}\n\n\tmemcpy(&pla->iocb, iocb, sizeof(pla->iocb));\n\tpla->id = *id;\n\tlist_add_tail(&pla->list, &vha->plogi_ack_list);\n\n\treturn pla;\n}\n\nvoid qlt_plogi_ack_unref(struct scsi_qla_host *vha,\n    struct qlt_plogi_ack_t *pla)\n{\n\tstruct imm_ntfy_from_isp *iocb = &pla->iocb;\n\tport_id_t port_id;\n\tuint16_t loop_id;\n\tfc_port_t *fcport = pla->fcport;\n\n\tBUG_ON(!pla->ref_count);\n\tpla->ref_count--;\n\n\tif (pla->ref_count)\n\t\treturn;\n\n\tql_dbg(ql_dbg_disc, vha, 0x5089,\n\t    \"Sending PLOGI ACK to wwn %8phC s_id %02x:%02x:%02x loop_id %#04x\"\n\t    \" exch %#x ox_id %#x\\n\", iocb->u.isp24.port_name,\n\t    iocb->u.isp24.port_id[2], iocb->u.isp24.port_id[1],\n\t    iocb->u.isp24.port_id[0],\n\t    le16_to_cpu(iocb->u.isp24.nport_handle),\n\t    iocb->u.isp24.exchange_address, iocb->ox_id);\n\n\tport_id.b.domain = iocb->u.isp24.port_id[2];\n\tport_id.b.area   = iocb->u.isp24.port_id[1];\n\tport_id.b.al_pa  = iocb->u.isp24.port_id[0];\n\tport_id.b.rsvd_1 = 0;\n\n\tloop_id = le16_to_cpu(iocb->u.isp24.nport_handle);\n\n\tfcport->loop_id = loop_id;\n\tfcport->d_id = port_id;\n\tif (iocb->u.isp24.status_subcode == ELS_PLOGI)\n\t\tqla24xx_post_nack_work(vha, fcport, iocb, SRB_NACK_PLOGI);\n\telse\n\t\tqla24xx_post_nack_work(vha, fcport, iocb, SRB_NACK_PRLI);\n\n\tlist_for_each_entry(fcport, &vha->vp_fcports, list) {\n\t\tif (fcport->plogi_link[QLT_PLOGI_LINK_SAME_WWN] == pla)\n\t\t\tfcport->plogi_link[QLT_PLOGI_LINK_SAME_WWN] = NULL;\n\t\tif (fcport->plogi_link[QLT_PLOGI_LINK_CONFLICT] == pla)\n\t\t\tfcport->plogi_link[QLT_PLOGI_LINK_CONFLICT] = NULL;\n\t}\n\n\tlist_del(&pla->list);\n\tkmem_cache_free(qla_tgt_plogi_cachep, pla);\n}\n\nvoid\nqlt_plogi_ack_link(struct scsi_qla_host *vha, struct qlt_plogi_ack_t *pla,\n    struct fc_port *sess, enum qlt_plogi_link_t link)\n{\n\tstruct imm_ntfy_from_isp *iocb = &pla->iocb;\n\t/* Inc ref_count first because link might already be pointing at pla */\n\tpla->ref_count++;\n\n\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf097,\n\t\t\"Linking sess %p [%d] wwn %8phC with PLOGI ACK to wwn %8phC\"\n\t\t\" s_id %02x:%02x:%02x, ref=%d pla %p link %d\\n\",\n\t\tsess, link, sess->port_name,\n\t\tiocb->u.isp24.port_name, iocb->u.isp24.port_id[2],\n\t\tiocb->u.isp24.port_id[1], iocb->u.isp24.port_id[0],\n\t\tpla->ref_count, pla, link);\n\n\tif (link == QLT_PLOGI_LINK_CONFLICT) {\n\t\tswitch (sess->disc_state) {\n\t\tcase DSC_DELETED:\n\t\tcase DSC_DELETE_PEND:\n\t\t\tpla->ref_count--;\n\t\t\treturn;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (sess->plogi_link[link])\n\t\tqlt_plogi_ack_unref(vha, sess->plogi_link[link]);\n\n\tif (link == QLT_PLOGI_LINK_SAME_WWN)\n\t\tpla->fcport = sess;\n\n\tsess->plogi_link[link] = pla;\n}\n\ntypedef struct {\n\t/* These fields must be initialized by the caller */\n\tport_id_t id;\n\t/*\n\t * number of cmds dropped while we were waiting for\n\t * initiator to ack LOGO initialize to 1 if LOGO is\n\t * triggered by a command, otherwise, to 0\n\t */\n\tint cmd_count;\n\n\t/* These fields are used by callee */\n\tstruct list_head list;\n} qlt_port_logo_t;\n\nstatic void\nqlt_send_first_logo(struct scsi_qla_host *vha, qlt_port_logo_t *logo)\n{\n\tqlt_port_logo_t *tmp;\n\tint res;\n\n\tmutex_lock(&vha->vha_tgt.tgt_mutex);\n\n\tlist_for_each_entry(tmp, &vha->logo_list, list) {\n\t\tif (tmp->id.b24 == logo->id.b24) {\n\t\t\ttmp->cmd_count += logo->cmd_count;\n\t\t\tmutex_unlock(&vha->vha_tgt.tgt_mutex);\n\t\t\treturn;\n\t\t}\n\t}\n\n\tlist_add_tail(&logo->list, &vha->logo_list);\n\n\tmutex_unlock(&vha->vha_tgt.tgt_mutex);\n\n\tres = qla24xx_els_dcmd_iocb(vha, ELS_DCMD_LOGO, logo->id);\n\n\tmutex_lock(&vha->vha_tgt.tgt_mutex);\n\tlist_del(&logo->list);\n\tmutex_unlock(&vha->vha_tgt.tgt_mutex);\n\n\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf098,\n\t    \"Finished LOGO to %02x:%02x:%02x, dropped %d cmds, res = %#x\\n\",\n\t    logo->id.b.domain, logo->id.b.area, logo->id.b.al_pa,\n\t    logo->cmd_count, res);\n}\n\nvoid qlt_free_session_done(struct work_struct *work)\n{\n\tstruct fc_port *sess = container_of(work, struct fc_port,\n\t    free_work);\n\tstruct qla_tgt *tgt = sess->tgt;\n\tstruct scsi_qla_host *vha = sess->vha;\n\tstruct qla_hw_data *ha = vha->hw;\n\tunsigned long flags;\n\tbool logout_started = false;\n\tscsi_qla_host_t *base_vha = pci_get_drvdata(ha->pdev);\n\tstruct qlt_plogi_ack_t *own =\n\t\tsess->plogi_link[QLT_PLOGI_LINK_SAME_WWN];\n\n\tql_dbg(ql_dbg_disc, vha, 0xf084,\n\t\t\"%s: se_sess %p / sess %p from port %8phC loop_id %#04x\"\n\t\t\" s_id %02x:%02x:%02x logout %d keep %d els_logo %d\\n\",\n\t\t__func__, sess->se_sess, sess, sess->port_name, sess->loop_id,\n\t\tsess->d_id.b.domain, sess->d_id.b.area, sess->d_id.b.al_pa,\n\t\tsess->logout_on_delete, sess->keep_nport_handle,\n\t\tsess->send_els_logo);\n\n\tif (!IS_SW_RESV_ADDR(sess->d_id)) {\n\t\tqla2x00_mark_device_lost(vha, sess, 0);\n\n\t\tif (sess->send_els_logo) {\n\t\t\tqlt_port_logo_t logo;\n\n\t\t\tlogo.id = sess->d_id;\n\t\t\tlogo.cmd_count = 0;\n\t\t\tif (!own)\n\t\t\t\tqlt_send_first_logo(vha, &logo);\n\t\t\tsess->send_els_logo = 0;\n\t\t}\n\n\t\tif (sess->logout_on_delete && sess->loop_id != FC_NO_LOOP_ID) {\n\t\t\tint rc;\n\n\t\t\tif (!own ||\n\t\t\t    (own &&\n\t\t\t     (own->iocb.u.isp24.status_subcode == ELS_PLOGI))) {\n\t\t\t\trc = qla2x00_post_async_logout_work(vha, sess,\n\t\t\t\t    NULL);\n\t\t\t\tif (rc != QLA_SUCCESS)\n\t\t\t\t\tql_log(ql_log_warn, vha, 0xf085,\n\t\t\t\t\t    \"Schedule logo failed sess %p rc %d\\n\",\n\t\t\t\t\t    sess, rc);\n\t\t\t\telse\n\t\t\t\t\tlogout_started = true;\n\t\t\t} else if (own && (own->iocb.u.isp24.status_subcode ==\n\t\t\t\tELS_PRLI) && ha->flags.rida_fmt2) {\n\t\t\t\trc = qla2x00_post_async_prlo_work(vha, sess,\n\t\t\t\t    NULL);\n\t\t\t\tif (rc != QLA_SUCCESS)\n\t\t\t\t\tql_log(ql_log_warn, vha, 0xf085,\n\t\t\t\t\t    \"Schedule PRLO failed sess %p rc %d\\n\",\n\t\t\t\t\t    sess, rc);\n\t\t\t\telse\n\t\t\t\t\tlogout_started = true;\n\t\t\t}\n\t\t} /* if sess->logout_on_delete */\n\n\t\tif (sess->nvme_flag & NVME_FLAG_REGISTERED &&\n\t\t    !(sess->nvme_flag & NVME_FLAG_DELETING)) {\n\t\t\tsess->nvme_flag |= NVME_FLAG_DELETING;\n\t\t\tqla_nvme_unregister_remote_port(sess);\n\t\t}\n\t}\n\n\t/*\n\t * Release the target session for FC Nexus from fabric module code.\n\t */\n\tif (sess->se_sess != NULL)\n\t\tha->tgt.tgt_ops->free_session(sess);\n\n\tif (logout_started) {\n\t\tbool traced = false;\n\t\tu16 cnt = 0;\n\n\t\twhile (!READ_ONCE(sess->logout_completed)) {\n\t\t\tif (!traced) {\n\t\t\t\tql_dbg(ql_dbg_disc, vha, 0xf086,\n\t\t\t\t\t\"%s: waiting for sess %p logout\\n\",\n\t\t\t\t\t__func__, sess);\n\t\t\t\ttraced = true;\n\t\t\t}\n\t\t\tmsleep(100);\n\t\t\tcnt++;\n\t\t\tif (cnt > 200)\n\t\t\t\tbreak;\n\t\t}\n\n\t\tql_dbg(ql_dbg_disc, vha, 0xf087,\n\t\t    \"%s: sess %p logout completed\\n\", __func__, sess);\n\t}\n\n\tif (sess->logo_ack_needed) {\n\t\tsess->logo_ack_needed = 0;\n\t\tqla24xx_async_notify_ack(vha, sess,\n\t\t\t(struct imm_ntfy_from_isp *)sess->iocb, SRB_NACK_LOGO);\n\t}\n\n\tspin_lock_irqsave(&vha->work_lock, flags);\n\tsess->flags &= ~FCF_ASYNC_SENT;\n\tspin_unlock_irqrestore(&vha->work_lock, flags);\n\n\tspin_lock_irqsave(&ha->tgt.sess_lock, flags);\n\tif (sess->se_sess) {\n\t\tsess->se_sess = NULL;\n\t\tif (tgt && !IS_SW_RESV_ADDR(sess->d_id))\n\t\t\ttgt->sess_count--;\n\t}\n\n\tqla2x00_set_fcport_disc_state(sess, DSC_DELETED);\n\tsess->fw_login_state = DSC_LS_PORT_UNAVAIL;\n\tsess->deleted = QLA_SESS_DELETED;\n\n\tif (sess->login_succ && !IS_SW_RESV_ADDR(sess->d_id)) {\n\t\tvha->fcport_count--;\n\t\tsess->login_succ = 0;\n\t}\n\n\tqla2x00_clear_loop_id(sess);\n\n\tif (sess->conflict) {\n\t\tsess->conflict->login_pause = 0;\n\t\tsess->conflict = NULL;\n\t\tif (!test_bit(UNLOADING, &vha->dpc_flags))\n\t\t\tset_bit(RELOGIN_NEEDED, &vha->dpc_flags);\n\t}\n\n\t{\n\t\tstruct qlt_plogi_ack_t *con =\n\t\t    sess->plogi_link[QLT_PLOGI_LINK_CONFLICT];\n\t\tstruct imm_ntfy_from_isp *iocb;\n\n\t\town = sess->plogi_link[QLT_PLOGI_LINK_SAME_WWN];\n\n\t\tif (con) {\n\t\t\tiocb = &con->iocb;\n\t\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf099,\n\t\t\t\t \"se_sess %p / sess %p port %8phC is gone,\"\n\t\t\t\t \" %s (ref=%d), releasing PLOGI for %8phC (ref=%d)\\n\",\n\t\t\t\t sess->se_sess, sess, sess->port_name,\n\t\t\t\t own ? \"releasing own PLOGI\" : \"no own PLOGI pending\",\n\t\t\t\t own ? own->ref_count : -1,\n\t\t\t\t iocb->u.isp24.port_name, con->ref_count);\n\t\t\tqlt_plogi_ack_unref(vha, con);\n\t\t\tsess->plogi_link[QLT_PLOGI_LINK_CONFLICT] = NULL;\n\t\t} else {\n\t\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf09a,\n\t\t\t    \"se_sess %p / sess %p port %8phC is gone, %s (ref=%d)\\n\",\n\t\t\t    sess->se_sess, sess, sess->port_name,\n\t\t\t    own ? \"releasing own PLOGI\" :\n\t\t\t    \"no own PLOGI pending\",\n\t\t\t    own ? own->ref_count : -1);\n\t\t}\n\n\t\tif (own) {\n\t\t\tsess->fw_login_state = DSC_LS_PLOGI_PEND;\n\t\t\tqlt_plogi_ack_unref(vha, own);\n\t\t\tsess->plogi_link[QLT_PLOGI_LINK_SAME_WWN] = NULL;\n\t\t}\n\t}\n\n\tsess->explicit_logout = 0;\n\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\n\tsess->free_pending = 0;\n\n\tqla2x00_dfs_remove_rport(vha, sess);\n\n\tql_dbg(ql_dbg_disc, vha, 0xf001,\n\t    \"Unregistration of sess %p %8phC finished fcp_cnt %d\\n\",\n\t\tsess, sess->port_name, vha->fcport_count);\n\n\tif (tgt && (tgt->sess_count == 0))\n\t\twake_up_all(&tgt->waitQ);\n\n\tif (!test_bit(PFLG_DRIVER_REMOVING, &base_vha->pci_flags) &&\n\t    !(vha->vp_idx && test_bit(VPORT_DELETE, &vha->dpc_flags)) &&\n\t    (!tgt || !tgt->tgt_stop) && !LOOP_TRANSITION(vha)) {\n\t\tswitch (vha->host->active_mode) {\n\t\tcase MODE_INITIATOR:\n\t\tcase MODE_DUAL:\n\t\t\tset_bit(RELOGIN_NEEDED, &vha->dpc_flags);\n\t\t\tqla2xxx_wake_dpc(vha);\n\t\t\tbreak;\n\t\tcase MODE_TARGET:\n\t\tdefault:\n\t\t\t/* no-op */\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (vha->fcport_count == 0)\n\t\twake_up_all(&vha->fcport_waitQ);\n}\n\n/* ha->tgt.sess_lock supposed to be held on entry */\nvoid qlt_unreg_sess(struct fc_port *sess)\n{\n\tstruct scsi_qla_host *vha = sess->vha;\n\tunsigned long flags;\n\n\tql_dbg(ql_dbg_disc, sess->vha, 0x210a,\n\t    \"%s sess %p for deletion %8phC\\n\",\n\t    __func__, sess, sess->port_name);\n\n\tspin_lock_irqsave(&sess->vha->work_lock, flags);\n\tif (sess->free_pending) {\n\t\tspin_unlock_irqrestore(&sess->vha->work_lock, flags);\n\t\treturn;\n\t}\n\tsess->free_pending = 1;\n\t/*\n\t * Use FCF_ASYNC_SENT flag to block other cmds used in sess\n\t * management from being sent.\n\t */\n\tsess->flags |= FCF_ASYNC_SENT;\n\tspin_unlock_irqrestore(&sess->vha->work_lock, flags);\n\n\tif (sess->se_sess)\n\t\tvha->hw->tgt.tgt_ops->clear_nacl_from_fcport_map(sess);\n\n\tsess->deleted = QLA_SESS_DELETION_IN_PROGRESS;\n\tqla2x00_set_fcport_disc_state(sess, DSC_DELETE_PEND);\n\tsess->last_rscn_gen = sess->rscn_gen;\n\tsess->last_login_gen = sess->login_gen;\n\n\tqueue_work(sess->vha->hw->wq, &sess->free_work);\n}\nEXPORT_SYMBOL(qlt_unreg_sess);\n\nstatic int qlt_reset(struct scsi_qla_host *vha, void *iocb, int mcmd)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct fc_port *sess = NULL;\n\tuint16_t loop_id;\n\tint res = 0;\n\tstruct imm_ntfy_from_isp *n = (struct imm_ntfy_from_isp *)iocb;\n\tunsigned long flags;\n\n\tloop_id = le16_to_cpu(n->u.isp24.nport_handle);\n\tif (loop_id == 0xFFFF) {\n\t\t/* Global event */\n\t\tatomic_inc(&vha->vha_tgt.qla_tgt->tgt_global_resets_count);\n\t\tspin_lock_irqsave(&ha->tgt.sess_lock, flags);\n\t\tqlt_clear_tgt_db(vha->vha_tgt.qla_tgt);\n\t\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\n\t} else {\n\t\tspin_lock_irqsave(&ha->tgt.sess_lock, flags);\n\t\tsess = ha->tgt.tgt_ops->find_sess_by_loop_id(vha, loop_id);\n\t\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\n\t}\n\n\tql_dbg(ql_dbg_tgt, vha, 0xe000,\n\t    \"Using sess for qla_tgt_reset: %p\\n\", sess);\n\tif (!sess) {\n\t\tres = -ESRCH;\n\t\treturn res;\n\t}\n\n\tql_dbg(ql_dbg_tgt, vha, 0xe047,\n\t    \"scsi(%ld): resetting (session %p from port %8phC mcmd %x, \"\n\t    \"loop_id %d)\\n\", vha->host_no, sess, sess->port_name,\n\t    mcmd, loop_id);\n\n\treturn qlt_issue_task_mgmt(sess, 0, mcmd, iocb, QLA24XX_MGMT_SEND_NACK);\n}\n\nstatic void qla24xx_chk_fcp_state(struct fc_port *sess)\n{\n\tif (sess->chip_reset != sess->vha->hw->base_qpair->chip_reset) {\n\t\tsess->logout_on_delete = 0;\n\t\tsess->logo_ack_needed = 0;\n\t\tsess->fw_login_state = DSC_LS_PORT_UNAVAIL;\n\t}\n}\n\nvoid qlt_schedule_sess_for_deletion(struct fc_port *sess)\n{\n\tstruct qla_tgt *tgt = sess->tgt;\n\tunsigned long flags;\n\tu16 sec;\n\n\tswitch (sess->disc_state) {\n\tcase DSC_DELETE_PEND:\n\t\treturn;\n\tcase DSC_DELETED:\n\t\tif (!sess->plogi_link[QLT_PLOGI_LINK_SAME_WWN] &&\n\t\t\t!sess->plogi_link[QLT_PLOGI_LINK_CONFLICT]) {\n\t\t\tif (tgt && tgt->tgt_stop && tgt->sess_count == 0)\n\t\t\t\twake_up_all(&tgt->waitQ);\n\n\t\t\tif (sess->vha->fcport_count == 0)\n\t\t\t\twake_up_all(&sess->vha->fcport_waitQ);\n\t\t\treturn;\n\t\t}\n\t\tbreak;\n\tcase DSC_UPD_FCPORT:\n\t\t/*\n\t\t * This port is not done reporting to upper layer.\n\t\t * let it finish\n\t\t */\n\t\tsess->next_disc_state = DSC_DELETE_PEND;\n\t\tsec = jiffies_to_msecs(jiffies -\n\t\t    sess->jiffies_at_registration)/1000;\n\t\tif (sess->sec_since_registration < sec && sec && !(sec % 5)) {\n\t\t\tsess->sec_since_registration = sec;\n\t\t\tql_dbg(ql_dbg_disc, sess->vha, 0xffff,\n\t\t\t    \"%s %8phC : Slow Rport registration(%d Sec)\\n\",\n\t\t\t    __func__, sess->port_name, sec);\n\t\t}\n\t\treturn;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tspin_lock_irqsave(&sess->vha->work_lock, flags);\n\tif (sess->deleted == QLA_SESS_DELETION_IN_PROGRESS) {\n\t\tspin_unlock_irqrestore(&sess->vha->work_lock, flags);\n\t\treturn;\n\t}\n\tsess->deleted = QLA_SESS_DELETION_IN_PROGRESS;\n\tspin_unlock_irqrestore(&sess->vha->work_lock, flags);\n\n\tsess->prli_pend_timer = 0;\n\tqla2x00_set_fcport_disc_state(sess, DSC_DELETE_PEND);\n\n\tqla24xx_chk_fcp_state(sess);\n\n\tql_dbg(ql_log_warn, sess->vha, 0xe001,\n\t    \"Scheduling sess %p for deletion %8phC\\n\",\n\t    sess, sess->port_name);\n\n\tWARN_ON(!queue_work(sess->vha->hw->wq, &sess->del_work));\n}\n\nstatic void qlt_clear_tgt_db(struct qla_tgt *tgt)\n{\n\tstruct fc_port *sess;\n\tscsi_qla_host_t *vha = tgt->vha;\n\n\tlist_for_each_entry(sess, &vha->vp_fcports, list) {\n\t\tif (sess->se_sess)\n\t\t\tqlt_schedule_sess_for_deletion(sess);\n\t}\n\n\t/* At this point tgt could be already dead */\n}\n\nstatic int qla24xx_get_loop_id(struct scsi_qla_host *vha, be_id_t s_id,\n\tuint16_t *loop_id)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tdma_addr_t gid_list_dma;\n\tstruct gid_list_info *gid_list, *gid;\n\tint res, rc, i;\n\tuint16_t entries;\n\n\tgid_list = dma_alloc_coherent(&ha->pdev->dev, qla2x00_gid_list_size(ha),\n\t    &gid_list_dma, GFP_KERNEL);\n\tif (!gid_list) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf044,\n\t\t    \"qla_target(%d): DMA Alloc failed of %u\\n\",\n\t\t    vha->vp_idx, qla2x00_gid_list_size(ha));\n\t\treturn -ENOMEM;\n\t}\n\n\t/* Get list of logged in devices */\n\trc = qla24xx_gidlist_wait(vha, gid_list, gid_list_dma, &entries);\n\tif (rc != QLA_SUCCESS) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf045,\n\t\t    \"qla_target(%d): get_id_list() failed: %x\\n\",\n\t\t    vha->vp_idx, rc);\n\t\tres = -EBUSY;\n\t\tgoto out_free_id_list;\n\t}\n\n\tgid = gid_list;\n\tres = -ENOENT;\n\tfor (i = 0; i < entries; i++) {\n\t\tif (gid->al_pa == s_id.al_pa &&\n\t\t    gid->area == s_id.area &&\n\t\t    gid->domain == s_id.domain) {\n\t\t\t*loop_id = le16_to_cpu(gid->loop_id);\n\t\t\tres = 0;\n\t\t\tbreak;\n\t\t}\n\t\tgid = (void *)gid + ha->gid_list_info_size;\n\t}\n\nout_free_id_list:\n\tdma_free_coherent(&ha->pdev->dev, qla2x00_gid_list_size(ha),\n\t    gid_list, gid_list_dma);\n\treturn res;\n}\n\n/*\n * Adds an extra ref to allow to drop hw lock after adding sess to the list.\n * Caller must put it.\n */\nstatic struct fc_port *qlt_create_sess(\n\tstruct scsi_qla_host *vha,\n\tfc_port_t *fcport,\n\tbool local)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct fc_port *sess = fcport;\n\tunsigned long flags;\n\n\tif (vha->vha_tgt.qla_tgt->tgt_stop)\n\t\treturn NULL;\n\n\tif (fcport->se_sess) {\n\t\tif (!kref_get_unless_zero(&sess->sess_kref)) {\n\t\t\tql_dbg(ql_dbg_disc, vha, 0x20f6,\n\t\t\t    \"%s: kref_get_unless_zero failed for %8phC\\n\",\n\t\t\t    __func__, sess->port_name);\n\t\t\treturn NULL;\n\t\t}\n\t\treturn fcport;\n\t}\n\tsess->tgt = vha->vha_tgt.qla_tgt;\n\tsess->local = local;\n\n\t/*\n\t * Under normal circumstances we want to logout from firmware when\n\t * session eventually ends and release corresponding nport handle.\n\t * In the exception cases (e.g. when new PLOGI is waiting) corresponding\n\t * code will adjust these flags as necessary.\n\t */\n\tsess->logout_on_delete = 1;\n\tsess->keep_nport_handle = 0;\n\tsess->logout_completed = 0;\n\n\tif (ha->tgt.tgt_ops->check_initiator_node_acl(vha,\n\t    &fcport->port_name[0], sess) < 0) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf015,\n\t\t    \"(%d) %8phC check_initiator_node_acl failed\\n\",\n\t\t    vha->vp_idx, fcport->port_name);\n\t\treturn NULL;\n\t} else {\n\t\tkref_init(&fcport->sess_kref);\n\t\t/*\n\t\t * Take an extra reference to ->sess_kref here to handle\n\t\t * fc_port access across ->tgt.sess_lock reaquire.\n\t\t */\n\t\tif (!kref_get_unless_zero(&sess->sess_kref)) {\n\t\t\tql_dbg(ql_dbg_disc, vha, 0x20f7,\n\t\t\t    \"%s: kref_get_unless_zero failed for %8phC\\n\",\n\t\t\t    __func__, sess->port_name);\n\t\t\treturn NULL;\n\t\t}\n\n\t\tspin_lock_irqsave(&ha->tgt.sess_lock, flags);\n\t\tif (!IS_SW_RESV_ADDR(sess->d_id))\n\t\t\tvha->vha_tgt.qla_tgt->sess_count++;\n\n\t\tqlt_do_generation_tick(vha, &sess->generation);\n\t\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\n\t}\n\n\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf006,\n\t    \"Adding sess %p se_sess %p  to tgt %p sess_count %d\\n\",\n\t    sess, sess->se_sess, vha->vha_tgt.qla_tgt,\n\t    vha->vha_tgt.qla_tgt->sess_count);\n\n\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf04b,\n\t    \"qla_target(%d): %ssession for wwn %8phC (loop_id %d, \"\n\t    \"s_id %x:%x:%x, confirmed completion %ssupported) added\\n\",\n\t    vha->vp_idx, local ?  \"local \" : \"\", fcport->port_name,\n\t    fcport->loop_id, sess->d_id.b.domain, sess->d_id.b.area,\n\t    sess->d_id.b.al_pa, sess->conf_compl_supported ?  \"\" : \"not \");\n\n\treturn sess;\n}\n\n/*\n * max_gen - specifies maximum session generation\n * at which this deletion requestion is still valid\n */\nvoid\nqlt_fc_port_deleted(struct scsi_qla_host *vha, fc_port_t *fcport, int max_gen)\n{\n\tstruct qla_tgt *tgt = vha->vha_tgt.qla_tgt;\n\tstruct fc_port *sess = fcport;\n\tunsigned long flags;\n\n\tif (!vha->hw->tgt.tgt_ops)\n\t\treturn;\n\n\tif (!tgt)\n\t\treturn;\n\n\tspin_lock_irqsave(&vha->hw->tgt.sess_lock, flags);\n\tif (tgt->tgt_stop) {\n\t\tspin_unlock_irqrestore(&vha->hw->tgt.sess_lock, flags);\n\t\treturn;\n\t}\n\tif (!sess->se_sess) {\n\t\tspin_unlock_irqrestore(&vha->hw->tgt.sess_lock, flags);\n\t\treturn;\n\t}\n\n\tif (max_gen - sess->generation < 0) {\n\t\tspin_unlock_irqrestore(&vha->hw->tgt.sess_lock, flags);\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf092,\n\t\t    \"Ignoring stale deletion request for se_sess %p / sess %p\"\n\t\t    \" for port %8phC, req_gen %d, sess_gen %d\\n\",\n\t\t    sess->se_sess, sess, sess->port_name, max_gen,\n\t\t    sess->generation);\n\t\treturn;\n\t}\n\n\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf008, \"qla_tgt_fc_port_deleted %p\", sess);\n\n\tsess->local = 1;\n\tspin_unlock_irqrestore(&vha->hw->tgt.sess_lock, flags);\n\tqlt_schedule_sess_for_deletion(sess);\n}\n\nstatic inline int test_tgt_sess_count(struct qla_tgt *tgt)\n{\n\tstruct qla_hw_data *ha = tgt->ha;\n\tunsigned long flags;\n\tint res;\n\t/*\n\t * We need to protect against race, when tgt is freed before or\n\t * inside wake_up()\n\t */\n\tspin_lock_irqsave(&ha->tgt.sess_lock, flags);\n\tql_dbg(ql_dbg_tgt, tgt->vha, 0xe002,\n\t    \"tgt %p, sess_count=%d\\n\",\n\t    tgt, tgt->sess_count);\n\tres = (tgt->sess_count == 0);\n\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\n\n\treturn res;\n}\n\n/* Called by tcm_qla2xxx configfs code */\nint qlt_stop_phase1(struct qla_tgt *tgt)\n{\n\tstruct scsi_qla_host *vha = tgt->vha;\n\tstruct qla_hw_data *ha = tgt->ha;\n\tunsigned long flags;\n\n\tmutex_lock(&ha->optrom_mutex);\n\tmutex_lock(&qla_tgt_mutex);\n\n\tif (tgt->tgt_stop || tgt->tgt_stopped) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf04e,\n\t\t    \"Already in tgt->tgt_stop or tgt_stopped state\\n\");\n\t\tmutex_unlock(&qla_tgt_mutex);\n\t\tmutex_unlock(&ha->optrom_mutex);\n\t\treturn -EPERM;\n\t}\n\n\tql_dbg(ql_dbg_tgt_mgt, vha, 0xe003, \"Stopping target for host %ld(%p)\\n\",\n\t    vha->host_no, vha);\n\t/*\n\t * Mutex needed to sync with qla_tgt_fc_port_[added,deleted].\n\t * Lock is needed, because we still can get an incoming packet.\n\t */\n\tmutex_lock(&vha->vha_tgt.tgt_mutex);\n\ttgt->tgt_stop = 1;\n\tqlt_clear_tgt_db(tgt);\n\tmutex_unlock(&vha->vha_tgt.tgt_mutex);\n\tmutex_unlock(&qla_tgt_mutex);\n\n\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf009,\n\t    \"Waiting for sess works (tgt %p)\", tgt);\n\tspin_lock_irqsave(&tgt->sess_work_lock, flags);\n\twhile (!list_empty(&tgt->sess_works_list)) {\n\t\tspin_unlock_irqrestore(&tgt->sess_work_lock, flags);\n\t\tflush_scheduled_work();\n\t\tspin_lock_irqsave(&tgt->sess_work_lock, flags);\n\t}\n\tspin_unlock_irqrestore(&tgt->sess_work_lock, flags);\n\n\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf00a,\n\t    \"Waiting for tgt %p: sess_count=%d\\n\", tgt, tgt->sess_count);\n\n\twait_event_timeout(tgt->waitQ, test_tgt_sess_count(tgt), 10*HZ);\n\n\t/* Big hammer */\n\tif (!ha->flags.host_shutting_down &&\n\t    (qla_tgt_mode_enabled(vha) || qla_dual_mode_enabled(vha)))\n\t\tqlt_disable_vha(vha);\n\n\t/* Wait for sessions to clear out (just in case) */\n\twait_event_timeout(tgt->waitQ, test_tgt_sess_count(tgt), 10*HZ);\n\tmutex_unlock(&ha->optrom_mutex);\n\n\treturn 0;\n}\nEXPORT_SYMBOL(qlt_stop_phase1);\n\n/* Called by tcm_qla2xxx configfs code */\nvoid qlt_stop_phase2(struct qla_tgt *tgt)\n{\n\tscsi_qla_host_t *vha = tgt->vha;\n\n\tif (tgt->tgt_stopped) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf04f,\n\t\t    \"Already in tgt->tgt_stopped state\\n\");\n\t\tdump_stack();\n\t\treturn;\n\t}\n\tif (!tgt->tgt_stop) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf00b,\n\t\t    \"%s: phase1 stop is not completed\\n\", __func__);\n\t\tdump_stack();\n\t\treturn;\n\t}\n\n\tmutex_lock(&vha->vha_tgt.tgt_mutex);\n\ttgt->tgt_stop = 0;\n\ttgt->tgt_stopped = 1;\n\tmutex_unlock(&vha->vha_tgt.tgt_mutex);\n\n\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf00c, \"Stop of tgt %p finished\\n\",\n\t    tgt);\n\n\tswitch (vha->qlini_mode) {\n\tcase QLA2XXX_INI_MODE_EXCLUSIVE:\n\t\tvha->flags.online = 1;\n\t\tset_bit(ISP_ABORT_NEEDED, &vha->dpc_flags);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\nEXPORT_SYMBOL(qlt_stop_phase2);\n\n/* Called from qlt_remove_target() -> qla2x00_remove_one() */\nstatic void qlt_release(struct qla_tgt *tgt)\n{\n\tscsi_qla_host_t *vha = tgt->vha;\n\tvoid *node;\n\tu64 key = 0;\n\tu16 i;\n\tstruct qla_qpair_hint *h;\n\tstruct qla_hw_data *ha = vha->hw;\n\n\tif (!tgt->tgt_stop && !tgt->tgt_stopped)\n\t\tqlt_stop_phase1(tgt);\n\n\tif (!tgt->tgt_stopped)\n\t\tqlt_stop_phase2(tgt);\n\n\tfor (i = 0; i < vha->hw->max_qpairs + 1; i++) {\n\t\tunsigned long flags;\n\n\t\th = &tgt->qphints[i];\n\t\tif (h->qpair) {\n\t\t\tspin_lock_irqsave(h->qpair->qp_lock_ptr, flags);\n\t\t\tlist_del(&h->hint_elem);\n\t\t\tspin_unlock_irqrestore(h->qpair->qp_lock_ptr, flags);\n\t\t\th->qpair = NULL;\n\t\t}\n\t}\n\tkfree(tgt->qphints);\n\tmutex_lock(&qla_tgt_mutex);\n\tlist_del(&vha->vha_tgt.qla_tgt->tgt_list_entry);\n\tmutex_unlock(&qla_tgt_mutex);\n\n\tbtree_for_each_safe64(&tgt->lun_qpair_map, key, node)\n\t\tbtree_remove64(&tgt->lun_qpair_map, key);\n\n\tbtree_destroy64(&tgt->lun_qpair_map);\n\n\tif (vha->vp_idx)\n\t\tif (ha->tgt.tgt_ops &&\n\t\t    ha->tgt.tgt_ops->remove_target &&\n\t\t    vha->vha_tgt.target_lport_ptr)\n\t\t\tha->tgt.tgt_ops->remove_target(vha);\n\n\tvha->vha_tgt.qla_tgt = NULL;\n\n\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf00d,\n\t    \"Release of tgt %p finished\\n\", tgt);\n\n\tkfree(tgt);\n}\n\n/* ha->hardware_lock supposed to be held on entry */\nstatic int qlt_sched_sess_work(struct qla_tgt *tgt, int type,\n\tconst void *param, unsigned int param_size)\n{\n\tstruct qla_tgt_sess_work_param *prm;\n\tunsigned long flags;\n\n\tprm = kzalloc(sizeof(*prm), GFP_ATOMIC);\n\tif (!prm) {\n\t\tql_dbg(ql_dbg_tgt_mgt, tgt->vha, 0xf050,\n\t\t    \"qla_target(%d): Unable to create session \"\n\t\t    \"work, command will be refused\", 0);\n\t\treturn -ENOMEM;\n\t}\n\n\tql_dbg(ql_dbg_tgt_mgt, tgt->vha, 0xf00e,\n\t    \"Scheduling work (type %d, prm %p)\"\n\t    \" to find session for param %p (size %d, tgt %p)\\n\",\n\t    type, prm, param, param_size, tgt);\n\n\tprm->type = type;\n\tmemcpy(&prm->tm_iocb, param, param_size);\n\n\tspin_lock_irqsave(&tgt->sess_work_lock, flags);\n\tlist_add_tail(&prm->sess_works_list_entry, &tgt->sess_works_list);\n\tspin_unlock_irqrestore(&tgt->sess_work_lock, flags);\n\n\tschedule_work(&tgt->sess_work);\n\n\treturn 0;\n}\n\n/*\n * ha->hardware_lock supposed to be held on entry. Might drop it, then reaquire\n */\nstatic void qlt_send_notify_ack(struct qla_qpair *qpair,\n\tstruct imm_ntfy_from_isp *ntfy,\n\tuint32_t add_flags, uint16_t resp_code, int resp_code_valid,\n\tuint16_t srr_flags, uint16_t srr_reject_code, uint8_t srr_explan)\n{\n\tstruct scsi_qla_host *vha = qpair->vha;\n\tstruct qla_hw_data *ha = vha->hw;\n\trequest_t *pkt;\n\tstruct nack_to_isp *nack;\n\n\tif (!ha->flags.fw_started)\n\t\treturn;\n\n\tql_dbg(ql_dbg_tgt, vha, 0xe004, \"Sending NOTIFY_ACK (ha=%p)\\n\", ha);\n\n\tpkt = (request_t *)__qla2x00_alloc_iocbs(qpair, NULL);\n\tif (!pkt) {\n\t\tql_dbg(ql_dbg_tgt, vha, 0xe049,\n\t\t    \"qla_target(%d): %s failed: unable to allocate \"\n\t\t    \"request packet\\n\", vha->vp_idx, __func__);\n\t\treturn;\n\t}\n\n\tif (vha->vha_tgt.qla_tgt != NULL)\n\t\tvha->vha_tgt.qla_tgt->notify_ack_expected++;\n\n\tpkt->entry_type = NOTIFY_ACK_TYPE;\n\tpkt->entry_count = 1;\n\n\tnack = (struct nack_to_isp *)pkt;\n\tnack->ox_id = ntfy->ox_id;\n\n\tnack->u.isp24.handle = QLA_TGT_SKIP_HANDLE;\n\tnack->u.isp24.nport_handle = ntfy->u.isp24.nport_handle;\n\tif (le16_to_cpu(ntfy->u.isp24.status) == IMM_NTFY_ELS) {\n\t\tnack->u.isp24.flags = ntfy->u.isp24.flags &\n\t\t\tcpu_to_le16(NOTIFY24XX_FLAGS_PUREX_IOCB);\n\t}\n\tnack->u.isp24.srr_rx_id = ntfy->u.isp24.srr_rx_id;\n\tnack->u.isp24.status = ntfy->u.isp24.status;\n\tnack->u.isp24.status_subcode = ntfy->u.isp24.status_subcode;\n\tnack->u.isp24.fw_handle = ntfy->u.isp24.fw_handle;\n\tnack->u.isp24.exchange_address = ntfy->u.isp24.exchange_address;\n\tnack->u.isp24.srr_rel_offs = ntfy->u.isp24.srr_rel_offs;\n\tnack->u.isp24.srr_ui = ntfy->u.isp24.srr_ui;\n\tnack->u.isp24.srr_flags = cpu_to_le16(srr_flags);\n\tnack->u.isp24.srr_reject_code = srr_reject_code;\n\tnack->u.isp24.srr_reject_code_expl = srr_explan;\n\tnack->u.isp24.vp_index = ntfy->u.isp24.vp_index;\n\n\tql_dbg(ql_dbg_tgt, vha, 0xe005,\n\t    \"qla_target(%d): Sending 24xx Notify Ack %d\\n\",\n\t    vha->vp_idx, nack->u.isp24.status);\n\n\t/* Memory Barrier */\n\twmb();\n\tqla2x00_start_iocbs(vha, qpair->req);\n}\n\nstatic int qlt_build_abts_resp_iocb(struct qla_tgt_mgmt_cmd *mcmd)\n{\n\tstruct scsi_qla_host *vha = mcmd->vha;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct abts_resp_to_24xx *resp;\n\t__le32 f_ctl;\n\tuint32_t h;\n\tuint8_t *p;\n\tint rc;\n\tstruct abts_recv_from_24xx *abts = &mcmd->orig_iocb.abts;\n\tstruct qla_qpair *qpair = mcmd->qpair;\n\n\tql_dbg(ql_dbg_tgt, vha, 0xe006,\n\t    \"Sending task mgmt ABTS response (ha=%p, status=%x)\\n\",\n\t    ha, mcmd->fc_tm_rsp);\n\n\trc = qlt_check_reserve_free_req(qpair, 1);\n\tif (rc) {\n\t\tql_dbg(ql_dbg_tgt, vha, 0xe04a,\n\t\t    \"qla_target(%d): %s failed: unable to allocate request packet\\n\",\n\t\t    vha->vp_idx, __func__);\n\t\treturn -EAGAIN;\n\t}\n\n\tresp = (struct abts_resp_to_24xx *)qpair->req->ring_ptr;\n\tmemset(resp, 0, sizeof(*resp));\n\n\th = qlt_make_handle(qpair);\n\tif (unlikely(h == QLA_TGT_NULL_HANDLE)) {\n\t\t/*\n\t\t * CTIO type 7 from the firmware doesn't provide a way to\n\t\t * know the initiator's LOOP ID, hence we can't find\n\t\t * the session and, so, the command.\n\t\t */\n\t\treturn -EAGAIN;\n\t} else {\n\t\tqpair->req->outstanding_cmds[h] = (srb_t *)mcmd;\n\t}\n\n\tresp->handle = make_handle(qpair->req->id, h);\n\tresp->entry_type = ABTS_RESP_24XX;\n\tresp->entry_count = 1;\n\tresp->nport_handle = abts->nport_handle;\n\tresp->vp_index = vha->vp_idx;\n\tresp->sof_type = abts->sof_type;\n\tresp->exchange_address = abts->exchange_address;\n\tresp->fcp_hdr_le = abts->fcp_hdr_le;\n\tf_ctl = cpu_to_le32(F_CTL_EXCH_CONTEXT_RESP |\n\t    F_CTL_LAST_SEQ | F_CTL_END_SEQ |\n\t    F_CTL_SEQ_INITIATIVE);\n\tp = (uint8_t *)&f_ctl;\n\tresp->fcp_hdr_le.f_ctl[0] = *p++;\n\tresp->fcp_hdr_le.f_ctl[1] = *p++;\n\tresp->fcp_hdr_le.f_ctl[2] = *p;\n\n\tresp->fcp_hdr_le.d_id = abts->fcp_hdr_le.s_id;\n\tresp->fcp_hdr_le.s_id = abts->fcp_hdr_le.d_id;\n\n\tresp->exchange_addr_to_abort = abts->exchange_addr_to_abort;\n\tif (mcmd->fc_tm_rsp == FCP_TMF_CMPL) {\n\t\tresp->fcp_hdr_le.r_ctl = R_CTL_BASIC_LINK_SERV | R_CTL_B_ACC;\n\t\tresp->payload.ba_acct.seq_id_valid = SEQ_ID_INVALID;\n\t\tresp->payload.ba_acct.low_seq_cnt = 0x0000;\n\t\tresp->payload.ba_acct.high_seq_cnt = cpu_to_le16(0xFFFF);\n\t\tresp->payload.ba_acct.ox_id = abts->fcp_hdr_le.ox_id;\n\t\tresp->payload.ba_acct.rx_id = abts->fcp_hdr_le.rx_id;\n\t} else {\n\t\tresp->fcp_hdr_le.r_ctl = R_CTL_BASIC_LINK_SERV | R_CTL_B_RJT;\n\t\tresp->payload.ba_rjt.reason_code =\n\t\t\tBA_RJT_REASON_CODE_UNABLE_TO_PERFORM;\n\t\t/* Other bytes are zero */\n\t}\n\n\tvha->vha_tgt.qla_tgt->abts_resp_expected++;\n\n\t/* Memory Barrier */\n\twmb();\n\tif (qpair->reqq_start_iocbs)\n\t\tqpair->reqq_start_iocbs(qpair);\n\telse\n\t\tqla2x00_start_iocbs(vha, qpair->req);\n\n\treturn rc;\n}\n\n/*\n * ha->hardware_lock supposed to be held on entry. Might drop it, then reaquire\n */\nstatic void qlt_24xx_send_abts_resp(struct qla_qpair *qpair,\n\tstruct abts_recv_from_24xx *abts, uint32_t status,\n\tbool ids_reversed)\n{\n\tstruct scsi_qla_host *vha = qpair->vha;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct abts_resp_to_24xx *resp;\n\t__le32 f_ctl;\n\tuint8_t *p;\n\n\tql_dbg(ql_dbg_tgt, vha, 0xe006,\n\t    \"Sending task mgmt ABTS response (ha=%p, atio=%p, status=%x\\n\",\n\t    ha, abts, status);\n\n\tresp = (struct abts_resp_to_24xx *)qla2x00_alloc_iocbs_ready(qpair,\n\t    NULL);\n\tif (!resp) {\n\t\tql_dbg(ql_dbg_tgt, vha, 0xe04a,\n\t\t    \"qla_target(%d): %s failed: unable to allocate \"\n\t\t    \"request packet\", vha->vp_idx, __func__);\n\t\treturn;\n\t}\n\n\tresp->entry_type = ABTS_RESP_24XX;\n\tresp->handle = QLA_TGT_SKIP_HANDLE;\n\tresp->entry_count = 1;\n\tresp->nport_handle = abts->nport_handle;\n\tresp->vp_index = vha->vp_idx;\n\tresp->sof_type = abts->sof_type;\n\tresp->exchange_address = abts->exchange_address;\n\tresp->fcp_hdr_le = abts->fcp_hdr_le;\n\tf_ctl = cpu_to_le32(F_CTL_EXCH_CONTEXT_RESP |\n\t    F_CTL_LAST_SEQ | F_CTL_END_SEQ |\n\t    F_CTL_SEQ_INITIATIVE);\n\tp = (uint8_t *)&f_ctl;\n\tresp->fcp_hdr_le.f_ctl[0] = *p++;\n\tresp->fcp_hdr_le.f_ctl[1] = *p++;\n\tresp->fcp_hdr_le.f_ctl[2] = *p;\n\tif (ids_reversed) {\n\t\tresp->fcp_hdr_le.d_id = abts->fcp_hdr_le.d_id;\n\t\tresp->fcp_hdr_le.s_id = abts->fcp_hdr_le.s_id;\n\t} else {\n\t\tresp->fcp_hdr_le.d_id = abts->fcp_hdr_le.s_id;\n\t\tresp->fcp_hdr_le.s_id = abts->fcp_hdr_le.d_id;\n\t}\n\tresp->exchange_addr_to_abort = abts->exchange_addr_to_abort;\n\tif (status == FCP_TMF_CMPL) {\n\t\tresp->fcp_hdr_le.r_ctl = R_CTL_BASIC_LINK_SERV | R_CTL_B_ACC;\n\t\tresp->payload.ba_acct.seq_id_valid = SEQ_ID_INVALID;\n\t\tresp->payload.ba_acct.low_seq_cnt = 0x0000;\n\t\tresp->payload.ba_acct.high_seq_cnt = cpu_to_le16(0xFFFF);\n\t\tresp->payload.ba_acct.ox_id = abts->fcp_hdr_le.ox_id;\n\t\tresp->payload.ba_acct.rx_id = abts->fcp_hdr_le.rx_id;\n\t} else {\n\t\tresp->fcp_hdr_le.r_ctl = R_CTL_BASIC_LINK_SERV | R_CTL_B_RJT;\n\t\tresp->payload.ba_rjt.reason_code =\n\t\t\tBA_RJT_REASON_CODE_UNABLE_TO_PERFORM;\n\t\t/* Other bytes are zero */\n\t}\n\n\tvha->vha_tgt.qla_tgt->abts_resp_expected++;\n\n\t/* Memory Barrier */\n\twmb();\n\tif (qpair->reqq_start_iocbs)\n\t\tqpair->reqq_start_iocbs(qpair);\n\telse\n\t\tqla2x00_start_iocbs(vha, qpair->req);\n}\n\n/*\n * ha->hardware_lock supposed to be held on entry. Might drop it, then reaquire\n */\nstatic void qlt_24xx_retry_term_exchange(struct scsi_qla_host *vha,\n    struct qla_qpair *qpair, response_t *pkt, struct qla_tgt_mgmt_cmd *mcmd)\n{\n\tstruct ctio7_to_24xx *ctio;\n\tu16 tmp;\n\tstruct abts_recv_from_24xx *entry;\n\n\tctio = (struct ctio7_to_24xx *)qla2x00_alloc_iocbs_ready(qpair, NULL);\n\tif (ctio == NULL) {\n\t\tql_dbg(ql_dbg_tgt, vha, 0xe04b,\n\t\t    \"qla_target(%d): %s failed: unable to allocate \"\n\t\t    \"request packet\\n\", vha->vp_idx, __func__);\n\t\treturn;\n\t}\n\n\tif (mcmd)\n\t\t/* abts from remote port */\n\t\tentry = &mcmd->orig_iocb.abts;\n\telse\n\t\t/* abts from this driver.  */\n\t\tentry = (struct abts_recv_from_24xx *)pkt;\n\n\t/*\n\t * We've got on entrance firmware's response on by us generated\n\t * ABTS response. So, in it ID fields are reversed.\n\t */\n\n\tctio->entry_type = CTIO_TYPE7;\n\tctio->entry_count = 1;\n\tctio->nport_handle = entry->nport_handle;\n\tctio->handle = QLA_TGT_SKIP_HANDLE |\tCTIO_COMPLETION_HANDLE_MARK;\n\tctio->timeout = cpu_to_le16(QLA_TGT_TIMEOUT);\n\tctio->vp_index = vha->vp_idx;\n\tctio->exchange_addr = entry->exchange_addr_to_abort;\n\ttmp = (CTIO7_FLAGS_STATUS_MODE_1 | CTIO7_FLAGS_TERMINATE);\n\n\tif (mcmd) {\n\t\tctio->initiator_id = entry->fcp_hdr_le.s_id;\n\n\t\tif (mcmd->flags & QLA24XX_MGMT_ABORT_IO_ATTR_VALID)\n\t\t\ttmp |= (mcmd->abort_io_attr << 9);\n\t\telse if (qpair->retry_term_cnt & 1)\n\t\t\ttmp |= (0x4 << 9);\n\t} else {\n\t\tctio->initiator_id = entry->fcp_hdr_le.d_id;\n\n\t\tif (qpair->retry_term_cnt & 1)\n\t\t\ttmp |= (0x4 << 9);\n\t}\n\tctio->u.status1.flags = cpu_to_le16(tmp);\n\tctio->u.status1.ox_id = entry->fcp_hdr_le.ox_id;\n\n\tql_dbg(ql_dbg_tgt, vha, 0xe007,\n\t    \"Sending retry TERM EXCH CTIO7 flags %04xh oxid %04xh attr valid %x\\n\",\n\t    le16_to_cpu(ctio->u.status1.flags),\n\t    le16_to_cpu(ctio->u.status1.ox_id),\n\t    (mcmd && mcmd->flags & QLA24XX_MGMT_ABORT_IO_ATTR_VALID) ? 1 : 0);\n\n\t/* Memory Barrier */\n\twmb();\n\tif (qpair->reqq_start_iocbs)\n\t\tqpair->reqq_start_iocbs(qpair);\n\telse\n\t\tqla2x00_start_iocbs(vha, qpair->req);\n\n\tif (mcmd)\n\t\tqlt_build_abts_resp_iocb(mcmd);\n\telse\n\t\tqlt_24xx_send_abts_resp(qpair,\n\t\t    (struct abts_recv_from_24xx *)entry, FCP_TMF_CMPL, true);\n\n}\n\n/* drop cmds for the given lun\n * XXX only looks for cmds on the port through which lun reset was recieved\n * XXX does not go through the list of other port (which may have cmds\n *     for the same lun)\n */\nstatic void abort_cmds_for_lun(struct scsi_qla_host *vha, u64 lun, be_id_t s_id)\n{\n\tstruct qla_tgt_sess_op *op;\n\tstruct qla_tgt_cmd *cmd;\n\tuint32_t key;\n\tunsigned long flags;\n\n\tkey = sid_to_key(s_id);\n\tspin_lock_irqsave(&vha->cmd_list_lock, flags);\n\tlist_for_each_entry(op, &vha->qla_sess_op_cmd_list, cmd_list) {\n\t\tuint32_t op_key;\n\t\tu64 op_lun;\n\n\t\top_key = sid_to_key(op->atio.u.isp24.fcp_hdr.s_id);\n\t\top_lun = scsilun_to_int(\n\t\t\t(struct scsi_lun *)&op->atio.u.isp24.fcp_cmnd.lun);\n\t\tif (op_key == key && op_lun == lun)\n\t\t\top->aborted = true;\n\t}\n\n\tlist_for_each_entry(op, &vha->unknown_atio_list, cmd_list) {\n\t\tuint32_t op_key;\n\t\tu64 op_lun;\n\n\t\top_key = sid_to_key(op->atio.u.isp24.fcp_hdr.s_id);\n\t\top_lun = scsilun_to_int(\n\t\t\t(struct scsi_lun *)&op->atio.u.isp24.fcp_cmnd.lun);\n\t\tif (op_key == key && op_lun == lun)\n\t\t\top->aborted = true;\n\t}\n\n\tlist_for_each_entry(cmd, &vha->qla_cmd_list, cmd_list) {\n\t\tuint32_t cmd_key;\n\t\tu64 cmd_lun;\n\n\t\tcmd_key = sid_to_key(cmd->atio.u.isp24.fcp_hdr.s_id);\n\t\tcmd_lun = scsilun_to_int(\n\t\t\t(struct scsi_lun *)&cmd->atio.u.isp24.fcp_cmnd.lun);\n\t\tif (cmd_key == key && cmd_lun == lun)\n\t\t\tcmd->aborted = 1;\n\t}\n\tspin_unlock_irqrestore(&vha->cmd_list_lock, flags);\n}\n\nstatic struct qla_qpair_hint *qlt_find_qphint(struct scsi_qla_host *vha,\n    uint64_t unpacked_lun)\n{\n\tstruct qla_tgt *tgt = vha->vha_tgt.qla_tgt;\n\tstruct qla_qpair_hint *h = NULL;\n\n\tif (vha->flags.qpairs_available) {\n\t\th = btree_lookup64(&tgt->lun_qpair_map, unpacked_lun);\n\t\tif (!h)\n\t\t\th = &tgt->qphints[0];\n\t} else {\n\t\th = &tgt->qphints[0];\n\t}\n\n\treturn h;\n}\n\nstatic void qlt_do_tmr_work(struct work_struct *work)\n{\n\tstruct qla_tgt_mgmt_cmd *mcmd =\n\t\tcontainer_of(work, struct qla_tgt_mgmt_cmd, work);\n\tstruct qla_hw_data *ha = mcmd->vha->hw;\n\tint rc;\n\tuint32_t tag;\n\tunsigned long flags;\n\n\tswitch (mcmd->tmr_func) {\n\tcase QLA_TGT_ABTS:\n\t\ttag = le32_to_cpu(mcmd->orig_iocb.abts.exchange_addr_to_abort);\n\t\tbreak;\n\tdefault:\n\t\ttag = 0;\n\t\tbreak;\n\t}\n\n\trc = ha->tgt.tgt_ops->handle_tmr(mcmd, mcmd->unpacked_lun,\n\t    mcmd->tmr_func, tag);\n\n\tif (rc != 0) {\n\t\tspin_lock_irqsave(mcmd->qpair->qp_lock_ptr, flags);\n\t\tswitch (mcmd->tmr_func) {\n\t\tcase QLA_TGT_ABTS:\n\t\t\tmcmd->fc_tm_rsp = FCP_TMF_REJECTED;\n\t\t\tqlt_build_abts_resp_iocb(mcmd);\n\t\t\tbreak;\n\t\tcase QLA_TGT_LUN_RESET:\n\t\tcase QLA_TGT_CLEAR_TS:\n\t\tcase QLA_TGT_ABORT_TS:\n\t\tcase QLA_TGT_CLEAR_ACA:\n\t\tcase QLA_TGT_TARGET_RESET:\n\t\t\tqlt_send_busy(mcmd->qpair, &mcmd->orig_iocb.atio,\n\t\t\t    qla_sam_status);\n\t\t\tbreak;\n\n\t\tcase QLA_TGT_ABORT_ALL:\n\t\tcase QLA_TGT_NEXUS_LOSS_SESS:\n\t\tcase QLA_TGT_NEXUS_LOSS:\n\t\t\tqlt_send_notify_ack(mcmd->qpair,\n\t\t\t    &mcmd->orig_iocb.imm_ntfy, 0, 0, 0, 0, 0, 0);\n\t\t\tbreak;\n\t\t}\n\t\tspin_unlock_irqrestore(mcmd->qpair->qp_lock_ptr, flags);\n\n\t\tql_dbg(ql_dbg_tgt_mgt, mcmd->vha, 0xf052,\n\t\t    \"qla_target(%d):  tgt_ops->handle_tmr() failed: %d\\n\",\n\t\t    mcmd->vha->vp_idx, rc);\n\t\tmempool_free(mcmd, qla_tgt_mgmt_cmd_mempool);\n\t}\n}\n\n/* ha->hardware_lock supposed to be held on entry */\nstatic int __qlt_24xx_handle_abts(struct scsi_qla_host *vha,\n\tstruct abts_recv_from_24xx *abts, struct fc_port *sess)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct qla_tgt_mgmt_cmd *mcmd;\n\tstruct qla_qpair_hint *h = &vha->vha_tgt.qla_tgt->qphints[0];\n\tstruct qla_tgt_cmd *abort_cmd;\n\n\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf00f,\n\t    \"qla_target(%d): task abort (tag=%d)\\n\",\n\t    vha->vp_idx, abts->exchange_addr_to_abort);\n\n\tmcmd = mempool_alloc(qla_tgt_mgmt_cmd_mempool, GFP_ATOMIC);\n\tif (mcmd == NULL) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf051,\n\t\t    \"qla_target(%d): %s: Allocation of ABORT cmd failed\",\n\t\t    vha->vp_idx, __func__);\n\t\treturn -ENOMEM;\n\t}\n\tmemset(mcmd, 0, sizeof(*mcmd));\n\tmcmd->cmd_type = TYPE_TGT_TMCMD;\n\tmcmd->sess = sess;\n\tmemcpy(&mcmd->orig_iocb.abts, abts, sizeof(mcmd->orig_iocb.abts));\n\tmcmd->reset_count = ha->base_qpair->chip_reset;\n\tmcmd->tmr_func = QLA_TGT_ABTS;\n\tmcmd->qpair = h->qpair;\n\tmcmd->vha = vha;\n\n\t/*\n\t * LUN is looked up by target-core internally based on the passed\n\t * abts->exchange_addr_to_abort tag.\n\t */\n\tmcmd->se_cmd.cpuid = h->cpuid;\n\n\tabort_cmd = ha->tgt.tgt_ops->find_cmd_by_tag(sess,\n\t\t\t\tle32_to_cpu(abts->exchange_addr_to_abort));\n\tif (!abort_cmd)\n\t\treturn -EIO;\n\tmcmd->unpacked_lun = abort_cmd->se_cmd.orig_fe_lun;\n\n\tif (abort_cmd->qpair) {\n\t\tmcmd->qpair = abort_cmd->qpair;\n\t\tmcmd->se_cmd.cpuid = abort_cmd->se_cmd.cpuid;\n\t\tmcmd->abort_io_attr = abort_cmd->atio.u.isp24.attr;\n\t\tmcmd->flags = QLA24XX_MGMT_ABORT_IO_ATTR_VALID;\n\t}\n\n\tINIT_WORK(&mcmd->work, qlt_do_tmr_work);\n\tqueue_work_on(mcmd->se_cmd.cpuid, qla_tgt_wq, &mcmd->work);\n\n\treturn 0;\n}\n\n/*\n * ha->hardware_lock supposed to be held on entry. Might drop it, then reaquire\n */\nstatic void qlt_24xx_handle_abts(struct scsi_qla_host *vha,\n\tstruct abts_recv_from_24xx *abts)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct fc_port *sess;\n\tuint32_t tag = le32_to_cpu(abts->exchange_addr_to_abort);\n\tbe_id_t s_id;\n\tint rc;\n\tunsigned long flags;\n\n\tif (le32_to_cpu(abts->fcp_hdr_le.parameter) & ABTS_PARAM_ABORT_SEQ) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf053,\n\t\t    \"qla_target(%d): ABTS: Abort Sequence not \"\n\t\t    \"supported\\n\", vha->vp_idx);\n\t\tqlt_24xx_send_abts_resp(ha->base_qpair, abts, FCP_TMF_REJECTED,\n\t\t    false);\n\t\treturn;\n\t}\n\n\tif (tag == ATIO_EXCHANGE_ADDRESS_UNKNOWN) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf010,\n\t\t    \"qla_target(%d): ABTS: Unknown Exchange \"\n\t\t    \"Address received\\n\", vha->vp_idx);\n\t\tqlt_24xx_send_abts_resp(ha->base_qpair, abts, FCP_TMF_REJECTED,\n\t\t    false);\n\t\treturn;\n\t}\n\n\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf011,\n\t    \"qla_target(%d): task abort (s_id=%x:%x:%x, \"\n\t    \"tag=%d, param=%x)\\n\", vha->vp_idx, abts->fcp_hdr_le.s_id.domain,\n\t    abts->fcp_hdr_le.s_id.area, abts->fcp_hdr_le.s_id.al_pa, tag,\n\t    le32_to_cpu(abts->fcp_hdr_le.parameter));\n\n\ts_id = le_id_to_be(abts->fcp_hdr_le.s_id);\n\n\tspin_lock_irqsave(&ha->tgt.sess_lock, flags);\n\tsess = ha->tgt.tgt_ops->find_sess_by_s_id(vha, s_id);\n\tif (!sess) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf012,\n\t\t    \"qla_target(%d): task abort for non-existent session\\n\",\n\t\t    vha->vp_idx);\n\t\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\n\n\t\tqlt_24xx_send_abts_resp(ha->base_qpair, abts, FCP_TMF_REJECTED,\n\t\t\t    false);\n\t\treturn;\n\t}\n\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\n\n\n\tif (sess->deleted) {\n\t\tqlt_24xx_send_abts_resp(ha->base_qpair, abts, FCP_TMF_REJECTED,\n\t\t    false);\n\t\treturn;\n\t}\n\n\trc = __qlt_24xx_handle_abts(vha, abts, sess);\n\tif (rc != 0) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf054,\n\t\t    \"qla_target(%d): __qlt_24xx_handle_abts() failed: %d\\n\",\n\t\t    vha->vp_idx, rc);\n\t\tqlt_24xx_send_abts_resp(ha->base_qpair, abts, FCP_TMF_REJECTED,\n\t\t    false);\n\t\treturn;\n\t}\n}\n\n/*\n * ha->hardware_lock supposed to be held on entry. Might drop it, then reaquire\n */\nstatic void qlt_24xx_send_task_mgmt_ctio(struct qla_qpair *qpair,\n\tstruct qla_tgt_mgmt_cmd *mcmd, uint32_t resp_code)\n{\n\tstruct scsi_qla_host *ha = mcmd->vha;\n\tstruct atio_from_isp *atio = &mcmd->orig_iocb.atio;\n\tstruct ctio7_to_24xx *ctio;\n\tuint16_t temp;\n\n\tql_dbg(ql_dbg_tgt, ha, 0xe008,\n\t    \"Sending task mgmt CTIO7 (ha=%p, atio=%p, resp_code=%x\\n\",\n\t    ha, atio, resp_code);\n\n\n\tctio = (struct ctio7_to_24xx *)__qla2x00_alloc_iocbs(qpair, NULL);\n\tif (ctio == NULL) {\n\t\tql_dbg(ql_dbg_tgt, ha, 0xe04c,\n\t\t    \"qla_target(%d): %s failed: unable to allocate \"\n\t\t    \"request packet\\n\", ha->vp_idx, __func__);\n\t\treturn;\n\t}\n\n\tctio->entry_type = CTIO_TYPE7;\n\tctio->entry_count = 1;\n\tctio->handle = QLA_TGT_SKIP_HANDLE | CTIO_COMPLETION_HANDLE_MARK;\n\tctio->nport_handle = cpu_to_le16(mcmd->sess->loop_id);\n\tctio->timeout = cpu_to_le16(QLA_TGT_TIMEOUT);\n\tctio->vp_index = ha->vp_idx;\n\tctio->initiator_id = be_id_to_le(atio->u.isp24.fcp_hdr.s_id);\n\tctio->exchange_addr = atio->u.isp24.exchange_addr;\n\ttemp = (atio->u.isp24.attr << 9)|\n\t\tCTIO7_FLAGS_STATUS_MODE_1 | CTIO7_FLAGS_SEND_STATUS;\n\tctio->u.status1.flags = cpu_to_le16(temp);\n\ttemp = be16_to_cpu(atio->u.isp24.fcp_hdr.ox_id);\n\tctio->u.status1.ox_id = cpu_to_le16(temp);\n\tctio->u.status1.scsi_status =\n\t    cpu_to_le16(SS_RESPONSE_INFO_LEN_VALID);\n\tctio->u.status1.response_len = cpu_to_le16(8);\n\tctio->u.status1.sense_data[0] = resp_code;\n\n\t/* Memory Barrier */\n\twmb();\n\tif (qpair->reqq_start_iocbs)\n\t\tqpair->reqq_start_iocbs(qpair);\n\telse\n\t\tqla2x00_start_iocbs(ha, qpair->req);\n}\n\nvoid qlt_free_mcmd(struct qla_tgt_mgmt_cmd *mcmd)\n{\n\tmempool_free(mcmd, qla_tgt_mgmt_cmd_mempool);\n}\nEXPORT_SYMBOL(qlt_free_mcmd);\n\n/*\n * ha->hardware_lock supposed to be held on entry. Might drop it, then\n * reacquire\n */\nvoid qlt_send_resp_ctio(struct qla_qpair *qpair, struct qla_tgt_cmd *cmd,\n    uint8_t scsi_status, uint8_t sense_key, uint8_t asc, uint8_t ascq)\n{\n\tstruct atio_from_isp *atio = &cmd->atio;\n\tstruct ctio7_to_24xx *ctio;\n\tuint16_t temp;\n\tstruct scsi_qla_host *vha = cmd->vha;\n\n\tql_dbg(ql_dbg_tgt_dif, vha, 0x3066,\n\t    \"Sending response CTIO7 (vha=%p, atio=%p, scsi_status=%02x, \"\n\t    \"sense_key=%02x, asc=%02x, ascq=%02x\",\n\t    vha, atio, scsi_status, sense_key, asc, ascq);\n\n\tctio = (struct ctio7_to_24xx *)qla2x00_alloc_iocbs(vha, NULL);\n\tif (!ctio) {\n\t\tql_dbg(ql_dbg_async, vha, 0x3067,\n\t\t    \"qla2x00t(%ld): %s failed: unable to allocate request packet\",\n\t\t    vha->host_no, __func__);\n\t\tgoto out;\n\t}\n\n\tctio->entry_type = CTIO_TYPE7;\n\tctio->entry_count = 1;\n\tctio->handle = QLA_TGT_SKIP_HANDLE;\n\tctio->nport_handle = cpu_to_le16(cmd->sess->loop_id);\n\tctio->timeout = cpu_to_le16(QLA_TGT_TIMEOUT);\n\tctio->vp_index = vha->vp_idx;\n\tctio->initiator_id = be_id_to_le(atio->u.isp24.fcp_hdr.s_id);\n\tctio->exchange_addr = atio->u.isp24.exchange_addr;\n\ttemp = (atio->u.isp24.attr << 9) |\n\t    CTIO7_FLAGS_STATUS_MODE_1 | CTIO7_FLAGS_SEND_STATUS;\n\tctio->u.status1.flags = cpu_to_le16(temp);\n\ttemp = be16_to_cpu(atio->u.isp24.fcp_hdr.ox_id);\n\tctio->u.status1.ox_id = cpu_to_le16(temp);\n\tctio->u.status1.scsi_status =\n\t    cpu_to_le16(SS_RESPONSE_INFO_LEN_VALID | scsi_status);\n\tctio->u.status1.response_len = cpu_to_le16(18);\n\tctio->u.status1.residual = cpu_to_le32(get_datalen_for_atio(atio));\n\n\tif (ctio->u.status1.residual != 0)\n\t\tctio->u.status1.scsi_status |=\n\t\t    cpu_to_le16(SS_RESIDUAL_UNDER);\n\n\t/* Fixed format sense data. */\n\tctio->u.status1.sense_data[0] = 0x70;\n\tctio->u.status1.sense_data[2] = sense_key;\n\t/* Additional sense length */\n\tctio->u.status1.sense_data[7] = 0xa;\n\t/* ASC and ASCQ */\n\tctio->u.status1.sense_data[12] = asc;\n\tctio->u.status1.sense_data[13] = ascq;\n\n\t/* Memory Barrier */\n\twmb();\n\n\tif (qpair->reqq_start_iocbs)\n\t\tqpair->reqq_start_iocbs(qpair);\n\telse\n\t\tqla2x00_start_iocbs(vha, qpair->req);\n\nout:\n\treturn;\n}\n\n/* callback from target fabric module code */\nvoid qlt_xmit_tm_rsp(struct qla_tgt_mgmt_cmd *mcmd)\n{\n\tstruct scsi_qla_host *vha = mcmd->sess->vha;\n\tstruct qla_hw_data *ha = vha->hw;\n\tunsigned long flags;\n\tstruct qla_qpair *qpair = mcmd->qpair;\n\tbool free_mcmd = true;\n\n\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf013,\n\t    \"TM response mcmd (%p) status %#x state %#x\",\n\t    mcmd, mcmd->fc_tm_rsp, mcmd->flags);\n\n\tspin_lock_irqsave(qpair->qp_lock_ptr, flags);\n\n\tif (!vha->flags.online || mcmd->reset_count != qpair->chip_reset) {\n\t\t/*\n\t\t * Either the port is not online or this request was from\n\t\t * previous life, just abort the processing.\n\t\t */\n\t\tql_dbg(ql_dbg_async, vha, 0xe100,\n\t\t\t\"RESET-TMR online/active/old-count/new-count = %d/%d/%d/%d.\\n\",\n\t\t\tvha->flags.online, qla2x00_reset_active(vha),\n\t\t\tmcmd->reset_count, qpair->chip_reset);\n\t\tha->tgt.tgt_ops->free_mcmd(mcmd);\n\t\tspin_unlock_irqrestore(qpair->qp_lock_ptr, flags);\n\t\treturn;\n\t}\n\n\tif (mcmd->flags == QLA24XX_MGMT_SEND_NACK) {\n\t\tswitch (mcmd->orig_iocb.imm_ntfy.u.isp24.status_subcode) {\n\t\tcase ELS_LOGO:\n\t\tcase ELS_PRLO:\n\t\tcase ELS_TPRLO:\n\t\t\tql_dbg(ql_dbg_disc, vha, 0x2106,\n\t\t\t    \"TM response logo %8phC status %#x state %#x\",\n\t\t\t    mcmd->sess->port_name, mcmd->fc_tm_rsp,\n\t\t\t    mcmd->flags);\n\t\t\tqlt_schedule_sess_for_deletion(mcmd->sess);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tqlt_send_notify_ack(vha->hw->base_qpair,\n\t\t\t    &mcmd->orig_iocb.imm_ntfy, 0, 0, 0, 0, 0, 0);\n\t\t\tbreak;\n\t\t}\n\t} else {\n\t\tif (mcmd->orig_iocb.atio.u.raw.entry_type == ABTS_RECV_24XX) {\n\t\t\tqlt_build_abts_resp_iocb(mcmd);\n\t\t\tfree_mcmd = false;\n\t\t} else\n\t\t\tqlt_24xx_send_task_mgmt_ctio(qpair, mcmd,\n\t\t\t    mcmd->fc_tm_rsp);\n\t}\n\t/*\n\t * Make the callback for ->free_mcmd() to queue_work() and invoke\n\t * target_put_sess_cmd() to drop cmd_kref to 1.  The final\n\t * target_put_sess_cmd() call will be made from TFO->check_stop_free()\n\t * -> tcm_qla2xxx_check_stop_free() to release the TMR associated se_cmd\n\t * descriptor after TFO->queue_tm_rsp() -> tcm_qla2xxx_queue_tm_rsp() ->\n\t * qlt_xmit_tm_rsp() returns here..\n\t */\n\tif (free_mcmd)\n\t\tha->tgt.tgt_ops->free_mcmd(mcmd);\n\n\tspin_unlock_irqrestore(qpair->qp_lock_ptr, flags);\n}\nEXPORT_SYMBOL(qlt_xmit_tm_rsp);\n\n/* No locks */\nstatic int qlt_pci_map_calc_cnt(struct qla_tgt_prm *prm)\n{\n\tstruct qla_tgt_cmd *cmd = prm->cmd;\n\n\tBUG_ON(cmd->sg_cnt == 0);\n\n\tprm->sg = (struct scatterlist *)cmd->sg;\n\tprm->seg_cnt = dma_map_sg(&cmd->qpair->pdev->dev, cmd->sg,\n\t    cmd->sg_cnt, cmd->dma_data_direction);\n\tif (unlikely(prm->seg_cnt == 0))\n\t\tgoto out_err;\n\n\tprm->cmd->sg_mapped = 1;\n\n\tif (cmd->se_cmd.prot_op == TARGET_PROT_NORMAL) {\n\t\t/*\n\t\t * If greater than four sg entries then we need to allocate\n\t\t * the continuation entries\n\t\t */\n\t\tif (prm->seg_cnt > QLA_TGT_DATASEGS_PER_CMD_24XX)\n\t\t\tprm->req_cnt += DIV_ROUND_UP(prm->seg_cnt -\n\t\t\tQLA_TGT_DATASEGS_PER_CMD_24XX,\n\t\t\tQLA_TGT_DATASEGS_PER_CONT_24XX);\n\t} else {\n\t\t/* DIF */\n\t\tif ((cmd->se_cmd.prot_op == TARGET_PROT_DIN_INSERT) ||\n\t\t    (cmd->se_cmd.prot_op == TARGET_PROT_DOUT_STRIP)) {\n\t\t\tprm->seg_cnt = DIV_ROUND_UP(cmd->bufflen, cmd->blk_sz);\n\t\t\tprm->tot_dsds = prm->seg_cnt;\n\t\t} else\n\t\t\tprm->tot_dsds = prm->seg_cnt;\n\n\t\tif (cmd->prot_sg_cnt) {\n\t\t\tprm->prot_sg      = cmd->prot_sg;\n\t\t\tprm->prot_seg_cnt = dma_map_sg(&cmd->qpair->pdev->dev,\n\t\t\t\tcmd->prot_sg, cmd->prot_sg_cnt,\n\t\t\t\tcmd->dma_data_direction);\n\t\t\tif (unlikely(prm->prot_seg_cnt == 0))\n\t\t\t\tgoto out_err;\n\n\t\t\tif ((cmd->se_cmd.prot_op == TARGET_PROT_DIN_INSERT) ||\n\t\t\t    (cmd->se_cmd.prot_op == TARGET_PROT_DOUT_STRIP)) {\n\t\t\t\t/* Dif Bundling not support here */\n\t\t\t\tprm->prot_seg_cnt = DIV_ROUND_UP(cmd->bufflen,\n\t\t\t\t\t\t\t\tcmd->blk_sz);\n\t\t\t\tprm->tot_dsds += prm->prot_seg_cnt;\n\t\t\t} else\n\t\t\t\tprm->tot_dsds += prm->prot_seg_cnt;\n\t\t}\n\t}\n\n\treturn 0;\n\nout_err:\n\tql_dbg_qp(ql_dbg_tgt, prm->cmd->qpair, 0xe04d,\n\t    \"qla_target(%d): PCI mapping failed: sg_cnt=%d\",\n\t    0, prm->cmd->sg_cnt);\n\treturn -1;\n}\n\nstatic void qlt_unmap_sg(struct scsi_qla_host *vha, struct qla_tgt_cmd *cmd)\n{\n\tstruct qla_hw_data *ha;\n\tstruct qla_qpair *qpair;\n\n\tif (!cmd->sg_mapped)\n\t\treturn;\n\n\tqpair = cmd->qpair;\n\n\tdma_unmap_sg(&qpair->pdev->dev, cmd->sg, cmd->sg_cnt,\n\t    cmd->dma_data_direction);\n\tcmd->sg_mapped = 0;\n\n\tif (cmd->prot_sg_cnt)\n\t\tdma_unmap_sg(&qpair->pdev->dev, cmd->prot_sg, cmd->prot_sg_cnt,\n\t\t\tcmd->dma_data_direction);\n\n\tif (!cmd->ctx)\n\t\treturn;\n\tha = vha->hw;\n\tif (cmd->ctx_dsd_alloced)\n\t\tqla2x00_clean_dsd_pool(ha, cmd->ctx);\n\n\tdma_pool_free(ha->dl_dma_pool, cmd->ctx, cmd->ctx->crc_ctx_dma);\n}\n\nstatic int qlt_check_reserve_free_req(struct qla_qpair *qpair,\n\tuint32_t req_cnt)\n{\n\tuint32_t cnt;\n\tstruct req_que *req = qpair->req;\n\n\tif (req->cnt < (req_cnt + 2)) {\n\t\tcnt = (uint16_t)(qpair->use_shadow_reg ? *req->out_ptr :\n\t\t    rd_reg_dword_relaxed(req->req_q_out));\n\n\t\tif  (req->ring_index < cnt)\n\t\t\treq->cnt = cnt - req->ring_index;\n\t\telse\n\t\t\treq->cnt = req->length - (req->ring_index - cnt);\n\n\t\tif (unlikely(req->cnt < (req_cnt + 2)))\n\t\t\treturn -EAGAIN;\n\t}\n\n\treq->cnt -= req_cnt;\n\n\treturn 0;\n}\n\n/*\n * ha->hardware_lock supposed to be held on entry. Might drop it, then reaquire\n */\nstatic inline void *qlt_get_req_pkt(struct req_que *req)\n{\n\t/* Adjust ring index. */\n\treq->ring_index++;\n\tif (req->ring_index == req->length) {\n\t\treq->ring_index = 0;\n\t\treq->ring_ptr = req->ring;\n\t} else {\n\t\treq->ring_ptr++;\n\t}\n\treturn (cont_entry_t *)req->ring_ptr;\n}\n\n/* ha->hardware_lock supposed to be held on entry */\nstatic inline uint32_t qlt_make_handle(struct qla_qpair *qpair)\n{\n\tuint32_t h;\n\tint index;\n\tuint8_t found = 0;\n\tstruct req_que *req = qpair->req;\n\n\th = req->current_outstanding_cmd;\n\n\tfor (index = 1; index < req->num_outstanding_cmds; index++) {\n\t\th++;\n\t\tif (h == req->num_outstanding_cmds)\n\t\t\th = 1;\n\n\t\tif (h == QLA_TGT_SKIP_HANDLE)\n\t\t\tcontinue;\n\n\t\tif (!req->outstanding_cmds[h]) {\n\t\t\tfound = 1;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (found) {\n\t\treq->current_outstanding_cmd = h;\n\t} else {\n\t\tql_dbg(ql_dbg_io, qpair->vha, 0x305b,\n\t\t    \"qla_target(%d): Ran out of empty cmd slots\\n\",\n\t\t    qpair->vha->vp_idx);\n\t\th = QLA_TGT_NULL_HANDLE;\n\t}\n\n\treturn h;\n}\n\n/* ha->hardware_lock supposed to be held on entry */\nstatic int qlt_24xx_build_ctio_pkt(struct qla_qpair *qpair,\n\tstruct qla_tgt_prm *prm)\n{\n\tuint32_t h;\n\tstruct ctio7_to_24xx *pkt;\n\tstruct atio_from_isp *atio = &prm->cmd->atio;\n\tuint16_t temp;\n\n\tpkt = (struct ctio7_to_24xx *)qpair->req->ring_ptr;\n\tprm->pkt = pkt;\n\tmemset(pkt, 0, sizeof(*pkt));\n\n\tpkt->entry_type = CTIO_TYPE7;\n\tpkt->entry_count = (uint8_t)prm->req_cnt;\n\tpkt->vp_index = prm->cmd->vp_idx;\n\n\th = qlt_make_handle(qpair);\n\tif (unlikely(h == QLA_TGT_NULL_HANDLE)) {\n\t\t/*\n\t\t * CTIO type 7 from the firmware doesn't provide a way to\n\t\t * know the initiator's LOOP ID, hence we can't find\n\t\t * the session and, so, the command.\n\t\t */\n\t\treturn -EAGAIN;\n\t} else\n\t\tqpair->req->outstanding_cmds[h] = (srb_t *)prm->cmd;\n\n\tpkt->handle = make_handle(qpair->req->id, h);\n\tpkt->handle |= CTIO_COMPLETION_HANDLE_MARK;\n\tpkt->nport_handle = cpu_to_le16(prm->cmd->loop_id);\n\tpkt->timeout = cpu_to_le16(QLA_TGT_TIMEOUT);\n\tpkt->initiator_id = be_id_to_le(atio->u.isp24.fcp_hdr.s_id);\n\tpkt->exchange_addr = atio->u.isp24.exchange_addr;\n\ttemp = atio->u.isp24.attr << 9;\n\tpkt->u.status0.flags |= cpu_to_le16(temp);\n\ttemp = be16_to_cpu(atio->u.isp24.fcp_hdr.ox_id);\n\tpkt->u.status0.ox_id = cpu_to_le16(temp);\n\tpkt->u.status0.relative_offset = cpu_to_le32(prm->cmd->offset);\n\n\treturn 0;\n}\n\n/*\n * ha->hardware_lock supposed to be held on entry. We have already made sure\n * that there is sufficient amount of request entries to not drop it.\n */\nstatic void qlt_load_cont_data_segments(struct qla_tgt_prm *prm)\n{\n\tint cnt;\n\tstruct dsd64 *cur_dsd;\n\n\t/* Build continuation packets */\n\twhile (prm->seg_cnt > 0) {\n\t\tcont_a64_entry_t *cont_pkt64 =\n\t\t\t(cont_a64_entry_t *)qlt_get_req_pkt(\n\t\t\t   prm->cmd->qpair->req);\n\n\t\t/*\n\t\t * Make sure that from cont_pkt64 none of\n\t\t * 64-bit specific fields used for 32-bit\n\t\t * addressing. Cast to (cont_entry_t *) for\n\t\t * that.\n\t\t */\n\n\t\tmemset(cont_pkt64, 0, sizeof(*cont_pkt64));\n\n\t\tcont_pkt64->entry_count = 1;\n\t\tcont_pkt64->sys_define = 0;\n\n\t\tcont_pkt64->entry_type = CONTINUE_A64_TYPE;\n\t\tcur_dsd = cont_pkt64->dsd;\n\n\t\t/* Load continuation entry data segments */\n\t\tfor (cnt = 0;\n\t\t    cnt < QLA_TGT_DATASEGS_PER_CONT_24XX && prm->seg_cnt;\n\t\t    cnt++, prm->seg_cnt--) {\n\t\t\tappend_dsd64(&cur_dsd, prm->sg);\n\t\t\tprm->sg = sg_next(prm->sg);\n\t\t}\n\t}\n}\n\n/*\n * ha->hardware_lock supposed to be held on entry. We have already made sure\n * that there is sufficient amount of request entries to not drop it.\n */\nstatic void qlt_load_data_segments(struct qla_tgt_prm *prm)\n{\n\tint cnt;\n\tstruct dsd64 *cur_dsd;\n\tstruct ctio7_to_24xx *pkt24 = (struct ctio7_to_24xx *)prm->pkt;\n\n\tpkt24->u.status0.transfer_length = cpu_to_le32(prm->cmd->bufflen);\n\n\t/* Setup packet address segment pointer */\n\tcur_dsd = &pkt24->u.status0.dsd;\n\n\t/* Set total data segment count */\n\tif (prm->seg_cnt)\n\t\tpkt24->dseg_count = cpu_to_le16(prm->seg_cnt);\n\n\tif (prm->seg_cnt == 0) {\n\t\t/* No data transfer */\n\t\tcur_dsd->address = 0;\n\t\tcur_dsd->length = 0;\n\t\treturn;\n\t}\n\n\t/* If scatter gather */\n\n\t/* Load command entry data segments */\n\tfor (cnt = 0;\n\t    (cnt < QLA_TGT_DATASEGS_PER_CMD_24XX) && prm->seg_cnt;\n\t    cnt++, prm->seg_cnt--) {\n\t\tappend_dsd64(&cur_dsd, prm->sg);\n\t\tprm->sg = sg_next(prm->sg);\n\t}\n\n\tqlt_load_cont_data_segments(prm);\n}\n\nstatic inline int qlt_has_data(struct qla_tgt_cmd *cmd)\n{\n\treturn cmd->bufflen > 0;\n}\n\nstatic void qlt_print_dif_err(struct qla_tgt_prm *prm)\n{\n\tstruct qla_tgt_cmd *cmd;\n\tstruct scsi_qla_host *vha;\n\n\t/* asc 0x10=dif error */\n\tif (prm->sense_buffer && (prm->sense_buffer[12] == 0x10)) {\n\t\tcmd = prm->cmd;\n\t\tvha = cmd->vha;\n\t\t/* ASCQ */\n\t\tswitch (prm->sense_buffer[13]) {\n\t\tcase 1:\n\t\t\tql_dbg(ql_dbg_tgt_dif, vha, 0xe00b,\n\t\t\t    \"BE detected Guard TAG ERR: lba[0x%llx|%lld] len[0x%x] \"\n\t\t\t    \"se_cmd=%p tag[%x]\",\n\t\t\t    cmd->lba, cmd->lba, cmd->num_blks, &cmd->se_cmd,\n\t\t\t    cmd->atio.u.isp24.exchange_addr);\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\tql_dbg(ql_dbg_tgt_dif, vha, 0xe00c,\n\t\t\t    \"BE detected APP TAG ERR: lba[0x%llx|%lld] len[0x%x] \"\n\t\t\t    \"se_cmd=%p tag[%x]\",\n\t\t\t    cmd->lba, cmd->lba, cmd->num_blks, &cmd->se_cmd,\n\t\t\t    cmd->atio.u.isp24.exchange_addr);\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\tql_dbg(ql_dbg_tgt_dif, vha, 0xe00f,\n\t\t\t    \"BE detected REF TAG ERR: lba[0x%llx|%lld] len[0x%x] \"\n\t\t\t    \"se_cmd=%p tag[%x]\",\n\t\t\t    cmd->lba, cmd->lba, cmd->num_blks, &cmd->se_cmd,\n\t\t\t    cmd->atio.u.isp24.exchange_addr);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tql_dbg(ql_dbg_tgt_dif, vha, 0xe010,\n\t\t\t    \"BE detected Dif ERR: lba[%llx|%lld] len[%x] \"\n\t\t\t    \"se_cmd=%p tag[%x]\",\n\t\t\t    cmd->lba, cmd->lba, cmd->num_blks, &cmd->se_cmd,\n\t\t\t    cmd->atio.u.isp24.exchange_addr);\n\t\t\tbreak;\n\t\t}\n\t\tql_dump_buffer(ql_dbg_tgt_dif, vha, 0xe011, cmd->cdb, 16);\n\t}\n}\n\n/*\n * Called without ha->hardware_lock held\n */\nstatic int qlt_pre_xmit_response(struct qla_tgt_cmd *cmd,\n\tstruct qla_tgt_prm *prm, int xmit_type, uint8_t scsi_status,\n\tuint32_t *full_req_cnt)\n{\n\tstruct se_cmd *se_cmd = &cmd->se_cmd;\n\tstruct qla_qpair *qpair = cmd->qpair;\n\n\tprm->cmd = cmd;\n\tprm->tgt = cmd->tgt;\n\tprm->pkt = NULL;\n\tprm->rq_result = scsi_status;\n\tprm->sense_buffer = &cmd->sense_buffer[0];\n\tprm->sense_buffer_len = TRANSPORT_SENSE_BUFFER;\n\tprm->sg = NULL;\n\tprm->seg_cnt = -1;\n\tprm->req_cnt = 1;\n\tprm->residual = 0;\n\tprm->add_status_pkt = 0;\n\tprm->prot_sg = NULL;\n\tprm->prot_seg_cnt = 0;\n\tprm->tot_dsds = 0;\n\n\tif ((xmit_type & QLA_TGT_XMIT_DATA) && qlt_has_data(cmd)) {\n\t\tif  (qlt_pci_map_calc_cnt(prm) != 0)\n\t\t\treturn -EAGAIN;\n\t}\n\n\t*full_req_cnt = prm->req_cnt;\n\n\tif (se_cmd->se_cmd_flags & SCF_UNDERFLOW_BIT) {\n\t\tprm->residual = se_cmd->residual_count;\n\t\tql_dbg_qp(ql_dbg_io + ql_dbg_verbose, qpair, 0x305c,\n\t\t    \"Residual underflow: %d (tag %lld, op %x, bufflen %d, rq_result %x)\\n\",\n\t\t       prm->residual, se_cmd->tag,\n\t\t       se_cmd->t_task_cdb ? se_cmd->t_task_cdb[0] : 0,\n\t\t       cmd->bufflen, prm->rq_result);\n\t\tprm->rq_result |= SS_RESIDUAL_UNDER;\n\t} else if (se_cmd->se_cmd_flags & SCF_OVERFLOW_BIT) {\n\t\tprm->residual = se_cmd->residual_count;\n\t\tql_dbg_qp(ql_dbg_io, qpair, 0x305d,\n\t\t    \"Residual overflow: %d (tag %lld, op %x, bufflen %d, rq_result %x)\\n\",\n\t\t       prm->residual, se_cmd->tag, se_cmd->t_task_cdb ?\n\t\t       se_cmd->t_task_cdb[0] : 0, cmd->bufflen, prm->rq_result);\n\t\tprm->rq_result |= SS_RESIDUAL_OVER;\n\t}\n\n\tif (xmit_type & QLA_TGT_XMIT_STATUS) {\n\t\t/*\n\t\t * If QLA_TGT_XMIT_DATA is not set, add_status_pkt will be\n\t\t * ignored in *xmit_response() below\n\t\t */\n\t\tif (qlt_has_data(cmd)) {\n\t\t\tif (QLA_TGT_SENSE_VALID(prm->sense_buffer) ||\n\t\t\t    (IS_FWI2_CAPABLE(cmd->vha->hw) &&\n\t\t\t    (prm->rq_result != 0))) {\n\t\t\t\tprm->add_status_pkt = 1;\n\t\t\t\t(*full_req_cnt)++;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic inline int qlt_need_explicit_conf(struct qla_tgt_cmd *cmd,\n    int sending_sense)\n{\n\tif (cmd->qpair->enable_class_2)\n\t\treturn 0;\n\n\tif (sending_sense)\n\t\treturn cmd->conf_compl_supported;\n\telse\n\t\treturn cmd->qpair->enable_explicit_conf &&\n                    cmd->conf_compl_supported;\n}\n\nstatic void qlt_24xx_init_ctio_to_isp(struct ctio7_to_24xx *ctio,\n\tstruct qla_tgt_prm *prm)\n{\n\tprm->sense_buffer_len = min_t(uint32_t, prm->sense_buffer_len,\n\t    (uint32_t)sizeof(ctio->u.status1.sense_data));\n\tctio->u.status0.flags |= cpu_to_le16(CTIO7_FLAGS_SEND_STATUS);\n\tif (qlt_need_explicit_conf(prm->cmd, 0)) {\n\t\tctio->u.status0.flags |= cpu_to_le16(\n\t\t    CTIO7_FLAGS_EXPLICIT_CONFORM |\n\t\t    CTIO7_FLAGS_CONFORM_REQ);\n\t}\n\tctio->u.status0.residual = cpu_to_le32(prm->residual);\n\tctio->u.status0.scsi_status = cpu_to_le16(prm->rq_result);\n\tif (QLA_TGT_SENSE_VALID(prm->sense_buffer)) {\n\t\tint i;\n\n\t\tif (qlt_need_explicit_conf(prm->cmd, 1)) {\n\t\t\tif ((prm->rq_result & SS_SCSI_STATUS_BYTE) != 0) {\n\t\t\t\tql_dbg_qp(ql_dbg_tgt, prm->cmd->qpair, 0xe017,\n\t\t\t\t    \"Skipping EXPLICIT_CONFORM and \"\n\t\t\t\t    \"CTIO7_FLAGS_CONFORM_REQ for FCP READ w/ \"\n\t\t\t\t    \"non GOOD status\\n\");\n\t\t\t\tgoto skip_explict_conf;\n\t\t\t}\n\t\t\tctio->u.status1.flags |= cpu_to_le16(\n\t\t\t    CTIO7_FLAGS_EXPLICIT_CONFORM |\n\t\t\t    CTIO7_FLAGS_CONFORM_REQ);\n\t\t}\nskip_explict_conf:\n\t\tctio->u.status1.flags &=\n\t\t    ~cpu_to_le16(CTIO7_FLAGS_STATUS_MODE_0);\n\t\tctio->u.status1.flags |=\n\t\t    cpu_to_le16(CTIO7_FLAGS_STATUS_MODE_1);\n\t\tctio->u.status1.scsi_status |=\n\t\t    cpu_to_le16(SS_SENSE_LEN_VALID);\n\t\tctio->u.status1.sense_length =\n\t\t    cpu_to_le16(prm->sense_buffer_len);\n\t\tfor (i = 0; i < prm->sense_buffer_len/4; i++) {\n\t\t\tuint32_t v;\n\n\t\t\tv = get_unaligned_be32(\n\t\t\t\t\t&((uint32_t *)prm->sense_buffer)[i]);\n\t\t\tput_unaligned_le32(v,\n\t\t\t\t&((uint32_t *)ctio->u.status1.sense_data)[i]);\n\t\t}\n\t\tqlt_print_dif_err(prm);\n\n\t} else {\n\t\tctio->u.status1.flags &=\n\t\t    ~cpu_to_le16(CTIO7_FLAGS_STATUS_MODE_0);\n\t\tctio->u.status1.flags |=\n\t\t    cpu_to_le16(CTIO7_FLAGS_STATUS_MODE_1);\n\t\tctio->u.status1.sense_length = 0;\n\t\tmemset(ctio->u.status1.sense_data, 0,\n\t\t    sizeof(ctio->u.status1.sense_data));\n\t}\n\n\t/* Sense with len > 24, is it possible ??? */\n}\n\nstatic inline int\nqlt_hba_err_chk_enabled(struct se_cmd *se_cmd)\n{\n\tswitch (se_cmd->prot_op) {\n\tcase TARGET_PROT_DOUT_INSERT:\n\tcase TARGET_PROT_DIN_STRIP:\n\t\tif (ql2xenablehba_err_chk >= 1)\n\t\t\treturn 1;\n\t\tbreak;\n\tcase TARGET_PROT_DOUT_PASS:\n\tcase TARGET_PROT_DIN_PASS:\n\t\tif (ql2xenablehba_err_chk >= 2)\n\t\t\treturn 1;\n\t\tbreak;\n\tcase TARGET_PROT_DIN_INSERT:\n\tcase TARGET_PROT_DOUT_STRIP:\n\t\treturn 1;\n\tdefault:\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic inline int\nqla_tgt_ref_mask_check(struct se_cmd *se_cmd)\n{\n\tswitch (se_cmd->prot_op) {\n\tcase TARGET_PROT_DIN_INSERT:\n\tcase TARGET_PROT_DOUT_INSERT:\n\tcase TARGET_PROT_DIN_STRIP:\n\tcase TARGET_PROT_DOUT_STRIP:\n\tcase TARGET_PROT_DIN_PASS:\n\tcase TARGET_PROT_DOUT_PASS:\n\t    return 1;\n\tdefault:\n\t    return 0;\n\t}\n\treturn 0;\n}\n\n/*\n * qla_tgt_set_dif_tags - Extract Ref and App tags from SCSI command\n */\nstatic void\nqla_tgt_set_dif_tags(struct qla_tgt_cmd *cmd, struct crc_context *ctx,\n    uint16_t *pfw_prot_opts)\n{\n\tstruct se_cmd *se_cmd = &cmd->se_cmd;\n\tuint32_t lba = 0xffffffff & se_cmd->t_task_lba;\n\tscsi_qla_host_t *vha = cmd->tgt->vha;\n\tstruct qla_hw_data *ha = vha->hw;\n\tuint32_t t32 = 0;\n\n\t/*\n\t * wait till Mode Sense/Select cmd, modepage Ah, subpage 2\n\t * have been immplemented by TCM, before AppTag is avail.\n\t * Look for modesense_handlers[]\n\t */\n\tctx->app_tag = 0;\n\tctx->app_tag_mask[0] = 0x0;\n\tctx->app_tag_mask[1] = 0x0;\n\n\tif (IS_PI_UNINIT_CAPABLE(ha)) {\n\t\tif ((se_cmd->prot_type == TARGET_DIF_TYPE1_PROT) ||\n\t\t    (se_cmd->prot_type == TARGET_DIF_TYPE2_PROT))\n\t\t\t*pfw_prot_opts |= PO_DIS_VALD_APP_ESC;\n\t\telse if (se_cmd->prot_type == TARGET_DIF_TYPE3_PROT)\n\t\t\t*pfw_prot_opts |= PO_DIS_VALD_APP_REF_ESC;\n\t}\n\n\tt32 = ha->tgt.tgt_ops->get_dif_tags(cmd, pfw_prot_opts);\n\n\tswitch (se_cmd->prot_type) {\n\tcase TARGET_DIF_TYPE0_PROT:\n\t\t/*\n\t\t * No check for ql2xenablehba_err_chk, as it\n\t\t * would be an I/O error if hba tag generation\n\t\t * is not done.\n\t\t */\n\t\tctx->ref_tag = cpu_to_le32(lba);\n\t\t/* enable ALL bytes of the ref tag */\n\t\tctx->ref_tag_mask[0] = 0xff;\n\t\tctx->ref_tag_mask[1] = 0xff;\n\t\tctx->ref_tag_mask[2] = 0xff;\n\t\tctx->ref_tag_mask[3] = 0xff;\n\t\tbreak;\n\tcase TARGET_DIF_TYPE1_PROT:\n\t    /*\n\t     * For TYPE 1 protection: 16 bit GUARD tag, 32 bit\n\t     * REF tag, and 16 bit app tag.\n\t     */\n\t    ctx->ref_tag = cpu_to_le32(lba);\n\t    if (!qla_tgt_ref_mask_check(se_cmd) ||\n\t\t!(ha->tgt.tgt_ops->chk_dif_tags(t32))) {\n\t\t    *pfw_prot_opts |= PO_DIS_REF_TAG_VALD;\n\t\t    break;\n\t    }\n\t    /* enable ALL bytes of the ref tag */\n\t    ctx->ref_tag_mask[0] = 0xff;\n\t    ctx->ref_tag_mask[1] = 0xff;\n\t    ctx->ref_tag_mask[2] = 0xff;\n\t    ctx->ref_tag_mask[3] = 0xff;\n\t    break;\n\tcase TARGET_DIF_TYPE2_PROT:\n\t    /*\n\t     * For TYPE 2 protection: 16 bit GUARD + 32 bit REF\n\t     * tag has to match LBA in CDB + N\n\t     */\n\t    ctx->ref_tag = cpu_to_le32(lba);\n\t    if (!qla_tgt_ref_mask_check(se_cmd) ||\n\t\t!(ha->tgt.tgt_ops->chk_dif_tags(t32))) {\n\t\t    *pfw_prot_opts |= PO_DIS_REF_TAG_VALD;\n\t\t    break;\n\t    }\n\t    /* enable ALL bytes of the ref tag */\n\t    ctx->ref_tag_mask[0] = 0xff;\n\t    ctx->ref_tag_mask[1] = 0xff;\n\t    ctx->ref_tag_mask[2] = 0xff;\n\t    ctx->ref_tag_mask[3] = 0xff;\n\t    break;\n\tcase TARGET_DIF_TYPE3_PROT:\n\t    /* For TYPE 3 protection: 16 bit GUARD only */\n\t    *pfw_prot_opts |= PO_DIS_REF_TAG_VALD;\n\t    ctx->ref_tag_mask[0] = ctx->ref_tag_mask[1] =\n\t\tctx->ref_tag_mask[2] = ctx->ref_tag_mask[3] = 0x00;\n\t    break;\n\t}\n}\n\nstatic inline int\nqlt_build_ctio_crc2_pkt(struct qla_qpair *qpair, struct qla_tgt_prm *prm)\n{\n\tstruct dsd64\t\t*cur_dsd;\n\tuint32_t\t\ttransfer_length = 0;\n\tuint32_t\t\tdata_bytes;\n\tuint32_t\t\tdif_bytes;\n\tuint8_t\t\t\tbundling = 1;\n\tstruct crc_context\t*crc_ctx_pkt = NULL;\n\tstruct qla_hw_data\t*ha;\n\tstruct ctio_crc2_to_fw\t*pkt;\n\tdma_addr_t\t\tcrc_ctx_dma;\n\tuint16_t\t\tfw_prot_opts = 0;\n\tstruct qla_tgt_cmd\t*cmd = prm->cmd;\n\tstruct se_cmd\t\t*se_cmd = &cmd->se_cmd;\n\tuint32_t h;\n\tstruct atio_from_isp *atio = &prm->cmd->atio;\n\tstruct qla_tc_param\ttc;\n\tuint16_t t16;\n\tscsi_qla_host_t *vha = cmd->vha;\n\n\tha = vha->hw;\n\n\tpkt = (struct ctio_crc2_to_fw *)qpair->req->ring_ptr;\n\tprm->pkt = pkt;\n\tmemset(pkt, 0, sizeof(*pkt));\n\n\tql_dbg_qp(ql_dbg_tgt, cmd->qpair, 0xe071,\n\t\t\"qla_target(%d):%s: se_cmd[%p] CRC2 prot_op[0x%x] cmd prot sg:cnt[%p:%x] lba[%llu]\\n\",\n\t\tcmd->vp_idx, __func__, se_cmd, se_cmd->prot_op,\n\t\tprm->prot_sg, prm->prot_seg_cnt, se_cmd->t_task_lba);\n\n\tif ((se_cmd->prot_op == TARGET_PROT_DIN_INSERT) ||\n\t    (se_cmd->prot_op == TARGET_PROT_DOUT_STRIP))\n\t\tbundling = 0;\n\n\t/* Compute dif len and adjust data len to incude protection */\n\tdata_bytes = cmd->bufflen;\n\tdif_bytes  = (data_bytes / cmd->blk_sz) * 8;\n\n\tswitch (se_cmd->prot_op) {\n\tcase TARGET_PROT_DIN_INSERT:\n\tcase TARGET_PROT_DOUT_STRIP:\n\t\ttransfer_length = data_bytes;\n\t\tif (cmd->prot_sg_cnt)\n\t\t\tdata_bytes += dif_bytes;\n\t\tbreak;\n\tcase TARGET_PROT_DIN_STRIP:\n\tcase TARGET_PROT_DOUT_INSERT:\n\tcase TARGET_PROT_DIN_PASS:\n\tcase TARGET_PROT_DOUT_PASS:\n\t\ttransfer_length = data_bytes + dif_bytes;\n\t\tbreak;\n\tdefault:\n\t\tBUG();\n\t\tbreak;\n\t}\n\n\tif (!qlt_hba_err_chk_enabled(se_cmd))\n\t\tfw_prot_opts |= 0x10; /* Disable Guard tag checking */\n\t/* HBA error checking enabled */\n\telse if (IS_PI_UNINIT_CAPABLE(ha)) {\n\t\tif ((se_cmd->prot_type == TARGET_DIF_TYPE1_PROT) ||\n\t\t    (se_cmd->prot_type == TARGET_DIF_TYPE2_PROT))\n\t\t\tfw_prot_opts |= PO_DIS_VALD_APP_ESC;\n\t\telse if (se_cmd->prot_type == TARGET_DIF_TYPE3_PROT)\n\t\t\tfw_prot_opts |= PO_DIS_VALD_APP_REF_ESC;\n\t}\n\n\tswitch (se_cmd->prot_op) {\n\tcase TARGET_PROT_DIN_INSERT:\n\tcase TARGET_PROT_DOUT_INSERT:\n\t\tfw_prot_opts |= PO_MODE_DIF_INSERT;\n\t\tbreak;\n\tcase TARGET_PROT_DIN_STRIP:\n\tcase TARGET_PROT_DOUT_STRIP:\n\t\tfw_prot_opts |= PO_MODE_DIF_REMOVE;\n\t\tbreak;\n\tcase TARGET_PROT_DIN_PASS:\n\tcase TARGET_PROT_DOUT_PASS:\n\t\tfw_prot_opts |= PO_MODE_DIF_PASS;\n\t\t/* FUTURE: does tcm require T10CRC<->IPCKSUM conversion? */\n\t\tbreak;\n\tdefault:/* Normal Request */\n\t\tfw_prot_opts |= PO_MODE_DIF_PASS;\n\t\tbreak;\n\t}\n\n\t/* ---- PKT ---- */\n\t/* Update entry type to indicate Command Type CRC_2 IOCB */\n\tpkt->entry_type  = CTIO_CRC2;\n\tpkt->entry_count = 1;\n\tpkt->vp_index = cmd->vp_idx;\n\n\th = qlt_make_handle(qpair);\n\tif (unlikely(h == QLA_TGT_NULL_HANDLE)) {\n\t\t/*\n\t\t * CTIO type 7 from the firmware doesn't provide a way to\n\t\t * know the initiator's LOOP ID, hence we can't find\n\t\t * the session and, so, the command.\n\t\t */\n\t\treturn -EAGAIN;\n\t} else\n\t\tqpair->req->outstanding_cmds[h] = (srb_t *)prm->cmd;\n\n\tpkt->handle  = make_handle(qpair->req->id, h);\n\tpkt->handle |= CTIO_COMPLETION_HANDLE_MARK;\n\tpkt->nport_handle = cpu_to_le16(prm->cmd->loop_id);\n\tpkt->timeout = cpu_to_le16(QLA_TGT_TIMEOUT);\n\tpkt->initiator_id = be_id_to_le(atio->u.isp24.fcp_hdr.s_id);\n\tpkt->exchange_addr   = atio->u.isp24.exchange_addr;\n\n\t/* silence compile warning */\n\tt16 = be16_to_cpu(atio->u.isp24.fcp_hdr.ox_id);\n\tpkt->ox_id  = cpu_to_le16(t16);\n\n\tt16 = (atio->u.isp24.attr << 9);\n\tpkt->flags |= cpu_to_le16(t16);\n\tpkt->relative_offset = cpu_to_le32(prm->cmd->offset);\n\n\t/* Set transfer direction */\n\tif (cmd->dma_data_direction == DMA_TO_DEVICE)\n\t\tpkt->flags = cpu_to_le16(CTIO7_FLAGS_DATA_IN);\n\telse if (cmd->dma_data_direction == DMA_FROM_DEVICE)\n\t\tpkt->flags = cpu_to_le16(CTIO7_FLAGS_DATA_OUT);\n\n\tpkt->dseg_count = cpu_to_le16(prm->tot_dsds);\n\t/* Fibre channel byte count */\n\tpkt->transfer_length = cpu_to_le32(transfer_length);\n\n\t/* ----- CRC context -------- */\n\n\t/* Allocate CRC context from global pool */\n\tcrc_ctx_pkt = cmd->ctx =\n\t    dma_pool_zalloc(ha->dl_dma_pool, GFP_ATOMIC, &crc_ctx_dma);\n\n\tif (!crc_ctx_pkt)\n\t\tgoto crc_queuing_error;\n\n\tcrc_ctx_pkt->crc_ctx_dma = crc_ctx_dma;\n\tINIT_LIST_HEAD(&crc_ctx_pkt->dsd_list);\n\n\t/* Set handle */\n\tcrc_ctx_pkt->handle = pkt->handle;\n\n\tqla_tgt_set_dif_tags(cmd, crc_ctx_pkt, &fw_prot_opts);\n\n\tput_unaligned_le64(crc_ctx_dma, &pkt->crc_context_address);\n\tpkt->crc_context_len = cpu_to_le16(CRC_CONTEXT_LEN_FW);\n\n\tif (!bundling) {\n\t\tcur_dsd = &crc_ctx_pkt->u.nobundling.data_dsd[0];\n\t} else {\n\t\t/*\n\t\t * Configure Bundling if we need to fetch interlaving\n\t\t * protection PCI accesses\n\t\t */\n\t\tfw_prot_opts |= PO_ENABLE_DIF_BUNDLING;\n\t\tcrc_ctx_pkt->u.bundling.dif_byte_count = cpu_to_le32(dif_bytes);\n\t\tcrc_ctx_pkt->u.bundling.dseg_count =\n\t\t\tcpu_to_le16(prm->tot_dsds - prm->prot_seg_cnt);\n\t\tcur_dsd = &crc_ctx_pkt->u.bundling.data_dsd[0];\n\t}\n\n\t/* Finish the common fields of CRC pkt */\n\tcrc_ctx_pkt->blk_size   = cpu_to_le16(cmd->blk_sz);\n\tcrc_ctx_pkt->prot_opts  = cpu_to_le16(fw_prot_opts);\n\tcrc_ctx_pkt->byte_count = cpu_to_le32(data_bytes);\n\tcrc_ctx_pkt->guard_seed = cpu_to_le16(0);\n\n\tmemset((uint8_t *)&tc, 0 , sizeof(tc));\n\ttc.vha = vha;\n\ttc.blk_sz = cmd->blk_sz;\n\ttc.bufflen = cmd->bufflen;\n\ttc.sg = cmd->sg;\n\ttc.prot_sg = cmd->prot_sg;\n\ttc.ctx = crc_ctx_pkt;\n\ttc.ctx_dsd_alloced = &cmd->ctx_dsd_alloced;\n\n\t/* Walks data segments */\n\tpkt->flags |= cpu_to_le16(CTIO7_FLAGS_DSD_PTR);\n\n\tif (!bundling && prm->prot_seg_cnt) {\n\t\tif (qla24xx_walk_and_build_sglist_no_difb(ha, NULL, cur_dsd,\n\t\t\tprm->tot_dsds, &tc))\n\t\t\tgoto crc_queuing_error;\n\t} else if (qla24xx_walk_and_build_sglist(ha, NULL, cur_dsd,\n\t\t(prm->tot_dsds - prm->prot_seg_cnt), &tc))\n\t\tgoto crc_queuing_error;\n\n\tif (bundling && prm->prot_seg_cnt) {\n\t\t/* Walks dif segments */\n\t\tpkt->add_flags |= CTIO_CRC2_AF_DIF_DSD_ENA;\n\n\t\tcur_dsd = &crc_ctx_pkt->u.bundling.dif_dsd;\n\t\tif (qla24xx_walk_and_build_prot_sglist(ha, NULL, cur_dsd,\n\t\t\tprm->prot_seg_cnt, cmd))\n\t\t\tgoto crc_queuing_error;\n\t}\n\treturn QLA_SUCCESS;\n\ncrc_queuing_error:\n\t/* Cleanup will be performed by the caller */\n\tqpair->req->outstanding_cmds[h] = NULL;\n\n\treturn QLA_FUNCTION_FAILED;\n}\n\n/*\n * Callback to setup response of xmit_type of QLA_TGT_XMIT_DATA and *\n * QLA_TGT_XMIT_STATUS for >= 24xx silicon\n */\nint qlt_xmit_response(struct qla_tgt_cmd *cmd, int xmit_type,\n\tuint8_t scsi_status)\n{\n\tstruct scsi_qla_host *vha = cmd->vha;\n\tstruct qla_qpair *qpair = cmd->qpair;\n\tstruct ctio7_to_24xx *pkt;\n\tstruct qla_tgt_prm prm;\n\tuint32_t full_req_cnt = 0;\n\tunsigned long flags = 0;\n\tint res;\n\n\tif (!qpair->fw_started || (cmd->reset_count != qpair->chip_reset) ||\n\t    (cmd->sess && cmd->sess->deleted)) {\n\t\tcmd->state = QLA_TGT_STATE_PROCESSED;\n\t\tres = 0;\n\t\tgoto free;\n\t}\n\n\tql_dbg_qp(ql_dbg_tgt, qpair, 0xe018,\n\t    \"is_send_status=%d, cmd->bufflen=%d, cmd->sg_cnt=%d, cmd->dma_data_direction=%d se_cmd[%p] qp %d\\n\",\n\t    (xmit_type & QLA_TGT_XMIT_STATUS) ?\n\t    1 : 0, cmd->bufflen, cmd->sg_cnt, cmd->dma_data_direction,\n\t    &cmd->se_cmd, qpair->id);\n\n\tres = qlt_pre_xmit_response(cmd, &prm, xmit_type, scsi_status,\n\t    &full_req_cnt);\n\tif (unlikely(res != 0))\n\t\tgoto free;\n\n\tspin_lock_irqsave(qpair->qp_lock_ptr, flags);\n\n\tif (xmit_type == QLA_TGT_XMIT_STATUS)\n\t\tqpair->tgt_counters.core_qla_snd_status++;\n\telse\n\t\tqpair->tgt_counters.core_qla_que_buf++;\n\n\tif (!qpair->fw_started || cmd->reset_count != qpair->chip_reset) {\n\t\t/*\n\t\t * Either the port is not online or this request was from\n\t\t * previous life, just abort the processing.\n\t\t */\n\t\tcmd->state = QLA_TGT_STATE_PROCESSED;\n\t\tql_dbg_qp(ql_dbg_async, qpair, 0xe101,\n\t\t\t\"RESET-RSP online/active/old-count/new-count = %d/%d/%d/%d.\\n\",\n\t\t\tvha->flags.online, qla2x00_reset_active(vha),\n\t\t\tcmd->reset_count, qpair->chip_reset);\n\t\tspin_unlock_irqrestore(qpair->qp_lock_ptr, flags);\n\t\tres = 0;\n\t\tgoto free;\n\t}\n\n\t/* Does F/W have an IOCBs for this request */\n\tres = qlt_check_reserve_free_req(qpair, full_req_cnt);\n\tif (unlikely(res))\n\t\tgoto out_unmap_unlock;\n\n\tif (cmd->se_cmd.prot_op && (xmit_type & QLA_TGT_XMIT_DATA))\n\t\tres = qlt_build_ctio_crc2_pkt(qpair, &prm);\n\telse\n\t\tres = qlt_24xx_build_ctio_pkt(qpair, &prm);\n\tif (unlikely(res != 0)) {\n\t\tqpair->req->cnt += full_req_cnt;\n\t\tgoto out_unmap_unlock;\n\t}\n\n\tpkt = (struct ctio7_to_24xx *)prm.pkt;\n\n\tif (qlt_has_data(cmd) && (xmit_type & QLA_TGT_XMIT_DATA)) {\n\t\tpkt->u.status0.flags |=\n\t\t    cpu_to_le16(CTIO7_FLAGS_DATA_IN |\n\t\t\tCTIO7_FLAGS_STATUS_MODE_0);\n\n\t\tif (cmd->se_cmd.prot_op == TARGET_PROT_NORMAL)\n\t\t\tqlt_load_data_segments(&prm);\n\n\t\tif (prm.add_status_pkt == 0) {\n\t\t\tif (xmit_type & QLA_TGT_XMIT_STATUS) {\n\t\t\t\tpkt->u.status0.scsi_status =\n\t\t\t\t    cpu_to_le16(prm.rq_result);\n\t\t\t\tpkt->u.status0.residual =\n\t\t\t\t    cpu_to_le32(prm.residual);\n\t\t\t\tpkt->u.status0.flags |= cpu_to_le16(\n\t\t\t\t    CTIO7_FLAGS_SEND_STATUS);\n\t\t\t\tif (qlt_need_explicit_conf(cmd, 0)) {\n\t\t\t\t\tpkt->u.status0.flags |=\n\t\t\t\t\t    cpu_to_le16(\n\t\t\t\t\t\tCTIO7_FLAGS_EXPLICIT_CONFORM |\n\t\t\t\t\t\tCTIO7_FLAGS_CONFORM_REQ);\n\t\t\t\t}\n\t\t\t}\n\n\t\t} else {\n\t\t\t/*\n\t\t\t * We have already made sure that there is sufficient\n\t\t\t * amount of request entries to not drop HW lock in\n\t\t\t * req_pkt().\n\t\t\t */\n\t\t\tstruct ctio7_to_24xx *ctio =\n\t\t\t\t(struct ctio7_to_24xx *)qlt_get_req_pkt(\n\t\t\t\t    qpair->req);\n\n\t\t\tql_dbg_qp(ql_dbg_tgt, qpair, 0x305e,\n\t\t\t    \"Building additional status packet 0x%p.\\n\",\n\t\t\t    ctio);\n\n\t\t\t/*\n\t\t\t * T10Dif: ctio_crc2_to_fw overlay ontop of\n\t\t\t * ctio7_to_24xx\n\t\t\t */\n\t\t\tmemcpy(ctio, pkt, sizeof(*ctio));\n\t\t\t/* reset back to CTIO7 */\n\t\t\tctio->entry_count = 1;\n\t\t\tctio->entry_type = CTIO_TYPE7;\n\t\t\tctio->dseg_count = 0;\n\t\t\tctio->u.status1.flags &= ~cpu_to_le16(\n\t\t\t    CTIO7_FLAGS_DATA_IN);\n\n\t\t\t/* Real finish is ctio_m1's finish */\n\t\t\tpkt->handle |= CTIO_INTERMEDIATE_HANDLE_MARK;\n\t\t\tpkt->u.status0.flags |= cpu_to_le16(\n\t\t\t    CTIO7_FLAGS_DONT_RET_CTIO);\n\n\t\t\t/* qlt_24xx_init_ctio_to_isp will correct\n\t\t\t * all neccessary fields that's part of CTIO7.\n\t\t\t * There should be no residual of CTIO-CRC2 data.\n\t\t\t */\n\t\t\tqlt_24xx_init_ctio_to_isp((struct ctio7_to_24xx *)ctio,\n\t\t\t    &prm);\n\t\t}\n\t} else\n\t\tqlt_24xx_init_ctio_to_isp(pkt, &prm);\n\n\n\tcmd->state = QLA_TGT_STATE_PROCESSED; /* Mid-level is done processing */\n\tcmd->cmd_sent_to_fw = 1;\n\tcmd->ctio_flags = le16_to_cpu(pkt->u.status0.flags);\n\n\t/* Memory Barrier */\n\twmb();\n\tif (qpair->reqq_start_iocbs)\n\t\tqpair->reqq_start_iocbs(qpair);\n\telse\n\t\tqla2x00_start_iocbs(vha, qpair->req);\n\tspin_unlock_irqrestore(qpair->qp_lock_ptr, flags);\n\n\treturn 0;\n\nout_unmap_unlock:\n\tqlt_unmap_sg(vha, cmd);\n\tspin_unlock_irqrestore(qpair->qp_lock_ptr, flags);\n\nfree:\n\tvha->hw->tgt.tgt_ops->free_cmd(cmd);\n\treturn res;\n}\nEXPORT_SYMBOL(qlt_xmit_response);\n\nint qlt_rdy_to_xfer(struct qla_tgt_cmd *cmd)\n{\n\tstruct ctio7_to_24xx *pkt;\n\tstruct scsi_qla_host *vha = cmd->vha;\n\tstruct qla_tgt *tgt = cmd->tgt;\n\tstruct qla_tgt_prm prm;\n\tunsigned long flags = 0;\n\tint res = 0;\n\tstruct qla_qpair *qpair = cmd->qpair;\n\n\tmemset(&prm, 0, sizeof(prm));\n\tprm.cmd = cmd;\n\tprm.tgt = tgt;\n\tprm.sg = NULL;\n\tprm.req_cnt = 1;\n\n\t/* Calculate number of entries and segments required */\n\tif (qlt_pci_map_calc_cnt(&prm) != 0)\n\t\treturn -EAGAIN;\n\n\tif (!qpair->fw_started || (cmd->reset_count != qpair->chip_reset) ||\n\t    (cmd->sess && cmd->sess->deleted)) {\n\t\t/*\n\t\t * Either the port is not online or this request was from\n\t\t * previous life, just abort the processing.\n\t\t */\n\t\tcmd->aborted = 1;\n\t\tcmd->write_data_transferred = 0;\n\t\tcmd->state = QLA_TGT_STATE_DATA_IN;\n\t\tvha->hw->tgt.tgt_ops->handle_data(cmd);\n\t\tql_dbg_qp(ql_dbg_async, qpair, 0xe102,\n\t\t\t\"RESET-XFR online/active/old-count/new-count = %d/%d/%d/%d.\\n\",\n\t\t\tvha->flags.online, qla2x00_reset_active(vha),\n\t\t\tcmd->reset_count, qpair->chip_reset);\n\t\treturn 0;\n\t}\n\n\tspin_lock_irqsave(qpair->qp_lock_ptr, flags);\n\t/* Does F/W have an IOCBs for this request */\n\tres = qlt_check_reserve_free_req(qpair, prm.req_cnt);\n\tif (res != 0)\n\t\tgoto out_unlock_free_unmap;\n\tif (cmd->se_cmd.prot_op)\n\t\tres = qlt_build_ctio_crc2_pkt(qpair, &prm);\n\telse\n\t\tres = qlt_24xx_build_ctio_pkt(qpair, &prm);\n\n\tif (unlikely(res != 0)) {\n\t\tqpair->req->cnt += prm.req_cnt;\n\t\tgoto out_unlock_free_unmap;\n\t}\n\n\tpkt = (struct ctio7_to_24xx *)prm.pkt;\n\tpkt->u.status0.flags |= cpu_to_le16(CTIO7_FLAGS_DATA_OUT |\n\t    CTIO7_FLAGS_STATUS_MODE_0);\n\n\tif (cmd->se_cmd.prot_op == TARGET_PROT_NORMAL)\n\t\tqlt_load_data_segments(&prm);\n\n\tcmd->state = QLA_TGT_STATE_NEED_DATA;\n\tcmd->cmd_sent_to_fw = 1;\n\tcmd->ctio_flags = le16_to_cpu(pkt->u.status0.flags);\n\n\t/* Memory Barrier */\n\twmb();\n\tif (qpair->reqq_start_iocbs)\n\t\tqpair->reqq_start_iocbs(qpair);\n\telse\n\t\tqla2x00_start_iocbs(vha, qpair->req);\n\tspin_unlock_irqrestore(qpair->qp_lock_ptr, flags);\n\n\treturn res;\n\nout_unlock_free_unmap:\n\tqlt_unmap_sg(vha, cmd);\n\tspin_unlock_irqrestore(qpair->qp_lock_ptr, flags);\n\n\treturn res;\n}\nEXPORT_SYMBOL(qlt_rdy_to_xfer);\n\n\n/*\n * it is assumed either hardware_lock or qpair lock is held.\n */\nstatic void\nqlt_handle_dif_error(struct qla_qpair *qpair, struct qla_tgt_cmd *cmd,\n\tstruct ctio_crc_from_fw *sts)\n{\n\tuint8_t\t\t*ap = &sts->actual_dif[0];\n\tuint8_t\t\t*ep = &sts->expected_dif[0];\n\tuint64_t\tlba = cmd->se_cmd.t_task_lba;\n\tuint8_t scsi_status, sense_key, asc, ascq;\n\tunsigned long flags;\n\tstruct scsi_qla_host *vha = cmd->vha;\n\n\tcmd->trc_flags |= TRC_DIF_ERR;\n\n\tcmd->a_guard   = get_unaligned_be16(ap + 0);\n\tcmd->a_app_tag = get_unaligned_be16(ap + 2);\n\tcmd->a_ref_tag = get_unaligned_be32(ap + 4);\n\n\tcmd->e_guard   = get_unaligned_be16(ep + 0);\n\tcmd->e_app_tag = get_unaligned_be16(ep + 2);\n\tcmd->e_ref_tag = get_unaligned_be32(ep + 4);\n\n\tql_dbg(ql_dbg_tgt_dif, vha, 0xf075,\n\t    \"%s: aborted %d state %d\\n\", __func__, cmd->aborted, cmd->state);\n\n\tscsi_status = sense_key = asc = ascq = 0;\n\n\t/* check appl tag */\n\tif (cmd->e_app_tag != cmd->a_app_tag) {\n\t\tql_dbg(ql_dbg_tgt_dif, vha, 0xe00d,\n\t\t    \"App Tag ERR: cdb[%x] lba[%llx %llx] blks[%x] [Actual|Expected] Ref[%x|%x], App[%x|%x], Guard [%x|%x] cmd=%p ox_id[%04x]\",\n\t\t    cmd->cdb[0], lba, (lba+cmd->num_blks), cmd->num_blks,\n\t\t    cmd->a_ref_tag, cmd->e_ref_tag, cmd->a_app_tag,\n\t\t    cmd->e_app_tag, cmd->a_guard, cmd->e_guard, cmd,\n\t\t    cmd->atio.u.isp24.fcp_hdr.ox_id);\n\n\t\tcmd->dif_err_code = DIF_ERR_APP;\n\t\tscsi_status = SAM_STAT_CHECK_CONDITION;\n\t\tsense_key = ABORTED_COMMAND;\n\t\tasc = 0x10;\n\t\tascq = 0x2;\n\t}\n\n\t/* check ref tag */\n\tif (cmd->e_ref_tag != cmd->a_ref_tag) {\n\t\tql_dbg(ql_dbg_tgt_dif, vha, 0xe00e,\n\t\t    \"Ref Tag ERR: cdb[%x] lba[%llx %llx] blks[%x] [Actual|Expected] Ref[%x|%x], App[%x|%x], Guard[%x|%x] cmd=%p ox_id[%04x] \",\n\t\t    cmd->cdb[0], lba, (lba+cmd->num_blks), cmd->num_blks,\n\t\t    cmd->a_ref_tag, cmd->e_ref_tag, cmd->a_app_tag,\n\t\t    cmd->e_app_tag, cmd->a_guard, cmd->e_guard, cmd,\n\t\t    cmd->atio.u.isp24.fcp_hdr.ox_id);\n\n\t\tcmd->dif_err_code = DIF_ERR_REF;\n\t\tscsi_status = SAM_STAT_CHECK_CONDITION;\n\t\tsense_key = ABORTED_COMMAND;\n\t\tasc = 0x10;\n\t\tascq = 0x3;\n\t\tgoto out;\n\t}\n\n\t/* check guard */\n\tif (cmd->e_guard != cmd->a_guard) {\n\t\tql_dbg(ql_dbg_tgt_dif, vha, 0xe012,\n\t\t    \"Guard ERR: cdb[%x] lba[%llx %llx] blks[%x] [Actual|Expected] Ref[%x|%x], App[%x|%x], Guard [%x|%x] cmd=%p ox_id[%04x]\",\n\t\t    cmd->cdb[0], lba, (lba+cmd->num_blks), cmd->num_blks,\n\t\t    cmd->a_ref_tag, cmd->e_ref_tag, cmd->a_app_tag,\n\t\t    cmd->e_app_tag, cmd->a_guard, cmd->e_guard, cmd,\n\t\t    cmd->atio.u.isp24.fcp_hdr.ox_id);\n\n\t\tcmd->dif_err_code = DIF_ERR_GRD;\n\t\tscsi_status = SAM_STAT_CHECK_CONDITION;\n\t\tsense_key = ABORTED_COMMAND;\n\t\tasc = 0x10;\n\t\tascq = 0x1;\n\t}\nout:\n\tswitch (cmd->state) {\n\tcase QLA_TGT_STATE_NEED_DATA:\n\t\t/* handle_data will load DIF error code  */\n\t\tcmd->state = QLA_TGT_STATE_DATA_IN;\n\t\tvha->hw->tgt.tgt_ops->handle_data(cmd);\n\t\tbreak;\n\tdefault:\n\t\tspin_lock_irqsave(&cmd->cmd_lock, flags);\n\t\tif (cmd->aborted) {\n\t\t\tspin_unlock_irqrestore(&cmd->cmd_lock, flags);\n\t\t\tvha->hw->tgt.tgt_ops->free_cmd(cmd);\n\t\t\tbreak;\n\t\t}\n\t\tspin_unlock_irqrestore(&cmd->cmd_lock, flags);\n\n\t\tqlt_send_resp_ctio(qpair, cmd, scsi_status, sense_key, asc,\n\t\t    ascq);\n\t\t/* assume scsi status gets out on the wire.\n\t\t * Will not wait for completion.\n\t\t */\n\t\tvha->hw->tgt.tgt_ops->free_cmd(cmd);\n\t\tbreak;\n\t}\n}\n\n/* If hardware_lock held on entry, might drop it, then reaquire */\n/* This function sends the appropriate CTIO to ISP 2xxx or 24xx */\nstatic int __qlt_send_term_imm_notif(struct scsi_qla_host *vha,\n\tstruct imm_ntfy_from_isp *ntfy)\n{\n\tstruct nack_to_isp *nack;\n\tstruct qla_hw_data *ha = vha->hw;\n\trequest_t *pkt;\n\tint ret = 0;\n\n\tql_dbg(ql_dbg_tgt_tmr, vha, 0xe01c,\n\t    \"Sending TERM ELS CTIO (ha=%p)\\n\", ha);\n\n\tpkt = (request_t *)qla2x00_alloc_iocbs(vha, NULL);\n\tif (pkt == NULL) {\n\t\tql_dbg(ql_dbg_tgt, vha, 0xe080,\n\t\t    \"qla_target(%d): %s failed: unable to allocate \"\n\t\t    \"request packet\\n\", vha->vp_idx, __func__);\n\t\treturn -ENOMEM;\n\t}\n\n\tpkt->entry_type = NOTIFY_ACK_TYPE;\n\tpkt->entry_count = 1;\n\tpkt->handle = QLA_TGT_SKIP_HANDLE;\n\n\tnack = (struct nack_to_isp *)pkt;\n\tnack->ox_id = ntfy->ox_id;\n\n\tnack->u.isp24.nport_handle = ntfy->u.isp24.nport_handle;\n\tif (le16_to_cpu(ntfy->u.isp24.status) == IMM_NTFY_ELS) {\n\t\tnack->u.isp24.flags = ntfy->u.isp24.flags &\n\t\t\tcpu_to_le16(NOTIFY24XX_FLAGS_PUREX_IOCB);\n\t}\n\n\t/* terminate */\n\tnack->u.isp24.flags |=\n\t\t__constant_cpu_to_le16(NOTIFY_ACK_FLAGS_TERMINATE);\n\n\tnack->u.isp24.srr_rx_id = ntfy->u.isp24.srr_rx_id;\n\tnack->u.isp24.status = ntfy->u.isp24.status;\n\tnack->u.isp24.status_subcode = ntfy->u.isp24.status_subcode;\n\tnack->u.isp24.fw_handle = ntfy->u.isp24.fw_handle;\n\tnack->u.isp24.exchange_address = ntfy->u.isp24.exchange_address;\n\tnack->u.isp24.srr_rel_offs = ntfy->u.isp24.srr_rel_offs;\n\tnack->u.isp24.srr_ui = ntfy->u.isp24.srr_ui;\n\tnack->u.isp24.vp_index = ntfy->u.isp24.vp_index;\n\n\tqla2x00_start_iocbs(vha, vha->req);\n\treturn ret;\n}\n\nstatic void qlt_send_term_imm_notif(struct scsi_qla_host *vha,\n\tstruct imm_ntfy_from_isp *imm, int ha_locked)\n{\n\tint rc;\n\n\tWARN_ON_ONCE(!ha_locked);\n\trc = __qlt_send_term_imm_notif(vha, imm);\n\tpr_debug(\"rc = %d\\n\", rc);\n}\n\n/*\n * If hardware_lock held on entry, might drop it, then reaquire\n * This function sends the appropriate CTIO to ISP 2xxx or 24xx\n */\nstatic int __qlt_send_term_exchange(struct qla_qpair *qpair,\n\tstruct qla_tgt_cmd *cmd,\n\tstruct atio_from_isp *atio)\n{\n\tstruct scsi_qla_host *vha = qpair->vha;\n\tstruct ctio7_to_24xx *ctio24;\n\tstruct qla_hw_data *ha = vha->hw;\n\trequest_t *pkt;\n\tint ret = 0;\n\tuint16_t temp;\n\n\tql_dbg(ql_dbg_tgt, vha, 0xe009, \"Sending TERM EXCH CTIO (ha=%p)\\n\", ha);\n\n\tif (cmd)\n\t\tvha = cmd->vha;\n\n\tpkt = (request_t *)qla2x00_alloc_iocbs_ready(qpair, NULL);\n\tif (pkt == NULL) {\n\t\tql_dbg(ql_dbg_tgt, vha, 0xe050,\n\t\t    \"qla_target(%d): %s failed: unable to allocate \"\n\t\t    \"request packet\\n\", vha->vp_idx, __func__);\n\t\treturn -ENOMEM;\n\t}\n\n\tif (cmd != NULL) {\n\t\tif (cmd->state < QLA_TGT_STATE_PROCESSED) {\n\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe051,\n\t\t\t    \"qla_target(%d): Terminating cmd %p with \"\n\t\t\t    \"incorrect state %d\\n\", vha->vp_idx, cmd,\n\t\t\t    cmd->state);\n\t\t} else\n\t\t\tret = 1;\n\t}\n\n\tqpair->tgt_counters.num_term_xchg_sent++;\n\tpkt->entry_count = 1;\n\tpkt->handle = QLA_TGT_SKIP_HANDLE | CTIO_COMPLETION_HANDLE_MARK;\n\n\tctio24 = (struct ctio7_to_24xx *)pkt;\n\tctio24->entry_type = CTIO_TYPE7;\n\tctio24->nport_handle = cpu_to_le16(CTIO7_NHANDLE_UNRECOGNIZED);\n\tctio24->timeout = cpu_to_le16(QLA_TGT_TIMEOUT);\n\tctio24->vp_index = vha->vp_idx;\n\tctio24->initiator_id = be_id_to_le(atio->u.isp24.fcp_hdr.s_id);\n\tctio24->exchange_addr = atio->u.isp24.exchange_addr;\n\ttemp = (atio->u.isp24.attr << 9) | CTIO7_FLAGS_STATUS_MODE_1 |\n\t\tCTIO7_FLAGS_TERMINATE;\n\tctio24->u.status1.flags = cpu_to_le16(temp);\n\ttemp = be16_to_cpu(atio->u.isp24.fcp_hdr.ox_id);\n\tctio24->u.status1.ox_id = cpu_to_le16(temp);\n\n\t/* Memory Barrier */\n\twmb();\n\tif (qpair->reqq_start_iocbs)\n\t\tqpair->reqq_start_iocbs(qpair);\n\telse\n\t\tqla2x00_start_iocbs(vha, qpair->req);\n\treturn ret;\n}\n\nstatic void qlt_send_term_exchange(struct qla_qpair *qpair,\n\tstruct qla_tgt_cmd *cmd, struct atio_from_isp *atio, int ha_locked,\n\tint ul_abort)\n{\n\tstruct scsi_qla_host *vha;\n\tunsigned long flags = 0;\n\tint rc;\n\n\t/* why use different vha? NPIV */\n\tif (cmd)\n\t\tvha = cmd->vha;\n\telse\n\t\tvha = qpair->vha;\n\n\tif (ha_locked) {\n\t\trc = __qlt_send_term_exchange(qpair, cmd, atio);\n\t\tif (rc == -ENOMEM)\n\t\t\tqlt_alloc_qfull_cmd(vha, atio, 0, 0);\n\t\tgoto done;\n\t}\n\tspin_lock_irqsave(qpair->qp_lock_ptr, flags);\n\trc = __qlt_send_term_exchange(qpair, cmd, atio);\n\tif (rc == -ENOMEM)\n\t\tqlt_alloc_qfull_cmd(vha, atio, 0, 0);\n\ndone:\n\tif (cmd && !ul_abort && !cmd->aborted) {\n\t\tif (cmd->sg_mapped)\n\t\t\tqlt_unmap_sg(vha, cmd);\n\t\tvha->hw->tgt.tgt_ops->free_cmd(cmd);\n\t}\n\n\tif (!ha_locked)\n\t\tspin_unlock_irqrestore(qpair->qp_lock_ptr, flags);\n\n\treturn;\n}\n\nstatic void qlt_init_term_exchange(struct scsi_qla_host *vha)\n{\n\tstruct list_head free_list;\n\tstruct qla_tgt_cmd *cmd, *tcmd;\n\n\tvha->hw->tgt.leak_exchg_thresh_hold =\n\t    (vha->hw->cur_fw_xcb_count/100) * LEAK_EXCHG_THRESH_HOLD_PERCENT;\n\n\tcmd = tcmd = NULL;\n\tif (!list_empty(&vha->hw->tgt.q_full_list)) {\n\t\tINIT_LIST_HEAD(&free_list);\n\t\tlist_splice_init(&vha->hw->tgt.q_full_list, &free_list);\n\n\t\tlist_for_each_entry_safe(cmd, tcmd, &free_list, cmd_list) {\n\t\t\tlist_del(&cmd->cmd_list);\n\t\t\t/* This cmd was never sent to TCM.  There is no need\n\t\t\t * to schedule free or call free_cmd\n\t\t\t */\n\t\t\tqlt_free_cmd(cmd);\n\t\t\tvha->hw->tgt.num_qfull_cmds_alloc--;\n\t\t}\n\t}\n\tvha->hw->tgt.num_qfull_cmds_dropped = 0;\n}\n\nstatic void qlt_chk_exch_leak_thresh_hold(struct scsi_qla_host *vha)\n{\n\tuint32_t total_leaked;\n\n\ttotal_leaked = vha->hw->tgt.num_qfull_cmds_dropped;\n\n\tif (vha->hw->tgt.leak_exchg_thresh_hold &&\n\t    (total_leaked > vha->hw->tgt.leak_exchg_thresh_hold)) {\n\n\t\tql_dbg(ql_dbg_tgt, vha, 0xe079,\n\t\t    \"Chip reset due to exchange starvation: %d/%d.\\n\",\n\t\t    total_leaked, vha->hw->cur_fw_xcb_count);\n\n\t\tif (IS_P3P_TYPE(vha->hw))\n\t\t\tset_bit(FCOE_CTX_RESET_NEEDED, &vha->dpc_flags);\n\t\telse\n\t\t\tset_bit(ISP_ABORT_NEEDED, &vha->dpc_flags);\n\t\tqla2xxx_wake_dpc(vha);\n\t}\n\n}\n\nint qlt_abort_cmd(struct qla_tgt_cmd *cmd)\n{\n\tstruct qla_tgt *tgt = cmd->tgt;\n\tstruct scsi_qla_host *vha = tgt->vha;\n\tstruct se_cmd *se_cmd = &cmd->se_cmd;\n\tunsigned long flags;\n\n\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf014,\n\t    \"qla_target(%d): terminating exchange for aborted cmd=%p \"\n\t    \"(se_cmd=%p, tag=%llu)\", vha->vp_idx, cmd, &cmd->se_cmd,\n\t    se_cmd->tag);\n\n\tspin_lock_irqsave(&cmd->cmd_lock, flags);\n\tif (cmd->aborted) {\n\t\tspin_unlock_irqrestore(&cmd->cmd_lock, flags);\n\t\t/*\n\t\t * It's normal to see 2 calls in this path:\n\t\t *  1) XFER Rdy completion + CMD_T_ABORT\n\t\t *  2) TCM TMR - drain_state_list\n\t\t */\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf016,\n\t\t    \"multiple abort. %p transport_state %x, t_state %x, \"\n\t\t    \"se_cmd_flags %x\\n\", cmd, cmd->se_cmd.transport_state,\n\t\t    cmd->se_cmd.t_state, cmd->se_cmd.se_cmd_flags);\n\t\treturn -EIO;\n\t}\n\tcmd->aborted = 1;\n\tcmd->trc_flags |= TRC_ABORT;\n\tspin_unlock_irqrestore(&cmd->cmd_lock, flags);\n\n\tqlt_send_term_exchange(cmd->qpair, cmd, &cmd->atio, 0, 1);\n\treturn 0;\n}\nEXPORT_SYMBOL(qlt_abort_cmd);\n\nvoid qlt_free_cmd(struct qla_tgt_cmd *cmd)\n{\n\tstruct fc_port *sess = cmd->sess;\n\n\tql_dbg(ql_dbg_tgt, cmd->vha, 0xe074,\n\t    \"%s: se_cmd[%p] ox_id %04x\\n\",\n\t    __func__, &cmd->se_cmd,\n\t    be16_to_cpu(cmd->atio.u.isp24.fcp_hdr.ox_id));\n\n\tBUG_ON(cmd->cmd_in_wq);\n\n\tif (cmd->sg_mapped)\n\t\tqlt_unmap_sg(cmd->vha, cmd);\n\n\tif (!cmd->q_full)\n\t\tqlt_decr_num_pend_cmds(cmd->vha);\n\n\tBUG_ON(cmd->sg_mapped);\n\tcmd->jiffies_at_free = get_jiffies_64();\n\tif (unlikely(cmd->free_sg))\n\t\tkfree(cmd->sg);\n\n\tif (!sess || !sess->se_sess) {\n\t\tWARN_ON(1);\n\t\treturn;\n\t}\n\tcmd->jiffies_at_free = get_jiffies_64();\n\tcmd->vha->hw->tgt.tgt_ops->rel_cmd(cmd);\n}\nEXPORT_SYMBOL(qlt_free_cmd);\n\n/*\n * ha->hardware_lock supposed to be held on entry. Might drop it, then reaquire\n */\nstatic int qlt_term_ctio_exchange(struct qla_qpair *qpair, void *ctio,\n\tstruct qla_tgt_cmd *cmd, uint32_t status)\n{\n\tint term = 0;\n\tstruct scsi_qla_host *vha = qpair->vha;\n\n\tif (cmd->se_cmd.prot_op)\n\t\tql_dbg(ql_dbg_tgt_dif, vha, 0xe013,\n\t\t    \"Term DIF cmd: lba[0x%llx|%lld] len[0x%x] \"\n\t\t    \"se_cmd=%p tag[%x] op %#x/%s\",\n\t\t     cmd->lba, cmd->lba,\n\t\t     cmd->num_blks, &cmd->se_cmd,\n\t\t     cmd->atio.u.isp24.exchange_addr,\n\t\t     cmd->se_cmd.prot_op,\n\t\t     prot_op_str(cmd->se_cmd.prot_op));\n\n\tif (ctio != NULL) {\n\t\tstruct ctio7_from_24xx *c = (struct ctio7_from_24xx *)ctio;\n\n\t\tterm = !(c->flags &\n\t\t    cpu_to_le16(OF_TERM_EXCH));\n\t} else\n\t\tterm = 1;\n\n\tif (term)\n\t\tqlt_send_term_exchange(qpair, cmd, &cmd->atio, 1, 0);\n\n\treturn term;\n}\n\n\n/* ha->hardware_lock supposed to be held on entry */\nstatic void *qlt_ctio_to_cmd(struct scsi_qla_host *vha,\n\tstruct rsp_que *rsp, uint32_t handle, void *ctio)\n{\n\tvoid *cmd = NULL;\n\tstruct req_que *req;\n\tint qid = GET_QID(handle);\n\tuint32_t h = handle & ~QLA_TGT_HANDLE_MASK;\n\n\tif (unlikely(h == QLA_TGT_SKIP_HANDLE))\n\t\treturn NULL;\n\n\tif (qid == rsp->req->id) {\n\t\treq = rsp->req;\n\t} else if (vha->hw->req_q_map[qid]) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0x1000a,\n\t\t    \"qla_target(%d): CTIO completion with different QID %d handle %x\\n\",\n\t\t    vha->vp_idx, rsp->id, handle);\n\t\treq = vha->hw->req_q_map[qid];\n\t} else {\n\t\treturn NULL;\n\t}\n\n\th &= QLA_CMD_HANDLE_MASK;\n\n\tif (h != QLA_TGT_NULL_HANDLE) {\n\t\tif (unlikely(h >= req->num_outstanding_cmds)) {\n\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe052,\n\t\t\t    \"qla_target(%d): Wrong handle %x received\\n\",\n\t\t\t    vha->vp_idx, handle);\n\t\t\treturn NULL;\n\t\t}\n\n\t\tcmd = req->outstanding_cmds[h];\n\t\tif (unlikely(cmd == NULL)) {\n\t\t\tql_dbg(ql_dbg_async, vha, 0xe053,\n\t\t\t    \"qla_target(%d): Suspicious: unable to find the command with handle %x req->id %d rsp->id %d\\n\",\n\t\t\t\tvha->vp_idx, handle, req->id, rsp->id);\n\t\t\treturn NULL;\n\t\t}\n\t\treq->outstanding_cmds[h] = NULL;\n\t} else if (ctio != NULL) {\n\t\t/* We can't get loop ID from CTIO7 */\n\t\tql_dbg(ql_dbg_tgt, vha, 0xe054,\n\t\t    \"qla_target(%d): Wrong CTIO received: QLA24xx doesn't \"\n\t\t    \"support NULL handles\\n\", vha->vp_idx);\n\t\treturn NULL;\n\t}\n\n\treturn cmd;\n}\n\n/*\n * ha->hardware_lock supposed to be held on entry. Might drop it, then reaquire\n */\nstatic void qlt_do_ctio_completion(struct scsi_qla_host *vha,\n    struct rsp_que *rsp, uint32_t handle, uint32_t status, void *ctio)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct se_cmd *se_cmd;\n\tstruct qla_tgt_cmd *cmd;\n\tstruct qla_qpair *qpair = rsp->qpair;\n\n\tif (handle & CTIO_INTERMEDIATE_HANDLE_MARK) {\n\t\t/* That could happen only in case of an error/reset/abort */\n\t\tif (status != CTIO_SUCCESS) {\n\t\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf01d,\n\t\t\t    \"Intermediate CTIO received\"\n\t\t\t    \" (status %x)\\n\", status);\n\t\t}\n\t\treturn;\n\t}\n\n\tcmd = qlt_ctio_to_cmd(vha, rsp, handle, ctio);\n\tif (cmd == NULL)\n\t\treturn;\n\n\tse_cmd = &cmd->se_cmd;\n\tcmd->cmd_sent_to_fw = 0;\n\n\tqlt_unmap_sg(vha, cmd);\n\n\tif (unlikely(status != CTIO_SUCCESS)) {\n\t\tswitch (status & 0xFFFF) {\n\t\tcase CTIO_INVALID_RX_ID:\n\t\t\tif (printk_ratelimit())\n\t\t\t\tdev_info(&vha->hw->pdev->dev,\n\t\t\t\t    \"qla_target(%d): CTIO with INVALID_RX_ID ATIO attr %x CTIO Flags %x|%x\\n\",\n\t\t\t\t    vha->vp_idx, cmd->atio.u.isp24.attr,\n\t\t\t\t    ((cmd->ctio_flags >> 9) & 0xf),\n\t\t\t\t    cmd->ctio_flags);\n\n\t\t\tbreak;\n\t\tcase CTIO_LIP_RESET:\n\t\tcase CTIO_TARGET_RESET:\n\t\tcase CTIO_ABORTED:\n\t\t\t/* driver request abort via Terminate exchange */\n\t\tcase CTIO_TIMEOUT:\n\t\t\t/* They are OK */\n\t\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf058,\n\t\t\t    \"qla_target(%d): CTIO with \"\n\t\t\t    \"status %#x received, state %x, se_cmd %p, \"\n\t\t\t    \"(LIP_RESET=e, ABORTED=2, TARGET_RESET=17, \"\n\t\t\t    \"TIMEOUT=b, INVALID_RX_ID=8)\\n\", vha->vp_idx,\n\t\t\t    status, cmd->state, se_cmd);\n\t\t\tbreak;\n\n\t\tcase CTIO_PORT_LOGGED_OUT:\n\t\tcase CTIO_PORT_UNAVAILABLE:\n\t\t{\n\t\t\tint logged_out =\n\t\t\t\t(status & 0xFFFF) == CTIO_PORT_LOGGED_OUT;\n\n\t\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf059,\n\t\t\t    \"qla_target(%d): CTIO with %s status %x \"\n\t\t\t    \"received (state %x, se_cmd %p)\\n\", vha->vp_idx,\n\t\t\t    logged_out ? \"PORT LOGGED OUT\" : \"PORT UNAVAILABLE\",\n\t\t\t    status, cmd->state, se_cmd);\n\n\t\t\tif (logged_out && cmd->sess) {\n\t\t\t\t/*\n\t\t\t\t * Session is already logged out, but we need\n\t\t\t\t * to notify initiator, who's not aware of this\n\t\t\t\t */\n\t\t\t\tcmd->sess->send_els_logo = 1;\n\t\t\t\tql_dbg(ql_dbg_disc, vha, 0x20f8,\n\t\t\t\t    \"%s %d %8phC post del sess\\n\",\n\t\t\t\t    __func__, __LINE__, cmd->sess->port_name);\n\n\t\t\t\tqlt_schedule_sess_for_deletion(cmd->sess);\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t\tcase CTIO_DIF_ERROR: {\n\t\t\tstruct ctio_crc_from_fw *crc =\n\t\t\t\t(struct ctio_crc_from_fw *)ctio;\n\t\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf073,\n\t\t\t    \"qla_target(%d): CTIO with DIF_ERROR status %x \"\n\t\t\t    \"received (state %x, ulp_cmd %p) actual_dif[0x%llx] \"\n\t\t\t    \"expect_dif[0x%llx]\\n\",\n\t\t\t    vha->vp_idx, status, cmd->state, se_cmd,\n\t\t\t    *((u64 *)&crc->actual_dif[0]),\n\t\t\t    *((u64 *)&crc->expected_dif[0]));\n\n\t\t\tqlt_handle_dif_error(qpair, cmd, ctio);\n\t\t\treturn;\n\t\t}\n\t\tdefault:\n\t\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf05b,\n\t\t\t    \"qla_target(%d): CTIO with error status 0x%x received (state %x, se_cmd %p\\n\",\n\t\t\t    vha->vp_idx, status, cmd->state, se_cmd);\n\t\t\tbreak;\n\t\t}\n\n\n\t\t/* \"cmd->aborted\" means\n\t\t * cmd is already aborted/terminated, we don't\n\t\t * need to terminate again.  The exchange is already\n\t\t * cleaned up/freed at FW level.  Just cleanup at driver\n\t\t * level.\n\t\t */\n\t\tif ((cmd->state != QLA_TGT_STATE_NEED_DATA) &&\n\t\t    (!cmd->aborted)) {\n\t\t\tcmd->trc_flags |= TRC_CTIO_ERR;\n\t\t\tif (qlt_term_ctio_exchange(qpair, ctio, cmd, status))\n\t\t\t\treturn;\n\t\t}\n\t}\n\n\tif (cmd->state == QLA_TGT_STATE_PROCESSED) {\n\t\tcmd->trc_flags |= TRC_CTIO_DONE;\n\t} else if (cmd->state == QLA_TGT_STATE_NEED_DATA) {\n\t\tcmd->state = QLA_TGT_STATE_DATA_IN;\n\n\t\tif (status == CTIO_SUCCESS)\n\t\t\tcmd->write_data_transferred = 1;\n\n\t\tha->tgt.tgt_ops->handle_data(cmd);\n\t\treturn;\n\t} else if (cmd->aborted) {\n\t\tcmd->trc_flags |= TRC_CTIO_ABORTED;\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf01e,\n\t\t  \"Aborted command %p (tag %lld) finished\\n\", cmd, se_cmd->tag);\n\t} else {\n\t\tcmd->trc_flags |= TRC_CTIO_STRANGE;\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf05c,\n\t\t    \"qla_target(%d): A command in state (%d) should \"\n\t\t    \"not return a CTIO complete\\n\", vha->vp_idx, cmd->state);\n\t}\n\n\tif (unlikely(status != CTIO_SUCCESS) &&\n\t\t!cmd->aborted) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf01f, \"Finishing failed CTIO\\n\");\n\t\tdump_stack();\n\t}\n\n\tha->tgt.tgt_ops->free_cmd(cmd);\n}\n\nstatic inline int qlt_get_fcp_task_attr(struct scsi_qla_host *vha,\n\tuint8_t task_codes)\n{\n\tint fcp_task_attr;\n\n\tswitch (task_codes) {\n\tcase ATIO_SIMPLE_QUEUE:\n\t\tfcp_task_attr = TCM_SIMPLE_TAG;\n\t\tbreak;\n\tcase ATIO_HEAD_OF_QUEUE:\n\t\tfcp_task_attr = TCM_HEAD_TAG;\n\t\tbreak;\n\tcase ATIO_ORDERED_QUEUE:\n\t\tfcp_task_attr = TCM_ORDERED_TAG;\n\t\tbreak;\n\tcase ATIO_ACA_QUEUE:\n\t\tfcp_task_attr = TCM_ACA_TAG;\n\t\tbreak;\n\tcase ATIO_UNTAGGED:\n\t\tfcp_task_attr = TCM_SIMPLE_TAG;\n\t\tbreak;\n\tdefault:\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf05d,\n\t\t    \"qla_target: unknown task code %x, use ORDERED instead\\n\",\n\t\t    task_codes);\n\t\tfcp_task_attr = TCM_ORDERED_TAG;\n\t\tbreak;\n\t}\n\n\treturn fcp_task_attr;\n}\n\n/*\n * Process context for I/O path into tcm_qla2xxx code\n */\nstatic void __qlt_do_work(struct qla_tgt_cmd *cmd)\n{\n\tscsi_qla_host_t *vha = cmd->vha;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct fc_port *sess = cmd->sess;\n\tstruct atio_from_isp *atio = &cmd->atio;\n\tunsigned char *cdb;\n\tunsigned long flags;\n\tuint32_t data_length;\n\tint ret, fcp_task_attr, data_dir, bidi = 0;\n\tstruct qla_qpair *qpair = cmd->qpair;\n\n\tcmd->cmd_in_wq = 0;\n\tcmd->trc_flags |= TRC_DO_WORK;\n\n\tif (cmd->aborted) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf082,\n\t\t    \"cmd with tag %u is aborted\\n\",\n\t\t    cmd->atio.u.isp24.exchange_addr);\n\t\tgoto out_term;\n\t}\n\n\tspin_lock_init(&cmd->cmd_lock);\n\tcdb = &atio->u.isp24.fcp_cmnd.cdb[0];\n\tcmd->se_cmd.tag = le32_to_cpu(atio->u.isp24.exchange_addr);\n\n\tif (atio->u.isp24.fcp_cmnd.rddata &&\n\t    atio->u.isp24.fcp_cmnd.wrdata) {\n\t\tbidi = 1;\n\t\tdata_dir = DMA_TO_DEVICE;\n\t} else if (atio->u.isp24.fcp_cmnd.rddata)\n\t\tdata_dir = DMA_FROM_DEVICE;\n\telse if (atio->u.isp24.fcp_cmnd.wrdata)\n\t\tdata_dir = DMA_TO_DEVICE;\n\telse\n\t\tdata_dir = DMA_NONE;\n\n\tfcp_task_attr = qlt_get_fcp_task_attr(vha,\n\t    atio->u.isp24.fcp_cmnd.task_attr);\n\tdata_length = get_datalen_for_atio(atio);\n\n\tret = ha->tgt.tgt_ops->handle_cmd(vha, cmd, cdb, data_length,\n\t\t\t\t          fcp_task_attr, data_dir, bidi);\n\tif (ret != 0)\n\t\tgoto out_term;\n\t/*\n\t * Drop extra session reference from qlt_handle_cmd_for_atio().\n\t */\n\tha->tgt.tgt_ops->put_sess(sess);\n\treturn;\n\nout_term:\n\tql_dbg(ql_dbg_io, vha, 0x3060, \"Terminating work cmd %p\", cmd);\n\t/*\n\t * cmd has not sent to target yet, so pass NULL as the second\n\t * argument to qlt_send_term_exchange() and free the memory here.\n\t */\n\tcmd->trc_flags |= TRC_DO_WORK_ERR;\n\tspin_lock_irqsave(qpair->qp_lock_ptr, flags);\n\tqlt_send_term_exchange(qpair, NULL, &cmd->atio, 1, 0);\n\n\tqlt_decr_num_pend_cmds(vha);\n\tcmd->vha->hw->tgt.tgt_ops->rel_cmd(cmd);\n\tspin_unlock_irqrestore(qpair->qp_lock_ptr, flags);\n\n\tha->tgt.tgt_ops->put_sess(sess);\n}\n\nstatic void qlt_do_work(struct work_struct *work)\n{\n\tstruct qla_tgt_cmd *cmd = container_of(work, struct qla_tgt_cmd, work);\n\tscsi_qla_host_t *vha = cmd->vha;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&vha->cmd_list_lock, flags);\n\tlist_del(&cmd->cmd_list);\n\tspin_unlock_irqrestore(&vha->cmd_list_lock, flags);\n\n\t__qlt_do_work(cmd);\n}\n\nvoid qlt_clr_qp_table(struct scsi_qla_host *vha)\n{\n\tunsigned long flags;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct qla_tgt *tgt = vha->vha_tgt.qla_tgt;\n\tvoid *node;\n\tu64 key = 0;\n\n\tql_log(ql_log_info, vha, 0x706c,\n\t    \"User update Number of Active Qpairs %d\\n\",\n\t    ha->tgt.num_act_qpairs);\n\n\tspin_lock_irqsave(&ha->tgt.atio_lock, flags);\n\n\tbtree_for_each_safe64(&tgt->lun_qpair_map, key, node)\n\t\tbtree_remove64(&tgt->lun_qpair_map, key);\n\n\tha->base_qpair->lun_cnt = 0;\n\tfor (key = 0; key < ha->max_qpairs; key++)\n\t\tif (ha->queue_pair_map[key])\n\t\t\tha->queue_pair_map[key]->lun_cnt = 0;\n\n\tspin_unlock_irqrestore(&ha->tgt.atio_lock, flags);\n}\n\nstatic void qlt_assign_qpair(struct scsi_qla_host *vha,\n\tstruct qla_tgt_cmd *cmd)\n{\n\tstruct qla_qpair *qpair, *qp;\n\tstruct qla_tgt *tgt = vha->vha_tgt.qla_tgt;\n\tstruct qla_qpair_hint *h;\n\n\tif (vha->flags.qpairs_available) {\n\t\th = btree_lookup64(&tgt->lun_qpair_map, cmd->unpacked_lun);\n\t\tif (unlikely(!h)) {\n\t\t\t/* spread lun to qpair ratio evently */\n\t\t\tint lcnt = 0, rc;\n\t\t\tstruct scsi_qla_host *base_vha =\n\t\t\t\tpci_get_drvdata(vha->hw->pdev);\n\n\t\t\tqpair = vha->hw->base_qpair;\n\t\t\tif (qpair->lun_cnt == 0) {\n\t\t\t\tqpair->lun_cnt++;\n\t\t\t\th = qla_qpair_to_hint(tgt, qpair);\n\t\t\t\tBUG_ON(!h);\n\t\t\t\trc = btree_insert64(&tgt->lun_qpair_map,\n\t\t\t\t\tcmd->unpacked_lun, h, GFP_ATOMIC);\n\t\t\t\tif (rc) {\n\t\t\t\t\tqpair->lun_cnt--;\n\t\t\t\t\tql_log(ql_log_info, vha, 0xd037,\n\t\t\t\t\t    \"Unable to insert lun %llx into lun_qpair_map\\n\",\n\t\t\t\t\t    cmd->unpacked_lun);\n\t\t\t\t}\n\t\t\t\tgoto out;\n\t\t\t} else {\n\t\t\t\tlcnt = qpair->lun_cnt;\n\t\t\t}\n\n\t\t\th = NULL;\n\t\t\tlist_for_each_entry(qp, &base_vha->qp_list,\n\t\t\t    qp_list_elem) {\n\t\t\t\tif (qp->lun_cnt == 0) {\n\t\t\t\t\tqp->lun_cnt++;\n\t\t\t\t\th = qla_qpair_to_hint(tgt, qp);\n\t\t\t\t\tBUG_ON(!h);\n\t\t\t\t\trc = btree_insert64(&tgt->lun_qpair_map,\n\t\t\t\t\t    cmd->unpacked_lun, h, GFP_ATOMIC);\n\t\t\t\t\tif (rc) {\n\t\t\t\t\t\tqp->lun_cnt--;\n\t\t\t\t\t\tql_log(ql_log_info, vha, 0xd038,\n\t\t\t\t\t\t\t\"Unable to insert lun %llx into lun_qpair_map\\n\",\n\t\t\t\t\t\t\tcmd->unpacked_lun);\n\t\t\t\t\t}\n\t\t\t\t\tqpair = qp;\n\t\t\t\t\tgoto out;\n\t\t\t\t} else {\n\t\t\t\t\tif (qp->lun_cnt < lcnt) {\n\t\t\t\t\t\tlcnt = qp->lun_cnt;\n\t\t\t\t\t\tqpair = qp;\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tBUG_ON(!qpair);\n\t\t\tqpair->lun_cnt++;\n\t\t\th = qla_qpair_to_hint(tgt, qpair);\n\t\t\tBUG_ON(!h);\n\t\t\trc = btree_insert64(&tgt->lun_qpair_map,\n\t\t\t\tcmd->unpacked_lun, h, GFP_ATOMIC);\n\t\t\tif (rc) {\n\t\t\t\tqpair->lun_cnt--;\n\t\t\t\tql_log(ql_log_info, vha, 0xd039,\n\t\t\t\t   \"Unable to insert lun %llx into lun_qpair_map\\n\",\n\t\t\t\t   cmd->unpacked_lun);\n\t\t\t}\n\t\t}\n\t} else {\n\t\th = &tgt->qphints[0];\n\t}\nout:\n\tcmd->qpair = h->qpair;\n\tcmd->se_cmd.cpuid = h->cpuid;\n}\n\nstatic struct qla_tgt_cmd *qlt_get_tag(scsi_qla_host_t *vha,\n\t\t\t\t       struct fc_port *sess,\n\t\t\t\t       struct atio_from_isp *atio)\n{\n\tstruct qla_tgt_cmd *cmd;\n\n\tcmd = vha->hw->tgt.tgt_ops->get_cmd(sess);\n\tif (!cmd)\n\t\treturn NULL;\n\n\tcmd->cmd_type = TYPE_TGT_CMD;\n\tmemcpy(&cmd->atio, atio, sizeof(*atio));\n\tINIT_LIST_HEAD(&cmd->sess_cmd_list);\n\tcmd->state = QLA_TGT_STATE_NEW;\n\tcmd->tgt = vha->vha_tgt.qla_tgt;\n\tqlt_incr_num_pend_cmds(vha);\n\tcmd->vha = vha;\n\tcmd->sess = sess;\n\tcmd->loop_id = sess->loop_id;\n\tcmd->conf_compl_supported = sess->conf_compl_supported;\n\n\tcmd->trc_flags = 0;\n\tcmd->jiffies_at_alloc = get_jiffies_64();\n\n\tcmd->unpacked_lun = scsilun_to_int(\n\t    (struct scsi_lun *)&atio->u.isp24.fcp_cmnd.lun);\n\tqlt_assign_qpair(vha, cmd);\n\tcmd->reset_count = vha->hw->base_qpair->chip_reset;\n\tcmd->vp_idx = vha->vp_idx;\n\n\treturn cmd;\n}\n\n/* ha->hardware_lock supposed to be held on entry */\nstatic int qlt_handle_cmd_for_atio(struct scsi_qla_host *vha,\n\tstruct atio_from_isp *atio)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct qla_tgt *tgt = vha->vha_tgt.qla_tgt;\n\tstruct fc_port *sess;\n\tstruct qla_tgt_cmd *cmd;\n\tunsigned long flags;\n\tport_id_t id;\n\n\tif (unlikely(tgt->tgt_stop)) {\n\t\tql_dbg(ql_dbg_io, vha, 0x3061,\n\t\t    \"New command while device %p is shutting down\\n\", tgt);\n\t\treturn -ENODEV;\n\t}\n\n\tid = be_to_port_id(atio->u.isp24.fcp_hdr.s_id);\n\tif (IS_SW_RESV_ADDR(id))\n\t\treturn -EBUSY;\n\n\tsess = ha->tgt.tgt_ops->find_sess_by_s_id(vha, atio->u.isp24.fcp_hdr.s_id);\n\tif (unlikely(!sess))\n\t\treturn -EFAULT;\n\n\t/* Another WWN used to have our s_id. Our PLOGI scheduled its\n\t * session deletion, but it's still in sess_del_work wq */\n\tif (sess->deleted) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf002,\n\t\t    \"New command while old session %p is being deleted\\n\",\n\t\t    sess);\n\t\treturn -EFAULT;\n\t}\n\n\t/*\n\t * Do kref_get() before returning + dropping qla_hw_data->hardware_lock.\n\t */\n\tif (!kref_get_unless_zero(&sess->sess_kref)) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf004,\n\t\t    \"%s: kref_get fail, %8phC oxid %x \\n\",\n\t\t    __func__, sess->port_name,\n\t\t     be16_to_cpu(atio->u.isp24.fcp_hdr.ox_id));\n\t\treturn -EFAULT;\n\t}\n\n\tcmd = qlt_get_tag(vha, sess, atio);\n\tif (!cmd) {\n\t\tql_dbg(ql_dbg_io, vha, 0x3062,\n\t\t    \"qla_target(%d): Allocation of cmd failed\\n\", vha->vp_idx);\n\t\tha->tgt.tgt_ops->put_sess(sess);\n\t\treturn -EBUSY;\n\t}\n\n\tcmd->cmd_in_wq = 1;\n\tcmd->trc_flags |= TRC_NEW_CMD;\n\n\tspin_lock_irqsave(&vha->cmd_list_lock, flags);\n\tlist_add_tail(&cmd->cmd_list, &vha->qla_cmd_list);\n\tspin_unlock_irqrestore(&vha->cmd_list_lock, flags);\n\n\tINIT_WORK(&cmd->work, qlt_do_work);\n\tif (vha->flags.qpairs_available) {\n\t\tqueue_work_on(cmd->se_cmd.cpuid, qla_tgt_wq, &cmd->work);\n\t} else if (ha->msix_count) {\n\t\tif (cmd->atio.u.isp24.fcp_cmnd.rddata)\n\t\t\tqueue_work_on(smp_processor_id(), qla_tgt_wq,\n\t\t\t    &cmd->work);\n\t\telse\n\t\t\tqueue_work_on(cmd->se_cmd.cpuid, qla_tgt_wq,\n\t\t\t    &cmd->work);\n\t} else {\n\t\tqueue_work(qla_tgt_wq, &cmd->work);\n\t}\n\n\treturn 0;\n}\n\n/* ha->hardware_lock supposed to be held on entry */\nstatic int qlt_issue_task_mgmt(struct fc_port *sess, u64 lun,\n\tint fn, void *iocb, int flags)\n{\n\tstruct scsi_qla_host *vha = sess->vha;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct qla_tgt_mgmt_cmd *mcmd;\n\tstruct atio_from_isp *a = (struct atio_from_isp *)iocb;\n\tstruct qla_qpair_hint *h = &vha->vha_tgt.qla_tgt->qphints[0];\n\n\tmcmd = mempool_alloc(qla_tgt_mgmt_cmd_mempool, GFP_ATOMIC);\n\tif (!mcmd) {\n\t\tql_dbg(ql_dbg_tgt_tmr, vha, 0x10009,\n\t\t    \"qla_target(%d): Allocation of management \"\n\t\t    \"command failed, some commands and their data could \"\n\t\t    \"leak\\n\", vha->vp_idx);\n\t\treturn -ENOMEM;\n\t}\n\tmemset(mcmd, 0, sizeof(*mcmd));\n\tmcmd->sess = sess;\n\n\tif (iocb) {\n\t\tmemcpy(&mcmd->orig_iocb.imm_ntfy, iocb,\n\t\t    sizeof(mcmd->orig_iocb.imm_ntfy));\n\t}\n\tmcmd->tmr_func = fn;\n\tmcmd->flags = flags;\n\tmcmd->reset_count = ha->base_qpair->chip_reset;\n\tmcmd->qpair = h->qpair;\n\tmcmd->vha = vha;\n\tmcmd->se_cmd.cpuid = h->cpuid;\n\tmcmd->unpacked_lun = lun;\n\n\tswitch (fn) {\n\tcase QLA_TGT_LUN_RESET:\n\tcase QLA_TGT_CLEAR_TS:\n\tcase QLA_TGT_ABORT_TS:\n\t\tabort_cmds_for_lun(vha, lun, a->u.isp24.fcp_hdr.s_id);\n\t\tfallthrough;\n\tcase QLA_TGT_CLEAR_ACA:\n\t\th = qlt_find_qphint(vha, mcmd->unpacked_lun);\n\t\tmcmd->qpair = h->qpair;\n\t\tmcmd->se_cmd.cpuid = h->cpuid;\n\t\tbreak;\n\n\tcase QLA_TGT_TARGET_RESET:\n\tcase QLA_TGT_NEXUS_LOSS_SESS:\n\tcase QLA_TGT_NEXUS_LOSS:\n\tcase QLA_TGT_ABORT_ALL:\n\tdefault:\n\t\t/* no-op */\n\t\tbreak;\n\t}\n\n\tINIT_WORK(&mcmd->work, qlt_do_tmr_work);\n\tqueue_work_on(mcmd->se_cmd.cpuid, qla_tgt_wq,\n\t    &mcmd->work);\n\n\treturn 0;\n}\n\n/* ha->hardware_lock supposed to be held on entry */\nstatic int qlt_handle_task_mgmt(struct scsi_qla_host *vha, void *iocb)\n{\n\tstruct atio_from_isp *a = (struct atio_from_isp *)iocb;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct fc_port *sess;\n\tu64 unpacked_lun;\n\tint fn;\n\tunsigned long flags;\n\n\tfn = a->u.isp24.fcp_cmnd.task_mgmt_flags;\n\n\tspin_lock_irqsave(&ha->tgt.sess_lock, flags);\n\tsess = ha->tgt.tgt_ops->find_sess_by_s_id(vha,\n\t    a->u.isp24.fcp_hdr.s_id);\n\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\n\n\tunpacked_lun =\n\t    scsilun_to_int((struct scsi_lun *)&a->u.isp24.fcp_cmnd.lun);\n\n\tif (sess == NULL || sess->deleted)\n\t\treturn -EFAULT;\n\n\treturn qlt_issue_task_mgmt(sess, unpacked_lun, fn, iocb, 0);\n}\n\n/* ha->hardware_lock supposed to be held on entry */\nstatic int __qlt_abort_task(struct scsi_qla_host *vha,\n\tstruct imm_ntfy_from_isp *iocb, struct fc_port *sess)\n{\n\tstruct atio_from_isp *a = (struct atio_from_isp *)iocb;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct qla_tgt_mgmt_cmd *mcmd;\n\tu64 unpacked_lun;\n\tint rc;\n\n\tmcmd = mempool_alloc(qla_tgt_mgmt_cmd_mempool, GFP_ATOMIC);\n\tif (mcmd == NULL) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf05f,\n\t\t    \"qla_target(%d): %s: Allocation of ABORT cmd failed\\n\",\n\t\t    vha->vp_idx, __func__);\n\t\treturn -ENOMEM;\n\t}\n\tmemset(mcmd, 0, sizeof(*mcmd));\n\n\tmcmd->sess = sess;\n\tmemcpy(&mcmd->orig_iocb.imm_ntfy, iocb,\n\t    sizeof(mcmd->orig_iocb.imm_ntfy));\n\n\tunpacked_lun =\n\t    scsilun_to_int((struct scsi_lun *)&a->u.isp24.fcp_cmnd.lun);\n\tmcmd->reset_count = ha->base_qpair->chip_reset;\n\tmcmd->tmr_func = QLA_TGT_2G_ABORT_TASK;\n\tmcmd->qpair = ha->base_qpair;\n\n\trc = ha->tgt.tgt_ops->handle_tmr(mcmd, unpacked_lun, mcmd->tmr_func,\n\t    le16_to_cpu(iocb->u.isp2x.seq_id));\n\tif (rc != 0) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf060,\n\t\t    \"qla_target(%d): tgt_ops->handle_tmr() failed: %d\\n\",\n\t\t    vha->vp_idx, rc);\n\t\tmempool_free(mcmd, qla_tgt_mgmt_cmd_mempool);\n\t\treturn -EFAULT;\n\t}\n\n\treturn 0;\n}\n\n/* ha->hardware_lock supposed to be held on entry */\nstatic int qlt_abort_task(struct scsi_qla_host *vha,\n\tstruct imm_ntfy_from_isp *iocb)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct fc_port *sess;\n\tint loop_id;\n\tunsigned long flags;\n\n\tloop_id = GET_TARGET_ID(ha, (struct atio_from_isp *)iocb);\n\n\tspin_lock_irqsave(&ha->tgt.sess_lock, flags);\n\tsess = ha->tgt.tgt_ops->find_sess_by_loop_id(vha, loop_id);\n\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\n\n\tif (sess == NULL) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf025,\n\t\t    \"qla_target(%d): task abort for unexisting \"\n\t\t    \"session\\n\", vha->vp_idx);\n\t\treturn qlt_sched_sess_work(vha->vha_tgt.qla_tgt,\n\t\t    QLA_TGT_SESS_WORK_ABORT, iocb, sizeof(*iocb));\n\t}\n\n\treturn __qlt_abort_task(vha, iocb, sess);\n}\n\nvoid qlt_logo_completion_handler(fc_port_t *fcport, int rc)\n{\n\tif (rc != MBS_COMMAND_COMPLETE) {\n\t\tql_dbg(ql_dbg_tgt_mgt, fcport->vha, 0xf093,\n\t\t\t\"%s: se_sess %p / sess %p from\"\n\t\t\t\" port %8phC loop_id %#04x s_id %02x:%02x:%02x\"\n\t\t\t\" LOGO failed: %#x\\n\",\n\t\t\t__func__,\n\t\t\tfcport->se_sess,\n\t\t\tfcport,\n\t\t\tfcport->port_name, fcport->loop_id,\n\t\t\tfcport->d_id.b.domain, fcport->d_id.b.area,\n\t\t\tfcport->d_id.b.al_pa, rc);\n\t}\n\n\tfcport->logout_completed = 1;\n}\n\n/*\n* ha->hardware_lock supposed to be held on entry (to protect tgt->sess_list)\n*\n* Schedules sessions with matching port_id/loop_id but different wwn for\n* deletion. Returns existing session with matching wwn if present.\n* Null otherwise.\n*/\nstruct fc_port *\nqlt_find_sess_invalidate_other(scsi_qla_host_t *vha, uint64_t wwn,\n    port_id_t port_id, uint16_t loop_id, struct fc_port **conflict_sess)\n{\n\tstruct fc_port *sess = NULL, *other_sess;\n\tuint64_t other_wwn;\n\n\t*conflict_sess = NULL;\n\n\tlist_for_each_entry(other_sess, &vha->vp_fcports, list) {\n\n\t\tother_wwn = wwn_to_u64(other_sess->port_name);\n\n\t\tif (wwn == other_wwn) {\n\t\t\tWARN_ON(sess);\n\t\t\tsess = other_sess;\n\t\t\tcontinue;\n\t\t}\n\n\t\t/* find other sess with nport_id collision */\n\t\tif (port_id.b24 == other_sess->d_id.b24) {\n\t\t\tif (loop_id != other_sess->loop_id) {\n\t\t\t\tql_dbg(ql_dbg_disc, vha, 0x1000c,\n\t\t\t\t    \"Invalidating sess %p loop_id %d wwn %llx.\\n\",\n\t\t\t\t    other_sess, other_sess->loop_id, other_wwn);\n\n\t\t\t\t/*\n\t\t\t\t * logout_on_delete is set by default, but another\n\t\t\t\t * session that has the same s_id/loop_id combo\n\t\t\t\t * might have cleared it when requested this session\n\t\t\t\t * deletion, so don't touch it\n\t\t\t\t */\n\t\t\t\tqlt_schedule_sess_for_deletion(other_sess);\n\t\t\t} else {\n\t\t\t\t/*\n\t\t\t\t * Another wwn used to have our s_id/loop_id\n\t\t\t\t * kill the session, but don't free the loop_id\n\t\t\t\t */\n\t\t\t\tql_dbg(ql_dbg_disc, vha, 0xf01b,\n\t\t\t\t    \"Invalidating sess %p loop_id %d wwn %llx.\\n\",\n\t\t\t\t    other_sess, other_sess->loop_id, other_wwn);\n\n\t\t\t\tother_sess->keep_nport_handle = 1;\n\t\t\t\tif (other_sess->disc_state != DSC_DELETED)\n\t\t\t\t\t*conflict_sess = other_sess;\n\t\t\t\tqlt_schedule_sess_for_deletion(other_sess);\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\n\t\t/* find other sess with nport handle collision */\n\t\tif ((loop_id == other_sess->loop_id) &&\n\t\t\t(loop_id != FC_NO_LOOP_ID)) {\n\t\t\tql_dbg(ql_dbg_disc, vha, 0x1000d,\n\t\t\t       \"Invalidating sess %p loop_id %d wwn %llx.\\n\",\n\t\t\t       other_sess, other_sess->loop_id, other_wwn);\n\n\t\t\t/* Same loop_id but different s_id\n\t\t\t * Ok to kill and logout */\n\t\t\tqlt_schedule_sess_for_deletion(other_sess);\n\t\t}\n\t}\n\n\treturn sess;\n}\n\n/* Abort any commands for this s_id waiting on qla_tgt_wq workqueue */\nstatic int abort_cmds_for_s_id(struct scsi_qla_host *vha, port_id_t *s_id)\n{\n\tstruct qla_tgt_sess_op *op;\n\tstruct qla_tgt_cmd *cmd;\n\tuint32_t key;\n\tint count = 0;\n\tunsigned long flags;\n\n\tkey = (((u32)s_id->b.domain << 16) |\n\t       ((u32)s_id->b.area   <<  8) |\n\t       ((u32)s_id->b.al_pa));\n\n\tspin_lock_irqsave(&vha->cmd_list_lock, flags);\n\tlist_for_each_entry(op, &vha->qla_sess_op_cmd_list, cmd_list) {\n\t\tuint32_t op_key = sid_to_key(op->atio.u.isp24.fcp_hdr.s_id);\n\n\t\tif (op_key == key) {\n\t\t\top->aborted = true;\n\t\t\tcount++;\n\t\t}\n\t}\n\n\tlist_for_each_entry(op, &vha->unknown_atio_list, cmd_list) {\n\t\tuint32_t op_key = sid_to_key(op->atio.u.isp24.fcp_hdr.s_id);\n\n\t\tif (op_key == key) {\n\t\t\top->aborted = true;\n\t\t\tcount++;\n\t\t}\n\t}\n\n\tlist_for_each_entry(cmd, &vha->qla_cmd_list, cmd_list) {\n\t\tuint32_t cmd_key = sid_to_key(cmd->atio.u.isp24.fcp_hdr.s_id);\n\n\t\tif (cmd_key == key) {\n\t\t\tcmd->aborted = 1;\n\t\t\tcount++;\n\t\t}\n\t}\n\tspin_unlock_irqrestore(&vha->cmd_list_lock, flags);\n\n\treturn count;\n}\n\nstatic int qlt_handle_login(struct scsi_qla_host *vha,\n    struct imm_ntfy_from_isp *iocb)\n{\n\tstruct fc_port *sess = NULL, *conflict_sess = NULL;\n\tuint64_t wwn;\n\tport_id_t port_id;\n\tuint16_t loop_id, wd3_lo;\n\tint res = 0;\n\tstruct qlt_plogi_ack_t *pla;\n\tunsigned long flags;\n\n\tlockdep_assert_held(&vha->hw->hardware_lock);\n\n\twwn = wwn_to_u64(iocb->u.isp24.port_name);\n\n\tport_id.b.domain = iocb->u.isp24.port_id[2];\n\tport_id.b.area   = iocb->u.isp24.port_id[1];\n\tport_id.b.al_pa  = iocb->u.isp24.port_id[0];\n\tport_id.b.rsvd_1 = 0;\n\n\tloop_id = le16_to_cpu(iocb->u.isp24.nport_handle);\n\n\t/* Mark all stale commands sitting in qla_tgt_wq for deletion */\n\tabort_cmds_for_s_id(vha, &port_id);\n\n\tif (wwn) {\n\t\tspin_lock_irqsave(&vha->hw->tgt.sess_lock, flags);\n\t\tsess = qlt_find_sess_invalidate_other(vha, wwn,\n\t\t    port_id, loop_id, &conflict_sess);\n\t\tspin_unlock_irqrestore(&vha->hw->tgt.sess_lock, flags);\n\t} else {\n\t\tql_dbg(ql_dbg_disc, vha, 0xffff,\n\t\t    \"%s %d Term INOT due to WWN=0 lid=%d, NportID %06X \",\n\t\t    __func__, __LINE__, loop_id, port_id.b24);\n\t\tqlt_send_term_imm_notif(vha, iocb, 1);\n\t\tgoto out;\n\t}\n\n\tif (IS_SW_RESV_ADDR(port_id)) {\n\t\tres = 1;\n\t\tgoto out;\n\t}\n\n\tpla = qlt_plogi_ack_find_add(vha, &port_id, iocb);\n\tif (!pla) {\n\t\tql_dbg(ql_dbg_disc + ql_dbg_verbose, vha, 0xffff,\n\t\t    \"%s %d %8phC Term INOT due to mem alloc fail\",\n\t\t    __func__, __LINE__,\n\t\t    iocb->u.isp24.port_name);\n\t\tqlt_send_term_imm_notif(vha, iocb, 1);\n\t\tgoto out;\n\t}\n\n\tif (conflict_sess) {\n\t\tconflict_sess->login_gen++;\n\t\tqlt_plogi_ack_link(vha, pla, conflict_sess,\n\t\t    QLT_PLOGI_LINK_CONFLICT);\n\t}\n\n\tif (!sess) {\n\t\tpla->ref_count++;\n\t\tql_dbg(ql_dbg_disc, vha, 0xffff,\n\t\t    \"%s %d %8phC post new sess\\n\",\n\t\t    __func__, __LINE__, iocb->u.isp24.port_name);\n\t\tif (iocb->u.isp24.status_subcode == ELS_PLOGI)\n\t\t\tqla24xx_post_newsess_work(vha, &port_id,\n\t\t\t    iocb->u.isp24.port_name,\n\t\t\t    iocb->u.isp24.u.plogi.node_name,\n\t\t\t    pla, 0);\n\t\telse\n\t\t\tqla24xx_post_newsess_work(vha, &port_id,\n\t\t\t    iocb->u.isp24.port_name, NULL,\n\t\t\t    pla, 0);\n\n\t\tgoto out;\n\t}\n\n\tif (sess->disc_state == DSC_UPD_FCPORT) {\n\t\tu16 sec;\n\n\t\t/*\n\t\t * Remote port registration is still going on from\n\t\t * previous login. Allow it to finish before we\n\t\t * accept the new login.\n\t\t */\n\t\tsess->next_disc_state = DSC_DELETE_PEND;\n\t\tsec = jiffies_to_msecs(jiffies -\n\t\t    sess->jiffies_at_registration) / 1000;\n\t\tif (sess->sec_since_registration < sec && sec &&\n\t\t    !(sec % 5)) {\n\t\t\tsess->sec_since_registration = sec;\n\t\t\tql_dbg(ql_dbg_disc, vha, 0xffff,\n\t\t\t    \"%s %8phC - Slow Rport registration (%d Sec)\\n\",\n\t\t\t    __func__, sess->port_name, sec);\n\t\t}\n\n\t\tif (!conflict_sess) {\n\t\t\tlist_del(&pla->list);\n\t\t\tkmem_cache_free(qla_tgt_plogi_cachep, pla);\n\t\t}\n\n\t\tqlt_send_term_imm_notif(vha, iocb, 1);\n\t\tgoto out;\n\t}\n\n\tqlt_plogi_ack_link(vha, pla, sess, QLT_PLOGI_LINK_SAME_WWN);\n\tsess->d_id = port_id;\n\tsess->login_gen++;\n\n\tif (iocb->u.isp24.status_subcode == ELS_PRLI) {\n\t\tsess->fw_login_state = DSC_LS_PRLI_PEND;\n\t\tsess->local = 0;\n\t\tsess->loop_id = loop_id;\n\t\tsess->d_id = port_id;\n\t\tsess->fw_login_state = DSC_LS_PRLI_PEND;\n\t\twd3_lo = le16_to_cpu(iocb->u.isp24.u.prli.wd3_lo);\n\n\t\tif (wd3_lo & BIT_7)\n\t\t\tsess->conf_compl_supported = 1;\n\n\t\tif ((wd3_lo & BIT_4) == 0)\n\t\t\tsess->port_type = FCT_INITIATOR;\n\t\telse\n\t\t\tsess->port_type = FCT_TARGET;\n\n\t} else\n\t\tsess->fw_login_state = DSC_LS_PLOGI_PEND;\n\n\n\tql_dbg(ql_dbg_disc, vha, 0x20f9,\n\t    \"%s %d %8phC  DS %d\\n\",\n\t    __func__, __LINE__, sess->port_name, sess->disc_state);\n\n\tswitch (sess->disc_state) {\n\tcase DSC_DELETED:\n\tcase DSC_LOGIN_PEND:\n\t\tqlt_plogi_ack_unref(vha, pla);\n\t\tbreak;\n\n\tdefault:\n\t\t/*\n\t\t * Under normal circumstances we want to release nport handle\n\t\t * during LOGO process to avoid nport handle leaks inside FW.\n\t\t * The exception is when LOGO is done while another PLOGI with\n\t\t * the same nport handle is waiting as might be the case here.\n\t\t * Note: there is always a possibily of a race where session\n\t\t * deletion has already started for other reasons (e.g. ACL\n\t\t * removal) and now PLOGI arrives:\n\t\t * 1. if PLOGI arrived in FW after nport handle has been freed,\n\t\t *    FW must have assigned this PLOGI a new/same handle and we\n\t\t *    can proceed ACK'ing it as usual when session deletion\n\t\t *    completes.\n\t\t * 2. if PLOGI arrived in FW before LOGO with LCF_FREE_NPORT\n\t\t *    bit reached it, the handle has now been released. We'll\n\t\t *    get an error when we ACK this PLOGI. Nothing will be sent\n\t\t *    back to initiator. Initiator should eventually retry\n\t\t *    PLOGI and situation will correct itself.\n\t\t */\n\t\tsess->keep_nport_handle = ((sess->loop_id == loop_id) &&\n\t\t    (sess->d_id.b24 == port_id.b24));\n\n\t\tql_dbg(ql_dbg_disc, vha, 0x20f9,\n\t\t    \"%s %d %8phC post del sess\\n\",\n\t\t    __func__, __LINE__, sess->port_name);\n\n\n\t\tqlt_schedule_sess_for_deletion(sess);\n\t\tbreak;\n\t}\nout:\n\treturn res;\n}\n\n/*\n * ha->hardware_lock supposed to be held on entry. Might drop it, then reaquire\n */\nstatic int qlt_24xx_handle_els(struct scsi_qla_host *vha,\n\tstruct imm_ntfy_from_isp *iocb)\n{\n\tstruct qla_tgt *tgt = vha->vha_tgt.qla_tgt;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct fc_port *sess = NULL, *conflict_sess = NULL;\n\tuint64_t wwn;\n\tport_id_t port_id;\n\tuint16_t loop_id;\n\tuint16_t wd3_lo;\n\tint res = 0;\n\tunsigned long flags;\n\n\tlockdep_assert_held(&ha->hardware_lock);\n\n\twwn = wwn_to_u64(iocb->u.isp24.port_name);\n\n\tport_id.b.domain = iocb->u.isp24.port_id[2];\n\tport_id.b.area   = iocb->u.isp24.port_id[1];\n\tport_id.b.al_pa  = iocb->u.isp24.port_id[0];\n\tport_id.b.rsvd_1 = 0;\n\n\tloop_id = le16_to_cpu(iocb->u.isp24.nport_handle);\n\n\tql_dbg(ql_dbg_disc, vha, 0xf026,\n\t    \"qla_target(%d): Port ID: %02x:%02x:%02x ELS opcode: 0x%02x lid %d %8phC\\n\",\n\t    vha->vp_idx, iocb->u.isp24.port_id[2],\n\t\tiocb->u.isp24.port_id[1], iocb->u.isp24.port_id[0],\n\t\t   iocb->u.isp24.status_subcode, loop_id,\n\t\tiocb->u.isp24.port_name);\n\n\t/* res = 1 means ack at the end of thread\n\t * res = 0 means ack async/later.\n\t */\n\tswitch (iocb->u.isp24.status_subcode) {\n\tcase ELS_PLOGI:\n\t\tres = qlt_handle_login(vha, iocb);\n\t\tbreak;\n\n\tcase ELS_PRLI:\n\t\tif (N2N_TOPO(ha)) {\n\t\t\tsess = qla2x00_find_fcport_by_wwpn(vha,\n\t\t\t    iocb->u.isp24.port_name, 1);\n\n\t\t\tif (sess && sess->plogi_link[QLT_PLOGI_LINK_SAME_WWN]) {\n\t\t\t\tql_dbg(ql_dbg_disc, vha, 0xffff,\n\t\t\t\t    \"%s %d %8phC Term PRLI due to PLOGI ACK not completed\\n\",\n\t\t\t\t    __func__, __LINE__,\n\t\t\t\t    iocb->u.isp24.port_name);\n\t\t\t\tqlt_send_term_imm_notif(vha, iocb, 1);\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tres = qlt_handle_login(vha, iocb);\n\t\t\tbreak;\n\t\t}\n\n\t\tif (IS_SW_RESV_ADDR(port_id)) {\n\t\t\tres = 1;\n\t\t\tbreak;\n\t\t}\n\n\t\twd3_lo = le16_to_cpu(iocb->u.isp24.u.prli.wd3_lo);\n\n\t\tif (wwn) {\n\t\t\tspin_lock_irqsave(&tgt->ha->tgt.sess_lock, flags);\n\t\t\tsess = qlt_find_sess_invalidate_other(vha, wwn, port_id,\n\t\t\t\tloop_id, &conflict_sess);\n\t\t\tspin_unlock_irqrestore(&tgt->ha->tgt.sess_lock, flags);\n\t\t}\n\n\t\tif (conflict_sess) {\n\t\t\tswitch (conflict_sess->disc_state) {\n\t\t\tcase DSC_DELETED:\n\t\t\tcase DSC_DELETE_PEND:\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf09b,\n\t\t\t\t    \"PRLI with conflicting sess %p port %8phC\\n\",\n\t\t\t\t    conflict_sess, conflict_sess->port_name);\n\t\t\t\tconflict_sess->fw_login_state =\n\t\t\t\t    DSC_LS_PORT_UNAVAIL;\n\t\t\t\tqlt_send_term_imm_notif(vha, iocb, 1);\n\t\t\t\tres = 0;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (sess != NULL) {\n\t\t\tbool delete = false;\n\t\t\tint sec;\n\n\t\t\tspin_lock_irqsave(&tgt->ha->tgt.sess_lock, flags);\n\t\t\tswitch (sess->fw_login_state) {\n\t\t\tcase DSC_LS_PLOGI_PEND:\n\t\t\tcase DSC_LS_PLOGI_COMP:\n\t\t\tcase DSC_LS_PRLI_COMP:\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tdelete = true;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tswitch (sess->disc_state) {\n\t\t\tcase DSC_UPD_FCPORT:\n\t\t\t\tspin_unlock_irqrestore(&tgt->ha->tgt.sess_lock,\n\t\t\t\t    flags);\n\n\t\t\t\tsec = jiffies_to_msecs(jiffies -\n\t\t\t\t    sess->jiffies_at_registration)/1000;\n\t\t\t\tif (sess->sec_since_registration < sec && sec &&\n\t\t\t\t    !(sec % 5)) {\n\t\t\t\t\tsess->sec_since_registration = sec;\n\t\t\t\t\tql_dbg(ql_dbg_disc, sess->vha, 0xffff,\n\t\t\t\t\t    \"%s %8phC : Slow Rport registration(%d Sec)\\n\",\n\t\t\t\t\t    __func__, sess->port_name, sec);\n\t\t\t\t}\n\t\t\t\tqlt_send_term_imm_notif(vha, iocb, 1);\n\t\t\t\treturn 0;\n\n\t\t\tcase DSC_LOGIN_PEND:\n\t\t\tcase DSC_GPDB:\n\t\t\tcase DSC_LOGIN_COMPLETE:\n\t\t\tcase DSC_ADISC:\n\t\t\t\tdelete = false;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (delete) {\n\t\t\t\tspin_unlock_irqrestore(&tgt->ha->tgt.sess_lock,\n\t\t\t\t    flags);\n\t\t\t\t/*\n\t\t\t\t * Impatient initiator sent PRLI before last\n\t\t\t\t * PLOGI could finish. Will force him to re-try,\n\t\t\t\t * while last one finishes.\n\t\t\t\t */\n\t\t\t\tql_log(ql_log_warn, sess->vha, 0xf095,\n\t\t\t\t    \"sess %p PRLI received, before plogi ack.\\n\",\n\t\t\t\t    sess);\n\t\t\t\tqlt_send_term_imm_notif(vha, iocb, 1);\n\t\t\t\tres = 0;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t/*\n\t\t\t * This shouldn't happen under normal circumstances,\n\t\t\t * since we have deleted the old session during PLOGI\n\t\t\t */\n\t\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf096,\n\t\t\t    \"PRLI (loop_id %#04x) for existing sess %p (loop_id %#04x)\\n\",\n\t\t\t    sess->loop_id, sess, iocb->u.isp24.nport_handle);\n\n\t\t\tsess->local = 0;\n\t\t\tsess->loop_id = loop_id;\n\t\t\tsess->d_id = port_id;\n\t\t\tsess->fw_login_state = DSC_LS_PRLI_PEND;\n\n\t\t\tif (wd3_lo & BIT_7)\n\t\t\t\tsess->conf_compl_supported = 1;\n\n\t\t\tif ((wd3_lo & BIT_4) == 0)\n\t\t\t\tsess->port_type = FCT_INITIATOR;\n\t\t\telse\n\t\t\t\tsess->port_type = FCT_TARGET;\n\n\t\t\tspin_unlock_irqrestore(&tgt->ha->tgt.sess_lock, flags);\n\t\t}\n\t\tres = 1; /* send notify ack */\n\n\t\t/* Make session global (not used in fabric mode) */\n\t\tif (ha->current_topology != ISP_CFG_F) {\n\t\t\tif (sess) {\n\t\t\t\tql_dbg(ql_dbg_disc, vha, 0x20fa,\n\t\t\t\t    \"%s %d %8phC post nack\\n\",\n\t\t\t\t    __func__, __LINE__, sess->port_name);\n\t\t\t\tqla24xx_post_nack_work(vha, sess, iocb,\n\t\t\t\t\tSRB_NACK_PRLI);\n\t\t\t\tres = 0;\n\t\t\t} else {\n\t\t\t\tset_bit(LOOP_RESYNC_NEEDED, &vha->dpc_flags);\n\t\t\t\tset_bit(LOCAL_LOOP_UPDATE, &vha->dpc_flags);\n\t\t\t\tqla2xxx_wake_dpc(vha);\n\t\t\t}\n\t\t} else {\n\t\t\tif (sess) {\n\t\t\t\tql_dbg(ql_dbg_disc, vha, 0x20fb,\n\t\t\t\t    \"%s %d %8phC post nack\\n\",\n\t\t\t\t    __func__, __LINE__, sess->port_name);\n\t\t\t\tqla24xx_post_nack_work(vha, sess, iocb,\n\t\t\t\t\tSRB_NACK_PRLI);\n\t\t\t\tres = 0;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\n\tcase ELS_TPRLO:\n\t\tif (le16_to_cpu(iocb->u.isp24.flags) &\n\t\t\tNOTIFY24XX_FLAGS_GLOBAL_TPRLO) {\n\t\t\tloop_id = 0xFFFF;\n\t\t\tqlt_reset(vha, iocb, QLA_TGT_NEXUS_LOSS);\n\t\t\tres = 1;\n\t\t\tbreak;\n\t\t}\n\t\tfallthrough;\n\tcase ELS_LOGO:\n\tcase ELS_PRLO:\n\t\tspin_lock_irqsave(&ha->tgt.sess_lock, flags);\n\t\tsess = qla2x00_find_fcport_by_loopid(vha, loop_id);\n\t\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\n\n\t\tif (sess) {\n\t\t\tsess->login_gen++;\n\t\t\tsess->fw_login_state = DSC_LS_LOGO_PEND;\n\t\t\tsess->logo_ack_needed = 1;\n\t\t\tmemcpy(sess->iocb, iocb, IOCB_SIZE);\n\t\t}\n\n\t\tres = qlt_reset(vha, iocb, QLA_TGT_NEXUS_LOSS_SESS);\n\n\t\tql_dbg(ql_dbg_disc, vha, 0x20fc,\n\t\t    \"%s: logo %llx res %d sess %p \",\n\t\t    __func__, wwn, res, sess);\n\t\tif (res == 0) {\n\t\t\t/*\n\t\t\t * cmd went upper layer, look for qlt_xmit_tm_rsp()\n\t\t\t * for LOGO_ACK & sess delete\n\t\t\t */\n\t\t\tBUG_ON(!sess);\n\t\t\tres = 0;\n\t\t} else {\n\t\t\t/* cmd did not go to upper layer. */\n\t\t\tif (sess) {\n\t\t\t\tqlt_schedule_sess_for_deletion(sess);\n\t\t\t\tres = 0;\n\t\t\t}\n\t\t\t/* else logo will be ack */\n\t\t}\n\t\tbreak;\n\tcase ELS_PDISC:\n\tcase ELS_ADISC:\n\t{\n\t\tstruct qla_tgt *tgt = vha->vha_tgt.qla_tgt;\n\n\t\tif (tgt->link_reinit_iocb_pending) {\n\t\t\tqlt_send_notify_ack(ha->base_qpair,\n\t\t\t    &tgt->link_reinit_iocb, 0, 0, 0, 0, 0, 0);\n\t\t\ttgt->link_reinit_iocb_pending = 0;\n\t\t}\n\n\t\tsess = qla2x00_find_fcport_by_wwpn(vha,\n\t\t    iocb->u.isp24.port_name, 1);\n\t\tif (sess) {\n\t\t\tql_dbg(ql_dbg_disc, vha, 0x20fd,\n\t\t\t\t\"sess %p lid %d|%d DS %d LS %d\\n\",\n\t\t\t\tsess, sess->loop_id, loop_id,\n\t\t\t\tsess->disc_state, sess->fw_login_state);\n\t\t}\n\n\t\tres = 1; /* send notify ack */\n\t\tbreak;\n\t}\n\n\tcase ELS_FLOGI:\t/* should never happen */\n\tdefault:\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf061,\n\t\t    \"qla_target(%d): Unsupported ELS command %x \"\n\t\t    \"received\\n\", vha->vp_idx, iocb->u.isp24.status_subcode);\n\t\tres = qlt_reset(vha, iocb, QLA_TGT_NEXUS_LOSS_SESS);\n\t\tbreak;\n\t}\n\n\tql_dbg(ql_dbg_disc, vha, 0xf026,\n\t    \"qla_target(%d): Exit ELS opcode: 0x%02x res %d\\n\",\n\t    vha->vp_idx, iocb->u.isp24.status_subcode, res);\n\n\treturn res;\n}\n\n/*\n * ha->hardware_lock supposed to be held on entry. Might drop it, then reaquire\n */\nstatic void qlt_handle_imm_notify(struct scsi_qla_host *vha,\n\tstruct imm_ntfy_from_isp *iocb)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tuint32_t add_flags = 0;\n\tint send_notify_ack = 1;\n\tuint16_t status;\n\n\tlockdep_assert_held(&ha->hardware_lock);\n\n\tstatus = le16_to_cpu(iocb->u.isp2x.status);\n\tswitch (status) {\n\tcase IMM_NTFY_LIP_RESET:\n\t{\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf032,\n\t\t    \"qla_target(%d): LIP reset (loop %#x), subcode %x\\n\",\n\t\t    vha->vp_idx, le16_to_cpu(iocb->u.isp24.nport_handle),\n\t\t    iocb->u.isp24.status_subcode);\n\n\t\tif (qlt_reset(vha, iocb, QLA_TGT_ABORT_ALL) == 0)\n\t\t\tsend_notify_ack = 0;\n\t\tbreak;\n\t}\n\n\tcase IMM_NTFY_LIP_LINK_REINIT:\n\t{\n\t\tstruct qla_tgt *tgt = vha->vha_tgt.qla_tgt;\n\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf033,\n\t\t    \"qla_target(%d): LINK REINIT (loop %#x, \"\n\t\t    \"subcode %x)\\n\", vha->vp_idx,\n\t\t    le16_to_cpu(iocb->u.isp24.nport_handle),\n\t\t    iocb->u.isp24.status_subcode);\n\t\tif (tgt->link_reinit_iocb_pending) {\n\t\t\tqlt_send_notify_ack(ha->base_qpair,\n\t\t\t    &tgt->link_reinit_iocb, 0, 0, 0, 0, 0, 0);\n\t\t}\n\t\tmemcpy(&tgt->link_reinit_iocb, iocb, sizeof(*iocb));\n\t\ttgt->link_reinit_iocb_pending = 1;\n\t\t/*\n\t\t * QLogic requires to wait after LINK REINIT for possible\n\t\t * PDISC or ADISC ELS commands\n\t\t */\n\t\tsend_notify_ack = 0;\n\t\tbreak;\n\t}\n\n\tcase IMM_NTFY_PORT_LOGOUT:\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf034,\n\t\t    \"qla_target(%d): Port logout (loop \"\n\t\t    \"%#x, subcode %x)\\n\", vha->vp_idx,\n\t\t    le16_to_cpu(iocb->u.isp24.nport_handle),\n\t\t    iocb->u.isp24.status_subcode);\n\n\t\tif (qlt_reset(vha, iocb, QLA_TGT_NEXUS_LOSS_SESS) == 0)\n\t\t\tsend_notify_ack = 0;\n\t\t/* The sessions will be cleared in the callback, if needed */\n\t\tbreak;\n\n\tcase IMM_NTFY_GLBL_TPRLO:\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf035,\n\t\t    \"qla_target(%d): Global TPRLO (%x)\\n\", vha->vp_idx, status);\n\t\tif (qlt_reset(vha, iocb, QLA_TGT_NEXUS_LOSS) == 0)\n\t\t\tsend_notify_ack = 0;\n\t\t/* The sessions will be cleared in the callback, if needed */\n\t\tbreak;\n\n\tcase IMM_NTFY_PORT_CONFIG:\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf036,\n\t\t    \"qla_target(%d): Port config changed (%x)\\n\", vha->vp_idx,\n\t\t    status);\n\t\tif (qlt_reset(vha, iocb, QLA_TGT_ABORT_ALL) == 0)\n\t\t\tsend_notify_ack = 0;\n\t\t/* The sessions will be cleared in the callback, if needed */\n\t\tbreak;\n\n\tcase IMM_NTFY_GLBL_LOGO:\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf06a,\n\t\t    \"qla_target(%d): Link failure detected\\n\",\n\t\t    vha->vp_idx);\n\t\t/* I_T nexus loss */\n\t\tif (qlt_reset(vha, iocb, QLA_TGT_NEXUS_LOSS) == 0)\n\t\t\tsend_notify_ack = 0;\n\t\tbreak;\n\n\tcase IMM_NTFY_IOCB_OVERFLOW:\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf06b,\n\t\t    \"qla_target(%d): Cannot provide requested \"\n\t\t    \"capability (IOCB overflowed the immediate notify \"\n\t\t    \"resource count)\\n\", vha->vp_idx);\n\t\tbreak;\n\n\tcase IMM_NTFY_ABORT_TASK:\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf037,\n\t\t    \"qla_target(%d): Abort Task (S %08x I %#x -> \"\n\t\t    \"L %#x)\\n\", vha->vp_idx,\n\t\t    le16_to_cpu(iocb->u.isp2x.seq_id),\n\t\t    GET_TARGET_ID(ha, (struct atio_from_isp *)iocb),\n\t\t    le16_to_cpu(iocb->u.isp2x.lun));\n\t\tif (qlt_abort_task(vha, iocb) == 0)\n\t\t\tsend_notify_ack = 0;\n\t\tbreak;\n\n\tcase IMM_NTFY_RESOURCE:\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf06c,\n\t\t    \"qla_target(%d): Out of resources, host %ld\\n\",\n\t\t    vha->vp_idx, vha->host_no);\n\t\tbreak;\n\n\tcase IMM_NTFY_MSG_RX:\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf038,\n\t\t    \"qla_target(%d): Immediate notify task %x\\n\",\n\t\t    vha->vp_idx, iocb->u.isp2x.task_flags);\n\t\tbreak;\n\n\tcase IMM_NTFY_ELS:\n\t\tif (qlt_24xx_handle_els(vha, iocb) == 0)\n\t\t\tsend_notify_ack = 0;\n\t\tbreak;\n\tdefault:\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf06d,\n\t\t    \"qla_target(%d): Received unknown immediate \"\n\t\t    \"notify status %x\\n\", vha->vp_idx, status);\n\t\tbreak;\n\t}\n\n\tif (send_notify_ack)\n\t\tqlt_send_notify_ack(ha->base_qpair, iocb, add_flags, 0, 0, 0,\n\t\t    0, 0);\n}\n\n/*\n * ha->hardware_lock supposed to be held on entry. Might drop it, then reaquire\n * This function sends busy to ISP 2xxx or 24xx.\n */\nstatic int __qlt_send_busy(struct qla_qpair *qpair,\n\tstruct atio_from_isp *atio, uint16_t status)\n{\n\tstruct scsi_qla_host *vha = qpair->vha;\n\tstruct ctio7_to_24xx *ctio24;\n\tstruct qla_hw_data *ha = vha->hw;\n\trequest_t *pkt;\n\tstruct fc_port *sess = NULL;\n\tunsigned long flags;\n\tu16 temp;\n\tport_id_t id;\n\n\tid = be_to_port_id(atio->u.isp24.fcp_hdr.s_id);\n\n\tspin_lock_irqsave(&ha->tgt.sess_lock, flags);\n\tsess = qla2x00_find_fcport_by_nportid(vha, &id, 1);\n\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\n\tif (!sess) {\n\t\tqlt_send_term_exchange(qpair, NULL, atio, 1, 0);\n\t\treturn 0;\n\t}\n\t/* Sending marker isn't necessary, since we called from ISR */\n\n\tpkt = (request_t *)__qla2x00_alloc_iocbs(qpair, NULL);\n\tif (!pkt) {\n\t\tql_dbg(ql_dbg_io, vha, 0x3063,\n\t\t    \"qla_target(%d): %s failed: unable to allocate \"\n\t\t    \"request packet\", vha->vp_idx, __func__);\n\t\treturn -ENOMEM;\n\t}\n\n\tqpair->tgt_counters.num_q_full_sent++;\n\tpkt->entry_count = 1;\n\tpkt->handle = QLA_TGT_SKIP_HANDLE | CTIO_COMPLETION_HANDLE_MARK;\n\n\tctio24 = (struct ctio7_to_24xx *)pkt;\n\tctio24->entry_type = CTIO_TYPE7;\n\tctio24->nport_handle = cpu_to_le16(sess->loop_id);\n\tctio24->timeout = cpu_to_le16(QLA_TGT_TIMEOUT);\n\tctio24->vp_index = vha->vp_idx;\n\tctio24->initiator_id = be_id_to_le(atio->u.isp24.fcp_hdr.s_id);\n\tctio24->exchange_addr = atio->u.isp24.exchange_addr;\n\ttemp = (atio->u.isp24.attr << 9) |\n\t\tCTIO7_FLAGS_STATUS_MODE_1 | CTIO7_FLAGS_SEND_STATUS |\n\t\tCTIO7_FLAGS_DONT_RET_CTIO;\n\tctio24->u.status1.flags = cpu_to_le16(temp);\n\t/*\n\t * CTIO from fw w/o se_cmd doesn't provide enough info to retry it,\n\t * if the explicit conformation is used.\n\t */\n\tctio24->u.status1.ox_id =\n\t\tcpu_to_le16(be16_to_cpu(atio->u.isp24.fcp_hdr.ox_id));\n\tctio24->u.status1.scsi_status = cpu_to_le16(status);\n\n\tctio24->u.status1.residual = cpu_to_le32(get_datalen_for_atio(atio));\n\n\tif (ctio24->u.status1.residual != 0)\n\t\tctio24->u.status1.scsi_status |= cpu_to_le16(SS_RESIDUAL_UNDER);\n\n\t/* Memory Barrier */\n\twmb();\n\tif (qpair->reqq_start_iocbs)\n\t\tqpair->reqq_start_iocbs(qpair);\n\telse\n\t\tqla2x00_start_iocbs(vha, qpair->req);\n\treturn 0;\n}\n\n/*\n * This routine is used to allocate a command for either a QFull condition\n * (ie reply SAM_STAT_BUSY) or to terminate an exchange that did not go\n * out previously.\n */\nstatic void\nqlt_alloc_qfull_cmd(struct scsi_qla_host *vha,\n\tstruct atio_from_isp *atio, uint16_t status, int qfull)\n{\n\tstruct qla_tgt *tgt = vha->vha_tgt.qla_tgt;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct fc_port *sess;\n\tstruct qla_tgt_cmd *cmd;\n\tunsigned long flags;\n\n\tif (unlikely(tgt->tgt_stop)) {\n\t\tql_dbg(ql_dbg_io, vha, 0x300a,\n\t\t\t\"New command while device %p is shutting down\\n\", tgt);\n\t\treturn;\n\t}\n\n\tif ((vha->hw->tgt.num_qfull_cmds_alloc + 1) > MAX_QFULL_CMDS_ALLOC) {\n\t\tvha->hw->tgt.num_qfull_cmds_dropped++;\n\t\tif (vha->hw->tgt.num_qfull_cmds_dropped >\n\t\t\tvha->qla_stats.stat_max_qfull_cmds_dropped)\n\t\t\tvha->qla_stats.stat_max_qfull_cmds_dropped =\n\t\t\t\tvha->hw->tgt.num_qfull_cmds_dropped;\n\n\t\tql_dbg(ql_dbg_io, vha, 0x3068,\n\t\t\t\"qla_target(%d): %s: QFull CMD dropped[%d]\\n\",\n\t\t\tvha->vp_idx, __func__,\n\t\t\tvha->hw->tgt.num_qfull_cmds_dropped);\n\n\t\tqlt_chk_exch_leak_thresh_hold(vha);\n\t\treturn;\n\t}\n\n\tsess = ha->tgt.tgt_ops->find_sess_by_s_id\n\t\t(vha, atio->u.isp24.fcp_hdr.s_id);\n\tif (!sess)\n\t\treturn;\n\n\tcmd = ha->tgt.tgt_ops->get_cmd(sess);\n\tif (!cmd) {\n\t\tql_dbg(ql_dbg_io, vha, 0x3009,\n\t\t\t\"qla_target(%d): %s: Allocation of cmd failed\\n\",\n\t\t\tvha->vp_idx, __func__);\n\n\t\tvha->hw->tgt.num_qfull_cmds_dropped++;\n\t\tif (vha->hw->tgt.num_qfull_cmds_dropped >\n\t\t\tvha->qla_stats.stat_max_qfull_cmds_dropped)\n\t\t\tvha->qla_stats.stat_max_qfull_cmds_dropped =\n\t\t\t\tvha->hw->tgt.num_qfull_cmds_dropped;\n\n\t\tqlt_chk_exch_leak_thresh_hold(vha);\n\t\treturn;\n\t}\n\n\tqlt_incr_num_pend_cmds(vha);\n\tINIT_LIST_HEAD(&cmd->cmd_list);\n\tmemcpy(&cmd->atio, atio, sizeof(*atio));\n\n\tcmd->tgt = vha->vha_tgt.qla_tgt;\n\tcmd->vha = vha;\n\tcmd->reset_count = ha->base_qpair->chip_reset;\n\tcmd->q_full = 1;\n\tcmd->qpair = ha->base_qpair;\n\n\tif (qfull) {\n\t\tcmd->q_full = 1;\n\t\t/* NOTE: borrowing the state field to carry the status */\n\t\tcmd->state = status;\n\t} else\n\t\tcmd->term_exchg = 1;\n\n\tspin_lock_irqsave(&vha->hw->tgt.q_full_lock, flags);\n\tlist_add_tail(&cmd->cmd_list, &vha->hw->tgt.q_full_list);\n\n\tvha->hw->tgt.num_qfull_cmds_alloc++;\n\tif (vha->hw->tgt.num_qfull_cmds_alloc >\n\t\tvha->qla_stats.stat_max_qfull_cmds_alloc)\n\t\tvha->qla_stats.stat_max_qfull_cmds_alloc =\n\t\t\tvha->hw->tgt.num_qfull_cmds_alloc;\n\tspin_unlock_irqrestore(&vha->hw->tgt.q_full_lock, flags);\n}\n\nint\nqlt_free_qfull_cmds(struct qla_qpair *qpair)\n{\n\tstruct scsi_qla_host *vha = qpair->vha;\n\tstruct qla_hw_data *ha = vha->hw;\n\tunsigned long flags;\n\tstruct qla_tgt_cmd *cmd, *tcmd;\n\tstruct list_head free_list, q_full_list;\n\tint rc = 0;\n\n\tif (list_empty(&ha->tgt.q_full_list))\n\t\treturn 0;\n\n\tINIT_LIST_HEAD(&free_list);\n\tINIT_LIST_HEAD(&q_full_list);\n\n\tspin_lock_irqsave(&vha->hw->tgt.q_full_lock, flags);\n\tif (list_empty(&ha->tgt.q_full_list)) {\n\t\tspin_unlock_irqrestore(&vha->hw->tgt.q_full_lock, flags);\n\t\treturn 0;\n\t}\n\n\tlist_splice_init(&vha->hw->tgt.q_full_list, &q_full_list);\n\tspin_unlock_irqrestore(&vha->hw->tgt.q_full_lock, flags);\n\n\tspin_lock_irqsave(qpair->qp_lock_ptr, flags);\n\tlist_for_each_entry_safe(cmd, tcmd, &q_full_list, cmd_list) {\n\t\tif (cmd->q_full)\n\t\t\t/* cmd->state is a borrowed field to hold status */\n\t\t\trc = __qlt_send_busy(qpair, &cmd->atio, cmd->state);\n\t\telse if (cmd->term_exchg)\n\t\t\trc = __qlt_send_term_exchange(qpair, NULL, &cmd->atio);\n\n\t\tif (rc == -ENOMEM)\n\t\t\tbreak;\n\n\t\tif (cmd->q_full)\n\t\t\tql_dbg(ql_dbg_io, vha, 0x3006,\n\t\t\t    \"%s: busy sent for ox_id[%04x]\\n\", __func__,\n\t\t\t    be16_to_cpu(cmd->atio.u.isp24.fcp_hdr.ox_id));\n\t\telse if (cmd->term_exchg)\n\t\t\tql_dbg(ql_dbg_io, vha, 0x3007,\n\t\t\t    \"%s: Term exchg sent for ox_id[%04x]\\n\", __func__,\n\t\t\t    be16_to_cpu(cmd->atio.u.isp24.fcp_hdr.ox_id));\n\t\telse\n\t\t\tql_dbg(ql_dbg_io, vha, 0x3008,\n\t\t\t    \"%s: Unexpected cmd in QFull list %p\\n\", __func__,\n\t\t\t    cmd);\n\n\t\tlist_del(&cmd->cmd_list);\n\t\tlist_add_tail(&cmd->cmd_list, &free_list);\n\n\t\t/* piggy back on hardware_lock for protection */\n\t\tvha->hw->tgt.num_qfull_cmds_alloc--;\n\t}\n\tspin_unlock_irqrestore(qpair->qp_lock_ptr, flags);\n\n\tcmd = NULL;\n\n\tlist_for_each_entry_safe(cmd, tcmd, &free_list, cmd_list) {\n\t\tlist_del(&cmd->cmd_list);\n\t\t/* This cmd was never sent to TCM.  There is no need\n\t\t * to schedule free or call free_cmd\n\t\t */\n\t\tqlt_free_cmd(cmd);\n\t}\n\n\tif (!list_empty(&q_full_list)) {\n\t\tspin_lock_irqsave(&vha->hw->tgt.q_full_lock, flags);\n\t\tlist_splice(&q_full_list, &vha->hw->tgt.q_full_list);\n\t\tspin_unlock_irqrestore(&vha->hw->tgt.q_full_lock, flags);\n\t}\n\n\treturn rc;\n}\n\nstatic void\nqlt_send_busy(struct qla_qpair *qpair, struct atio_from_isp *atio,\n    uint16_t status)\n{\n\tint rc = 0;\n\tstruct scsi_qla_host *vha = qpair->vha;\n\n\trc = __qlt_send_busy(qpair, atio, status);\n\tif (rc == -ENOMEM)\n\t\tqlt_alloc_qfull_cmd(vha, atio, status, 1);\n}\n\nstatic int\nqlt_chk_qfull_thresh_hold(struct scsi_qla_host *vha, struct qla_qpair *qpair,\n\tstruct atio_from_isp *atio, uint8_t ha_locked)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tunsigned long flags;\n\n\tif (ha->tgt.num_pend_cmds < Q_FULL_THRESH_HOLD(ha))\n\t\treturn 0;\n\n\tif (!ha_locked)\n\t\tspin_lock_irqsave(&ha->hardware_lock, flags);\n\tqlt_send_busy(qpair, atio, qla_sam_status);\n\tif (!ha_locked)\n\t\tspin_unlock_irqrestore(&ha->hardware_lock, flags);\n\n\treturn 1;\n}\n\n/* ha->hardware_lock supposed to be held on entry */\n/* called via callback from qla2xxx */\nstatic void qlt_24xx_atio_pkt(struct scsi_qla_host *vha,\n\tstruct atio_from_isp *atio, uint8_t ha_locked)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct qla_tgt *tgt = vha->vha_tgt.qla_tgt;\n\tint rc;\n\tunsigned long flags = 0;\n\n\tif (unlikely(tgt == NULL)) {\n\t\tql_dbg(ql_dbg_tgt, vha, 0x3064,\n\t\t    \"ATIO pkt, but no tgt (ha %p)\", ha);\n\t\treturn;\n\t}\n\t/*\n\t * In tgt_stop mode we also should allow all requests to pass.\n\t * Otherwise, some commands can stuck.\n\t */\n\n\ttgt->atio_irq_cmd_count++;\n\n\tswitch (atio->u.raw.entry_type) {\n\tcase ATIO_TYPE7:\n\t\tif (unlikely(atio->u.isp24.exchange_addr ==\n\t\t\t     cpu_to_le32(ATIO_EXCHANGE_ADDRESS_UNKNOWN))) {\n\t\t\tql_dbg(ql_dbg_io, vha, 0x3065,\n\t\t\t    \"qla_target(%d): ATIO_TYPE7 \"\n\t\t\t    \"received with UNKNOWN exchange address, \"\n\t\t\t    \"sending QUEUE_FULL\\n\", vha->vp_idx);\n\t\t\tif (!ha_locked)\n\t\t\t\tspin_lock_irqsave(&ha->hardware_lock, flags);\n\t\t\tqlt_send_busy(ha->base_qpair, atio, qla_sam_status);\n\t\t\tif (!ha_locked)\n\t\t\t\tspin_unlock_irqrestore(&ha->hardware_lock,\n\t\t\t\t    flags);\n\t\t\tbreak;\n\t\t}\n\n\t\tif (likely(atio->u.isp24.fcp_cmnd.task_mgmt_flags == 0)) {\n\t\t\trc = qlt_chk_qfull_thresh_hold(vha, ha->base_qpair,\n\t\t\t    atio, ha_locked);\n\t\t\tif (rc != 0) {\n\t\t\t\ttgt->atio_irq_cmd_count--;\n\t\t\t\treturn;\n\t\t\t}\n\t\t\trc = qlt_handle_cmd_for_atio(vha, atio);\n\t\t} else {\n\t\t\trc = qlt_handle_task_mgmt(vha, atio);\n\t\t}\n\t\tif (unlikely(rc != 0)) {\n\t\t\tif (!ha_locked)\n\t\t\t\tspin_lock_irqsave(&ha->hardware_lock, flags);\n\t\t\tswitch (rc) {\n\t\t\tcase -ENODEV:\n\t\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe05f,\n\t\t\t\t    \"qla_target: Unable to send command to target\\n\");\n\t\t\t\tbreak;\n\t\t\tcase -EBADF:\n\t\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe05f,\n\t\t\t\t    \"qla_target: Unable to send command to target, sending TERM EXCHANGE for rsp\\n\");\n\t\t\t\tqlt_send_term_exchange(ha->base_qpair, NULL,\n\t\t\t\t    atio, 1, 0);\n\t\t\t\tbreak;\n\t\t\tcase -EBUSY:\n\t\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe060,\n\t\t\t\t    \"qla_target(%d): Unable to send command to target, sending BUSY status\\n\",\n\t\t\t\t    vha->vp_idx);\n\t\t\t\tqlt_send_busy(ha->base_qpair, atio,\n\t\t\t\t    tc_sam_status);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe060,\n\t\t\t\t    \"qla_target(%d): Unable to send command to target, sending BUSY status\\n\",\n\t\t\t\t    vha->vp_idx);\n\t\t\t\tqlt_send_busy(ha->base_qpair, atio,\n\t\t\t\t    qla_sam_status);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (!ha_locked)\n\t\t\t\tspin_unlock_irqrestore(&ha->hardware_lock,\n\t\t\t\t    flags);\n\t\t}\n\t\tbreak;\n\n\tcase IMMED_NOTIFY_TYPE:\n\t{\n\t\tif (unlikely(atio->u.isp2x.entry_status != 0)) {\n\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe05b,\n\t\t\t    \"qla_target(%d): Received ATIO packet %x \"\n\t\t\t    \"with error status %x\\n\", vha->vp_idx,\n\t\t\t    atio->u.raw.entry_type,\n\t\t\t    atio->u.isp2x.entry_status);\n\t\t\tbreak;\n\t\t}\n\t\tql_dbg(ql_dbg_tgt, vha, 0xe02e, \"%s\", \"IMMED_NOTIFY ATIO\");\n\n\t\tif (!ha_locked)\n\t\t\tspin_lock_irqsave(&ha->hardware_lock, flags);\n\t\tqlt_handle_imm_notify(vha, (struct imm_ntfy_from_isp *)atio);\n\t\tif (!ha_locked)\n\t\t\tspin_unlock_irqrestore(&ha->hardware_lock, flags);\n\t\tbreak;\n\t}\n\n\tdefault:\n\t\tql_dbg(ql_dbg_tgt, vha, 0xe05c,\n\t\t    \"qla_target(%d): Received unknown ATIO atio \"\n\t\t    \"type %x\\n\", vha->vp_idx, atio->u.raw.entry_type);\n\t\tbreak;\n\t}\n\n\ttgt->atio_irq_cmd_count--;\n}\n\n/*\n * qpair lock is assume to be held\n * rc = 0 : send terminate & abts respond\n * rc != 0: do not send term & abts respond\n */\nstatic int qlt_chk_unresolv_exchg(struct scsi_qla_host *vha,\n    struct qla_qpair *qpair, struct abts_resp_from_24xx_fw *entry)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tint rc = 0;\n\n\t/*\n\t * Detect unresolved exchange. If the same ABTS is unable\n\t * to terminate an existing command and the same ABTS loops\n\t * between FW & Driver, then force FW dump. Under 1 jiff,\n\t * we should see multiple loops.\n\t */\n\tif (qpair->retry_term_exchg_addr == entry->exchange_addr_to_abort &&\n\t    qpair->retry_term_jiff == jiffies) {\n\t\t/* found existing exchange */\n\t\tqpair->retry_term_cnt++;\n\t\tif (qpair->retry_term_cnt >= 5) {\n\t\t\trc = -EIO;\n\t\t\tqpair->retry_term_cnt = 0;\n\t\t\tql_log(ql_log_warn, vha, 0xffff,\n\t\t\t    \"Unable to send ABTS Respond. Dumping firmware.\\n\");\n\t\t\tql_dump_buffer(ql_dbg_tgt_mgt + ql_dbg_buffer,\n\t\t\t    vha, 0xffff, (uint8_t *)entry, sizeof(*entry));\n\n\t\t\tif (qpair == ha->base_qpair)\n\t\t\t\tha->isp_ops->fw_dump(vha);\n\t\t\telse\n\t\t\t\tqla2xxx_dump_fw(vha);\n\n\t\t\tset_bit(ISP_ABORT_NEEDED, &vha->dpc_flags);\n\t\t\tqla2xxx_wake_dpc(vha);\n\t\t}\n\t} else if (qpair->retry_term_jiff != jiffies) {\n\t\tqpair->retry_term_exchg_addr = entry->exchange_addr_to_abort;\n\t\tqpair->retry_term_cnt = 0;\n\t\tqpair->retry_term_jiff = jiffies;\n\t}\n\n\treturn rc;\n}\n\n\nstatic void qlt_handle_abts_completion(struct scsi_qla_host *vha,\n\tstruct rsp_que *rsp, response_t *pkt)\n{\n\tstruct abts_resp_from_24xx_fw *entry =\n\t\t(struct abts_resp_from_24xx_fw *)pkt;\n\tu32 h = pkt->handle & ~QLA_TGT_HANDLE_MASK;\n\tstruct qla_tgt_mgmt_cmd *mcmd;\n\tstruct qla_hw_data *ha = vha->hw;\n\n\tmcmd = qlt_ctio_to_cmd(vha, rsp, pkt->handle, pkt);\n\tif (mcmd == NULL && h != QLA_TGT_SKIP_HANDLE) {\n\t\tql_dbg(ql_dbg_async, vha, 0xe064,\n\t\t    \"qla_target(%d): ABTS Comp without mcmd\\n\",\n\t\t    vha->vp_idx);\n\t\treturn;\n\t}\n\n\tif (mcmd)\n\t\tvha  = mcmd->vha;\n\tvha->vha_tgt.qla_tgt->abts_resp_expected--;\n\n\tql_dbg(ql_dbg_tgt, vha, 0xe038,\n\t    \"ABTS_RESP_24XX: compl_status %x\\n\",\n\t    entry->compl_status);\n\n\tif (le16_to_cpu(entry->compl_status) != ABTS_RESP_COMPL_SUCCESS) {\n\t\tif (le32_to_cpu(entry->error_subcode1) == 0x1E &&\n\t\t    le32_to_cpu(entry->error_subcode2) == 0) {\n\t\t\tif (qlt_chk_unresolv_exchg(vha, rsp->qpair, entry)) {\n\t\t\t\tha->tgt.tgt_ops->free_mcmd(mcmd);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tqlt_24xx_retry_term_exchange(vha, rsp->qpair,\n\t\t\t    pkt, mcmd);\n\t\t} else {\n\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe063,\n\t\t\t    \"qla_target(%d): ABTS_RESP_24XX failed %x (subcode %x:%x)\",\n\t\t\t    vha->vp_idx, entry->compl_status,\n\t\t\t    entry->error_subcode1,\n\t\t\t    entry->error_subcode2);\n\t\t\tha->tgt.tgt_ops->free_mcmd(mcmd);\n\t\t}\n\t} else if (mcmd) {\n\t\tha->tgt.tgt_ops->free_mcmd(mcmd);\n\t}\n}\n\n/* ha->hardware_lock supposed to be held on entry */\n/* called via callback from qla2xxx */\nstatic void qlt_response_pkt(struct scsi_qla_host *vha,\n\tstruct rsp_que *rsp, response_t *pkt)\n{\n\tstruct qla_tgt *tgt = vha->vha_tgt.qla_tgt;\n\n\tif (unlikely(tgt == NULL)) {\n\t\tql_dbg(ql_dbg_tgt, vha, 0xe05d,\n\t\t    \"qla_target(%d): Response pkt %x received, but no tgt (ha %p)\\n\",\n\t\t    vha->vp_idx, pkt->entry_type, vha->hw);\n\t\treturn;\n\t}\n\n\t/*\n\t * In tgt_stop mode we also should allow all requests to pass.\n\t * Otherwise, some commands can stuck.\n\t */\n\n\tswitch (pkt->entry_type) {\n\tcase CTIO_CRC2:\n\tcase CTIO_TYPE7:\n\t{\n\t\tstruct ctio7_from_24xx *entry = (struct ctio7_from_24xx *)pkt;\n\n\t\tqlt_do_ctio_completion(vha, rsp, entry->handle,\n\t\t    le16_to_cpu(entry->status)|(pkt->entry_status << 16),\n\t\t    entry);\n\t\tbreak;\n\t}\n\n\tcase ACCEPT_TGT_IO_TYPE:\n\t{\n\t\tstruct atio_from_isp *atio = (struct atio_from_isp *)pkt;\n\t\tint rc;\n\n\t\tif (atio->u.isp2x.status !=\n\t\t    cpu_to_le16(ATIO_CDB_VALID)) {\n\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe05e,\n\t\t\t    \"qla_target(%d): ATIO with error \"\n\t\t\t    \"status %x received\\n\", vha->vp_idx,\n\t\t\t    le16_to_cpu(atio->u.isp2x.status));\n\t\t\tbreak;\n\t\t}\n\n\t\trc = qlt_chk_qfull_thresh_hold(vha, rsp->qpair, atio, 1);\n\t\tif (rc != 0)\n\t\t\treturn;\n\n\t\trc = qlt_handle_cmd_for_atio(vha, atio);\n\t\tif (unlikely(rc != 0)) {\n\t\t\tswitch (rc) {\n\t\t\tcase -ENODEV:\n\t\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe05f,\n\t\t\t\t    \"qla_target: Unable to send command to target\\n\");\n\t\t\t\tbreak;\n\t\t\tcase -EBADF:\n\t\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe05f,\n\t\t\t\t    \"qla_target: Unable to send command to target, sending TERM EXCHANGE for rsp\\n\");\n\t\t\t\tqlt_send_term_exchange(rsp->qpair, NULL,\n\t\t\t\t    atio, 1, 0);\n\t\t\t\tbreak;\n\t\t\tcase -EBUSY:\n\t\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe060,\n\t\t\t\t    \"qla_target(%d): Unable to send command to target, sending BUSY status\\n\",\n\t\t\t\t    vha->vp_idx);\n\t\t\t\tqlt_send_busy(rsp->qpair, atio,\n\t\t\t\t    tc_sam_status);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe060,\n\t\t\t\t    \"qla_target(%d): Unable to send command to target, sending BUSY status\\n\",\n\t\t\t\t    vha->vp_idx);\n\t\t\t\tqlt_send_busy(rsp->qpair, atio,\n\t\t\t\t    qla_sam_status);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\tbreak;\n\n\tcase CONTINUE_TGT_IO_TYPE:\n\t{\n\t\tstruct ctio_to_2xxx *entry = (struct ctio_to_2xxx *)pkt;\n\n\t\tqlt_do_ctio_completion(vha, rsp, entry->handle,\n\t\t    le16_to_cpu(entry->status)|(pkt->entry_status << 16),\n\t\t    entry);\n\t\tbreak;\n\t}\n\n\tcase CTIO_A64_TYPE:\n\t{\n\t\tstruct ctio_to_2xxx *entry = (struct ctio_to_2xxx *)pkt;\n\n\t\tqlt_do_ctio_completion(vha, rsp, entry->handle,\n\t\t    le16_to_cpu(entry->status)|(pkt->entry_status << 16),\n\t\t    entry);\n\t\tbreak;\n\t}\n\n\tcase IMMED_NOTIFY_TYPE:\n\t\tql_dbg(ql_dbg_tgt, vha, 0xe035, \"%s\", \"IMMED_NOTIFY\\n\");\n\t\tqlt_handle_imm_notify(vha, (struct imm_ntfy_from_isp *)pkt);\n\t\tbreak;\n\n\tcase NOTIFY_ACK_TYPE:\n\t\tif (tgt->notify_ack_expected > 0) {\n\t\t\tstruct nack_to_isp *entry = (struct nack_to_isp *)pkt;\n\n\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe036,\n\t\t\t    \"NOTIFY_ACK seq %08x status %x\\n\",\n\t\t\t    le16_to_cpu(entry->u.isp2x.seq_id),\n\t\t\t    le16_to_cpu(entry->u.isp2x.status));\n\t\t\ttgt->notify_ack_expected--;\n\t\t\tif (entry->u.isp2x.status !=\n\t\t\t    cpu_to_le16(NOTIFY_ACK_SUCCESS)) {\n\t\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe061,\n\t\t\t\t    \"qla_target(%d): NOTIFY_ACK \"\n\t\t\t\t    \"failed %x\\n\", vha->vp_idx,\n\t\t\t\t    le16_to_cpu(entry->u.isp2x.status));\n\t\t\t}\n\t\t} else {\n\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe062,\n\t\t\t    \"qla_target(%d): Unexpected NOTIFY_ACK received\\n\",\n\t\t\t    vha->vp_idx);\n\t\t}\n\t\tbreak;\n\n\tcase ABTS_RECV_24XX:\n\t\tql_dbg(ql_dbg_tgt, vha, 0xe037,\n\t\t    \"ABTS_RECV_24XX: instance %d\\n\", vha->vp_idx);\n\t\tqlt_24xx_handle_abts(vha, (struct abts_recv_from_24xx *)pkt);\n\t\tbreak;\n\n\tcase ABTS_RESP_24XX:\n\t\tif (tgt->abts_resp_expected > 0) {\n\t\t\tqlt_handle_abts_completion(vha, rsp, pkt);\n\t\t} else {\n\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe064,\n\t\t\t    \"qla_target(%d): Unexpected ABTS_RESP_24XX \"\n\t\t\t    \"received\\n\", vha->vp_idx);\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tql_dbg(ql_dbg_tgt, vha, 0xe065,\n\t\t    \"qla_target(%d): Received unknown response pkt \"\n\t\t    \"type %x\\n\", vha->vp_idx, pkt->entry_type);\n\t\tbreak;\n\t}\n\n}\n\n/*\n * ha->hardware_lock supposed to be held on entry. Might drop it, then reaquire\n */\nvoid qlt_async_event(uint16_t code, struct scsi_qla_host *vha,\n\tuint16_t *mailbox)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct qla_tgt *tgt = vha->vha_tgt.qla_tgt;\n\tint login_code;\n\n\tif (!tgt || tgt->tgt_stop || tgt->tgt_stopped)\n\t\treturn;\n\n\tif (((code == MBA_POINT_TO_POINT) || (code == MBA_CHG_IN_CONNECTION)) &&\n\t    IS_QLA2100(ha))\n\t\treturn;\n\t/*\n\t * In tgt_stop mode we also should allow all requests to pass.\n\t * Otherwise, some commands can stuck.\n\t */\n\n\n\tswitch (code) {\n\tcase MBA_RESET:\t\t\t/* Reset */\n\tcase MBA_SYSTEM_ERR:\t\t/* System Error */\n\tcase MBA_REQ_TRANSFER_ERR:\t/* Request Transfer Error */\n\tcase MBA_RSP_TRANSFER_ERR:\t/* Response Transfer Error */\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf03a,\n\t\t    \"qla_target(%d): System error async event %#x \"\n\t\t    \"occurred\", vha->vp_idx, code);\n\t\tbreak;\n\tcase MBA_WAKEUP_THRES:\t\t/* Request Queue Wake-up. */\n\t\tset_bit(ISP_ABORT_NEEDED, &vha->dpc_flags);\n\t\tbreak;\n\n\tcase MBA_LOOP_UP:\n\t{\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf03b,\n\t\t    \"qla_target(%d): Async LOOP_UP occurred \"\n\t\t    \"(m[0]=%x, m[1]=%x, m[2]=%x, m[3]=%x)\", vha->vp_idx,\n\t\t    mailbox[0], mailbox[1], mailbox[2], mailbox[3]);\n\t\tif (tgt->link_reinit_iocb_pending) {\n\t\t\tqlt_send_notify_ack(ha->base_qpair,\n\t\t\t    &tgt->link_reinit_iocb,\n\t\t\t    0, 0, 0, 0, 0, 0);\n\t\t\ttgt->link_reinit_iocb_pending = 0;\n\t\t}\n\t\tbreak;\n\t}\n\n\tcase MBA_LIP_OCCURRED:\n\tcase MBA_LOOP_DOWN:\n\tcase MBA_LIP_RESET:\n\tcase MBA_RSCN_UPDATE:\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf03c,\n\t\t    \"qla_target(%d): Async event %#x occurred \"\n\t\t    \"(m[0]=%x, m[1]=%x, m[2]=%x, m[3]=%x)\", vha->vp_idx, code,\n\t\t    mailbox[0], mailbox[1], mailbox[2], mailbox[3]);\n\t\tbreak;\n\n\tcase MBA_REJECTED_FCP_CMD:\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf017,\n\t\t    \"qla_target(%d): Async event LS_REJECT occurred (m[0]=%x, m[1]=%x, m[2]=%x, m[3]=%x)\",\n\t\t    vha->vp_idx,\n\t\t    mailbox[0], mailbox[1], mailbox[2], mailbox[3]);\n\n\t\tif (mailbox[3] == 1) {\n\t\t\t/* exchange starvation. */\n\t\t\tvha->hw->exch_starvation++;\n\t\t\tif (vha->hw->exch_starvation > 5) {\n\t\t\t\tql_log(ql_log_warn, vha, 0xd03a,\n\t\t\t\t    \"Exchange starvation-. Resetting RISC\\n\");\n\n\t\t\t\tvha->hw->exch_starvation = 0;\n\t\t\t\tif (IS_P3P_TYPE(vha->hw))\n\t\t\t\t\tset_bit(FCOE_CTX_RESET_NEEDED,\n\t\t\t\t\t    &vha->dpc_flags);\n\t\t\t\telse\n\t\t\t\t\tset_bit(ISP_ABORT_NEEDED,\n\t\t\t\t\t    &vha->dpc_flags);\n\t\t\t\tqla2xxx_wake_dpc(vha);\n\t\t\t}\n\t\t}\n\t\tbreak;\n\n\tcase MBA_PORT_UPDATE:\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf03d,\n\t\t    \"qla_target(%d): Port update async event %#x \"\n\t\t    \"occurred: updating the ports database (m[0]=%x, m[1]=%x, \"\n\t\t    \"m[2]=%x, m[3]=%x)\", vha->vp_idx, code,\n\t\t    mailbox[0], mailbox[1], mailbox[2], mailbox[3]);\n\n\t\tlogin_code = mailbox[2];\n\t\tif (login_code == 0x4) {\n\t\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf03e,\n\t\t\t    \"Async MB 2: Got PLOGI Complete\\n\");\n\t\t\tvha->hw->exch_starvation = 0;\n\t\t} else if (login_code == 0x7)\n\t\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf03f,\n\t\t\t    \"Async MB 2: Port Logged Out\\n\");\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n}\n\nstatic fc_port_t *qlt_get_port_database(struct scsi_qla_host *vha,\n\tuint16_t loop_id)\n{\n\tfc_port_t *fcport, *tfcp, *del;\n\tint rc;\n\tunsigned long flags;\n\tu8 newfcport = 0;\n\n\tfcport = qla2x00_alloc_fcport(vha, GFP_KERNEL);\n\tif (!fcport) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf06f,\n\t\t    \"qla_target(%d): Allocation of tmp FC port failed\",\n\t\t    vha->vp_idx);\n\t\treturn NULL;\n\t}\n\n\tfcport->loop_id = loop_id;\n\n\trc = qla24xx_gpdb_wait(vha, fcport, 0);\n\tif (rc != QLA_SUCCESS) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf070,\n\t\t    \"qla_target(%d): Failed to retrieve fcport \"\n\t\t    \"information -- get_port_database() returned %x \"\n\t\t    \"(loop_id=0x%04x)\", vha->vp_idx, rc, loop_id);\n\t\tkfree(fcport);\n\t\treturn NULL;\n\t}\n\n\tdel = NULL;\n\tspin_lock_irqsave(&vha->hw->tgt.sess_lock, flags);\n\ttfcp = qla2x00_find_fcport_by_wwpn(vha, fcport->port_name, 1);\n\n\tif (tfcp) {\n\t\ttfcp->d_id = fcport->d_id;\n\t\ttfcp->port_type = fcport->port_type;\n\t\ttfcp->supported_classes = fcport->supported_classes;\n\t\ttfcp->flags |= fcport->flags;\n\t\ttfcp->scan_state = QLA_FCPORT_FOUND;\n\n\t\tdel = fcport;\n\t\tfcport = tfcp;\n\t} else {\n\t\tif (vha->hw->current_topology == ISP_CFG_F)\n\t\t\tfcport->flags |= FCF_FABRIC_DEVICE;\n\n\t\tlist_add_tail(&fcport->list, &vha->vp_fcports);\n\t\tif (!IS_SW_RESV_ADDR(fcport->d_id))\n\t\t   vha->fcport_count++;\n\t\tfcport->login_gen++;\n\t\tqla2x00_set_fcport_disc_state(fcport, DSC_LOGIN_COMPLETE);\n\t\tfcport->login_succ = 1;\n\t\tnewfcport = 1;\n\t}\n\n\tfcport->deleted = 0;\n\tspin_unlock_irqrestore(&vha->hw->tgt.sess_lock, flags);\n\n\tswitch (vha->host->active_mode) {\n\tcase MODE_INITIATOR:\n\tcase MODE_DUAL:\n\t\tif (newfcport) {\n\t\t\tif (!IS_IIDMA_CAPABLE(vha->hw) || !vha->hw->flags.gpsc_supported) {\n\t\t\t\tqla24xx_sched_upd_fcport(fcport);\n\t\t\t} else {\n\t\t\t\tql_dbg(ql_dbg_disc, vha, 0x20ff,\n\t\t\t\t   \"%s %d %8phC post gpsc fcp_cnt %d\\n\",\n\t\t\t\t   __func__, __LINE__, fcport->port_name, vha->fcport_count);\n\t\t\t\tqla24xx_post_gpsc_work(vha, fcport);\n\t\t\t}\n\t\t}\n\t\tbreak;\n\n\tcase MODE_TARGET:\n\tdefault:\n\t\tbreak;\n\t}\n\tif (del)\n\t\tqla2x00_free_fcport(del);\n\n\treturn fcport;\n}\n\n/* Must be called under tgt_mutex */\nstatic struct fc_port *qlt_make_local_sess(struct scsi_qla_host *vha,\n\t\t\t\t\t   be_id_t s_id)\n{\n\tstruct fc_port *sess = NULL;\n\tfc_port_t *fcport = NULL;\n\tint rc, global_resets;\n\tuint16_t loop_id = 0;\n\n\tif (s_id.domain == 0xFF && s_id.area == 0xFC) {\n\t\t/*\n\t\t * This is Domain Controller, so it should be\n\t\t * OK to drop SCSI commands from it.\n\t\t */\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf042,\n\t\t    \"Unable to find initiator with S_ID %x:%x:%x\",\n\t\t    s_id.domain, s_id.area, s_id.al_pa);\n\t\treturn NULL;\n\t}\n\n\tmutex_lock(&vha->vha_tgt.tgt_mutex);\n\nretry:\n\tglobal_resets =\n\t    atomic_read(&vha->vha_tgt.qla_tgt->tgt_global_resets_count);\n\n\trc = qla24xx_get_loop_id(vha, s_id, &loop_id);\n\tif (rc != 0) {\n\t\tmutex_unlock(&vha->vha_tgt.tgt_mutex);\n\n\t\tql_log(ql_log_info, vha, 0xf071,\n\t\t    \"qla_target(%d): Unable to find \"\n\t\t    \"initiator with S_ID %x:%x:%x\",\n\t\t    vha->vp_idx, s_id.domain, s_id.area, s_id.al_pa);\n\n\t\tif (rc == -ENOENT) {\n\t\t\tqlt_port_logo_t logo;\n\n\t\t\tlogo.id = be_to_port_id(s_id);\n\t\t\tlogo.cmd_count = 1;\n\t\t\tqlt_send_first_logo(vha, &logo);\n\t\t}\n\n\t\treturn NULL;\n\t}\n\n\tfcport = qlt_get_port_database(vha, loop_id);\n\tif (!fcport) {\n\t\tmutex_unlock(&vha->vha_tgt.tgt_mutex);\n\t\treturn NULL;\n\t}\n\n\tif (global_resets !=\n\t    atomic_read(&vha->vha_tgt.qla_tgt->tgt_global_resets_count)) {\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf043,\n\t\t    \"qla_target(%d): global reset during session discovery \"\n\t\t    \"(counter was %d, new %d), retrying\", vha->vp_idx,\n\t\t    global_resets,\n\t\t    atomic_read(&vha->vha_tgt.\n\t\t\tqla_tgt->tgt_global_resets_count));\n\t\tgoto retry;\n\t}\n\n\tsess = qlt_create_sess(vha, fcport, true);\n\n\tmutex_unlock(&vha->vha_tgt.tgt_mutex);\n\n\treturn sess;\n}\n\nstatic void qlt_abort_work(struct qla_tgt *tgt,\n\tstruct qla_tgt_sess_work_param *prm)\n{\n\tstruct scsi_qla_host *vha = tgt->vha;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct fc_port *sess = NULL;\n\tunsigned long flags = 0, flags2 = 0;\n\tbe_id_t s_id;\n\tint rc;\n\n\tspin_lock_irqsave(&ha->tgt.sess_lock, flags2);\n\n\tif (tgt->tgt_stop)\n\t\tgoto out_term2;\n\n\ts_id = le_id_to_be(prm->abts.fcp_hdr_le.s_id);\n\n\tsess = ha->tgt.tgt_ops->find_sess_by_s_id(vha, s_id);\n\tif (!sess) {\n\t\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags2);\n\n\t\tsess = qlt_make_local_sess(vha, s_id);\n\t\t/* sess has got an extra creation ref */\n\n\t\tspin_lock_irqsave(&ha->tgt.sess_lock, flags2);\n\t\tif (!sess)\n\t\t\tgoto out_term2;\n\t} else {\n\t\tif (sess->deleted) {\n\t\t\tsess = NULL;\n\t\t\tgoto out_term2;\n\t\t}\n\n\t\tif (!kref_get_unless_zero(&sess->sess_kref)) {\n\t\t\tql_dbg(ql_dbg_tgt_tmr, vha, 0xf01c,\n\t\t\t    \"%s: kref_get fail %8phC \\n\",\n\t\t\t     __func__, sess->port_name);\n\t\t\tsess = NULL;\n\t\t\tgoto out_term2;\n\t\t}\n\t}\n\n\trc = __qlt_24xx_handle_abts(vha, &prm->abts, sess);\n\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags2);\n\n\tha->tgt.tgt_ops->put_sess(sess);\n\n\tif (rc != 0)\n\t\tgoto out_term;\n\treturn;\n\nout_term2:\n\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags2);\n\nout_term:\n\tspin_lock_irqsave(&ha->hardware_lock, flags);\n\tqlt_24xx_send_abts_resp(ha->base_qpair, &prm->abts,\n\t    FCP_TMF_REJECTED, false);\n\tspin_unlock_irqrestore(&ha->hardware_lock, flags);\n}\n\nstatic void qlt_tmr_work(struct qla_tgt *tgt,\n\tstruct qla_tgt_sess_work_param *prm)\n{\n\tstruct atio_from_isp *a = &prm->tm_iocb2;\n\tstruct scsi_qla_host *vha = tgt->vha;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct fc_port *sess;\n\tunsigned long flags;\n\tbe_id_t s_id;\n\tint rc;\n\tu64 unpacked_lun;\n\tint fn;\n\tvoid *iocb;\n\n\tspin_lock_irqsave(&ha->tgt.sess_lock, flags);\n\n\tif (tgt->tgt_stop)\n\t\tgoto out_term2;\n\n\ts_id = prm->tm_iocb2.u.isp24.fcp_hdr.s_id;\n\tsess = ha->tgt.tgt_ops->find_sess_by_s_id(vha, s_id);\n\tif (!sess) {\n\t\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\n\n\t\tsess = qlt_make_local_sess(vha, s_id);\n\t\t/* sess has got an extra creation ref */\n\n\t\tspin_lock_irqsave(&ha->tgt.sess_lock, flags);\n\t\tif (!sess)\n\t\t\tgoto out_term2;\n\t} else {\n\t\tif (sess->deleted) {\n\t\t\tgoto out_term2;\n\t\t}\n\n\t\tif (!kref_get_unless_zero(&sess->sess_kref)) {\n\t\t\tql_dbg(ql_dbg_tgt_tmr, vha, 0xf020,\n\t\t\t    \"%s: kref_get fail %8phC\\n\",\n\t\t\t     __func__, sess->port_name);\n\t\t\tgoto out_term2;\n\t\t}\n\t}\n\n\tiocb = a;\n\tfn = a->u.isp24.fcp_cmnd.task_mgmt_flags;\n\tunpacked_lun =\n\t    scsilun_to_int((struct scsi_lun *)&a->u.isp24.fcp_cmnd.lun);\n\n\trc = qlt_issue_task_mgmt(sess, unpacked_lun, fn, iocb, 0);\n\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\n\n\tha->tgt.tgt_ops->put_sess(sess);\n\n\tif (rc != 0)\n\t\tgoto out_term;\n\treturn;\n\nout_term2:\n\tspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\nout_term:\n\tqlt_send_term_exchange(ha->base_qpair, NULL, &prm->tm_iocb2, 1, 0);\n}\n\nstatic void qlt_sess_work_fn(struct work_struct *work)\n{\n\tstruct qla_tgt *tgt = container_of(work, struct qla_tgt, sess_work);\n\tstruct scsi_qla_host *vha = tgt->vha;\n\tunsigned long flags;\n\n\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf000, \"Sess work (tgt %p)\", tgt);\n\n\tspin_lock_irqsave(&tgt->sess_work_lock, flags);\n\twhile (!list_empty(&tgt->sess_works_list)) {\n\t\tstruct qla_tgt_sess_work_param *prm = list_entry(\n\t\t    tgt->sess_works_list.next, typeof(*prm),\n\t\t    sess_works_list_entry);\n\n\t\t/*\n\t\t * This work can be scheduled on several CPUs at time, so we\n\t\t * must delete the entry to eliminate double processing\n\t\t */\n\t\tlist_del(&prm->sess_works_list_entry);\n\n\t\tspin_unlock_irqrestore(&tgt->sess_work_lock, flags);\n\n\t\tswitch (prm->type) {\n\t\tcase QLA_TGT_SESS_WORK_ABORT:\n\t\t\tqlt_abort_work(tgt, prm);\n\t\t\tbreak;\n\t\tcase QLA_TGT_SESS_WORK_TM:\n\t\t\tqlt_tmr_work(tgt, prm);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tBUG_ON(1);\n\t\t\tbreak;\n\t\t}\n\n\t\tspin_lock_irqsave(&tgt->sess_work_lock, flags);\n\n\t\tkfree(prm);\n\t}\n\tspin_unlock_irqrestore(&tgt->sess_work_lock, flags);\n}\n\n/* Must be called under tgt_host_action_mutex */\nint qlt_add_target(struct qla_hw_data *ha, struct scsi_qla_host *base_vha)\n{\n\tstruct qla_tgt *tgt;\n\tint rc, i;\n\tstruct qla_qpair_hint *h;\n\n\tif (!QLA_TGT_MODE_ENABLED())\n\t\treturn 0;\n\n\tif (!IS_TGT_MODE_CAPABLE(ha)) {\n\t\tql_log(ql_log_warn, base_vha, 0xe070,\n\t\t    \"This adapter does not support target mode.\\n\");\n\t\treturn 0;\n\t}\n\n\tql_dbg(ql_dbg_tgt, base_vha, 0xe03b,\n\t    \"Registering target for host %ld(%p).\\n\", base_vha->host_no, ha);\n\n\tBUG_ON(base_vha->vha_tgt.qla_tgt != NULL);\n\n\ttgt = kzalloc(sizeof(struct qla_tgt), GFP_KERNEL);\n\tif (!tgt) {\n\t\tql_dbg(ql_dbg_tgt, base_vha, 0xe066,\n\t\t    \"Unable to allocate struct qla_tgt\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\ttgt->qphints = kcalloc(ha->max_qpairs + 1,\n\t\t\t       sizeof(struct qla_qpair_hint),\n\t\t\t       GFP_KERNEL);\n\tif (!tgt->qphints) {\n\t\tkfree(tgt);\n\t\tql_log(ql_log_warn, base_vha, 0x0197,\n\t\t    \"Unable to allocate qpair hints.\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tif (!(base_vha->host->hostt->supported_mode & MODE_TARGET))\n\t\tbase_vha->host->hostt->supported_mode |= MODE_TARGET;\n\n\trc = btree_init64(&tgt->lun_qpair_map);\n\tif (rc) {\n\t\tkfree(tgt->qphints);\n\t\tkfree(tgt);\n\t\tql_log(ql_log_info, base_vha, 0x0198,\n\t\t\t\"Unable to initialize lun_qpair_map btree\\n\");\n\t\treturn -EIO;\n\t}\n\th = &tgt->qphints[0];\n\th->qpair = ha->base_qpair;\n\tINIT_LIST_HEAD(&h->hint_elem);\n\th->cpuid = ha->base_qpair->cpuid;\n\tlist_add_tail(&h->hint_elem, &ha->base_qpair->hints_list);\n\n\tfor (i = 0; i < ha->max_qpairs; i++) {\n\t\tunsigned long flags;\n\n\t\tstruct qla_qpair *qpair = ha->queue_pair_map[i];\n\n\t\th = &tgt->qphints[i + 1];\n\t\tINIT_LIST_HEAD(&h->hint_elem);\n\t\tif (qpair) {\n\t\t\th->qpair = qpair;\n\t\t\tspin_lock_irqsave(qpair->qp_lock_ptr, flags);\n\t\t\tlist_add_tail(&h->hint_elem, &qpair->hints_list);\n\t\t\tspin_unlock_irqrestore(qpair->qp_lock_ptr, flags);\n\t\t\th->cpuid = qpair->cpuid;\n\t\t}\n\t}\n\n\ttgt->ha = ha;\n\ttgt->vha = base_vha;\n\tinit_waitqueue_head(&tgt->waitQ);\n\tINIT_LIST_HEAD(&tgt->del_sess_list);\n\tspin_lock_init(&tgt->sess_work_lock);\n\tINIT_WORK(&tgt->sess_work, qlt_sess_work_fn);\n\tINIT_LIST_HEAD(&tgt->sess_works_list);\n\tatomic_set(&tgt->tgt_global_resets_count, 0);\n\n\tbase_vha->vha_tgt.qla_tgt = tgt;\n\n\tql_dbg(ql_dbg_tgt, base_vha, 0xe067,\n\t\t\"qla_target(%d): using 64 Bit PCI addressing\",\n\t\tbase_vha->vp_idx);\n\t/* 3 is reserved */\n\ttgt->sg_tablesize = QLA_TGT_MAX_SG_24XX(base_vha->req->length - 3);\n\n\tmutex_lock(&qla_tgt_mutex);\n\tlist_add_tail(&tgt->tgt_list_entry, &qla_tgt_glist);\n\tmutex_unlock(&qla_tgt_mutex);\n\n\tif (ha->tgt.tgt_ops && ha->tgt.tgt_ops->add_target)\n\t\tha->tgt.tgt_ops->add_target(base_vha);\n\n\treturn 0;\n}\n\n/* Must be called under tgt_host_action_mutex */\nint qlt_remove_target(struct qla_hw_data *ha, struct scsi_qla_host *vha)\n{\n\tif (!vha->vha_tgt.qla_tgt)\n\t\treturn 0;\n\n\tif (vha->fc_vport) {\n\t\tqlt_release(vha->vha_tgt.qla_tgt);\n\t\treturn 0;\n\t}\n\n\t/* free left over qfull cmds */\n\tqlt_init_term_exchange(vha);\n\n\tql_dbg(ql_dbg_tgt, vha, 0xe03c, \"Unregistering target for host %ld(%p)\",\n\t    vha->host_no, ha);\n\tqlt_release(vha->vha_tgt.qla_tgt);\n\n\treturn 0;\n}\n\nvoid qlt_remove_target_resources(struct qla_hw_data *ha)\n{\n\tstruct scsi_qla_host *node;\n\tu32 key = 0;\n\n\tbtree_for_each_safe32(&ha->tgt.host_map, key, node)\n\t\tbtree_remove32(&ha->tgt.host_map, key);\n\n\tbtree_destroy32(&ha->tgt.host_map);\n}\n\nstatic void qlt_lport_dump(struct scsi_qla_host *vha, u64 wwpn,\n\tunsigned char *b)\n{\n\tpr_debug(\"qla2xxx HW vha->node_name: %8phC\\n\", vha->node_name);\n\tpr_debug(\"qla2xxx HW vha->port_name: %8phC\\n\", vha->port_name);\n\tput_unaligned_be64(wwpn, b);\n\tpr_debug(\"qla2xxx passed configfs WWPN: %8phC\\n\", b);\n}\n\n/**\n * qla_tgt_lport_register - register lport with external module\n *\n * @target_lport_ptr: pointer for tcm_qla2xxx specific lport data\n * @phys_wwpn: physical port WWPN\n * @npiv_wwpn: NPIV WWPN\n * @npiv_wwnn: NPIV WWNN\n * @callback:  lport initialization callback for tcm_qla2xxx code\n */\nint qlt_lport_register(void *target_lport_ptr, u64 phys_wwpn,\n\t\t       u64 npiv_wwpn, u64 npiv_wwnn,\n\t\t       int (*callback)(struct scsi_qla_host *, void *, u64, u64))\n{\n\tstruct qla_tgt *tgt;\n\tstruct scsi_qla_host *vha;\n\tstruct qla_hw_data *ha;\n\tstruct Scsi_Host *host;\n\tunsigned long flags;\n\tint rc;\n\tu8 b[WWN_SIZE];\n\n\tmutex_lock(&qla_tgt_mutex);\n\tlist_for_each_entry(tgt, &qla_tgt_glist, tgt_list_entry) {\n\t\tvha = tgt->vha;\n\t\tha = vha->hw;\n\n\t\thost = vha->host;\n\t\tif (!host)\n\t\t\tcontinue;\n\n\t\tif (!(host->hostt->supported_mode & MODE_TARGET))\n\t\t\tcontinue;\n\n\t\tif (vha->qlini_mode == QLA2XXX_INI_MODE_ENABLED)\n\t\t\tcontinue;\n\n\t\tspin_lock_irqsave(&ha->hardware_lock, flags);\n\t\tif ((!npiv_wwpn || !npiv_wwnn) && host->active_mode & MODE_TARGET) {\n\t\t\tpr_debug(\"MODE_TARGET already active on qla2xxx(%d)\\n\",\n\t\t\t    host->host_no);\n\t\t\tspin_unlock_irqrestore(&ha->hardware_lock, flags);\n\t\t\tcontinue;\n\t\t}\n\t\tif (tgt->tgt_stop) {\n\t\t\tpr_debug(\"MODE_TARGET in shutdown on qla2xxx(%d)\\n\",\n\t\t\t\t host->host_no);\n\t\t\tspin_unlock_irqrestore(&ha->hardware_lock, flags);\n\t\t\tcontinue;\n\t\t}\n\t\tspin_unlock_irqrestore(&ha->hardware_lock, flags);\n\n\t\tif (!scsi_host_get(host)) {\n\t\t\tql_dbg(ql_dbg_tgt, vha, 0xe068,\n\t\t\t    \"Unable to scsi_host_get() for\"\n\t\t\t    \" qla2xxx scsi_host\\n\");\n\t\t\tcontinue;\n\t\t}\n\t\tqlt_lport_dump(vha, phys_wwpn, b);\n\n\t\tif (memcmp(vha->port_name, b, WWN_SIZE)) {\n\t\t\tscsi_host_put(host);\n\t\t\tcontinue;\n\t\t}\n\t\trc = (*callback)(vha, target_lport_ptr, npiv_wwpn, npiv_wwnn);\n\t\tif (rc != 0)\n\t\t\tscsi_host_put(host);\n\n\t\tmutex_unlock(&qla_tgt_mutex);\n\t\treturn rc;\n\t}\n\tmutex_unlock(&qla_tgt_mutex);\n\n\treturn -ENODEV;\n}\nEXPORT_SYMBOL(qlt_lport_register);\n\n/**\n * qla_tgt_lport_deregister - Degister lport\n *\n * @vha:  Registered scsi_qla_host pointer\n */\nvoid qlt_lport_deregister(struct scsi_qla_host *vha)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct Scsi_Host *sh = vha->host;\n\t/*\n\t * Clear the target_lport_ptr qla_target_template pointer in qla_hw_data\n\t */\n\tvha->vha_tgt.target_lport_ptr = NULL;\n\tha->tgt.tgt_ops = NULL;\n\t/*\n\t * Release the Scsi_Host reference for the underlying qla2xxx host\n\t */\n\tscsi_host_put(sh);\n}\nEXPORT_SYMBOL(qlt_lport_deregister);\n\n/* Must be called under HW lock */\nvoid qlt_set_mode(struct scsi_qla_host *vha)\n{\n\tswitch (vha->qlini_mode) {\n\tcase QLA2XXX_INI_MODE_DISABLED:\n\tcase QLA2XXX_INI_MODE_EXCLUSIVE:\n\t\tvha->host->active_mode = MODE_TARGET;\n\t\tbreak;\n\tcase QLA2XXX_INI_MODE_ENABLED:\n\t\tvha->host->active_mode = MODE_INITIATOR;\n\t\tbreak;\n\tcase QLA2XXX_INI_MODE_DUAL:\n\t\tvha->host->active_mode = MODE_DUAL;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\n/* Must be called under HW lock */\nstatic void qlt_clear_mode(struct scsi_qla_host *vha)\n{\n\tswitch (vha->qlini_mode) {\n\tcase QLA2XXX_INI_MODE_DISABLED:\n\t\tvha->host->active_mode = MODE_UNKNOWN;\n\t\tbreak;\n\tcase QLA2XXX_INI_MODE_EXCLUSIVE:\n\t\tvha->host->active_mode = MODE_INITIATOR;\n\t\tbreak;\n\tcase QLA2XXX_INI_MODE_ENABLED:\n\tcase QLA2XXX_INI_MODE_DUAL:\n\t\tvha->host->active_mode = MODE_INITIATOR;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\n/*\n * qla_tgt_enable_vha - NO LOCK HELD\n *\n * host_reset, bring up w/ Target Mode Enabled\n */\nvoid\nqlt_enable_vha(struct scsi_qla_host *vha)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct qla_tgt *tgt = vha->vha_tgt.qla_tgt;\n\tunsigned long flags;\n\tscsi_qla_host_t *base_vha = pci_get_drvdata(ha->pdev);\n\n\tif (!tgt) {\n\t\tql_dbg(ql_dbg_tgt, vha, 0xe069,\n\t\t    \"Unable to locate qla_tgt pointer from\"\n\t\t    \" struct qla_hw_data\\n\");\n\t\tdump_stack();\n\t\treturn;\n\t}\n\tif (vha->qlini_mode == QLA2XXX_INI_MODE_ENABLED)\n\t\treturn;\n\n\tif (ha->tgt.num_act_qpairs > ha->max_qpairs)\n\t\tha->tgt.num_act_qpairs = ha->max_qpairs;\n\tspin_lock_irqsave(&ha->hardware_lock, flags);\n\ttgt->tgt_stopped = 0;\n\tqlt_set_mode(vha);\n\tspin_unlock_irqrestore(&ha->hardware_lock, flags);\n\n\tmutex_lock(&ha->optrom_mutex);\n\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf021,\n\t    \"%s.\\n\", __func__);\n\tif (vha->vp_idx) {\n\t\tqla24xx_disable_vp(vha);\n\t\tqla24xx_enable_vp(vha);\n\t} else {\n\t\tset_bit(ISP_ABORT_NEEDED, &base_vha->dpc_flags);\n\t\tqla2xxx_wake_dpc(base_vha);\n\t\tWARN_ON_ONCE(qla2x00_wait_for_hba_online(base_vha) !=\n\t\t\t     QLA_SUCCESS);\n\t}\n\tmutex_unlock(&ha->optrom_mutex);\n}\nEXPORT_SYMBOL(qlt_enable_vha);\n\n/*\n * qla_tgt_disable_vha - NO LOCK HELD\n *\n * Disable Target Mode and reset the adapter\n */\nstatic void qlt_disable_vha(struct scsi_qla_host *vha)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct qla_tgt *tgt = vha->vha_tgt.qla_tgt;\n\tunsigned long flags;\n\n\tif (!tgt) {\n\t\tql_dbg(ql_dbg_tgt, vha, 0xe06a,\n\t\t    \"Unable to locate qla_tgt pointer from\"\n\t\t    \" struct qla_hw_data\\n\");\n\t\tdump_stack();\n\t\treturn;\n\t}\n\n\tspin_lock_irqsave(&ha->hardware_lock, flags);\n\tqlt_clear_mode(vha);\n\tspin_unlock_irqrestore(&ha->hardware_lock, flags);\n\n\tset_bit(ISP_ABORT_NEEDED, &vha->dpc_flags);\n\tqla2xxx_wake_dpc(vha);\n\n\t/*\n\t * We are expecting the offline state.\n\t * QLA_FUNCTION_FAILED means that adapter is offline.\n\t */\n\tif (qla2x00_wait_for_hba_online(vha) != QLA_SUCCESS)\n\t\tql_dbg(ql_dbg_tgt, vha, 0xe081,\n\t\t       \"adapter is offline\\n\");\n}\n\n/*\n * Called from qla_init.c:qla24xx_vport_create() contex to setup\n * the target mode specific struct scsi_qla_host and struct qla_hw_data\n * members.\n */\nvoid\nqlt_vport_create(struct scsi_qla_host *vha, struct qla_hw_data *ha)\n{\n\tvha->vha_tgt.qla_tgt = NULL;\n\n\tmutex_init(&vha->vha_tgt.tgt_mutex);\n\tmutex_init(&vha->vha_tgt.tgt_host_action_mutex);\n\n\tqlt_clear_mode(vha);\n\n\t/*\n\t * NOTE: Currently the value is kept the same for <24xx and\n\t * >=24xx ISPs. If it is necessary to change it,\n\t * the check should be added for specific ISPs,\n\t * assigning the value appropriately.\n\t */\n\tha->tgt.atio_q_length = ATIO_ENTRY_CNT_24XX;\n\n\tqlt_add_target(ha, vha);\n}\n\nu8\nqlt_rff_id(struct scsi_qla_host *vha)\n{\n\tu8 fc4_feature = 0;\n\t/*\n\t * FC-4 Feature bit 0 indicates target functionality to the name server.\n\t */\n\tif (qla_tgt_mode_enabled(vha)) {\n\t\tfc4_feature = BIT_0;\n\t} else if (qla_ini_mode_enabled(vha)) {\n\t\tfc4_feature = BIT_1;\n\t} else if (qla_dual_mode_enabled(vha))\n\t\tfc4_feature = BIT_0 | BIT_1;\n\n\treturn fc4_feature;\n}\n\n/*\n * qlt_init_atio_q_entries() - Initializes ATIO queue entries.\n * @ha: HA context\n *\n * Beginning of ATIO ring has initialization control block already built\n * by nvram config routine.\n *\n * Returns 0 on success.\n */\nvoid\nqlt_init_atio_q_entries(struct scsi_qla_host *vha)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tuint16_t cnt;\n\tstruct atio_from_isp *pkt = (struct atio_from_isp *)ha->tgt.atio_ring;\n\n\tif (qla_ini_mode_enabled(vha))\n\t\treturn;\n\n\tfor (cnt = 0; cnt < ha->tgt.atio_q_length; cnt++) {\n\t\tpkt->u.raw.signature = cpu_to_le32(ATIO_PROCESSED);\n\t\tpkt++;\n\t}\n\n}\n\n/*\n * qlt_24xx_process_atio_queue() - Process ATIO queue entries.\n * @ha: SCSI driver HA context\n */\nvoid\nqlt_24xx_process_atio_queue(struct scsi_qla_host *vha, uint8_t ha_locked)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct atio_from_isp *pkt;\n\tint cnt, i;\n\n\tif (!ha->flags.fw_started)\n\t\treturn;\n\n\twhile ((ha->tgt.atio_ring_ptr->signature != ATIO_PROCESSED) ||\n\t    fcpcmd_is_corrupted(ha->tgt.atio_ring_ptr)) {\n\t\tpkt = (struct atio_from_isp *)ha->tgt.atio_ring_ptr;\n\t\tcnt = pkt->u.raw.entry_count;\n\n\t\tif (unlikely(fcpcmd_is_corrupted(ha->tgt.atio_ring_ptr))) {\n\t\t\t/*\n\t\t\t * This packet is corrupted. The header + payload\n\t\t\t * can not be trusted. There is no point in passing\n\t\t\t * it further up.\n\t\t\t */\n\t\t\tql_log(ql_log_warn, vha, 0xd03c,\n\t\t\t    \"corrupted fcp frame SID[%3phN] OXID[%04x] EXCG[%x] %64phN\\n\",\n\t\t\t    &pkt->u.isp24.fcp_hdr.s_id,\n\t\t\t    be16_to_cpu(pkt->u.isp24.fcp_hdr.ox_id),\n\t\t\t    pkt->u.isp24.exchange_addr, pkt);\n\n\t\t\tadjust_corrupted_atio(pkt);\n\t\t\tqlt_send_term_exchange(ha->base_qpair, NULL, pkt,\n\t\t\t    ha_locked, 0);\n\t\t} else {\n\t\t\tqlt_24xx_atio_pkt_all_vps(vha,\n\t\t\t    (struct atio_from_isp *)pkt, ha_locked);\n\t\t}\n\n\t\tfor (i = 0; i < cnt; i++) {\n\t\t\tha->tgt.atio_ring_index++;\n\t\t\tif (ha->tgt.atio_ring_index == ha->tgt.atio_q_length) {\n\t\t\t\tha->tgt.atio_ring_index = 0;\n\t\t\t\tha->tgt.atio_ring_ptr = ha->tgt.atio_ring;\n\t\t\t} else\n\t\t\t\tha->tgt.atio_ring_ptr++;\n\n\t\t\tpkt->u.raw.signature = cpu_to_le32(ATIO_PROCESSED);\n\t\t\tpkt = (struct atio_from_isp *)ha->tgt.atio_ring_ptr;\n\t\t}\n\t\twmb();\n\t}\n\n\t/* Adjust ring index */\n\twrt_reg_dword(ISP_ATIO_Q_OUT(vha), ha->tgt.atio_ring_index);\n}\n\nvoid\nqlt_24xx_config_rings(struct scsi_qla_host *vha)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct qla_msix_entry *msix = &ha->msix_entries[2];\n\tstruct init_cb_24xx *icb = (struct init_cb_24xx *)ha->init_cb;\n\n\tif (!QLA_TGT_MODE_ENABLED())\n\t\treturn;\n\n\twrt_reg_dword(ISP_ATIO_Q_IN(vha), 0);\n\twrt_reg_dword(ISP_ATIO_Q_OUT(vha), 0);\n\trd_reg_dword(ISP_ATIO_Q_OUT(vha));\n\n\tif (ha->flags.msix_enabled) {\n\t\tif (IS_QLA83XX(ha) || IS_QLA27XX(ha) || IS_QLA28XX(ha)) {\n\t\t\tif (IS_QLA2071(ha)) {\n\t\t\t\t/* 4 ports Baker: Enable Interrupt Handshake */\n\t\t\t\ticb->msix_atio = 0;\n\t\t\t\ticb->firmware_options_2 |= cpu_to_le32(BIT_26);\n\t\t\t} else {\n\t\t\t\ticb->msix_atio = cpu_to_le16(msix->entry);\n\t\t\t\ticb->firmware_options_2 &= cpu_to_le32(~BIT_26);\n\t\t\t}\n\t\t\tql_dbg(ql_dbg_init, vha, 0xf072,\n\t\t\t    \"Registering ICB vector 0x%x for atio que.\\n\",\n\t\t\t    msix->entry);\n\t\t}\n\t} else {\n\t\t/* INTx|MSI */\n\t\tif (IS_QLA83XX(ha) || IS_QLA27XX(ha) || IS_QLA28XX(ha)) {\n\t\t\ticb->msix_atio = 0;\n\t\t\ticb->firmware_options_2 |= cpu_to_le32(BIT_26);\n\t\t\tql_dbg(ql_dbg_init, vha, 0xf072,\n\t\t\t    \"%s: Use INTx for ATIOQ.\\n\", __func__);\n\t\t}\n\t}\n}\n\nvoid\nqlt_24xx_config_nvram_stage1(struct scsi_qla_host *vha, struct nvram_24xx *nv)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tu32 tmp;\n\n\tif (!QLA_TGT_MODE_ENABLED())\n\t\treturn;\n\n\tif (qla_tgt_mode_enabled(vha) || qla_dual_mode_enabled(vha)) {\n\t\tif (!ha->tgt.saved_set) {\n\t\t\t/* We save only once */\n\t\t\tha->tgt.saved_exchange_count = nv->exchange_count;\n\t\t\tha->tgt.saved_firmware_options_1 =\n\t\t\t    nv->firmware_options_1;\n\t\t\tha->tgt.saved_firmware_options_2 =\n\t\t\t    nv->firmware_options_2;\n\t\t\tha->tgt.saved_firmware_options_3 =\n\t\t\t    nv->firmware_options_3;\n\t\t\tha->tgt.saved_set = 1;\n\t\t}\n\n\t\tif (qla_tgt_mode_enabled(vha))\n\t\t\tnv->exchange_count = cpu_to_le16(0xFFFF);\n\t\telse\t\t\t/* dual */\n\t\t\tnv->exchange_count = cpu_to_le16(vha->ql2xexchoffld);\n\n\t\t/* Enable target mode */\n\t\tnv->firmware_options_1 |= cpu_to_le32(BIT_4);\n\n\t\t/* Disable ini mode, if requested */\n\t\tif (qla_tgt_mode_enabled(vha))\n\t\t\tnv->firmware_options_1 |= cpu_to_le32(BIT_5);\n\n\t\t/* Disable Full Login after LIP */\n\t\tnv->firmware_options_1 &= cpu_to_le32(~BIT_13);\n\t\t/* Enable initial LIP */\n\t\tnv->firmware_options_1 &= cpu_to_le32(~BIT_9);\n\t\tif (ql2xtgt_tape_enable)\n\t\t\t/* Enable FC Tape support */\n\t\t\tnv->firmware_options_2 |= cpu_to_le32(BIT_12);\n\t\telse\n\t\t\t/* Disable FC Tape support */\n\t\t\tnv->firmware_options_2 &= cpu_to_le32(~BIT_12);\n\n\t\t/* Disable Full Login after LIP */\n\t\tnv->host_p &= cpu_to_le32(~BIT_10);\n\n\t\t/*\n\t\t * clear BIT 15 explicitly as we have seen at least\n\t\t * a couple of instances where this was set and this\n\t\t * was causing the firmware to not be initialized.\n\t\t */\n\t\tnv->firmware_options_1 &= cpu_to_le32(~BIT_15);\n\t\t/* Enable target PRLI control */\n\t\tnv->firmware_options_2 |= cpu_to_le32(BIT_14);\n\n\t\tif (IS_QLA25XX(ha)) {\n\t\t\t/* Change Loop-prefer to Pt-Pt */\n\t\t\ttmp = ~(BIT_4|BIT_5|BIT_6);\n\t\t\tnv->firmware_options_2 &= cpu_to_le32(tmp);\n\t\t\ttmp = P2P << 4;\n\t\t\tnv->firmware_options_2 |= cpu_to_le32(tmp);\n\t\t}\n\t} else {\n\t\tif (ha->tgt.saved_set) {\n\t\t\tnv->exchange_count = ha->tgt.saved_exchange_count;\n\t\t\tnv->firmware_options_1 =\n\t\t\t    ha->tgt.saved_firmware_options_1;\n\t\t\tnv->firmware_options_2 =\n\t\t\t    ha->tgt.saved_firmware_options_2;\n\t\t\tnv->firmware_options_3 =\n\t\t\t    ha->tgt.saved_firmware_options_3;\n\t\t}\n\t\treturn;\n\t}\n\n\tif (ha->base_qpair->enable_class_2) {\n\t\tif (vha->flags.init_done)\n\t\t\tfc_host_supported_classes(vha->host) =\n\t\t\t\tFC_COS_CLASS2 | FC_COS_CLASS3;\n\n\t\tnv->firmware_options_2 |= cpu_to_le32(BIT_8);\n\t} else {\n\t\tif (vha->flags.init_done)\n\t\t\tfc_host_supported_classes(vha->host) = FC_COS_CLASS3;\n\n\t\tnv->firmware_options_2 &= ~cpu_to_le32(BIT_8);\n\t}\n}\n\nvoid\nqlt_24xx_config_nvram_stage2(struct scsi_qla_host *vha,\n\tstruct init_cb_24xx *icb)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\n\tif (!QLA_TGT_MODE_ENABLED())\n\t\treturn;\n\n\tif (ha->tgt.node_name_set) {\n\t\tmemcpy(icb->node_name, ha->tgt.tgt_node_name, WWN_SIZE);\n\t\ticb->firmware_options_1 |= cpu_to_le32(BIT_14);\n\t}\n}\n\nvoid\nqlt_81xx_config_nvram_stage1(struct scsi_qla_host *vha, struct nvram_81xx *nv)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\tu32 tmp;\n\n\tif (!QLA_TGT_MODE_ENABLED())\n\t\treturn;\n\n\tif (qla_tgt_mode_enabled(vha) || qla_dual_mode_enabled(vha)) {\n\t\tif (!ha->tgt.saved_set) {\n\t\t\t/* We save only once */\n\t\t\tha->tgt.saved_exchange_count = nv->exchange_count;\n\t\t\tha->tgt.saved_firmware_options_1 =\n\t\t\t    nv->firmware_options_1;\n\t\t\tha->tgt.saved_firmware_options_2 =\n\t\t\t    nv->firmware_options_2;\n\t\t\tha->tgt.saved_firmware_options_3 =\n\t\t\t    nv->firmware_options_3;\n\t\t\tha->tgt.saved_set = 1;\n\t\t}\n\n\t\tif (qla_tgt_mode_enabled(vha))\n\t\t\tnv->exchange_count = cpu_to_le16(0xFFFF);\n\t\telse\t\t\t/* dual */\n\t\t\tnv->exchange_count = cpu_to_le16(vha->ql2xexchoffld);\n\n\t\t/* Enable target mode */\n\t\tnv->firmware_options_1 |= cpu_to_le32(BIT_4);\n\n\t\t/* Disable ini mode, if requested */\n\t\tif (qla_tgt_mode_enabled(vha))\n\t\t\tnv->firmware_options_1 |= cpu_to_le32(BIT_5);\n\t\t/* Disable Full Login after LIP */\n\t\tnv->firmware_options_1 &= cpu_to_le32(~BIT_13);\n\t\t/* Enable initial LIP */\n\t\tnv->firmware_options_1 &= cpu_to_le32(~BIT_9);\n\t\t/*\n\t\t * clear BIT 15 explicitly as we have seen at\n\t\t * least a couple of instances where this was set\n\t\t * and this was causing the firmware to not be\n\t\t * initialized.\n\t\t */\n\t\tnv->firmware_options_1 &= cpu_to_le32(~BIT_15);\n\t\tif (ql2xtgt_tape_enable)\n\t\t\t/* Enable FC tape support */\n\t\t\tnv->firmware_options_2 |= cpu_to_le32(BIT_12);\n\t\telse\n\t\t\t/* Disable FC tape support */\n\t\t\tnv->firmware_options_2 &= cpu_to_le32(~BIT_12);\n\n\t\t/* Disable Full Login after LIP */\n\t\tnv->host_p &= cpu_to_le32(~BIT_10);\n\t\t/* Enable target PRLI control */\n\t\tnv->firmware_options_2 |= cpu_to_le32(BIT_14);\n\n\t\t/* Change Loop-prefer to Pt-Pt */\n\t\ttmp = ~(BIT_4|BIT_5|BIT_6);\n\t\tnv->firmware_options_2 &= cpu_to_le32(tmp);\n\t\ttmp = P2P << 4;\n\t\tnv->firmware_options_2 |= cpu_to_le32(tmp);\n\t} else {\n\t\tif (ha->tgt.saved_set) {\n\t\t\tnv->exchange_count = ha->tgt.saved_exchange_count;\n\t\t\tnv->firmware_options_1 =\n\t\t\t    ha->tgt.saved_firmware_options_1;\n\t\t\tnv->firmware_options_2 =\n\t\t\t    ha->tgt.saved_firmware_options_2;\n\t\t\tnv->firmware_options_3 =\n\t\t\t    ha->tgt.saved_firmware_options_3;\n\t\t}\n\t\treturn;\n\t}\n\n\tif (ha->base_qpair->enable_class_2) {\n\t\tif (vha->flags.init_done)\n\t\t\tfc_host_supported_classes(vha->host) =\n\t\t\t\tFC_COS_CLASS2 | FC_COS_CLASS3;\n\n\t\tnv->firmware_options_2 |= cpu_to_le32(BIT_8);\n\t} else {\n\t\tif (vha->flags.init_done)\n\t\t\tfc_host_supported_classes(vha->host) = FC_COS_CLASS3;\n\n\t\tnv->firmware_options_2 &= ~cpu_to_le32(BIT_8);\n\t}\n}\n\nvoid\nqlt_81xx_config_nvram_stage2(struct scsi_qla_host *vha,\n\tstruct init_cb_81xx *icb)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\n\tif (!QLA_TGT_MODE_ENABLED())\n\t\treturn;\n\n\tif (ha->tgt.node_name_set) {\n\t\tmemcpy(icb->node_name, ha->tgt.tgt_node_name, WWN_SIZE);\n\t\ticb->firmware_options_1 |= cpu_to_le32(BIT_14);\n\t}\n}\n\nvoid\nqlt_83xx_iospace_config(struct qla_hw_data *ha)\n{\n\tif (!QLA_TGT_MODE_ENABLED())\n\t\treturn;\n\n\tha->msix_count += 1; /* For ATIO Q */\n}\n\n\nvoid\nqlt_modify_vp_config(struct scsi_qla_host *vha,\n\tstruct vp_config_entry_24xx *vpmod)\n{\n\t/* enable target mode.  Bit5 = 1 => disable */\n\tif (qla_tgt_mode_enabled(vha) || qla_dual_mode_enabled(vha))\n\t\tvpmod->options_idx1 &= ~BIT_5;\n\n\t/* Disable ini mode, if requested.  bit4 = 1 => disable */\n\tif (qla_tgt_mode_enabled(vha))\n\t\tvpmod->options_idx1 &= ~BIT_4;\n}\n\nvoid\nqlt_probe_one_stage1(struct scsi_qla_host *base_vha, struct qla_hw_data *ha)\n{\n\tint rc;\n\n\tif (!QLA_TGT_MODE_ENABLED())\n\t\treturn;\n\n\tif  ((ql2xenablemsix == 0) || IS_QLA83XX(ha) || IS_QLA27XX(ha) ||\n\t    IS_QLA28XX(ha)) {\n\t\tISP_ATIO_Q_IN(base_vha) = &ha->mqiobase->isp25mq.atio_q_in;\n\t\tISP_ATIO_Q_OUT(base_vha) = &ha->mqiobase->isp25mq.atio_q_out;\n\t} else {\n\t\tISP_ATIO_Q_IN(base_vha) = &ha->iobase->isp24.atio_q_in;\n\t\tISP_ATIO_Q_OUT(base_vha) = &ha->iobase->isp24.atio_q_out;\n\t}\n\n\tmutex_init(&base_vha->vha_tgt.tgt_mutex);\n\tmutex_init(&base_vha->vha_tgt.tgt_host_action_mutex);\n\n\tINIT_LIST_HEAD(&base_vha->unknown_atio_list);\n\tINIT_DELAYED_WORK(&base_vha->unknown_atio_work,\n\t    qlt_unknown_atio_work_fn);\n\n\tqlt_clear_mode(base_vha);\n\n\trc = btree_init32(&ha->tgt.host_map);\n\tif (rc)\n\t\tql_log(ql_log_info, base_vha, 0xd03d,\n\t\t    \"Unable to initialize ha->host_map btree\\n\");\n\n\tqlt_update_vp_map(base_vha, SET_VP_IDX);\n}\n\nirqreturn_t\nqla83xx_msix_atio_q(int irq, void *dev_id)\n{\n\tstruct rsp_que *rsp;\n\tscsi_qla_host_t\t*vha;\n\tstruct qla_hw_data *ha;\n\tunsigned long flags;\n\n\trsp = (struct rsp_que *) dev_id;\n\tha = rsp->hw;\n\tvha = pci_get_drvdata(ha->pdev);\n\n\tspin_lock_irqsave(&ha->tgt.atio_lock, flags);\n\n\tqlt_24xx_process_atio_queue(vha, 0);\n\n\tspin_unlock_irqrestore(&ha->tgt.atio_lock, flags);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void\nqlt_handle_abts_recv_work(struct work_struct *work)\n{\n\tstruct qla_tgt_sess_op *op = container_of(work,\n\t\tstruct qla_tgt_sess_op, work);\n\tscsi_qla_host_t *vha = op->vha;\n\tstruct qla_hw_data *ha = vha->hw;\n\tunsigned long flags;\n\n\tif (qla2x00_reset_active(vha) ||\n\t    (op->chip_reset != ha->base_qpair->chip_reset))\n\t\treturn;\n\n\tspin_lock_irqsave(&ha->tgt.atio_lock, flags);\n\tqlt_24xx_process_atio_queue(vha, 0);\n\tspin_unlock_irqrestore(&ha->tgt.atio_lock, flags);\n\n\tspin_lock_irqsave(&ha->hardware_lock, flags);\n\tqlt_response_pkt_all_vps(vha, op->rsp, (response_t *)&op->atio);\n\tspin_unlock_irqrestore(&ha->hardware_lock, flags);\n\n\tkfree(op);\n}\n\nvoid\nqlt_handle_abts_recv(struct scsi_qla_host *vha, struct rsp_que *rsp,\n    response_t *pkt)\n{\n\tstruct qla_tgt_sess_op *op;\n\n\top = kzalloc(sizeof(*op), GFP_ATOMIC);\n\n\tif (!op) {\n\t\t/* do not reach for ATIO queue here.  This is best effort err\n\t\t * recovery at this point.\n\t\t */\n\t\tqlt_response_pkt_all_vps(vha, rsp, pkt);\n\t\treturn;\n\t}\n\n\tmemcpy(&op->atio, pkt, sizeof(*pkt));\n\top->vha = vha;\n\top->chip_reset = vha->hw->base_qpair->chip_reset;\n\top->rsp = rsp;\n\tINIT_WORK(&op->work, qlt_handle_abts_recv_work);\n\tqueue_work(qla_tgt_wq, &op->work);\n\treturn;\n}\n\nint\nqlt_mem_alloc(struct qla_hw_data *ha)\n{\n\tif (!QLA_TGT_MODE_ENABLED())\n\t\treturn 0;\n\n\tha->tgt.tgt_vp_map = kcalloc(MAX_MULTI_ID_FABRIC,\n\t\t\t\t     sizeof(struct qla_tgt_vp_map),\n\t\t\t\t     GFP_KERNEL);\n\tif (!ha->tgt.tgt_vp_map)\n\t\treturn -ENOMEM;\n\n\tha->tgt.atio_ring = dma_alloc_coherent(&ha->pdev->dev,\n\t    (ha->tgt.atio_q_length + 1) * sizeof(struct atio_from_isp),\n\t    &ha->tgt.atio_dma, GFP_KERNEL);\n\tif (!ha->tgt.atio_ring) {\n\t\tkfree(ha->tgt.tgt_vp_map);\n\t\treturn -ENOMEM;\n\t}\n\treturn 0;\n}\n\nvoid\nqlt_mem_free(struct qla_hw_data *ha)\n{\n\tif (!QLA_TGT_MODE_ENABLED())\n\t\treturn;\n\n\tif (ha->tgt.atio_ring) {\n\t\tdma_free_coherent(&ha->pdev->dev, (ha->tgt.atio_q_length + 1) *\n\t\t    sizeof(struct atio_from_isp), ha->tgt.atio_ring,\n\t\t    ha->tgt.atio_dma);\n\t}\n\tha->tgt.atio_ring = NULL;\n\tha->tgt.atio_dma = 0;\n\tkfree(ha->tgt.tgt_vp_map);\n\tha->tgt.tgt_vp_map = NULL;\n}\n\n/* vport_slock to be held by the caller */\nvoid\nqlt_update_vp_map(struct scsi_qla_host *vha, int cmd)\n{\n\tvoid *slot;\n\tu32 key;\n\tint rc;\n\n\tif (!QLA_TGT_MODE_ENABLED())\n\t\treturn;\n\n\tkey = vha->d_id.b24;\n\n\tswitch (cmd) {\n\tcase SET_VP_IDX:\n\t\tvha->hw->tgt.tgt_vp_map[vha->vp_idx].vha = vha;\n\t\tbreak;\n\tcase SET_AL_PA:\n\t\tslot = btree_lookup32(&vha->hw->tgt.host_map, key);\n\t\tif (!slot) {\n\t\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf018,\n\t\t\t    \"Save vha in host_map %p %06x\\n\", vha, key);\n\t\t\trc = btree_insert32(&vha->hw->tgt.host_map,\n\t\t\t\tkey, vha, GFP_ATOMIC);\n\t\t\tif (rc)\n\t\t\t\tql_log(ql_log_info, vha, 0xd03e,\n\t\t\t\t    \"Unable to insert s_id into host_map: %06x\\n\",\n\t\t\t\t    key);\n\t\t\treturn;\n\t\t}\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf019,\n\t\t    \"replace existing vha in host_map %p %06x\\n\", vha, key);\n\t\tbtree_update32(&vha->hw->tgt.host_map, key, vha);\n\t\tbreak;\n\tcase RESET_VP_IDX:\n\t\tvha->hw->tgt.tgt_vp_map[vha->vp_idx].vha = NULL;\n\t\tbreak;\n\tcase RESET_AL_PA:\n\t\tql_dbg(ql_dbg_tgt_mgt, vha, 0xf01a,\n\t\t   \"clear vha in host_map %p %06x\\n\", vha, key);\n\t\tslot = btree_lookup32(&vha->hw->tgt.host_map, key);\n\t\tif (slot)\n\t\t\tbtree_remove32(&vha->hw->tgt.host_map, key);\n\t\tvha->d_id.b24 = 0;\n\t\tbreak;\n\t}\n}\n\nvoid qlt_update_host_map(struct scsi_qla_host *vha, port_id_t id)\n{\n\n\tif (!vha->d_id.b24) {\n\t\tvha->d_id = id;\n\t\tqlt_update_vp_map(vha, SET_AL_PA);\n\t} else if (vha->d_id.b24 != id.b24) {\n\t\tqlt_update_vp_map(vha, RESET_AL_PA);\n\t\tvha->d_id = id;\n\t\tqlt_update_vp_map(vha, SET_AL_PA);\n\t}\n}\n\nstatic int __init qlt_parse_ini_mode(void)\n{\n\tif (strcasecmp(qlini_mode, QLA2XXX_INI_MODE_STR_EXCLUSIVE) == 0)\n\t\tql2x_ini_mode = QLA2XXX_INI_MODE_EXCLUSIVE;\n\telse if (strcasecmp(qlini_mode, QLA2XXX_INI_MODE_STR_DISABLED) == 0)\n\t\tql2x_ini_mode = QLA2XXX_INI_MODE_DISABLED;\n\telse if (strcasecmp(qlini_mode, QLA2XXX_INI_MODE_STR_ENABLED) == 0)\n\t\tql2x_ini_mode = QLA2XXX_INI_MODE_ENABLED;\n\telse if (strcasecmp(qlini_mode, QLA2XXX_INI_MODE_STR_DUAL) == 0)\n\t\tql2x_ini_mode = QLA2XXX_INI_MODE_DUAL;\n\telse\n\t\treturn false;\n\n\treturn true;\n}\n\nint __init qlt_init(void)\n{\n\tint ret;\n\n\tBUILD_BUG_ON(sizeof(struct ctio7_to_24xx) != 64);\n\tBUILD_BUG_ON(sizeof(struct ctio_to_2xxx) != 64);\n\n\tif (!qlt_parse_ini_mode()) {\n\t\tql_log(ql_log_fatal, NULL, 0xe06b,\n\t\t    \"qlt_parse_ini_mode() failed\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (!QLA_TGT_MODE_ENABLED())\n\t\treturn 0;\n\n\tqla_tgt_mgmt_cmd_cachep = kmem_cache_create(\"qla_tgt_mgmt_cmd_cachep\",\n\t    sizeof(struct qla_tgt_mgmt_cmd), __alignof__(struct\n\t    qla_tgt_mgmt_cmd), 0, NULL);\n\tif (!qla_tgt_mgmt_cmd_cachep) {\n\t\tql_log(ql_log_fatal, NULL, 0xd04b,\n\t\t    \"kmem_cache_create for qla_tgt_mgmt_cmd_cachep failed\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tqla_tgt_plogi_cachep = kmem_cache_create(\"qla_tgt_plogi_cachep\",\n\t    sizeof(struct qlt_plogi_ack_t), __alignof__(struct qlt_plogi_ack_t),\n\t    0, NULL);\n\n\tif (!qla_tgt_plogi_cachep) {\n\t\tql_log(ql_log_fatal, NULL, 0xe06d,\n\t\t    \"kmem_cache_create for qla_tgt_plogi_cachep failed\\n\");\n\t\tret = -ENOMEM;\n\t\tgoto out_mgmt_cmd_cachep;\n\t}\n\n\tqla_tgt_mgmt_cmd_mempool = mempool_create(25, mempool_alloc_slab,\n\t    mempool_free_slab, qla_tgt_mgmt_cmd_cachep);\n\tif (!qla_tgt_mgmt_cmd_mempool) {\n\t\tql_log(ql_log_fatal, NULL, 0xe06e,\n\t\t    \"mempool_create for qla_tgt_mgmt_cmd_mempool failed\\n\");\n\t\tret = -ENOMEM;\n\t\tgoto out_plogi_cachep;\n\t}\n\n\tqla_tgt_wq = alloc_workqueue(\"qla_tgt_wq\", 0, 0);\n\tif (!qla_tgt_wq) {\n\t\tql_log(ql_log_fatal, NULL, 0xe06f,\n\t\t    \"alloc_workqueue for qla_tgt_wq failed\\n\");\n\t\tret = -ENOMEM;\n\t\tgoto out_cmd_mempool;\n\t}\n\t/*\n\t * Return 1 to signal that initiator-mode is being disabled\n\t */\n\treturn (ql2x_ini_mode == QLA2XXX_INI_MODE_DISABLED) ? 1 : 0;\n\nout_cmd_mempool:\n\tmempool_destroy(qla_tgt_mgmt_cmd_mempool);\nout_plogi_cachep:\n\tkmem_cache_destroy(qla_tgt_plogi_cachep);\nout_mgmt_cmd_cachep:\n\tkmem_cache_destroy(qla_tgt_mgmt_cmd_cachep);\n\treturn ret;\n}\n\nvoid qlt_exit(void)\n{\n\tif (!QLA_TGT_MODE_ENABLED())\n\t\treturn;\n\n\tdestroy_workqueue(qla_tgt_wq);\n\tmempool_destroy(qla_tgt_mgmt_cmd_mempool);\n\tkmem_cache_destroy(qla_tgt_plogi_cachep);\n\tkmem_cache_destroy(qla_tgt_mgmt_cmd_cachep);\n}\n"}}, "reports": [{"events": [{"location": {"col": 12, "file": 0, "line": 984}, "message": "WARNING !A || A && B is equivalent to !A || B"}], "macros": [], "notes": [], "path": "/src/drivers/scsi/qla2xxx/qla_target.c", "reportHash": "0bba62132f96d7fd9b5ef2c5ca11eaa2", "checkerName": "coccinelle", "reviewStatus": null, "severity": "UNSPECIFIED"}]};
      window.onload = function() {
        if (!browserCompatible) {
          setNonCompatibleBrowserMessage();
        } else {
          BugViewer.init(data.files, data.reports);
          BugViewer.create();
          BugViewer.initByUrl();
        }
      };
    </script>
  </head>
  <body>
  <div class="container">
    <div id="content">
      <div id="side-bar">
        <div class="header">
          <a href="index.html" class="button">&#8249; Return to List</a>
        </div>
        <div id="report-nav">
          <div class="header">Reports</div>
        </div>
      </div>
      <div id="editor-wrapper">
        <div class="header">
          <div id="file">
            <span class="label">File:</span>
            <span id="file-path"></span>
          </div>
          <div id="checker">
            <span class="label">Checker name:</span>
            <span id="checker-name"></span>
          </div>
          <div id="review-status-wrapper">
            <span class="label">Review status:</span>
            <span id="review-status"></span>
          </div>
        </div>
        <div id="editor"></div>
      </div>
    </div>
  </div>
  </body>
</html>
