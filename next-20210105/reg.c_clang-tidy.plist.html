<!DOCTYPE html>
<html>
  <head>
    <title>Plist HTML Viewer</title>

    <meta charset="UTF-8">

    <style type="text/css">
      .CodeMirror{font-family:monospace;height:300px;color:#000;direction:ltr}.CodeMirror-lines{padding:4px 0}.CodeMirror pre{padding:0 4px}.CodeMirror-gutter-filler,.CodeMirror-scrollbar-filler{background-color:#fff}.CodeMirror-gutters{border-right:1px solid #ddd;background-color:#f7f7f7;white-space:nowrap}.CodeMirror-linenumber{padding:0 3px 0 5px;min-width:20px;text-align:right;color:#999;white-space:nowrap}.CodeMirror-guttermarker{color:#000}.CodeMirror-guttermarker-subtle{color:#999}.CodeMirror-cursor{border-left:1px solid #000;border-right:none;width:0}.CodeMirror div.CodeMirror-secondarycursor{border-left:1px solid silver}.cm-fat-cursor .CodeMirror-cursor{width:auto;border:0!important;background:#7e7}.cm-fat-cursor div.CodeMirror-cursors{z-index:1}.cm-animate-fat-cursor{width:auto;border:0;-webkit-animation:blink 1.06s steps(1) infinite;-moz-animation:blink 1.06s steps(1) infinite;animation:blink 1.06s steps(1) infinite;background-color:#7e7}@-moz-keyframes blink{50%{background-color:transparent}}@-webkit-keyframes blink{50%{background-color:transparent}}@keyframes blink{50%{background-color:transparent}}.cm-tab{display:inline-block;text-decoration:inherit}.CodeMirror-rulers{position:absolute;left:0;right:0;top:-50px;bottom:-20px;overflow:hidden}.CodeMirror-ruler{border-left:1px solid #ccc;top:0;bottom:0;position:absolute}.cm-s-default .cm-header{color:#00f}.cm-s-default .cm-quote{color:#090}.cm-negative{color:#d44}.cm-positive{color:#292}.cm-header,.cm-strong{font-weight:700}.cm-em{font-style:italic}.cm-link{text-decoration:underline}.cm-strikethrough{text-decoration:line-through}.cm-s-default .cm-keyword{color:#708}.cm-s-default .cm-atom{color:#219}.cm-s-default .cm-number{color:#164}.cm-s-default .cm-def{color:#00f}.cm-s-default .cm-variable-2{color:#05a}.cm-s-default .cm-type,.cm-s-default .cm-variable-3{color:#085}.cm-s-default .cm-comment{color:#a50}.cm-s-default .cm-string{color:#a11}.cm-s-default .cm-string-2{color:#f50}.cm-s-default .cm-meta{color:#555}.cm-s-default .cm-qualifier{color:#555}.cm-s-default .cm-builtin{color:#30a}.cm-s-default .cm-bracket{color:#997}.cm-s-default .cm-tag{color:#170}.cm-s-default .cm-attribute{color:#00c}.cm-s-default .cm-hr{color:#999}.cm-s-default .cm-link{color:#00c}.cm-s-default .cm-error{color:red}.cm-invalidchar{color:red}.CodeMirror-composing{border-bottom:2px solid}div.CodeMirror span.CodeMirror-matchingbracket{color:#0f0}div.CodeMirror span.CodeMirror-nonmatchingbracket{color:#f22}.CodeMirror-matchingtag{background:rgba(255,150,0,.3)}.CodeMirror-activeline-background{background:#e8f2ff}.CodeMirror{position:relative;overflow:hidden;background:#fff}.CodeMirror-scroll{overflow:scroll!important;margin-bottom:-30px;margin-right:-30px;padding-bottom:30px;height:100%;outline:0;position:relative}.CodeMirror-sizer{position:relative;border-right:30px solid transparent}.CodeMirror-gutter-filler,.CodeMirror-hscrollbar,.CodeMirror-scrollbar-filler,.CodeMirror-vscrollbar{position:absolute;z-index:6;display:none}.CodeMirror-vscrollbar{right:0;top:0;overflow-x:hidden;overflow-y:scroll}.CodeMirror-hscrollbar{bottom:0;left:0;overflow-y:hidden;overflow-x:scroll}.CodeMirror-scrollbar-filler{right:0;bottom:0}.CodeMirror-gutter-filler{left:0;bottom:0}.CodeMirror-gutters{position:absolute;left:0;top:0;min-height:100%;z-index:3}.CodeMirror-gutter{white-space:normal;height:100%;display:inline-block;vertical-align:top;margin-bottom:-30px}.CodeMirror-gutter-wrapper{position:absolute;z-index:4;background:0 0!important;border:none!important}.CodeMirror-gutter-background{position:absolute;top:0;bottom:0;z-index:4}.CodeMirror-gutter-elt{position:absolute;cursor:default;z-index:4}.CodeMirror-gutter-wrapper ::selection{background-color:transparent}.CodeMirror-gutter-wrapper ::-moz-selection{background-color:transparent}.CodeMirror-lines{cursor:text;min-height:1px}.CodeMirror pre{-moz-border-radius:0;-webkit-border-radius:0;border-radius:0;border-width:0;background:0 0;font-family:inherit;font-size:inherit;margin:0;white-space:pre;word-wrap:normal;line-height:inherit;color:inherit;z-index:2;position:relative;overflow:visible;-webkit-tap-highlight-color:transparent;-webkit-font-variant-ligatures:contextual;font-variant-ligatures:contextual}.CodeMirror-wrap pre{word-wrap:break-word;white-space:pre-wrap;word-break:normal}.CodeMirror-linebackground{position:absolute;left:0;right:0;top:0;bottom:0;z-index:0}.CodeMirror-linewidget{position:relative;z-index:2;overflow:auto}.CodeMirror-rtl pre{direction:rtl}.CodeMirror-code{outline:0}.CodeMirror-gutter,.CodeMirror-gutters,.CodeMirror-linenumber,.CodeMirror-scroll,.CodeMirror-sizer{-moz-box-sizing:content-box;box-sizing:content-box}.CodeMirror-measure{position:absolute;width:100%;height:0;overflow:hidden;visibility:hidden}.CodeMirror-cursor{position:absolute;pointer-events:none}.CodeMirror-measure pre{position:static}div.CodeMirror-cursors{visibility:hidden;position:relative;z-index:3}div.CodeMirror-dragcursors{visibility:visible}.CodeMirror-focused div.CodeMirror-cursors{visibility:visible}.CodeMirror-selected{background:#d9d9d9}.CodeMirror-focused .CodeMirror-selected{background:#d7d4f0}.CodeMirror-crosshair{cursor:crosshair}.CodeMirror-line::selection,.CodeMirror-line>span::selection,.CodeMirror-line>span>span::selection{background:#d7d4f0}.CodeMirror-line::-moz-selection,.CodeMirror-line>span::-moz-selection,.CodeMirror-line>span>span::-moz-selection{background:#d7d4f0}.cm-searching{background-color:#ffa;background-color:rgba(255,255,0,.4)}.cm-force-border{padding-right:.1px}@media print{.CodeMirror div.CodeMirror-cursors{visibility:hidden}}.cm-tab-wrap-hack:after{content:''}span.CodeMirror-selectedtext{background:0 0}
/*# sourceMappingURL=codemirror.min.css.map */

      .severity-low {
  background-color: #669603;
}

.severity-low:after {
  content : 'L';
}

.severity-unspecified {
  background-color: #666666;
}

.severity-unspecified:after {
  content : 'U';
}

.severity-style {
  background-color: #9932cc;
}

.severity-style:after {
  content : 'S';
}

.severity-medium {
  background-color: #a9d323;
  color: black;
}

.severity-medium:after {
  content : 'M';
}

.severity-high {
  background-color: #ffa800;
}

.severity-high:after {
  content : 'H';
}

.severity-critical {
  background-color: #e92625;
}

.severity-critical:after {
  content : 'C';
}

i[class*="severity-"] {
  line-height: normal;
  text-transform: capitalize;
  font-size: 0.8em;
  font-weight: bold;
  color: white;
  display: inline-block;
  width: 16px;
  height: 16px;
  text-align: center;
  font-family: sans-serif;
}

      html, body {
  width: 100%;
  height: 100%;
  padding: 0px;
  margin: 0px;
}

div.container {
  padding: 10px;
}

#content {
  height: 100%;
  display: block;
  overflow: hidden;
}

#content > div {
  margin: 10px;
  overflow: hidden;
  border: 1px solid #ddd;
  border-radius: 3px;
  overflow: hidden;
  height: 97%;
}

.button {
  background-color: #f1f1f1;
  text-decoration: none;
  display: inline-block;
  padding: 8px 16px;
  color: black;
  cursor: pointer;
}

.button:hover {
  background-color: #ddd;
  color: black;
}

.review-status {
  color: white;
  text-align: center;
}

.review-status-confirmed {
  background-color: #e92625;
}

.review-status-false-positive {
  background-color: grey;
}

.review-status-intentional {
  background-color: #669603;
}

      div.container {
  width: 100%;
  height: 100%;
  padding: 0px;
}

#editor-wrapper {
  margin: 10px;
}

#side-bar {
  float: left;
  width: 260px;
  margin: 0px;
}

#report-nav ul {
  list-style-type: none;
  padding: 0;
  margin: 0;
  overflow-y: auto;
  height: 100%;
}

#report-nav ul > li {
  padding: .4em;
  background-color: #fff;
  border-bottom: 1px solid rgba(0,0,0,.125);
  text-align: left;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

#report-nav ul > li.active {
  background-color: #427ea9;
  color: white;
}

#report-nav ul > li:hover {
  background-color: #427ea9;
  color: white;
  cursor: pointer;
}

#report-nav ul a {
  text-decoration: none;
}

#report-nav i[class*="severity-"] {
  margin-right: 5px;
}

.header {
  border-bottom: 1px solid lightgrey;
  font-family: monospace;
  padding: 10px;
  background-color: #fafbfc;
  border-bottom: 1px solid #e1e4e8;
  border-top-left-radius: 2px;
  border-top-right-radius: 2px;
}

#report-nav .header {
  font-weight: bold;
}

#editor-wrapper .header > div {
  padding-top: 2px;
}

#file-path,
#checker-name {
  color: #195ea2;
}

#review-status {
  padding: 0px 5px;
}

#file-path {
  font-family: monospace;
}

.check-msg {
  display: inline-block;
  padding: 3px 6px;
  margin: 1px;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
  border-radius: 5px;
}

.check-msg.info {
  color: #00546f;
  background-color: #bfdfe9;
  border: 1px solid #87a8b3;
}

.check-msg.error {
  background-color: #f2dede;
  color: #a94442;
  border: 1px solid #ebcccc;
}

.check-msg.macro {
  background-color: #d7dac2;
  color: #4f5c6d;
  border: 1px solid #d7dac2;
}

.check-msg.note {
  background-color: #d7d7d7;
  color: #4f5c6d;
  border: 1px solid #bfbfbf;
}

.check-msg.current {
  border: 2px dashed #3692ff;
}

.check-msg .tag {
  padding: 1px 5px;
  text-align: center;
  border-radius: 2px;
  margin-right: 5px;
  text-decoration: inherit;
}

.check-msg .tag.macro {
  background-color: #83876a;
  color: white;
  text-transform: capitalize;
}

.check-msg .tag.note {
  background-color: #9299a1;
  color: white;
  text-transform: capitalize;
}

.checker-enum {
  color: white;
  padding: 1px 5px;
  text-align: center;
  border-radius: 25px;
  margin-right: 5px;
  text-decoration: inherit;
}

.checker-enum.info {
  background-color: #427ea9;
}

.checker-enum.error {
  background-color: #a94442;
}

.arrow {
  border: solid black;
  border-width: 0 3px 3px 0;
  display: inline-block;
  padding: 3px;
  cursor: pointer;
  margin: 0px 5px;
}

.arrow:hover {
  border: solid #437ea8;
  border-width: 0 3px 3px 0;
}

.left-arrow {
  transform: rotate(135deg);
  -webkit-transform: rotate(135deg);
}

.right-arrow {
  transform: rotate(-45deg);
  -webkit-transform: rotate(-45deg);
}

    </style>

    <script type="text/javascript">
      function setNonCompatibleBrowserMessage() {
  document.body.innerHTML =
    '<h2 style="margin-left: 20px;">Your browser is not compatible with CodeChecker Viewer!</h2> \
     <p style="margin-left: 20px;">The version required for the following browsers are:</p> \
     <ul style="margin-left: 20px;"> \
     <li>Internet Explorer: version 9 or newer</li> \
     <li>Firefox: version 22.0 or newer</li> \
     </ul>';
}

// http://stackoverflow.com/questions/5916900/how-can-you-detect-the-version-of-a-browser
var browserVersion = (function(){
  var ua = navigator.userAgent, tem,
    M = ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];

  if (/trident/i.test(M[1])) {
    tem = /\brv[ :]+(\d+)/g.exec(ua) || [];
    return 'IE ' + (tem[1] || '');
  }

  if (M[1] === 'Chrome') {
    tem = ua.match(/\b(OPR|Edge)\/(\d+)/);
    if (tem != null) return tem.slice(1).join(' ').replace('OPR', 'Opera');
  }

  M = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, '-?'];
  if ((tem = ua.match(/version\/(\d+)/i)) != null) M.splice(1, 1, tem[1]);
    return M.join(' ');
})();

var pos = browserVersion.indexOf(' ');
var browser = browserVersion.substr(0, pos);
var version = parseInt(browserVersion.substr(pos + 1));

var browserCompatible
  = browser === 'Firefox'
  ? version >= 22
  : browser === 'IE'
  ? version >= 9
  : true;


      /* MIT License

Copyright (C) 2017 by Marijn Haverbeke <marijnh@gmail.com> and others

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
 */
      !function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.CodeMirror=t()}(this,function(){"use strict";function e(e){return new RegExp("(^|\\s)"+e+"(?:$|\\s)\\s*")}function t(e){for(var t=e.childNodes.length;t>0;--t)e.removeChild(e.firstChild);return e}function r(e,r){return t(e).appendChild(r)}function n(e,t,r,n){var i=document.createElement(e);if(r&&(i.className=r),n&&(i.style.cssText=n),"string"==typeof t)i.appendChild(document.createTextNode(t));else if(t)for(var o=0;o<t.length;++o)i.appendChild(t[o]);return i}function i(e,t,r,i){var o=n(e,t,r,i);return o.setAttribute("role","presentation"),o}function o(e,t){if(3==t.nodeType&&(t=t.parentNode),e.contains)return e.contains(t);do{if(11==t.nodeType&&(t=t.host),t==e)return!0}while(t=t.parentNode)}function l(){var e;try{e=document.activeElement}catch(t){e=document.body||null}for(;e&&e.shadowRoot&&e.shadowRoot.activeElement;)e=e.shadowRoot.activeElement;return e}function s(t,r){var n=t.className;e(r).test(n)||(t.className+=(n?" ":"")+r)}function a(t,r){for(var n=t.split(" "),i=0;i<n.length;i++)n[i]&&!e(n[i]).test(r)&&(r+=" "+n[i]);return r}function u(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t)}}function c(e,t,r){t||(t={});for(var n in e)!e.hasOwnProperty(n)||!1===r&&t.hasOwnProperty(n)||(t[n]=e[n]);return t}function f(e,t,r,n,i){null==t&&-1==(t=e.search(/[^\s\u00a0]/))&&(t=e.length);for(var o=n||0,l=i||0;;){var s=e.indexOf("\t",o);if(s<0||s>=t)return l+(t-o);l+=s-o,l+=r-l%r,o=s+1}}function h(e,t){for(var r=0;r<e.length;++r)if(e[r]==t)return r;return-1}function d(e,t,r){for(var n=0,i=0;;){var o=e.indexOf("\t",n);-1==o&&(o=e.length);var l=o-n;if(o==e.length||i+l>=t)return n+Math.min(l,t-i);if(i+=o-n,i+=r-i%r,n=o+1,i>=t)return n}}function p(e){for(;Kl.length<=e;)Kl.push(g(Kl)+" ");return Kl[e]}function g(e){return e[e.length-1]}function v(e,t){for(var r=[],n=0;n<e.length;n++)r[n]=t(e[n],n);return r}function m(e,t,r){for(var n=0,i=r(t);n<e.length&&r(e[n])<=i;)n++;e.splice(n,0,t)}function y(){}function b(e,t){var r;return Object.create?r=Object.create(e):(y.prototype=e,r=new y),t&&c(t,r),r}function w(e){return/\w/.test(e)||e>""&&(e.toUpperCase()!=e.toLowerCase()||jl.test(e))}function x(e,t){return t?!!(t.source.indexOf("\\w")>-1&&w(e))||t.test(e):w(e)}function C(e){for(var t in e)if(e.hasOwnProperty(t)&&e[t])return!1;return!0}function S(e){return e.charCodeAt(0)>=768&&Xl.test(e)}function L(e,t,r){for(;(r<0?t>0:t<e.length)&&S(e.charAt(t));)t+=r;return t}function k(e,t,r){for(var n=t>r?-1:1;;){if(t==r)return t;var i=(t+r)/2,o=n<0?Math.ceil(i):Math.floor(i);if(o==t)return e(o)?t:r;e(o)?r=o:t=o+n}}function T(e,t,r){var o=this;this.input=r,o.scrollbarFiller=n("div",null,"CodeMirror-scrollbar-filler"),o.scrollbarFiller.setAttribute("cm-not-content","true"),o.gutterFiller=n("div",null,"CodeMirror-gutter-filler"),o.gutterFiller.setAttribute("cm-not-content","true"),o.lineDiv=i("div",null,"CodeMirror-code"),o.selectionDiv=n("div",null,null,"position: relative; z-index: 1"),o.cursorDiv=n("div",null,"CodeMirror-cursors"),o.measure=n("div",null,"CodeMirror-measure"),o.lineMeasure=n("div",null,"CodeMirror-measure"),o.lineSpace=i("div",[o.measure,o.lineMeasure,o.selectionDiv,o.cursorDiv,o.lineDiv],null,"position: relative; outline: none");var l=i("div",[o.lineSpace],"CodeMirror-lines");o.mover=n("div",[l],null,"position: relative"),o.sizer=n("div",[o.mover],"CodeMirror-sizer"),o.sizerWidth=null,o.heightForcer=n("div",null,null,"position: absolute; height: "+Rl+"px; width: 1px;"),o.gutters=n("div",null,"CodeMirror-gutters"),o.lineGutter=null,o.scroller=n("div",[o.sizer,o.heightForcer,o.gutters],"CodeMirror-scroll"),o.scroller.setAttribute("tabIndex","-1"),o.wrapper=n("div",[o.scrollbarFiller,o.gutterFiller,o.scroller],"CodeMirror"),gl&&vl<8&&(o.gutters.style.zIndex=-1,o.scroller.style.paddingRight=0),ml||fl&&Tl||(o.scroller.draggable=!0),e&&(e.appendChild?e.appendChild(o.wrapper):e(o.wrapper)),o.viewFrom=o.viewTo=t.first,o.reportedViewFrom=o.reportedViewTo=t.first,o.view=[],o.renderedView=null,o.externalMeasured=null,o.viewOffset=0,o.lastWrapHeight=o.lastWrapWidth=0,o.updateLineNumbers=null,o.nativeBarWidth=o.barHeight=o.barWidth=0,o.scrollbarsClipped=!1,o.lineNumWidth=o.lineNumInnerWidth=o.lineNumChars=null,o.alignWidgets=!1,o.cachedCharWidth=o.cachedTextHeight=o.cachedPaddingH=null,o.maxLine=null,o.maxLineLength=0,o.maxLineChanged=!1,o.wheelDX=o.wheelDY=o.wheelStartX=o.wheelStartY=null,o.shift=!1,o.selForContextMenu=null,o.activeTouch=null,r.init(o)}function M(e,t){if((t-=e.first)<0||t>=e.size)throw new Error("There is no line "+(t+e.first)+" in the document.");for(var r=e;!r.lines;)for(var n=0;;++n){var i=r.children[n],o=i.chunkSize();if(t<o){r=i;break}t-=o}return r.lines[t]}function N(e,t,r){var n=[],i=t.line;return e.iter(t.line,r.line+1,function(e){var o=e.text;i==r.line&&(o=o.slice(0,r.ch)),i==t.line&&(o=o.slice(t.ch)),n.push(o),++i}),n}function O(e,t,r){var n=[];return e.iter(t,r,function(e){n.push(e.text)}),n}function A(e,t){var r=t-e.height;if(r)for(var n=e;n;n=n.parent)n.height+=r}function W(e){if(null==e.parent)return null;for(var t=e.parent,r=h(t.lines,e),n=t.parent;n;t=n,n=n.parent)for(var i=0;n.children[i]!=t;++i)r+=n.children[i].chunkSize();return r+t.first}function D(e,t){var r=e.first;e:do{for(var n=0;n<e.children.length;++n){var i=e.children[n],o=i.height;if(t<o){e=i;continue e}t-=o,r+=i.chunkSize()}return r}while(!e.lines);for(var l=0;l<e.lines.length;++l){var s=e.lines[l].height;if(t<s)break;t-=s}return r+l}function H(e,t){return t>=e.first&&t<e.first+e.size}function F(e,t){return String(e.lineNumberFormatter(t+e.firstLineNumber))}function E(e,t,r){if(void 0===r&&(r=null),!(this instanceof E))return new E(e,t,r);this.line=e,this.ch=t,this.sticky=r}function P(e,t){return e.line-t.line||e.ch-t.ch}function I(e,t){return e.sticky==t.sticky&&0==P(e,t)}function z(e){return E(e.line,e.ch)}function R(e,t){return P(e,t)<0?t:e}function B(e,t){return P(e,t)<0?e:t}function G(e,t){return Math.max(e.first,Math.min(t,e.first+e.size-1))}function U(e,t){if(t.line<e.first)return E(e.first,0);var r=e.first+e.size-1;return t.line>r?E(r,M(e,r).text.length):V(t,M(e,t.line).text.length)}function V(e,t){var r=e.ch;return null==r||r>t?E(e.line,t):r<0?E(e.line,0):e}function K(e,t){for(var r=[],n=0;n<t.length;n++)r[n]=U(e,t[n]);return r}function j(){Yl=!0}function X(){_l=!0}function Y(e,t,r){this.marker=e,this.from=t,this.to=r}function _(e,t){if(e)for(var r=0;r<e.length;++r){var n=e[r];if(n.marker==t)return n}}function $(e,t){for(var r,n=0;n<e.length;++n)e[n]!=t&&(r||(r=[])).push(e[n]);return r}function q(e,t){e.markedSpans=e.markedSpans?e.markedSpans.concat([t]):[t],t.marker.attachLine(e)}function Z(e,t,r){var n;if(e)for(var i=0;i<e.length;++i){var o=e[i],l=o.marker;if(null==o.from||(l.inclusiveLeft?o.from<=t:o.from<t)||o.from==t&&"bookmark"==l.type&&(!r||!o.marker.insertLeft)){var s=null==o.to||(l.inclusiveRight?o.to>=t:o.to>t);(n||(n=[])).push(new Y(l,o.from,s?null:o.to))}}return n}function Q(e,t,r){var n;if(e)for(var i=0;i<e.length;++i){var o=e[i],l=o.marker;if(null==o.to||(l.inclusiveRight?o.to>=t:o.to>t)||o.from==t&&"bookmark"==l.type&&(!r||o.marker.insertLeft)){var s=null==o.from||(l.inclusiveLeft?o.from<=t:o.from<t);(n||(n=[])).push(new Y(l,s?null:o.from-t,null==o.to?null:o.to-t))}}return n}function J(e,t){if(t.full)return null;var r=H(e,t.from.line)&&M(e,t.from.line).markedSpans,n=H(e,t.to.line)&&M(e,t.to.line).markedSpans;if(!r&&!n)return null;var i=t.from.ch,o=t.to.ch,l=0==P(t.from,t.to),s=Z(r,i,l),a=Q(n,o,l),u=1==t.text.length,c=g(t.text).length+(u?i:0);if(s)for(var f=0;f<s.length;++f){var h=s[f];if(null==h.to){var d=_(a,h.marker);d?u&&(h.to=null==d.to?null:d.to+c):h.to=i}}if(a)for(var p=0;p<a.length;++p){var v=a[p];null!=v.to&&(v.to+=c),null==v.from?_(s,v.marker)||(v.from=c,u&&(s||(s=[])).push(v)):(v.from+=c,u&&(s||(s=[])).push(v))}s&&(s=ee(s)),a&&a!=s&&(a=ee(a));var m=[s];if(!u){var y,b=t.text.length-2;if(b>0&&s)for(var w=0;w<s.length;++w)null==s[w].to&&(y||(y=[])).push(new Y(s[w].marker,null,null));for(var x=0;x<b;++x)m.push(y);m.push(a)}return m}function ee(e){for(var t=0;t<e.length;++t){var r=e[t];null!=r.from&&r.from==r.to&&!1!==r.marker.clearWhenEmpty&&e.splice(t--,1)}return e.length?e:null}function te(e,t,r){var n=null;if(e.iter(t.line,r.line+1,function(e){if(e.markedSpans)for(var t=0;t<e.markedSpans.length;++t){var r=e.markedSpans[t].marker;!r.readOnly||n&&-1!=h(n,r)||(n||(n=[])).push(r)}}),!n)return null;for(var i=[{from:t,to:r}],o=0;o<n.length;++o)for(var l=n[o],s=l.find(0),a=0;a<i.length;++a){var u=i[a];if(!(P(u.to,s.from)<0||P(u.from,s.to)>0)){var c=[a,1],f=P(u.from,s.from),d=P(u.to,s.to);(f<0||!l.inclusiveLeft&&!f)&&c.push({from:u.from,to:s.from}),(d>0||!l.inclusiveRight&&!d)&&c.push({from:s.to,to:u.to}),i.splice.apply(i,c),a+=c.length-3}}return i}function re(e){var t=e.markedSpans;if(t){for(var r=0;r<t.length;++r)t[r].marker.detachLine(e);e.markedSpans=null}}function ne(e,t){if(t){for(var r=0;r<t.length;++r)t[r].marker.attachLine(e);e.markedSpans=t}}function ie(e){return e.inclusiveLeft?-1:0}function oe(e){return e.inclusiveRight?1:0}function le(e,t){var r=e.lines.length-t.lines.length;if(0!=r)return r;var n=e.find(),i=t.find(),o=P(n.from,i.from)||ie(e)-ie(t);if(o)return-o;var l=P(n.to,i.to)||oe(e)-oe(t);return l||t.id-e.id}function se(e,t){var r,n=_l&&e.markedSpans;if(n)for(var i=void 0,o=0;o<n.length;++o)(i=n[o]).marker.collapsed&&null==(t?i.from:i.to)&&(!r||le(r,i.marker)<0)&&(r=i.marker);return r}function ae(e){return se(e,!0)}function ue(e){return se(e,!1)}function ce(e,t,r,n,i){var o=M(e,t),l=_l&&o.markedSpans;if(l)for(var s=0;s<l.length;++s){var a=l[s];if(a.marker.collapsed){var u=a.marker.find(0),c=P(u.from,r)||ie(a.marker)-ie(i),f=P(u.to,n)||oe(a.marker)-oe(i);if(!(c>=0&&f<=0||c<=0&&f>=0)&&(c<=0&&(a.marker.inclusiveRight&&i.inclusiveLeft?P(u.to,r)>=0:P(u.to,r)>0)||c>=0&&(a.marker.inclusiveRight&&i.inclusiveLeft?P(u.from,n)<=0:P(u.from,n)<0)))return!0}}}function fe(e){for(var t;t=ae(e);)e=t.find(-1,!0).line;return e}function he(e){for(var t;t=ue(e);)e=t.find(1,!0).line;return e}function de(e){for(var t,r;t=ue(e);)e=t.find(1,!0).line,(r||(r=[])).push(e);return r}function pe(e,t){var r=M(e,t),n=fe(r);return r==n?t:W(n)}function ge(e,t){if(t>e.lastLine())return t;var r,n=M(e,t);if(!ve(e,n))return t;for(;r=ue(n);)n=r.find(1,!0).line;return W(n)+1}function ve(e,t){var r=_l&&t.markedSpans;if(r)for(var n=void 0,i=0;i<r.length;++i)if((n=r[i]).marker.collapsed){if(null==n.from)return!0;if(!n.marker.widgetNode&&0==n.from&&n.marker.inclusiveLeft&&me(e,t,n))return!0}}function me(e,t,r){if(null==r.to){var n=r.marker.find(1,!0);return me(e,n.line,_(n.line.markedSpans,r.marker))}if(r.marker.inclusiveRight&&r.to==t.text.length)return!0;for(var i=void 0,o=0;o<t.markedSpans.length;++o)if((i=t.markedSpans[o]).marker.collapsed&&!i.marker.widgetNode&&i.from==r.to&&(null==i.to||i.to!=r.from)&&(i.marker.inclusiveLeft||r.marker.inclusiveRight)&&me(e,t,i))return!0}function ye(e){for(var t=0,r=(e=fe(e)).parent,n=0;n<r.lines.length;++n){var i=r.lines[n];if(i==e)break;t+=i.height}for(var o=r.parent;o;r=o,o=r.parent)for(var l=0;l<o.children.length;++l){var s=o.children[l];if(s==r)break;t+=s.height}return t}function be(e){if(0==e.height)return 0;for(var t,r=e.text.length,n=e;t=ae(n);){var i=t.find(0,!0);n=i.from.line,r+=i.from.ch-i.to.ch}for(n=e;t=ue(n);){var o=t.find(0,!0);r-=n.text.length-o.from.ch,r+=(n=o.to.line).text.length-o.to.ch}return r}function we(e){var t=e.display,r=e.doc;t.maxLine=M(r,r.first),t.maxLineLength=be(t.maxLine),t.maxLineChanged=!0,r.iter(function(e){var r=be(e);r>t.maxLineLength&&(t.maxLineLength=r,t.maxLine=e)})}function xe(e,t,r,n){if(!e)return n(t,r,"ltr",0);for(var i=!1,o=0;o<e.length;++o){var l=e[o];(l.from<r&&l.to>t||t==r&&l.to==t)&&(n(Math.max(l.from,t),Math.min(l.to,r),1==l.level?"rtl":"ltr",o),i=!0)}i||n(t,r,"ltr")}function Ce(e,t,r){var n;$l=null;for(var i=0;i<e.length;++i){var o=e[i];if(o.from<t&&o.to>t)return i;o.to==t&&(o.from!=o.to&&"before"==r?n=i:$l=i),o.from==t&&(o.from!=o.to&&"before"!=r?n=i:$l=i)}return null!=n?n:$l}function Se(e,t){var r=e.order;return null==r&&(r=e.order=ql(e.text,t)),r}function Le(e,t){return e._handlers&&e._handlers[t]||Zl}function ke(e,t,r){if(e.removeEventListener)e.removeEventListener(t,r,!1);else if(e.detachEvent)e.detachEvent("on"+t,r);else{var n=e._handlers,i=n&&n[t];if(i){var o=h(i,r);o>-1&&(n[t]=i.slice(0,o).concat(i.slice(o+1)))}}}function Te(e,t){var r=Le(e,t);if(r.length)for(var n=Array.prototype.slice.call(arguments,2),i=0;i<r.length;++i)r[i].apply(null,n)}function Me(e,t,r){return"string"==typeof t&&(t={type:t,preventDefault:function(){this.defaultPrevented=!0}}),Te(e,r||t.type,e,t),He(t)||t.codemirrorIgnore}function Ne(e){var t=e._handlers&&e._handlers.cursorActivity;if(t)for(var r=e.curOp.cursorActivityHandlers||(e.curOp.cursorActivityHandlers=[]),n=0;n<t.length;++n)-1==h(r,t[n])&&r.push(t[n])}function Oe(e,t){return Le(e,t).length>0}function Ae(e){e.prototype.on=function(e,t){Ql(this,e,t)},e.prototype.off=function(e,t){ke(this,e,t)}}function We(e){e.preventDefault?e.preventDefault():e.returnValue=!1}function De(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}function He(e){return null!=e.defaultPrevented?e.defaultPrevented:0==e.returnValue}function Fe(e){We(e),De(e)}function Ee(e){return e.target||e.srcElement}function Pe(e){var t=e.which;return null==t&&(1&e.button?t=1:2&e.button?t=3:4&e.button&&(t=2)),Ml&&e.ctrlKey&&1==t&&(t=3),t}function Ie(e){if(null==Il){var t=n("span","​");r(e,n("span",[t,document.createTextNode("x")])),0!=e.firstChild.offsetHeight&&(Il=t.offsetWidth<=1&&t.offsetHeight>2&&!(gl&&vl<8))}var i=Il?n("span","​"):n("span"," ",null,"display: inline-block; width: 1px; margin-right: -1px");return i.setAttribute("cm-text",""),i}function ze(e){if(null!=zl)return zl;var n=r(e,document.createTextNode("AخA")),i=Wl(n,0,1).getBoundingClientRect(),o=Wl(n,1,2).getBoundingClientRect();return t(e),!(!i||i.left==i.right)&&(zl=o.right-i.right<3)}function Re(e){if(null!=ns)return ns;var t=r(e,n("span","x")),i=t.getBoundingClientRect(),o=Wl(t,0,1).getBoundingClientRect();return ns=Math.abs(i.left-o.left)>1}function Be(e,t){arguments.length>2&&(t.dependencies=Array.prototype.slice.call(arguments,2)),is[e]=t}function Ge(e){if("string"==typeof e&&os.hasOwnProperty(e))e=os[e];else if(e&&"string"==typeof e.name&&os.hasOwnProperty(e.name)){var t=os[e.name];"string"==typeof t&&(t={name:t}),(e=b(t,e)).name=t.name}else{if("string"==typeof e&&/^[\w\-]+\/[\w\-]+\+xml$/.test(e))return Ge("application/xml");if("string"==typeof e&&/^[\w\-]+\/[\w\-]+\+json$/.test(e))return Ge("application/json")}return"string"==typeof e?{name:e}:e||{name:"null"}}function Ue(e,t){t=Ge(t);var r=is[t.name];if(!r)return Ue(e,"text/plain");var n=r(e,t);if(ls.hasOwnProperty(t.name)){var i=ls[t.name];for(var o in i)i.hasOwnProperty(o)&&(n.hasOwnProperty(o)&&(n["_"+o]=n[o]),n[o]=i[o])}if(n.name=t.name,t.helperType&&(n.helperType=t.helperType),t.modeProps)for(var l in t.modeProps)n[l]=t.modeProps[l];return n}function Ve(e,t){c(t,ls.hasOwnProperty(e)?ls[e]:ls[e]={})}function Ke(e,t){if(!0===t)return t;if(e.copyState)return e.copyState(t);var r={};for(var n in t){var i=t[n];i instanceof Array&&(i=i.concat([])),r[n]=i}return r}function je(e,t){for(var r;e.innerMode&&(r=e.innerMode(t))&&r.mode!=e;)t=r.state,e=r.mode;return r||{mode:e,state:t}}function Xe(e,t,r){return!e.startState||e.startState(t,r)}function Ye(e,t,r,n){var i=[e.state.modeGen],o={};tt(e,t.text,e.doc.mode,r,function(e,t){return i.push(e,t)},o,n);for(var l=r.state,s=0;s<e.state.overlays.length;++s)!function(n){var l=e.state.overlays[n],s=1,a=0;r.state=!0,tt(e,t.text,l.mode,r,function(e,t){for(var r=s;a<e;){var n=i[s];n>e&&i.splice(s,1,e,i[s+1],n),s+=2,a=Math.min(e,n)}if(t)if(l.opaque)i.splice(r,s-r,e,"overlay "+t),s=r+2;else for(;r<s;r+=2){var o=i[r+1];i[r+1]=(o?o+" ":"")+"overlay "+t}},o)}(s);return r.state=l,{styles:i,classes:o.bgClass||o.textClass?o:null}}function _e(e,t,r){if(!t.styles||t.styles[0]!=e.state.modeGen){var n=$e(e,W(t)),i=t.text.length>e.options.maxHighlightLength&&Ke(e.doc.mode,n.state),o=Ye(e,t,n);i&&(n.state=i),t.stateAfter=n.save(!i),t.styles=o.styles,o.classes?t.styleClasses=o.classes:t.styleClasses&&(t.styleClasses=null),r===e.doc.highlightFrontier&&(e.doc.modeFrontier=Math.max(e.doc.modeFrontier,++e.doc.highlightFrontier))}return t.styles}function $e(e,t,r){var n=e.doc,i=e.display;if(!n.mode.startState)return new us(n,!0,t);var o=rt(e,t,r),l=o>n.first&&M(n,o-1).stateAfter,s=l?us.fromSaved(n,l,o):new us(n,Xe(n.mode),o);return n.iter(o,t,function(r){qe(e,r.text,s);var n=s.line;r.stateAfter=n==t-1||n%5==0||n>=i.viewFrom&&n<i.viewTo?s.save():null,s.nextLine()}),r&&(n.modeFrontier=s.line),s}function qe(e,t,r,n){var i=e.doc.mode,o=new ss(t,e.options.tabSize,r);for(o.start=o.pos=n||0,""==t&&Ze(i,r.state);!o.eol();)Qe(i,o,r.state),o.start=o.pos}function Ze(e,t){if(e.blankLine)return e.blankLine(t);if(e.innerMode){var r=je(e,t);return r.mode.blankLine?r.mode.blankLine(r.state):void 0}}function Qe(e,t,r,n){for(var i=0;i<10;i++){n&&(n[0]=je(e,r).mode);var o=e.token(t,r);if(t.pos>t.start)return o}throw new Error("Mode "+e.name+" failed to advance stream.")}function Je(e,t,r,n){var i,o,l=e.doc,s=l.mode,a=M(l,(t=U(l,t)).line),u=$e(e,t.line,r),c=new ss(a.text,e.options.tabSize,u);for(n&&(o=[]);(n||c.pos<t.ch)&&!c.eol();)c.start=c.pos,i=Qe(s,c,u.state),n&&o.push(new cs(c,i,Ke(l.mode,u.state)));return n?o:new cs(c,i,u.state)}function et(e,t){if(e)for(;;){var r=e.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!r)break;e=e.slice(0,r.index)+e.slice(r.index+r[0].length);var n=r[1]?"bgClass":"textClass";null==t[n]?t[n]=r[2]:new RegExp("(?:^|s)"+r[2]+"(?:$|s)").test(t[n])||(t[n]+=" "+r[2])}return e}function tt(e,t,r,n,i,o,l){var s=r.flattenSpans;null==s&&(s=e.options.flattenSpans);var a,u=0,c=null,f=new ss(t,e.options.tabSize,n),h=e.options.addModeClass&&[null];for(""==t&&et(Ze(r,n.state),o);!f.eol();){if(f.pos>e.options.maxHighlightLength?(s=!1,l&&qe(e,t,n,f.pos),f.pos=t.length,a=null):a=et(Qe(r,f,n.state,h),o),h){var d=h[0].name;d&&(a="m-"+(a?d+" "+a:d))}if(!s||c!=a){for(;u<f.start;)i(u=Math.min(f.start,u+5e3),c);c=a}f.start=f.pos}for(;u<f.pos;){var p=Math.min(f.pos,u+5e3);i(p,c),u=p}}function rt(e,t,r){for(var n,i,o=e.doc,l=r?-1:t-(e.doc.mode.innerMode?1e3:100),s=t;s>l;--s){if(s<=o.first)return o.first;var a=M(o,s-1),u=a.stateAfter;if(u&&(!r||s+(u instanceof as?u.lookAhead:0)<=o.modeFrontier))return s;var c=f(a.text,null,e.options.tabSize);(null==i||n>c)&&(i=s-1,n=c)}return i}function nt(e,t){if(e.modeFrontier=Math.min(e.modeFrontier,t),!(e.highlightFrontier<t-10)){for(var r=e.first,n=t-1;n>r;n--){var i=M(e,n).stateAfter;if(i&&(!(i instanceof as)||n+i.lookAhead<t)){r=n+1;break}}e.highlightFrontier=Math.min(e.highlightFrontier,r)}}function it(e,t,r,n){e.text=t,e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null),null!=e.order&&(e.order=null),re(e),ne(e,r);var i=n?n(e):1;i!=e.height&&A(e,i)}function ot(e){e.parent=null,re(e)}function lt(e,t){if(!e||/^\s*$/.test(e))return null;var r=t.addModeClass?ps:ds;return r[e]||(r[e]=e.replace(/\S+/g,"cm-$&"))}function st(e,t){var r=i("span",null,null,ml?"padding-right: .1px":null),n={pre:i("pre",[r],"CodeMirror-line"),content:r,col:0,pos:0,cm:e,trailingSpace:!1,splitSpaces:(gl||ml)&&e.getOption("lineWrapping")};t.measure={};for(var o=0;o<=(t.rest?t.rest.length:0);o++){var l=o?t.rest[o-1]:t.line,s=void 0;n.pos=0,n.addToken=ut,ze(e.display.measure)&&(s=Se(l,e.doc.direction))&&(n.addToken=ft(n.addToken,s)),n.map=[],dt(l,n,_e(e,l,t!=e.display.externalMeasured&&W(l))),l.styleClasses&&(l.styleClasses.bgClass&&(n.bgClass=a(l.styleClasses.bgClass,n.bgClass||"")),l.styleClasses.textClass&&(n.textClass=a(l.styleClasses.textClass,n.textClass||""))),0==n.map.length&&n.map.push(0,0,n.content.appendChild(Ie(e.display.measure))),0==o?(t.measure.map=n.map,t.measure.cache={}):((t.measure.maps||(t.measure.maps=[])).push(n.map),(t.measure.caches||(t.measure.caches=[])).push({}))}if(ml){var u=n.content.lastChild;(/\bcm-tab\b/.test(u.className)||u.querySelector&&u.querySelector(".cm-tab"))&&(n.content.className="cm-tab-wrap-hack")}return Te(e,"renderLine",e,t.line,n.pre),n.pre.className&&(n.textClass=a(n.pre.className,n.textClass||"")),n}function at(e){var t=n("span","•","cm-invalidchar");return t.title="\\u"+e.charCodeAt(0).toString(16),t.setAttribute("aria-label",t.title),t}function ut(e,t,r,i,o,l,s){if(t){var a,u=e.splitSpaces?ct(t,e.trailingSpace):t,c=e.cm.state.specialChars,f=!1;if(c.test(t)){a=document.createDocumentFragment();for(var h=0;;){c.lastIndex=h;var d=c.exec(t),g=d?d.index-h:t.length-h;if(g){var v=document.createTextNode(u.slice(h,h+g));gl&&vl<9?a.appendChild(n("span",[v])):a.appendChild(v),e.map.push(e.pos,e.pos+g,v),e.col+=g,e.pos+=g}if(!d)break;h+=g+1;var m=void 0;if("\t"==d[0]){var y=e.cm.options.tabSize,b=y-e.col%y;(m=a.appendChild(n("span",p(b),"cm-tab"))).setAttribute("role","presentation"),m.setAttribute("cm-text","\t"),e.col+=b}else"\r"==d[0]||"\n"==d[0]?((m=a.appendChild(n("span","\r"==d[0]?"␍":"␤","cm-invalidchar"))).setAttribute("cm-text",d[0]),e.col+=1):((m=e.cm.options.specialCharPlaceholder(d[0])).setAttribute("cm-text",d[0]),gl&&vl<9?a.appendChild(n("span",[m])):a.appendChild(m),e.col+=1);e.map.push(e.pos,e.pos+1,m),e.pos++}}else e.col+=t.length,a=document.createTextNode(u),e.map.push(e.pos,e.pos+t.length,a),gl&&vl<9&&(f=!0),e.pos+=t.length;if(e.trailingSpace=32==u.charCodeAt(t.length-1),r||i||o||f||s){var w=r||"";i&&(w+=i),o&&(w+=o);var x=n("span",[a],w,s);return l&&(x.title=l),e.content.appendChild(x)}e.content.appendChild(a)}}function ct(e,t){if(e.length>1&&!/  /.test(e))return e;for(var r=t,n="",i=0;i<e.length;i++){var o=e.charAt(i);" "!=o||!r||i!=e.length-1&&32!=e.charCodeAt(i+1)||(o=" "),n+=o,r=" "==o}return n}function ft(e,t){return function(r,n,i,o,l,s,a){i=i?i+" cm-force-border":"cm-force-border";for(var u=r.pos,c=u+n.length;;){for(var f=void 0,h=0;h<t.length&&!((f=t[h]).to>u&&f.from<=u);h++);if(f.to>=c)return e(r,n,i,o,l,s,a);e(r,n.slice(0,f.to-u),i,o,null,s,a),o=null,n=n.slice(f.to-u),u=f.to}}}function ht(e,t,r,n){var i=!n&&r.widgetNode;i&&e.map.push(e.pos,e.pos+t,i),!n&&e.cm.display.input.needsContentAttribute&&(i||(i=e.content.appendChild(document.createElement("span"))),i.setAttribute("cm-marker",r.id)),i&&(e.cm.display.input.setUneditable(i),e.content.appendChild(i)),e.pos+=t,e.trailingSpace=!1}function dt(e,t,r){var n=e.markedSpans,i=e.text,o=0;if(n)for(var l,s,a,u,c,f,h,d=i.length,p=0,g=1,v="",m=0;;){if(m==p){a=u=c=f=s="",h=null,m=1/0;for(var y=[],b=void 0,w=0;w<n.length;++w){var x=n[w],C=x.marker;"bookmark"==C.type&&x.from==p&&C.widgetNode?y.push(C):x.from<=p&&(null==x.to||x.to>p||C.collapsed&&x.to==p&&x.from==p)?(null!=x.to&&x.to!=p&&m>x.to&&(m=x.to,u=""),C.className&&(a+=" "+C.className),C.css&&(s=(s?s+";":"")+C.css),C.startStyle&&x.from==p&&(c+=" "+C.startStyle),C.endStyle&&x.to==m&&(b||(b=[])).push(C.endStyle,x.to),C.title&&!f&&(f=C.title),C.collapsed&&(!h||le(h.marker,C)<0)&&(h=x)):x.from>p&&m>x.from&&(m=x.from)}if(b)for(var S=0;S<b.length;S+=2)b[S+1]==m&&(u+=" "+b[S]);if(!h||h.from==p)for(var L=0;L<y.length;++L)ht(t,0,y[L]);if(h&&(h.from||0)==p){if(ht(t,(null==h.to?d+1:h.to)-p,h.marker,null==h.from),null==h.to)return;h.to==p&&(h=!1)}}if(p>=d)break;for(var k=Math.min(d,m);;){if(v){var T=p+v.length;if(!h){var M=T>k?v.slice(0,k-p):v;t.addToken(t,M,l?l+a:a,c,p+M.length==m?u:"",f,s)}if(T>=k){v=v.slice(k-p),p=k;break}p=T,c=""}v=i.slice(o,o=r[g++]),l=lt(r[g++],t.cm.options)}}else for(var N=1;N<r.length;N+=2)t.addToken(t,i.slice(o,o=r[N]),lt(r[N+1],t.cm.options))}function pt(e,t,r){this.line=t,this.rest=de(t),this.size=this.rest?W(g(this.rest))-r+1:1,this.node=this.text=null,this.hidden=ve(e,t)}function gt(e,t,r){for(var n,i=[],o=t;o<r;o=n){var l=new pt(e.doc,M(e.doc,o),o);n=o+l.size,i.push(l)}return i}function vt(e){gs?gs.ops.push(e):e.ownsGroup=gs={ops:[e],delayedCallbacks:[]}}function mt(e){var t=e.delayedCallbacks,r=0;do{for(;r<t.length;r++)t[r].call(null);for(var n=0;n<e.ops.length;n++){var i=e.ops[n];if(i.cursorActivityHandlers)for(;i.cursorActivityCalled<i.cursorActivityHandlers.length;)i.cursorActivityHandlers[i.cursorActivityCalled++].call(null,i.cm)}}while(r<t.length)}function yt(e,t){var r=e.ownsGroup;if(r)try{mt(r)}finally{gs=null,t(r)}}function bt(e,t){var r=Le(e,t);if(r.length){var n,i=Array.prototype.slice.call(arguments,2);gs?n=gs.delayedCallbacks:vs?n=vs:(n=vs=[],setTimeout(wt,0));for(var o=0;o<r.length;++o)!function(e){n.push(function(){return r[e].apply(null,i)})}(o)}}function wt(){var e=vs;vs=null;for(var t=0;t<e.length;++t)e[t]()}function xt(e,t,r,n){for(var i=0;i<t.changes.length;i++){var o=t.changes[i];"text"==o?kt(e,t):"gutter"==o?Mt(e,t,r,n):"class"==o?Tt(e,t):"widget"==o&&Nt(e,t,n)}t.changes=null}function Ct(e){return e.node==e.text&&(e.node=n("div",null,null,"position: relative"),e.text.parentNode&&e.text.parentNode.replaceChild(e.node,e.text),e.node.appendChild(e.text),gl&&vl<8&&(e.node.style.zIndex=2)),e.node}function St(e,t){var r=t.bgClass?t.bgClass+" "+(t.line.bgClass||""):t.line.bgClass;if(r&&(r+=" CodeMirror-linebackground"),t.background)r?t.background.className=r:(t.background.parentNode.removeChild(t.background),t.background=null);else if(r){var i=Ct(t);t.background=i.insertBefore(n("div",null,r),i.firstChild),e.display.input.setUneditable(t.background)}}function Lt(e,t){var r=e.display.externalMeasured;return r&&r.line==t.line?(e.display.externalMeasured=null,t.measure=r.measure,r.built):st(e,t)}function kt(e,t){var r=t.text.className,n=Lt(e,t);t.text==t.node&&(t.node=n.pre),t.text.parentNode.replaceChild(n.pre,t.text),t.text=n.pre,n.bgClass!=t.bgClass||n.textClass!=t.textClass?(t.bgClass=n.bgClass,t.textClass=n.textClass,Tt(e,t)):r&&(t.text.className=r)}function Tt(e,t){St(e,t),t.line.wrapClass?Ct(t).className=t.line.wrapClass:t.node!=t.text&&(t.node.className="");var r=t.textClass?t.textClass+" "+(t.line.textClass||""):t.line.textClass;t.text.className=r||""}function Mt(e,t,r,i){if(t.gutter&&(t.node.removeChild(t.gutter),t.gutter=null),t.gutterBackground&&(t.node.removeChild(t.gutterBackground),t.gutterBackground=null),t.line.gutterClass){var o=Ct(t);t.gutterBackground=n("div",null,"CodeMirror-gutter-background "+t.line.gutterClass,"left: "+(e.options.fixedGutter?i.fixedPos:-i.gutterTotalWidth)+"px; width: "+i.gutterTotalWidth+"px"),e.display.input.setUneditable(t.gutterBackground),o.insertBefore(t.gutterBackground,t.text)}var l=t.line.gutterMarkers;if(e.options.lineNumbers||l){var s=Ct(t),a=t.gutter=n("div",null,"CodeMirror-gutter-wrapper","left: "+(e.options.fixedGutter?i.fixedPos:-i.gutterTotalWidth)+"px");if(e.display.input.setUneditable(a),s.insertBefore(a,t.text),t.line.gutterClass&&(a.className+=" "+t.line.gutterClass),!e.options.lineNumbers||l&&l["CodeMirror-linenumbers"]||(t.lineNumber=a.appendChild(n("div",F(e.options,r),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+i.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+e.display.lineNumInnerWidth+"px"))),l)for(var u=0;u<e.options.gutters.length;++u){var c=e.options.gutters[u],f=l.hasOwnProperty(c)&&l[c];f&&a.appendChild(n("div",[f],"CodeMirror-gutter-elt","left: "+i.gutterLeft[c]+"px; width: "+i.gutterWidth[c]+"px"))}}}function Nt(e,t,r){t.alignable&&(t.alignable=null);for(var n=t.node.firstChild,i=void 0;n;n=i)i=n.nextSibling,"CodeMirror-linewidget"==n.className&&t.node.removeChild(n);At(e,t,r)}function Ot(e,t,r,n){var i=Lt(e,t);return t.text=t.node=i.pre,i.bgClass&&(t.bgClass=i.bgClass),i.textClass&&(t.textClass=i.textClass),Tt(e,t),Mt(e,t,r,n),At(e,t,n),t.node}function At(e,t,r){if(Wt(e,t.line,t,r,!0),t.rest)for(var n=0;n<t.rest.length;n++)Wt(e,t.rest[n],t,r,!1)}function Wt(e,t,r,i,o){if(t.widgets)for(var l=Ct(r),s=0,a=t.widgets;s<a.length;++s){var u=a[s],c=n("div",[u.node],"CodeMirror-linewidget");u.handleMouseEvents||c.setAttribute("cm-ignore-events","true"),Dt(u,c,r,i),e.display.input.setUneditable(c),o&&u.above?l.insertBefore(c,r.gutter||r.text):l.appendChild(c),bt(u,"redraw")}}function Dt(e,t,r,n){if(e.noHScroll){(r.alignable||(r.alignable=[])).push(t);var i=n.wrapperWidth;t.style.left=n.fixedPos+"px",e.coverGutter||(i-=n.gutterTotalWidth,t.style.paddingLeft=n.gutterTotalWidth+"px"),t.style.width=i+"px"}e.coverGutter&&(t.style.zIndex=5,t.style.position="relative",e.noHScroll||(t.style.marginLeft=-n.gutterTotalWidth+"px"))}function Ht(e){if(null!=e.height)return e.height;var t=e.doc.cm;if(!t)return 0;if(!o(document.body,e.node)){var i="position: relative;";e.coverGutter&&(i+="margin-left: -"+t.display.gutters.offsetWidth+"px;"),e.noHScroll&&(i+="width: "+t.display.wrapper.clientWidth+"px;"),r(t.display.measure,n("div",[e.node],null,i))}return e.height=e.node.parentNode.offsetHeight}function Ft(e,t){for(var r=Ee(t);r!=e.wrapper;r=r.parentNode)if(!r||1==r.nodeType&&"true"==r.getAttribute("cm-ignore-events")||r.parentNode==e.sizer&&r!=e.mover)return!0}function Et(e){return e.lineSpace.offsetTop}function Pt(e){return e.mover.offsetHeight-e.lineSpace.offsetHeight}function It(e){if(e.cachedPaddingH)return e.cachedPaddingH;var t=r(e.measure,n("pre","x")),i=window.getComputedStyle?window.getComputedStyle(t):t.currentStyle,o={left:parseInt(i.paddingLeft),right:parseInt(i.paddingRight)};return isNaN(o.left)||isNaN(o.right)||(e.cachedPaddingH=o),o}function zt(e){return Rl-e.display.nativeBarWidth}function Rt(e){return e.display.scroller.clientWidth-zt(e)-e.display.barWidth}function Bt(e){return e.display.scroller.clientHeight-zt(e)-e.display.barHeight}function Gt(e,t,r){var n=e.options.lineWrapping,i=n&&Rt(e);if(!t.measure.heights||n&&t.measure.width!=i){var o=t.measure.heights=[];if(n){t.measure.width=i;for(var l=t.text.firstChild.getClientRects(),s=0;s<l.length-1;s++){var a=l[s],u=l[s+1];Math.abs(a.bottom-u.bottom)>2&&o.push((a.bottom+u.top)/2-r.top)}}o.push(r.bottom-r.top)}}function Ut(e,t,r){if(e.line==t)return{map:e.measure.map,cache:e.measure.cache};for(var n=0;n<e.rest.length;n++)if(e.rest[n]==t)return{map:e.measure.maps[n],cache:e.measure.caches[n]};for(var i=0;i<e.rest.length;i++)if(W(e.rest[i])>r)return{map:e.measure.maps[i],cache:e.measure.caches[i],before:!0}}function Vt(e,t){var n=W(t=fe(t)),i=e.display.externalMeasured=new pt(e.doc,t,n);i.lineN=n;var o=i.built=st(e,i);return i.text=o.pre,r(e.display.lineMeasure,o.pre),i}function Kt(e,t,r,n){return Yt(e,Xt(e,t),r,n)}function jt(e,t){if(t>=e.display.viewFrom&&t<e.display.viewTo)return e.display.view[Lr(e,t)];var r=e.display.externalMeasured;return r&&t>=r.lineN&&t<r.lineN+r.size?r:void 0}function Xt(e,t){var r=W(t),n=jt(e,r);n&&!n.text?n=null:n&&n.changes&&(xt(e,n,r,br(e)),e.curOp.forceUpdate=!0),n||(n=Vt(e,t));var i=Ut(n,t,r);return{line:t,view:n,rect:null,map:i.map,cache:i.cache,before:i.before,hasHeights:!1}}function Yt(e,t,r,n,i){t.before&&(r=-1);var o,l=r+(n||"");return t.cache.hasOwnProperty(l)?o=t.cache[l]:(t.rect||(t.rect=t.view.text.getBoundingClientRect()),t.hasHeights||(Gt(e,t.view,t.rect),t.hasHeights=!0),(o=qt(e,t,r,n)).bogus||(t.cache[l]=o)),{left:o.left,right:o.right,top:i?o.rtop:o.top,bottom:i?o.rbottom:o.bottom}}function _t(e,t,r){for(var n,i,o,l,s,a,u=0;u<e.length;u+=3)if(s=e[u],a=e[u+1],t<s?(i=0,o=1,l="left"):t<a?o=(i=t-s)+1:(u==e.length-3||t==a&&e[u+3]>t)&&(i=(o=a-s)-1,t>=a&&(l="right")),null!=i){if(n=e[u+2],s==a&&r==(n.insertLeft?"left":"right")&&(l=r),"left"==r&&0==i)for(;u&&e[u-2]==e[u-3]&&e[u-1].insertLeft;)n=e[2+(u-=3)],l="left";if("right"==r&&i==a-s)for(;u<e.length-3&&e[u+3]==e[u+4]&&!e[u+5].insertLeft;)n=e[(u+=3)+2],l="right";break}return{node:n,start:i,end:o,collapse:l,coverStart:s,coverEnd:a}}function $t(e,t){var r=ms;if("left"==t)for(var n=0;n<e.length&&(r=e[n]).left==r.right;n++);else for(var i=e.length-1;i>=0&&(r=e[i]).left==r.right;i--);return r}function qt(e,t,r,n){var i,o=_t(t.map,r,n),l=o.node,s=o.start,a=o.end,u=o.collapse;if(3==l.nodeType){for(var c=0;c<4;c++){for(;s&&S(t.line.text.charAt(o.coverStart+s));)--s;for(;o.coverStart+a<o.coverEnd&&S(t.line.text.charAt(o.coverStart+a));)++a;if((i=gl&&vl<9&&0==s&&a==o.coverEnd-o.coverStart?l.parentNode.getBoundingClientRect():$t(Wl(l,s,a).getClientRects(),n)).left||i.right||0==s)break;a=s,s-=1,u="right"}gl&&vl<11&&(i=Zt(e.display.measure,i))}else{s>0&&(u=n="right");var f;i=e.options.lineWrapping&&(f=l.getClientRects()).length>1?f["right"==n?f.length-1:0]:l.getBoundingClientRect()}if(gl&&vl<9&&!s&&(!i||!i.left&&!i.right)){var h=l.parentNode.getClientRects()[0];i=h?{left:h.left,right:h.left+yr(e.display),top:h.top,bottom:h.bottom}:ms}for(var d=i.top-t.rect.top,p=i.bottom-t.rect.top,g=(d+p)/2,v=t.view.measure.heights,m=0;m<v.length-1&&!(g<v[m]);m++);var y=m?v[m-1]:0,b=v[m],w={left:("right"==u?i.right:i.left)-t.rect.left,right:("left"==u?i.left:i.right)-t.rect.left,top:y,bottom:b};return i.left||i.right||(w.bogus=!0),e.options.singleCursorHeightPerLine||(w.rtop=d,w.rbottom=p),w}function Zt(e,t){if(!window.screen||null==screen.logicalXDPI||screen.logicalXDPI==screen.deviceXDPI||!Re(e))return t;var r=screen.logicalXDPI/screen.deviceXDPI,n=screen.logicalYDPI/screen.deviceYDPI;return{left:t.left*r,right:t.right*r,top:t.top*n,bottom:t.bottom*n}}function Qt(e){if(e.measure&&(e.measure.cache={},e.measure.heights=null,e.rest))for(var t=0;t<e.rest.length;t++)e.measure.caches[t]={}}function Jt(e){e.display.externalMeasure=null,t(e.display.lineMeasure);for(var r=0;r<e.display.view.length;r++)Qt(e.display.view[r])}function er(e){Jt(e),e.display.cachedCharWidth=e.display.cachedTextHeight=e.display.cachedPaddingH=null,e.options.lineWrapping||(e.display.maxLineChanged=!0),e.display.lineNumChars=null}function tr(){return bl&&kl?-(document.body.getBoundingClientRect().left-parseInt(getComputedStyle(document.body).marginLeft)):window.pageXOffset||(document.documentElement||document.body).scrollLeft}function rr(){return bl&&kl?-(document.body.getBoundingClientRect().top-parseInt(getComputedStyle(document.body).marginTop)):window.pageYOffset||(document.documentElement||document.body).scrollTop}function nr(e){var t=0;if(e.widgets)for(var r=0;r<e.widgets.length;++r)e.widgets[r].above&&(t+=Ht(e.widgets[r]));return t}function ir(e,t,r,n,i){if(!i){var o=nr(t);r.top+=o,r.bottom+=o}if("line"==n)return r;n||(n="local");var l=ye(t);if("local"==n?l+=Et(e.display):l-=e.display.viewOffset,"page"==n||"window"==n){var s=e.display.lineSpace.getBoundingClientRect();l+=s.top+("window"==n?0:rr());var a=s.left+("window"==n?0:tr());r.left+=a,r.right+=a}return r.top+=l,r.bottom+=l,r}function or(e,t,r){if("div"==r)return t;var n=t.left,i=t.top;if("page"==r)n-=tr(),i-=rr();else if("local"==r||!r){var o=e.display.sizer.getBoundingClientRect();n+=o.left,i+=o.top}var l=e.display.lineSpace.getBoundingClientRect();return{left:n-l.left,top:i-l.top}}function lr(e,t,r,n,i){return n||(n=M(e.doc,t.line)),ir(e,n,Kt(e,n,t.ch,i),r)}function sr(e,t,r,n,i,o){function l(t,l){var s=Yt(e,i,t,l?"right":"left",o);return l?s.left=s.right:s.right=s.left,ir(e,n,s,r)}function s(e,t,r){var n=1==a[t].level;return l(r?e-1:e,n!=r)}n=n||M(e.doc,t.line),i||(i=Xt(e,n));var a=Se(n,e.doc.direction),u=t.ch,c=t.sticky;if(u>=n.text.length?(u=n.text.length,c="before"):u<=0&&(u=0,c="after"),!a)return l("before"==c?u-1:u,"before"==c);var f=Ce(a,u,c),h=$l,d=s(u,f,"before"==c);return null!=h&&(d.other=s(u,h,"before"!=c)),d}function ar(e,t){var r=0;t=U(e.doc,t),e.options.lineWrapping||(r=yr(e.display)*t.ch);var n=M(e.doc,t.line),i=ye(n)+Et(e.display);return{left:r,right:r,top:i,bottom:i+n.height}}function ur(e,t,r,n,i){var o=E(e,t,r);return o.xRel=i,n&&(o.outside=!0),o}function cr(e,t,r){var n=e.doc;if((r+=e.display.viewOffset)<0)return ur(n.first,0,null,!0,-1);var i=D(n,r),o=n.first+n.size-1;if(i>o)return ur(n.first+n.size-1,M(n,o).text.length,null,!0,1);t<0&&(t=0);for(var l=M(n,i);;){var s=pr(e,l,i,t,r),a=ue(l),u=a&&a.find(0,!0);if(!a||!(s.ch>u.from.ch||s.ch==u.from.ch&&s.xRel>0))return s;i=W(l=u.to.line)}}function fr(e,t,r,n){n-=nr(t);var i=t.text.length,o=k(function(t){return Yt(e,r,t-1).bottom<=n},i,0);return i=k(function(t){return Yt(e,r,t).top>n},o,i),{begin:o,end:i}}function hr(e,t,r,n){return r||(r=Xt(e,t)),fr(e,t,r,ir(e,t,Yt(e,r,n),"line").top)}function dr(e,t,r,n){return!(e.bottom<=r)&&(e.top>r||(n?e.left:e.right)>t)}function pr(e,t,r,n,i){i-=ye(t);var o=Xt(e,t),l=nr(t),s=0,a=t.text.length,u=!0,c=Se(t,e.doc.direction);if(c){var f=(e.options.lineWrapping?vr:gr)(e,t,r,o,c,n,i);s=(u=1!=f.level)?f.from:f.to-1,a=u?f.to:f.from-1}var h,d,p=null,g=null,v=k(function(t){var r=Yt(e,o,t);return r.top+=l,r.bottom+=l,!!dr(r,n,i,!1)&&(r.top<=i&&r.left<=n&&(p=t,g=r),!0)},s,a),m=!1;if(g){var y=n-g.left<g.right-n,b=y==u;v=p+(b?0:1),d=b?"after":"before",h=y?g.left:g.right}else{u||v!=a&&v!=s||v++,d=0==v?"after":v==t.text.length?"before":Yt(e,o,v-(u?1:0)).bottom+l<=i==u?"after":"before";var w=sr(e,E(r,v,d),"line",t,o);h=w.left,m=i<w.top||i>=w.bottom}return v=L(t.text,v,1),ur(r,v,d,m,n-h)}function gr(e,t,r,n,i,o,l){var s=k(function(s){var a=i[s],u=1!=a.level;return dr(sr(e,E(r,u?a.to:a.from,u?"before":"after"),"line",t,n),o,l,!0)},0,i.length-1),a=i[s];if(s>0){var u=1!=a.level,c=sr(e,E(r,u?a.from:a.to,u?"after":"before"),"line",t,n);dr(c,o,l,!0)&&c.top>l&&(a=i[s-1])}return a}function vr(e,t,r,n,i,o,l){for(var s=fr(e,t,n,l),a=s.begin,u=s.end,c=null,f=null,h=0;h<i.length;h++){var d=i[h];if(!(d.from>=u||d.to<=a)){var p=Yt(e,n,1!=d.level?Math.min(u,d.to)-1:Math.max(a,d.from)).right,g=p<o?o-p+1e9:p-o;(!c||f>g)&&(c=d,f=g)}}return c||(c=i[i.length-1]),c.from<a&&(c={from:a,to:c.to,level:c.level}),c.to>u&&(c={from:c.from,to:u,level:c.level}),c}function mr(e){if(null!=e.cachedTextHeight)return e.cachedTextHeight;if(null==hs){hs=n("pre");for(var i=0;i<49;++i)hs.appendChild(document.createTextNode("x")),hs.appendChild(n("br"));hs.appendChild(document.createTextNode("x"))}r(e.measure,hs);var o=hs.offsetHeight/50;return o>3&&(e.cachedTextHeight=o),t(e.measure),o||1}function yr(e){if(null!=e.cachedCharWidth)return e.cachedCharWidth;var t=n("span","xxxxxxxxxx"),i=n("pre",[t]);r(e.measure,i);var o=t.getBoundingClientRect(),l=(o.right-o.left)/10;return l>2&&(e.cachedCharWidth=l),l||10}function br(e){for(var t=e.display,r={},n={},i=t.gutters.clientLeft,o=t.gutters.firstChild,l=0;o;o=o.nextSibling,++l)r[e.options.gutters[l]]=o.offsetLeft+o.clientLeft+i,n[e.options.gutters[l]]=o.clientWidth;return{fixedPos:wr(t),gutterTotalWidth:t.gutters.offsetWidth,gutterLeft:r,gutterWidth:n,wrapperWidth:t.wrapper.clientWidth}}function wr(e){return e.scroller.getBoundingClientRect().left-e.sizer.getBoundingClientRect().left}function xr(e){var t=mr(e.display),r=e.options.lineWrapping,n=r&&Math.max(5,e.display.scroller.clientWidth/yr(e.display)-3);return function(i){if(ve(e.doc,i))return 0;var o=0;if(i.widgets)for(var l=0;l<i.widgets.length;l++)i.widgets[l].height&&(o+=i.widgets[l].height);return r?o+(Math.ceil(i.text.length/n)||1)*t:o+t}}function Cr(e){var t=e.doc,r=xr(e);t.iter(function(e){var t=r(e);t!=e.height&&A(e,t)})}function Sr(e,t,r,n){var i=e.display;if(!r&&"true"==Ee(t).getAttribute("cm-not-content"))return null;var o,l,s=i.lineSpace.getBoundingClientRect();try{o=t.clientX-s.left,l=t.clientY-s.top}catch(t){return null}var a,u=cr(e,o,l);if(n&&1==u.xRel&&(a=M(e.doc,u.line).text).length==u.ch){var c=f(a,a.length,e.options.tabSize)-a.length;u=E(u.line,Math.max(0,Math.round((o-It(e.display).left)/yr(e.display))-c))}return u}function Lr(e,t){if(t>=e.display.viewTo)return null;if((t-=e.display.viewFrom)<0)return null;for(var r=e.display.view,n=0;n<r.length;n++)if((t-=r[n].size)<0)return n}function kr(e){e.display.input.showSelection(e.display.input.prepareSelection())}function Tr(e,t){void 0===t&&(t=!0);for(var r=e.doc,n={},i=n.cursors=document.createDocumentFragment(),o=n.selection=document.createDocumentFragment(),l=0;l<r.sel.ranges.length;l++)if(t||l!=r.sel.primIndex){var s=r.sel.ranges[l];if(!(s.from().line>=e.display.viewTo||s.to().line<e.display.viewFrom)){var a=s.empty();(a||e.options.showCursorWhenSelecting)&&Mr(e,s.head,i),a||Or(e,s,o)}}return n}function Mr(e,t,r){var i=sr(e,t,"div",null,null,!e.options.singleCursorHeightPerLine),o=r.appendChild(n("div"," ","CodeMirror-cursor"));if(o.style.left=i.left+"px",o.style.top=i.top+"px",o.style.height=Math.max(0,i.bottom-i.top)*e.options.cursorHeight+"px",i.other){var l=r.appendChild(n("div"," ","CodeMirror-cursor CodeMirror-secondarycursor"));l.style.display="",l.style.left=i.other.left+"px",l.style.top=i.other.top+"px",l.style.height=.85*(i.other.bottom-i.other.top)+"px"}}function Nr(e,t){return e.top-t.top||e.left-t.left}function Or(e,t,r){function i(e,t,r,i){t<0&&(t=0),t=Math.round(t),i=Math.round(i),a.appendChild(n("div",null,"CodeMirror-selected","position: absolute; left: "+e+"px;\n                             top: "+t+"px; width: "+(null==r?f-e:r)+"px;\n                             height: "+(i-t)+"px"))}function o(t,r,n){function o(r,n){return lr(e,E(t,r),"div",u,n)}var l,a,u=M(s,t),h=u.text.length,d=Se(u,s.direction);return xe(d,r||0,null==n?h:n,function(t,s,p,g){var v=o(t,"ltr"==p?"left":"right"),m=o(s-1,"ltr"==p?"right":"left");if("ltr"==p){var y=null==r&&0==t?c:v.left,b=null==n&&s==h?f:m.right;m.top-v.top<=3?i(y,m.top,b-y,m.bottom):(i(y,v.top,null,v.bottom),v.bottom<m.top&&i(c,v.bottom,null,m.top),i(c,m.top,m.right,m.bottom))}else if(t<s){var w=null==r&&0==t?f:v.right,x=null==n&&s==h?c:m.left;if(m.top-v.top<=3)i(x,m.top,w-x,m.bottom);else{var C=c;if(g){var S=hr(e,u,null,t).end;C=o(S-(/\s/.test(u.text.charAt(S-1))?2:1),"left").left}i(C,v.top,w-C,v.bottom),v.bottom<m.top&&i(c,v.bottom,null,m.top);var L=null;d.length,L=o(hr(e,u,null,s).begin,"right").right-x,i(x,m.top,L,m.bottom)}}(!l||Nr(v,l)<0)&&(l=v),Nr(m,l)<0&&(l=m),(!a||Nr(v,a)<0)&&(a=v),Nr(m,a)<0&&(a=m)}),{start:l,end:a}}var l=e.display,s=e.doc,a=document.createDocumentFragment(),u=It(e.display),c=u.left,f=Math.max(l.sizerWidth,Rt(e)-l.sizer.offsetLeft)-u.right,h=t.from(),d=t.to();if(h.line==d.line)o(h.line,h.ch,d.ch);else{var p=M(s,h.line),g=M(s,d.line),v=fe(p)==fe(g),m=o(h.line,h.ch,v?p.text.length+1:null).end,y=o(d.line,v?0:null,d.ch).start;v&&(m.top<y.top-2?(i(m.right,m.top,null,m.bottom),i(c,y.top,y.left,y.bottom)):i(m.right,m.top,y.left-m.right,m.bottom)),m.bottom<y.top&&i(c,m.bottom,null,y.top)}r.appendChild(a)}function Ar(e){if(e.state.focused){var t=e.display;clearInterval(t.blinker);var r=!0;t.cursorDiv.style.visibility="",e.options.cursorBlinkRate>0?t.blinker=setInterval(function(){return t.cursorDiv.style.visibility=(r=!r)?"":"hidden"},e.options.cursorBlinkRate):e.options.cursorBlinkRate<0&&(t.cursorDiv.style.visibility="hidden")}}function Wr(e){e.state.focused||(e.display.input.focus(),Hr(e))}function Dr(e){e.state.delayingBlurEvent=!0,setTimeout(function(){e.state.delayingBlurEvent&&(e.state.delayingBlurEvent=!1,Fr(e))},100)}function Hr(e,t){e.state.delayingBlurEvent&&(e.state.delayingBlurEvent=!1),"nocursor"!=e.options.readOnly&&(e.state.focused||(Te(e,"focus",e,t),e.state.focused=!0,s(e.display.wrapper,"CodeMirror-focused"),e.curOp||e.display.selForContextMenu==e.doc.sel||(e.display.input.reset(),ml&&setTimeout(function(){return e.display.input.reset(!0)},20)),e.display.input.receivedFocus()),Ar(e))}function Fr(e,t){e.state.delayingBlurEvent||(e.state.focused&&(Te(e,"blur",e,t),e.state.focused=!1,Fl(e.display.wrapper,"CodeMirror-focused")),clearInterval(e.display.blinker),setTimeout(function(){e.state.focused||(e.display.shift=!1)},150))}function Er(e){for(var t=e.display,r=t.lineDiv.offsetTop,n=0;n<t.view.length;n++){var i=t.view[n],o=void 0;if(!i.hidden){if(gl&&vl<8){var l=i.node.offsetTop+i.node.offsetHeight;o=l-r,r=l}else{var s=i.node.getBoundingClientRect();o=s.bottom-s.top}var a=i.line.height-o;if(o<2&&(o=mr(t)),(a>.005||a<-.005)&&(A(i.line,o),Pr(i.line),i.rest))for(var u=0;u<i.rest.length;u++)Pr(i.rest[u])}}}function Pr(e){if(e.widgets)for(var t=0;t<e.widgets.length;++t)e.widgets[t].height=e.widgets[t].node.parentNode.offsetHeight}function Ir(e,t,r){var n=r&&null!=r.top?Math.max(0,r.top):e.scroller.scrollTop;n=Math.floor(n-Et(e));var i=r&&null!=r.bottom?r.bottom:n+e.wrapper.clientHeight,o=D(t,n),l=D(t,i);if(r&&r.ensure){var s=r.ensure.from.line,a=r.ensure.to.line;s<o?(o=s,l=D(t,ye(M(t,s))+e.wrapper.clientHeight)):Math.min(a,t.lastLine())>=l&&(o=D(t,ye(M(t,a))-e.wrapper.clientHeight),l=a)}return{from:o,to:Math.max(l,o+1)}}function zr(e){var t=e.display,r=t.view;if(t.alignWidgets||t.gutters.firstChild&&e.options.fixedGutter){for(var n=wr(t)-t.scroller.scrollLeft+e.doc.scrollLeft,i=t.gutters.offsetWidth,o=n+"px",l=0;l<r.length;l++)if(!r[l].hidden){e.options.fixedGutter&&(r[l].gutter&&(r[l].gutter.style.left=o),r[l].gutterBackground&&(r[l].gutterBackground.style.left=o));var s=r[l].alignable;if(s)for(var a=0;a<s.length;a++)s[a].style.left=o}e.options.fixedGutter&&(t.gutters.style.left=n+i+"px")}}function Rr(e){if(!e.options.lineNumbers)return!1;var t=e.doc,r=F(e.options,t.first+t.size-1),i=e.display;if(r.length!=i.lineNumChars){var o=i.measure.appendChild(n("div",[n("div",r)],"CodeMirror-linenumber CodeMirror-gutter-elt")),l=o.firstChild.offsetWidth,s=o.offsetWidth-l;return i.lineGutter.style.width="",i.lineNumInnerWidth=Math.max(l,i.lineGutter.offsetWidth-s)+1,i.lineNumWidth=i.lineNumInnerWidth+s,i.lineNumChars=i.lineNumInnerWidth?r.length:-1,i.lineGutter.style.width=i.lineNumWidth+"px",Wn(e),!0}return!1}function Br(e,t){if(!Me(e,"scrollCursorIntoView")){var r=e.display,i=r.sizer.getBoundingClientRect(),o=null;if(t.top+i.top<0?o=!0:t.bottom+i.top>(window.innerHeight||document.documentElement.clientHeight)&&(o=!1),null!=o&&!Sl){var l=n("div","​",null,"position: absolute;\n                         top: "+(t.top-r.viewOffset-Et(e.display))+"px;\n                         height: "+(t.bottom-t.top+zt(e)+r.barHeight)+"px;\n                         left: "+t.left+"px; width: "+Math.max(2,t.right-t.left)+"px;");e.display.lineSpace.appendChild(l),l.scrollIntoView(o),e.display.lineSpace.removeChild(l)}}}function Gr(e,t,r,n){null==n&&(n=0);var i;e.options.lineWrapping||t!=r||(r="before"==(t=t.ch?E(t.line,"before"==t.sticky?t.ch-1:t.ch,"after"):t).sticky?E(t.line,t.ch+1,"before"):t);for(var o=0;o<5;o++){var l=!1,s=sr(e,t),a=r&&r!=t?sr(e,r):s,u=Vr(e,i={left:Math.min(s.left,a.left),top:Math.min(s.top,a.top)-n,right:Math.max(s.left,a.left),bottom:Math.max(s.bottom,a.bottom)+n}),c=e.doc.scrollTop,f=e.doc.scrollLeft;if(null!=u.scrollTop&&(qr(e,u.scrollTop),Math.abs(e.doc.scrollTop-c)>1&&(l=!0)),null!=u.scrollLeft&&(Qr(e,u.scrollLeft),Math.abs(e.doc.scrollLeft-f)>1&&(l=!0)),!l)break}return i}function Ur(e,t){var r=Vr(e,t);null!=r.scrollTop&&qr(e,r.scrollTop),null!=r.scrollLeft&&Qr(e,r.scrollLeft)}function Vr(e,t){var r=e.display,n=mr(e.display);t.top<0&&(t.top=0);var i=e.curOp&&null!=e.curOp.scrollTop?e.curOp.scrollTop:r.scroller.scrollTop,o=Bt(e),l={};t.bottom-t.top>o&&(t.bottom=t.top+o);var s=e.doc.height+Pt(r),a=t.top<n,u=t.bottom>s-n;if(t.top<i)l.scrollTop=a?0:t.top;else if(t.bottom>i+o){var c=Math.min(t.top,(u?s:t.bottom)-o);c!=i&&(l.scrollTop=c)}var f=e.curOp&&null!=e.curOp.scrollLeft?e.curOp.scrollLeft:r.scroller.scrollLeft,h=Rt(e)-(e.options.fixedGutter?r.gutters.offsetWidth:0),d=t.right-t.left>h;return d&&(t.right=t.left+h),t.left<10?l.scrollLeft=0:t.left<f?l.scrollLeft=Math.max(0,t.left-(d?0:10)):t.right>h+f-3&&(l.scrollLeft=t.right+(d?0:10)-h),l}function Kr(e,t){null!=t&&(_r(e),e.curOp.scrollTop=(null==e.curOp.scrollTop?e.doc.scrollTop:e.curOp.scrollTop)+t)}function jr(e){_r(e);var t=e.getCursor();e.curOp.scrollToPos={from:t,to:t,margin:e.options.cursorScrollMargin}}function Xr(e,t,r){null==t&&null==r||_r(e),null!=t&&(e.curOp.scrollLeft=t),null!=r&&(e.curOp.scrollTop=r)}function Yr(e,t){_r(e),e.curOp.scrollToPos=t}function _r(e){var t=e.curOp.scrollToPos;t&&(e.curOp.scrollToPos=null,$r(e,ar(e,t.from),ar(e,t.to),t.margin))}function $r(e,t,r,n){var i=Vr(e,{left:Math.min(t.left,r.left),top:Math.min(t.top,r.top)-n,right:Math.max(t.right,r.right),bottom:Math.max(t.bottom,r.bottom)+n});Xr(e,i.scrollLeft,i.scrollTop)}function qr(e,t){Math.abs(e.doc.scrollTop-t)<2||(fl||On(e,{top:t}),Zr(e,t,!0),fl&&On(e),Cn(e,100))}function Zr(e,t,r){t=Math.min(e.display.scroller.scrollHeight-e.display.scroller.clientHeight,t),(e.display.scroller.scrollTop!=t||r)&&(e.doc.scrollTop=t,e.display.scrollbars.setScrollTop(t),e.display.scroller.scrollTop!=t&&(e.display.scroller.scrollTop=t))}function Qr(e,t,r,n){t=Math.min(t,e.display.scroller.scrollWidth-e.display.scroller.clientWidth),(r?t==e.doc.scrollLeft:Math.abs(e.doc.scrollLeft-t)<2)&&!n||(e.doc.scrollLeft=t,zr(e),e.display.scroller.scrollLeft!=t&&(e.display.scroller.scrollLeft=t),e.display.scrollbars.setScrollLeft(t))}function Jr(e){var t=e.display,r=t.gutters.offsetWidth,n=Math.round(e.doc.height+Pt(e.display));return{clientHeight:t.scroller.clientHeight,viewHeight:t.wrapper.clientHeight,scrollWidth:t.scroller.scrollWidth,clientWidth:t.scroller.clientWidth,viewWidth:t.wrapper.clientWidth,barLeft:e.options.fixedGutter?r:0,docHeight:n,scrollHeight:n+zt(e)+t.barHeight,nativeBarWidth:t.nativeBarWidth,gutterWidth:r}}function en(e,t){t||(t=Jr(e));var r=e.display.barWidth,n=e.display.barHeight;tn(e,t);for(var i=0;i<4&&r!=e.display.barWidth||n!=e.display.barHeight;i++)r!=e.display.barWidth&&e.options.lineWrapping&&Er(e),tn(e,Jr(e)),r=e.display.barWidth,n=e.display.barHeight}function tn(e,t){var r=e.display,n=r.scrollbars.update(t);r.sizer.style.paddingRight=(r.barWidth=n.right)+"px",r.sizer.style.paddingBottom=(r.barHeight=n.bottom)+"px",r.heightForcer.style.borderBottom=n.bottom+"px solid transparent",n.right&&n.bottom?(r.scrollbarFiller.style.display="block",r.scrollbarFiller.style.height=n.bottom+"px",r.scrollbarFiller.style.width=n.right+"px"):r.scrollbarFiller.style.display="",n.bottom&&e.options.coverGutterNextToScrollbar&&e.options.fixedGutter?(r.gutterFiller.style.display="block",r.gutterFiller.style.height=n.bottom+"px",r.gutterFiller.style.width=t.gutterWidth+"px"):r.gutterFiller.style.display=""}function rn(e){e.display.scrollbars&&(e.display.scrollbars.clear(),e.display.scrollbars.addClass&&Fl(e.display.wrapper,e.display.scrollbars.addClass)),e.display.scrollbars=new ws[e.options.scrollbarStyle](function(t){e.display.wrapper.insertBefore(t,e.display.scrollbarFiller),Ql(t,"mousedown",function(){e.state.focused&&setTimeout(function(){return e.display.input.focus()},0)}),t.setAttribute("cm-not-content","true")},function(t,r){"horizontal"==r?Qr(e,t):qr(e,t)},e),e.display.scrollbars.addClass&&s(e.display.wrapper,e.display.scrollbars.addClass)}function nn(e){e.curOp={cm:e,viewChanged:!1,startHeight:e.doc.height,forceUpdate:!1,updateInput:null,typing:!1,changeObjs:null,cursorActivityHandlers:null,cursorActivityCalled:0,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,focus:!1,id:++xs},vt(e.curOp)}function on(e){yt(e.curOp,function(e){for(var t=0;t<e.ops.length;t++)e.ops[t].cm.curOp=null;ln(e)})}function ln(e){for(var t=e.ops,r=0;r<t.length;r++)sn(t[r]);for(var n=0;n<t.length;n++)an(t[n]);for(var i=0;i<t.length;i++)un(t[i]);for(var o=0;o<t.length;o++)cn(t[o]);for(var l=0;l<t.length;l++)fn(t[l])}function sn(e){var t=e.cm,r=t.display;Ln(t),e.updateMaxLine&&we(t),e.mustUpdate=e.viewChanged||e.forceUpdate||null!=e.scrollTop||e.scrollToPos&&(e.scrollToPos.from.line<r.viewFrom||e.scrollToPos.to.line>=r.viewTo)||r.maxLineChanged&&t.options.lineWrapping,e.update=e.mustUpdate&&new Cs(t,e.mustUpdate&&{top:e.scrollTop,ensure:e.scrollToPos},e.forceUpdate)}function an(e){e.updatedDisplay=e.mustUpdate&&Mn(e.cm,e.update)}function un(e){var t=e.cm,r=t.display;e.updatedDisplay&&Er(t),e.barMeasure=Jr(t),r.maxLineChanged&&!t.options.lineWrapping&&(e.adjustWidthTo=Kt(t,r.maxLine,r.maxLine.text.length).left+3,t.display.sizerWidth=e.adjustWidthTo,e.barMeasure.scrollWidth=Math.max(r.scroller.clientWidth,r.sizer.offsetLeft+e.adjustWidthTo+zt(t)+t.display.barWidth),e.maxScrollLeft=Math.max(0,r.sizer.offsetLeft+e.adjustWidthTo-Rt(t))),(e.updatedDisplay||e.selectionChanged)&&(e.preparedSelection=r.input.prepareSelection())}function cn(e){var t=e.cm;null!=e.adjustWidthTo&&(t.display.sizer.style.minWidth=e.adjustWidthTo+"px",e.maxScrollLeft<t.doc.scrollLeft&&Qr(t,Math.min(t.display.scroller.scrollLeft,e.maxScrollLeft),!0),t.display.maxLineChanged=!1);var r=e.focus&&e.focus==l();e.preparedSelection&&t.display.input.showSelection(e.preparedSelection,r),(e.updatedDisplay||e.startHeight!=t.doc.height)&&en(t,e.barMeasure),e.updatedDisplay&&Dn(t,e.barMeasure),e.selectionChanged&&Ar(t),t.state.focused&&e.updateInput&&t.display.input.reset(e.typing),r&&Wr(e.cm)}function fn(e){var t=e.cm,r=t.display,n=t.doc;e.updatedDisplay&&Nn(t,e.update),null==r.wheelStartX||null==e.scrollTop&&null==e.scrollLeft&&!e.scrollToPos||(r.wheelStartX=r.wheelStartY=null),null!=e.scrollTop&&Zr(t,e.scrollTop,e.forceScroll),null!=e.scrollLeft&&Qr(t,e.scrollLeft,!0,!0),e.scrollToPos&&Br(t,Gr(t,U(n,e.scrollToPos.from),U(n,e.scrollToPos.to),e.scrollToPos.margin));var i=e.maybeHiddenMarkers,o=e.maybeUnhiddenMarkers;if(i)for(var l=0;l<i.length;++l)i[l].lines.length||Te(i[l],"hide");if(o)for(var s=0;s<o.length;++s)o[s].lines.length&&Te(o[s],"unhide");r.wrapper.offsetHeight&&(n.scrollTop=t.display.scroller.scrollTop),e.changeObjs&&Te(t,"changes",t,e.changeObjs),e.update&&e.update.finish()}function hn(e,t){if(e.curOp)return t();nn(e);try{return t()}finally{on(e)}}function dn(e,t){return function(){if(e.curOp)return t.apply(e,arguments);nn(e);try{return t.apply(e,arguments)}finally{on(e)}}}function pn(e){return function(){if(this.curOp)return e.apply(this,arguments);nn(this);try{return e.apply(this,arguments)}finally{on(this)}}}function gn(e){return function(){var t=this.cm;if(!t||t.curOp)return e.apply(this,arguments);nn(t);try{return e.apply(this,arguments)}finally{on(t)}}}function vn(e,t,r,n){null==t&&(t=e.doc.first),null==r&&(r=e.doc.first+e.doc.size),n||(n=0);var i=e.display;if(n&&r<i.viewTo&&(null==i.updateLineNumbers||i.updateLineNumbers>t)&&(i.updateLineNumbers=t),e.curOp.viewChanged=!0,t>=i.viewTo)_l&&pe(e.doc,t)<i.viewTo&&yn(e);else if(r<=i.viewFrom)_l&&ge(e.doc,r+n)>i.viewFrom?yn(e):(i.viewFrom+=n,i.viewTo+=n);else if(t<=i.viewFrom&&r>=i.viewTo)yn(e);else if(t<=i.viewFrom){var o=bn(e,r,r+n,1);o?(i.view=i.view.slice(o.index),i.viewFrom=o.lineN,i.viewTo+=n):yn(e)}else if(r>=i.viewTo){var l=bn(e,t,t,-1);l?(i.view=i.view.slice(0,l.index),i.viewTo=l.lineN):yn(e)}else{var s=bn(e,t,t,-1),a=bn(e,r,r+n,1);s&&a?(i.view=i.view.slice(0,s.index).concat(gt(e,s.lineN,a.lineN)).concat(i.view.slice(a.index)),i.viewTo+=n):yn(e)}var u=i.externalMeasured;u&&(r<u.lineN?u.lineN+=n:t<u.lineN+u.size&&(i.externalMeasured=null))}function mn(e,t,r){e.curOp.viewChanged=!0;var n=e.display,i=e.display.externalMeasured;if(i&&t>=i.lineN&&t<i.lineN+i.size&&(n.externalMeasured=null),!(t<n.viewFrom||t>=n.viewTo)){var o=n.view[Lr(e,t)];if(null!=o.node){var l=o.changes||(o.changes=[]);-1==h(l,r)&&l.push(r)}}}function yn(e){e.display.viewFrom=e.display.viewTo=e.doc.first,e.display.view=[],e.display.viewOffset=0}function bn(e,t,r,n){var i,o=Lr(e,t),l=e.display.view;if(!_l||r==e.doc.first+e.doc.size)return{index:o,lineN:r};for(var s=e.display.viewFrom,a=0;a<o;a++)s+=l[a].size;if(s!=t){if(n>0){if(o==l.length-1)return null;i=s+l[o].size-t,o++}else i=s-t;t+=i,r+=i}for(;pe(e.doc,r)!=r;){if(o==(n<0?0:l.length-1))return null;r+=n*l[o-(n<0?1:0)].size,o+=n}return{index:o,lineN:r}}function wn(e,t,r){var n=e.display;0==n.view.length||t>=n.viewTo||r<=n.viewFrom?(n.view=gt(e,t,r),n.viewFrom=t):(n.viewFrom>t?n.view=gt(e,t,n.viewFrom).concat(n.view):n.viewFrom<t&&(n.view=n.view.slice(Lr(e,t))),n.viewFrom=t,n.viewTo<r?n.view=n.view.concat(gt(e,n.viewTo,r)):n.viewTo>r&&(n.view=n.view.slice(0,Lr(e,r)))),n.viewTo=r}function xn(e){for(var t=e.display.view,r=0,n=0;n<t.length;n++){var i=t[n];i.hidden||i.node&&!i.changes||++r}return r}function Cn(e,t){e.doc.highlightFrontier<e.display.viewTo&&e.state.highlight.set(t,u(Sn,e))}function Sn(e){var t=e.doc;if(!(t.highlightFrontier>=e.display.viewTo)){var r=+new Date+e.options.workTime,n=$e(e,t.highlightFrontier),i=[];t.iter(n.line,Math.min(t.first+t.size,e.display.viewTo+500),function(o){if(n.line>=e.display.viewFrom){var l=o.styles,s=o.text.length>e.options.maxHighlightLength?Ke(t.mode,n.state):null,a=Ye(e,o,n,!0);s&&(n.state=s),o.styles=a.styles;var u=o.styleClasses,c=a.classes;c?o.styleClasses=c:u&&(o.styleClasses=null);for(var f=!l||l.length!=o.styles.length||u!=c&&(!u||!c||u.bgClass!=c.bgClass||u.textClass!=c.textClass),h=0;!f&&h<l.length;++h)f=l[h]!=o.styles[h];f&&i.push(n.line),o.stateAfter=n.save(),n.nextLine()}else o.text.length<=e.options.maxHighlightLength&&qe(e,o.text,n),o.stateAfter=n.line%5==0?n.save():null,n.nextLine();if(+new Date>r)return Cn(e,e.options.workDelay),!0}),t.highlightFrontier=n.line,t.modeFrontier=Math.max(t.modeFrontier,n.line),i.length&&hn(e,function(){for(var t=0;t<i.length;t++)mn(e,i[t],"text")})}}function Ln(e){var t=e.display;!t.scrollbarsClipped&&t.scroller.offsetWidth&&(t.nativeBarWidth=t.scroller.offsetWidth-t.scroller.clientWidth,t.heightForcer.style.height=zt(e)+"px",t.sizer.style.marginBottom=-t.nativeBarWidth+"px",t.sizer.style.borderRightWidth=zt(e)+"px",t.scrollbarsClipped=!0)}function kn(e){if(e.hasFocus())return null;var t=l();if(!t||!o(e.display.lineDiv,t))return null;var r={activeElt:t};if(window.getSelection){var n=window.getSelection();n.anchorNode&&n.extend&&o(e.display.lineDiv,n.anchorNode)&&(r.anchorNode=n.anchorNode,r.anchorOffset=n.anchorOffset,r.focusNode=n.focusNode,r.focusOffset=n.focusOffset)}return r}function Tn(e){if(e&&e.activeElt&&e.activeElt!=l()&&(e.activeElt.focus(),e.anchorNode&&o(document.body,e.anchorNode)&&o(document.body,e.focusNode))){var t=window.getSelection(),r=document.createRange();r.setEnd(e.anchorNode,e.anchorOffset),r.collapse(!1),t.removeAllRanges(),t.addRange(r),t.extend(e.focusNode,e.focusOffset)}}function Mn(e,r){var n=e.display,i=e.doc;if(r.editorIsHidden)return yn(e),!1;if(!r.force&&r.visible.from>=n.viewFrom&&r.visible.to<=n.viewTo&&(null==n.updateLineNumbers||n.updateLineNumbers>=n.viewTo)&&n.renderedView==n.view&&0==xn(e))return!1;Rr(e)&&(yn(e),r.dims=br(e));var o=i.first+i.size,l=Math.max(r.visible.from-e.options.viewportMargin,i.first),s=Math.min(o,r.visible.to+e.options.viewportMargin);n.viewFrom<l&&l-n.viewFrom<20&&(l=Math.max(i.first,n.viewFrom)),n.viewTo>s&&n.viewTo-s<20&&(s=Math.min(o,n.viewTo)),_l&&(l=pe(e.doc,l),s=ge(e.doc,s));var a=l!=n.viewFrom||s!=n.viewTo||n.lastWrapHeight!=r.wrapperHeight||n.lastWrapWidth!=r.wrapperWidth;wn(e,l,s),n.viewOffset=ye(M(e.doc,n.viewFrom)),e.display.mover.style.top=n.viewOffset+"px";var u=xn(e);if(!a&&0==u&&!r.force&&n.renderedView==n.view&&(null==n.updateLineNumbers||n.updateLineNumbers>=n.viewTo))return!1;var c=kn(e);return u>4&&(n.lineDiv.style.display="none"),An(e,n.updateLineNumbers,r.dims),u>4&&(n.lineDiv.style.display=""),n.renderedView=n.view,Tn(c),t(n.cursorDiv),t(n.selectionDiv),n.gutters.style.height=n.sizer.style.minHeight=0,a&&(n.lastWrapHeight=r.wrapperHeight,n.lastWrapWidth=r.wrapperWidth,Cn(e,400)),n.updateLineNumbers=null,!0}function Nn(e,t){for(var r=t.viewport,n=!0;(n&&e.options.lineWrapping&&t.oldDisplayWidth!=Rt(e)||(r&&null!=r.top&&(r={top:Math.min(e.doc.height+Pt(e.display)-Bt(e),r.top)}),t.visible=Ir(e.display,e.doc,r),!(t.visible.from>=e.display.viewFrom&&t.visible.to<=e.display.viewTo)))&&Mn(e,t);n=!1){Er(e);var i=Jr(e);kr(e),en(e,i),Dn(e,i),t.force=!1}t.signal(e,"update",e),e.display.viewFrom==e.display.reportedViewFrom&&e.display.viewTo==e.display.reportedViewTo||(t.signal(e,"viewportChange",e,e.display.viewFrom,e.display.viewTo),e.display.reportedViewFrom=e.display.viewFrom,e.display.reportedViewTo=e.display.viewTo)}function On(e,t){var r=new Cs(e,t);if(Mn(e,r)){Er(e),Nn(e,r);var n=Jr(e);kr(e),en(e,n),Dn(e,n),r.finish()}}function An(e,r,n){function i(t){var r=t.nextSibling;return ml&&Ml&&e.display.currentWheelTarget==t?t.style.display="none":t.parentNode.removeChild(t),r}for(var o=e.display,l=e.options.lineNumbers,s=o.lineDiv,a=s.firstChild,u=o.view,c=o.viewFrom,f=0;f<u.length;f++){var d=u[f];if(d.hidden);else if(d.node&&d.node.parentNode==s){for(;a!=d.node;)a=i(a);var p=l&&null!=r&&r<=c&&d.lineNumber;d.changes&&(h(d.changes,"gutter")>-1&&(p=!1),xt(e,d,c,n)),p&&(t(d.lineNumber),d.lineNumber.appendChild(document.createTextNode(F(e.options,c)))),a=d.node.nextSibling}else{var g=Ot(e,d,c,n);s.insertBefore(g,a)}c+=d.size}for(;a;)a=i(a)}function Wn(e){var t=e.display.gutters.offsetWidth;e.display.sizer.style.marginLeft=t+"px"}function Dn(e,t){e.display.sizer.style.minHeight=t.docHeight+"px",e.display.heightForcer.style.top=t.docHeight+"px",e.display.gutters.style.height=t.docHeight+e.display.barHeight+zt(e)+"px"}function Hn(e){var r=e.display.gutters,i=e.options.gutters;t(r);for(var o=0;o<i.length;++o){var l=i[o],s=r.appendChild(n("div",null,"CodeMirror-gutter "+l));"CodeMirror-linenumbers"==l&&(e.display.lineGutter=s,s.style.width=(e.display.lineNumWidth||1)+"px")}r.style.display=o?"":"none",Wn(e)}function Fn(e){var t=h(e.gutters,"CodeMirror-linenumbers");-1==t&&e.lineNumbers?e.gutters=e.gutters.concat(["CodeMirror-linenumbers"]):t>-1&&!e.lineNumbers&&(e.gutters=e.gutters.slice(0),e.gutters.splice(t,1))}function En(e){var t=e.wheelDeltaX,r=e.wheelDeltaY;return null==t&&e.detail&&e.axis==e.HORIZONTAL_AXIS&&(t=e.detail),null==r&&e.detail&&e.axis==e.VERTICAL_AXIS?r=e.detail:null==r&&(r=e.wheelDelta),{x:t,y:r}}function Pn(e){var t=En(e);return t.x*=Ls,t.y*=Ls,t}function In(e,t){var r=En(t),n=r.x,i=r.y,o=e.display,l=o.scroller,s=l.scrollWidth>l.clientWidth,a=l.scrollHeight>l.clientHeight;if(n&&s||i&&a){if(i&&Ml&&ml)e:for(var u=t.target,c=o.view;u!=l;u=u.parentNode)for(var f=0;f<c.length;f++)if(c[f].node==u){e.display.currentWheelTarget=u;break e}if(n&&!fl&&!wl&&null!=Ls)return i&&a&&qr(e,Math.max(0,l.scrollTop+i*Ls)),Qr(e,Math.max(0,l.scrollLeft+n*Ls)),(!i||i&&a)&&We(t),void(o.wheelStartX=null);if(i&&null!=Ls){var h=i*Ls,d=e.doc.scrollTop,p=d+o.wrapper.clientHeight;h<0?d=Math.max(0,d+h-50):p=Math.min(e.doc.height,p+h+50),On(e,{top:d,bottom:p})}Ss<20&&(null==o.wheelStartX?(o.wheelStartX=l.scrollLeft,o.wheelStartY=l.scrollTop,o.wheelDX=n,o.wheelDY=i,setTimeout(function(){if(null!=o.wheelStartX){var e=l.scrollLeft-o.wheelStartX,t=l.scrollTop-o.wheelStartY,r=t&&o.wheelDY&&t/o.wheelDY||e&&o.wheelDX&&e/o.wheelDX;o.wheelStartX=o.wheelStartY=null,r&&(Ls=(Ls*Ss+r)/(Ss+1),++Ss)}},200)):(o.wheelDX+=n,o.wheelDY+=i))}}function zn(e,t){var r=e[t];e.sort(function(e,t){return P(e.from(),t.from())}),t=h(e,r);for(var n=1;n<e.length;n++){var i=e[n],o=e[n-1];if(P(o.to(),i.from())>=0){var l=B(o.from(),i.from()),s=R(o.to(),i.to()),a=o.empty()?i.from()==i.head:o.from()==o.head;n<=t&&--t,e.splice(--n,2,new Ts(a?s:l,a?l:s))}}return new ks(e,t)}function Rn(e,t){return new ks([new Ts(e,t||e)],0)}function Bn(e){return e.text?E(e.from.line+e.text.length-1,g(e.text).length+(1==e.text.length?e.from.ch:0)):e.to}function Gn(e,t){if(P(e,t.from)<0)return e;if(P(e,t.to)<=0)return Bn(t);var r=e.line+t.text.length-(t.to.line-t.from.line)-1,n=e.ch;return e.line==t.to.line&&(n+=Bn(t).ch-t.to.ch),E(r,n)}function Un(e,t){for(var r=[],n=0;n<e.sel.ranges.length;n++){var i=e.sel.ranges[n];r.push(new Ts(Gn(i.anchor,t),Gn(i.head,t)))}return zn(r,e.sel.primIndex)}function Vn(e,t,r){return e.line==t.line?E(r.line,e.ch-t.ch+r.ch):E(r.line+(e.line-t.line),e.ch)}function Kn(e,t,r){for(var n=[],i=E(e.first,0),o=i,l=0;l<t.length;l++){var s=t[l],a=Vn(s.from,i,o),u=Vn(Bn(s),i,o);if(i=s.to,o=u,"around"==r){var c=e.sel.ranges[l],f=P(c.head,c.anchor)<0;n[l]=new Ts(f?u:a,f?a:u)}else n[l]=new Ts(a,a)}return new ks(n,e.sel.primIndex)}function jn(e){e.doc.mode=Ue(e.options,e.doc.modeOption),Xn(e)}function Xn(e){e.doc.iter(function(e){e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null)}),e.doc.modeFrontier=e.doc.highlightFrontier=e.doc.first,Cn(e,100),e.state.modeGen++,e.curOp&&vn(e)}function Yn(e,t){return 0==t.from.ch&&0==t.to.ch&&""==g(t.text)&&(!e.cm||e.cm.options.wholeLineUpdateBefore)}function _n(e,t,r,n){function i(e){return r?r[e]:null}function o(e,r,i){it(e,r,i,n),bt(e,"change",e,t)}function l(e,t){for(var r=[],o=e;o<t;++o)r.push(new fs(u[o],i(o),n));return r}var s=t.from,a=t.to,u=t.text,c=M(e,s.line),f=M(e,a.line),h=g(u),d=i(u.length-1),p=a.line-s.line;if(t.full)e.insert(0,l(0,u.length)),e.remove(u.length,e.size-u.length);else if(Yn(e,t)){var v=l(0,u.length-1);o(f,f.text,d),p&&e.remove(s.line,p),v.length&&e.insert(s.line,v)}else if(c==f)if(1==u.length)o(c,c.text.slice(0,s.ch)+h+c.text.slice(a.ch),d);else{var m=l(1,u.length-1);m.push(new fs(h+c.text.slice(a.ch),d,n)),o(c,c.text.slice(0,s.ch)+u[0],i(0)),e.insert(s.line+1,m)}else if(1==u.length)o(c,c.text.slice(0,s.ch)+u[0]+f.text.slice(a.ch),i(0)),e.remove(s.line+1,p);else{o(c,c.text.slice(0,s.ch)+u[0],i(0)),o(f,h+f.text.slice(a.ch),d);var y=l(1,u.length-1);p>1&&e.remove(s.line+1,p-1),e.insert(s.line+1,y)}bt(e,"change",e,t)}function $n(e,t,r){function n(e,i,o){if(e.linked)for(var l=0;l<e.linked.length;++l){var s=e.linked[l];if(s.doc!=i){var a=o&&s.sharedHist;r&&!a||(t(s.doc,a),n(s.doc,e,a))}}}n(e,null,!0)}function qn(e,t){if(t.cm)throw new Error("This document is already in use.");e.doc=t,t.cm=e,Cr(e),jn(e),Zn(e),e.options.lineWrapping||we(e),e.options.mode=t.modeOption,vn(e)}function Zn(e){("rtl"==e.doc.direction?s:Fl)(e.display.lineDiv,"CodeMirror-rtl")}function Qn(e){hn(e,function(){Zn(e),vn(e)})}function Jn(e){this.done=[],this.undone=[],this.undoDepth=1/0,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=e||1}function ei(e,t){var r={from:z(t.from),to:Bn(t),text:N(e,t.from,t.to)};return si(e,r,t.from.line,t.to.line+1),$n(e,function(e){return si(e,r,t.from.line,t.to.line+1)},!0),r}function ti(e){for(;e.length&&g(e).ranges;)e.pop()}function ri(e,t){return t?(ti(e.done),g(e.done)):e.done.length&&!g(e.done).ranges?g(e.done):e.done.length>1&&!e.done[e.done.length-2].ranges?(e.done.pop(),g(e.done)):void 0}function ni(e,t,r,n){var i=e.history;i.undone.length=0;var o,l,s=+new Date;if((i.lastOp==n||i.lastOrigin==t.origin&&t.origin&&("+"==t.origin.charAt(0)&&e.cm&&i.lastModTime>s-e.cm.options.historyEventDelay||"*"==t.origin.charAt(0)))&&(o=ri(i,i.lastOp==n)))l=g(o.changes),0==P(t.from,t.to)&&0==P(t.from,l.to)?l.to=Bn(t):o.changes.push(ei(e,t));else{var a=g(i.done);for(a&&a.ranges||li(e.sel,i.done),o={changes:[ei(e,t)],generation:i.generation},i.done.push(o);i.done.length>i.undoDepth;)i.done.shift(),i.done[0].ranges||i.done.shift()}i.done.push(r),i.generation=++i.maxGeneration,i.lastModTime=i.lastSelTime=s,i.lastOp=i.lastSelOp=n,i.lastOrigin=i.lastSelOrigin=t.origin,l||Te(e,"historyAdded")}function ii(e,t,r,n){var i=t.charAt(0);return"*"==i||"+"==i&&r.ranges.length==n.ranges.length&&r.somethingSelected()==n.somethingSelected()&&new Date-e.history.lastSelTime<=(e.cm?e.cm.options.historyEventDelay:500)}function oi(e,t,r,n){var i=e.history,o=n&&n.origin;r==i.lastSelOp||o&&i.lastSelOrigin==o&&(i.lastModTime==i.lastSelTime&&i.lastOrigin==o||ii(e,o,g(i.done),t))?i.done[i.done.length-1]=t:li(t,i.done),i.lastSelTime=+new Date,i.lastSelOrigin=o,i.lastSelOp=r,n&&!1!==n.clearRedo&&ti(i.undone)}function li(e,t){var r=g(t);r&&r.ranges&&r.equals(e)||t.push(e)}function si(e,t,r,n){var i=t["spans_"+e.id],o=0;e.iter(Math.max(e.first,r),Math.min(e.first+e.size,n),function(r){r.markedSpans&&((i||(i=t["spans_"+e.id]={}))[o]=r.markedSpans),++o})}function ai(e){if(!e)return null;for(var t,r=0;r<e.length;++r)e[r].marker.explicitlyCleared?t||(t=e.slice(0,r)):t&&t.push(e[r]);return t?t.length?t:null:e}function ui(e,t){var r=t["spans_"+e.id];if(!r)return null;for(var n=[],i=0;i<t.text.length;++i)n.push(ai(r[i]));return n}function ci(e,t){var r=ui(e,t),n=J(e,t);if(!r)return n;if(!n)return r;for(var i=0;i<r.length;++i){var o=r[i],l=n[i];if(o&&l)e:for(var s=0;s<l.length;++s){for(var a=l[s],u=0;u<o.length;++u)if(o[u].marker==a.marker)continue e;o.push(a)}else l&&(r[i]=l)}return r}function fi(e,t,r){for(var n=[],i=0;i<e.length;++i){var o=e[i];if(o.ranges)n.push(r?ks.prototype.deepCopy.call(o):o);else{var l=o.changes,s=[];n.push({changes:s});for(var a=0;a<l.length;++a){var u=l[a],c=void 0;if(s.push({from:u.from,to:u.to,text:u.text}),t)for(var f in u)(c=f.match(/^spans_(\d+)$/))&&h(t,Number(c[1]))>-1&&(g(s)[f]=u[f],delete u[f])}}}return n}function hi(e,t,r,n){if(n){var i=e.anchor;if(r){var o=P(t,i)<0;o!=P(r,i)<0?(i=t,t=r):o!=P(t,r)<0&&(t=r)}return new Ts(i,t)}return new Ts(r||t,t)}function di(e,t,r,n,i){null==i&&(i=e.cm&&(e.cm.display.shift||e.extend)),bi(e,new ks([hi(e.sel.primary(),t,r,i)],0),n)}function pi(e,t,r){for(var n=[],i=e.cm&&(e.cm.display.shift||e.extend),o=0;o<e.sel.ranges.length;o++)n[o]=hi(e.sel.ranges[o],t[o],null,i);bi(e,zn(n,e.sel.primIndex),r)}function gi(e,t,r,n){var i=e.sel.ranges.slice(0);i[t]=r,bi(e,zn(i,e.sel.primIndex),n)}function vi(e,t,r,n){bi(e,Rn(t,r),n)}function mi(e,t,r){var n={ranges:t.ranges,update:function(t){var r=this;this.ranges=[];for(var n=0;n<t.length;n++)r.ranges[n]=new Ts(U(e,t[n].anchor),U(e,t[n].head))},origin:r&&r.origin};return Te(e,"beforeSelectionChange",e,n),e.cm&&Te(e.cm,"beforeSelectionChange",e.cm,n),n.ranges!=t.ranges?zn(n.ranges,n.ranges.length-1):t}function yi(e,t,r){var n=e.history.done,i=g(n);i&&i.ranges?(n[n.length-1]=t,wi(e,t,r)):bi(e,t,r)}function bi(e,t,r){wi(e,t,r),oi(e,e.sel,e.cm?e.cm.curOp.id:NaN,r)}function wi(e,t,r){(Oe(e,"beforeSelectionChange")||e.cm&&Oe(e.cm,"beforeSelectionChange"))&&(t=mi(e,t,r)),xi(e,Si(e,t,r&&r.bias||(P(t.primary().head,e.sel.primary().head)<0?-1:1),!0)),r&&!1===r.scroll||!e.cm||jr(e.cm)}function xi(e,t){t.equals(e.sel)||(e.sel=t,e.cm&&(e.cm.curOp.updateInput=e.cm.curOp.selectionChanged=!0,Ne(e.cm)),bt(e,"cursorActivity",e))}function Ci(e){xi(e,Si(e,e.sel,null,!1))}function Si(e,t,r,n){for(var i,o=0;o<t.ranges.length;o++){var l=t.ranges[o],s=t.ranges.length==e.sel.ranges.length&&e.sel.ranges[o],a=ki(e,l.anchor,s&&s.anchor,r,n),u=ki(e,l.head,s&&s.head,r,n);(i||a!=l.anchor||u!=l.head)&&(i||(i=t.ranges.slice(0,o)),i[o]=new Ts(a,u))}return i?zn(i,t.primIndex):t}function Li(e,t,r,n,i){var o=M(e,t.line);if(o.markedSpans)for(var l=0;l<o.markedSpans.length;++l){var s=o.markedSpans[l],a=s.marker;if((null==s.from||(a.inclusiveLeft?s.from<=t.ch:s.from<t.ch))&&(null==s.to||(a.inclusiveRight?s.to>=t.ch:s.to>t.ch))){if(i&&(Te(a,"beforeCursorEnter"),a.explicitlyCleared)){if(o.markedSpans){--l;continue}break}if(!a.atomic)continue;if(r){var u=a.find(n<0?1:-1),c=void 0;if((n<0?a.inclusiveRight:a.inclusiveLeft)&&(u=Ti(e,u,-n,u&&u.line==t.line?o:null)),u&&u.line==t.line&&(c=P(u,r))&&(n<0?c<0:c>0))return Li(e,u,t,n,i)}var f=a.find(n<0?-1:1);return(n<0?a.inclusiveLeft:a.inclusiveRight)&&(f=Ti(e,f,n,f.line==t.line?o:null)),f?Li(e,f,t,n,i):null}}return t}function ki(e,t,r,n,i){var o=n||1,l=Li(e,t,r,o,i)||!i&&Li(e,t,r,o,!0)||Li(e,t,r,-o,i)||!i&&Li(e,t,r,-o,!0);return l||(e.cantEdit=!0,E(e.first,0))}function Ti(e,t,r,n){return r<0&&0==t.ch?t.line>e.first?U(e,E(t.line-1)):null:r>0&&t.ch==(n||M(e,t.line)).text.length?t.line<e.first+e.size-1?E(t.line+1,0):null:new E(t.line,t.ch+r)}function Mi(e){e.setSelection(E(e.firstLine(),0),E(e.lastLine()),Gl)}function Ni(e,t,r){var n={canceled:!1,from:t.from,to:t.to,text:t.text,origin:t.origin,cancel:function(){return n.canceled=!0}};return r&&(n.update=function(t,r,i,o){t&&(n.from=U(e,t)),r&&(n.to=U(e,r)),i&&(n.text=i),void 0!==o&&(n.origin=o)}),Te(e,"beforeChange",e,n),e.cm&&Te(e.cm,"beforeChange",e.cm,n),n.canceled?null:{from:n.from,to:n.to,text:n.text,origin:n.origin}}function Oi(e,t,r){if(e.cm){if(!e.cm.curOp)return dn(e.cm,Oi)(e,t,r);if(e.cm.state.suppressEdits)return}if(!(Oe(e,"beforeChange")||e.cm&&Oe(e.cm,"beforeChange"))||(t=Ni(e,t,!0))){var n=Yl&&!r&&te(e,t.from,t.to);if(n)for(var i=n.length-1;i>=0;--i)Ai(e,{from:n[i].from,to:n[i].to,text:i?[""]:t.text,origin:t.origin});else Ai(e,t)}}function Ai(e,t){if(1!=t.text.length||""!=t.text[0]||0!=P(t.from,t.to)){var r=Un(e,t);ni(e,t,r,e.cm?e.cm.curOp.id:NaN),Hi(e,t,r,J(e,t));var n=[];$n(e,function(e,r){r||-1!=h(n,e.history)||(zi(e.history,t),n.push(e.history)),Hi(e,t,null,J(e,t))})}}function Wi(e,t,r){if(!e.cm||!e.cm.state.suppressEdits||r){for(var n,i=e.history,o=e.sel,l="undo"==t?i.done:i.undone,s="undo"==t?i.undone:i.done,a=0;a<l.length&&(n=l[a],r?!n.ranges||n.equals(e.sel):n.ranges);a++);if(a!=l.length){for(i.lastOrigin=i.lastSelOrigin=null;(n=l.pop()).ranges;){if(li(n,s),r&&!n.equals(e.sel))return void bi(e,n,{clearRedo:!1});o=n}var u=[];li(o,s),s.push({changes:u,generation:i.generation}),i.generation=n.generation||++i.maxGeneration;for(var c=Oe(e,"beforeChange")||e.cm&&Oe(e.cm,"beforeChange"),f=n.changes.length-1;f>=0;--f){var d=function(r){var i=n.changes[r];if(i.origin=t,c&&!Ni(e,i,!1))return l.length=0,{};u.push(ei(e,i));var o=r?Un(e,i):g(l);Hi(e,i,o,ci(e,i)),!r&&e.cm&&e.cm.scrollIntoView({from:i.from,to:Bn(i)});var s=[];$n(e,function(e,t){t||-1!=h(s,e.history)||(zi(e.history,i),s.push(e.history)),Hi(e,i,null,ci(e,i))})}(f);if(d)return d.v}}}}function Di(e,t){if(0!=t&&(e.first+=t,e.sel=new ks(v(e.sel.ranges,function(e){return new Ts(E(e.anchor.line+t,e.anchor.ch),E(e.head.line+t,e.head.ch))}),e.sel.primIndex),e.cm)){vn(e.cm,e.first,e.first-t,t);for(var r=e.cm.display,n=r.viewFrom;n<r.viewTo;n++)mn(e.cm,n,"gutter")}}function Hi(e,t,r,n){if(e.cm&&!e.cm.curOp)return dn(e.cm,Hi)(e,t,r,n);if(t.to.line<e.first)Di(e,t.text.length-1-(t.to.line-t.from.line));else if(!(t.from.line>e.lastLine())){if(t.from.line<e.first){var i=t.text.length-1-(e.first-t.from.line);Di(e,i),t={from:E(e.first,0),to:E(t.to.line+i,t.to.ch),text:[g(t.text)],origin:t.origin}}var o=e.lastLine();t.to.line>o&&(t={from:t.from,to:E(o,M(e,o).text.length),text:[t.text[0]],origin:t.origin}),t.removed=N(e,t.from,t.to),r||(r=Un(e,t)),e.cm?Fi(e.cm,t,n):_n(e,t,n),wi(e,r,Gl)}}function Fi(e,t,r){var n=e.doc,i=e.display,o=t.from,l=t.to,s=!1,a=o.line;e.options.lineWrapping||(a=W(fe(M(n,o.line))),n.iter(a,l.line+1,function(e){if(e==i.maxLine)return s=!0,!0})),n.sel.contains(t.from,t.to)>-1&&Ne(e),_n(n,t,r,xr(e)),e.options.lineWrapping||(n.iter(a,o.line+t.text.length,function(e){var t=be(e);t>i.maxLineLength&&(i.maxLine=e,i.maxLineLength=t,i.maxLineChanged=!0,s=!1)}),s&&(e.curOp.updateMaxLine=!0)),nt(n,o.line),Cn(e,400);var u=t.text.length-(l.line-o.line)-1;t.full?vn(e):o.line!=l.line||1!=t.text.length||Yn(e.doc,t)?vn(e,o.line,l.line+1,u):mn(e,o.line,"text");var c=Oe(e,"changes"),f=Oe(e,"change");if(f||c){var h={from:o,to:l,text:t.text,removed:t.removed,origin:t.origin};f&&bt(e,"change",e,h),c&&(e.curOp.changeObjs||(e.curOp.changeObjs=[])).push(h)}e.display.selForContextMenu=null}function Ei(e,t,r,n,i){if(n||(n=r),P(n,r)<0){var o;r=(o=[n,r])[0],n=o[1]}"string"==typeof t&&(t=e.splitLines(t)),Oi(e,{from:r,to:n,text:t,origin:i})}function Pi(e,t,r,n){r<e.line?e.line+=n:t<e.line&&(e.line=t,e.ch=0)}function Ii(e,t,r,n){for(var i=0;i<e.length;++i){var o=e[i],l=!0;if(o.ranges){o.copied||((o=e[i]=o.deepCopy()).copied=!0);for(var s=0;s<o.ranges.length;s++)Pi(o.ranges[s].anchor,t,r,n),Pi(o.ranges[s].head,t,r,n)}else{for(var a=0;a<o.changes.length;++a){var u=o.changes[a];if(r<u.from.line)u.from=E(u.from.line+n,u.from.ch),u.to=E(u.to.line+n,u.to.ch);else if(t<=u.to.line){l=!1;break}}l||(e.splice(0,i+1),i=0)}}}function zi(e,t){var r=t.from.line,n=t.to.line,i=t.text.length-(n-r)-1;Ii(e.done,r,n,i),Ii(e.undone,r,n,i)}function Ri(e,t,r,n){var i=t,o=t;return"number"==typeof t?o=M(e,G(e,t)):i=W(t),null==i?null:(n(o,i)&&e.cm&&mn(e.cm,i,r),o)}function Bi(e){var t=this;this.lines=e,this.parent=null;for(var r=0,n=0;n<e.length;++n)e[n].parent=t,r+=e[n].height;this.height=r}function Gi(e){var t=this;this.children=e;for(var r=0,n=0,i=0;i<e.length;++i){var o=e[i];r+=o.chunkSize(),n+=o.height,o.parent=t}this.size=r,this.height=n,this.parent=null}function Ui(e,t,r){ye(t)<(e.curOp&&e.curOp.scrollTop||e.doc.scrollTop)&&Kr(e,r)}function Vi(e,t,r,n){var i=new Ms(e,r,n),o=e.cm;return o&&i.noHScroll&&(o.display.alignWidgets=!0),Ri(e,t,"widget",function(t){var r=t.widgets||(t.widgets=[]);if(null==i.insertAt?r.push(i):r.splice(Math.min(r.length-1,Math.max(0,i.insertAt)),0,i),i.line=t,o&&!ve(e,t)){var n=ye(t)<e.scrollTop;A(t,t.height+Ht(i)),n&&Kr(o,i.height),o.curOp.forceUpdate=!0}return!0}),bt(o,"lineWidgetAdded",o,i,"number"==typeof t?t:W(t)),i}function Ki(e,t,r,n,o){if(n&&n.shared)return ji(e,t,r,n,o);if(e.cm&&!e.cm.curOp)return dn(e.cm,Ki)(e,t,r,n,o);var l=new Os(e,o),s=P(t,r);if(n&&c(n,l,!1),s>0||0==s&&!1!==l.clearWhenEmpty)return l;if(l.replacedWith&&(l.collapsed=!0,l.widgetNode=i("span",[l.replacedWith],"CodeMirror-widget"),n.handleMouseEvents||l.widgetNode.setAttribute("cm-ignore-events","true"),n.insertLeft&&(l.widgetNode.insertLeft=!0)),l.collapsed){if(ce(e,t.line,t,r,l)||t.line!=r.line&&ce(e,r.line,t,r,l))throw new Error("Inserting collapsed marker partially overlapping an existing one");X()}l.addToHistory&&ni(e,{from:t,to:r,origin:"markText"},e.sel,NaN);var a,u=t.line,f=e.cm;if(e.iter(u,r.line+1,function(e){f&&l.collapsed&&!f.options.lineWrapping&&fe(e)==f.display.maxLine&&(a=!0),l.collapsed&&u!=t.line&&A(e,0),q(e,new Y(l,u==t.line?t.ch:null,u==r.line?r.ch:null)),++u}),l.collapsed&&e.iter(t.line,r.line+1,function(t){ve(e,t)&&A(t,0)}),l.clearOnEnter&&Ql(l,"beforeCursorEnter",function(){return l.clear()}),l.readOnly&&(j(),(e.history.done.length||e.history.undone.length)&&e.clearHistory()),l.collapsed&&(l.id=++Ns,l.atomic=!0),f){if(a&&(f.curOp.updateMaxLine=!0),l.collapsed)vn(f,t.line,r.line+1);else if(l.className||l.title||l.startStyle||l.endStyle||l.css)for(var h=t.line;h<=r.line;h++)mn(f,h,"text");l.atomic&&Ci(f.doc),bt(f,"markerAdded",f,l)}return l}function ji(e,t,r,n,i){(n=c(n)).shared=!1;var o=[Ki(e,t,r,n,i)],l=o[0],s=n.widgetNode;return $n(e,function(e){s&&(n.widgetNode=s.cloneNode(!0)),o.push(Ki(e,U(e,t),U(e,r),n,i));for(var a=0;a<e.linked.length;++a)if(e.linked[a].isParent)return;l=g(o)}),new As(o,l)}function Xi(e){return e.findMarks(E(e.first,0),e.clipPos(E(e.lastLine())),function(e){return e.parent})}function Yi(e,t){for(var r=0;r<t.length;r++){var n=t[r],i=n.find(),o=e.clipPos(i.from),l=e.clipPos(i.to);if(P(o,l)){var s=Ki(e,o,l,n.primary,n.primary.type);n.markers.push(s),s.parent=n}}}function _i(e){for(var t=0;t<e.length;t++)!function(t){var r=e[t],n=[r.primary.doc];$n(r.primary.doc,function(e){return n.push(e)});for(var i=0;i<r.markers.length;i++){var o=r.markers[i];-1==h(n,o.doc)&&(o.parent=null,r.markers.splice(i--,1))}}(t)}function $i(e){var t=this;if(Qi(t),!Me(t,e)&&!Ft(t.display,e)){We(e),gl&&(Hs=+new Date);var r=Sr(t,e,!0),n=e.dataTransfer.files;if(r&&!t.isReadOnly())if(n&&n.length&&window.FileReader&&window.File)for(var i=n.length,o=Array(i),l=0,s=0;s<i;++s)!function(e,n){if(!t.options.allowDropFileTypes||-1!=h(t.options.allowDropFileTypes,e.type)){var s=new FileReader;s.onload=dn(t,function(){var e=s.result;if(/[\x00-\x08\x0e-\x1f]{2}/.test(e)&&(e=""),o[n]=e,++l==i){var a={from:r=U(t.doc,r),to:r,text:t.doc.splitLines(o.join(t.doc.lineSeparator())),origin:"paste"};Oi(t.doc,a),yi(t.doc,Rn(r,Bn(a)))}}),s.readAsText(e)}}(n[s],s);else{if(t.state.draggingText&&t.doc.sel.contains(r)>-1)return t.state.draggingText(e),void setTimeout(function(){return t.display.input.focus()},20);try{var a=e.dataTransfer.getData("Text");if(a){var u;if(t.state.draggingText&&!t.state.draggingText.copy&&(u=t.listSelections()),wi(t.doc,Rn(r,r)),u)for(var c=0;c<u.length;++c)Ei(t.doc,"",u[c].anchor,u[c].head,"drag");t.replaceSelection(a,"around","paste"),t.display.input.focus()}}catch(e){}}}}function qi(e,t){if(gl&&(!e.state.draggingText||+new Date-Hs<100))Fe(t);else if(!Me(e,t)&&!Ft(e.display,t)&&(t.dataTransfer.setData("Text",e.getSelection()),t.dataTransfer.effectAllowed="copyMove",t.dataTransfer.setDragImage&&!xl)){var r=n("img",null,null,"position: fixed; left: 0; top: 0;");r.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",wl&&(r.width=r.height=1,e.display.wrapper.appendChild(r),r._top=r.offsetTop),t.dataTransfer.setDragImage(r,0,0),wl&&r.parentNode.removeChild(r)}}function Zi(e,t){var i=Sr(e,t);if(i){var o=document.createDocumentFragment();Mr(e,i,o),e.display.dragCursor||(e.display.dragCursor=n("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),e.display.lineSpace.insertBefore(e.display.dragCursor,e.display.cursorDiv)),r(e.display.dragCursor,o)}}function Qi(e){e.display.dragCursor&&(e.display.lineSpace.removeChild(e.display.dragCursor),e.display.dragCursor=null)}function Ji(e){if(document.getElementsByClassName)for(var t=document.getElementsByClassName("CodeMirror"),r=0;r<t.length;r++){var n=t[r].CodeMirror;n&&e(n)}}function eo(){Fs||(to(),Fs=!0)}function to(){var e;Ql(window,"resize",function(){null==e&&(e=setTimeout(function(){e=null,Ji(ro)},100))}),Ql(window,"blur",function(){return Ji(Fr)})}function ro(e){var t=e.display;t.lastWrapHeight==t.wrapper.clientHeight&&t.lastWrapWidth==t.wrapper.clientWidth||(t.cachedCharWidth=t.cachedTextHeight=t.cachedPaddingH=null,t.scrollbarsClipped=!1,e.setSize())}function no(e){var t=e.split(/-(?!$)/);e=t[t.length-1];for(var r,n,i,o,l=0;l<t.length-1;l++){var s=t[l];if(/^(cmd|meta|m)$/i.test(s))o=!0;else if(/^a(lt)?$/i.test(s))r=!0;else if(/^(c|ctrl|control)$/i.test(s))n=!0;else{if(!/^s(hift)?$/i.test(s))throw new Error("Unrecognized modifier name: "+s);i=!0}}return r&&(e="Alt-"+e),n&&(e="Ctrl-"+e),o&&(e="Cmd-"+e),i&&(e="Shift-"+e),e}function io(e){var t={};for(var r in e)if(e.hasOwnProperty(r)){var n=e[r];if(/^(name|fallthrough|(de|at)tach)$/.test(r))continue;if("..."==n){delete e[r];continue}for(var i=v(r.split(" "),no),o=0;o<i.length;o++){var l=void 0,s=void 0;o==i.length-1?(s=i.join(" "),l=n):(s=i.slice(0,o+1).join(" "),l="...");var a=t[s];if(a){if(a!=l)throw new Error("Inconsistent bindings for "+s)}else t[s]=l}delete e[r]}for(var u in t)e[u]=t[u];return e}function oo(e,t,r,n){var i=(t=uo(t)).call?t.call(e,n):t[e];if(!1===i)return"nothing";if("..."===i)return"multi";if(null!=i&&r(i))return"handled";if(t.fallthrough){if("[object Array]"!=Object.prototype.toString.call(t.fallthrough))return oo(e,t.fallthrough,r,n);for(var o=0;o<t.fallthrough.length;o++){var l=oo(e,t.fallthrough[o],r,n);if(l)return l}}}function lo(e){var t="string"==typeof e?e:Es[e.keyCode];return"Ctrl"==t||"Alt"==t||"Shift"==t||"Mod"==t}function so(e,t,r){var n=e;return t.altKey&&"Alt"!=n&&(e="Alt-"+e),(Dl?t.metaKey:t.ctrlKey)&&"Ctrl"!=n&&(e="Ctrl-"+e),(Dl?t.ctrlKey:t.metaKey)&&"Cmd"!=n&&(e="Cmd-"+e),!r&&t.shiftKey&&"Shift"!=n&&(e="Shift-"+e),e}function ao(e,t){if(wl&&34==e.keyCode&&e.char)return!1;var r=Es[e.keyCode];return null!=r&&!e.altGraphKey&&so(r,e,t)}function uo(e){return"string"==typeof e?Rs[e]:e}function co(e,t){for(var r=e.doc.sel.ranges,n=[],i=0;i<r.length;i++){for(var o=t(r[i]);n.length&&P(o.from,g(n).to)<=0;){var l=n.pop();if(P(l.from,o.from)<0){o.from=l.from;break}}n.push(o)}hn(e,function(){for(var t=n.length-1;t>=0;t--)Ei(e.doc,"",n[t].from,n[t].to,"+delete");jr(e)})}function fo(e,t,r){var n=L(e.text,t+r,r);return n<0||n>e.text.length?null:n}function ho(e,t,r){var n=fo(e,t.ch,r);return null==n?null:new E(t.line,n,r<0?"after":"before")}function po(e,t,r,n,i){if(e){var o=Se(r,t.doc.direction);if(o){var l,s=i<0?g(o):o[0],a=i<0==(1==s.level)?"after":"before";if(s.level>0){var u=Xt(t,r);l=i<0?r.text.length-1:0;var c=Yt(t,u,l).top;l=k(function(e){return Yt(t,u,e).top==c},i<0==(1==s.level)?s.from:s.to-1,l),"before"==a&&(l=fo(r,l,1))}else l=i<0?s.to:s.from;return new E(n,l,a)}}return new E(n,i<0?r.text.length:0,i<0?"before":"after")}function go(e,t,r,n){var i=Se(t,e.doc.direction);if(!i)return ho(t,r,n);r.ch>=t.text.length?(r.ch=t.text.length,r.sticky="before"):r.ch<=0&&(r.ch=0,r.sticky="after");var o=Ce(i,r.ch,r.sticky),l=i[o];if("ltr"==e.doc.direction&&l.level%2==0&&(n>0?l.to>r.ch:l.from<r.ch))return ho(t,r,n);var s,a=function(e,r){return fo(t,e instanceof E?e.ch:e,r)},u=function(r){return e.options.lineWrapping?(s=s||Xt(e,t),hr(e,t,s,r)):{begin:0,end:t.text.length}},c=u("before"==r.sticky?a(r,-1):r.ch);if("rtl"==e.doc.direction||1==l.level){var f=1==l.level==n<0,h=a(r,f?1:-1);if(null!=h&&(f?h<=l.to&&h<=c.end:h>=l.from&&h>=c.begin)){var d=f?"before":"after";return new E(r.line,h,d)}}var p=function(e,t,n){for(var o=function(e,t){return t?new E(r.line,a(e,1),"before"):new E(r.line,e,"after")};e>=0&&e<i.length;e+=t){var l=i[e],s=t>0==(1!=l.level),u=s?n.begin:a(n.end,-1);if(l.from<=u&&u<l.to)return o(u,s);if(u=s?l.from:a(l.to,-1),n.begin<=u&&u<n.end)return o(u,s)}},g=p(o+n,n,c);if(g)return g;var v=n>0?c.end:a(c.begin,-1);return null==v||n>0&&v==t.text.length||!(g=p(n>0?0:i.length-1,n,u(v)))?null:g}function vo(e,t){var r=M(e.doc,t),n=fe(r);return n!=r&&(t=W(n)),po(!0,e,n,t,1)}function mo(e,t){var r=M(e.doc,t),n=he(r);return n!=r&&(t=W(n)),po(!0,e,r,t,-1)}function yo(e,t){var r=vo(e,t.line),n=M(e.doc,r.line),i=Se(n,e.doc.direction);if(!i||0==i[0].level){var o=Math.max(0,n.text.search(/\S/)),l=t.line==r.line&&t.ch<=o&&t.ch;return E(r.line,l?0:o,r.sticky)}return r}function bo(e,t,r){if("string"==typeof t&&!(t=Bs[t]))return!1;e.display.input.ensurePolled();var n=e.display.shift,i=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),r&&(e.display.shift=!1),i=t(e)!=Bl}finally{e.display.shift=n,e.state.suppressEdits=!1}return i}function wo(e,t,r){for(var n=0;n<e.state.keyMaps.length;n++){var i=oo(t,e.state.keyMaps[n],r,e);if(i)return i}return e.options.extraKeys&&oo(t,e.options.extraKeys,r,e)||oo(t,e.options.keyMap,r,e)}function xo(e,t,r,n){var i=e.state.keySeq;if(i){if(lo(t))return"handled";Gs.set(50,function(){e.state.keySeq==i&&(e.state.keySeq=null,e.display.input.reset())}),t=i+" "+t}var o=wo(e,t,n);return"multi"==o&&(e.state.keySeq=t),"handled"==o&&bt(e,"keyHandled",e,t,r),"handled"!=o&&"multi"!=o||(We(r),Ar(e)),i&&!o&&/\'$/.test(t)?(We(r),!0):!!o}function Co(e,t){var r=ao(t,!0);return!!r&&(t.shiftKey&&!e.state.keySeq?xo(e,"Shift-"+r,t,function(t){return bo(e,t,!0)})||xo(e,r,t,function(t){if("string"==typeof t?/^go[A-Z]/.test(t):t.motion)return bo(e,t)}):xo(e,r,t,function(t){return bo(e,t)}))}function So(e,t,r){return xo(e,"'"+r+"'",t,function(t){return bo(e,t,!0)})}function Lo(e){var t=this;if(t.curOp.focus=l(),!Me(t,e)){gl&&vl<11&&27==e.keyCode&&(e.returnValue=!1);var r=e.keyCode;t.display.shift=16==r||e.shiftKey;var n=Co(t,e);wl&&(Us=n?r:null,!n&&88==r&&!rs&&(Ml?e.metaKey:e.ctrlKey)&&t.replaceSelection("",null,"cut")),18!=r||/\bCodeMirror-crosshair\b/.test(t.display.lineDiv.className)||ko(t)}}function ko(e){function t(e){18!=e.keyCode&&e.altKey||(Fl(r,"CodeMirror-crosshair"),ke(document,"keyup",t),ke(document,"mouseover",t))}var r=e.display.lineDiv;s(r,"CodeMirror-crosshair"),Ql(document,"keyup",t),Ql(document,"mouseover",t)}function To(e){16==e.keyCode&&(this.doc.sel.shift=!1),Me(this,e)}function Mo(e){var t=this;if(!(Ft(t.display,e)||Me(t,e)||e.ctrlKey&&!e.altKey||Ml&&e.metaKey)){var r=e.keyCode,n=e.charCode;if(wl&&r==Us)return Us=null,void We(e);if(!wl||e.which&&!(e.which<10)||!Co(t,e)){var i=String.fromCharCode(null==n?r:n);"\b"!=i&&(So(t,e,i)||t.display.input.onKeyPress(e))}}}function No(e,t){var r=+new Date;return js&&js.compare(r,e,t)?(Ks=js=null,"triple"):Ks&&Ks.compare(r,e,t)?(js=new Vs(r,e,t),Ks=null,"double"):(Ks=new Vs(r,e,t),js=null,"single")}function Oo(e){var t=this,r=t.display;if(!(Me(t,e)||r.activeTouch&&r.input.supportsTouch()))if(r.input.ensurePolled(),r.shift=e.shiftKey,Ft(r,e))ml||(r.scroller.draggable=!1,setTimeout(function(){return r.scroller.draggable=!0},100));else if(!zo(t,e)){var n=Sr(t,e),i=Pe(e),o=n?No(n,i):"single";window.focus(),1==i&&t.state.selectingText&&t.state.selectingText(e),n&&Ao(t,i,n,o,e)||(1==i?n?Do(t,n,o,e):Ee(e)==r.scroller&&We(e):2==i?(n&&di(t.doc,n),setTimeout(function(){return r.input.focus()},20)):3==i&&(Hl?Ro(t,e):Dr(t)))}}function Ao(e,t,r,n,i){var o="Click";return"double"==n?o="Double"+o:"triple"==n&&(o="Triple"+o),o=(1==t?"Left":2==t?"Middle":"Right")+o,xo(e,so(o,i),i,function(t){if("string"==typeof t&&(t=Bs[t]),!t)return!1;var n=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),n=t(e,r)!=Bl}finally{e.state.suppressEdits=!1}return n})}function Wo(e,t,r){var n=e.getOption("configureMouse"),i=n?n(e,t,r):{};if(null==i.unit){var o=Nl?r.shiftKey&&r.metaKey:r.altKey;i.unit=o?"rectangle":"single"==t?"char":"double"==t?"word":"line"}return(null==i.extend||e.doc.extend)&&(i.extend=e.doc.extend||r.shiftKey),null==i.addNew&&(i.addNew=Ml?r.metaKey:r.ctrlKey),null==i.moveOnDrag&&(i.moveOnDrag=!(Ml?r.altKey:r.ctrlKey)),i}function Do(e,t,r,n){gl?setTimeout(u(Wr,e),0):e.curOp.focus=l();var i,o=Wo(e,r,n),s=e.doc.sel;e.options.dragDrop&&Jl&&!e.isReadOnly()&&"single"==r&&(i=s.contains(t))>-1&&(P((i=s.ranges[i]).from(),t)<0||t.xRel>0)&&(P(i.to(),t)>0||t.xRel<0)?Ho(e,n,t,o):Eo(e,n,t,o)}function Ho(e,t,r,n){var i=e.display,o=!1,l=dn(e,function(t){ml&&(i.scroller.draggable=!1),e.state.draggingText=!1,ke(document,"mouseup",l),ke(document,"mousemove",s),ke(i.scroller,"dragstart",a),ke(i.scroller,"drop",l),o||(We(t),n.addNew||di(e.doc,r,null,null,n.extend),ml||gl&&9==vl?setTimeout(function(){document.body.focus(),i.input.focus()},20):i.input.focus())}),s=function(e){o=o||Math.abs(t.clientX-e.clientX)+Math.abs(t.clientY-e.clientY)>=10},a=function(){return o=!0};ml&&(i.scroller.draggable=!0),e.state.draggingText=l,l.copy=!n.moveOnDrag,i.scroller.dragDrop&&i.scroller.dragDrop(),Ql(document,"mouseup",l),Ql(document,"mousemove",s),Ql(i.scroller,"dragstart",a),Ql(i.scroller,"drop",l),Dr(e),setTimeout(function(){return i.input.focus()},20)}function Fo(e,t,r){if("char"==r)return new Ts(t,t);if("word"==r)return e.findWordAt(t);if("line"==r)return new Ts(E(t.line,0),U(e.doc,E(t.line+1,0)));var n=r(e,t);return new Ts(n.from,n.to)}function Eo(e,t,r,n){function i(t){if(0!=P(m,t))if(m=t,"rectangle"==n.unit){for(var i=[],o=e.options.tabSize,l=f(M(u,r.line).text,r.ch,o),s=f(M(u,t.line).text,t.ch,o),a=Math.min(l,s),g=Math.max(l,s),v=Math.min(r.line,t.line),y=Math.min(e.lastLine(),Math.max(r.line,t.line));v<=y;v++){var b=M(u,v).text,w=d(b,a,o);a==g?i.push(new Ts(E(v,w),E(v,w))):b.length>w&&i.push(new Ts(E(v,w),E(v,d(b,g,o))))}i.length||i.push(new Ts(r,r)),bi(u,zn(p.ranges.slice(0,h).concat(i),h),{origin:"*mouse",scroll:!1}),e.scrollIntoView(t)}else{var x,C=c,S=Fo(e,t,n.unit),L=C.anchor;P(S.anchor,L)>0?(x=S.head,L=B(C.from(),S.anchor)):(x=S.anchor,L=R(C.to(),S.head));var k=p.ranges.slice(0);k[h]=Po(e,new Ts(U(u,L),x)),bi(u,zn(k,h),Ul)}}function o(t){var r=++b,s=Sr(e,t,!0,"rectangle"==n.unit);if(s)if(0!=P(s,m)){e.curOp.focus=l(),i(s);var c=Ir(a,u);(s.line>=c.to||s.line<c.from)&&setTimeout(dn(e,function(){b==r&&o(t)}),150)}else{var f=t.clientY<y.top?-20:t.clientY>y.bottom?20:0;f&&setTimeout(dn(e,function(){b==r&&(a.scroller.scrollTop+=f,o(t))}),50)}}function s(t){e.state.selectingText=!1,b=1/0,We(t),a.input.focus(),ke(document,"mousemove",w),ke(document,"mouseup",x),u.history.lastSelOrigin=null}var a=e.display,u=e.doc;We(t);var c,h,p=u.sel,g=p.ranges;if(n.addNew&&!n.extend?(h=u.sel.contains(r),c=h>-1?g[h]:new Ts(r,r)):(c=u.sel.primary(),h=u.sel.primIndex),"rectangle"==n.unit)n.addNew||(c=new Ts(r,r)),r=Sr(e,t,!0,!0),h=-1;else{var v=Fo(e,r,n.unit);c=n.extend?hi(c,v.anchor,v.head,n.extend):v}n.addNew?-1==h?(h=g.length,bi(u,zn(g.concat([c]),h),{scroll:!1,origin:"*mouse"})):g.length>1&&g[h].empty()&&"char"==n.unit&&!n.extend?(bi(u,zn(g.slice(0,h).concat(g.slice(h+1)),0),{scroll:!1,origin:"*mouse"}),p=u.sel):gi(u,h,c,Ul):(h=0,bi(u,new ks([c],0),Ul),p=u.sel);var m=r,y=a.wrapper.getBoundingClientRect(),b=0,w=dn(e,function(e){Pe(e)?o(e):s(e)}),x=dn(e,s);e.state.selectingText=x,Ql(document,"mousemove",w),Ql(document,"mouseup",x)}function Po(e,t){var r=t.anchor,n=t.head,i=M(e.doc,r.line);if(0==P(r,n)&&r.sticky==n.sticky)return t;var o=Se(i);if(!o)return t;var l=Ce(o,r.ch,r.sticky),s=o[l];if(s.from!=r.ch&&s.to!=r.ch)return t;var a=l+(s.from==r.ch==(1!=s.level)?0:1);if(0==a||a==o.length)return t;var u;if(n.line!=r.line)u=(n.line-r.line)*("ltr"==e.doc.direction?1:-1)>0;else{var c=Ce(o,n.ch,n.sticky),f=c-l||(n.ch-r.ch)*(1==s.level?-1:1);u=c==a-1||c==a?f<0:f>0}var h=o[a+(u?-1:0)],d=u==(1==h.level),p=d?h.from:h.to,g=d?"after":"before";return r.ch==p&&r.sticky==g?t:new Ts(new E(r.line,p,g),n)}function Io(e,t,r,n){var i,o;if(t.touches)i=t.touches[0].clientX,o=t.touches[0].clientY;else try{i=t.clientX,o=t.clientY}catch(t){return!1}if(i>=Math.floor(e.display.gutters.getBoundingClientRect().right))return!1;n&&We(t);var l=e.display,s=l.lineDiv.getBoundingClientRect();if(o>s.bottom||!Oe(e,r))return He(t);o-=s.top-l.viewOffset;for(var a=0;a<e.options.gutters.length;++a){var u=l.gutters.childNodes[a];if(u&&u.getBoundingClientRect().right>=i)return Te(e,r,e,D(e.doc,o),e.options.gutters[a],t),He(t)}}function zo(e,t){return Io(e,t,"gutterClick",!0)}function Ro(e,t){Ft(e.display,t)||Bo(e,t)||Me(e,t,"contextmenu")||e.display.input.onContextMenu(t)}function Bo(e,t){return!!Oe(e,"gutterContextMenu")&&Io(e,t,"gutterContextMenu",!1)}function Go(e){e.display.wrapper.className=e.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+e.options.theme.replace(/(^|\s)\s*/g," cm-s-"),er(e)}function Uo(e){Hn(e),vn(e),zr(e)}function Vo(e,t,r){if(!t!=!(r&&r!=Xs)){var n=e.display.dragFunctions,i=t?Ql:ke;i(e.display.scroller,"dragstart",n.start),i(e.display.scroller,"dragenter",n.enter),i(e.display.scroller,"dragover",n.over),i(e.display.scroller,"dragleave",n.leave),i(e.display.scroller,"drop",n.drop)}}function Ko(e){e.options.lineWrapping?(s(e.display.wrapper,"CodeMirror-wrap"),e.display.sizer.style.minWidth="",e.display.sizerWidth=null):(Fl(e.display.wrapper,"CodeMirror-wrap"),we(e)),Cr(e),vn(e),er(e),setTimeout(function(){return en(e)},100)}function jo(e,t){var r=this;if(!(this instanceof jo))return new jo(e,t);this.options=t=t?c(t):{},c(Ys,t,!1),Fn(t);var n=t.value;"string"==typeof n&&(n=new Ds(n,t.mode,null,t.lineSeparator,t.direction)),this.doc=n;var i=new jo.inputStyles[t.inputStyle](this),o=this.display=new T(e,n,i);o.wrapper.CodeMirror=this,Hn(this),Go(this),t.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),rn(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,delayingBlurEvent:!1,focused:!1,suppressEdits:!1,pasteIncoming:!1,cutIncoming:!1,selectingText:!1,draggingText:!1,highlight:new Pl,keySeq:null,specialChars:null},t.autofocus&&!Tl&&o.input.focus(),gl&&vl<11&&setTimeout(function(){return r.display.input.reset(!0)},20),Xo(this),eo(),nn(this),this.curOp.forceUpdate=!0,qn(this,n),t.autofocus&&!Tl||this.hasFocus()?setTimeout(u(Hr,this),20):Fr(this);for(var l in _s)_s.hasOwnProperty(l)&&_s[l](r,t[l],Xs);Rr(this),t.finishInit&&t.finishInit(this);for(var s=0;s<$s.length;++s)$s[s](r);on(this),ml&&t.lineWrapping&&"optimizelegibility"==getComputedStyle(o.lineDiv).textRendering&&(o.lineDiv.style.textRendering="auto")}function Xo(e){function t(){i.activeTouch&&(o=setTimeout(function(){return i.activeTouch=null},1e3),(l=i.activeTouch).end=+new Date)}function r(e){if(1!=e.touches.length)return!1;var t=e.touches[0];return t.radiusX<=1&&t.radiusY<=1}function n(e,t){if(null==t.left)return!0;var r=t.left-e.left,n=t.top-e.top;return r*r+n*n>400}var i=e.display;Ql(i.scroller,"mousedown",dn(e,Oo)),gl&&vl<11?Ql(i.scroller,"dblclick",dn(e,function(t){if(!Me(e,t)){var r=Sr(e,t);if(r&&!zo(e,t)&&!Ft(e.display,t)){We(t);var n=e.findWordAt(r);di(e.doc,n.anchor,n.head)}}})):Ql(i.scroller,"dblclick",function(t){return Me(e,t)||We(t)}),Hl||Ql(i.scroller,"contextmenu",function(t){return Ro(e,t)});var o,l={end:0};Ql(i.scroller,"touchstart",function(t){if(!Me(e,t)&&!r(t)&&!zo(e,t)){i.input.ensurePolled(),clearTimeout(o);var n=+new Date;i.activeTouch={start:n,moved:!1,prev:n-l.end<=300?l:null},1==t.touches.length&&(i.activeTouch.left=t.touches[0].pageX,i.activeTouch.top=t.touches[0].pageY)}}),Ql(i.scroller,"touchmove",function(){i.activeTouch&&(i.activeTouch.moved=!0)}),Ql(i.scroller,"touchend",function(r){var o=i.activeTouch;if(o&&!Ft(i,r)&&null!=o.left&&!o.moved&&new Date-o.start<300){var l,s=e.coordsChar(i.activeTouch,"page");l=!o.prev||n(o,o.prev)?new Ts(s,s):!o.prev.prev||n(o,o.prev.prev)?e.findWordAt(s):new Ts(E(s.line,0),U(e.doc,E(s.line+1,0))),e.setSelection(l.anchor,l.head),e.focus(),We(r)}t()}),Ql(i.scroller,"touchcancel",t),Ql(i.scroller,"scroll",function(){i.scroller.clientHeight&&(qr(e,i.scroller.scrollTop),Qr(e,i.scroller.scrollLeft,!0),Te(e,"scroll",e))}),Ql(i.scroller,"mousewheel",function(t){return In(e,t)}),Ql(i.scroller,"DOMMouseScroll",function(t){return In(e,t)}),Ql(i.wrapper,"scroll",function(){return i.wrapper.scrollTop=i.wrapper.scrollLeft=0}),i.dragFunctions={enter:function(t){Me(e,t)||Fe(t)},over:function(t){Me(e,t)||(Zi(e,t),Fe(t))},start:function(t){return qi(e,t)},drop:dn(e,$i),leave:function(t){Me(e,t)||Qi(e)}};var s=i.input.getField();Ql(s,"keyup",function(t){return To.call(e,t)}),Ql(s,"keydown",dn(e,Lo)),Ql(s,"keypress",dn(e,Mo)),Ql(s,"focus",function(t){return Hr(e,t)}),Ql(s,"blur",function(t){return Fr(e,t)})}function Yo(e,t,r,n){var i,o=e.doc;null==r&&(r="add"),"smart"==r&&(o.mode.indent?i=$e(e,t).state:r="prev");var l=e.options.tabSize,s=M(o,t),a=f(s.text,null,l);s.stateAfter&&(s.stateAfter=null);var u,c=s.text.match(/^\s*/)[0];if(n||/\S/.test(s.text)){if("smart"==r&&((u=o.mode.indent(i,s.text.slice(c.length),s.text))==Bl||u>150)){if(!n)return;r="prev"}}else u=0,r="not";"prev"==r?u=t>o.first?f(M(o,t-1).text,null,l):0:"add"==r?u=a+e.options.indentUnit:"subtract"==r?u=a-e.options.indentUnit:"number"==typeof r&&(u=a+r),u=Math.max(0,u);var h="",d=0;if(e.options.indentWithTabs)for(var g=Math.floor(u/l);g;--g)d+=l,h+="\t";if(d<u&&(h+=p(u-d)),h!=c)return Ei(o,h,E(t,0),E(t,c.length),"+input"),s.stateAfter=null,!0;for(var v=0;v<o.sel.ranges.length;v++){var m=o.sel.ranges[v];if(m.head.line==t&&m.head.ch<c.length){var y=E(t,c.length);gi(o,v,new Ts(y,y));break}}}function _o(e){qs=e}function $o(e,t,r,n,i){var o=e.doc;e.display.shift=!1,n||(n=o.sel);var l=e.state.pasteIncoming||"paste"==i,s=es(t),a=null;if(l&&n.ranges.length>1)if(qs&&qs.text.join("\n")==t){if(n.ranges.length%qs.text.length==0){a=[];for(var u=0;u<qs.text.length;u++)a.push(o.splitLines(qs.text[u]))}}else s.length==n.ranges.length&&e.options.pasteLinesPerSelection&&(a=v(s,function(e){return[e]}));for(var c,f=n.ranges.length-1;f>=0;f--){var h=n.ranges[f],d=h.from(),p=h.to();h.empty()&&(r&&r>0?d=E(d.line,d.ch-r):e.state.overwrite&&!l?p=E(p.line,Math.min(M(o,p.line).text.length,p.ch+g(s).length)):qs&&qs.lineWise&&qs.text.join("\n")==t&&(d=p=E(d.line,0))),c=e.curOp.updateInput;var m={from:d,to:p,text:a?a[f%a.length]:s,origin:i||(l?"paste":e.state.cutIncoming?"cut":"+input")};Oi(e.doc,m),bt(e,"inputRead",e,m)}t&&!l&&Zo(e,t),jr(e),e.curOp.updateInput=c,e.curOp.typing=!0,e.state.pasteIncoming=e.state.cutIncoming=!1}function qo(e,t){var r=e.clipboardData&&e.clipboardData.getData("Text");if(r)return e.preventDefault(),t.isReadOnly()||t.options.disableInput||hn(t,function(){return $o(t,r,0,null,"paste")}),!0}function Zo(e,t){if(e.options.electricChars&&e.options.smartIndent)for(var r=e.doc.sel,n=r.ranges.length-1;n>=0;n--){var i=r.ranges[n];if(!(i.head.ch>100||n&&r.ranges[n-1].head.line==i.head.line)){var o=e.getModeAt(i.head),l=!1;if(o.electricChars){for(var s=0;s<o.electricChars.length;s++)if(t.indexOf(o.electricChars.charAt(s))>-1){l=Yo(e,i.head.line,"smart");break}}else o.electricInput&&o.electricInput.test(M(e.doc,i.head.line).text.slice(0,i.head.ch))&&(l=Yo(e,i.head.line,"smart"));l&&bt(e,"electricInput",e,i.head.line)}}}function Qo(e){for(var t=[],r=[],n=0;n<e.doc.sel.ranges.length;n++){var i=e.doc.sel.ranges[n].head.line,o={anchor:E(i,0),head:E(i+1,0)};r.push(o),t.push(e.getRange(o.anchor,o.head))}return{text:t,ranges:r}}function Jo(e,t){e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!!t)}function el(){var e=n("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; outline: none"),t=n("div",[e],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return ml?e.style.width="1000px":e.setAttribute("wrap","off"),Ll&&(e.style.border="1px solid black"),Jo(e),t}function tl(e,t,r,n,i){function o(){var n=t.line+r;return!(n<e.first||n>=e.first+e.size)&&(t=new E(n,t.ch,t.sticky),u=M(e,n))}function l(n){var l;if(null==(l=i?go(e.cm,u,t,r):ho(u,t,r))){if(n||!o())return!1;t=po(i,e.cm,u,t.line,r)}else t=l;return!0}var s=t,a=r,u=M(e,t.line);if("char"==n)l();else if("column"==n)l(!0);else if("word"==n||"group"==n)for(var c=null,f="group"==n,h=e.cm&&e.cm.getHelper(t,"wordChars"),d=!0;!(r<0)||l(!d);d=!1){var p=u.text.charAt(t.ch)||"\n",g=x(p,h)?"w":f&&"\n"==p?"n":!f||/\s/.test(p)?null:"p";if(!f||d||g||(g="s"),c&&c!=g){r<0&&(r=1,l(),t.sticky="after");break}if(g&&(c=g),r>0&&!l(!d))break}var v=ki(e,t,s,a,!0);return I(s,v)&&(v.hitSide=!0),v}function rl(e,t,r,n){var i,o=e.doc,l=t.left;if("page"==n){var s=Math.min(e.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight),a=Math.max(s-.5*mr(e.display),3);i=(r>0?t.bottom:t.top)+r*a}else"line"==n&&(i=r>0?t.bottom+3:t.top-3);for(var u;(u=cr(e,l,i)).outside;){if(r<0?i<=0:i>=o.height){u.hitSide=!0;break}i+=5*r}return u}function nl(e,t){var r=jt(e,t.line);if(!r||r.hidden)return null;var n=M(e.doc,t.line),i=Ut(r,n,t.line),o=Se(n,e.doc.direction),l="left";o&&(l=Ce(o,t.ch)%2?"right":"left");var s=_t(i.map,t.ch,l);return s.offset="right"==s.collapse?s.end:s.start,s}function il(e){for(var t=e;t;t=t.parentNode)if(/CodeMirror-gutter-wrapper/.test(t.className))return!0;return!1}function ol(e,t){return t&&(e.bad=!0),e}function ll(e,t,r,n,i){function o(e){return function(t){return t.id==e}}function l(){c&&(u+=f,c=!1)}function s(e){e&&(l(),u+=e)}function a(t){if(1==t.nodeType){var r=t.getAttribute("cm-text");if(null!=r)return void s(r||t.textContent.replace(/\u200b/g,""));var u,h=t.getAttribute("cm-marker");if(h){var d=e.findMarks(E(n,0),E(i+1,0),o(+h));return void(d.length&&(u=d[0].find(0))&&s(N(e.doc,u.from,u.to).join(f)))}if("false"==t.getAttribute("contenteditable"))return;var p=/^(pre|div|p)$/i.test(t.nodeName);p&&l();for(var g=0;g<t.childNodes.length;g++)a(t.childNodes[g]);p&&(c=!0)}else 3==t.nodeType&&s(t.nodeValue)}for(var u="",c=!1,f=e.doc.lineSeparator();a(t),t!=r;)t=t.nextSibling;return u}function sl(e,t,r){var n;if(t==e.display.lineDiv){if(!(n=e.display.lineDiv.childNodes[r]))return ol(e.clipPos(E(e.display.viewTo-1)),!0);t=null,r=0}else for(n=t;;n=n.parentNode){if(!n||n==e.display.lineDiv)return null;if(n.parentNode&&n.parentNode==e.display.lineDiv)break}for(var i=0;i<e.display.view.length;i++){var o=e.display.view[i];if(o.node==n)return al(o,t,r)}}function al(e,t,r){function n(t,r,n){for(var i=-1;i<(f?f.length:0);i++)for(var o=i<0?c.map:f[i],l=0;l<o.length;l+=3){var s=o[l+2];if(s==t||s==r){var a=W(i<0?e.line:e.rest[i]),u=o[l]+n;return(n<0||s!=t)&&(u=o[l+(n?1:0)]),E(a,u)}}}var i=e.text.firstChild,l=!1;if(!t||!o(i,t))return ol(E(W(e.line),0),!0);if(t==i&&(l=!0,t=i.childNodes[r],r=0,!t)){var s=e.rest?g(e.rest):e.line;return ol(E(W(s),s.text.length),l)}var a=3==t.nodeType?t:null,u=t;for(a||1!=t.childNodes.length||3!=t.firstChild.nodeType||(a=t.firstChild,r&&(r=a.nodeValue.length));u.parentNode!=i;)u=u.parentNode;var c=e.measure,f=c.maps,h=n(a,u,r);if(h)return ol(h,l);for(var d=u.nextSibling,p=a?a.nodeValue.length-r:0;d;d=d.nextSibling){if(h=n(d,d.firstChild,0))return ol(E(h.line,h.ch-p),l);p+=d.textContent.length}for(var v=u.previousSibling,m=r;v;v=v.previousSibling){if(h=n(v,v.firstChild,-1))return ol(E(h.line,h.ch+m),l);m+=v.textContent.length}}var ul=navigator.userAgent,cl=navigator.platform,fl=/gecko\/\d/i.test(ul),hl=/MSIE \d/.test(ul),dl=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(ul),pl=/Edge\/(\d+)/.exec(ul),gl=hl||dl||pl,vl=gl&&(hl?document.documentMode||6:+(pl||dl)[1]),ml=!pl&&/WebKit\//.test(ul),yl=ml&&/Qt\/\d+\.\d+/.test(ul),bl=!pl&&/Chrome\//.test(ul),wl=/Opera\//.test(ul),xl=/Apple Computer/.test(navigator.vendor),Cl=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(ul),Sl=/PhantomJS/.test(ul),Ll=!pl&&/AppleWebKit/.test(ul)&&/Mobile\/\w+/.test(ul),kl=/Android/.test(ul),Tl=Ll||kl||/webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(ul),Ml=Ll||/Mac/.test(cl),Nl=/\bCrOS\b/.test(ul),Ol=/win/i.test(cl),Al=wl&&ul.match(/Version\/(\d*\.\d*)/);Al&&(Al=Number(Al[1])),Al&&Al>=15&&(wl=!1,ml=!0);var Wl,Dl=Ml&&(yl||wl&&(null==Al||Al<12.11)),Hl=fl||gl&&vl>=9,Fl=function(t,r){var n=t.className,i=e(r).exec(n);if(i){var o=n.slice(i.index+i[0].length);t.className=n.slice(0,i.index)+(o?i[1]+o:"")}};Wl=document.createRange?function(e,t,r,n){var i=document.createRange();return i.setEnd(n||e,r),i.setStart(e,t),i}:function(e,t,r){var n=document.body.createTextRange();try{n.moveToElementText(e.parentNode)}catch(e){return n}return n.collapse(!0),n.moveEnd("character",r),n.moveStart("character",t),n};var El=function(e){e.select()};Ll?El=function(e){e.selectionStart=0,e.selectionEnd=e.value.length}:gl&&(El=function(e){try{e.select()}catch(e){}});var Pl=function(){this.id=null};Pl.prototype.set=function(e,t){clearTimeout(this.id),this.id=setTimeout(t,e)};var Il,zl,Rl=30,Bl={toString:function(){return"CodeMirror.Pass"}},Gl={scroll:!1},Ul={origin:"*mouse"},Vl={origin:"+move"},Kl=[""],jl=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/,Xl=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/,Yl=!1,_l=!1,$l=null,ql=function(){function e(e){return e<=247?r.charAt(e):1424<=e&&e<=1524?"R":1536<=e&&e<=1785?n.charAt(e-1536):1774<=e&&e<=2220?"r":8192<=e&&e<=8203?"w":8204==e?"b":"L"}function t(e,t,r){this.level=e,this.from=t,this.to=r}var r="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",n="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111",i=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,o=/[stwN]/,l=/[LRr]/,s=/[Lb1n]/,a=/[1n]/;return function(r,n){var u="ltr"==n?"L":"R";if(0==r.length||"ltr"==n&&!i.test(r))return!1;for(var c=r.length,f=[],h=0;h<c;++h)f.push(e(r.charCodeAt(h)));for(var d=0,p=u;d<c;++d){var v=f[d];"m"==v?f[d]=p:p=v}for(var m=0,y=u;m<c;++m){var b=f[m];"1"==b&&"r"==y?f[m]="n":l.test(b)&&(y=b,"r"==b&&(f[m]="R"))}for(var w=1,x=f[0];w<c-1;++w){var C=f[w];"+"==C&&"1"==x&&"1"==f[w+1]?f[w]="1":","!=C||x!=f[w+1]||"1"!=x&&"n"!=x||(f[w]=x),x=C}for(var S=0;S<c;++S){var L=f[S];if(","==L)f[S]="N";else if("%"==L){var k=void 0;for(k=S+1;k<c&&"%"==f[k];++k);for(var T=S&&"!"==f[S-1]||k<c&&"1"==f[k]?"1":"N",M=S;M<k;++M)f[M]=T;S=k-1}}for(var N=0,O=u;N<c;++N){var A=f[N];"L"==O&&"1"==A?f[N]="L":l.test(A)&&(O=A)}for(var W=0;W<c;++W)if(o.test(f[W])){var D=void 0;for(D=W+1;D<c&&o.test(f[D]);++D);for(var H="L"==(W?f[W-1]:u),F=H==("L"==(D<c?f[D]:u))?H?"L":"R":u,E=W;E<D;++E)f[E]=F;W=D-1}for(var P,I=[],z=0;z<c;)if(s.test(f[z])){var R=z;for(++z;z<c&&s.test(f[z]);++z);I.push(new t(0,R,z))}else{var B=z,G=I.length;for(++z;z<c&&"L"!=f[z];++z);for(var U=B;U<z;)if(a.test(f[U])){B<U&&I.splice(G,0,new t(1,B,U));var V=U;for(++U;U<z&&a.test(f[U]);++U);I.splice(G,0,new t(2,V,U)),B=U}else++U;B<z&&I.splice(G,0,new t(1,B,z))}return 1==I[0].level&&(P=r.match(/^\s+/))&&(I[0].from=P[0].length,I.unshift(new t(0,0,P[0].length))),1==g(I).level&&(P=r.match(/\s+$/))&&(g(I).to-=P[0].length,I.push(new t(0,c-P[0].length,c))),"rtl"==n?I.reverse():I}}(),Zl=[],Ql=function(e,t,r){if(e.addEventListener)e.addEventListener(t,r,!1);else if(e.attachEvent)e.attachEvent("on"+t,r);else{var n=e._handlers||(e._handlers={});n[t]=(n[t]||Zl).concat(r)}},Jl=function(){if(gl&&vl<9)return!1;var e=n("div");return"draggable"in e||"dragDrop"in e}(),es=3!="\n\nb".split(/\n/).length?function(e){for(var t=0,r=[],n=e.length;t<=n;){var i=e.indexOf("\n",t);-1==i&&(i=e.length);var o=e.slice(t,"\r"==e.charAt(i-1)?i-1:i),l=o.indexOf("\r");-1!=l?(r.push(o.slice(0,l)),t+=l+1):(r.push(o),t=i+1)}return r}:function(e){return e.split(/\r\n?|\n/)},ts=window.getSelection?function(e){try{return e.selectionStart!=e.selectionEnd}catch(e){return!1}}:function(e){var t;try{t=e.ownerDocument.selection.createRange()}catch(e){}return!(!t||t.parentElement()!=e)&&0!=t.compareEndPoints("StartToEnd",t)},rs=function(){var e=n("div");return"oncopy"in e||(e.setAttribute("oncopy","return;"),"function"==typeof e.oncopy)}(),ns=null,is={},os={},ls={},ss=function(e,t,r){this.pos=this.start=0,this.string=e,this.tabSize=t||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0,this.lineOracle=r};ss.prototype.eol=function(){return this.pos>=this.string.length},ss.prototype.sol=function(){return this.pos==this.lineStart},ss.prototype.peek=function(){return this.string.charAt(this.pos)||void 0},ss.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},ss.prototype.eat=function(e){var t=this.string.charAt(this.pos);if("string"==typeof e?t==e:t&&(e.test?e.test(t):e(t)))return++this.pos,t},ss.prototype.eatWhile=function(e){for(var t=this.pos;this.eat(e););return this.pos>t},ss.prototype.eatSpace=function(){for(var e=this,t=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++e.pos;return this.pos>t},ss.prototype.skipToEnd=function(){this.pos=this.string.length},ss.prototype.skipTo=function(e){var t=this.string.indexOf(e,this.pos);if(t>-1)return this.pos=t,!0},ss.prototype.backUp=function(e){this.pos-=e},ss.prototype.column=function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=f(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?f(this.string,this.lineStart,this.tabSize):0)},ss.prototype.indentation=function(){return f(this.string,null,this.tabSize)-(this.lineStart?f(this.string,this.lineStart,this.tabSize):0)},ss.prototype.match=function(e,t,r){if("string"!=typeof e){var n=this.string.slice(this.pos).match(e);return n&&n.index>0?null:(n&&!1!==t&&(this.pos+=n[0].length),n)}var i=function(e){return r?e.toLowerCase():e};if(i(this.string.substr(this.pos,e.length))==i(e))return!1!==t&&(this.pos+=e.length),!0},ss.prototype.current=function(){return this.string.slice(this.start,this.pos)},ss.prototype.hideFirstChars=function(e,t){this.lineStart+=e;try{return t()}finally{this.lineStart-=e}},ss.prototype.lookAhead=function(e){var t=this.lineOracle;return t&&t.lookAhead(e)};var as=function(e,t){this.state=e,this.lookAhead=t},us=function(e,t,r,n){this.state=t,this.doc=e,this.line=r,this.maxLookAhead=n||0};us.prototype.lookAhead=function(e){var t=this.doc.getLine(this.line+e);return null!=t&&e>this.maxLookAhead&&(this.maxLookAhead=e),t},us.prototype.nextLine=function(){this.line++,this.maxLookAhead>0&&this.maxLookAhead--},us.fromSaved=function(e,t,r){return t instanceof as?new us(e,Ke(e.mode,t.state),r,t.lookAhead):new us(e,Ke(e.mode,t),r)},us.prototype.save=function(e){var t=!1!==e?Ke(this.doc.mode,this.state):this.state;return this.maxLookAhead>0?new as(t,this.maxLookAhead):t};var cs=function(e,t,r){this.start=e.start,this.end=e.pos,this.string=e.current(),this.type=t||null,this.state=r},fs=function(e,t,r){this.text=e,ne(this,t),this.height=r?r(this):1};fs.prototype.lineNo=function(){return W(this)},Ae(fs);var hs,ds={},ps={},gs=null,vs=null,ms={left:0,right:0,top:0,bottom:0},ys=function(e,t,r){this.cm=r;var i=this.vert=n("div",[n("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),o=this.horiz=n("div",[n("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");e(i),e(o),Ql(i,"scroll",function(){i.clientHeight&&t(i.scrollTop,"vertical")}),Ql(o,"scroll",function(){o.clientWidth&&t(o.scrollLeft,"horizontal")}),this.checkedZeroWidth=!1,gl&&vl<8&&(this.horiz.style.minHeight=this.vert.style.minWidth="18px")};ys.prototype.update=function(e){var t=e.scrollWidth>e.clientWidth+1,r=e.scrollHeight>e.clientHeight+1,n=e.nativeBarWidth;if(r){this.vert.style.display="block",this.vert.style.bottom=t?n+"px":"0";var i=e.viewHeight-(t?n:0);this.vert.firstChild.style.height=Math.max(0,e.scrollHeight-e.clientHeight+i)+"px"}else this.vert.style.display="",this.vert.firstChild.style.height="0";if(t){this.horiz.style.display="block",this.horiz.style.right=r?n+"px":"0",this.horiz.style.left=e.barLeft+"px";var o=e.viewWidth-e.barLeft-(r?n:0);this.horiz.firstChild.style.width=Math.max(0,e.scrollWidth-e.clientWidth+o)+"px"}else this.horiz.style.display="",this.horiz.firstChild.style.width="0";return!this.checkedZeroWidth&&e.clientHeight>0&&(0==n&&this.zeroWidthHack(),this.checkedZeroWidth=!0),{right:r?n:0,bottom:t?n:0}},ys.prototype.setScrollLeft=function(e){this.horiz.scrollLeft!=e&&(this.horiz.scrollLeft=e),this.disableHoriz&&this.enableZeroWidthBar(this.horiz,this.disableHoriz,"horiz")},ys.prototype.setScrollTop=function(e){this.vert.scrollTop!=e&&(this.vert.scrollTop=e),this.disableVert&&this.enableZeroWidthBar(this.vert,this.disableVert,"vert")},ys.prototype.zeroWidthHack=function(){var e=Ml&&!Cl?"12px":"18px";this.horiz.style.height=this.vert.style.width=e,this.horiz.style.pointerEvents=this.vert.style.pointerEvents="none",this.disableHoriz=new Pl,this.disableVert=new Pl},ys.prototype.enableZeroWidthBar=function(e,t,r){function n(){var i=e.getBoundingClientRect();("vert"==r?document.elementFromPoint(i.right-1,(i.top+i.bottom)/2):document.elementFromPoint((i.right+i.left)/2,i.bottom-1))!=e?e.style.pointerEvents="none":t.set(1e3,n)}e.style.pointerEvents="auto",t.set(1e3,n)},ys.prototype.clear=function(){var e=this.horiz.parentNode;e.removeChild(this.horiz),e.removeChild(this.vert)};var bs=function(){};bs.prototype.update=function(){return{bottom:0,right:0}},bs.prototype.setScrollLeft=function(){},bs.prototype.setScrollTop=function(){},bs.prototype.clear=function(){};var ws={native:ys,null:bs},xs=0,Cs=function(e,t,r){var n=e.display;this.viewport=t,this.visible=Ir(n,e.doc,t),this.editorIsHidden=!n.wrapper.offsetWidth,this.wrapperHeight=n.wrapper.clientHeight,this.wrapperWidth=n.wrapper.clientWidth,this.oldDisplayWidth=Rt(e),this.force=r,this.dims=br(e),this.events=[]};Cs.prototype.signal=function(e,t){Oe(e,t)&&this.events.push(arguments)},Cs.prototype.finish=function(){for(var e=this,t=0;t<this.events.length;t++)Te.apply(null,e.events[t])};var Ss=0,Ls=null;gl?Ls=-.53:fl?Ls=15:bl?Ls=-.7:xl&&(Ls=-1/3);var ks=function(e,t){this.ranges=e,this.primIndex=t};ks.prototype.primary=function(){return this.ranges[this.primIndex]},ks.prototype.equals=function(e){var t=this;if(e==this)return!0;if(e.primIndex!=this.primIndex||e.ranges.length!=this.ranges.length)return!1;for(var r=0;r<this.ranges.length;r++){var n=t.ranges[r],i=e.ranges[r];if(!I(n.anchor,i.anchor)||!I(n.head,i.head))return!1}return!0},ks.prototype.deepCopy=function(){for(var e=this,t=[],r=0;r<this.ranges.length;r++)t[r]=new Ts(z(e.ranges[r].anchor),z(e.ranges[r].head));return new ks(t,this.primIndex)},ks.prototype.somethingSelected=function(){for(var e=this,t=0;t<this.ranges.length;t++)if(!e.ranges[t].empty())return!0;return!1},ks.prototype.contains=function(e,t){var r=this;t||(t=e);for(var n=0;n<this.ranges.length;n++){var i=r.ranges[n];if(P(t,i.from())>=0&&P(e,i.to())<=0)return n}return-1};var Ts=function(e,t){this.anchor=e,this.head=t};Ts.prototype.from=function(){return B(this.anchor,this.head)},Ts.prototype.to=function(){return R(this.anchor,this.head)},Ts.prototype.empty=function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch},Bi.prototype={chunkSize:function(){return this.lines.length},removeInner:function(e,t){for(var r=this,n=e,i=e+t;n<i;++n){var o=r.lines[n];r.height-=o.height,ot(o),bt(o,"delete")}this.lines.splice(e,t)},collapse:function(e){e.push.apply(e,this.lines)},insertInner:function(e,t,r){var n=this;this.height+=r,this.lines=this.lines.slice(0,e).concat(t).concat(this.lines.slice(e));for(var i=0;i<t.length;++i)t[i].parent=n},iterN:function(e,t,r){for(var n=this,i=e+t;e<i;++e)if(r(n.lines[e]))return!0}},Gi.prototype={chunkSize:function(){return this.size},removeInner:function(e,t){var r=this;this.size-=t;for(var n=0;n<this.children.length;++n){var i=r.children[n],o=i.chunkSize();if(e<o){var l=Math.min(t,o-e),s=i.height;if(i.removeInner(e,l),r.height-=s-i.height,o==l&&(r.children.splice(n--,1),i.parent=null),0==(t-=l))break;e=0}else e-=o}if(this.size-t<25&&(this.children.length>1||!(this.children[0]instanceof Bi))){var a=[];this.collapse(a),this.children=[new Bi(a)],this.children[0].parent=this}},collapse:function(e){for(var t=this,r=0;r<this.children.length;++r)t.children[r].collapse(e)},insertInner:function(e,t,r){var n=this;this.size+=t.length,this.height+=r;for(var i=0;i<this.children.length;++i){var o=n.children[i],l=o.chunkSize();if(e<=l){if(o.insertInner(e,t,r),o.lines&&o.lines.length>50){for(var s=o.lines.length%25+25,a=s;a<o.lines.length;){var u=new Bi(o.lines.slice(a,a+=25));o.height-=u.height,n.children.splice(++i,0,u),u.parent=n}o.lines=o.lines.slice(0,s),n.maybeSpill()}break}e-=l}},maybeSpill:function(){if(!(this.children.length<=10)){var e=this;do{var t=new Gi(e.children.splice(e.children.length-5,5));if(e.parent){e.size-=t.size,e.height-=t.height;var r=h(e.parent.children,e);e.parent.children.splice(r+1,0,t)}else{var n=new Gi(e.children);n.parent=e,e.children=[n,t],e=n}t.parent=e.parent}while(e.children.length>10);e.parent.maybeSpill()}},iterN:function(e,t,r){for(var n=this,i=0;i<this.children.length;++i){var o=n.children[i],l=o.chunkSize();if(e<l){var s=Math.min(t,l-e);if(o.iterN(e,s,r))return!0;if(0==(t-=s))break;e=0}else e-=l}}};var Ms=function(e,t,r){var n=this;if(r)for(var i in r)r.hasOwnProperty(i)&&(n[i]=r[i]);this.doc=e,this.node=t};Ms.prototype.clear=function(){var e=this,t=this.doc.cm,r=this.line.widgets,n=this.line,i=W(n);if(null!=i&&r){for(var o=0;o<r.length;++o)r[o]==e&&r.splice(o--,1);r.length||(n.widgets=null);var l=Ht(this);A(n,Math.max(0,n.height-l)),t&&(hn(t,function(){Ui(t,n,-l),mn(t,i,"widget")}),bt(t,"lineWidgetCleared",t,this,i))}},Ms.prototype.changed=function(){var e=this,t=this.height,r=this.doc.cm,n=this.line;this.height=null;var i=Ht(this)-t;i&&(A(n,n.height+i),r&&hn(r,function(){r.curOp.forceUpdate=!0,Ui(r,n,i),bt(r,"lineWidgetChanged",r,e,W(n))}))},Ae(Ms);var Ns=0,Os=function(e,t){this.lines=[],this.type=t,this.doc=e,this.id=++Ns};Os.prototype.clear=function(){var e=this;if(!this.explicitlyCleared){var t=this.doc.cm,r=t&&!t.curOp;if(r&&nn(t),Oe(this,"clear")){var n=this.find();n&&bt(this,"clear",n.from,n.to)}for(var i=null,o=null,l=0;l<this.lines.length;++l){var s=e.lines[l],a=_(s.markedSpans,e);t&&!e.collapsed?mn(t,W(s),"text"):t&&(null!=a.to&&(o=W(s)),null!=a.from&&(i=W(s))),s.markedSpans=$(s.markedSpans,a),null==a.from&&e.collapsed&&!ve(e.doc,s)&&t&&A(s,mr(t.display))}if(t&&this.collapsed&&!t.options.lineWrapping)for(var u=0;u<this.lines.length;++u){var c=fe(e.lines[u]),f=be(c);f>t.display.maxLineLength&&(t.display.maxLine=c,t.display.maxLineLength=f,t.display.maxLineChanged=!0)}null!=i&&t&&this.collapsed&&vn(t,i,o+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,t&&Ci(t.doc)),t&&bt(t,"markerCleared",t,this,i,o),r&&on(t),this.parent&&this.parent.clear()}},Os.prototype.find=function(e,t){var r=this;null==e&&"bookmark"==this.type&&(e=1);for(var n,i,o=0;o<this.lines.length;++o){var l=r.lines[o],s=_(l.markedSpans,r);if(null!=s.from&&(n=E(t?l:W(l),s.from),-1==e))return n;if(null!=s.to&&(i=E(t?l:W(l),s.to),1==e))return i}return n&&{from:n,to:i}},Os.prototype.changed=function(){var e=this,t=this.find(-1,!0),r=this,n=this.doc.cm;t&&n&&hn(n,function(){var i=t.line,o=W(t.line),l=jt(n,o);if(l&&(Qt(l),n.curOp.selectionChanged=n.curOp.forceUpdate=!0),n.curOp.updateMaxLine=!0,!ve(r.doc,i)&&null!=r.height){var s=r.height;r.height=null;var a=Ht(r)-s;a&&A(i,i.height+a)}bt(n,"markerChanged",n,e)})},Os.prototype.attachLine=function(e){if(!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;t.maybeHiddenMarkers&&-1!=h(t.maybeHiddenMarkers,this)||(t.maybeUnhiddenMarkers||(t.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(e)},Os.prototype.detachLine=function(e){if(this.lines.splice(h(this.lines,e),1),!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;(t.maybeHiddenMarkers||(t.maybeHiddenMarkers=[])).push(this)}},Ae(Os);var As=function(e,t){var r=this;this.markers=e,this.primary=t;for(var n=0;n<e.length;++n)e[n].parent=r};As.prototype.clear=function(){var e=this;if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var t=0;t<this.markers.length;++t)e.markers[t].clear();bt(this,"clear")}},As.prototype.find=function(e,t){return this.primary.find(e,t)},Ae(As);var Ws=0,Ds=function(e,t,r,n,i){if(!(this instanceof Ds))return new Ds(e,t,r,n,i);null==r&&(r=0),Gi.call(this,[new Bi([new fs("",null)])]),this.first=r,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=r;var o=E(r,0);this.sel=Rn(o),this.history=new Jn(null),this.id=++Ws,this.modeOption=t,this.lineSep=n,this.direction="rtl"==i?"rtl":"ltr",this.extend=!1,"string"==typeof e&&(e=this.splitLines(e)),_n(this,{from:o,to:o,text:e}),bi(this,Rn(o),Gl)};Ds.prototype=b(Gi.prototype,{constructor:Ds,iter:function(e,t,r){r?this.iterN(e-this.first,t-e,r):this.iterN(this.first,this.first+this.size,e)},insert:function(e,t){for(var r=0,n=0;n<t.length;++n)r+=t[n].height;this.insertInner(e-this.first,t,r)},remove:function(e,t){this.removeInner(e-this.first,t)},getValue:function(e){var t=O(this,this.first,this.first+this.size);return!1===e?t:t.join(e||this.lineSeparator())},setValue:gn(function(e){var t=E(this.first,0),r=this.first+this.size-1;Oi(this,{from:t,to:E(r,M(this,r).text.length),text:this.splitLines(e),origin:"setValue",full:!0},!0),this.cm&&Xr(this.cm,0,0),bi(this,Rn(t),Gl)}),replaceRange:function(e,t,r,n){Ei(this,e,t=U(this,t),r=r?U(this,r):t,n)},getRange:function(e,t,r){var n=N(this,U(this,e),U(this,t));return!1===r?n:n.join(r||this.lineSeparator())},getLine:function(e){var t=this.getLineHandle(e);return t&&t.text},getLineHandle:function(e){if(H(this,e))return M(this,e)},getLineNumber:function(e){return W(e)},getLineHandleVisualStart:function(e){return"number"==typeof e&&(e=M(this,e)),fe(e)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(e){return U(this,e)},getCursor:function(e){var t=this.sel.primary();return null==e||"head"==e?t.head:"anchor"==e?t.anchor:"end"==e||"to"==e||!1===e?t.to():t.from()},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:gn(function(e,t,r){vi(this,U(this,"number"==typeof e?E(e,t||0):e),null,r)}),setSelection:gn(function(e,t,r){vi(this,U(this,e),U(this,t||e),r)}),extendSelection:gn(function(e,t,r){di(this,U(this,e),t&&U(this,t),r)}),extendSelections:gn(function(e,t){pi(this,K(this,e),t)}),extendSelectionsBy:gn(function(e,t){pi(this,K(this,v(this.sel.ranges,e)),t)}),setSelections:gn(function(e,t,r){var n=this;if(e.length){for(var i=[],o=0;o<e.length;o++)i[o]=new Ts(U(n,e[o].anchor),U(n,e[o].head));null==t&&(t=Math.min(e.length-1,this.sel.primIndex)),bi(this,zn(i,t),r)}}),addSelection:gn(function(e,t,r){var n=this.sel.ranges.slice(0);n.push(new Ts(U(this,e),U(this,t||e))),bi(this,zn(n,n.length-1),r)}),getSelection:function(e){for(var t,r=this,n=this.sel.ranges,i=0;i<n.length;i++){var o=N(r,n[i].from(),n[i].to());t=t?t.concat(o):o}return!1===e?t:t.join(e||this.lineSeparator())},getSelections:function(e){for(var t=this,r=[],n=this.sel.ranges,i=0;i<n.length;i++){var o=N(t,n[i].from(),n[i].to());!1!==e&&(o=o.join(e||t.lineSeparator())),r[i]=o}return r},replaceSelection:function(e,t,r){for(var n=[],i=0;i<this.sel.ranges.length;i++)n[i]=e;this.replaceSelections(n,t,r||"+input")},replaceSelections:gn(function(e,t,r){for(var n=this,i=[],o=this.sel,l=0;l<o.ranges.length;l++){var s=o.ranges[l];i[l]={from:s.from(),to:s.to(),text:n.splitLines(e[l]),origin:r}}for(var a=t&&"end"!=t&&Kn(this,i,t),u=i.length-1;u>=0;u--)Oi(n,i[u]);a?yi(this,a):this.cm&&jr(this.cm)}),undo:gn(function(){Wi(this,"undo")}),redo:gn(function(){Wi(this,"redo")}),undoSelection:gn(function(){Wi(this,"undo",!0)}),redoSelection:gn(function(){Wi(this,"redo",!0)}),setExtending:function(e){this.extend=e},getExtending:function(){return this.extend},historySize:function(){for(var e=this.history,t=0,r=0,n=0;n<e.done.length;n++)e.done[n].ranges||++t;for(var i=0;i<e.undone.length;i++)e.undone[i].ranges||++r;return{undo:t,redo:r}},clearHistory:function(){this.history=new Jn(this.history.maxGeneration)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(e){return e&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(e){return this.history.generation==(e||this.cleanGeneration)},getHistory:function(){return{done:fi(this.history.done),undone:fi(this.history.undone)}},setHistory:function(e){var t=this.history=new Jn(this.history.maxGeneration);t.done=fi(e.done.slice(0),null,!0),t.undone=fi(e.undone.slice(0),null,!0)},setGutterMarker:gn(function(e,t,r){return Ri(this,e,"gutter",function(e){var n=e.gutterMarkers||(e.gutterMarkers={});return n[t]=r,!r&&C(n)&&(e.gutterMarkers=null),!0})}),clearGutter:gn(function(e){var t=this;this.iter(function(r){r.gutterMarkers&&r.gutterMarkers[e]&&Ri(t,r,"gutter",function(){return r.gutterMarkers[e]=null,C(r.gutterMarkers)&&(r.gutterMarkers=null),!0})})}),lineInfo:function(e){var t;if("number"==typeof e){if(!H(this,e))return null;if(t=e,!(e=M(this,e)))return null}else if(null==(t=W(e)))return null;return{line:t,handle:e,text:e.text,gutterMarkers:e.gutterMarkers,textClass:e.textClass,bgClass:e.bgClass,wrapClass:e.wrapClass,widgets:e.widgets}},addLineClass:gn(function(t,r,n){return Ri(this,t,"gutter"==r?"gutter":"class",function(t){var i="text"==r?"textClass":"background"==r?"bgClass":"gutter"==r?"gutterClass":"wrapClass";if(t[i]){if(e(n).test(t[i]))return!1;t[i]+=" "+n}else t[i]=n;return!0})}),removeLineClass:gn(function(t,r,n){return Ri(this,t,"gutter"==r?"gutter":"class",function(t){var i="text"==r?"textClass":"background"==r?"bgClass":"gutter"==r?"gutterClass":"wrapClass",o=t[i];if(!o)return!1;if(null==n)t[i]=null;else{var l=o.match(e(n));if(!l)return!1;var s=l.index+l[0].length;t[i]=o.slice(0,l.index)+(l.index&&s!=o.length?" ":"")+o.slice(s)||null}return!0})}),addLineWidget:gn(function(e,t,r){return Vi(this,e,t,r)}),removeLineWidget:function(e){e.clear()},markText:function(e,t,r){return Ki(this,U(this,e),U(this,t),r,r&&r.type||"range")},setBookmark:function(e,t){var r={replacedWith:t&&(null==t.nodeType?t.widget:t),insertLeft:t&&t.insertLeft,clearWhenEmpty:!1,shared:t&&t.shared,handleMouseEvents:t&&t.handleMouseEvents};return e=U(this,e),Ki(this,e,e,r,"bookmark")},findMarksAt:function(e){var t=[],r=M(this,(e=U(this,e)).line).markedSpans;if(r)for(var n=0;n<r.length;++n){var i=r[n];(null==i.from||i.from<=e.ch)&&(null==i.to||i.to>=e.ch)&&t.push(i.marker.parent||i.marker)}return t},findMarks:function(e,t,r){e=U(this,e),t=U(this,t);var n=[],i=e.line;return this.iter(e.line,t.line+1,function(o){var l=o.markedSpans;if(l)for(var s=0;s<l.length;s++){var a=l[s];null!=a.to&&i==e.line&&e.ch>=a.to||null==a.from&&i!=e.line||null!=a.from&&i==t.line&&a.from>=t.ch||r&&!r(a.marker)||n.push(a.marker.parent||a.marker)}++i}),n},getAllMarks:function(){var e=[];return this.iter(function(t){var r=t.markedSpans;if(r)for(var n=0;n<r.length;++n)null!=r[n].from&&e.push(r[n].marker)}),e},posFromIndex:function(e){var t,r=this.first,n=this.lineSeparator().length;return this.iter(function(i){var o=i.text.length+n;if(o>e)return t=e,!0;e-=o,++r}),U(this,E(r,t))},indexFromPos:function(e){var t=(e=U(this,e)).ch;if(e.line<this.first||e.ch<0)return 0;var r=this.lineSeparator().length;return this.iter(this.first,e.line,function(e){t+=e.text.length+r}),t},copy:function(e){var t=new Ds(O(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return t.scrollTop=this.scrollTop,t.scrollLeft=this.scrollLeft,t.sel=this.sel,t.extend=!1,e&&(t.history.undoDepth=this.history.undoDepth,t.setHistory(this.getHistory())),t},linkedDoc:function(e){e||(e={});var t=this.first,r=this.first+this.size;null!=e.from&&e.from>t&&(t=e.from),null!=e.to&&e.to<r&&(r=e.to);var n=new Ds(O(this,t,r),e.mode||this.modeOption,t,this.lineSep,this.direction);return e.sharedHist&&(n.history=this.history),(this.linked||(this.linked=[])).push({doc:n,sharedHist:e.sharedHist}),n.linked=[{doc:this,isParent:!0,sharedHist:e.sharedHist}],Yi(n,Xi(this)),n},unlinkDoc:function(e){var t=this;if(e instanceof jo&&(e=e.doc),this.linked)for(var r=0;r<this.linked.length;++r)if(t.linked[r].doc==e){t.linked.splice(r,1),e.unlinkDoc(t),_i(Xi(t));break}if(e.history==this.history){var n=[e.id];$n(e,function(e){return n.push(e.id)},!0),e.history=new Jn(null),e.history.done=fi(this.history.done,n),e.history.undone=fi(this.history.undone,n)}},iterLinkedDocs:function(e){$n(this,e)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(e){return this.lineSep?e.split(this.lineSep):es(e)},lineSeparator:function(){return this.lineSep||"\n"},setDirection:gn(function(e){"rtl"!=e&&(e="ltr"),e!=this.direction&&(this.direction=e,this.iter(function(e){return e.order=null}),this.cm&&Qn(this.cm))})}),Ds.prototype.eachLine=Ds.prototype.iter;for(var Hs=0,Fs=!1,Es={3:"Enter",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",106:"*",107:"=",109:"-",110:".",111:"/",127:"Delete",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},Ps=0;Ps<10;Ps++)Es[Ps+48]=Es[Ps+96]=String(Ps);for(var Is=65;Is<=90;Is++)Es[Is]=String.fromCharCode(Is);for(var zs=1;zs<=12;zs++)Es[zs+111]=Es[zs+63235]="F"+zs;var Rs={};Rs.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},Rs.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Up":"goLineUp","Ctrl-Down":"goLineDown","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},Rs.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Alt-F":"goWordRight","Alt-B":"goWordLeft","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-D":"delWordAfter","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars","Ctrl-O":"openLine"},Rs.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Home":"goDocStart","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineLeft","Cmd-Right":"goLineRight","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delWrappedLineLeft","Cmd-Delete":"delWrappedLineRight","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd",fallthrough:["basic","emacsy"]},Rs.default=Ml?Rs.macDefault:Rs.pcDefault;var Bs={selectAll:Mi,singleSelection:function(e){return e.setSelection(e.getCursor("anchor"),e.getCursor("head"),Gl)},killLine:function(e){return co(e,function(t){if(t.empty()){var r=M(e.doc,t.head.line).text.length;return t.head.ch==r&&t.head.line<e.lastLine()?{from:t.head,to:E(t.head.line+1,0)}:{from:t.head,to:E(t.head.line,r)}}return{from:t.from(),to:t.to()}})},deleteLine:function(e){return co(e,function(t){return{from:E(t.from().line,0),to:U(e.doc,E(t.to().line+1,0))}})},delLineLeft:function(e){return co(e,function(e){return{from:E(e.from().line,0),to:e.from()}})},delWrappedLineLeft:function(e){return co(e,function(t){var r=e.charCoords(t.head,"div").top+5;return{from:e.coordsChar({left:0,top:r},"div"),to:t.from()}})},delWrappedLineRight:function(e){return co(e,function(t){var r=e.charCoords(t.head,"div").top+5,n=e.coordsChar({left:e.display.lineDiv.offsetWidth+100,top:r},"div");return{from:t.from(),to:n}})},undo:function(e){return e.undo()},redo:function(e){return e.redo()},undoSelection:function(e){return e.undoSelection()},redoSelection:function(e){return e.redoSelection()},goDocStart:function(e){return e.extendSelection(E(e.firstLine(),0))},goDocEnd:function(e){return e.extendSelection(E(e.lastLine()))},goLineStart:function(e){return e.extendSelectionsBy(function(t){return vo(e,t.head.line)},{origin:"+move",bias:1})},goLineStartSmart:function(e){return e.extendSelectionsBy(function(t){return yo(e,t.head)},{origin:"+move",bias:1})},goLineEnd:function(e){return e.extendSelectionsBy(function(t){return mo(e,t.head.line)},{origin:"+move",bias:-1})},goLineRight:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5;return e.coordsChar({left:e.display.lineDiv.offsetWidth+100,top:r},"div")},Vl)},goLineLeft:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5;return e.coordsChar({left:0,top:r},"div")},Vl)},goLineLeftSmart:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5,n=e.coordsChar({left:0,top:r},"div");return n.ch<e.getLine(n.line).search(/\S/)?yo(e,t.head):n},Vl)},goLineUp:function(e){return e.moveV(-1,"line")},goLineDown:function(e){return e.moveV(1,"line")},goPageUp:function(e){return e.moveV(-1,"page")},goPageDown:function(e){return e.moveV(1,"page")},goCharLeft:function(e){return e.moveH(-1,"char")},goCharRight:function(e){return e.moveH(1,"char")},goColumnLeft:function(e){return e.moveH(-1,"column")},goColumnRight:function(e){return e.moveH(1,"column")},goWordLeft:function(e){return e.moveH(-1,"word")},goGroupRight:function(e){return e.moveH(1,"group")},goGroupLeft:function(e){return e.moveH(-1,"group")},goWordRight:function(e){return e.moveH(1,"word")},delCharBefore:function(e){return e.deleteH(-1,"char")},delCharAfter:function(e){return e.deleteH(1,"char")},delWordBefore:function(e){return e.deleteH(-1,"word")},delWordAfter:function(e){return e.deleteH(1,"word")},delGroupBefore:function(e){return e.deleteH(-1,"group")},delGroupAfter:function(e){return e.deleteH(1,"group")},indentAuto:function(e){return e.indentSelection("smart")},indentMore:function(e){return e.indentSelection("add")},indentLess:function(e){return e.indentSelection("subtract")},insertTab:function(e){return e.replaceSelection("\t")},insertSoftTab:function(e){for(var t=[],r=e.listSelections(),n=e.options.tabSize,i=0;i<r.length;i++){var o=r[i].from(),l=f(e.getLine(o.line),o.ch,n);t.push(p(n-l%n))}e.replaceSelections(t)},defaultTab:function(e){e.somethingSelected()?e.indentSelection("add"):e.execCommand("insertTab")},transposeChars:function(e){return hn(e,function(){for(var t=e.listSelections(),r=[],n=0;n<t.length;n++)if(t[n].empty()){var i=t[n].head,o=M(e.doc,i.line).text;if(o)if(i.ch==o.length&&(i=new E(i.line,i.ch-1)),i.ch>0)i=new E(i.line,i.ch+1),e.replaceRange(o.charAt(i.ch-1)+o.charAt(i.ch-2),E(i.line,i.ch-2),i,"+transpose");else if(i.line>e.doc.first){var l=M(e.doc,i.line-1).text;l&&(i=new E(i.line,1),e.replaceRange(o.charAt(0)+e.doc.lineSeparator()+l.charAt(l.length-1),E(i.line-1,l.length-1),i,"+transpose"))}r.push(new Ts(i,i))}e.setSelections(r)})},newlineAndIndent:function(e){return hn(e,function(){for(var t=e.listSelections(),r=t.length-1;r>=0;r--)e.replaceRange(e.doc.lineSeparator(),t[r].anchor,t[r].head,"+input");t=e.listSelections();for(var n=0;n<t.length;n++)e.indentLine(t[n].from().line,null,!0);jr(e)})},openLine:function(e){return e.replaceSelection("\n","start")},toggleOverwrite:function(e){return e.toggleOverwrite()}},Gs=new Pl,Us=null,Vs=function(e,t,r){this.time=e,this.pos=t,this.button=r};Vs.prototype.compare=function(e,t,r){return this.time+400>e&&0==P(t,this.pos)&&r==this.button};var Ks,js,Xs={toString:function(){return"CodeMirror.Init"}},Ys={},_s={};jo.defaults=Ys,jo.optionHandlers=_s;var $s=[];jo.defineInitHook=function(e){return $s.push(e)};var qs=null,Zs=function(e){this.cm=e,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new Pl,this.composing=null,this.gracePeriod=!1,this.readDOMTimeout=null};Zs.prototype.init=function(e){function t(e){if(!Me(i,e)){if(i.somethingSelected())_o({lineWise:!1,text:i.getSelections()}),"cut"==e.type&&i.replaceSelection("",null,"cut");else{if(!i.options.lineWiseCopyCut)return;var t=Qo(i);_o({lineWise:!0,text:t.text}),"cut"==e.type&&i.operation(function(){i.setSelections(t.ranges,0,Gl),i.replaceSelection("",null,"cut")})}if(e.clipboardData){e.clipboardData.clearData();var r=qs.text.join("\n");if(e.clipboardData.setData("Text",r),e.clipboardData.getData("Text")==r)return void e.preventDefault()}var l=el(),s=l.firstChild;i.display.lineSpace.insertBefore(l,i.display.lineSpace.firstChild),s.value=qs.text.join("\n");var a=document.activeElement;El(s),setTimeout(function(){i.display.lineSpace.removeChild(l),a.focus(),a==o&&n.showPrimarySelection()},50)}}var r=this,n=this,i=n.cm,o=n.div=e.lineDiv;Jo(o,i.options.spellcheck),Ql(o,"paste",function(e){Me(i,e)||qo(e,i)||vl<=11&&setTimeout(dn(i,function(){return r.updateFromDOM()}),20)}),Ql(o,"compositionstart",function(e){r.composing={data:e.data,done:!1}}),Ql(o,"compositionupdate",function(e){r.composing||(r.composing={data:e.data,done:!1})}),Ql(o,"compositionend",function(e){r.composing&&(e.data!=r.composing.data&&r.readFromDOMSoon(),r.composing.done=!0)}),Ql(o,"touchstart",function(){return n.forceCompositionEnd()}),Ql(o,"input",function(){r.composing||r.readFromDOMSoon()}),Ql(o,"copy",t),Ql(o,"cut",t)},Zs.prototype.prepareSelection=function(){var e=Tr(this.cm,!1);return e.focus=this.cm.state.focused,e},Zs.prototype.showSelection=function(e,t){e&&this.cm.display.view.length&&((e.focus||t)&&this.showPrimarySelection(),this.showMultipleSelections(e))},Zs.prototype.showPrimarySelection=function(){var e=window.getSelection(),t=this.cm,r=t.doc.sel.primary(),n=r.from(),i=r.to();if(t.display.viewTo==t.display.viewFrom||n.line>=t.display.viewTo||i.line<t.display.viewFrom)e.removeAllRanges();else{var o=sl(t,e.anchorNode,e.anchorOffset),l=sl(t,e.focusNode,e.focusOffset);if(!o||o.bad||!l||l.bad||0!=P(B(o,l),n)||0!=P(R(o,l),i)){var s=t.display.view,a=n.line>=t.display.viewFrom&&nl(t,n)||{node:s[0].measure.map[2],offset:0},u=i.line<t.display.viewTo&&nl(t,i);if(!u){var c=s[s.length-1].measure,f=c.maps?c.maps[c.maps.length-1]:c.map;u={node:f[f.length-1],offset:f[f.length-2]-f[f.length-3]}}if(a&&u){var h,d=e.rangeCount&&e.getRangeAt(0);try{h=Wl(a.node,a.offset,u.offset,u.node)}catch(e){}h&&(!fl&&t.state.focused?(e.collapse(a.node,a.offset),h.collapsed||(e.removeAllRanges(),e.addRange(h))):(e.removeAllRanges(),e.addRange(h)),d&&null==e.anchorNode?e.addRange(d):fl&&this.startGracePeriod()),this.rememberSelection()}else e.removeAllRanges()}}},Zs.prototype.startGracePeriod=function(){var e=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout(function(){e.gracePeriod=!1,e.selectionChanged()&&e.cm.operation(function(){return e.cm.curOp.selectionChanged=!0})},20)},Zs.prototype.showMultipleSelections=function(e){r(this.cm.display.cursorDiv,e.cursors),r(this.cm.display.selectionDiv,e.selection)},Zs.prototype.rememberSelection=function(){var e=window.getSelection();this.lastAnchorNode=e.anchorNode,this.lastAnchorOffset=e.anchorOffset,this.lastFocusNode=e.focusNode,this.lastFocusOffset=e.focusOffset},Zs.prototype.selectionInEditor=function(){var e=window.getSelection();if(!e.rangeCount)return!1;var t=e.getRangeAt(0).commonAncestorContainer;return o(this.div,t)},Zs.prototype.focus=function(){"nocursor"!=this.cm.options.readOnly&&(this.selectionInEditor()||this.showSelection(this.prepareSelection(),!0),this.div.focus())},Zs.prototype.blur=function(){this.div.blur()},Zs.prototype.getField=function(){return this.div},Zs.prototype.supportsTouch=function(){return!0},Zs.prototype.receivedFocus=function(){function e(){t.cm.state.focused&&(t.pollSelection(),t.polling.set(t.cm.options.pollInterval,e))}var t=this;this.selectionInEditor()?this.pollSelection():hn(this.cm,function(){return t.cm.curOp.selectionChanged=!0}),this.polling.set(this.cm.options.pollInterval,e)},Zs.prototype.selectionChanged=function(){var e=window.getSelection();return e.anchorNode!=this.lastAnchorNode||e.anchorOffset!=this.lastAnchorOffset||e.focusNode!=this.lastFocusNode||e.focusOffset!=this.lastFocusOffset},Zs.prototype.pollSelection=function(){if(null==this.readDOMTimeout&&!this.gracePeriod&&this.selectionChanged()){var e=window.getSelection(),t=this.cm;if(kl&&bl&&this.cm.options.gutters.length&&il(e.anchorNode))return this.cm.triggerOnKeyDown({type:"keydown",keyCode:8,preventDefault:Math.abs}),this.blur(),void this.focus();if(!this.composing){this.rememberSelection();var r=sl(t,e.anchorNode,e.anchorOffset),n=sl(t,e.focusNode,e.focusOffset);r&&n&&hn(t,function(){bi(t.doc,Rn(r,n),Gl),(r.bad||n.bad)&&(t.curOp.selectionChanged=!0)})}}},Zs.prototype.pollContent=function(){null!=this.readDOMTimeout&&(clearTimeout(this.readDOMTimeout),this.readDOMTimeout=null);var e=this.cm,t=e.display,r=e.doc.sel.primary(),n=r.from(),i=r.to();if(0==n.ch&&n.line>e.firstLine()&&(n=E(n.line-1,M(e.doc,n.line-1).length)),i.ch==M(e.doc,i.line).text.length&&i.line<e.lastLine()&&(i=E(i.line+1,0)),n.line<t.viewFrom||i.line>t.viewTo-1)return!1;var o,l,s;n.line==t.viewFrom||0==(o=Lr(e,n.line))?(l=W(t.view[0].line),s=t.view[0].node):(l=W(t.view[o].line),s=t.view[o-1].node.nextSibling);var a,u,c=Lr(e,i.line);if(c==t.view.length-1?(a=t.viewTo-1,u=t.lineDiv.lastChild):(a=W(t.view[c+1].line)-1,u=t.view[c+1].node.previousSibling),!s)return!1;for(var f=e.doc.splitLines(ll(e,s,u,l,a)),h=N(e.doc,E(l,0),E(a,M(e.doc,a).text.length));f.length>1&&h.length>1;)if(g(f)==g(h))f.pop(),h.pop(),a--;else{if(f[0]!=h[0])break;f.shift(),h.shift(),l++}for(var d=0,p=0,v=f[0],m=h[0],y=Math.min(v.length,m.length);d<y&&v.charCodeAt(d)==m.charCodeAt(d);)++d;for(var b=g(f),w=g(h),x=Math.min(b.length-(1==f.length?d:0),w.length-(1==h.length?d:0));p<x&&b.charCodeAt(b.length-p-1)==w.charCodeAt(w.length-p-1);)++p;if(1==f.length&&1==h.length&&l==n.line)for(;d&&d>n.ch&&b.charCodeAt(b.length-p-1)==w.charCodeAt(w.length-p-1);)d--,p++;f[f.length-1]=b.slice(0,b.length-p).replace(/^\u200b+/,""),f[0]=f[0].slice(d).replace(/\u200b+$/,"");var C=E(l,d),S=E(a,h.length?g(h).length-p:0);return f.length>1||f[0]||P(C,S)?(Ei(e.doc,f,C,S,"+input"),!0):void 0},Zs.prototype.ensurePolled=function(){this.forceCompositionEnd()},Zs.prototype.reset=function(){this.forceCompositionEnd()},Zs.prototype.forceCompositionEnd=function(){this.composing&&(clearTimeout(this.readDOMTimeout),this.composing=null,this.updateFromDOM(),this.div.blur(),this.div.focus())},Zs.prototype.readFromDOMSoon=function(){var e=this;null==this.readDOMTimeout&&(this.readDOMTimeout=setTimeout(function(){if(e.readDOMTimeout=null,e.composing){if(!e.composing.done)return;e.composing=null}e.updateFromDOM()},80))},Zs.prototype.updateFromDOM=function(){var e=this;!this.cm.isReadOnly()&&this.pollContent()||hn(this.cm,function(){return vn(e.cm)})},Zs.prototype.setUneditable=function(e){e.contentEditable="false"},Zs.prototype.onKeyPress=function(e){0!=e.charCode&&(e.preventDefault(),this.cm.isReadOnly()||dn(this.cm,$o)(this.cm,String.fromCharCode(null==e.charCode?e.keyCode:e.charCode),0))},Zs.prototype.readOnlyChanged=function(e){this.div.contentEditable=String("nocursor"!=e)},Zs.prototype.onContextMenu=function(){},Zs.prototype.resetPosition=function(){},Zs.prototype.needsContentAttribute=!0;var Qs=function(e){this.cm=e,this.prevInput="",this.pollingFast=!1,this.polling=new Pl,this.hasSelection=!1,this.composing=null};Qs.prototype.init=function(e){function t(e){if(!Me(i,e)){if(i.somethingSelected())_o({lineWise:!1,text:i.getSelections()});else{if(!i.options.lineWiseCopyCut)return;var t=Qo(i);_o({lineWise:!0,text:t.text}),"cut"==e.type?i.setSelections(t.ranges,null,Gl):(n.prevInput="",l.value=t.text.join("\n"),El(l))}"cut"==e.type&&(i.state.cutIncoming=!0)}}var r=this,n=this,i=this.cm,o=this.wrapper=el(),l=this.textarea=o.firstChild;e.wrapper.insertBefore(o,e.wrapper.firstChild),Ll&&(l.style.width="0px"),Ql(l,"input",function(){gl&&vl>=9&&r.hasSelection&&(r.hasSelection=null),n.poll()}),Ql(l,"paste",function(e){Me(i,e)||qo(e,i)||(i.state.pasteIncoming=!0,n.fastPoll())}),Ql(l,"cut",t),Ql(l,"copy",t),Ql(e.scroller,"paste",function(t){Ft(e,t)||Me(i,t)||(i.state.pasteIncoming=!0,n.focus())}),Ql(e.lineSpace,"selectstart",function(t){Ft(e,t)||We(t)}),Ql(l,"compositionstart",function(){var e=i.getCursor("from");n.composing&&n.composing.range.clear(),n.composing={start:e,range:i.markText(e,i.getCursor("to"),{className:"CodeMirror-composing"})}}),Ql(l,"compositionend",function(){n.composing&&(n.poll(),n.composing.range.clear(),n.composing=null)})},Qs.prototype.prepareSelection=function(){var e=this.cm,t=e.display,r=e.doc,n=Tr(e);if(e.options.moveInputWithCursor){var i=sr(e,r.sel.primary().head,"div"),o=t.wrapper.getBoundingClientRect(),l=t.lineDiv.getBoundingClientRect();n.teTop=Math.max(0,Math.min(t.wrapper.clientHeight-10,i.top+l.top-o.top)),n.teLeft=Math.max(0,Math.min(t.wrapper.clientWidth-10,i.left+l.left-o.left))}return n},Qs.prototype.showSelection=function(e){var t=this.cm.display;r(t.cursorDiv,e.cursors),r(t.selectionDiv,e.selection),null!=e.teTop&&(this.wrapper.style.top=e.teTop+"px",this.wrapper.style.left=e.teLeft+"px")},Qs.prototype.reset=function(e){if(!this.contextMenuPending&&!this.composing){var t=this.cm;if(t.somethingSelected()){this.prevInput="";var r=t.getSelection();this.textarea.value=r,t.state.focused&&El(this.textarea),gl&&vl>=9&&(this.hasSelection=r)}else e||(this.prevInput=this.textarea.value="",gl&&vl>=9&&(this.hasSelection=null))}},Qs.prototype.getField=function(){return this.textarea},Qs.prototype.supportsTouch=function(){return!1},Qs.prototype.focus=function(){if("nocursor"!=this.cm.options.readOnly&&(!Tl||l()!=this.textarea))try{this.textarea.focus()}catch(e){}},Qs.prototype.blur=function(){this.textarea.blur()},Qs.prototype.resetPosition=function(){this.wrapper.style.top=this.wrapper.style.left=0},Qs.prototype.receivedFocus=function(){this.slowPoll()},Qs.prototype.slowPoll=function(){var e=this;this.pollingFast||this.polling.set(this.cm.options.pollInterval,function(){e.poll(),e.cm.state.focused&&e.slowPoll()})},Qs.prototype.fastPoll=function(){function e(){r.poll()||t?(r.pollingFast=!1,r.slowPoll()):(t=!0,r.polling.set(60,e))}var t=!1,r=this;r.pollingFast=!0,r.polling.set(20,e)},Qs.prototype.poll=function(){var e=this,t=this.cm,r=this.textarea,n=this.prevInput;if(this.contextMenuPending||!t.state.focused||ts(r)&&!n&&!this.composing||t.isReadOnly()||t.options.disableInput||t.state.keySeq)return!1;var i=r.value;if(i==n&&!t.somethingSelected())return!1;if(gl&&vl>=9&&this.hasSelection===i||Ml&&/[\uf700-\uf7ff]/.test(i))return t.display.input.reset(),!1;if(t.doc.sel==t.display.selForContextMenu){var o=i.charCodeAt(0);if(8203!=o||n||(n="​"),8666==o)return this.reset(),this.cm.execCommand("undo")}for(var l=0,s=Math.min(n.length,i.length);l<s&&n.charCodeAt(l)==i.charCodeAt(l);)++l;return hn(t,function(){$o(t,i.slice(l),n.length-l,null,e.composing?"*compose":null),i.length>1e3||i.indexOf("\n")>-1?r.value=e.prevInput="":e.prevInput=i,e.composing&&(e.composing.range.clear(),e.composing.range=t.markText(e.composing.start,t.getCursor("to"),{className:"CodeMirror-composing"}))}),!0},Qs.prototype.ensurePolled=function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},Qs.prototype.onKeyPress=function(){gl&&vl>=9&&(this.hasSelection=null),this.fastPoll()},Qs.prototype.onContextMenu=function(e){function t(){if(null!=l.selectionStart){var e=i.somethingSelected(),t="​"+(e?l.value:"");l.value="⇚",l.value=t,n.prevInput=e?"":"​",l.selectionStart=1,l.selectionEnd=t.length,o.selForContextMenu=i.doc.sel}}function r(){if(n.contextMenuPending=!1,n.wrapper.style.cssText=c,l.style.cssText=u,gl&&vl<9&&o.scrollbars.setScrollTop(o.scroller.scrollTop=a),null!=l.selectionStart){(!gl||gl&&vl<9)&&t();var e=0,r=function(){o.selForContextMenu==i.doc.sel&&0==l.selectionStart&&l.selectionEnd>0&&"​"==n.prevInput?dn(i,Mi)(i):e++<10?o.detectingSelectAll=setTimeout(r,500):(o.selForContextMenu=null,o.input.reset())};o.detectingSelectAll=setTimeout(r,200)}}var n=this,i=n.cm,o=i.display,l=n.textarea,s=Sr(i,e),a=o.scroller.scrollTop;if(s&&!wl){i.options.resetSelectionOnContextMenu&&-1==i.doc.sel.contains(s)&&dn(i,bi)(i.doc,Rn(s),Gl);var u=l.style.cssText,c=n.wrapper.style.cssText;n.wrapper.style.cssText="position: absolute";var f=n.wrapper.getBoundingClientRect();l.style.cssText="position: absolute; width: 30px; height: 30px;\n      top: "+(e.clientY-f.top-5)+"px; left: "+(e.clientX-f.left-5)+"px;\n      z-index: 1000; background: "+(gl?"rgba(255, 255, 255, .05)":"transparent")+";\n      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);";var h;if(ml&&(h=window.scrollY),o.input.focus(),ml&&window.scrollTo(null,h),o.input.reset(),i.somethingSelected()||(l.value=n.prevInput=" "),n.contextMenuPending=!0,o.selForContextMenu=i.doc.sel,clearTimeout(o.detectingSelectAll),gl&&vl>=9&&t(),Hl){Fe(e);var d=function(){ke(window,"mouseup",d),setTimeout(r,20)};Ql(window,"mouseup",d)}else setTimeout(r,50)}},Qs.prototype.readOnlyChanged=function(e){e||this.reset(),this.textarea.disabled="nocursor"==e},Qs.prototype.setUneditable=function(){},Qs.prototype.needsContentAttribute=!1,function(e){function t(t,n,i,o){e.defaults[t]=n,i&&(r[t]=o?function(e,t,r){r!=Xs&&i(e,t,r)}:i)}var r=e.optionHandlers;e.defineOption=t,e.Init=Xs,t("value","",function(e,t){return e.setValue(t)},!0),t("mode",null,function(e,t){e.doc.modeOption=t,jn(e)},!0),t("indentUnit",2,jn,!0),t("indentWithTabs",!1),t("smartIndent",!0),t("tabSize",4,function(e){Xn(e),er(e),vn(e)},!0),t("lineSeparator",null,function(e,t){if(e.doc.lineSep=t,t){var r=[],n=e.doc.first;e.doc.iter(function(e){for(var i=0;;){var o=e.text.indexOf(t,i);if(-1==o)break;i=o+t.length,r.push(E(n,o))}n++});for(var i=r.length-1;i>=0;i--)Ei(e.doc,t,r[i],E(r[i].line,r[i].ch+t.length))}}),t("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b-\u200f\u2028\u2029\ufeff]/g,function(e,t,r){e.state.specialChars=new RegExp(t.source+(t.test("\t")?"":"|\t"),"g"),r!=Xs&&e.refresh()}),t("specialCharPlaceholder",at,function(e){return e.refresh()},!0),t("electricChars",!0),t("inputStyle",Tl?"contenteditable":"textarea",function(){throw new Error("inputStyle can not (yet) be changed in a running editor")},!0),t("spellcheck",!1,function(e,t){return e.getInputField().spellcheck=t},!0),t("rtlMoveVisually",!Ol),t("wholeLineUpdateBefore",!0),t("theme","default",function(e){Go(e),Uo(e)},!0),t("keyMap","default",function(e,t,r){var n=uo(t),i=r!=Xs&&uo(r);i&&i.detach&&i.detach(e,n),n.attach&&n.attach(e,i||null)}),t("extraKeys",null),t("configureMouse",null),t("lineWrapping",!1,Ko,!0),t("gutters",[],function(e){Fn(e.options),Uo(e)},!0),t("fixedGutter",!0,function(e,t){e.display.gutters.style.left=t?wr(e.display)+"px":"0",e.refresh()},!0),t("coverGutterNextToScrollbar",!1,function(e){return en(e)},!0),t("scrollbarStyle","native",function(e){rn(e),en(e),e.display.scrollbars.setScrollTop(e.doc.scrollTop),e.display.scrollbars.setScrollLeft(e.doc.scrollLeft)},!0),t("lineNumbers",!1,function(e){Fn(e.options),Uo(e)},!0),t("firstLineNumber",1,Uo,!0),t("lineNumberFormatter",function(e){return e},Uo,!0),t("showCursorWhenSelecting",!1,kr,!0),t("resetSelectionOnContextMenu",!0),t("lineWiseCopyCut",!0),t("pasteLinesPerSelection",!0),t("readOnly",!1,function(e,t){"nocursor"==t&&(Fr(e),e.display.input.blur()),e.display.input.readOnlyChanged(t)}),t("disableInput",!1,function(e,t){t||e.display.input.reset()},!0),t("dragDrop",!0,Vo),t("allowDropFileTypes",null),t("cursorBlinkRate",530),t("cursorScrollMargin",0),t("cursorHeight",1,kr,!0),t("singleCursorHeightPerLine",!0,kr,!0),t("workTime",100),t("workDelay",100),t("flattenSpans",!0,Xn,!0),t("addModeClass",!1,Xn,!0),t("pollInterval",100),t("undoDepth",200,function(e,t){return e.doc.history.undoDepth=t}),t("historyEventDelay",1250),t("viewportMargin",10,function(e){return e.refresh()},!0),t("maxHighlightLength",1e4,Xn,!0),t("moveInputWithCursor",!0,function(e,t){t||e.display.input.resetPosition()}),t("tabindex",null,function(e,t){return e.display.input.getField().tabIndex=t||""}),t("autofocus",null),t("direction","ltr",function(e,t){return e.doc.setDirection(t)},!0)}(jo),function(e){var t=e.optionHandlers,r=e.helpers={};e.prototype={constructor:e,focus:function(){window.focus(),this.display.input.focus()},setOption:function(e,r){var n=this.options,i=n[e];n[e]==r&&"mode"!=e||(n[e]=r,t.hasOwnProperty(e)&&dn(this,t[e])(this,r,i),Te(this,"optionChange",this,e))},getOption:function(e){return this.options[e]},getDoc:function(){return this.doc},addKeyMap:function(e,t){this.state.keyMaps[t?"push":"unshift"](uo(e))},removeKeyMap:function(e){for(var t=this.state.keyMaps,r=0;r<t.length;++r)if(t[r]==e||t[r].name==e)return t.splice(r,1),!0},addOverlay:pn(function(t,r){var n=t.token?t:e.getMode(this.options,t);if(n.startState)throw new Error("Overlays may not be stateful.");m(this.state.overlays,{mode:n,modeSpec:t,opaque:r&&r.opaque,priority:r&&r.priority||0},function(e){return e.priority}),this.state.modeGen++,vn(this)}),removeOverlay:pn(function(e){for(var t=this,r=this.state.overlays,n=0;n<r.length;++n){var i=r[n].modeSpec;if(i==e||"string"==typeof e&&i.name==e)return r.splice(n,1),t.state.modeGen++,void vn(t)}}),indentLine:pn(function(e,t,r){"string"!=typeof t&&"number"!=typeof t&&(t=null==t?this.options.smartIndent?"smart":"prev":t?"add":"subtract"),H(this.doc,e)&&Yo(this,e,t,r)}),indentSelection:pn(function(e){for(var t=this,r=this.doc.sel.ranges,n=-1,i=0;i<r.length;i++){var o=r[i];if(o.empty())o.head.line>n&&(Yo(t,o.head.line,e,!0),n=o.head.line,i==t.doc.sel.primIndex&&jr(t));else{var l=o.from(),s=o.to(),a=Math.max(n,l.line);n=Math.min(t.lastLine(),s.line-(s.ch?0:1))+1;for(var u=a;u<n;++u)Yo(t,u,e);var c=t.doc.sel.ranges;0==l.ch&&r.length==c.length&&c[i].from().ch>0&&gi(t.doc,i,new Ts(l,c[i].to()),Gl)}}}),getTokenAt:function(e,t){return Je(this,e,t)},getLineTokens:function(e,t){return Je(this,E(e),t,!0)},getTokenTypeAt:function(e){e=U(this.doc,e);var t,r=_e(this,M(this.doc,e.line)),n=0,i=(r.length-1)/2,o=e.ch;if(0==o)t=r[2];else for(;;){var l=n+i>>1;if((l?r[2*l-1]:0)>=o)i=l;else{if(!(r[2*l+1]<o)){t=r[2*l+2];break}n=l+1}}var s=t?t.indexOf("overlay "):-1;return s<0?t:0==s?null:t.slice(0,s-1)},getModeAt:function(t){var r=this.doc.mode;return r.innerMode?e.innerMode(r,this.getTokenAt(t).state).mode:r},getHelper:function(e,t){return this.getHelpers(e,t)[0]},getHelpers:function(e,t){var n=this,i=[];if(!r.hasOwnProperty(t))return i;var o=r[t],l=this.getModeAt(e);if("string"==typeof l[t])o[l[t]]&&i.push(o[l[t]]);else if(l[t])for(var s=0;s<l[t].length;s++){var a=o[l[t][s]];a&&i.push(a)}else l.helperType&&o[l.helperType]?i.push(o[l.helperType]):o[l.name]&&i.push(o[l.name]);for(var u=0;u<o._global.length;u++){var c=o._global[u];c.pred(l,n)&&-1==h(i,c.val)&&i.push(c.val)}return i},getStateAfter:function(e,t){var r=this.doc;return e=G(r,null==e?r.first+r.size-1:e),$e(this,e+1,t).state},cursorCoords:function(e,t){var r,n=this.doc.sel.primary();return r=null==e?n.head:"object"==typeof e?U(this.doc,e):e?n.from():n.to(),sr(this,r,t||"page")},charCoords:function(e,t){return lr(this,U(this.doc,e),t||"page")},coordsChar:function(e,t){return e=or(this,e,t||"page"),cr(this,e.left,e.top)},lineAtHeight:function(e,t){return e=or(this,{top:e,left:0},t||"page").top,D(this.doc,e+this.display.viewOffset)},heightAtLine:function(e,t,r){var n,i=!1;if("number"==typeof e){var o=this.doc.first+this.doc.size-1;e<this.doc.first?e=this.doc.first:e>o&&(e=o,i=!0),n=M(this.doc,e)}else n=e;return ir(this,n,{top:0,left:0},t||"page",r||i).top+(i?this.doc.height-ye(n):0)},defaultTextHeight:function(){return mr(this.display)},defaultCharWidth:function(){return yr(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(e,t,r,n,i){var o=this.display,l=(e=sr(this,U(this.doc,e))).bottom,s=e.left;if(t.style.position="absolute",t.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(t),o.sizer.appendChild(t),"over"==n)l=e.top;else if("above"==n||"near"==n){var a=Math.max(o.wrapper.clientHeight,this.doc.height),u=Math.max(o.sizer.clientWidth,o.lineSpace.clientWidth);("above"==n||e.bottom+t.offsetHeight>a)&&e.top>t.offsetHeight?l=e.top-t.offsetHeight:e.bottom+t.offsetHeight<=a&&(l=e.bottom),s+t.offsetWidth>u&&(s=u-t.offsetWidth)}t.style.top=l+"px",t.style.left=t.style.right="","right"==i?(s=o.sizer.clientWidth-t.offsetWidth,t.style.right="0px"):("left"==i?s=0:"middle"==i&&(s=(o.sizer.clientWidth-t.offsetWidth)/2),t.style.left=s+"px"),r&&Ur(this,{left:s,top:l,right:s+t.offsetWidth,bottom:l+t.offsetHeight})},triggerOnKeyDown:pn(Lo),triggerOnKeyPress:pn(Mo),triggerOnKeyUp:To,triggerOnMouseDown:pn(Oo),execCommand:function(e){if(Bs.hasOwnProperty(e))return Bs[e].call(null,this)},triggerElectric:pn(function(e){Zo(this,e)}),findPosH:function(e,t,r,n){var i=this,o=1;t<0&&(o=-1,t=-t);for(var l=U(this.doc,e),s=0;s<t&&!(l=tl(i.doc,l,o,r,n)).hitSide;++s);return l},moveH:pn(function(e,t){var r=this;this.extendSelectionsBy(function(n){return r.display.shift||r.doc.extend||n.empty()?tl(r.doc,n.head,e,t,r.options.rtlMoveVisually):e<0?n.from():n.to()},Vl)}),deleteH:pn(function(e,t){var r=this.doc.sel,n=this.doc;r.somethingSelected()?n.replaceSelection("",null,"+delete"):co(this,function(r){var i=tl(n,r.head,e,t,!1);return e<0?{from:i,to:r.head}:{from:r.head,to:i}})}),findPosV:function(e,t,r,n){var i=this,o=1,l=n;t<0&&(o=-1,t=-t);for(var s=U(this.doc,e),a=0;a<t;++a){var u=sr(i,s,"div");if(null==l?l=u.left:u.left=l,(s=rl(i,u,o,r)).hitSide)break}return s},moveV:pn(function(e,t){var r=this,n=this.doc,i=[],o=!this.display.shift&&!n.extend&&n.sel.somethingSelected();if(n.extendSelectionsBy(function(l){if(o)return e<0?l.from():l.to();var s=sr(r,l.head,"div");null!=l.goalColumn&&(s.left=l.goalColumn),i.push(s.left);var a=rl(r,s,e,t);return"page"==t&&l==n.sel.primary()&&Kr(r,lr(r,a,"div").top-s.top),a},Vl),i.length)for(var l=0;l<n.sel.ranges.length;l++)n.sel.ranges[l].goalColumn=i[l]}),findWordAt:function(e){var t=M(this.doc,e.line).text,r=e.ch,n=e.ch;if(t){var i=this.getHelper(e,"wordChars");"before"!=e.sticky&&n!=t.length||!r?++n:--r;for(var o=t.charAt(r),l=x(o,i)?function(e){return x(e,i)}:/\s/.test(o)?function(e){return/\s/.test(e)}:function(e){return!/\s/.test(e)&&!x(e)};r>0&&l(t.charAt(r-1));)--r;for(;n<t.length&&l(t.charAt(n));)++n}return new Ts(E(e.line,r),E(e.line,n))},toggleOverwrite:function(e){null!=e&&e==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?s(this.display.cursorDiv,"CodeMirror-overwrite"):Fl(this.display.cursorDiv,"CodeMirror-overwrite"),Te(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==l()},isReadOnly:function(){return!(!this.options.readOnly&&!this.doc.cantEdit)},scrollTo:pn(function(e,t){Xr(this,e,t)}),getScrollInfo:function(){var e=this.display.scroller;return{left:e.scrollLeft,top:e.scrollTop,height:e.scrollHeight-zt(this)-this.display.barHeight,width:e.scrollWidth-zt(this)-this.display.barWidth,clientHeight:Bt(this),clientWidth:Rt(this)}},scrollIntoView:pn(function(e,t){null==e?(e={from:this.doc.sel.primary().head,to:null},null==t&&(t=this.options.cursorScrollMargin)):"number"==typeof e?e={from:E(e,0),to:null}:null==e.from&&(e={from:e,to:null}),e.to||(e.to=e.from),e.margin=t||0,null!=e.from.line?Yr(this,e):$r(this,e.from,e.to,e.margin)}),setSize:pn(function(e,t){var r=this,n=function(e){return"number"==typeof e||/^\d+$/.test(String(e))?e+"px":e};null!=e&&(this.display.wrapper.style.width=n(e)),null!=t&&(this.display.wrapper.style.height=n(t)),this.options.lineWrapping&&Jt(this);var i=this.display.viewFrom;this.doc.iter(i,this.display.viewTo,function(e){if(e.widgets)for(var t=0;t<e.widgets.length;t++)if(e.widgets[t].noHScroll){mn(r,i,"widget");break}++i}),this.curOp.forceUpdate=!0,Te(this,"refresh",this)}),operation:function(e){return hn(this,e)},startOperation:function(){return nn(this)},endOperation:function(){return on(this)},refresh:pn(function(){var e=this.display.cachedTextHeight;vn(this),this.curOp.forceUpdate=!0,er(this),Xr(this,this.doc.scrollLeft,this.doc.scrollTop),Wn(this),(null==e||Math.abs(e-mr(this.display))>.5)&&Cr(this),Te(this,"refresh",this)}),swapDoc:pn(function(e){var t=this.doc;return t.cm=null,qn(this,e),er(this),this.display.input.reset(),Xr(this,e.scrollLeft,e.scrollTop),this.curOp.forceScroll=!0,bt(this,"swapDoc",this,t),t}),getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},Ae(e),e.registerHelper=function(t,n,i){r.hasOwnProperty(t)||(r[t]=e[t]={_global:[]}),r[t][n]=i},e.registerGlobalHelper=function(t,n,i,o){e.registerHelper(t,n,o),r[t]._global.push({pred:i,val:o})}}(jo);var Js="iter insert remove copy getEditor constructor".split(" ");for(var ea in Ds.prototype)Ds.prototype.hasOwnProperty(ea)&&h(Js,ea)<0&&(jo.prototype[ea]=function(e){return function(){return e.apply(this.doc,arguments)}}(Ds.prototype[ea]));return Ae(Ds),jo.inputStyles={textarea:Qs,contenteditable:Zs},jo.defineMode=function(e){jo.defaults.mode||"null"==e||(jo.defaults.mode=e),Be.apply(this,arguments)},jo.defineMIME=function(e,t){os[e]=t},jo.defineMode("null",function(){return{token:function(e){return e.skipToEnd()}}}),jo.defineMIME("text/plain","null"),jo.defineExtension=function(e,t){jo.prototype[e]=t},jo.defineDocExtension=function(e,t){Ds.prototype[e]=t},jo.fromTextArea=function(e,t){function r(){e.value=a.getValue()}if(t=t?c(t):{},t.value=e.value,!t.tabindex&&e.tabIndex&&(t.tabindex=e.tabIndex),!t.placeholder&&e.placeholder&&(t.placeholder=e.placeholder),null==t.autofocus){var n=l();t.autofocus=n==e||null!=e.getAttribute("autofocus")&&n==document.body}var i;if(e.form&&(Ql(e.form,"submit",r),!t.leaveSubmitMethodAlone)){var o=e.form;i=o.submit;try{var s=o.submit=function(){r(),o.submit=i,o.submit(),o.submit=s}}catch(e){}}t.finishInit=function(t){t.save=r,t.getTextArea=function(){return e},t.toTextArea=function(){t.toTextArea=isNaN,r(),e.parentNode.removeChild(t.getWrapperElement()),e.style.display="",e.form&&(ke(e.form,"submit",r),"function"==typeof e.form.submit&&(e.form.submit=i))}},e.style.display="none";var a=jo(function(t){return e.parentNode.insertBefore(t,e.nextSibling)},t);return a},function(e){e.off=ke,e.on=Ql,e.wheelEventPixels=Pn,e.Doc=Ds,e.splitLines=es,e.countColumn=f,e.findColumn=d,e.isWordChar=w,e.Pass=Bl,e.signal=Te,e.Line=fs,e.changeEnd=Bn,e.scrollbarModel=ws,e.Pos=E,e.cmpPos=P,e.modes=is,e.mimeModes=os,e.resolveMode=Ge,e.getMode=Ue,e.modeExtensions=ls,e.extendMode=Ve,e.copyState=Ke,e.startState=Xe,e.innerMode=je,e.commands=Bs,e.keyMap=Rs,e.keyName=ao,e.isModifierKey=lo,e.lookupKey=oo,e.normalizeKeyMap=io,e.StringStream=ss,e.SharedTextMarker=As,e.TextMarker=Os,e.LineWidget=Ms,e.e_preventDefault=We,e.e_stopPropagation=De,e.e_stop=Fe,e.addClass=s,e.contains=o,e.rmClass=Fl,e.keyNames=Es}(jo),jo.version="5.30.0",jo});
      !function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){"use strict";function t(e,t,n,r,o,a){this.indented=e,this.column=t,this.type=n,this.info=r,this.align=o,this.prev=a}function n(e,n,r,o){var a=e.indented;return e.context&&"statement"==e.context.type&&"statement"!=r&&(a=e.context.indented),e.context=new t(a,n,r,o,null,e.context)}function r(e){var t=e.context.type;return")"!=t&&"]"!=t&&"}"!=t||(e.indented=e.context.indented),e.context=e.context.prev}function o(e,t,n){return"variable"==t.prevToken||"type"==t.prevToken||(!!/\S(?:[^- ]>|[*\]])\s*$|\*$/.test(e.string.slice(0,n))||(!(!t.typeAtEndOfLine||e.column()!=e.indentation())||void 0))}function a(e){for(;;){if(!e||"top"==e.type)return!0;if("}"==e.type&&"namespace"!=e.prev.info)return!1;e=e.prev}}function i(e){for(var t={},n=e.split(" "),r=0;r<n.length;++r)t[n[r]]=!0;return t}function l(e,t){return"function"==typeof e?e(t):e.propertyIsEnumerable(t)}function s(e,t){if(!t.startOfLine)return!1;for(var n,r=null;n=e.peek();){if("\\"==n&&e.match(/^.$/)){r=s;break}if("/"==n&&e.match(/^\/[\/\*]/,!1))break;e.next()}return t.tokenize=r,"meta"}function c(e,t){return"type"==t.prevToken&&"type"}function u(e){return e.eatWhile(/[\w\.']/),"number"}function d(e,t){if(e.backUp(1),e.match(/(R|u8R|uR|UR|LR)/)){var n=e.match(/"([^\s\\()]{0,16})\(/);return!!n&&(t.cpp11RawStringDelim=n[1],t.tokenize=m,m(e,t))}return e.match(/(u8|u|U|L)/)?!!e.match(/["']/,!1)&&"string":(e.next(),!1)}function f(e){var t=/(\w+)::~?(\w+)$/.exec(e);return t&&t[1]==t[2]}function p(e,t){for(var n;null!=(n=e.next());)if('"'==n&&!e.eat('"')){t.tokenize=null;break}return"string"}function m(e,t){var n=t.cpp11RawStringDelim.replace(/[^\w\s]/g,"\\$&");return e.match(new RegExp(".*?\\)"+n+'"'))?t.tokenize=null:e.skipToEnd(),"string"}function h(t,n){function r(e){if(e)for(var t in e)e.hasOwnProperty(t)&&o.push(t)}"string"==typeof t&&(t=[t]);var o=[];r(n.keywords),r(n.types),r(n.builtin),r(n.atoms),o.length&&(n.helperType=t[0],e.registerHelper("hintWords",t[0],o));for(var a=0;a<t.length;++a)e.defineMIME(t[a],n)}function g(e,t){for(var n=!1;!e.eol();){if(!n&&e.match('"""')){t.tokenize=null;break}n="\\"==e.next()&&!n}return"string"}function y(e){return function(t,n){for(var r,o=!1,a=!1;!t.eol();){if(!e&&!o&&t.match('"')){a=!0;break}if(e&&t.match('"""')){a=!0;break}r=t.next(),!o&&"$"==r&&t.match("{")&&t.skipTo("}"),o=!o&&"\\"==r&&!e}return!a&&e||(n.tokenize=null),"string"}}function x(e){return function(t,n){for(var r,o=!1,a=!1;!t.eol();){if(!o&&t.match('"')&&("single"==e||t.match('""'))){a=!0;break}if(!o&&t.match("``")){w=x(e),a=!0;break}r=t.next(),o="single"==e&&!o&&"\\"==r}return a&&(n.tokenize=null),"string"}}e.defineMode("clike",function(i,s){function c(e,t){var n=e.next();if(S[n]){var r=S[n](e,t);if(!1!==r)return r}if('"'==n||"'"==n)return t.tokenize=u(n),t.tokenize(e,t);if(D.test(n))return p=n,null;if(L.test(n)){if(e.backUp(1),e.match(I))return"number";e.next()}if("/"==n){if(e.eat("*"))return t.tokenize=d,d(e,t);if(e.eat("/"))return e.skipToEnd(),"comment"}if(F.test(n)){for(;!e.match(/^\/[\/*]/,!1)&&e.eat(F););return"operator"}if(e.eatWhile(z),P)for(;e.match(P);)e.eatWhile(z);var o=e.current();return l(x,o)?(l(w,o)&&(p="newstatement"),l(v,o)&&(m=!0),"keyword"):l(b,o)?"type":l(k,o)?(l(w,o)&&(p="newstatement"),"builtin"):l(_,o)?"atom":"variable"}function u(e){return function(t,n){for(var r,o=!1,a=!1;null!=(r=t.next());){if(r==e&&!o){a=!0;break}o=!o&&"\\"==r}return(a||!o&&!C)&&(n.tokenize=null),"string"}}function d(e,t){for(var n,r=!1;n=e.next();){if("/"==n&&r){t.tokenize=null;break}r="*"==n}return"comment"}function f(e,t){s.typeFirstDefinitions&&e.eol()&&a(t.context)&&(t.typeAtEndOfLine=o(e,t,e.pos))}var p,m,h=i.indentUnit,g=s.statementIndentUnit||h,y=s.dontAlignCalls,x=s.keywords||{},b=s.types||{},k=s.builtin||{},w=s.blockKeywords||{},v=s.defKeywords||{},_=s.atoms||{},S=s.hooks||{},C=s.multiLineStrings,T=!1!==s.indentStatements,M=!1!==s.indentSwitch,P=s.namespaceSeparator,D=s.isPunctuationChar||/[\[\]{}\(\),;\:\.]/,L=s.numberStart||/[\d\.]/,I=s.number||/^(?:0x[a-f\d]+|0b[01]+|(?:\d+\.?\d*|\.\d+)(?:e[-+]?\d+)?)(u|ll?|l|f)?/i,F=s.isOperatorChar||/[+\-*&%=<>!?|\/]/,z=s.isIdentifierChar||/[\w\$_\xa1-\uffff]/;return{startState:function(e){return{tokenize:null,context:new t((e||0)-h,0,"top",null,!1),indented:0,startOfLine:!0,prevToken:null}},token:function(e,t){var i=t.context;if(e.sol()&&(null==i.align&&(i.align=!1),t.indented=e.indentation(),t.startOfLine=!0),e.eatSpace())return f(e,t),null;p=m=null;var l=(t.tokenize||c)(e,t);if("comment"==l||"meta"==l)return l;if(null==i.align&&(i.align=!0),";"==p||":"==p||","==p&&e.match(/^\s*(?:\/\/.*)?$/,!1))for(;"statement"==t.context.type;)r(t);else if("{"==p)n(t,e.column(),"}");else if("["==p)n(t,e.column(),"]");else if("("==p)n(t,e.column(),")");else if("}"==p){for(;"statement"==i.type;)i=r(t);for("}"==i.type&&(i=r(t));"statement"==i.type;)i=r(t)}else p==i.type?r(t):T&&(("}"==i.type||"top"==i.type)&&";"!=p||"statement"==i.type&&"newstatement"==p)&&n(t,e.column(),"statement",e.current());if("variable"==l&&("def"==t.prevToken||s.typeFirstDefinitions&&o(e,t,e.start)&&a(t.context)&&e.match(/^\s*\(/,!1))&&(l="def"),S.token){var u=S.token(e,t,l);void 0!==u&&(l=u)}return"def"==l&&!1===s.styleDefs&&(l="variable"),t.startOfLine=!1,t.prevToken=m?"def":l||p,f(e,t),l},indent:function(t,n){if(t.tokenize!=c&&null!=t.tokenize||t.typeAtEndOfLine)return e.Pass;var r=t.context,o=n&&n.charAt(0);if("statement"==r.type&&"}"==o&&(r=r.prev),s.dontIndentStatements)for(;"statement"==r.type&&s.dontIndentStatements.test(r.info);)r=r.prev;if(S.indent){var a=S.indent(t,r,n);if("number"==typeof a)return a}var i=o==r.type,l=r.prev&&"switch"==r.prev.info;if(s.allmanIndentation&&/[{(]/.test(o)){for(;"top"!=r.type&&"}"!=r.type;)r=r.prev;return r.indented}return"statement"==r.type?r.indented+("{"==o?0:g):!r.align||y&&")"==r.type?")"!=r.type||i?r.indented+(i?0:h)+(i||!l||/^(?:case|default)\b/.test(n)?0:h):r.indented+g:r.column+(i?0:1)},electricInput:M?/^\s*(?:case .*?:|default:|\{\}?|\})$/:/^\s*[{}]$/,blockCommentStart:"/*",blockCommentEnd:"*/",lineComment:"//",fold:"brace"}});var b="auto if break case register continue return default do sizeof static else struct switch extern typedef union for goto while enum const volatile",k="int long char short double float unsigned signed void size_t ptrdiff_t";h(["text/x-csrc","text/x-c","text/x-chdr"],{name:"clike",keywords:i(b),types:i(k+" bool _Complex _Bool float_t double_t intptr_t intmax_t int8_t int16_t int32_t int64_t uintptr_t uintmax_t uint8_t uint16_t uint32_t uint64_t"),blockKeywords:i("case do else for if switch while struct"),defKeywords:i("struct"),typeFirstDefinitions:!0,atoms:i("null true false"),hooks:{"#":s,"*":c},modeProps:{fold:["brace","include"]}}),h(["text/x-c++src","text/x-c++hdr"],{name:"clike",keywords:i(b+" asm dynamic_cast namespace reinterpret_cast try explicit new static_cast typeid catch operator template typename class friend private this using const_cast inline public throw virtual delete mutable protected alignas alignof constexpr decltype nullptr noexcept thread_local final static_assert override"),types:i(k+" bool wchar_t"),blockKeywords:i("catch class do else finally for if struct switch try while"),defKeywords:i("class namespace struct enum union"),typeFirstDefinitions:!0,atoms:i("true false null"),dontIndentStatements:/^template$/,isIdentifierChar:/[\w\$_~\xa1-\uffff]/,hooks:{"#":s,"*":c,u:d,U:d,L:d,R:d,0:u,1:u,2:u,3:u,4:u,5:u,6:u,7:u,8:u,9:u,token:function(e,t,n){if("variable"==n&&"("==e.peek()&&(";"==t.prevToken||null==t.prevToken||"}"==t.prevToken)&&f(e.current()))return"def"}},namespaceSeparator:"::",modeProps:{fold:["brace","include"]}}),h("text/x-java",{name:"clike",keywords:i("abstract assert break case catch class const continue default do else enum extends final finally float for goto if implements import instanceof interface native new package private protected public return static strictfp super switch synchronized this throw throws transient try volatile while @interface"),types:i("byte short int long float double boolean char void Boolean Byte Character Double Float Integer Long Number Object Short String StringBuffer StringBuilder Void"),blockKeywords:i("catch class do else finally for if switch try while"),defKeywords:i("class interface package enum @interface"),typeFirstDefinitions:!0,atoms:i("true false null"),number:/^(?:0x[a-f\d_]+|0b[01_]+|(?:[\d_]+\.?\d*|\.\d+)(?:e[-+]?[\d_]+)?)(u|ll?|l|f)?/i,hooks:{"@":function(e){return!e.match("interface",!1)&&(e.eatWhile(/[\w\$_]/),"meta")}},modeProps:{fold:["brace","import"]}}),h("text/x-csharp",{name:"clike",keywords:i("abstract as async await base break case catch checked class const continue default delegate do else enum event explicit extern finally fixed for foreach goto if implicit in interface internal is lock namespace new operator out override params private protected public readonly ref return sealed sizeof stackalloc static struct switch this throw try typeof unchecked unsafe using virtual void volatile while add alias ascending descending dynamic from get global group into join let orderby partial remove select set value var yield"),types:i("Action Boolean Byte Char DateTime DateTimeOffset Decimal Double Func Guid Int16 Int32 Int64 Object SByte Single String Task TimeSpan UInt16 UInt32 UInt64 bool byte char decimal double short int long object sbyte float string ushort uint ulong"),blockKeywords:i("catch class do else finally for foreach if struct switch try while"),defKeywords:i("class interface namespace struct var"),typeFirstDefinitions:!0,atoms:i("true false null"),hooks:{"@":function(e,t){return e.eat('"')?(t.tokenize=p,p(e,t)):(e.eatWhile(/[\w\$_]/),"meta")}}}),h("text/x-scala",{name:"clike",keywords:i("abstract case catch class def do else extends final finally for forSome if implicit import lazy match new null object override package private protected return sealed super this throw trait try type val var while with yield _ assert assume require print println printf readLine readBoolean readByte readShort readChar readInt readLong readFloat readDouble"),types:i("AnyVal App Application Array BufferedIterator BigDecimal BigInt Char Console Either Enumeration Equiv Error Exception Fractional Function IndexedSeq Int Integral Iterable Iterator List Map Numeric Nil NotNull Option Ordered Ordering PartialFunction PartialOrdering Product Proxy Range Responder Seq Serializable Set Specializable Stream StringBuilder StringContext Symbol Throwable Traversable TraversableOnce Tuple Unit Vector Boolean Byte Character CharSequence Class ClassLoader Cloneable Comparable Compiler Double Exception Float Integer Long Math Number Object Package Pair Process Runtime Runnable SecurityManager Short StackTraceElement StrictMath String StringBuffer System Thread ThreadGroup ThreadLocal Throwable Triple Void"),multiLineStrings:!0,blockKeywords:i("catch class enum do else finally for forSome if match switch try while"),defKeywords:i("class enum def object package trait type val var"),atoms:i("true false null"),indentStatements:!1,indentSwitch:!1,isOperatorChar:/[+\-*&%=<>!?|\/#:@]/,hooks:{"@":function(e){return e.eatWhile(/[\w\$_]/),"meta"},'"':function(e,t){return!!e.match('""')&&(t.tokenize=g,t.tokenize(e,t))},"'":function(e){return e.eatWhile(/[\w\$_\xa1-\uffff]/),"atom"},"=":function(e,n){var r=n.context;return!("}"!=r.type||!r.align||!e.eat(">"))&&(n.context=new t(r.indented,r.column,r.type,r.info,null,r.prev),"operator")}},modeProps:{closeBrackets:{triples:'"'}}}),h("text/x-kotlin",{name:"clike",keywords:i("package as typealias class interface this super val var fun for is in This throw return break continue object if else while do try when !in !is as? file import where by get set abstract enum open inner override private public internal protected catch finally out final vararg reified dynamic companion constructor init sealed field property receiver param sparam lateinit data inline noinline tailrec external annotation crossinline const operator infix suspend"),types:i("Boolean Byte Character CharSequence Class ClassLoader Cloneable Comparable Compiler Double Exception Float Integer Long Math Number Object Package Pair Process Runtime Runnable SecurityManager Short StackTraceElement StrictMath String StringBuffer System Thread ThreadGroup ThreadLocal Throwable Triple Void"),intendSwitch:!1,indentStatements:!1,multiLineStrings:!0,number:/^(?:0x[a-f\d_]+|0b[01_]+|(?:[\d_]+\.?\d*|\.\d+)(?:e[-+]?[\d_]+)?)(u|ll?|l|f)?/i,blockKeywords:i("catch class do else finally for if where try while enum"),defKeywords:i("class val var object package interface fun"),atoms:i("true false null this"),hooks:{'"':function(e,t){return t.tokenize=y(e.match('""')),t.tokenize(e,t)}},modeProps:{closeBrackets:{triples:'"'}}}),h(["x-shader/x-vertex","x-shader/x-fragment"],{name:"clike",keywords:i("sampler1D sampler2D sampler3D samplerCube sampler1DShadow sampler2DShadow const attribute uniform varying break continue discard return for while do if else struct in out inout"),types:i("float int bool void vec2 vec3 vec4 ivec2 ivec3 ivec4 bvec2 bvec3 bvec4 mat2 mat3 mat4"),blockKeywords:i("for while do if else struct"),builtin:i("radians degrees sin cos tan asin acos atan pow exp log exp2 sqrt inversesqrt abs sign floor ceil fract mod min max clamp mix step smoothstep length distance dot cross normalize ftransform faceforward reflect refract matrixCompMult lessThan lessThanEqual greaterThan greaterThanEqual equal notEqual any all not texture1D texture1DProj texture1DLod texture1DProjLod texture2D texture2DProj texture2DLod texture2DProjLod texture3D texture3DProj texture3DLod texture3DProjLod textureCube textureCubeLod shadow1D shadow2D shadow1DProj shadow2DProj shadow1DLod shadow2DLod shadow1DProjLod shadow2DProjLod dFdx dFdy fwidth noise1 noise2 noise3 noise4"),atoms:i("true false gl_FragColor gl_SecondaryColor gl_Normal gl_Vertex gl_MultiTexCoord0 gl_MultiTexCoord1 gl_MultiTexCoord2 gl_MultiTexCoord3 gl_MultiTexCoord4 gl_MultiTexCoord5 gl_MultiTexCoord6 gl_MultiTexCoord7 gl_FogCoord gl_PointCoord gl_Position gl_PointSize gl_ClipVertex gl_FrontColor gl_BackColor gl_FrontSecondaryColor gl_BackSecondaryColor gl_TexCoord gl_FogFragCoord gl_FragCoord gl_FrontFacing gl_FragData gl_FragDepth gl_ModelViewMatrix gl_ProjectionMatrix gl_ModelViewProjectionMatrix gl_TextureMatrix gl_NormalMatrix gl_ModelViewMatrixInverse gl_ProjectionMatrixInverse gl_ModelViewProjectionMatrixInverse gl_TexureMatrixTranspose gl_ModelViewMatrixInverseTranspose gl_ProjectionMatrixInverseTranspose gl_ModelViewProjectionMatrixInverseTranspose gl_TextureMatrixInverseTranspose gl_NormalScale gl_DepthRange gl_ClipPlane gl_Point gl_FrontMaterial gl_BackMaterial gl_LightSource gl_LightModel gl_FrontLightModelProduct gl_BackLightModelProduct gl_TextureColor gl_EyePlaneS gl_EyePlaneT gl_EyePlaneR gl_EyePlaneQ gl_FogParameters gl_MaxLights gl_MaxClipPlanes gl_MaxTextureUnits gl_MaxTextureCoords gl_MaxVertexAttribs gl_MaxVertexUniformComponents gl_MaxVaryingFloats gl_MaxVertexTextureImageUnits gl_MaxTextureImageUnits gl_MaxFragmentUniformComponents gl_MaxCombineTextureImageUnits gl_MaxDrawBuffers"),indentSwitch:!1,hooks:{"#":s},modeProps:{fold:["brace","include"]}}),h("text/x-nesc",{name:"clike",keywords:i(b+"as atomic async call command component components configuration event generic implementation includes interface module new norace nx_struct nx_union post provides signal task uses abstract extends"),types:i(k),blockKeywords:i("case do else for if switch while struct"),atoms:i("null true false"),hooks:{"#":s},modeProps:{fold:["brace","include"]}}),h("text/x-objectivec",{name:"clike",keywords:i(b+"inline restrict _Bool _Complex _Imaginary BOOL Class bycopy byref id IMP in inout nil oneway out Protocol SEL self super atomic nonatomic retain copy readwrite readonly"),types:i(k),atoms:i("YES NO NULL NILL ON OFF true false"),hooks:{"@":function(e){return e.eatWhile(/[\w\$]/),"keyword"},"#":s,indent:function(e,t,n){if("statement"==t.type&&/^@\w/.test(n))return t.indented}},modeProps:{fold:"brace"}}),h("text/x-squirrel",{name:"clike",keywords:i("base break clone continue const default delete enum extends function in class foreach local resume return this throw typeof yield constructor instanceof static"),types:i(k),blockKeywords:i("case catch class else for foreach if switch try while"),defKeywords:i("function local class"),typeFirstDefinitions:!0,atoms:i("true false null"),hooks:{"#":s},modeProps:{fold:["brace","include"]}});var w=null;h("text/x-ceylon",{name:"clike",keywords:i("abstracts alias assembly assert assign break case catch class continue dynamic else exists extends finally for function given if import in interface is let module new nonempty object of out outer package return satisfies super switch then this throw try value void while"),types:function(e){var t=e.charAt(0);return t===t.toUpperCase()&&t!==t.toLowerCase()},blockKeywords:i("case catch class dynamic else finally for function if interface module new object switch try while"),defKeywords:i("class dynamic function interface module object package value"),builtin:i("abstract actual aliased annotation by default deprecated doc final formal late license native optional sealed see serializable shared suppressWarnings tagged throws variable"),isPunctuationChar:/[\[\]{}\(\),;\:\.`]/,isOperatorChar:/[+\-*&%=<>!?|^~:\/]/,numberStart:/[\d#$]/,number:/^(?:#[\da-fA-F_]+|\$[01_]+|[\d_]+[kMGTPmunpf]?|[\d_]+\.[\d_]+(?:[eE][-+]?\d+|[kMGTPmunpf]|)|)/i,multiLineStrings:!0,typeFirstDefinitions:!0,atoms:i("true false null larger smaller equal empty finished"),indentSwitch:!1,styleDefs:!1,hooks:{"@":function(e){return e.eatWhile(/[\w\$_]/),"meta"},'"':function(e,t){return t.tokenize=x(e.match('""')?"triple":"single"),t.tokenize(e,t)},"`":function(e,t){return!(!w||!e.match("`"))&&(t.tokenize=w,w=null,t.tokenize(e,t))},"'":function(e){return e.eatWhile(/[\w\$_\xa1-\uffff]/),"atom"},token:function(e,t,n){if(("variable"==n||"type"==n)&&"."==t.prevToken)return"variable-2"}},modeProps:{fold:["brace","import"],closeBrackets:{triples:'"'}}})});
      // -------------------------------------------------------------------------
//  Part of the CodeChecker project, under the Apache License v2.0 with
//  LLVM Exceptions. See LICENSE for license information.
//  SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
// -------------------------------------------------------------------------

var BugViewer = {
  _files : [],
  _reports : [],
  _lineWidgets : [],
  _navigationMenuItems : [],
  _sourceFileData : null,
  _currentReport : null,
  _lastBugEvent  : null,

  init : function (files, reports) {
    this._files = files;
    this._reports = reports;

    this.initEscapeChars();
  },

  initEscapeChars : function () {
    this.escapeChars = {
      ' ' : 'nbsp',
      '<' : 'lt',
      '>' : 'gt',
      '"' : 'quot',
      '&' : 'amp'
    };

    var regexString = '[';
    for (var key in this.escapeChars) {
      regexString += key;
    }
    regexString += ']';

    this.escapeRegExp = new RegExp( regexString, 'g');
  },

  escapeHTML : function (str) {
    var that = this;

    return str.replace(this.escapeRegExp, function (m) {
      return '&' + that.escapeChars[m] + ';';
    });
  },

  initByUrl : function () {
    if (!this._reports) return;

    var state = {};
    window.location.hash.substr(1).split('&').forEach(function (s) {
      var parts = s.split('=');
      state[parts[0]] = parts[1];
    });

    for (var key in this._reports) {
      var report = this._reports[key];
      if (report.reportHash === state['reportHash']) {
        this.navigate(report);
        return;
      }
    }

    this.navigate(this._reports[0]);
  },

  create : function () {
    this._content = document.getElementById('editor-wrapper');
    this._filepath = document.getElementById('file-path');
    this._checkerName = document.getElementById('checker-name');
    this._reviewStatusWrapper =
      document.getElementById('review-status-wrapper');
    this._reviewStatus = document.getElementById('review-status');
    this._editor = document.getElementById('editor');

    this._codeMirror = CodeMirror(this._editor, {
      mode: 'text/x-c++src',
      matchBrackets : true,
      lineNumbers : true,
      readOnly : true,
      foldGutter : true,
      extraKeys : {},
      viewportMargin : 100
    });

    this._createNavigationMenu();
  },

  navigate : function (report, item) {
    if (!item) {
      var items = this._navigationMenuItems.filter(function (navItem) {
        return navItem.report.reportHash === report.reportHash;
      });

      if (!items.length) return;

      item = items[0].widget;
    }

    this._selectedReport.classList.remove('active');
    this._selectedReport = item;
    this._selectedReport.classList.add('active');
    this.setReport(report);
  },

  _createNavigationMenu : function () {
    var that = this;

    var nav = document.getElementById('report-nav');
    var list = document.createElement('ul');
    this._reports.forEach(function (report) {
      var events = report['events'];
      var lastBugEvent = events[events.length - 1];
      var item = document.createElement('li');

      var severity = document.createElement('i');
      severity.className = 'severity-' + report.severity.toLowerCase();

      item.appendChild(severity);
      item.appendChild(document.createTextNode(lastBugEvent.message));

      item.addEventListener('click', function () {
        that.navigate(report, item);
      })
      list.appendChild(item);
      that._navigationMenuItems.push({ report : report, widget : item });
    });

    if (!this._selectedReport && list.childNodes.length) {
      this._selectedReport = list.childNodes[0];
      this._selectedReport.classList.add('active');
    }

    nav.appendChild(list);
  },

  setReport : function (report) {
    this._currentReport = report;
    var events = report['events'];
    var lastBugEvent = events[events.length - 1];
    this.setCurrentBugEvent(lastBugEvent, events.length - 1);
    this.setCheckerName(report.checkerName);
    this.setReviewStatus(report.reviewStatus);

    window.location.hash = '#reportHash=' + report.reportHash;
  },

  setCurrentBugEvent : function (event, idx) {
    this._currentBugEvent = event;
    this.setSourceFileData(this._files[event.location.file]);
    this.drawBugPath();

    this.jumpTo(event.location.line, 0);
    this.highlightBugEvent(event, idx);
  },

  highlightBugEvent : function (event, idx) {
    this._lineWidgets.forEach(function (widget) {
      var lineIdx = widget.node.getAttribute('idx');
      if (parseInt(lineIdx) === idx) {
        widget.node.classList.add('current');
      }
    });
  },

  setCheckerName : function (checkerName) {
    this._checkerName.innerHTML = checkerName;
  },

  setReviewStatus : function (status) {
    if (status) {
      var className =
        'review-status-' + status.toLowerCase().split(' ').join('-');
      this._reviewStatus.className = "review-status " + className;

      this._reviewStatus.innerHTML = status;
      this._reviewStatusWrapper.style.display = 'block';
    } else {
      this._reviewStatusWrapper.style.display = 'none';
    }
  },

  setSourceFileData : function (file) {
    if (this._sourceFileData && file.id === this._sourceFileData.id) {
      return;
    }

    this._sourceFileData = file;
    this._filepath.innerHTML = file.path;
    this._codeMirror.doc.setValue(file.content);
    this._refresh();
  },

  _refresh : function () {
    var that = this;
    setTimeout(function () {
      var fullHeight = parseInt(that._content.clientHeight);
      var headerHeight = that._filepath.clientHeight;

      that._codeMirror.setSize('auto', fullHeight - headerHeight);
      that._codeMirror.refresh();
    }, 200);
  },

  clearBubbles : function () {
    this._lineWidgets.forEach(function (widget) { widget.clear(); });
    this._lineWidgets = [];
  },

  getMessage : function (event, kind) {
    if (kind === 'macro') {
      var name = 'macro expansion' + (event.name ? ': ' + event.name : '');

      return '<span class="tag macro">' + name + '</span>'
        + this.escapeHTML(event.expansion).replace(/(?:\r\n|\r|\n)/g, '<br>');
    } else if (kind === 'note') {
      return '<span class="tag note">note</span>'
        +  this.escapeHTML(event.message).replace(/(?:\r\n|\r|\n)/g, '<br>');
    }
  },

  addExtraPathEvents : function (events, kind) {
    var that = this;

    if (!events) {
      return;
    }

    events.forEach(function (event) {
      if (event.location.file !== that._currentBugEvent.location.file) {
        return;
      }

      var left =
        that._codeMirror.defaultCharWidth() * event.location.col + 'px';

      var element = document.createElement('div');
      element.setAttribute('style', 'margin-left: ' + left);
      element.setAttribute('class', 'check-msg ' + kind);

      var msg = document.createElement('span');
      msg.innerHTML = that.getMessage(event, kind);
      element.appendChild(msg);

      that._lineWidgets.push(that._codeMirror.addLineWidget(
        event.location.line - 1, element));
    });
  },

  drawBugPath : function () {
    var that = this;

    this.clearBubbles();

    this.addExtraPathEvents(this._currentReport.macros, 'macro');
    this.addExtraPathEvents(this._currentReport.notes, 'note');

    // Processing bug path events.
    var currentEvents = this._currentReport.events;
    currentEvents.forEach(function (event, step) {
      if (event.location.file !== that._currentBugEvent.location.file)
        return;

      var left =
        that._codeMirror.defaultCharWidth() * event.location.col + 'px';
      var type = step === currentEvents.length - 1 ? 'error' : 'info';

      var element = document.createElement('div');
      element.setAttribute('style', 'margin-left: ' + left);
      element.setAttribute('class', 'check-msg ' + type);
      element.setAttribute('idx', step);

      var enumeration = document.createElement('span');
      enumeration.setAttribute('class', 'checker-enum ' + type);
      enumeration.innerHTML = step + 1;

      if (currentEvents.length > 1)
        element.appendChild(enumeration);

      var prevBugEvent = step - 1;
      if (step > 0) {
        var prevBug = document.createElement('span');
        prevBug.setAttribute('class', 'arrow left-arrow');
        prevBug.addEventListener('click', function () {
          var event = currentEvents[prevBugEvent];
          that.setCurrentBugEvent(event, prevBugEvent);
        });
        element.appendChild(prevBug);
      }

      var msg = document.createElement('span');
      msg.innerHTML = that.escapeHTML(event.message)
        .replace(/(?:\r\n|\r|\n)/g, '<br>');

      element.appendChild(msg);

      var nextBugEvent = step + 1;
      if (nextBugEvent < currentEvents.length) {
        var nextBug = document.createElement('span');
        nextBug.setAttribute('class', 'arrow right-arrow');
        nextBug.addEventListener('click', function () {
          var event = currentEvents[nextBugEvent];
          that.setCurrentBugEvent(event, nextBugEvent);
        });
        element.appendChild(nextBug);
      }


      that._lineWidgets.push(that._codeMirror.addLineWidget(
        event.location.line - 1, element));
    });
  },

  jumpTo : function (line, column) {
    var that = this;

    setTimeout(function () {
      var selPosPixel
        = that._codeMirror.charCoords({ line : line, ch : column }, 'local');
      var editorSize = {
        width  : that._editor.clientWidth,
        height : that._editor.clientHeight
      };

      that._codeMirror.scrollIntoView({
        top    : selPosPixel.top - 100,
        bottom : selPosPixel.top + editorSize.height - 150,
        left   : selPosPixel.left < editorSize.width - 100
               ? 0
               : selPosPixel.left - 50,
        right  : selPosPixel.left < editorSize.width - 100
               ? 10
               : selPosPixel.left + editorSize.width - 100
      });
    }, 0);
  }
}


      var data = {"files": {"0": {"id": 0, "path": "/src/net/wireless/reg.c", "content": "/*\n * Copyright 2002-2005, Instant802 Networks, Inc.\n * Copyright 2005-2006, Devicescape Software, Inc.\n * Copyright 2007\tJohannes Berg <johannes@sipsolutions.net>\n * Copyright 2008-2011\tLuis R. Rodriguez <mcgrof@qca.qualcomm.com>\n * Copyright 2013-2014  Intel Mobile Communications GmbH\n * Copyright      2017  Intel Deutschland GmbH\n * Copyright (C) 2018 - 2019 Intel Corporation\n *\n * Permission to use, copy, modify, and/or distribute this software for any\n * purpose with or without fee is hereby granted, provided that the above\n * copyright notice and this permission notice appear in all copies.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES\n * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF\n * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR\n * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES\n * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN\n * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF\n * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n */\n\n\n/**\n * DOC: Wireless regulatory infrastructure\n *\n * The usual implementation is for a driver to read a device EEPROM to\n * determine which regulatory domain it should be operating under, then\n * looking up the allowable channels in a driver-local table and finally\n * registering those channels in the wiphy structure.\n *\n * Another set of compliance enforcement is for drivers to use their\n * own compliance limits which can be stored on the EEPROM. The host\n * driver or firmware may ensure these are used.\n *\n * In addition to all this we provide an extra layer of regulatory\n * conformance. For drivers which do not have any regulatory\n * information CRDA provides the complete regulatory solution.\n * For others it provides a community effort on further restrictions\n * to enhance compliance.\n *\n * Note: When number of rules --> infinity we will not be able to\n * index on alpha2 any more, instead we'll probably have to\n * rely on some SHA1 checksum of the regdomain for example.\n *\n */\n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/kernel.h>\n#include <linux/export.h>\n#include <linux/slab.h>\n#include <linux/list.h>\n#include <linux/ctype.h>\n#include <linux/nl80211.h>\n#include <linux/platform_device.h>\n#include <linux/verification.h>\n#include <linux/moduleparam.h>\n#include <linux/firmware.h>\n#include <net/cfg80211.h>\n#include \"core.h\"\n#include \"reg.h\"\n#include \"rdev-ops.h\"\n#include \"nl80211.h\"\n\n/*\n * Grace period we give before making sure all current interfaces reside on\n * channels allowed by the current regulatory domain.\n */\n#define REG_ENFORCE_GRACE_MS 60000\n\n/**\n * enum reg_request_treatment - regulatory request treatment\n *\n * @REG_REQ_OK: continue processing the regulatory request\n * @REG_REQ_IGNORE: ignore the regulatory request\n * @REG_REQ_INTERSECT: the regulatory domain resulting from this request should\n *\tbe intersected with the current one.\n * @REG_REQ_ALREADY_SET: the regulatory request will not change the current\n *\tregulatory settings, and no further processing is required.\n */\nenum reg_request_treatment {\n\tREG_REQ_OK,\n\tREG_REQ_IGNORE,\n\tREG_REQ_INTERSECT,\n\tREG_REQ_ALREADY_SET,\n};\n\nstatic struct regulatory_request core_request_world = {\n\t.initiator = NL80211_REGDOM_SET_BY_CORE,\n\t.alpha2[0] = '0',\n\t.alpha2[1] = '0',\n\t.intersect = false,\n\t.processed = true,\n\t.country_ie_env = ENVIRON_ANY,\n};\n\n/*\n * Receipt of information from last regulatory request,\n * protected by RTNL (and can be accessed with RCU protection)\n */\nstatic struct regulatory_request __rcu *last_request =\n\t(void __force __rcu *)&core_request_world;\n\n/* To trigger userspace events and load firmware */\nstatic struct platform_device *reg_pdev;\n\n/*\n * Central wireless core regulatory domains, we only need two,\n * the current one and a world regulatory domain in case we have no\n * information to give us an alpha2.\n * (protected by RTNL, can be read under RCU)\n */\nconst struct ieee80211_regdomain __rcu *cfg80211_regdomain;\n\n/*\n * Number of devices that registered to the core\n * that support cellular base station regulatory hints\n * (protected by RTNL)\n */\nstatic int reg_num_devs_support_basehint;\n\n/*\n * State variable indicating if the platform on which the devices\n * are attached is operating in an indoor environment. The state variable\n * is relevant for all registered devices.\n */\nstatic bool reg_is_indoor;\nstatic spinlock_t reg_indoor_lock;\n\n/* Used to track the userspace process controlling the indoor setting */\nstatic u32 reg_is_indoor_portid;\n\nstatic void restore_regulatory_settings(bool reset_user, bool cached);\nstatic void print_regdomain(const struct ieee80211_regdomain *rd);\n\nstatic const struct ieee80211_regdomain *get_cfg80211_regdom(void)\n{\n\treturn rcu_dereference_rtnl(cfg80211_regdomain);\n}\n\nconst struct ieee80211_regdomain *get_wiphy_regdom(struct wiphy *wiphy)\n{\n\treturn rcu_dereference_rtnl(wiphy->regd);\n}\n\nstatic const char *reg_dfs_region_str(enum nl80211_dfs_regions dfs_region)\n{\n\tswitch (dfs_region) {\n\tcase NL80211_DFS_UNSET:\n\t\treturn \"unset\";\n\tcase NL80211_DFS_FCC:\n\t\treturn \"FCC\";\n\tcase NL80211_DFS_ETSI:\n\t\treturn \"ETSI\";\n\tcase NL80211_DFS_JP:\n\t\treturn \"JP\";\n\t}\n\treturn \"Unknown\";\n}\n\nenum nl80211_dfs_regions reg_get_dfs_region(struct wiphy *wiphy)\n{\n\tconst struct ieee80211_regdomain *regd = NULL;\n\tconst struct ieee80211_regdomain *wiphy_regd = NULL;\n\n\tregd = get_cfg80211_regdom();\n\tif (!wiphy)\n\t\tgoto out;\n\n\twiphy_regd = get_wiphy_regdom(wiphy);\n\tif (!wiphy_regd)\n\t\tgoto out;\n\n\tif (wiphy_regd->dfs_region == regd->dfs_region)\n\t\tgoto out;\n\n\tpr_debug(\"%s: device specific dfs_region (%s) disagrees with cfg80211's central dfs_region (%s)\\n\",\n\t\t dev_name(&wiphy->dev),\n\t\t reg_dfs_region_str(wiphy_regd->dfs_region),\n\t\t reg_dfs_region_str(regd->dfs_region));\n\nout:\n\treturn regd->dfs_region;\n}\n\nstatic void rcu_free_regdom(const struct ieee80211_regdomain *r)\n{\n\tif (!r)\n\t\treturn;\n\tkfree_rcu((struct ieee80211_regdomain *)r, rcu_head);\n}\n\nstatic struct regulatory_request *get_last_request(void)\n{\n\treturn rcu_dereference_rtnl(last_request);\n}\n\n/* Used to queue up regulatory hints */\nstatic LIST_HEAD(reg_requests_list);\nstatic spinlock_t reg_requests_lock;\n\n/* Used to queue up beacon hints for review */\nstatic LIST_HEAD(reg_pending_beacons);\nstatic spinlock_t reg_pending_beacons_lock;\n\n/* Used to keep track of processed beacon hints */\nstatic LIST_HEAD(reg_beacon_list);\n\nstruct reg_beacon {\n\tstruct list_head list;\n\tstruct ieee80211_channel chan;\n};\n\nstatic void reg_check_chans_work(struct work_struct *work);\nstatic DECLARE_DELAYED_WORK(reg_check_chans, reg_check_chans_work);\n\nstatic void reg_todo(struct work_struct *work);\nstatic DECLARE_WORK(reg_work, reg_todo);\n\n/* We keep a static world regulatory domain in case of the absence of CRDA */\nstatic const struct ieee80211_regdomain world_regdom = {\n\t.n_reg_rules = 8,\n\t.alpha2 =  \"00\",\n\t.reg_rules = {\n\t\t/* IEEE 802.11b/g, channels 1..11 */\n\t\tREG_RULE(2412-10, 2462+10, 40, 6, 20, 0),\n\t\t/* IEEE 802.11b/g, channels 12..13. */\n\t\tREG_RULE(2467-10, 2472+10, 20, 6, 20,\n\t\t\tNL80211_RRF_NO_IR | NL80211_RRF_AUTO_BW),\n\t\t/* IEEE 802.11 channel 14 - Only JP enables\n\t\t * this and for 802.11b only */\n\t\tREG_RULE(2484-10, 2484+10, 20, 6, 20,\n\t\t\tNL80211_RRF_NO_IR |\n\t\t\tNL80211_RRF_NO_OFDM),\n\t\t/* IEEE 802.11a, channel 36..48 */\n\t\tREG_RULE(5180-10, 5240+10, 80, 6, 20,\n                        NL80211_RRF_NO_IR |\n                        NL80211_RRF_AUTO_BW),\n\n\t\t/* IEEE 802.11a, channel 52..64 - DFS required */\n\t\tREG_RULE(5260-10, 5320+10, 80, 6, 20,\n\t\t\tNL80211_RRF_NO_IR |\n\t\t\tNL80211_RRF_AUTO_BW |\n\t\t\tNL80211_RRF_DFS),\n\n\t\t/* IEEE 802.11a, channel 100..144 - DFS required */\n\t\tREG_RULE(5500-10, 5720+10, 160, 6, 20,\n\t\t\tNL80211_RRF_NO_IR |\n\t\t\tNL80211_RRF_DFS),\n\n\t\t/* IEEE 802.11a, channel 149..165 */\n\t\tREG_RULE(5745-10, 5825+10, 80, 6, 20,\n\t\t\tNL80211_RRF_NO_IR),\n\n\t\t/* IEEE 802.11ad (60GHz), channels 1..3 */\n\t\tREG_RULE(56160+2160*1-1080, 56160+2160*3+1080, 2160, 0, 0, 0),\n\t}\n};\n\n/* protected by RTNL */\nstatic const struct ieee80211_regdomain *cfg80211_world_regdom =\n\t&world_regdom;\n\nstatic char *ieee80211_regdom = \"00\";\nstatic char user_alpha2[2];\nstatic const struct ieee80211_regdomain *cfg80211_user_regdom;\n\nmodule_param(ieee80211_regdom, charp, 0444);\nMODULE_PARM_DESC(ieee80211_regdom, \"IEEE 802.11 regulatory domain code\");\n\nstatic void reg_free_request(struct regulatory_request *request)\n{\n\tif (request == &core_request_world)\n\t\treturn;\n\n\tif (request != get_last_request())\n\t\tkfree(request);\n}\n\nstatic void reg_free_last_request(void)\n{\n\tstruct regulatory_request *lr = get_last_request();\n\n\tif (lr != &core_request_world && lr)\n\t\tkfree_rcu(lr, rcu_head);\n}\n\nstatic void reg_update_last_request(struct regulatory_request *request)\n{\n\tstruct regulatory_request *lr;\n\n\tlr = get_last_request();\n\tif (lr == request)\n\t\treturn;\n\n\treg_free_last_request();\n\trcu_assign_pointer(last_request, request);\n}\n\nstatic void reset_regdomains(bool full_reset,\n\t\t\t     const struct ieee80211_regdomain *new_regdom)\n{\n\tconst struct ieee80211_regdomain *r;\n\n\tASSERT_RTNL();\n\n\tr = get_cfg80211_regdom();\n\n\t/* avoid freeing static information or freeing something twice */\n\tif (r == cfg80211_world_regdom)\n\t\tr = NULL;\n\tif (cfg80211_world_regdom == &world_regdom)\n\t\tcfg80211_world_regdom = NULL;\n\tif (r == &world_regdom)\n\t\tr = NULL;\n\n\trcu_free_regdom(r);\n\trcu_free_regdom(cfg80211_world_regdom);\n\n\tcfg80211_world_regdom = &world_regdom;\n\trcu_assign_pointer(cfg80211_regdomain, new_regdom);\n\n\tif (!full_reset)\n\t\treturn;\n\n\treg_update_last_request(&core_request_world);\n}\n\n/*\n * Dynamic world regulatory domain requested by the wireless\n * core upon initialization\n */\nstatic void update_world_regdomain(const struct ieee80211_regdomain *rd)\n{\n\tstruct regulatory_request *lr;\n\n\tlr = get_last_request();\n\n\tWARN_ON(!lr);\n\n\treset_regdomains(false, rd);\n\n\tcfg80211_world_regdom = rd;\n}\n\nbool is_world_regdom(const char *alpha2)\n{\n\tif (!alpha2)\n\t\treturn false;\n\treturn alpha2[0] == '0' && alpha2[1] == '0';\n}\n\nstatic bool is_alpha2_set(const char *alpha2)\n{\n\tif (!alpha2)\n\t\treturn false;\n\treturn alpha2[0] && alpha2[1];\n}\n\nstatic bool is_unknown_alpha2(const char *alpha2)\n{\n\tif (!alpha2)\n\t\treturn false;\n\t/*\n\t * Special case where regulatory domain was built by driver\n\t * but a specific alpha2 cannot be determined\n\t */\n\treturn alpha2[0] == '9' && alpha2[1] == '9';\n}\n\nstatic bool is_intersected_alpha2(const char *alpha2)\n{\n\tif (!alpha2)\n\t\treturn false;\n\t/*\n\t * Special case where regulatory domain is the\n\t * result of an intersection between two regulatory domain\n\t * structures\n\t */\n\treturn alpha2[0] == '9' && alpha2[1] == '8';\n}\n\nstatic bool is_an_alpha2(const char *alpha2)\n{\n\tif (!alpha2)\n\t\treturn false;\n\treturn isalpha(alpha2[0]) && isalpha(alpha2[1]);\n}\n\nstatic bool alpha2_equal(const char *alpha2_x, const char *alpha2_y)\n{\n\tif (!alpha2_x || !alpha2_y)\n\t\treturn false;\n\treturn alpha2_x[0] == alpha2_y[0] && alpha2_x[1] == alpha2_y[1];\n}\n\nstatic bool regdom_changes(const char *alpha2)\n{\n\tconst struct ieee80211_regdomain *r = get_cfg80211_regdom();\n\n\tif (!r)\n\t\treturn true;\n\treturn !alpha2_equal(r->alpha2, alpha2);\n}\n\n/*\n * The NL80211_REGDOM_SET_BY_USER regdom alpha2 is cached, this lets\n * you know if a valid regulatory hint with NL80211_REGDOM_SET_BY_USER\n * has ever been issued.\n */\nstatic bool is_user_regdom_saved(void)\n{\n\tif (user_alpha2[0] == '9' && user_alpha2[1] == '7')\n\t\treturn false;\n\n\t/* This would indicate a mistake on the design */\n\tif (WARN(!is_world_regdom(user_alpha2) && !is_an_alpha2(user_alpha2),\n\t\t \"Unexpected user alpha2: %c%c\\n\",\n\t\t user_alpha2[0], user_alpha2[1]))\n\t\treturn false;\n\n\treturn true;\n}\n\nstatic const struct ieee80211_regdomain *\nreg_copy_regd(const struct ieee80211_regdomain *src_regd)\n{\n\tstruct ieee80211_regdomain *regd;\n\tunsigned int i;\n\n\tregd = kzalloc(struct_size(regd, reg_rules, src_regd->n_reg_rules),\n\t\t       GFP_KERNEL);\n\tif (!regd)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tmemcpy(regd, src_regd, sizeof(struct ieee80211_regdomain));\n\n\tfor (i = 0; i < src_regd->n_reg_rules; i++)\n\t\tmemcpy(&regd->reg_rules[i], &src_regd->reg_rules[i],\n\t\t       sizeof(struct ieee80211_reg_rule));\n\n\treturn regd;\n}\n\nstatic void cfg80211_save_user_regdom(const struct ieee80211_regdomain *rd)\n{\n\tASSERT_RTNL();\n\n\tif (!IS_ERR(cfg80211_user_regdom))\n\t\tkfree(cfg80211_user_regdom);\n\tcfg80211_user_regdom = reg_copy_regd(rd);\n}\n\nstruct reg_regdb_apply_request {\n\tstruct list_head list;\n\tconst struct ieee80211_regdomain *regdom;\n};\n\nstatic LIST_HEAD(reg_regdb_apply_list);\nstatic DEFINE_MUTEX(reg_regdb_apply_mutex);\n\nstatic void reg_regdb_apply(struct work_struct *work)\n{\n\tstruct reg_regdb_apply_request *request;\n\n\trtnl_lock();\n\n\tmutex_lock(&reg_regdb_apply_mutex);\n\twhile (!list_empty(&reg_regdb_apply_list)) {\n\t\trequest = list_first_entry(&reg_regdb_apply_list,\n\t\t\t\t\t   struct reg_regdb_apply_request,\n\t\t\t\t\t   list);\n\t\tlist_del(&request->list);\n\n\t\tset_regdom(request->regdom, REGD_SOURCE_INTERNAL_DB);\n\t\tkfree(request);\n\t}\n\tmutex_unlock(&reg_regdb_apply_mutex);\n\n\trtnl_unlock();\n}\n\nstatic DECLARE_WORK(reg_regdb_work, reg_regdb_apply);\n\nstatic int reg_schedule_apply(const struct ieee80211_regdomain *regdom)\n{\n\tstruct reg_regdb_apply_request *request;\n\n\trequest = kzalloc(sizeof(struct reg_regdb_apply_request), GFP_KERNEL);\n\tif (!request) {\n\t\tkfree(regdom);\n\t\treturn -ENOMEM;\n\t}\n\n\trequest->regdom = regdom;\n\n\tmutex_lock(&reg_regdb_apply_mutex);\n\tlist_add_tail(&request->list, &reg_regdb_apply_list);\n\tmutex_unlock(&reg_regdb_apply_mutex);\n\n\tschedule_work(&reg_regdb_work);\n\treturn 0;\n}\n\n#ifdef CONFIG_CFG80211_CRDA_SUPPORT\n/* Max number of consecutive attempts to communicate with CRDA  */\n#define REG_MAX_CRDA_TIMEOUTS 10\n\nstatic u32 reg_crda_timeouts;\n\nstatic void crda_timeout_work(struct work_struct *work);\nstatic DECLARE_DELAYED_WORK(crda_timeout, crda_timeout_work);\n\nstatic void crda_timeout_work(struct work_struct *work)\n{\n\tpr_debug(\"Timeout while waiting for CRDA to reply, restoring regulatory settings\\n\");\n\trtnl_lock();\n\treg_crda_timeouts++;\n\trestore_regulatory_settings(true, false);\n\trtnl_unlock();\n}\n\nstatic void cancel_crda_timeout(void)\n{\n\tcancel_delayed_work(&crda_timeout);\n}\n\nstatic void cancel_crda_timeout_sync(void)\n{\n\tcancel_delayed_work_sync(&crda_timeout);\n}\n\nstatic void reset_crda_timeouts(void)\n{\n\treg_crda_timeouts = 0;\n}\n\n/*\n * This lets us keep regulatory code which is updated on a regulatory\n * basis in userspace.\n */\nstatic int call_crda(const char *alpha2)\n{\n\tchar country[12];\n\tchar *env[] = { country, NULL };\n\tint ret;\n\n\tsnprintf(country, sizeof(country), \"COUNTRY=%c%c\",\n\t\t alpha2[0], alpha2[1]);\n\n\tif (reg_crda_timeouts > REG_MAX_CRDA_TIMEOUTS) {\n\t\tpr_debug(\"Exceeded CRDA call max attempts. Not calling CRDA\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (!is_world_regdom((char *) alpha2))\n\t\tpr_debug(\"Calling CRDA for country: %c%c\\n\",\n\t\t\t alpha2[0], alpha2[1]);\n\telse\n\t\tpr_debug(\"Calling CRDA to update world regulatory domain\\n\");\n\n\tret = kobject_uevent_env(&reg_pdev->dev.kobj, KOBJ_CHANGE, env);\n\tif (ret)\n\t\treturn ret;\n\n\tqueue_delayed_work(system_power_efficient_wq,\n\t\t\t   &crda_timeout, msecs_to_jiffies(3142));\n\treturn 0;\n}\n#else\nstatic inline void cancel_crda_timeout(void) {}\nstatic inline void cancel_crda_timeout_sync(void) {}\nstatic inline void reset_crda_timeouts(void) {}\nstatic inline int call_crda(const char *alpha2)\n{\n\treturn -ENODATA;\n}\n#endif /* CONFIG_CFG80211_CRDA_SUPPORT */\n\n/* code to directly load a firmware database through request_firmware */\nstatic const struct fwdb_header *regdb;\n\nstruct fwdb_country {\n\tu8 alpha2[2];\n\t__be16 coll_ptr;\n\t/* this struct cannot be extended */\n} __packed __aligned(4);\n\nstruct fwdb_collection {\n\tu8 len;\n\tu8 n_rules;\n\tu8 dfs_region;\n\t/* no optional data yet */\n\t/* aligned to 2, then followed by __be16 array of rule pointers */\n} __packed __aligned(4);\n\nenum fwdb_flags {\n\tFWDB_FLAG_NO_OFDM\t= BIT(0),\n\tFWDB_FLAG_NO_OUTDOOR\t= BIT(1),\n\tFWDB_FLAG_DFS\t\t= BIT(2),\n\tFWDB_FLAG_NO_IR\t\t= BIT(3),\n\tFWDB_FLAG_AUTO_BW\t= BIT(4),\n};\n\nstruct fwdb_wmm_ac {\n\tu8 ecw;\n\tu8 aifsn;\n\t__be16 cot;\n} __packed;\n\nstruct fwdb_wmm_rule {\n\tstruct fwdb_wmm_ac client[IEEE80211_NUM_ACS];\n\tstruct fwdb_wmm_ac ap[IEEE80211_NUM_ACS];\n} __packed;\n\nstruct fwdb_rule {\n\tu8 len;\n\tu8 flags;\n\t__be16 max_eirp;\n\t__be32 start, end, max_bw;\n\t/* start of optional data */\n\t__be16 cac_timeout;\n\t__be16 wmm_ptr;\n} __packed __aligned(4);\n\n#define FWDB_MAGIC 0x52474442\n#define FWDB_VERSION 20\n\nstruct fwdb_header {\n\t__be32 magic;\n\t__be32 version;\n\tstruct fwdb_country country[];\n} __packed __aligned(4);\n\nstatic int ecw2cw(int ecw)\n{\n\treturn (1 << ecw) - 1;\n}\n\nstatic bool valid_wmm(struct fwdb_wmm_rule *rule)\n{\n\tstruct fwdb_wmm_ac *ac = (struct fwdb_wmm_ac *)rule;\n\tint i;\n\n\tfor (i = 0; i < IEEE80211_NUM_ACS * 2; i++) {\n\t\tu16 cw_min = ecw2cw((ac[i].ecw & 0xf0) >> 4);\n\t\tu16 cw_max = ecw2cw(ac[i].ecw & 0x0f);\n\t\tu8 aifsn = ac[i].aifsn;\n\n\t\tif (cw_min >= cw_max)\n\t\t\treturn false;\n\n\t\tif (aifsn < 1)\n\t\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nstatic bool valid_rule(const u8 *data, unsigned int size, u16 rule_ptr)\n{\n\tstruct fwdb_rule *rule = (void *)(data + (rule_ptr << 2));\n\n\tif ((u8 *)rule + sizeof(rule->len) > data + size)\n\t\treturn false;\n\n\t/* mandatory fields */\n\tif (rule->len < offsetofend(struct fwdb_rule, max_bw))\n\t\treturn false;\n\tif (rule->len >= offsetofend(struct fwdb_rule, wmm_ptr)) {\n\t\tu32 wmm_ptr = be16_to_cpu(rule->wmm_ptr) << 2;\n\t\tstruct fwdb_wmm_rule *wmm;\n\n\t\tif (wmm_ptr + sizeof(struct fwdb_wmm_rule) > size)\n\t\t\treturn false;\n\n\t\twmm = (void *)(data + wmm_ptr);\n\n\t\tif (!valid_wmm(wmm))\n\t\t\treturn false;\n\t}\n\treturn true;\n}\n\nstatic bool valid_country(const u8 *data, unsigned int size,\n\t\t\t  const struct fwdb_country *country)\n{\n\tunsigned int ptr = be16_to_cpu(country->coll_ptr) << 2;\n\tstruct fwdb_collection *coll = (void *)(data + ptr);\n\t__be16 *rules_ptr;\n\tunsigned int i;\n\n\t/* make sure we can read len/n_rules */\n\tif ((u8 *)coll + offsetofend(typeof(*coll), n_rules) > data + size)\n\t\treturn false;\n\n\t/* make sure base struct and all rules fit */\n\tif ((u8 *)coll + ALIGN(coll->len, 2) +\n\t    (coll->n_rules * 2) > data + size)\n\t\treturn false;\n\n\t/* mandatory fields must exist */\n\tif (coll->len < offsetofend(struct fwdb_collection, dfs_region))\n\t\treturn false;\n\n\trules_ptr = (void *)((u8 *)coll + ALIGN(coll->len, 2));\n\n\tfor (i = 0; i < coll->n_rules; i++) {\n\t\tu16 rule_ptr = be16_to_cpu(rules_ptr[i]);\n\n\t\tif (!valid_rule(data, size, rule_ptr))\n\t\t\treturn false;\n\t}\n\n\treturn true;\n}\n\n#ifdef CONFIG_CFG80211_REQUIRE_SIGNED_REGDB\nstatic struct key *builtin_regdb_keys;\n\nstatic void __init load_keys_from_buffer(const u8 *p, unsigned int buflen)\n{\n\tconst u8 *end = p + buflen;\n\tsize_t plen;\n\tkey_ref_t key;\n\n\twhile (p < end) {\n\t\t/* Each cert begins with an ASN.1 SEQUENCE tag and must be more\n\t\t * than 256 bytes in size.\n\t\t */\n\t\tif (end - p < 4)\n\t\t\tgoto dodgy_cert;\n\t\tif (p[0] != 0x30 &&\n\t\t    p[1] != 0x82)\n\t\t\tgoto dodgy_cert;\n\t\tplen = (p[2] << 8) | p[3];\n\t\tplen += 4;\n\t\tif (plen > end - p)\n\t\t\tgoto dodgy_cert;\n\n\t\tkey = key_create_or_update(make_key_ref(builtin_regdb_keys, 1),\n\t\t\t\t\t   \"asymmetric\", NULL, p, plen,\n\t\t\t\t\t   ((KEY_POS_ALL & ~KEY_POS_SETATTR) |\n\t\t\t\t\t    KEY_USR_VIEW | KEY_USR_READ),\n\t\t\t\t\t   KEY_ALLOC_NOT_IN_QUOTA |\n\t\t\t\t\t   KEY_ALLOC_BUILT_IN |\n\t\t\t\t\t   KEY_ALLOC_BYPASS_RESTRICTION);\n\t\tif (IS_ERR(key)) {\n\t\t\tpr_err(\"Problem loading in-kernel X.509 certificate (%ld)\\n\",\n\t\t\t       PTR_ERR(key));\n\t\t} else {\n\t\t\tpr_notice(\"Loaded X.509 cert '%s'\\n\",\n\t\t\t\t  key_ref_to_ptr(key)->description);\n\t\t\tkey_ref_put(key);\n\t\t}\n\t\tp += plen;\n\t}\n\n\treturn;\n\ndodgy_cert:\n\tpr_err(\"Problem parsing in-kernel X.509 certificate list\\n\");\n}\n\nstatic int __init load_builtin_regdb_keys(void)\n{\n\tbuiltin_regdb_keys =\n\t\tkeyring_alloc(\".builtin_regdb_keys\",\n\t\t\t      KUIDT_INIT(0), KGIDT_INIT(0), current_cred(),\n\t\t\t      ((KEY_POS_ALL & ~KEY_POS_SETATTR) |\n\t\t\t      KEY_USR_VIEW | KEY_USR_READ | KEY_USR_SEARCH),\n\t\t\t      KEY_ALLOC_NOT_IN_QUOTA, NULL, NULL);\n\tif (IS_ERR(builtin_regdb_keys))\n\t\treturn PTR_ERR(builtin_regdb_keys);\n\n\tpr_notice(\"Loading compiled-in X.509 certificates for regulatory database\\n\");\n\n#ifdef CONFIG_CFG80211_USE_KERNEL_REGDB_KEYS\n\tload_keys_from_buffer(shipped_regdb_certs, shipped_regdb_certs_len);\n#endif\n#ifdef CONFIG_CFG80211_EXTRA_REGDB_KEYDIR\n\tif (CONFIG_CFG80211_EXTRA_REGDB_KEYDIR[0] != '\\0')\n\t\tload_keys_from_buffer(extra_regdb_certs, extra_regdb_certs_len);\n#endif\n\n\treturn 0;\n}\n\nstatic bool regdb_has_valid_signature(const u8 *data, unsigned int size)\n{\n\tconst struct firmware *sig;\n\tbool result;\n\n\tif (request_firmware(&sig, \"regulatory.db.p7s\", &reg_pdev->dev))\n\t\treturn false;\n\n\tresult = verify_pkcs7_signature(data, size, sig->data, sig->size,\n\t\t\t\t\tbuiltin_regdb_keys,\n\t\t\t\t\tVERIFYING_UNSPECIFIED_SIGNATURE,\n\t\t\t\t\tNULL, NULL) == 0;\n\n\trelease_firmware(sig);\n\n\treturn result;\n}\n\nstatic void free_regdb_keyring(void)\n{\n\tkey_put(builtin_regdb_keys);\n}\n#else\nstatic int load_builtin_regdb_keys(void)\n{\n\treturn 0;\n}\n\nstatic bool regdb_has_valid_signature(const u8 *data, unsigned int size)\n{\n\treturn true;\n}\n\nstatic void free_regdb_keyring(void)\n{\n}\n#endif /* CONFIG_CFG80211_REQUIRE_SIGNED_REGDB */\n\nstatic bool valid_regdb(const u8 *data, unsigned int size)\n{\n\tconst struct fwdb_header *hdr = (void *)data;\n\tconst struct fwdb_country *country;\n\n\tif (size < sizeof(*hdr))\n\t\treturn false;\n\n\tif (hdr->magic != cpu_to_be32(FWDB_MAGIC))\n\t\treturn false;\n\n\tif (hdr->version != cpu_to_be32(FWDB_VERSION))\n\t\treturn false;\n\n\tif (!regdb_has_valid_signature(data, size))\n\t\treturn false;\n\n\tcountry = &hdr->country[0];\n\twhile ((u8 *)(country + 1) <= data + size) {\n\t\tif (!country->coll_ptr)\n\t\t\tbreak;\n\t\tif (!valid_country(data, size, country))\n\t\t\treturn false;\n\t\tcountry++;\n\t}\n\n\treturn true;\n}\n\nstatic void set_wmm_rule(const struct fwdb_header *db,\n\t\t\t const struct fwdb_country *country,\n\t\t\t const struct fwdb_rule *rule,\n\t\t\t struct ieee80211_reg_rule *rrule)\n{\n\tstruct ieee80211_wmm_rule *wmm_rule = &rrule->wmm_rule;\n\tstruct fwdb_wmm_rule *wmm;\n\tunsigned int i, wmm_ptr;\n\n\twmm_ptr = be16_to_cpu(rule->wmm_ptr) << 2;\n\twmm = (void *)((u8 *)db + wmm_ptr);\n\n\tif (!valid_wmm(wmm)) {\n\t\tpr_err(\"Invalid regulatory WMM rule %u-%u in domain %c%c\\n\",\n\t\t       be32_to_cpu(rule->start), be32_to_cpu(rule->end),\n\t\t       country->alpha2[0], country->alpha2[1]);\n\t\treturn;\n\t}\n\n\tfor (i = 0; i < IEEE80211_NUM_ACS; i++) {\n\t\twmm_rule->client[i].cw_min =\n\t\t\tecw2cw((wmm->client[i].ecw & 0xf0) >> 4);\n\t\twmm_rule->client[i].cw_max = ecw2cw(wmm->client[i].ecw & 0x0f);\n\t\twmm_rule->client[i].aifsn =  wmm->client[i].aifsn;\n\t\twmm_rule->client[i].cot =\n\t\t\t1000 * be16_to_cpu(wmm->client[i].cot);\n\t\twmm_rule->ap[i].cw_min = ecw2cw((wmm->ap[i].ecw & 0xf0) >> 4);\n\t\twmm_rule->ap[i].cw_max = ecw2cw(wmm->ap[i].ecw & 0x0f);\n\t\twmm_rule->ap[i].aifsn = wmm->ap[i].aifsn;\n\t\twmm_rule->ap[i].cot = 1000 * be16_to_cpu(wmm->ap[i].cot);\n\t}\n\n\trrule->has_wmm = true;\n}\n\nstatic int __regdb_query_wmm(const struct fwdb_header *db,\n\t\t\t     const struct fwdb_country *country, int freq,\n\t\t\t     struct ieee80211_reg_rule *rrule)\n{\n\tunsigned int ptr = be16_to_cpu(country->coll_ptr) << 2;\n\tstruct fwdb_collection *coll = (void *)((u8 *)db + ptr);\n\tint i;\n\n\tfor (i = 0; i < coll->n_rules; i++) {\n\t\t__be16 *rules_ptr = (void *)((u8 *)coll + ALIGN(coll->len, 2));\n\t\tunsigned int rule_ptr = be16_to_cpu(rules_ptr[i]) << 2;\n\t\tstruct fwdb_rule *rule = (void *)((u8 *)db + rule_ptr);\n\n\t\tif (rule->len < offsetofend(struct fwdb_rule, wmm_ptr))\n\t\t\tcontinue;\n\n\t\tif (freq >= KHZ_TO_MHZ(be32_to_cpu(rule->start)) &&\n\t\t    freq <= KHZ_TO_MHZ(be32_to_cpu(rule->end))) {\n\t\t\tset_wmm_rule(db, country, rule, rrule);\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\treturn -ENODATA;\n}\n\nint reg_query_regdb_wmm(char *alpha2, int freq, struct ieee80211_reg_rule *rule)\n{\n\tconst struct fwdb_header *hdr = regdb;\n\tconst struct fwdb_country *country;\n\n\tif (!regdb)\n\t\treturn -ENODATA;\n\n\tif (IS_ERR(regdb))\n\t\treturn PTR_ERR(regdb);\n\n\tcountry = &hdr->country[0];\n\twhile (country->coll_ptr) {\n\t\tif (alpha2_equal(alpha2, country->alpha2))\n\t\t\treturn __regdb_query_wmm(regdb, country, freq, rule);\n\n\t\tcountry++;\n\t}\n\n\treturn -ENODATA;\n}\nEXPORT_SYMBOL(reg_query_regdb_wmm);\n\nstatic int regdb_query_country(const struct fwdb_header *db,\n\t\t\t       const struct fwdb_country *country)\n{\n\tunsigned int ptr = be16_to_cpu(country->coll_ptr) << 2;\n\tstruct fwdb_collection *coll = (void *)((u8 *)db + ptr);\n\tstruct ieee80211_regdomain *regdom;\n\tunsigned int i;\n\n\tregdom = kzalloc(struct_size(regdom, reg_rules, coll->n_rules),\n\t\t\t GFP_KERNEL);\n\tif (!regdom)\n\t\treturn -ENOMEM;\n\n\tregdom->n_reg_rules = coll->n_rules;\n\tregdom->alpha2[0] = country->alpha2[0];\n\tregdom->alpha2[1] = country->alpha2[1];\n\tregdom->dfs_region = coll->dfs_region;\n\n\tfor (i = 0; i < regdom->n_reg_rules; i++) {\n\t\t__be16 *rules_ptr = (void *)((u8 *)coll + ALIGN(coll->len, 2));\n\t\tunsigned int rule_ptr = be16_to_cpu(rules_ptr[i]) << 2;\n\t\tstruct fwdb_rule *rule = (void *)((u8 *)db + rule_ptr);\n\t\tstruct ieee80211_reg_rule *rrule = &regdom->reg_rules[i];\n\n\t\trrule->freq_range.start_freq_khz = be32_to_cpu(rule->start);\n\t\trrule->freq_range.end_freq_khz = be32_to_cpu(rule->end);\n\t\trrule->freq_range.max_bandwidth_khz = be32_to_cpu(rule->max_bw);\n\n\t\trrule->power_rule.max_antenna_gain = 0;\n\t\trrule->power_rule.max_eirp = be16_to_cpu(rule->max_eirp);\n\n\t\trrule->flags = 0;\n\t\tif (rule->flags & FWDB_FLAG_NO_OFDM)\n\t\t\trrule->flags |= NL80211_RRF_NO_OFDM;\n\t\tif (rule->flags & FWDB_FLAG_NO_OUTDOOR)\n\t\t\trrule->flags |= NL80211_RRF_NO_OUTDOOR;\n\t\tif (rule->flags & FWDB_FLAG_DFS)\n\t\t\trrule->flags |= NL80211_RRF_DFS;\n\t\tif (rule->flags & FWDB_FLAG_NO_IR)\n\t\t\trrule->flags |= NL80211_RRF_NO_IR;\n\t\tif (rule->flags & FWDB_FLAG_AUTO_BW)\n\t\t\trrule->flags |= NL80211_RRF_AUTO_BW;\n\n\t\trrule->dfs_cac_ms = 0;\n\n\t\t/* handle optional data */\n\t\tif (rule->len >= offsetofend(struct fwdb_rule, cac_timeout))\n\t\t\trrule->dfs_cac_ms =\n\t\t\t\t1000 * be16_to_cpu(rule->cac_timeout);\n\t\tif (rule->len >= offsetofend(struct fwdb_rule, wmm_ptr))\n\t\t\tset_wmm_rule(db, country, rule, rrule);\n\t}\n\n\treturn reg_schedule_apply(regdom);\n}\n\nstatic int query_regdb(const char *alpha2)\n{\n\tconst struct fwdb_header *hdr = regdb;\n\tconst struct fwdb_country *country;\n\n\tASSERT_RTNL();\n\n\tif (IS_ERR(regdb))\n\t\treturn PTR_ERR(regdb);\n\n\tcountry = &hdr->country[0];\n\twhile (country->coll_ptr) {\n\t\tif (alpha2_equal(alpha2, country->alpha2))\n\t\t\treturn regdb_query_country(regdb, country);\n\t\tcountry++;\n\t}\n\n\treturn -ENODATA;\n}\n\nstatic void regdb_fw_cb(const struct firmware *fw, void *context)\n{\n\tint set_error = 0;\n\tbool restore = true;\n\tvoid *db;\n\n\tif (!fw) {\n\t\tpr_info(\"failed to load regulatory.db\\n\");\n\t\tset_error = -ENODATA;\n\t} else if (!valid_regdb(fw->data, fw->size)) {\n\t\tpr_info(\"loaded regulatory.db is malformed or signature is missing/invalid\\n\");\n\t\tset_error = -EINVAL;\n\t}\n\n\trtnl_lock();\n\tif (regdb && !IS_ERR(regdb)) {\n\t\t/* negative case - a bug\n\t\t * positive case - can happen due to race in case of multiple cb's in\n\t\t * queue, due to usage of asynchronous callback\n\t\t *\n\t\t * Either case, just restore and free new db.\n\t\t */\n\t} else if (set_error) {\n\t\tregdb = ERR_PTR(set_error);\n\t} else if (fw) {\n\t\tdb = kmemdup(fw->data, fw->size, GFP_KERNEL);\n\t\tif (db) {\n\t\t\tregdb = db;\n\t\t\trestore = context && query_regdb(context);\n\t\t} else {\n\t\t\trestore = true;\n\t\t}\n\t}\n\n\tif (restore)\n\t\trestore_regulatory_settings(true, false);\n\n\trtnl_unlock();\n\n\tkfree(context);\n\n\trelease_firmware(fw);\n}\n\nstatic int query_regdb_file(const char *alpha2)\n{\n\tASSERT_RTNL();\n\n\tif (regdb)\n\t\treturn query_regdb(alpha2);\n\n\talpha2 = kmemdup(alpha2, 2, GFP_KERNEL);\n\tif (!alpha2)\n\t\treturn -ENOMEM;\n\n\treturn request_firmware_nowait(THIS_MODULE, true, \"regulatory.db\",\n\t\t\t\t       &reg_pdev->dev, GFP_KERNEL,\n\t\t\t\t       (void *)alpha2, regdb_fw_cb);\n}\n\nint reg_reload_regdb(void)\n{\n\tconst struct firmware *fw;\n\tvoid *db;\n\tint err;\n\n\terr = request_firmware(&fw, \"regulatory.db\", &reg_pdev->dev);\n\tif (err)\n\t\treturn err;\n\n\tif (!valid_regdb(fw->data, fw->size)) {\n\t\terr = -ENODATA;\n\t\tgoto out;\n\t}\n\n\tdb = kmemdup(fw->data, fw->size, GFP_KERNEL);\n\tif (!db) {\n\t\terr = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\trtnl_lock();\n\tif (!IS_ERR_OR_NULL(regdb))\n\t\tkfree(regdb);\n\tregdb = db;\n\trtnl_unlock();\n\n out:\n\trelease_firmware(fw);\n\treturn err;\n}\n\nstatic bool reg_query_database(struct regulatory_request *request)\n{\n\tif (query_regdb_file(request->alpha2) == 0)\n\t\treturn true;\n\n\tif (call_crda(request->alpha2) == 0)\n\t\treturn true;\n\n\treturn false;\n}\n\nbool reg_is_valid_request(const char *alpha2)\n{\n\tstruct regulatory_request *lr = get_last_request();\n\n\tif (!lr || lr->processed)\n\t\treturn false;\n\n\treturn alpha2_equal(lr->alpha2, alpha2);\n}\n\nstatic const struct ieee80211_regdomain *reg_get_regdomain(struct wiphy *wiphy)\n{\n\tstruct regulatory_request *lr = get_last_request();\n\n\t/*\n\t * Follow the driver's regulatory domain, if present, unless a country\n\t * IE has been processed or a user wants to help complaince further\n\t */\n\tif (lr->initiator != NL80211_REGDOM_SET_BY_COUNTRY_IE &&\n\t    lr->initiator != NL80211_REGDOM_SET_BY_USER &&\n\t    wiphy->regd)\n\t\treturn get_wiphy_regdom(wiphy);\n\n\treturn get_cfg80211_regdom();\n}\n\nstatic unsigned int\nreg_get_max_bandwidth_from_range(const struct ieee80211_regdomain *rd,\n\t\t\t\t const struct ieee80211_reg_rule *rule)\n{\n\tconst struct ieee80211_freq_range *freq_range = &rule->freq_range;\n\tconst struct ieee80211_freq_range *freq_range_tmp;\n\tconst struct ieee80211_reg_rule *tmp;\n\tu32 start_freq, end_freq, idx, no;\n\n\tfor (idx = 0; idx < rd->n_reg_rules; idx++)\n\t\tif (rule == &rd->reg_rules[idx])\n\t\t\tbreak;\n\n\tif (idx == rd->n_reg_rules)\n\t\treturn 0;\n\n\t/* get start_freq */\n\tno = idx;\n\n\twhile (no) {\n\t\ttmp = &rd->reg_rules[--no];\n\t\tfreq_range_tmp = &tmp->freq_range;\n\n\t\tif (freq_range_tmp->end_freq_khz < freq_range->start_freq_khz)\n\t\t\tbreak;\n\n\t\tfreq_range = freq_range_tmp;\n\t}\n\n\tstart_freq = freq_range->start_freq_khz;\n\n\t/* get end_freq */\n\tfreq_range = &rule->freq_range;\n\tno = idx;\n\n\twhile (no < rd->n_reg_rules - 1) {\n\t\ttmp = &rd->reg_rules[++no];\n\t\tfreq_range_tmp = &tmp->freq_range;\n\n\t\tif (freq_range_tmp->start_freq_khz > freq_range->end_freq_khz)\n\t\t\tbreak;\n\n\t\tfreq_range = freq_range_tmp;\n\t}\n\n\tend_freq = freq_range->end_freq_khz;\n\n\treturn end_freq - start_freq;\n}\n\nunsigned int reg_get_max_bandwidth(const struct ieee80211_regdomain *rd,\n\t\t\t\t   const struct ieee80211_reg_rule *rule)\n{\n\tunsigned int bw = reg_get_max_bandwidth_from_range(rd, rule);\n\n\tif (rule->flags & NL80211_RRF_NO_160MHZ)\n\t\tbw = min_t(unsigned int, bw, MHZ_TO_KHZ(80));\n\tif (rule->flags & NL80211_RRF_NO_80MHZ)\n\t\tbw = min_t(unsigned int, bw, MHZ_TO_KHZ(40));\n\n\t/*\n\t * HT40+/HT40- limits are handled per-channel. Only limit BW if both\n\t * are not allowed.\n\t */\n\tif (rule->flags & NL80211_RRF_NO_HT40MINUS &&\n\t    rule->flags & NL80211_RRF_NO_HT40PLUS)\n\t\tbw = min_t(unsigned int, bw, MHZ_TO_KHZ(20));\n\n\treturn bw;\n}\n\n/* Sanity check on a regulatory rule */\nstatic bool is_valid_reg_rule(const struct ieee80211_reg_rule *rule)\n{\n\tconst struct ieee80211_freq_range *freq_range = &rule->freq_range;\n\tu32 freq_diff;\n\n\tif (freq_range->start_freq_khz <= 0 || freq_range->end_freq_khz <= 0)\n\t\treturn false;\n\n\tif (freq_range->start_freq_khz > freq_range->end_freq_khz)\n\t\treturn false;\n\n\tfreq_diff = freq_range->end_freq_khz - freq_range->start_freq_khz;\n\n\tif (freq_range->end_freq_khz <= freq_range->start_freq_khz ||\n\t    freq_range->max_bandwidth_khz > freq_diff)\n\t\treturn false;\n\n\treturn true;\n}\n\nstatic bool is_valid_rd(const struct ieee80211_regdomain *rd)\n{\n\tconst struct ieee80211_reg_rule *reg_rule = NULL;\n\tunsigned int i;\n\n\tif (!rd->n_reg_rules)\n\t\treturn false;\n\n\tif (WARN_ON(rd->n_reg_rules > NL80211_MAX_SUPP_REG_RULES))\n\t\treturn false;\n\n\tfor (i = 0; i < rd->n_reg_rules; i++) {\n\t\treg_rule = &rd->reg_rules[i];\n\t\tif (!is_valid_reg_rule(reg_rule))\n\t\t\treturn false;\n\t}\n\n\treturn true;\n}\n\n/**\n * freq_in_rule_band - tells us if a frequency is in a frequency band\n * @freq_range: frequency rule we want to query\n * @freq_khz: frequency we are inquiring about\n *\n * This lets us know if a specific frequency rule is or is not relevant to\n * a specific frequency's band. Bands are device specific and artificial\n * definitions (the \"2.4 GHz band\", the \"5 GHz band\" and the \"60GHz band\"),\n * however it is safe for now to assume that a frequency rule should not be\n * part of a frequency's band if the start freq or end freq are off by more\n * than 2 GHz for the 2.4 and 5 GHz bands, and by more than 20 GHz for the\n * 60 GHz band.\n * This resolution can be lowered and should be considered as we add\n * regulatory rule support for other \"bands\".\n **/\nstatic bool freq_in_rule_band(const struct ieee80211_freq_range *freq_range,\n\t\t\t      u32 freq_khz)\n{\n#define ONE_GHZ_IN_KHZ\t1000000\n\t/*\n\t * From 802.11ad: directional multi-gigabit (DMG):\n\t * Pertaining to operation in a frequency band containing a channel\n\t * with the Channel starting frequency above 45 GHz.\n\t */\n\tu32 limit = freq_khz > 45 * ONE_GHZ_IN_KHZ ?\n\t\t\t20 * ONE_GHZ_IN_KHZ : 2 * ONE_GHZ_IN_KHZ;\n\tif (abs(freq_khz - freq_range->start_freq_khz) <= limit)\n\t\treturn true;\n\tif (abs(freq_khz - freq_range->end_freq_khz) <= limit)\n\t\treturn true;\n\treturn false;\n#undef ONE_GHZ_IN_KHZ\n}\n\n/*\n * Later on we can perhaps use the more restrictive DFS\n * region but we don't have information for that yet so\n * for now simply disallow conflicts.\n */\nstatic enum nl80211_dfs_regions\nreg_intersect_dfs_region(const enum nl80211_dfs_regions dfs_region1,\n\t\t\t const enum nl80211_dfs_regions dfs_region2)\n{\n\tif (dfs_region1 != dfs_region2)\n\t\treturn NL80211_DFS_UNSET;\n\treturn dfs_region1;\n}\n\nstatic void reg_wmm_rules_intersect(const struct ieee80211_wmm_ac *wmm_ac1,\n\t\t\t\t    const struct ieee80211_wmm_ac *wmm_ac2,\n\t\t\t\t    struct ieee80211_wmm_ac *intersect)\n{\n\tintersect->cw_min = max_t(u16, wmm_ac1->cw_min, wmm_ac2->cw_min);\n\tintersect->cw_max = max_t(u16, wmm_ac1->cw_max, wmm_ac2->cw_max);\n\tintersect->cot = min_t(u16, wmm_ac1->cot, wmm_ac2->cot);\n\tintersect->aifsn = max_t(u8, wmm_ac1->aifsn, wmm_ac2->aifsn);\n}\n\n/*\n * Helper for regdom_intersect(), this does the real\n * mathematical intersection fun\n */\nstatic int reg_rules_intersect(const struct ieee80211_regdomain *rd1,\n\t\t\t       const struct ieee80211_regdomain *rd2,\n\t\t\t       const struct ieee80211_reg_rule *rule1,\n\t\t\t       const struct ieee80211_reg_rule *rule2,\n\t\t\t       struct ieee80211_reg_rule *intersected_rule)\n{\n\tconst struct ieee80211_freq_range *freq_range1, *freq_range2;\n\tstruct ieee80211_freq_range *freq_range;\n\tconst struct ieee80211_power_rule *power_rule1, *power_rule2;\n\tstruct ieee80211_power_rule *power_rule;\n\tconst struct ieee80211_wmm_rule *wmm_rule1, *wmm_rule2;\n\tstruct ieee80211_wmm_rule *wmm_rule;\n\tu32 freq_diff, max_bandwidth1, max_bandwidth2;\n\n\tfreq_range1 = &rule1->freq_range;\n\tfreq_range2 = &rule2->freq_range;\n\tfreq_range = &intersected_rule->freq_range;\n\n\tpower_rule1 = &rule1->power_rule;\n\tpower_rule2 = &rule2->power_rule;\n\tpower_rule = &intersected_rule->power_rule;\n\n\twmm_rule1 = &rule1->wmm_rule;\n\twmm_rule2 = &rule2->wmm_rule;\n\twmm_rule = &intersected_rule->wmm_rule;\n\n\tfreq_range->start_freq_khz = max(freq_range1->start_freq_khz,\n\t\t\t\t\t freq_range2->start_freq_khz);\n\tfreq_range->end_freq_khz = min(freq_range1->end_freq_khz,\n\t\t\t\t       freq_range2->end_freq_khz);\n\n\tmax_bandwidth1 = freq_range1->max_bandwidth_khz;\n\tmax_bandwidth2 = freq_range2->max_bandwidth_khz;\n\n\tif (rule1->flags & NL80211_RRF_AUTO_BW)\n\t\tmax_bandwidth1 = reg_get_max_bandwidth(rd1, rule1);\n\tif (rule2->flags & NL80211_RRF_AUTO_BW)\n\t\tmax_bandwidth2 = reg_get_max_bandwidth(rd2, rule2);\n\n\tfreq_range->max_bandwidth_khz = min(max_bandwidth1, max_bandwidth2);\n\n\tintersected_rule->flags = rule1->flags | rule2->flags;\n\n\t/*\n\t * In case NL80211_RRF_AUTO_BW requested for both rules\n\t * set AUTO_BW in intersected rule also. Next we will\n\t * calculate BW correctly in handle_channel function.\n\t * In other case remove AUTO_BW flag while we calculate\n\t * maximum bandwidth correctly and auto calculation is\n\t * not required.\n\t */\n\tif ((rule1->flags & NL80211_RRF_AUTO_BW) &&\n\t    (rule2->flags & NL80211_RRF_AUTO_BW))\n\t\tintersected_rule->flags |= NL80211_RRF_AUTO_BW;\n\telse\n\t\tintersected_rule->flags &= ~NL80211_RRF_AUTO_BW;\n\n\tfreq_diff = freq_range->end_freq_khz - freq_range->start_freq_khz;\n\tif (freq_range->max_bandwidth_khz > freq_diff)\n\t\tfreq_range->max_bandwidth_khz = freq_diff;\n\n\tpower_rule->max_eirp = min(power_rule1->max_eirp,\n\t\tpower_rule2->max_eirp);\n\tpower_rule->max_antenna_gain = min(power_rule1->max_antenna_gain,\n\t\tpower_rule2->max_antenna_gain);\n\n\tintersected_rule->dfs_cac_ms = max(rule1->dfs_cac_ms,\n\t\t\t\t\t   rule2->dfs_cac_ms);\n\n\tif (rule1->has_wmm && rule2->has_wmm) {\n\t\tu8 ac;\n\n\t\tfor (ac = 0; ac < IEEE80211_NUM_ACS; ac++) {\n\t\t\treg_wmm_rules_intersect(&wmm_rule1->client[ac],\n\t\t\t\t\t\t&wmm_rule2->client[ac],\n\t\t\t\t\t\t&wmm_rule->client[ac]);\n\t\t\treg_wmm_rules_intersect(&wmm_rule1->ap[ac],\n\t\t\t\t\t\t&wmm_rule2->ap[ac],\n\t\t\t\t\t\t&wmm_rule->ap[ac]);\n\t\t}\n\n\t\tintersected_rule->has_wmm = true;\n\t} else if (rule1->has_wmm) {\n\t\t*wmm_rule = *wmm_rule1;\n\t\tintersected_rule->has_wmm = true;\n\t} else if (rule2->has_wmm) {\n\t\t*wmm_rule = *wmm_rule2;\n\t\tintersected_rule->has_wmm = true;\n\t} else {\n\t\tintersected_rule->has_wmm = false;\n\t}\n\n\tif (!is_valid_reg_rule(intersected_rule))\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\n/* check whether old rule contains new rule */\nstatic bool rule_contains(struct ieee80211_reg_rule *r1,\n\t\t\t  struct ieee80211_reg_rule *r2)\n{\n\t/* for simplicity, currently consider only same flags */\n\tif (r1->flags != r2->flags)\n\t\treturn false;\n\n\t/* verify r1 is more restrictive */\n\tif ((r1->power_rule.max_antenna_gain >\n\t     r2->power_rule.max_antenna_gain) ||\n\t    r1->power_rule.max_eirp > r2->power_rule.max_eirp)\n\t\treturn false;\n\n\t/* make sure r2's range is contained within r1 */\n\tif (r1->freq_range.start_freq_khz > r2->freq_range.start_freq_khz ||\n\t    r1->freq_range.end_freq_khz < r2->freq_range.end_freq_khz)\n\t\treturn false;\n\n\t/* and finally verify that r1.max_bw >= r2.max_bw */\n\tif (r1->freq_range.max_bandwidth_khz <\n\t    r2->freq_range.max_bandwidth_khz)\n\t\treturn false;\n\n\treturn true;\n}\n\n/* add or extend current rules. do nothing if rule is already contained */\nstatic void add_rule(struct ieee80211_reg_rule *rule,\n\t\t     struct ieee80211_reg_rule *reg_rules, u32 *n_rules)\n{\n\tstruct ieee80211_reg_rule *tmp_rule;\n\tint i;\n\n\tfor (i = 0; i < *n_rules; i++) {\n\t\ttmp_rule = &reg_rules[i];\n\t\t/* rule is already contained - do nothing */\n\t\tif (rule_contains(tmp_rule, rule))\n\t\t\treturn;\n\n\t\t/* extend rule if possible */\n\t\tif (rule_contains(rule, tmp_rule)) {\n\t\t\tmemcpy(tmp_rule, rule, sizeof(*rule));\n\t\t\treturn;\n\t\t}\n\t}\n\n\tmemcpy(&reg_rules[*n_rules], rule, sizeof(*rule));\n\t(*n_rules)++;\n}\n\n/**\n * regdom_intersect - do the intersection between two regulatory domains\n * @rd1: first regulatory domain\n * @rd2: second regulatory domain\n *\n * Use this function to get the intersection between two regulatory domains.\n * Once completed we will mark the alpha2 for the rd as intersected, \"98\",\n * as no one single alpha2 can represent this regulatory domain.\n *\n * Returns a pointer to the regulatory domain structure which will hold the\n * resulting intersection of rules between rd1 and rd2. We will\n * kzalloc() this structure for you.\n */\nstatic struct ieee80211_regdomain *\nregdom_intersect(const struct ieee80211_regdomain *rd1,\n\t\t const struct ieee80211_regdomain *rd2)\n{\n\tint r;\n\tunsigned int x, y;\n\tunsigned int num_rules = 0;\n\tconst struct ieee80211_reg_rule *rule1, *rule2;\n\tstruct ieee80211_reg_rule intersected_rule;\n\tstruct ieee80211_regdomain *rd;\n\n\tif (!rd1 || !rd2)\n\t\treturn NULL;\n\n\t/*\n\t * First we get a count of the rules we'll need, then we actually\n\t * build them. This is to so we can malloc() and free() a\n\t * regdomain once. The reason we use reg_rules_intersect() here\n\t * is it will return -EINVAL if the rule computed makes no sense.\n\t * All rules that do check out OK are valid.\n\t */\n\n\tfor (x = 0; x < rd1->n_reg_rules; x++) {\n\t\trule1 = &rd1->reg_rules[x];\n\t\tfor (y = 0; y < rd2->n_reg_rules; y++) {\n\t\t\trule2 = &rd2->reg_rules[y];\n\t\t\tif (!reg_rules_intersect(rd1, rd2, rule1, rule2,\n\t\t\t\t\t\t &intersected_rule))\n\t\t\t\tnum_rules++;\n\t\t}\n\t}\n\n\tif (!num_rules)\n\t\treturn NULL;\n\n\trd = kzalloc(struct_size(rd, reg_rules, num_rules), GFP_KERNEL);\n\tif (!rd)\n\t\treturn NULL;\n\n\tfor (x = 0; x < rd1->n_reg_rules; x++) {\n\t\trule1 = &rd1->reg_rules[x];\n\t\tfor (y = 0; y < rd2->n_reg_rules; y++) {\n\t\t\trule2 = &rd2->reg_rules[y];\n\t\t\tr = reg_rules_intersect(rd1, rd2, rule1, rule2,\n\t\t\t\t\t\t&intersected_rule);\n\t\t\t/*\n\t\t\t * No need to memset here the intersected rule here as\n\t\t\t * we're not using the stack anymore\n\t\t\t */\n\t\t\tif (r)\n\t\t\t\tcontinue;\n\n\t\t\tadd_rule(&intersected_rule, rd->reg_rules,\n\t\t\t\t &rd->n_reg_rules);\n\t\t}\n\t}\n\n\trd->alpha2[0] = '9';\n\trd->alpha2[1] = '8';\n\trd->dfs_region = reg_intersect_dfs_region(rd1->dfs_region,\n\t\t\t\t\t\t  rd2->dfs_region);\n\n\treturn rd;\n}\n\n/*\n * XXX: add support for the rest of enum nl80211_reg_rule_flags, we may\n * want to just have the channel structure use these\n */\nstatic u32 map_regdom_flags(u32 rd_flags)\n{\n\tu32 channel_flags = 0;\n\tif (rd_flags & NL80211_RRF_NO_IR_ALL)\n\t\tchannel_flags |= IEEE80211_CHAN_NO_IR;\n\tif (rd_flags & NL80211_RRF_DFS)\n\t\tchannel_flags |= IEEE80211_CHAN_RADAR;\n\tif (rd_flags & NL80211_RRF_NO_OFDM)\n\t\tchannel_flags |= IEEE80211_CHAN_NO_OFDM;\n\tif (rd_flags & NL80211_RRF_NO_OUTDOOR)\n\t\tchannel_flags |= IEEE80211_CHAN_INDOOR_ONLY;\n\tif (rd_flags & NL80211_RRF_IR_CONCURRENT)\n\t\tchannel_flags |= IEEE80211_CHAN_IR_CONCURRENT;\n\tif (rd_flags & NL80211_RRF_NO_HT40MINUS)\n\t\tchannel_flags |= IEEE80211_CHAN_NO_HT40MINUS;\n\tif (rd_flags & NL80211_RRF_NO_HT40PLUS)\n\t\tchannel_flags |= IEEE80211_CHAN_NO_HT40PLUS;\n\tif (rd_flags & NL80211_RRF_NO_80MHZ)\n\t\tchannel_flags |= IEEE80211_CHAN_NO_80MHZ;\n\tif (rd_flags & NL80211_RRF_NO_160MHZ)\n\t\tchannel_flags |= IEEE80211_CHAN_NO_160MHZ;\n\tif (rd_flags & NL80211_RRF_NO_HE)\n\t\tchannel_flags |= IEEE80211_CHAN_NO_HE;\n\treturn channel_flags;\n}\n\nstatic const struct ieee80211_reg_rule *\nfreq_reg_info_regd(u32 center_freq,\n\t\t   const struct ieee80211_regdomain *regd, u32 bw)\n{\n\tint i;\n\tbool band_rule_found = false;\n\tbool bw_fits = false;\n\n\tif (!regd)\n\t\treturn ERR_PTR(-EINVAL);\n\n\tfor (i = 0; i < regd->n_reg_rules; i++) {\n\t\tconst struct ieee80211_reg_rule *rr;\n\t\tconst struct ieee80211_freq_range *fr = NULL;\n\n\t\trr = &regd->reg_rules[i];\n\t\tfr = &rr->freq_range;\n\n\t\t/*\n\t\t * We only need to know if one frequency rule was\n\t\t * in center_freq's band, that's enough, so let's\n\t\t * not overwrite it once found\n\t\t */\n\t\tif (!band_rule_found)\n\t\t\tband_rule_found = freq_in_rule_band(fr, center_freq);\n\n\t\tbw_fits = cfg80211_does_bw_fit_range(fr, center_freq, bw);\n\n\t\tif (band_rule_found && bw_fits)\n\t\t\treturn rr;\n\t}\n\n\tif (!band_rule_found)\n\t\treturn ERR_PTR(-ERANGE);\n\n\treturn ERR_PTR(-EINVAL);\n}\n\nstatic const struct ieee80211_reg_rule *\n__freq_reg_info(struct wiphy *wiphy, u32 center_freq, u32 min_bw)\n{\n\tconst struct ieee80211_regdomain *regd = reg_get_regdomain(wiphy);\n\tstatic const u32 bws[] = {0, 1, 2, 4, 5, 8, 10, 16, 20};\n\tconst struct ieee80211_reg_rule *reg_rule;\n\tint i = ARRAY_SIZE(bws) - 1;\n\tu32 bw;\n\n\tfor (bw = MHZ_TO_KHZ(bws[i]); bw >= min_bw; bw = MHZ_TO_KHZ(bws[i--])) {\n\t\treg_rule = freq_reg_info_regd(center_freq, regd, bw);\n\t\tif (!IS_ERR(reg_rule))\n\t\t\treturn reg_rule;\n\t}\n\n\treturn reg_rule;\n}\n\nconst struct ieee80211_reg_rule *freq_reg_info(struct wiphy *wiphy,\n\t\t\t\t\t       u32 center_freq)\n{\n\tu32 min_bw = center_freq < MHZ_TO_KHZ(1000) ? 1 : 20;\n\n\treturn __freq_reg_info(wiphy, center_freq, MHZ_TO_KHZ(min_bw));\n}\nEXPORT_SYMBOL(freq_reg_info);\n\nconst char *reg_initiator_name(enum nl80211_reg_initiator initiator)\n{\n\tswitch (initiator) {\n\tcase NL80211_REGDOM_SET_BY_CORE:\n\t\treturn \"core\";\n\tcase NL80211_REGDOM_SET_BY_USER:\n\t\treturn \"user\";\n\tcase NL80211_REGDOM_SET_BY_DRIVER:\n\t\treturn \"driver\";\n\tcase NL80211_REGDOM_SET_BY_COUNTRY_IE:\n\t\treturn \"country element\";\n\tdefault:\n\t\tWARN_ON(1);\n\t\treturn \"bug\";\n\t}\n}\nEXPORT_SYMBOL(reg_initiator_name);\n\nstatic uint32_t reg_rule_to_chan_bw_flags(const struct ieee80211_regdomain *regd,\n\t\t\t\t\t  const struct ieee80211_reg_rule *reg_rule,\n\t\t\t\t\t  const struct ieee80211_channel *chan)\n{\n\tconst struct ieee80211_freq_range *freq_range = NULL;\n\tu32 max_bandwidth_khz, center_freq_khz, bw_flags = 0;\n\tbool is_s1g = chan->band == NL80211_BAND_S1GHZ;\n\n\tfreq_range = &reg_rule->freq_range;\n\n\tmax_bandwidth_khz = freq_range->max_bandwidth_khz;\n\tcenter_freq_khz = ieee80211_channel_to_khz(chan);\n\t/* Check if auto calculation requested */\n\tif (reg_rule->flags & NL80211_RRF_AUTO_BW)\n\t\tmax_bandwidth_khz = reg_get_max_bandwidth(regd, reg_rule);\n\n\t/* If we get a reg_rule we can assume that at least 5Mhz fit */\n\tif (!cfg80211_does_bw_fit_range(freq_range,\n\t\t\t\t\tcenter_freq_khz,\n\t\t\t\t\tMHZ_TO_KHZ(10)))\n\t\tbw_flags |= IEEE80211_CHAN_NO_10MHZ;\n\tif (!cfg80211_does_bw_fit_range(freq_range,\n\t\t\t\t\tcenter_freq_khz,\n\t\t\t\t\tMHZ_TO_KHZ(20)))\n\t\tbw_flags |= IEEE80211_CHAN_NO_20MHZ;\n\n\tif (is_s1g) {\n\t\t/* S1G is strict about non overlapping channels. We can\n\t\t * calculate which bandwidth is allowed per channel by finding\n\t\t * the largest bandwidth which cleanly divides the freq_range.\n\t\t */\n\t\tint edge_offset;\n\t\tint ch_bw = max_bandwidth_khz;\n\n\t\twhile (ch_bw) {\n\t\t\tedge_offset = (center_freq_khz - ch_bw / 2) -\n\t\t\t\t      freq_range->start_freq_khz;\n\t\t\tif (edge_offset % ch_bw == 0) {\n\t\t\t\tswitch (KHZ_TO_MHZ(ch_bw)) {\n\t\t\t\tcase 1:\n\t\t\t\t\tbw_flags |= IEEE80211_CHAN_1MHZ;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 2:\n\t\t\t\t\tbw_flags |= IEEE80211_CHAN_2MHZ;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 4:\n\t\t\t\t\tbw_flags |= IEEE80211_CHAN_4MHZ;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 8:\n\t\t\t\t\tbw_flags |= IEEE80211_CHAN_8MHZ;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 16:\n\t\t\t\t\tbw_flags |= IEEE80211_CHAN_16MHZ;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\t/* If we got here, no bandwidths fit on\n\t\t\t\t\t * this frequency, ie. band edge.\n\t\t\t\t\t */\n\t\t\t\t\tbw_flags |= IEEE80211_CHAN_DISABLED;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tch_bw /= 2;\n\t\t}\n\t} else {\n\t\tif (max_bandwidth_khz < MHZ_TO_KHZ(10))\n\t\t\tbw_flags |= IEEE80211_CHAN_NO_10MHZ;\n\t\tif (max_bandwidth_khz < MHZ_TO_KHZ(20))\n\t\t\tbw_flags |= IEEE80211_CHAN_NO_20MHZ;\n\t\tif (max_bandwidth_khz < MHZ_TO_KHZ(40))\n\t\t\tbw_flags |= IEEE80211_CHAN_NO_HT40;\n\t\tif (max_bandwidth_khz < MHZ_TO_KHZ(80))\n\t\t\tbw_flags |= IEEE80211_CHAN_NO_80MHZ;\n\t\tif (max_bandwidth_khz < MHZ_TO_KHZ(160))\n\t\t\tbw_flags |= IEEE80211_CHAN_NO_160MHZ;\n\t}\n\treturn bw_flags;\n}\n\nstatic void handle_channel_single_rule(struct wiphy *wiphy,\n\t\t\t\t       enum nl80211_reg_initiator initiator,\n\t\t\t\t       struct ieee80211_channel *chan,\n\t\t\t\t       u32 flags,\n\t\t\t\t       struct regulatory_request *lr,\n\t\t\t\t       struct wiphy *request_wiphy,\n\t\t\t\t       const struct ieee80211_reg_rule *reg_rule)\n{\n\tu32 bw_flags = 0;\n\tconst struct ieee80211_power_rule *power_rule = NULL;\n\tconst struct ieee80211_regdomain *regd;\n\n\tregd = reg_get_regdomain(wiphy);\n\n\tpower_rule = &reg_rule->power_rule;\n\tbw_flags = reg_rule_to_chan_bw_flags(regd, reg_rule, chan);\n\n\tif (lr->initiator == NL80211_REGDOM_SET_BY_DRIVER &&\n\t    request_wiphy && request_wiphy == wiphy &&\n\t    request_wiphy->regulatory_flags & REGULATORY_STRICT_REG) {\n\t\t/*\n\t\t * This guarantees the driver's requested regulatory domain\n\t\t * will always be used as a base for further regulatory\n\t\t * settings\n\t\t */\n\t\tchan->flags = chan->orig_flags =\n\t\t\tmap_regdom_flags(reg_rule->flags) | bw_flags;\n\t\tchan->max_antenna_gain = chan->orig_mag =\n\t\t\t(int) MBI_TO_DBI(power_rule->max_antenna_gain);\n\t\tchan->max_reg_power = chan->max_power = chan->orig_mpwr =\n\t\t\t(int) MBM_TO_DBM(power_rule->max_eirp);\n\n\t\tif (chan->flags & IEEE80211_CHAN_RADAR) {\n\t\t\tchan->dfs_cac_ms = IEEE80211_DFS_MIN_CAC_TIME_MS;\n\t\t\tif (reg_rule->dfs_cac_ms)\n\t\t\t\tchan->dfs_cac_ms = reg_rule->dfs_cac_ms;\n\t\t}\n\n\t\treturn;\n\t}\n\n\tchan->dfs_state = NL80211_DFS_USABLE;\n\tchan->dfs_state_entered = jiffies;\n\n\tchan->beacon_found = false;\n\tchan->flags = flags | bw_flags | map_regdom_flags(reg_rule->flags);\n\tchan->max_antenna_gain =\n\t\tmin_t(int, chan->orig_mag,\n\t\t      MBI_TO_DBI(power_rule->max_antenna_gain));\n\tchan->max_reg_power = (int) MBM_TO_DBM(power_rule->max_eirp);\n\n\tif (chan->flags & IEEE80211_CHAN_RADAR) {\n\t\tif (reg_rule->dfs_cac_ms)\n\t\t\tchan->dfs_cac_ms = reg_rule->dfs_cac_ms;\n\t\telse\n\t\t\tchan->dfs_cac_ms = IEEE80211_DFS_MIN_CAC_TIME_MS;\n\t}\n\n\tif (chan->orig_mpwr) {\n\t\t/*\n\t\t * Devices that use REGULATORY_COUNTRY_IE_FOLLOW_POWER\n\t\t * will always follow the passed country IE power settings.\n\t\t */\n\t\tif (initiator == NL80211_REGDOM_SET_BY_COUNTRY_IE &&\n\t\t    wiphy->regulatory_flags & REGULATORY_COUNTRY_IE_FOLLOW_POWER)\n\t\t\tchan->max_power = chan->max_reg_power;\n\t\telse\n\t\t\tchan->max_power = min(chan->orig_mpwr,\n\t\t\t\t\t      chan->max_reg_power);\n\t} else\n\t\tchan->max_power = chan->max_reg_power;\n}\n\nstatic void handle_channel_adjacent_rules(struct wiphy *wiphy,\n\t\t\t\t\t  enum nl80211_reg_initiator initiator,\n\t\t\t\t\t  struct ieee80211_channel *chan,\n\t\t\t\t\t  u32 flags,\n\t\t\t\t\t  struct regulatory_request *lr,\n\t\t\t\t\t  struct wiphy *request_wiphy,\n\t\t\t\t\t  const struct ieee80211_reg_rule *rrule1,\n\t\t\t\t\t  const struct ieee80211_reg_rule *rrule2,\n\t\t\t\t\t  struct ieee80211_freq_range *comb_range)\n{\n\tu32 bw_flags1 = 0;\n\tu32 bw_flags2 = 0;\n\tconst struct ieee80211_power_rule *power_rule1 = NULL;\n\tconst struct ieee80211_power_rule *power_rule2 = NULL;\n\tconst struct ieee80211_regdomain *regd;\n\n\tregd = reg_get_regdomain(wiphy);\n\n\tpower_rule1 = &rrule1->power_rule;\n\tpower_rule2 = &rrule2->power_rule;\n\tbw_flags1 = reg_rule_to_chan_bw_flags(regd, rrule1, chan);\n\tbw_flags2 = reg_rule_to_chan_bw_flags(regd, rrule2, chan);\n\n\tif (lr->initiator == NL80211_REGDOM_SET_BY_DRIVER &&\n\t    request_wiphy && request_wiphy == wiphy &&\n\t    request_wiphy->regulatory_flags & REGULATORY_STRICT_REG) {\n\t\t/* This guarantees the driver's requested regulatory domain\n\t\t * will always be used as a base for further regulatory\n\t\t * settings\n\t\t */\n\t\tchan->flags =\n\t\t\tmap_regdom_flags(rrule1->flags) |\n\t\t\tmap_regdom_flags(rrule2->flags) |\n\t\t\tbw_flags1 |\n\t\t\tbw_flags2;\n\t\tchan->orig_flags = chan->flags;\n\t\tchan->max_antenna_gain =\n\t\t\tmin_t(int, MBI_TO_DBI(power_rule1->max_antenna_gain),\n\t\t\t      MBI_TO_DBI(power_rule2->max_antenna_gain));\n\t\tchan->orig_mag = chan->max_antenna_gain;\n\t\tchan->max_reg_power =\n\t\t\tmin_t(int, MBM_TO_DBM(power_rule1->max_eirp),\n\t\t\t      MBM_TO_DBM(power_rule2->max_eirp));\n\t\tchan->max_power = chan->max_reg_power;\n\t\tchan->orig_mpwr = chan->max_reg_power;\n\n\t\tif (chan->flags & IEEE80211_CHAN_RADAR) {\n\t\t\tchan->dfs_cac_ms = IEEE80211_DFS_MIN_CAC_TIME_MS;\n\t\t\tif (rrule1->dfs_cac_ms || rrule2->dfs_cac_ms)\n\t\t\t\tchan->dfs_cac_ms = max_t(unsigned int,\n\t\t\t\t\t\t\t rrule1->dfs_cac_ms,\n\t\t\t\t\t\t\t rrule2->dfs_cac_ms);\n\t\t}\n\n\t\treturn;\n\t}\n\n\tchan->dfs_state = NL80211_DFS_USABLE;\n\tchan->dfs_state_entered = jiffies;\n\n\tchan->beacon_found = false;\n\tchan->flags = flags | bw_flags1 | bw_flags2 |\n\t\t      map_regdom_flags(rrule1->flags) |\n\t\t      map_regdom_flags(rrule2->flags);\n\n\t/* reg_rule_to_chan_bw_flags may forbids 10 and forbids 20 MHz\n\t * (otherwise no adj. rule case), recheck therefore\n\t */\n\tif (cfg80211_does_bw_fit_range(comb_range,\n\t\t\t\t       ieee80211_channel_to_khz(chan),\n\t\t\t\t       MHZ_TO_KHZ(10)))\n\t\tchan->flags &= ~IEEE80211_CHAN_NO_10MHZ;\n\tif (cfg80211_does_bw_fit_range(comb_range,\n\t\t\t\t       ieee80211_channel_to_khz(chan),\n\t\t\t\t       MHZ_TO_KHZ(20)))\n\t\tchan->flags &= ~IEEE80211_CHAN_NO_20MHZ;\n\n\tchan->max_antenna_gain =\n\t\tmin_t(int, chan->orig_mag,\n\t\t      min_t(int,\n\t\t\t    MBI_TO_DBI(power_rule1->max_antenna_gain),\n\t\t\t    MBI_TO_DBI(power_rule2->max_antenna_gain)));\n\tchan->max_reg_power = min_t(int,\n\t\t\t\t    MBM_TO_DBM(power_rule1->max_eirp),\n\t\t\t\t    MBM_TO_DBM(power_rule2->max_eirp));\n\n\tif (chan->flags & IEEE80211_CHAN_RADAR) {\n\t\tif (rrule1->dfs_cac_ms || rrule2->dfs_cac_ms)\n\t\t\tchan->dfs_cac_ms = max_t(unsigned int,\n\t\t\t\t\t\t rrule1->dfs_cac_ms,\n\t\t\t\t\t\t rrule2->dfs_cac_ms);\n\t\telse\n\t\t\tchan->dfs_cac_ms = IEEE80211_DFS_MIN_CAC_TIME_MS;\n\t}\n\n\tif (chan->orig_mpwr) {\n\t\t/* Devices that use REGULATORY_COUNTRY_IE_FOLLOW_POWER\n\t\t * will always follow the passed country IE power settings.\n\t\t */\n\t\tif (initiator == NL80211_REGDOM_SET_BY_COUNTRY_IE &&\n\t\t    wiphy->regulatory_flags & REGULATORY_COUNTRY_IE_FOLLOW_POWER)\n\t\t\tchan->max_power = chan->max_reg_power;\n\t\telse\n\t\t\tchan->max_power = min(chan->orig_mpwr,\n\t\t\t\t\t      chan->max_reg_power);\n\t} else {\n\t\tchan->max_power = chan->max_reg_power;\n\t}\n}\n\n/* Note that right now we assume the desired channel bandwidth\n * is always 20 MHz for each individual channel (HT40 uses 20 MHz\n * per channel, the primary and the extension channel).\n */\nstatic void handle_channel(struct wiphy *wiphy,\n\t\t\t   enum nl80211_reg_initiator initiator,\n\t\t\t   struct ieee80211_channel *chan)\n{\n\tconst u32 orig_chan_freq = ieee80211_channel_to_khz(chan);\n\tstruct regulatory_request *lr = get_last_request();\n\tstruct wiphy *request_wiphy = wiphy_idx_to_wiphy(lr->wiphy_idx);\n\tconst struct ieee80211_reg_rule *rrule = NULL;\n\tconst struct ieee80211_reg_rule *rrule1 = NULL;\n\tconst struct ieee80211_reg_rule *rrule2 = NULL;\n\n\tu32 flags = chan->orig_flags;\n\n\trrule = freq_reg_info(wiphy, orig_chan_freq);\n\tif (IS_ERR(rrule)) {\n\t\t/* check for adjacent match, therefore get rules for\n\t\t * chan - 20 MHz and chan + 20 MHz and test\n\t\t * if reg rules are adjacent\n\t\t */\n\t\trrule1 = freq_reg_info(wiphy,\n\t\t\t\t       orig_chan_freq - MHZ_TO_KHZ(20));\n\t\trrule2 = freq_reg_info(wiphy,\n\t\t\t\t       orig_chan_freq + MHZ_TO_KHZ(20));\n\t\tif (!IS_ERR(rrule1) && !IS_ERR(rrule2)) {\n\t\t\tstruct ieee80211_freq_range comb_range;\n\n\t\t\tif (rrule1->freq_range.end_freq_khz !=\n\t\t\t    rrule2->freq_range.start_freq_khz)\n\t\t\t\tgoto disable_chan;\n\n\t\t\tcomb_range.start_freq_khz =\n\t\t\t\trrule1->freq_range.start_freq_khz;\n\t\t\tcomb_range.end_freq_khz =\n\t\t\t\trrule2->freq_range.end_freq_khz;\n\t\t\tcomb_range.max_bandwidth_khz =\n\t\t\t\tmin_t(u32,\n\t\t\t\t      rrule1->freq_range.max_bandwidth_khz,\n\t\t\t\t      rrule2->freq_range.max_bandwidth_khz);\n\n\t\t\tif (!cfg80211_does_bw_fit_range(&comb_range,\n\t\t\t\t\t\t\torig_chan_freq,\n\t\t\t\t\t\t\tMHZ_TO_KHZ(20)))\n\t\t\t\tgoto disable_chan;\n\n\t\t\thandle_channel_adjacent_rules(wiphy, initiator, chan,\n\t\t\t\t\t\t      flags, lr, request_wiphy,\n\t\t\t\t\t\t      rrule1, rrule2,\n\t\t\t\t\t\t      &comb_range);\n\t\t\treturn;\n\t\t}\n\ndisable_chan:\n\t\t/* We will disable all channels that do not match our\n\t\t * received regulatory rule unless the hint is coming\n\t\t * from a Country IE and the Country IE had no information\n\t\t * about a band. The IEEE 802.11 spec allows for an AP\n\t\t * to send only a subset of the regulatory rules allowed,\n\t\t * so an AP in the US that only supports 2.4 GHz may only send\n\t\t * a country IE with information for the 2.4 GHz band\n\t\t * while 5 GHz is still supported.\n\t\t */\n\t\tif (initiator == NL80211_REGDOM_SET_BY_COUNTRY_IE &&\n\t\t    PTR_ERR(rrule) == -ERANGE)\n\t\t\treturn;\n\n\t\tif (lr->initiator == NL80211_REGDOM_SET_BY_DRIVER &&\n\t\t    request_wiphy && request_wiphy == wiphy &&\n\t\t    request_wiphy->regulatory_flags & REGULATORY_STRICT_REG) {\n\t\t\tpr_debug(\"Disabling freq %d.%03d MHz for good\\n\",\n\t\t\t\t chan->center_freq, chan->freq_offset);\n\t\t\tchan->orig_flags |= IEEE80211_CHAN_DISABLED;\n\t\t\tchan->flags = chan->orig_flags;\n\t\t} else {\n\t\t\tpr_debug(\"Disabling freq %d.%03d MHz\\n\",\n\t\t\t\t chan->center_freq, chan->freq_offset);\n\t\t\tchan->flags |= IEEE80211_CHAN_DISABLED;\n\t\t}\n\t\treturn;\n\t}\n\n\thandle_channel_single_rule(wiphy, initiator, chan, flags, lr,\n\t\t\t\t   request_wiphy, rrule);\n}\n\nstatic void handle_band(struct wiphy *wiphy,\n\t\t\tenum nl80211_reg_initiator initiator,\n\t\t\tstruct ieee80211_supported_band *sband)\n{\n\tunsigned int i;\n\n\tif (!sband)\n\t\treturn;\n\n\tfor (i = 0; i < sband->n_channels; i++)\n\t\thandle_channel(wiphy, initiator, &sband->channels[i]);\n}\n\nstatic bool reg_request_cell_base(struct regulatory_request *request)\n{\n\tif (request->initiator != NL80211_REGDOM_SET_BY_USER)\n\t\treturn false;\n\treturn request->user_reg_hint_type == NL80211_USER_REG_HINT_CELL_BASE;\n}\n\nbool reg_last_request_cell_base(void)\n{\n\treturn reg_request_cell_base(get_last_request());\n}\n\n#ifdef CONFIG_CFG80211_REG_CELLULAR_HINTS\n/* Core specific check */\nstatic enum reg_request_treatment\nreg_ignore_cell_hint(struct regulatory_request *pending_request)\n{\n\tstruct regulatory_request *lr = get_last_request();\n\n\tif (!reg_num_devs_support_basehint)\n\t\treturn REG_REQ_IGNORE;\n\n\tif (reg_request_cell_base(lr) &&\n\t    !regdom_changes(pending_request->alpha2))\n\t\treturn REG_REQ_ALREADY_SET;\n\n\treturn REG_REQ_OK;\n}\n\n/* Device specific check */\nstatic bool reg_dev_ignore_cell_hint(struct wiphy *wiphy)\n{\n\treturn !(wiphy->features & NL80211_FEATURE_CELL_BASE_REG_HINTS);\n}\n#else\nstatic enum reg_request_treatment\nreg_ignore_cell_hint(struct regulatory_request *pending_request)\n{\n\treturn REG_REQ_IGNORE;\n}\n\nstatic bool reg_dev_ignore_cell_hint(struct wiphy *wiphy)\n{\n\treturn true;\n}\n#endif\n\nstatic bool wiphy_strict_alpha2_regd(struct wiphy *wiphy)\n{\n\tif (wiphy->regulatory_flags & REGULATORY_STRICT_REG &&\n\t    !(wiphy->regulatory_flags & REGULATORY_CUSTOM_REG))\n\t\treturn true;\n\treturn false;\n}\n\nstatic bool ignore_reg_update(struct wiphy *wiphy,\n\t\t\t      enum nl80211_reg_initiator initiator)\n{\n\tstruct regulatory_request *lr = get_last_request();\n\n\tif (wiphy->regulatory_flags & REGULATORY_WIPHY_SELF_MANAGED)\n\t\treturn true;\n\n\tif (!lr) {\n\t\tpr_debug(\"Ignoring regulatory request set by %s since last_request is not set\\n\",\n\t\t\t reg_initiator_name(initiator));\n\t\treturn true;\n\t}\n\n\tif (initiator == NL80211_REGDOM_SET_BY_CORE &&\n\t    wiphy->regulatory_flags & REGULATORY_CUSTOM_REG) {\n\t\tpr_debug(\"Ignoring regulatory request set by %s since the driver uses its own custom regulatory domain\\n\",\n\t\t\t reg_initiator_name(initiator));\n\t\treturn true;\n\t}\n\n\t/*\n\t * wiphy->regd will be set once the device has its own\n\t * desired regulatory domain set\n\t */\n\tif (wiphy_strict_alpha2_regd(wiphy) && !wiphy->regd &&\n\t    initiator != NL80211_REGDOM_SET_BY_COUNTRY_IE &&\n\t    !is_world_regdom(lr->alpha2)) {\n\t\tpr_debug(\"Ignoring regulatory request set by %s since the driver requires its own regulatory domain to be set first\\n\",\n\t\t\t reg_initiator_name(initiator));\n\t\treturn true;\n\t}\n\n\tif (reg_request_cell_base(lr))\n\t\treturn reg_dev_ignore_cell_hint(wiphy);\n\n\treturn false;\n}\n\nstatic bool reg_is_world_roaming(struct wiphy *wiphy)\n{\n\tconst struct ieee80211_regdomain *cr = get_cfg80211_regdom();\n\tconst struct ieee80211_regdomain *wr = get_wiphy_regdom(wiphy);\n\tstruct regulatory_request *lr = get_last_request();\n\n\tif (is_world_regdom(cr->alpha2) || (wr && is_world_regdom(wr->alpha2)))\n\t\treturn true;\n\n\tif (lr && lr->initiator != NL80211_REGDOM_SET_BY_COUNTRY_IE &&\n\t    wiphy->regulatory_flags & REGULATORY_CUSTOM_REG)\n\t\treturn true;\n\n\treturn false;\n}\n\nstatic void handle_reg_beacon(struct wiphy *wiphy, unsigned int chan_idx,\n\t\t\t      struct reg_beacon *reg_beacon)\n{\n\tstruct ieee80211_supported_band *sband;\n\tstruct ieee80211_channel *chan;\n\tbool channel_changed = false;\n\tstruct ieee80211_channel chan_before;\n\n\tsband = wiphy->bands[reg_beacon->chan.band];\n\tchan = &sband->channels[chan_idx];\n\n\tif (likely(!ieee80211_channel_equal(chan, &reg_beacon->chan)))\n\t\treturn;\n\n\tif (chan->beacon_found)\n\t\treturn;\n\n\tchan->beacon_found = true;\n\n\tif (!reg_is_world_roaming(wiphy))\n\t\treturn;\n\n\tif (wiphy->regulatory_flags & REGULATORY_DISABLE_BEACON_HINTS)\n\t\treturn;\n\n\tchan_before = *chan;\n\n\tif (chan->flags & IEEE80211_CHAN_NO_IR) {\n\t\tchan->flags &= ~IEEE80211_CHAN_NO_IR;\n\t\tchannel_changed = true;\n\t}\n\n\tif (channel_changed)\n\t\tnl80211_send_beacon_hint_event(wiphy, &chan_before, chan);\n}\n\n/*\n * Called when a scan on a wiphy finds a beacon on\n * new channel\n */\nstatic void wiphy_update_new_beacon(struct wiphy *wiphy,\n\t\t\t\t    struct reg_beacon *reg_beacon)\n{\n\tunsigned int i;\n\tstruct ieee80211_supported_band *sband;\n\n\tif (!wiphy->bands[reg_beacon->chan.band])\n\t\treturn;\n\n\tsband = wiphy->bands[reg_beacon->chan.band];\n\n\tfor (i = 0; i < sband->n_channels; i++)\n\t\thandle_reg_beacon(wiphy, i, reg_beacon);\n}\n\n/*\n * Called upon reg changes or a new wiphy is added\n */\nstatic void wiphy_update_beacon_reg(struct wiphy *wiphy)\n{\n\tunsigned int i;\n\tstruct ieee80211_supported_band *sband;\n\tstruct reg_beacon *reg_beacon;\n\n\tlist_for_each_entry(reg_beacon, &reg_beacon_list, list) {\n\t\tif (!wiphy->bands[reg_beacon->chan.band])\n\t\t\tcontinue;\n\t\tsband = wiphy->bands[reg_beacon->chan.band];\n\t\tfor (i = 0; i < sband->n_channels; i++)\n\t\t\thandle_reg_beacon(wiphy, i, reg_beacon);\n\t}\n}\n\n/* Reap the advantages of previously found beacons */\nstatic void reg_process_beacons(struct wiphy *wiphy)\n{\n\t/*\n\t * Means we are just firing up cfg80211, so no beacons would\n\t * have been processed yet.\n\t */\n\tif (!last_request)\n\t\treturn;\n\twiphy_update_beacon_reg(wiphy);\n}\n\nstatic bool is_ht40_allowed(struct ieee80211_channel *chan)\n{\n\tif (!chan)\n\t\treturn false;\n\tif (chan->flags & IEEE80211_CHAN_DISABLED)\n\t\treturn false;\n\t/* This would happen when regulatory rules disallow HT40 completely */\n\tif ((chan->flags & IEEE80211_CHAN_NO_HT40) == IEEE80211_CHAN_NO_HT40)\n\t\treturn false;\n\treturn true;\n}\n\nstatic void reg_process_ht_flags_channel(struct wiphy *wiphy,\n\t\t\t\t\t struct ieee80211_channel *channel)\n{\n\tstruct ieee80211_supported_band *sband = wiphy->bands[channel->band];\n\tstruct ieee80211_channel *channel_before = NULL, *channel_after = NULL;\n\tconst struct ieee80211_regdomain *regd;\n\tunsigned int i;\n\tu32 flags;\n\n\tif (!is_ht40_allowed(channel)) {\n\t\tchannel->flags |= IEEE80211_CHAN_NO_HT40;\n\t\treturn;\n\t}\n\n\t/*\n\t * We need to ensure the extension channels exist to\n\t * be able to use HT40- or HT40+, this finds them (or not)\n\t */\n\tfor (i = 0; i < sband->n_channels; i++) {\n\t\tstruct ieee80211_channel *c = &sband->channels[i];\n\n\t\tif (c->center_freq == (channel->center_freq - 20))\n\t\t\tchannel_before = c;\n\t\tif (c->center_freq == (channel->center_freq + 20))\n\t\t\tchannel_after = c;\n\t}\n\n\tflags = 0;\n\tregd = get_wiphy_regdom(wiphy);\n\tif (regd) {\n\t\tconst struct ieee80211_reg_rule *reg_rule =\n\t\t\tfreq_reg_info_regd(MHZ_TO_KHZ(channel->center_freq),\n\t\t\t\t\t   regd, MHZ_TO_KHZ(20));\n\n\t\tif (!IS_ERR(reg_rule))\n\t\t\tflags = reg_rule->flags;\n\t}\n\n\t/*\n\t * Please note that this assumes target bandwidth is 20 MHz,\n\t * if that ever changes we also need to change the below logic\n\t * to include that as well.\n\t */\n\tif (!is_ht40_allowed(channel_before) ||\n\t    flags & NL80211_RRF_NO_HT40MINUS)\n\t\tchannel->flags |= IEEE80211_CHAN_NO_HT40MINUS;\n\telse\n\t\tchannel->flags &= ~IEEE80211_CHAN_NO_HT40MINUS;\n\n\tif (!is_ht40_allowed(channel_after) ||\n\t    flags & NL80211_RRF_NO_HT40PLUS)\n\t\tchannel->flags |= IEEE80211_CHAN_NO_HT40PLUS;\n\telse\n\t\tchannel->flags &= ~IEEE80211_CHAN_NO_HT40PLUS;\n}\n\nstatic void reg_process_ht_flags_band(struct wiphy *wiphy,\n\t\t\t\t      struct ieee80211_supported_band *sband)\n{\n\tunsigned int i;\n\n\tif (!sband)\n\t\treturn;\n\n\tfor (i = 0; i < sband->n_channels; i++)\n\t\treg_process_ht_flags_channel(wiphy, &sband->channels[i]);\n}\n\nstatic void reg_process_ht_flags(struct wiphy *wiphy)\n{\n\tenum nl80211_band band;\n\n\tif (!wiphy)\n\t\treturn;\n\n\tfor (band = 0; band < NUM_NL80211_BANDS; band++)\n\t\treg_process_ht_flags_band(wiphy, wiphy->bands[band]);\n}\n\nstatic void reg_call_notifier(struct wiphy *wiphy,\n\t\t\t      struct regulatory_request *request)\n{\n\tif (wiphy->reg_notifier)\n\t\twiphy->reg_notifier(wiphy, request);\n}\n\nstatic bool reg_wdev_chan_valid(struct wiphy *wiphy, struct wireless_dev *wdev)\n{\n\tstruct cfg80211_chan_def chandef = {};\n\tstruct cfg80211_registered_device *rdev = wiphy_to_rdev(wiphy);\n\tenum nl80211_iftype iftype;\n\n\twdev_lock(wdev);\n\tiftype = wdev->iftype;\n\n\t/* make sure the interface is active */\n\tif (!wdev->netdev || !netif_running(wdev->netdev))\n\t\tgoto wdev_inactive_unlock;\n\n\tswitch (iftype) {\n\tcase NL80211_IFTYPE_AP:\n\tcase NL80211_IFTYPE_P2P_GO:\n\t\tif (!wdev->beacon_interval)\n\t\t\tgoto wdev_inactive_unlock;\n\t\tchandef = wdev->chandef;\n\t\tbreak;\n\tcase NL80211_IFTYPE_ADHOC:\n\t\tif (!wdev->ssid_len)\n\t\t\tgoto wdev_inactive_unlock;\n\t\tchandef = wdev->chandef;\n\t\tbreak;\n\tcase NL80211_IFTYPE_STATION:\n\tcase NL80211_IFTYPE_P2P_CLIENT:\n\t\tif (!wdev->current_bss ||\n\t\t    !wdev->current_bss->pub.channel)\n\t\t\tgoto wdev_inactive_unlock;\n\n\t\tif (!rdev->ops->get_channel ||\n\t\t    rdev_get_channel(rdev, wdev, &chandef))\n\t\t\tcfg80211_chandef_create(&chandef,\n\t\t\t\t\t\twdev->current_bss->pub.channel,\n\t\t\t\t\t\tNL80211_CHAN_NO_HT);\n\t\tbreak;\n\tcase NL80211_IFTYPE_MONITOR:\n\tcase NL80211_IFTYPE_AP_VLAN:\n\tcase NL80211_IFTYPE_P2P_DEVICE:\n\t\t/* no enforcement required */\n\t\tbreak;\n\tdefault:\n\t\t/* others not implemented for now */\n\t\tWARN_ON(1);\n\t\tbreak;\n\t}\n\n\twdev_unlock(wdev);\n\n\tswitch (iftype) {\n\tcase NL80211_IFTYPE_AP:\n\tcase NL80211_IFTYPE_P2P_GO:\n\tcase NL80211_IFTYPE_ADHOC:\n\t\treturn cfg80211_reg_can_beacon_relax(wiphy, &chandef, iftype);\n\tcase NL80211_IFTYPE_STATION:\n\tcase NL80211_IFTYPE_P2P_CLIENT:\n\t\treturn cfg80211_chandef_usable(wiphy, &chandef,\n\t\t\t\t\t       IEEE80211_CHAN_DISABLED);\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn true;\n\nwdev_inactive_unlock:\n\twdev_unlock(wdev);\n\treturn true;\n}\n\nstatic void reg_leave_invalid_chans(struct wiphy *wiphy)\n{\n\tstruct wireless_dev *wdev;\n\tstruct cfg80211_registered_device *rdev = wiphy_to_rdev(wiphy);\n\n\tASSERT_RTNL();\n\n\tlist_for_each_entry(wdev, &rdev->wiphy.wdev_list, list)\n\t\tif (!reg_wdev_chan_valid(wiphy, wdev))\n\t\t\tcfg80211_leave(rdev, wdev);\n}\n\nstatic void reg_check_chans_work(struct work_struct *work)\n{\n\tstruct cfg80211_registered_device *rdev;\n\n\tpr_debug(\"Verifying active interfaces after reg change\\n\");\n\trtnl_lock();\n\n\tlist_for_each_entry(rdev, &cfg80211_rdev_list, list)\n\t\tif (!(rdev->wiphy.regulatory_flags &\n\t\t      REGULATORY_IGNORE_STALE_KICKOFF))\n\t\t\treg_leave_invalid_chans(&rdev->wiphy);\n\n\trtnl_unlock();\n}\n\nstatic void reg_check_channels(void)\n{\n\t/*\n\t * Give usermode a chance to do something nicer (move to another\n\t * channel, orderly disconnection), before forcing a disconnection.\n\t */\n\tmod_delayed_work(system_power_efficient_wq,\n\t\t\t &reg_check_chans,\n\t\t\t msecs_to_jiffies(REG_ENFORCE_GRACE_MS));\n}\n\nstatic void wiphy_update_regulatory(struct wiphy *wiphy,\n\t\t\t\t    enum nl80211_reg_initiator initiator)\n{\n\tenum nl80211_band band;\n\tstruct regulatory_request *lr = get_last_request();\n\n\tif (ignore_reg_update(wiphy, initiator)) {\n\t\t/*\n\t\t * Regulatory updates set by CORE are ignored for custom\n\t\t * regulatory cards. Let us notify the changes to the driver,\n\t\t * as some drivers used this to restore its orig_* reg domain.\n\t\t */\n\t\tif (initiator == NL80211_REGDOM_SET_BY_CORE &&\n\t\t    wiphy->regulatory_flags & REGULATORY_CUSTOM_REG &&\n\t\t    !(wiphy->regulatory_flags &\n\t\t      REGULATORY_WIPHY_SELF_MANAGED))\n\t\t\treg_call_notifier(wiphy, lr);\n\t\treturn;\n\t}\n\n\tlr->dfs_region = get_cfg80211_regdom()->dfs_region;\n\n\tfor (band = 0; band < NUM_NL80211_BANDS; band++)\n\t\thandle_band(wiphy, initiator, wiphy->bands[band]);\n\n\treg_process_beacons(wiphy);\n\treg_process_ht_flags(wiphy);\n\treg_call_notifier(wiphy, lr);\n}\n\nstatic void update_all_wiphy_regulatory(enum nl80211_reg_initiator initiator)\n{\n\tstruct cfg80211_registered_device *rdev;\n\tstruct wiphy *wiphy;\n\n\tASSERT_RTNL();\n\n\tlist_for_each_entry(rdev, &cfg80211_rdev_list, list) {\n\t\twiphy = &rdev->wiphy;\n\t\twiphy_update_regulatory(wiphy, initiator);\n\t}\n\n\treg_check_channels();\n}\n\nstatic void handle_channel_custom(struct wiphy *wiphy,\n\t\t\t\t  struct ieee80211_channel *chan,\n\t\t\t\t  const struct ieee80211_regdomain *regd,\n\t\t\t\t  u32 min_bw)\n{\n\tu32 bw_flags = 0;\n\tconst struct ieee80211_reg_rule *reg_rule = NULL;\n\tconst struct ieee80211_power_rule *power_rule = NULL;\n\tu32 bw, center_freq_khz;\n\n\tcenter_freq_khz = ieee80211_channel_to_khz(chan);\n\tfor (bw = MHZ_TO_KHZ(20); bw >= min_bw; bw = bw / 2) {\n\t\treg_rule = freq_reg_info_regd(center_freq_khz, regd, bw);\n\t\tif (!IS_ERR(reg_rule))\n\t\t\tbreak;\n\t}\n\n\tif (IS_ERR_OR_NULL(reg_rule)) {\n\t\tpr_debug(\"Disabling freq %d.%03d MHz as custom regd has no rule that fits it\\n\",\n\t\t\t chan->center_freq, chan->freq_offset);\n\t\tif (wiphy->regulatory_flags & REGULATORY_WIPHY_SELF_MANAGED) {\n\t\t\tchan->flags |= IEEE80211_CHAN_DISABLED;\n\t\t} else {\n\t\t\tchan->orig_flags |= IEEE80211_CHAN_DISABLED;\n\t\t\tchan->flags = chan->orig_flags;\n\t\t}\n\t\treturn;\n\t}\n\n\tpower_rule = &reg_rule->power_rule;\n\tbw_flags = reg_rule_to_chan_bw_flags(regd, reg_rule, chan);\n\n\tchan->dfs_state_entered = jiffies;\n\tchan->dfs_state = NL80211_DFS_USABLE;\n\n\tchan->beacon_found = false;\n\n\tif (wiphy->regulatory_flags & REGULATORY_WIPHY_SELF_MANAGED)\n\t\tchan->flags = chan->orig_flags | bw_flags |\n\t\t\t      map_regdom_flags(reg_rule->flags);\n\telse\n\t\tchan->flags |= map_regdom_flags(reg_rule->flags) | bw_flags;\n\n\tchan->max_antenna_gain = (int) MBI_TO_DBI(power_rule->max_antenna_gain);\n\tchan->max_reg_power = chan->max_power =\n\t\t(int) MBM_TO_DBM(power_rule->max_eirp);\n\n\tif (chan->flags & IEEE80211_CHAN_RADAR) {\n\t\tif (reg_rule->dfs_cac_ms)\n\t\t\tchan->dfs_cac_ms = reg_rule->dfs_cac_ms;\n\t\telse\n\t\t\tchan->dfs_cac_ms = IEEE80211_DFS_MIN_CAC_TIME_MS;\n\t}\n\n\tchan->max_power = chan->max_reg_power;\n}\n\nstatic void handle_band_custom(struct wiphy *wiphy,\n\t\t\t       struct ieee80211_supported_band *sband,\n\t\t\t       const struct ieee80211_regdomain *regd)\n{\n\tunsigned int i;\n\n\tif (!sband)\n\t\treturn;\n\n\t/*\n\t * We currently assume that you always want at least 20 MHz,\n\t * otherwise channel 12 might get enabled if this rule is\n\t * compatible to US, which permits 2402 - 2472 MHz.\n\t */\n\tfor (i = 0; i < sband->n_channels; i++)\n\t\thandle_channel_custom(wiphy, &sband->channels[i], regd,\n\t\t\t\t      MHZ_TO_KHZ(20));\n}\n\n/* Used by drivers prior to wiphy registration */\nvoid wiphy_apply_custom_regulatory(struct wiphy *wiphy,\n\t\t\t\t   const struct ieee80211_regdomain *regd)\n{\n\tconst struct ieee80211_regdomain *new_regd, *tmp;\n\tenum nl80211_band band;\n\tunsigned int bands_set = 0;\n\n\tWARN(!(wiphy->regulatory_flags & REGULATORY_CUSTOM_REG),\n\t     \"wiphy should have REGULATORY_CUSTOM_REG\\n\");\n\twiphy->regulatory_flags |= REGULATORY_CUSTOM_REG;\n\n\tfor (band = 0; band < NUM_NL80211_BANDS; band++) {\n\t\tif (!wiphy->bands[band])\n\t\t\tcontinue;\n\t\thandle_band_custom(wiphy, wiphy->bands[band], regd);\n\t\tbands_set++;\n\t}\n\n\t/*\n\t * no point in calling this if it won't have any effect\n\t * on your device's supported bands.\n\t */\n\tWARN_ON(!bands_set);\n\tnew_regd = reg_copy_regd(regd);\n\tif (IS_ERR(new_regd))\n\t\treturn;\n\n\ttmp = get_wiphy_regdom(wiphy);\n\trcu_assign_pointer(wiphy->regd, new_regd);\n\trcu_free_regdom(tmp);\n}\nEXPORT_SYMBOL(wiphy_apply_custom_regulatory);\n\nstatic void reg_set_request_processed(void)\n{\n\tbool need_more_processing = false;\n\tstruct regulatory_request *lr = get_last_request();\n\n\tlr->processed = true;\n\n\tspin_lock(&reg_requests_lock);\n\tif (!list_empty(&reg_requests_list))\n\t\tneed_more_processing = true;\n\tspin_unlock(&reg_requests_lock);\n\n\tcancel_crda_timeout();\n\n\tif (need_more_processing)\n\t\tschedule_work(&reg_work);\n}\n\n/**\n * reg_process_hint_core - process core regulatory requests\n * @core_request: a pending core regulatory request\n *\n * The wireless subsystem can use this function to process\n * a regulatory request issued by the regulatory core.\n */\nstatic enum reg_request_treatment\nreg_process_hint_core(struct regulatory_request *core_request)\n{\n\tif (reg_query_database(core_request)) {\n\t\tcore_request->intersect = false;\n\t\tcore_request->processed = false;\n\t\treg_update_last_request(core_request);\n\t\treturn REG_REQ_OK;\n\t}\n\n\treturn REG_REQ_IGNORE;\n}\n\nstatic enum reg_request_treatment\n__reg_process_hint_user(struct regulatory_request *user_request)\n{\n\tstruct regulatory_request *lr = get_last_request();\n\n\tif (reg_request_cell_base(user_request))\n\t\treturn reg_ignore_cell_hint(user_request);\n\n\tif (reg_request_cell_base(lr))\n\t\treturn REG_REQ_IGNORE;\n\n\tif (lr->initiator == NL80211_REGDOM_SET_BY_COUNTRY_IE)\n\t\treturn REG_REQ_INTERSECT;\n\t/*\n\t * If the user knows better the user should set the regdom\n\t * to their country before the IE is picked up\n\t */\n\tif (lr->initiator == NL80211_REGDOM_SET_BY_USER &&\n\t    lr->intersect)\n\t\treturn REG_REQ_IGNORE;\n\t/*\n\t * Process user requests only after previous user/driver/core\n\t * requests have been processed\n\t */\n\tif ((lr->initiator == NL80211_REGDOM_SET_BY_CORE ||\n\t     lr->initiator == NL80211_REGDOM_SET_BY_DRIVER ||\n\t     lr->initiator == NL80211_REGDOM_SET_BY_USER) &&\n\t    regdom_changes(lr->alpha2))\n\t\treturn REG_REQ_IGNORE;\n\n\tif (!regdom_changes(user_request->alpha2))\n\t\treturn REG_REQ_ALREADY_SET;\n\n\treturn REG_REQ_OK;\n}\n\n/**\n * reg_process_hint_user - process user regulatory requests\n * @user_request: a pending user regulatory request\n *\n * The wireless subsystem can use this function to process\n * a regulatory request initiated by userspace.\n */\nstatic enum reg_request_treatment\nreg_process_hint_user(struct regulatory_request *user_request)\n{\n\tenum reg_request_treatment treatment;\n\n\ttreatment = __reg_process_hint_user(user_request);\n\tif (treatment == REG_REQ_IGNORE ||\n\t    treatment == REG_REQ_ALREADY_SET)\n\t\treturn REG_REQ_IGNORE;\n\n\tuser_request->intersect = treatment == REG_REQ_INTERSECT;\n\tuser_request->processed = false;\n\n\tif (reg_query_database(user_request)) {\n\t\treg_update_last_request(user_request);\n\t\tuser_alpha2[0] = user_request->alpha2[0];\n\t\tuser_alpha2[1] = user_request->alpha2[1];\n\t\treturn REG_REQ_OK;\n\t}\n\n\treturn REG_REQ_IGNORE;\n}\n\nstatic enum reg_request_treatment\n__reg_process_hint_driver(struct regulatory_request *driver_request)\n{\n\tstruct regulatory_request *lr = get_last_request();\n\n\tif (lr->initiator == NL80211_REGDOM_SET_BY_CORE) {\n\t\tif (regdom_changes(driver_request->alpha2))\n\t\t\treturn REG_REQ_OK;\n\t\treturn REG_REQ_ALREADY_SET;\n\t}\n\n\t/*\n\t * This would happen if you unplug and plug your card\n\t * back in or if you add a new device for which the previously\n\t * loaded card also agrees on the regulatory domain.\n\t */\n\tif (lr->initiator == NL80211_REGDOM_SET_BY_DRIVER &&\n\t    !regdom_changes(driver_request->alpha2))\n\t\treturn REG_REQ_ALREADY_SET;\n\n\treturn REG_REQ_INTERSECT;\n}\n\n/**\n * reg_process_hint_driver - process driver regulatory requests\n * @wiphy: the wireless device for the regulatory request\n * @driver_request: a pending driver regulatory request\n *\n * The wireless subsystem can use this function to process\n * a regulatory request issued by an 802.11 driver.\n *\n * Returns one of the different reg request treatment values.\n */\nstatic enum reg_request_treatment\nreg_process_hint_driver(struct wiphy *wiphy,\n\t\t\tstruct regulatory_request *driver_request)\n{\n\tconst struct ieee80211_regdomain *regd, *tmp;\n\tenum reg_request_treatment treatment;\n\n\ttreatment = __reg_process_hint_driver(driver_request);\n\n\tswitch (treatment) {\n\tcase REG_REQ_OK:\n\t\tbreak;\n\tcase REG_REQ_IGNORE:\n\t\treturn REG_REQ_IGNORE;\n\tcase REG_REQ_INTERSECT:\n\tcase REG_REQ_ALREADY_SET:\n\t\tregd = reg_copy_regd(get_cfg80211_regdom());\n\t\tif (IS_ERR(regd))\n\t\t\treturn REG_REQ_IGNORE;\n\n\t\ttmp = get_wiphy_regdom(wiphy);\n\t\trcu_assign_pointer(wiphy->regd, regd);\n\t\trcu_free_regdom(tmp);\n\t}\n\n\n\tdriver_request->intersect = treatment == REG_REQ_INTERSECT;\n\tdriver_request->processed = false;\n\n\t/*\n\t * Since CRDA will not be called in this case as we already\n\t * have applied the requested regulatory domain before we just\n\t * inform userspace we have processed the request\n\t */\n\tif (treatment == REG_REQ_ALREADY_SET) {\n\t\tnl80211_send_reg_change_event(driver_request);\n\t\treg_update_last_request(driver_request);\n\t\treg_set_request_processed();\n\t\treturn REG_REQ_ALREADY_SET;\n\t}\n\n\tif (reg_query_database(driver_request)) {\n\t\treg_update_last_request(driver_request);\n\t\treturn REG_REQ_OK;\n\t}\n\n\treturn REG_REQ_IGNORE;\n}\n\nstatic enum reg_request_treatment\n__reg_process_hint_country_ie(struct wiphy *wiphy,\n\t\t\t      struct regulatory_request *country_ie_request)\n{\n\tstruct wiphy *last_wiphy = NULL;\n\tstruct regulatory_request *lr = get_last_request();\n\n\tif (reg_request_cell_base(lr)) {\n\t\t/* Trust a Cell base station over the AP's country IE */\n\t\tif (regdom_changes(country_ie_request->alpha2))\n\t\t\treturn REG_REQ_IGNORE;\n\t\treturn REG_REQ_ALREADY_SET;\n\t} else {\n\t\tif (wiphy->regulatory_flags & REGULATORY_COUNTRY_IE_IGNORE)\n\t\t\treturn REG_REQ_IGNORE;\n\t}\n\n\tif (unlikely(!is_an_alpha2(country_ie_request->alpha2)))\n\t\treturn -EINVAL;\n\n\tif (lr->initiator != NL80211_REGDOM_SET_BY_COUNTRY_IE)\n\t\treturn REG_REQ_OK;\n\n\tlast_wiphy = wiphy_idx_to_wiphy(lr->wiphy_idx);\n\n\tif (last_wiphy != wiphy) {\n\t\t/*\n\t\t * Two cards with two APs claiming different\n\t\t * Country IE alpha2s. We could\n\t\t * intersect them, but that seems unlikely\n\t\t * to be correct. Reject second one for now.\n\t\t */\n\t\tif (regdom_changes(country_ie_request->alpha2))\n\t\t\treturn REG_REQ_IGNORE;\n\t\treturn REG_REQ_ALREADY_SET;\n\t}\n\n\tif (regdom_changes(country_ie_request->alpha2))\n\t\treturn REG_REQ_OK;\n\treturn REG_REQ_ALREADY_SET;\n}\n\n/**\n * reg_process_hint_country_ie - process regulatory requests from country IEs\n * @wiphy: the wireless device for the regulatory request\n * @country_ie_request: a regulatory request from a country IE\n *\n * The wireless subsystem can use this function to process\n * a regulatory request issued by a country Information Element.\n *\n * Returns one of the different reg request treatment values.\n */\nstatic enum reg_request_treatment\nreg_process_hint_country_ie(struct wiphy *wiphy,\n\t\t\t    struct regulatory_request *country_ie_request)\n{\n\tenum reg_request_treatment treatment;\n\n\ttreatment = __reg_process_hint_country_ie(wiphy, country_ie_request);\n\n\tswitch (treatment) {\n\tcase REG_REQ_OK:\n\t\tbreak;\n\tcase REG_REQ_IGNORE:\n\t\treturn REG_REQ_IGNORE;\n\tcase REG_REQ_ALREADY_SET:\n\t\treg_free_request(country_ie_request);\n\t\treturn REG_REQ_ALREADY_SET;\n\tcase REG_REQ_INTERSECT:\n\t\t/*\n\t\t * This doesn't happen yet, not sure we\n\t\t * ever want to support it for this case.\n\t\t */\n\t\tWARN_ONCE(1, \"Unexpected intersection for country elements\");\n\t\treturn REG_REQ_IGNORE;\n\t}\n\n\tcountry_ie_request->intersect = false;\n\tcountry_ie_request->processed = false;\n\n\tif (reg_query_database(country_ie_request)) {\n\t\treg_update_last_request(country_ie_request);\n\t\treturn REG_REQ_OK;\n\t}\n\n\treturn REG_REQ_IGNORE;\n}\n\nbool reg_dfs_domain_same(struct wiphy *wiphy1, struct wiphy *wiphy2)\n{\n\tconst struct ieee80211_regdomain *wiphy1_regd = NULL;\n\tconst struct ieee80211_regdomain *wiphy2_regd = NULL;\n\tconst struct ieee80211_regdomain *cfg80211_regd = NULL;\n\tbool dfs_domain_same;\n\n\trcu_read_lock();\n\n\tcfg80211_regd = rcu_dereference(cfg80211_regdomain);\n\twiphy1_regd = rcu_dereference(wiphy1->regd);\n\tif (!wiphy1_regd)\n\t\twiphy1_regd = cfg80211_regd;\n\n\twiphy2_regd = rcu_dereference(wiphy2->regd);\n\tif (!wiphy2_regd)\n\t\twiphy2_regd = cfg80211_regd;\n\n\tdfs_domain_same = wiphy1_regd->dfs_region == wiphy2_regd->dfs_region;\n\n\trcu_read_unlock();\n\n\treturn dfs_domain_same;\n}\n\nstatic void reg_copy_dfs_chan_state(struct ieee80211_channel *dst_chan,\n\t\t\t\t    struct ieee80211_channel *src_chan)\n{\n\tif (!(dst_chan->flags & IEEE80211_CHAN_RADAR) ||\n\t    !(src_chan->flags & IEEE80211_CHAN_RADAR))\n\t\treturn;\n\n\tif (dst_chan->flags & IEEE80211_CHAN_DISABLED ||\n\t    src_chan->flags & IEEE80211_CHAN_DISABLED)\n\t\treturn;\n\n\tif (src_chan->center_freq == dst_chan->center_freq &&\n\t    dst_chan->dfs_state == NL80211_DFS_USABLE) {\n\t\tdst_chan->dfs_state = src_chan->dfs_state;\n\t\tdst_chan->dfs_state_entered = src_chan->dfs_state_entered;\n\t}\n}\n\nstatic void wiphy_share_dfs_chan_state(struct wiphy *dst_wiphy,\n\t\t\t\t       struct wiphy *src_wiphy)\n{\n\tstruct ieee80211_supported_band *src_sband, *dst_sband;\n\tstruct ieee80211_channel *src_chan, *dst_chan;\n\tint i, j, band;\n\n\tif (!reg_dfs_domain_same(dst_wiphy, src_wiphy))\n\t\treturn;\n\n\tfor (band = 0; band < NUM_NL80211_BANDS; band++) {\n\t\tdst_sband = dst_wiphy->bands[band];\n\t\tsrc_sband = src_wiphy->bands[band];\n\t\tif (!dst_sband || !src_sband)\n\t\t\tcontinue;\n\n\t\tfor (i = 0; i < dst_sband->n_channels; i++) {\n\t\t\tdst_chan = &dst_sband->channels[i];\n\t\t\tfor (j = 0; j < src_sband->n_channels; j++) {\n\t\t\t\tsrc_chan = &src_sband->channels[j];\n\t\t\t\treg_copy_dfs_chan_state(dst_chan, src_chan);\n\t\t\t}\n\t\t}\n\t}\n}\n\nstatic void wiphy_all_share_dfs_chan_state(struct wiphy *wiphy)\n{\n\tstruct cfg80211_registered_device *rdev;\n\n\tASSERT_RTNL();\n\n\tlist_for_each_entry(rdev, &cfg80211_rdev_list, list) {\n\t\tif (wiphy == &rdev->wiphy)\n\t\t\tcontinue;\n\t\twiphy_share_dfs_chan_state(wiphy, &rdev->wiphy);\n\t}\n}\n\n/* This processes *all* regulatory hints */\nstatic void reg_process_hint(struct regulatory_request *reg_request)\n{\n\tstruct wiphy *wiphy = NULL;\n\tenum reg_request_treatment treatment;\n\tenum nl80211_reg_initiator initiator = reg_request->initiator;\n\n\tif (reg_request->wiphy_idx != WIPHY_IDX_INVALID)\n\t\twiphy = wiphy_idx_to_wiphy(reg_request->wiphy_idx);\n\n\tswitch (initiator) {\n\tcase NL80211_REGDOM_SET_BY_CORE:\n\t\ttreatment = reg_process_hint_core(reg_request);\n\t\tbreak;\n\tcase NL80211_REGDOM_SET_BY_USER:\n\t\ttreatment = reg_process_hint_user(reg_request);\n\t\tbreak;\n\tcase NL80211_REGDOM_SET_BY_DRIVER:\n\t\tif (!wiphy)\n\t\t\tgoto out_free;\n\t\ttreatment = reg_process_hint_driver(wiphy, reg_request);\n\t\tbreak;\n\tcase NL80211_REGDOM_SET_BY_COUNTRY_IE:\n\t\tif (!wiphy)\n\t\t\tgoto out_free;\n\t\ttreatment = reg_process_hint_country_ie(wiphy, reg_request);\n\t\tbreak;\n\tdefault:\n\t\tWARN(1, \"invalid initiator %d\\n\", initiator);\n\t\tgoto out_free;\n\t}\n\n\tif (treatment == REG_REQ_IGNORE)\n\t\tgoto out_free;\n\n\tWARN(treatment != REG_REQ_OK && treatment != REG_REQ_ALREADY_SET,\n\t     \"unexpected treatment value %d\\n\", treatment);\n\n\t/* This is required so that the orig_* parameters are saved.\n\t * NOTE: treatment must be set for any case that reaches here!\n\t */\n\tif (treatment == REG_REQ_ALREADY_SET && wiphy &&\n\t    wiphy->regulatory_flags & REGULATORY_STRICT_REG) {\n\t\twiphy_update_regulatory(wiphy, initiator);\n\t\twiphy_all_share_dfs_chan_state(wiphy);\n\t\treg_check_channels();\n\t}\n\n\treturn;\n\nout_free:\n\treg_free_request(reg_request);\n}\n\nstatic void notify_self_managed_wiphys(struct regulatory_request *request)\n{\n\tstruct cfg80211_registered_device *rdev;\n\tstruct wiphy *wiphy;\n\n\tlist_for_each_entry(rdev, &cfg80211_rdev_list, list) {\n\t\twiphy = &rdev->wiphy;\n\t\tif (wiphy->regulatory_flags & REGULATORY_WIPHY_SELF_MANAGED &&\n\t\t    request->initiator == NL80211_REGDOM_SET_BY_USER)\n\t\t\treg_call_notifier(wiphy, request);\n\t}\n}\n\n/*\n * Processes regulatory hints, this is all the NL80211_REGDOM_SET_BY_*\n * Regulatory hints come on a first come first serve basis and we\n * must process each one atomically.\n */\nstatic void reg_process_pending_hints(void)\n{\n\tstruct regulatory_request *reg_request, *lr;\n\n\tlr = get_last_request();\n\n\t/* When last_request->processed becomes true this will be rescheduled */\n\tif (lr && !lr->processed) {\n\t\tpr_debug(\"Pending regulatory request, waiting for it to be processed...\\n\");\n\t\treturn;\n\t}\n\n\tspin_lock(&reg_requests_lock);\n\n\tif (list_empty(&reg_requests_list)) {\n\t\tspin_unlock(&reg_requests_lock);\n\t\treturn;\n\t}\n\n\treg_request = list_first_entry(&reg_requests_list,\n\t\t\t\t       struct regulatory_request,\n\t\t\t\t       list);\n\tlist_del_init(&reg_request->list);\n\n\tspin_unlock(&reg_requests_lock);\n\n\tnotify_self_managed_wiphys(reg_request);\n\n\treg_process_hint(reg_request);\n\n\tlr = get_last_request();\n\n\tspin_lock(&reg_requests_lock);\n\tif (!list_empty(&reg_requests_list) && lr && lr->processed)\n\t\tschedule_work(&reg_work);\n\tspin_unlock(&reg_requests_lock);\n}\n\n/* Processes beacon hints -- this has nothing to do with country IEs */\nstatic void reg_process_pending_beacon_hints(void)\n{\n\tstruct cfg80211_registered_device *rdev;\n\tstruct reg_beacon *pending_beacon, *tmp;\n\n\t/* This goes through the _pending_ beacon list */\n\tspin_lock_bh(&reg_pending_beacons_lock);\n\n\tlist_for_each_entry_safe(pending_beacon, tmp,\n\t\t\t\t &reg_pending_beacons, list) {\n\t\tlist_del_init(&pending_beacon->list);\n\n\t\t/* Applies the beacon hint to current wiphys */\n\t\tlist_for_each_entry(rdev, &cfg80211_rdev_list, list)\n\t\t\twiphy_update_new_beacon(&rdev->wiphy, pending_beacon);\n\n\t\t/* Remembers the beacon hint for new wiphys or reg changes */\n\t\tlist_add_tail(&pending_beacon->list, &reg_beacon_list);\n\t}\n\n\tspin_unlock_bh(&reg_pending_beacons_lock);\n}\n\nstatic void reg_process_self_managed_hints(void)\n{\n\tstruct cfg80211_registered_device *rdev;\n\tstruct wiphy *wiphy;\n\tconst struct ieee80211_regdomain *tmp;\n\tconst struct ieee80211_regdomain *regd;\n\tenum nl80211_band band;\n\tstruct regulatory_request request = {};\n\n\tlist_for_each_entry(rdev, &cfg80211_rdev_list, list) {\n\t\twiphy = &rdev->wiphy;\n\n\t\tspin_lock(&reg_requests_lock);\n\t\tregd = rdev->requested_regd;\n\t\trdev->requested_regd = NULL;\n\t\tspin_unlock(&reg_requests_lock);\n\n\t\tif (regd == NULL)\n\t\t\tcontinue;\n\n\t\ttmp = get_wiphy_regdom(wiphy);\n\t\trcu_assign_pointer(wiphy->regd, regd);\n\t\trcu_free_regdom(tmp);\n\n\t\tfor (band = 0; band < NUM_NL80211_BANDS; band++)\n\t\t\thandle_band_custom(wiphy, wiphy->bands[band], regd);\n\n\t\treg_process_ht_flags(wiphy);\n\n\t\trequest.wiphy_idx = get_wiphy_idx(wiphy);\n\t\trequest.alpha2[0] = regd->alpha2[0];\n\t\trequest.alpha2[1] = regd->alpha2[1];\n\t\trequest.initiator = NL80211_REGDOM_SET_BY_DRIVER;\n\n\t\tnl80211_send_wiphy_reg_change_event(&request);\n\t}\n\n\treg_check_channels();\n}\n\nstatic void reg_todo(struct work_struct *work)\n{\n\trtnl_lock();\n\treg_process_pending_hints();\n\treg_process_pending_beacon_hints();\n\treg_process_self_managed_hints();\n\trtnl_unlock();\n}\n\nstatic void queue_regulatory_request(struct regulatory_request *request)\n{\n\trequest->alpha2[0] = toupper(request->alpha2[0]);\n\trequest->alpha2[1] = toupper(request->alpha2[1]);\n\n\tspin_lock(&reg_requests_lock);\n\tlist_add_tail(&request->list, &reg_requests_list);\n\tspin_unlock(&reg_requests_lock);\n\n\tschedule_work(&reg_work);\n}\n\n/*\n * Core regulatory hint -- happens during cfg80211_init()\n * and when we restore regulatory settings.\n */\nstatic int regulatory_hint_core(const char *alpha2)\n{\n\tstruct regulatory_request *request;\n\n\trequest = kzalloc(sizeof(struct regulatory_request), GFP_KERNEL);\n\tif (!request)\n\t\treturn -ENOMEM;\n\n\trequest->alpha2[0] = alpha2[0];\n\trequest->alpha2[1] = alpha2[1];\n\trequest->initiator = NL80211_REGDOM_SET_BY_CORE;\n\trequest->wiphy_idx = WIPHY_IDX_INVALID;\n\n\tqueue_regulatory_request(request);\n\n\treturn 0;\n}\n\n/* User hints */\nint regulatory_hint_user(const char *alpha2,\n\t\t\t enum nl80211_user_reg_hint_type user_reg_hint_type)\n{\n\tstruct regulatory_request *request;\n\n\tif (WARN_ON(!alpha2))\n\t\treturn -EINVAL;\n\n\tif (!is_world_regdom(alpha2) && !is_an_alpha2(alpha2))\n\t\treturn -EINVAL;\n\n\trequest = kzalloc(sizeof(struct regulatory_request), GFP_KERNEL);\n\tif (!request)\n\t\treturn -ENOMEM;\n\n\trequest->wiphy_idx = WIPHY_IDX_INVALID;\n\trequest->alpha2[0] = alpha2[0];\n\trequest->alpha2[1] = alpha2[1];\n\trequest->initiator = NL80211_REGDOM_SET_BY_USER;\n\trequest->user_reg_hint_type = user_reg_hint_type;\n\n\t/* Allow calling CRDA again */\n\treset_crda_timeouts();\n\n\tqueue_regulatory_request(request);\n\n\treturn 0;\n}\n\nint regulatory_hint_indoor(bool is_indoor, u32 portid)\n{\n\tspin_lock(&reg_indoor_lock);\n\n\t/* It is possible that more than one user space process is trying to\n\t * configure the indoor setting. To handle such cases, clear the indoor\n\t * setting in case that some process does not think that the device\n\t * is operating in an indoor environment. In addition, if a user space\n\t * process indicates that it is controlling the indoor setting, save its\n\t * portid, i.e., make it the owner.\n\t */\n\treg_is_indoor = is_indoor;\n\tif (reg_is_indoor) {\n\t\tif (!reg_is_indoor_portid)\n\t\t\treg_is_indoor_portid = portid;\n\t} else {\n\t\treg_is_indoor_portid = 0;\n\t}\n\n\tspin_unlock(&reg_indoor_lock);\n\n\tif (!is_indoor)\n\t\treg_check_channels();\n\n\treturn 0;\n}\n\nvoid regulatory_netlink_notify(u32 portid)\n{\n\tspin_lock(&reg_indoor_lock);\n\n\tif (reg_is_indoor_portid != portid) {\n\t\tspin_unlock(&reg_indoor_lock);\n\t\treturn;\n\t}\n\n\treg_is_indoor = false;\n\treg_is_indoor_portid = 0;\n\n\tspin_unlock(&reg_indoor_lock);\n\n\treg_check_channels();\n}\n\n/* Driver hints */\nint regulatory_hint(struct wiphy *wiphy, const char *alpha2)\n{\n\tstruct regulatory_request *request;\n\n\tif (WARN_ON(!alpha2 || !wiphy))\n\t\treturn -EINVAL;\n\n\twiphy->regulatory_flags &= ~REGULATORY_CUSTOM_REG;\n\n\trequest = kzalloc(sizeof(struct regulatory_request), GFP_KERNEL);\n\tif (!request)\n\t\treturn -ENOMEM;\n\n\trequest->wiphy_idx = get_wiphy_idx(wiphy);\n\n\trequest->alpha2[0] = alpha2[0];\n\trequest->alpha2[1] = alpha2[1];\n\trequest->initiator = NL80211_REGDOM_SET_BY_DRIVER;\n\n\t/* Allow calling CRDA again */\n\treset_crda_timeouts();\n\n\tqueue_regulatory_request(request);\n\n\treturn 0;\n}\nEXPORT_SYMBOL(regulatory_hint);\n\nvoid regulatory_hint_country_ie(struct wiphy *wiphy, enum nl80211_band band,\n\t\t\t\tconst u8 *country_ie, u8 country_ie_len)\n{\n\tchar alpha2[2];\n\tenum environment_cap env = ENVIRON_ANY;\n\tstruct regulatory_request *request = NULL, *lr;\n\n\t/* IE len must be evenly divisible by 2 */\n\tif (country_ie_len & 0x01)\n\t\treturn;\n\n\tif (country_ie_len < IEEE80211_COUNTRY_IE_MIN_LEN)\n\t\treturn;\n\n\trequest = kzalloc(sizeof(*request), GFP_KERNEL);\n\tif (!request)\n\t\treturn;\n\n\talpha2[0] = country_ie[0];\n\talpha2[1] = country_ie[1];\n\n\tif (country_ie[2] == 'I')\n\t\tenv = ENVIRON_INDOOR;\n\telse if (country_ie[2] == 'O')\n\t\tenv = ENVIRON_OUTDOOR;\n\n\trcu_read_lock();\n\tlr = get_last_request();\n\n\tif (unlikely(!lr))\n\t\tgoto out;\n\n\t/*\n\t * We will run this only upon a successful connection on cfg80211.\n\t * We leave conflict resolution to the workqueue, where can hold\n\t * the RTNL.\n\t */\n\tif (lr->initiator == NL80211_REGDOM_SET_BY_COUNTRY_IE &&\n\t    lr->wiphy_idx != WIPHY_IDX_INVALID)\n\t\tgoto out;\n\n\trequest->wiphy_idx = get_wiphy_idx(wiphy);\n\trequest->alpha2[0] = alpha2[0];\n\trequest->alpha2[1] = alpha2[1];\n\trequest->initiator = NL80211_REGDOM_SET_BY_COUNTRY_IE;\n\trequest->country_ie_env = env;\n\n\t/* Allow calling CRDA again */\n\treset_crda_timeouts();\n\n\tqueue_regulatory_request(request);\n\trequest = NULL;\nout:\n\tkfree(request);\n\trcu_read_unlock();\n}\n\nstatic void restore_alpha2(char *alpha2, bool reset_user)\n{\n\t/* indicates there is no alpha2 to consider for restoration */\n\talpha2[0] = '9';\n\talpha2[1] = '7';\n\n\t/* The user setting has precedence over the module parameter */\n\tif (is_user_regdom_saved()) {\n\t\t/* Unless we're asked to ignore it and reset it */\n\t\tif (reset_user) {\n\t\t\tpr_debug(\"Restoring regulatory settings including user preference\\n\");\n\t\t\tuser_alpha2[0] = '9';\n\t\t\tuser_alpha2[1] = '7';\n\n\t\t\t/*\n\t\t\t * If we're ignoring user settings, we still need to\n\t\t\t * check the module parameter to ensure we put things\n\t\t\t * back as they were for a full restore.\n\t\t\t */\n\t\t\tif (!is_world_regdom(ieee80211_regdom)) {\n\t\t\t\tpr_debug(\"Keeping preference on module parameter ieee80211_regdom: %c%c\\n\",\n\t\t\t\t\t ieee80211_regdom[0], ieee80211_regdom[1]);\n\t\t\t\talpha2[0] = ieee80211_regdom[0];\n\t\t\t\talpha2[1] = ieee80211_regdom[1];\n\t\t\t}\n\t\t} else {\n\t\t\tpr_debug(\"Restoring regulatory settings while preserving user preference for: %c%c\\n\",\n\t\t\t\t user_alpha2[0], user_alpha2[1]);\n\t\t\talpha2[0] = user_alpha2[0];\n\t\t\talpha2[1] = user_alpha2[1];\n\t\t}\n\t} else if (!is_world_regdom(ieee80211_regdom)) {\n\t\tpr_debug(\"Keeping preference on module parameter ieee80211_regdom: %c%c\\n\",\n\t\t\t ieee80211_regdom[0], ieee80211_regdom[1]);\n\t\talpha2[0] = ieee80211_regdom[0];\n\t\talpha2[1] = ieee80211_regdom[1];\n\t} else\n\t\tpr_debug(\"Restoring regulatory settings\\n\");\n}\n\nstatic void restore_custom_reg_settings(struct wiphy *wiphy)\n{\n\tstruct ieee80211_supported_band *sband;\n\tenum nl80211_band band;\n\tstruct ieee80211_channel *chan;\n\tint i;\n\n\tfor (band = 0; band < NUM_NL80211_BANDS; band++) {\n\t\tsband = wiphy->bands[band];\n\t\tif (!sband)\n\t\t\tcontinue;\n\t\tfor (i = 0; i < sband->n_channels; i++) {\n\t\t\tchan = &sband->channels[i];\n\t\t\tchan->flags = chan->orig_flags;\n\t\t\tchan->max_antenna_gain = chan->orig_mag;\n\t\t\tchan->max_power = chan->orig_mpwr;\n\t\t\tchan->beacon_found = false;\n\t\t}\n\t}\n}\n\n/*\n * Restoring regulatory settings involves ingoring any\n * possibly stale country IE information and user regulatory\n * settings if so desired, this includes any beacon hints\n * learned as we could have traveled outside to another country\n * after disconnection. To restore regulatory settings we do\n * exactly what we did at bootup:\n *\n *   - send a core regulatory hint\n *   - send a user regulatory hint if applicable\n *\n * Device drivers that send a regulatory hint for a specific country\n * keep their own regulatory domain on wiphy->regd so that does\n * not need to be remembered.\n */\nstatic void restore_regulatory_settings(bool reset_user, bool cached)\n{\n\tchar alpha2[2];\n\tchar world_alpha2[2];\n\tstruct reg_beacon *reg_beacon, *btmp;\n\tLIST_HEAD(tmp_reg_req_list);\n\tstruct cfg80211_registered_device *rdev;\n\n\tASSERT_RTNL();\n\n\t/*\n\t * Clear the indoor setting in case that it is not controlled by user\n\t * space, as otherwise there is no guarantee that the device is still\n\t * operating in an indoor environment.\n\t */\n\tspin_lock(&reg_indoor_lock);\n\tif (reg_is_indoor && !reg_is_indoor_portid) {\n\t\treg_is_indoor = false;\n\t\treg_check_channels();\n\t}\n\tspin_unlock(&reg_indoor_lock);\n\n\treset_regdomains(true, &world_regdom);\n\trestore_alpha2(alpha2, reset_user);\n\n\t/*\n\t * If there's any pending requests we simply\n\t * stash them to a temporary pending queue and\n\t * add then after we've restored regulatory\n\t * settings.\n\t */\n\tspin_lock(&reg_requests_lock);\n\tlist_splice_tail_init(&reg_requests_list, &tmp_reg_req_list);\n\tspin_unlock(&reg_requests_lock);\n\n\t/* Clear beacon hints */\n\tspin_lock_bh(&reg_pending_beacons_lock);\n\tlist_for_each_entry_safe(reg_beacon, btmp, &reg_pending_beacons, list) {\n\t\tlist_del(&reg_beacon->list);\n\t\tkfree(reg_beacon);\n\t}\n\tspin_unlock_bh(&reg_pending_beacons_lock);\n\n\tlist_for_each_entry_safe(reg_beacon, btmp, &reg_beacon_list, list) {\n\t\tlist_del(&reg_beacon->list);\n\t\tkfree(reg_beacon);\n\t}\n\n\t/* First restore to the basic regulatory settings */\n\tworld_alpha2[0] = cfg80211_world_regdom->alpha2[0];\n\tworld_alpha2[1] = cfg80211_world_regdom->alpha2[1];\n\n\tlist_for_each_entry(rdev, &cfg80211_rdev_list, list) {\n\t\tif (rdev->wiphy.regulatory_flags & REGULATORY_WIPHY_SELF_MANAGED)\n\t\t\tcontinue;\n\t\tif (rdev->wiphy.regulatory_flags & REGULATORY_CUSTOM_REG)\n\t\t\trestore_custom_reg_settings(&rdev->wiphy);\n\t}\n\n\tif (cached && (!is_an_alpha2(alpha2) ||\n\t\t       !IS_ERR_OR_NULL(cfg80211_user_regdom))) {\n\t\treset_regdomains(false, cfg80211_world_regdom);\n\t\tupdate_all_wiphy_regulatory(NL80211_REGDOM_SET_BY_CORE);\n\t\tprint_regdomain(get_cfg80211_regdom());\n\t\tnl80211_send_reg_change_event(&core_request_world);\n\t\treg_set_request_processed();\n\n\t\tif (is_an_alpha2(alpha2) &&\n\t\t    !regulatory_hint_user(alpha2, NL80211_USER_REG_HINT_USER)) {\n\t\t\tstruct regulatory_request *ureq;\n\n\t\t\tspin_lock(&reg_requests_lock);\n\t\t\tureq = list_last_entry(&reg_requests_list,\n\t\t\t\t\t       struct regulatory_request,\n\t\t\t\t\t       list);\n\t\t\tlist_del(&ureq->list);\n\t\t\tspin_unlock(&reg_requests_lock);\n\n\t\t\tnotify_self_managed_wiphys(ureq);\n\t\t\treg_update_last_request(ureq);\n\t\t\tset_regdom(reg_copy_regd(cfg80211_user_regdom),\n\t\t\t\t   REGD_SOURCE_CACHED);\n\t\t}\n\t} else {\n\t\tregulatory_hint_core(world_alpha2);\n\n\t\t/*\n\t\t * This restores the ieee80211_regdom module parameter\n\t\t * preference or the last user requested regulatory\n\t\t * settings, user regulatory settings takes precedence.\n\t\t */\n\t\tif (is_an_alpha2(alpha2))\n\t\t\tregulatory_hint_user(alpha2, NL80211_USER_REG_HINT_USER);\n\t}\n\n\tspin_lock(&reg_requests_lock);\n\tlist_splice_tail_init(&tmp_reg_req_list, &reg_requests_list);\n\tspin_unlock(&reg_requests_lock);\n\n\tpr_debug(\"Kicking the queue\\n\");\n\n\tschedule_work(&reg_work);\n}\n\nstatic bool is_wiphy_all_set_reg_flag(enum ieee80211_regulatory_flags flag)\n{\n\tstruct cfg80211_registered_device *rdev;\n\tstruct wireless_dev *wdev;\n\n\tlist_for_each_entry(rdev, &cfg80211_rdev_list, list) {\n\t\tlist_for_each_entry(wdev, &rdev->wiphy.wdev_list, list) {\n\t\t\twdev_lock(wdev);\n\t\t\tif (!(wdev->wiphy->regulatory_flags & flag)) {\n\t\t\t\twdev_unlock(wdev);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\twdev_unlock(wdev);\n\t\t}\n\t}\n\n\treturn true;\n}\n\nvoid regulatory_hint_disconnect(void)\n{\n\t/* Restore of regulatory settings is not required when wiphy(s)\n\t * ignore IE from connected access point but clearance of beacon hints\n\t * is required when wiphy(s) supports beacon hints.\n\t */\n\tif (is_wiphy_all_set_reg_flag(REGULATORY_COUNTRY_IE_IGNORE)) {\n\t\tstruct reg_beacon *reg_beacon, *btmp;\n\n\t\tif (is_wiphy_all_set_reg_flag(REGULATORY_DISABLE_BEACON_HINTS))\n\t\t\treturn;\n\n\t\tspin_lock_bh(&reg_pending_beacons_lock);\n\t\tlist_for_each_entry_safe(reg_beacon, btmp,\n\t\t\t\t\t &reg_pending_beacons, list) {\n\t\t\tlist_del(&reg_beacon->list);\n\t\t\tkfree(reg_beacon);\n\t\t}\n\t\tspin_unlock_bh(&reg_pending_beacons_lock);\n\n\t\tlist_for_each_entry_safe(reg_beacon, btmp,\n\t\t\t\t\t &reg_beacon_list, list) {\n\t\t\tlist_del(&reg_beacon->list);\n\t\t\tkfree(reg_beacon);\n\t\t}\n\n\t\treturn;\n\t}\n\n\tpr_debug(\"All devices are disconnected, going to restore regulatory settings\\n\");\n\trestore_regulatory_settings(false, true);\n}\n\nstatic bool freq_is_chan_12_13_14(u32 freq)\n{\n\tif (freq == ieee80211_channel_to_frequency(12, NL80211_BAND_2GHZ) ||\n\t    freq == ieee80211_channel_to_frequency(13, NL80211_BAND_2GHZ) ||\n\t    freq == ieee80211_channel_to_frequency(14, NL80211_BAND_2GHZ))\n\t\treturn true;\n\treturn false;\n}\n\nstatic bool pending_reg_beacon(struct ieee80211_channel *beacon_chan)\n{\n\tstruct reg_beacon *pending_beacon;\n\n\tlist_for_each_entry(pending_beacon, &reg_pending_beacons, list)\n\t\tif (ieee80211_channel_equal(beacon_chan,\n\t\t\t\t\t    &pending_beacon->chan))\n\t\t\treturn true;\n\treturn false;\n}\n\nint regulatory_hint_found_beacon(struct wiphy *wiphy,\n\t\t\t\t struct ieee80211_channel *beacon_chan,\n\t\t\t\t gfp_t gfp)\n{\n\tstruct reg_beacon *reg_beacon;\n\tbool processing;\n\n\tif (beacon_chan->beacon_found ||\n\t    beacon_chan->flags & IEEE80211_CHAN_RADAR ||\n\t    (beacon_chan->band == NL80211_BAND_2GHZ &&\n\t     !freq_is_chan_12_13_14(beacon_chan->center_freq)))\n\t\treturn 0;\n\n\tspin_lock_bh(&reg_pending_beacons_lock);\n\tprocessing = pending_reg_beacon(beacon_chan);\n\tspin_unlock_bh(&reg_pending_beacons_lock);\n\n\tif (processing)\n\t\treturn 0;\n\n\treg_beacon = kzalloc(sizeof(struct reg_beacon), gfp);\n\tif (!reg_beacon)\n\t\treturn -ENOMEM;\n\n\tpr_debug(\"Found new beacon on frequency: %d.%03d MHz (Ch %d) on %s\\n\",\n\t\t beacon_chan->center_freq, beacon_chan->freq_offset,\n\t\t ieee80211_freq_khz_to_channel(\n\t\t\t ieee80211_channel_to_khz(beacon_chan)),\n\t\t wiphy_name(wiphy));\n\n\tmemcpy(&reg_beacon->chan, beacon_chan,\n\t       sizeof(struct ieee80211_channel));\n\n\t/*\n\t * Since we can be called from BH or and non-BH context\n\t * we must use spin_lock_bh()\n\t */\n\tspin_lock_bh(&reg_pending_beacons_lock);\n\tlist_add_tail(&reg_beacon->list, &reg_pending_beacons);\n\tspin_unlock_bh(&reg_pending_beacons_lock);\n\n\tschedule_work(&reg_work);\n\n\treturn 0;\n}\n\nstatic void print_rd_rules(const struct ieee80211_regdomain *rd)\n{\n\tunsigned int i;\n\tconst struct ieee80211_reg_rule *reg_rule = NULL;\n\tconst struct ieee80211_freq_range *freq_range = NULL;\n\tconst struct ieee80211_power_rule *power_rule = NULL;\n\tchar bw[32], cac_time[32];\n\n\tpr_debug(\"  (start_freq - end_freq @ bandwidth), (max_antenna_gain, max_eirp), (dfs_cac_time)\\n\");\n\n\tfor (i = 0; i < rd->n_reg_rules; i++) {\n\t\treg_rule = &rd->reg_rules[i];\n\t\tfreq_range = &reg_rule->freq_range;\n\t\tpower_rule = &reg_rule->power_rule;\n\n\t\tif (reg_rule->flags & NL80211_RRF_AUTO_BW)\n\t\t\tsnprintf(bw, sizeof(bw), \"%d KHz, %u KHz AUTO\",\n\t\t\t\t freq_range->max_bandwidth_khz,\n\t\t\t\t reg_get_max_bandwidth(rd, reg_rule));\n\t\telse\n\t\t\tsnprintf(bw, sizeof(bw), \"%d KHz\",\n\t\t\t\t freq_range->max_bandwidth_khz);\n\n\t\tif (reg_rule->flags & NL80211_RRF_DFS)\n\t\t\tscnprintf(cac_time, sizeof(cac_time), \"%u s\",\n\t\t\t\t  reg_rule->dfs_cac_ms/1000);\n\t\telse\n\t\t\tscnprintf(cac_time, sizeof(cac_time), \"N/A\");\n\n\n\t\t/*\n\t\t * There may not be documentation for max antenna gain\n\t\t * in certain regions\n\t\t */\n\t\tif (power_rule->max_antenna_gain)\n\t\t\tpr_debug(\"  (%d KHz - %d KHz @ %s), (%d mBi, %d mBm), (%s)\\n\",\n\t\t\t\tfreq_range->start_freq_khz,\n\t\t\t\tfreq_range->end_freq_khz,\n\t\t\t\tbw,\n\t\t\t\tpower_rule->max_antenna_gain,\n\t\t\t\tpower_rule->max_eirp,\n\t\t\t\tcac_time);\n\t\telse\n\t\t\tpr_debug(\"  (%d KHz - %d KHz @ %s), (N/A, %d mBm), (%s)\\n\",\n\t\t\t\tfreq_range->start_freq_khz,\n\t\t\t\tfreq_range->end_freq_khz,\n\t\t\t\tbw,\n\t\t\t\tpower_rule->max_eirp,\n\t\t\t\tcac_time);\n\t}\n}\n\nbool reg_supported_dfs_region(enum nl80211_dfs_regions dfs_region)\n{\n\tswitch (dfs_region) {\n\tcase NL80211_DFS_UNSET:\n\tcase NL80211_DFS_FCC:\n\tcase NL80211_DFS_ETSI:\n\tcase NL80211_DFS_JP:\n\t\treturn true;\n\tdefault:\n\t\tpr_debug(\"Ignoring unknown DFS master region: %d\\n\", dfs_region);\n\t\treturn false;\n\t}\n}\n\nstatic void print_regdomain(const struct ieee80211_regdomain *rd)\n{\n\tstruct regulatory_request *lr = get_last_request();\n\n\tif (is_intersected_alpha2(rd->alpha2)) {\n\t\tif (lr->initiator == NL80211_REGDOM_SET_BY_COUNTRY_IE) {\n\t\t\tstruct cfg80211_registered_device *rdev;\n\t\t\trdev = cfg80211_rdev_by_wiphy_idx(lr->wiphy_idx);\n\t\t\tif (rdev) {\n\t\t\t\tpr_debug(\"Current regulatory domain updated by AP to: %c%c\\n\",\n\t\t\t\t\trdev->country_ie_alpha2[0],\n\t\t\t\t\trdev->country_ie_alpha2[1]);\n\t\t\t} else\n\t\t\t\tpr_debug(\"Current regulatory domain intersected:\\n\");\n\t\t} else\n\t\t\tpr_debug(\"Current regulatory domain intersected:\\n\");\n\t} else if (is_world_regdom(rd->alpha2)) {\n\t\tpr_debug(\"World regulatory domain updated:\\n\");\n\t} else {\n\t\tif (is_unknown_alpha2(rd->alpha2))\n\t\t\tpr_debug(\"Regulatory domain changed to driver built-in settings (unknown country)\\n\");\n\t\telse {\n\t\t\tif (reg_request_cell_base(lr))\n\t\t\t\tpr_debug(\"Regulatory domain changed to country: %c%c by Cell Station\\n\",\n\t\t\t\t\trd->alpha2[0], rd->alpha2[1]);\n\t\t\telse\n\t\t\t\tpr_debug(\"Regulatory domain changed to country: %c%c\\n\",\n\t\t\t\t\trd->alpha2[0], rd->alpha2[1]);\n\t\t}\n\t}\n\n\tpr_debug(\" DFS Master region: %s\", reg_dfs_region_str(rd->dfs_region));\n\tprint_rd_rules(rd);\n}\n\nstatic void print_regdomain_info(const struct ieee80211_regdomain *rd)\n{\n\tpr_debug(\"Regulatory domain: %c%c\\n\", rd->alpha2[0], rd->alpha2[1]);\n\tprint_rd_rules(rd);\n}\n\nstatic int reg_set_rd_core(const struct ieee80211_regdomain *rd)\n{\n\tif (!is_world_regdom(rd->alpha2))\n\t\treturn -EINVAL;\n\tupdate_world_regdomain(rd);\n\treturn 0;\n}\n\nstatic int reg_set_rd_user(const struct ieee80211_regdomain *rd,\n\t\t\t   struct regulatory_request *user_request)\n{\n\tconst struct ieee80211_regdomain *intersected_rd = NULL;\n\n\tif (!regdom_changes(rd->alpha2))\n\t\treturn -EALREADY;\n\n\tif (!is_valid_rd(rd)) {\n\t\tpr_err(\"Invalid regulatory domain detected: %c%c\\n\",\n\t\t       rd->alpha2[0], rd->alpha2[1]);\n\t\tprint_regdomain_info(rd);\n\t\treturn -EINVAL;\n\t}\n\n\tif (!user_request->intersect) {\n\t\treset_regdomains(false, rd);\n\t\treturn 0;\n\t}\n\n\tintersected_rd = regdom_intersect(rd, get_cfg80211_regdom());\n\tif (!intersected_rd)\n\t\treturn -EINVAL;\n\n\tkfree(rd);\n\trd = NULL;\n\treset_regdomains(false, intersected_rd);\n\n\treturn 0;\n}\n\nstatic int reg_set_rd_driver(const struct ieee80211_regdomain *rd,\n\t\t\t     struct regulatory_request *driver_request)\n{\n\tconst struct ieee80211_regdomain *regd;\n\tconst struct ieee80211_regdomain *intersected_rd = NULL;\n\tconst struct ieee80211_regdomain *tmp;\n\tstruct wiphy *request_wiphy;\n\n\tif (is_world_regdom(rd->alpha2))\n\t\treturn -EINVAL;\n\n\tif (!regdom_changes(rd->alpha2))\n\t\treturn -EALREADY;\n\n\tif (!is_valid_rd(rd)) {\n\t\tpr_err(\"Invalid regulatory domain detected: %c%c\\n\",\n\t\t       rd->alpha2[0], rd->alpha2[1]);\n\t\tprint_regdomain_info(rd);\n\t\treturn -EINVAL;\n\t}\n\n\trequest_wiphy = wiphy_idx_to_wiphy(driver_request->wiphy_idx);\n\tif (!request_wiphy)\n\t\treturn -ENODEV;\n\n\tif (!driver_request->intersect) {\n\t\tif (request_wiphy->regd)\n\t\t\treturn -EALREADY;\n\n\t\tregd = reg_copy_regd(rd);\n\t\tif (IS_ERR(regd))\n\t\t\treturn PTR_ERR(regd);\n\n\t\trcu_assign_pointer(request_wiphy->regd, regd);\n\t\treset_regdomains(false, rd);\n\t\treturn 0;\n\t}\n\n\tintersected_rd = regdom_intersect(rd, get_cfg80211_regdom());\n\tif (!intersected_rd)\n\t\treturn -EINVAL;\n\n\t/*\n\t * We can trash what CRDA provided now.\n\t * However if a driver requested this specific regulatory\n\t * domain we keep it for its private use\n\t */\n\ttmp = get_wiphy_regdom(request_wiphy);\n\trcu_assign_pointer(request_wiphy->regd, rd);\n\trcu_free_regdom(tmp);\n\n\trd = NULL;\n\n\treset_regdomains(false, intersected_rd);\n\n\treturn 0;\n}\n\nstatic int reg_set_rd_country_ie(const struct ieee80211_regdomain *rd,\n\t\t\t\t struct regulatory_request *country_ie_request)\n{\n\tstruct wiphy *request_wiphy;\n\n\tif (!is_alpha2_set(rd->alpha2) && !is_an_alpha2(rd->alpha2) &&\n\t    !is_unknown_alpha2(rd->alpha2))\n\t\treturn -EINVAL;\n\n\t/*\n\t * Lets only bother proceeding on the same alpha2 if the current\n\t * rd is non static (it means CRDA was present and was used last)\n\t * and the pending request came in from a country IE\n\t */\n\n\tif (!is_valid_rd(rd)) {\n\t\tpr_err(\"Invalid regulatory domain detected: %c%c\\n\",\n\t\t       rd->alpha2[0], rd->alpha2[1]);\n\t\tprint_regdomain_info(rd);\n\t\treturn -EINVAL;\n\t}\n\n\trequest_wiphy = wiphy_idx_to_wiphy(country_ie_request->wiphy_idx);\n\tif (!request_wiphy)\n\t\treturn -ENODEV;\n\n\tif (country_ie_request->intersect)\n\t\treturn -EINVAL;\n\n\treset_regdomains(false, rd);\n\treturn 0;\n}\n\n/*\n * Use this call to set the current regulatory domain. Conflicts with\n * multiple drivers can be ironed out later. Caller must've already\n * kmalloc'd the rd structure.\n */\nint set_regdom(const struct ieee80211_regdomain *rd,\n\t       enum ieee80211_regd_source regd_src)\n{\n\tstruct regulatory_request *lr;\n\tbool user_reset = false;\n\tint r;\n\n\tif (IS_ERR_OR_NULL(rd))\n\t\treturn -ENODATA;\n\n\tif (!reg_is_valid_request(rd->alpha2)) {\n\t\tkfree(rd);\n\t\treturn -EINVAL;\n\t}\n\n\tif (regd_src == REGD_SOURCE_CRDA)\n\t\treset_crda_timeouts();\n\n\tlr = get_last_request();\n\n\t/* Note that this doesn't update the wiphys, this is done below */\n\tswitch (lr->initiator) {\n\tcase NL80211_REGDOM_SET_BY_CORE:\n\t\tr = reg_set_rd_core(rd);\n\t\tbreak;\n\tcase NL80211_REGDOM_SET_BY_USER:\n\t\tcfg80211_save_user_regdom(rd);\n\t\tr = reg_set_rd_user(rd, lr);\n\t\tuser_reset = true;\n\t\tbreak;\n\tcase NL80211_REGDOM_SET_BY_DRIVER:\n\t\tr = reg_set_rd_driver(rd, lr);\n\t\tbreak;\n\tcase NL80211_REGDOM_SET_BY_COUNTRY_IE:\n\t\tr = reg_set_rd_country_ie(rd, lr);\n\t\tbreak;\n\tdefault:\n\t\tWARN(1, \"invalid initiator %d\\n\", lr->initiator);\n\t\tkfree(rd);\n\t\treturn -EINVAL;\n\t}\n\n\tif (r) {\n\t\tswitch (r) {\n\t\tcase -EALREADY:\n\t\t\treg_set_request_processed();\n\t\t\tbreak;\n\t\tdefault:\n\t\t\t/* Back to world regulatory in case of errors */\n\t\t\trestore_regulatory_settings(user_reset, false);\n\t\t}\n\n\t\tkfree(rd);\n\t\treturn r;\n\t}\n\n\t/* This would make this whole thing pointless */\n\tif (WARN_ON(!lr->intersect && rd != get_cfg80211_regdom()))\n\t\treturn -EINVAL;\n\n\t/* update all wiphys now with the new established regulatory domain */\n\tupdate_all_wiphy_regulatory(lr->initiator);\n\n\tprint_regdomain(get_cfg80211_regdom());\n\n\tnl80211_send_reg_change_event(lr);\n\n\treg_set_request_processed();\n\n\treturn 0;\n}\n\nstatic int __regulatory_set_wiphy_regd(struct wiphy *wiphy,\n\t\t\t\t       struct ieee80211_regdomain *rd)\n{\n\tconst struct ieee80211_regdomain *regd;\n\tconst struct ieee80211_regdomain *prev_regd;\n\tstruct cfg80211_registered_device *rdev;\n\n\tif (WARN_ON(!wiphy || !rd))\n\t\treturn -EINVAL;\n\n\tif (WARN(!(wiphy->regulatory_flags & REGULATORY_WIPHY_SELF_MANAGED),\n\t\t \"wiphy should have REGULATORY_WIPHY_SELF_MANAGED\\n\"))\n\t\treturn -EPERM;\n\n\tif (WARN(!is_valid_rd(rd), \"Invalid regulatory domain detected\\n\")) {\n\t\tprint_regdomain_info(rd);\n\t\treturn -EINVAL;\n\t}\n\n\tregd = reg_copy_regd(rd);\n\tif (IS_ERR(regd))\n\t\treturn PTR_ERR(regd);\n\n\trdev = wiphy_to_rdev(wiphy);\n\n\tspin_lock(&reg_requests_lock);\n\tprev_regd = rdev->requested_regd;\n\trdev->requested_regd = regd;\n\tspin_unlock(&reg_requests_lock);\n\n\tkfree(prev_regd);\n\treturn 0;\n}\n\nint regulatory_set_wiphy_regd(struct wiphy *wiphy,\n\t\t\t      struct ieee80211_regdomain *rd)\n{\n\tint ret = __regulatory_set_wiphy_regd(wiphy, rd);\n\n\tif (ret)\n\t\treturn ret;\n\n\tschedule_work(&reg_work);\n\treturn 0;\n}\nEXPORT_SYMBOL(regulatory_set_wiphy_regd);\n\nint regulatory_set_wiphy_regd_sync_rtnl(struct wiphy *wiphy,\n\t\t\t\t\tstruct ieee80211_regdomain *rd)\n{\n\tint ret;\n\n\tASSERT_RTNL();\n\n\tret = __regulatory_set_wiphy_regd(wiphy, rd);\n\tif (ret)\n\t\treturn ret;\n\n\t/* process the request immediately */\n\treg_process_self_managed_hints();\n\treturn 0;\n}\nEXPORT_SYMBOL(regulatory_set_wiphy_regd_sync_rtnl);\n\nvoid wiphy_regulatory_register(struct wiphy *wiphy)\n{\n\tstruct regulatory_request *lr = get_last_request();\n\n\t/* self-managed devices ignore beacon hints and country IE */\n\tif (wiphy->regulatory_flags & REGULATORY_WIPHY_SELF_MANAGED) {\n\t\twiphy->regulatory_flags |= REGULATORY_DISABLE_BEACON_HINTS |\n\t\t\t\t\t   REGULATORY_COUNTRY_IE_IGNORE;\n\n\t\t/*\n\t\t * The last request may have been received before this\n\t\t * registration call. Call the driver notifier if\n\t\t * initiator is USER.\n\t\t */\n\t\tif (lr->initiator == NL80211_REGDOM_SET_BY_USER)\n\t\t\treg_call_notifier(wiphy, lr);\n\t}\n\n\tif (!reg_dev_ignore_cell_hint(wiphy))\n\t\treg_num_devs_support_basehint++;\n\n\twiphy_update_regulatory(wiphy, lr->initiator);\n\twiphy_all_share_dfs_chan_state(wiphy);\n}\n\nvoid wiphy_regulatory_deregister(struct wiphy *wiphy)\n{\n\tstruct wiphy *request_wiphy = NULL;\n\tstruct regulatory_request *lr;\n\n\tlr = get_last_request();\n\n\tif (!reg_dev_ignore_cell_hint(wiphy))\n\t\treg_num_devs_support_basehint--;\n\n\trcu_free_regdom(get_wiphy_regdom(wiphy));\n\tRCU_INIT_POINTER(wiphy->regd, NULL);\n\n\tif (lr)\n\t\trequest_wiphy = wiphy_idx_to_wiphy(lr->wiphy_idx);\n\n\tif (!request_wiphy || request_wiphy != wiphy)\n\t\treturn;\n\n\tlr->wiphy_idx = WIPHY_IDX_INVALID;\n\tlr->country_ie_env = ENVIRON_ANY;\n}\n\n/*\n * See FCC notices for UNII band definitions\n *  5GHz: https://www.fcc.gov/document/5-ghz-unlicensed-spectrum-unii\n *  6GHz: https://www.fcc.gov/document/fcc-proposes-more-spectrum-unlicensed-use-0\n */\nint cfg80211_get_unii(int freq)\n{\n\t/* UNII-1 */\n\tif (freq >= 5150 && freq <= 5250)\n\t\treturn 0;\n\n\t/* UNII-2A */\n\tif (freq > 5250 && freq <= 5350)\n\t\treturn 1;\n\n\t/* UNII-2B */\n\tif (freq > 5350 && freq <= 5470)\n\t\treturn 2;\n\n\t/* UNII-2C */\n\tif (freq > 5470 && freq <= 5725)\n\t\treturn 3;\n\n\t/* UNII-3 */\n\tif (freq > 5725 && freq <= 5825)\n\t\treturn 4;\n\n\t/* UNII-5 */\n\tif (freq > 5925 && freq <= 6425)\n\t\treturn 5;\n\n\t/* UNII-6 */\n\tif (freq > 6425 && freq <= 6525)\n\t\treturn 6;\n\n\t/* UNII-7 */\n\tif (freq > 6525 && freq <= 6875)\n\t\treturn 7;\n\n\t/* UNII-8 */\n\tif (freq > 6875 && freq <= 7125)\n\t\treturn 8;\n\n\treturn -EINVAL;\n}\n\nbool regulatory_indoor_allowed(void)\n{\n\treturn reg_is_indoor;\n}\n\nbool regulatory_pre_cac_allowed(struct wiphy *wiphy)\n{\n\tconst struct ieee80211_regdomain *regd = NULL;\n\tconst struct ieee80211_regdomain *wiphy_regd = NULL;\n\tbool pre_cac_allowed = false;\n\n\trcu_read_lock();\n\n\tregd = rcu_dereference(cfg80211_regdomain);\n\twiphy_regd = rcu_dereference(wiphy->regd);\n\tif (!wiphy_regd) {\n\t\tif (regd->dfs_region == NL80211_DFS_ETSI)\n\t\t\tpre_cac_allowed = true;\n\n\t\trcu_read_unlock();\n\n\t\treturn pre_cac_allowed;\n\t}\n\n\tif (regd->dfs_region == wiphy_regd->dfs_region &&\n\t    wiphy_regd->dfs_region == NL80211_DFS_ETSI)\n\t\tpre_cac_allowed = true;\n\n\trcu_read_unlock();\n\n\treturn pre_cac_allowed;\n}\nEXPORT_SYMBOL(regulatory_pre_cac_allowed);\n\nstatic void cfg80211_check_and_end_cac(struct cfg80211_registered_device *rdev)\n{\n\tstruct wireless_dev *wdev;\n\t/* If we finished CAC or received radar, we should end any\n\t * CAC running on the same channels.\n\t * the check !cfg80211_chandef_dfs_usable contain 2 options:\n\t * either all channels are available - those the CAC_FINISHED\n\t * event has effected another wdev state, or there is a channel\n\t * in unavailable state in wdev chandef - those the RADAR_DETECTED\n\t * event has effected another wdev state.\n\t * In both cases we should end the CAC on the wdev.\n\t */\n\tlist_for_each_entry(wdev, &rdev->wiphy.wdev_list, list) {\n\t\tif (wdev->cac_started &&\n\t\t    !cfg80211_chandef_dfs_usable(&rdev->wiphy, &wdev->chandef))\n\t\t\trdev_end_cac(rdev, wdev->netdev);\n\t}\n}\n\nvoid regulatory_propagate_dfs_state(struct wiphy *wiphy,\n\t\t\t\t    struct cfg80211_chan_def *chandef,\n\t\t\t\t    enum nl80211_dfs_state dfs_state,\n\t\t\t\t    enum nl80211_radar_event event)\n{\n\tstruct cfg80211_registered_device *rdev;\n\n\tASSERT_RTNL();\n\n\tif (WARN_ON(!cfg80211_chandef_valid(chandef)))\n\t\treturn;\n\n\tlist_for_each_entry(rdev, &cfg80211_rdev_list, list) {\n\t\tif (wiphy == &rdev->wiphy)\n\t\t\tcontinue;\n\n\t\tif (!reg_dfs_domain_same(wiphy, &rdev->wiphy))\n\t\t\tcontinue;\n\n\t\tif (!ieee80211_get_channel(&rdev->wiphy,\n\t\t\t\t\t   chandef->chan->center_freq))\n\t\t\tcontinue;\n\n\t\tcfg80211_set_dfs_state(&rdev->wiphy, chandef, dfs_state);\n\n\t\tif (event == NL80211_RADAR_DETECTED ||\n\t\t    event == NL80211_RADAR_CAC_FINISHED) {\n\t\t\tcfg80211_sched_dfs_chan_update(rdev);\n\t\t\tcfg80211_check_and_end_cac(rdev);\n\t\t}\n\n\t\tnl80211_radar_notify(rdev, chandef, event, NULL, GFP_KERNEL);\n\t}\n}\n\nstatic int __init regulatory_init_db(void)\n{\n\tint err;\n\n\t/*\n\t * It's possible that - due to other bugs/issues - cfg80211\n\t * never called regulatory_init() below, or that it failed;\n\t * in that case, don't try to do any further work here as\n\t * it's doomed to lead to crashes.\n\t */\n\tif (IS_ERR_OR_NULL(reg_pdev))\n\t\treturn -EINVAL;\n\n\terr = load_builtin_regdb_keys();\n\tif (err)\n\t\treturn err;\n\n\t/* We always try to get an update for the static regdomain */\n\terr = regulatory_hint_core(cfg80211_world_regdom->alpha2);\n\tif (err) {\n\t\tif (err == -ENOMEM) {\n\t\t\tplatform_device_unregister(reg_pdev);\n\t\t\treturn err;\n\t\t}\n\t\t/*\n\t\t * N.B. kobject_uevent_env() can fail mainly for when we're out\n\t\t * memory which is handled and propagated appropriately above\n\t\t * but it can also fail during a netlink_broadcast() or during\n\t\t * early boot for call_usermodehelper(). For now treat these\n\t\t * errors as non-fatal.\n\t\t */\n\t\tpr_err(\"kobject_uevent_env() was unable to call CRDA during init\\n\");\n\t}\n\n\t/*\n\t * Finally, if the user set the module parameter treat it\n\t * as a user hint.\n\t */\n\tif (!is_world_regdom(ieee80211_regdom))\n\t\tregulatory_hint_user(ieee80211_regdom,\n\t\t\t\t     NL80211_USER_REG_HINT_USER);\n\n\treturn 0;\n}\n#ifndef MODULE\nlate_initcall(regulatory_init_db);\n#endif\n\nint __init regulatory_init(void)\n{\n\treg_pdev = platform_device_register_simple(\"regulatory\", 0, NULL, 0);\n\tif (IS_ERR(reg_pdev))\n\t\treturn PTR_ERR(reg_pdev);\n\n\tspin_lock_init(&reg_requests_lock);\n\tspin_lock_init(&reg_pending_beacons_lock);\n\tspin_lock_init(&reg_indoor_lock);\n\n\trcu_assign_pointer(cfg80211_regdomain, cfg80211_world_regdom);\n\n\tuser_alpha2[0] = '9';\n\tuser_alpha2[1] = '7';\n\n#ifdef MODULE\n\treturn regulatory_init_db();\n#else\n\treturn 0;\n#endif\n}\n\nvoid regulatory_exit(void)\n{\n\tstruct regulatory_request *reg_request, *tmp;\n\tstruct reg_beacon *reg_beacon, *btmp;\n\n\tcancel_work_sync(&reg_work);\n\tcancel_crda_timeout_sync();\n\tcancel_delayed_work_sync(&reg_check_chans);\n\n\t/* Lock to suppress warnings */\n\trtnl_lock();\n\treset_regdomains(true, NULL);\n\trtnl_unlock();\n\n\tdev_set_uevent_suppress(&reg_pdev->dev, true);\n\n\tplatform_device_unregister(reg_pdev);\n\n\tlist_for_each_entry_safe(reg_beacon, btmp, &reg_pending_beacons, list) {\n\t\tlist_del(&reg_beacon->list);\n\t\tkfree(reg_beacon);\n\t}\n\n\tlist_for_each_entry_safe(reg_beacon, btmp, &reg_beacon_list, list) {\n\t\tlist_del(&reg_beacon->list);\n\t\tkfree(reg_beacon);\n\t}\n\n\tlist_for_each_entry_safe(reg_request, tmp, &reg_requests_list, list) {\n\t\tlist_del(&reg_request->list);\n\t\tkfree(reg_request);\n\t}\n\n\tif (!IS_ERR_OR_NULL(regdb))\n\t\tkfree(regdb);\n\tif (!IS_ERR_OR_NULL(cfg80211_user_regdom))\n\t\tkfree(cfg80211_user_regdom);\n\n\tfree_regdb_keyring();\n}\n"}}, "reports": [{"events": [{"location": {"col": 2, "file": 0, "line": 1620}, "message": "'reg_rule' declared without an initial value"}, {"location": {"col": 32, "file": 0, "line": 1624}, "message": "Assuming 'bw' is < 'min_bw'"}, {"location": {"col": 2, "file": 0, "line": 1624}, "message": "Loop condition is false. Execution continues on line 1630"}, {"location": {"col": 2, "file": 0, "line": 1630}, "message": "Undefined or garbage value returned to caller"}, {"location": {"col": 2, "file": 0, "line": 1630}, "message": "Undefined or garbage value returned to caller"}], "macros": [], "notes": [], "path": "/src/net/wireless/reg.c", "reportHash": "9a534fd681b76a1b6e0843e4681d0371", "checkerName": "clang-analyzer-core.uninitialized.UndefReturn", "reviewStatus": null, "severity": "UNSPECIFIED"}]};
      window.onload = function() {
        if (!browserCompatible) {
          setNonCompatibleBrowserMessage();
        } else {
          BugViewer.init(data.files, data.reports);
          BugViewer.create();
          BugViewer.initByUrl();
        }
      };
    </script>
  </head>
  <body>
  <div class="container">
    <div id="content">
      <div id="side-bar">
        <div class="header">
          <a href="index.html" class="button">&#8249; Return to List</a>
        </div>
        <div id="report-nav">
          <div class="header">Reports</div>
        </div>
      </div>
      <div id="editor-wrapper">
        <div class="header">
          <div id="file">
            <span class="label">File:</span>
            <span id="file-path"></span>
          </div>
          <div id="checker">
            <span class="label">Checker name:</span>
            <span id="checker-name"></span>
          </div>
          <div id="review-status-wrapper">
            <span class="label">Review status:</span>
            <span id="review-status"></span>
          </div>
        </div>
        <div id="editor"></div>
      </div>
    </div>
  </div>
  </body>
</html>
