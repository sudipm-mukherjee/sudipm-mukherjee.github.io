<!DOCTYPE html>
<html>
  <head>
    <title>Plist HTML Viewer</title>

    <meta charset="UTF-8">

    <style type="text/css">
      .CodeMirror{font-family:monospace;height:300px;color:#000;direction:ltr}.CodeMirror-lines{padding:4px 0}.CodeMirror pre{padding:0 4px}.CodeMirror-gutter-filler,.CodeMirror-scrollbar-filler{background-color:#fff}.CodeMirror-gutters{border-right:1px solid #ddd;background-color:#f7f7f7;white-space:nowrap}.CodeMirror-linenumber{padding:0 3px 0 5px;min-width:20px;text-align:right;color:#999;white-space:nowrap}.CodeMirror-guttermarker{color:#000}.CodeMirror-guttermarker-subtle{color:#999}.CodeMirror-cursor{border-left:1px solid #000;border-right:none;width:0}.CodeMirror div.CodeMirror-secondarycursor{border-left:1px solid silver}.cm-fat-cursor .CodeMirror-cursor{width:auto;border:0!important;background:#7e7}.cm-fat-cursor div.CodeMirror-cursors{z-index:1}.cm-animate-fat-cursor{width:auto;border:0;-webkit-animation:blink 1.06s steps(1) infinite;-moz-animation:blink 1.06s steps(1) infinite;animation:blink 1.06s steps(1) infinite;background-color:#7e7}@-moz-keyframes blink{50%{background-color:transparent}}@-webkit-keyframes blink{50%{background-color:transparent}}@keyframes blink{50%{background-color:transparent}}.cm-tab{display:inline-block;text-decoration:inherit}.CodeMirror-rulers{position:absolute;left:0;right:0;top:-50px;bottom:-20px;overflow:hidden}.CodeMirror-ruler{border-left:1px solid #ccc;top:0;bottom:0;position:absolute}.cm-s-default .cm-header{color:#00f}.cm-s-default .cm-quote{color:#090}.cm-negative{color:#d44}.cm-positive{color:#292}.cm-header,.cm-strong{font-weight:700}.cm-em{font-style:italic}.cm-link{text-decoration:underline}.cm-strikethrough{text-decoration:line-through}.cm-s-default .cm-keyword{color:#708}.cm-s-default .cm-atom{color:#219}.cm-s-default .cm-number{color:#164}.cm-s-default .cm-def{color:#00f}.cm-s-default .cm-variable-2{color:#05a}.cm-s-default .cm-type,.cm-s-default .cm-variable-3{color:#085}.cm-s-default .cm-comment{color:#a50}.cm-s-default .cm-string{color:#a11}.cm-s-default .cm-string-2{color:#f50}.cm-s-default .cm-meta{color:#555}.cm-s-default .cm-qualifier{color:#555}.cm-s-default .cm-builtin{color:#30a}.cm-s-default .cm-bracket{color:#997}.cm-s-default .cm-tag{color:#170}.cm-s-default .cm-attribute{color:#00c}.cm-s-default .cm-hr{color:#999}.cm-s-default .cm-link{color:#00c}.cm-s-default .cm-error{color:red}.cm-invalidchar{color:red}.CodeMirror-composing{border-bottom:2px solid}div.CodeMirror span.CodeMirror-matchingbracket{color:#0f0}div.CodeMirror span.CodeMirror-nonmatchingbracket{color:#f22}.CodeMirror-matchingtag{background:rgba(255,150,0,.3)}.CodeMirror-activeline-background{background:#e8f2ff}.CodeMirror{position:relative;overflow:hidden;background:#fff}.CodeMirror-scroll{overflow:scroll!important;margin-bottom:-30px;margin-right:-30px;padding-bottom:30px;height:100%;outline:0;position:relative}.CodeMirror-sizer{position:relative;border-right:30px solid transparent}.CodeMirror-gutter-filler,.CodeMirror-hscrollbar,.CodeMirror-scrollbar-filler,.CodeMirror-vscrollbar{position:absolute;z-index:6;display:none}.CodeMirror-vscrollbar{right:0;top:0;overflow-x:hidden;overflow-y:scroll}.CodeMirror-hscrollbar{bottom:0;left:0;overflow-y:hidden;overflow-x:scroll}.CodeMirror-scrollbar-filler{right:0;bottom:0}.CodeMirror-gutter-filler{left:0;bottom:0}.CodeMirror-gutters{position:absolute;left:0;top:0;min-height:100%;z-index:3}.CodeMirror-gutter{white-space:normal;height:100%;display:inline-block;vertical-align:top;margin-bottom:-30px}.CodeMirror-gutter-wrapper{position:absolute;z-index:4;background:0 0!important;border:none!important}.CodeMirror-gutter-background{position:absolute;top:0;bottom:0;z-index:4}.CodeMirror-gutter-elt{position:absolute;cursor:default;z-index:4}.CodeMirror-gutter-wrapper ::selection{background-color:transparent}.CodeMirror-gutter-wrapper ::-moz-selection{background-color:transparent}.CodeMirror-lines{cursor:text;min-height:1px}.CodeMirror pre{-moz-border-radius:0;-webkit-border-radius:0;border-radius:0;border-width:0;background:0 0;font-family:inherit;font-size:inherit;margin:0;white-space:pre;word-wrap:normal;line-height:inherit;color:inherit;z-index:2;position:relative;overflow:visible;-webkit-tap-highlight-color:transparent;-webkit-font-variant-ligatures:contextual;font-variant-ligatures:contextual}.CodeMirror-wrap pre{word-wrap:break-word;white-space:pre-wrap;word-break:normal}.CodeMirror-linebackground{position:absolute;left:0;right:0;top:0;bottom:0;z-index:0}.CodeMirror-linewidget{position:relative;z-index:2;overflow:auto}.CodeMirror-rtl pre{direction:rtl}.CodeMirror-code{outline:0}.CodeMirror-gutter,.CodeMirror-gutters,.CodeMirror-linenumber,.CodeMirror-scroll,.CodeMirror-sizer{-moz-box-sizing:content-box;box-sizing:content-box}.CodeMirror-measure{position:absolute;width:100%;height:0;overflow:hidden;visibility:hidden}.CodeMirror-cursor{position:absolute;pointer-events:none}.CodeMirror-measure pre{position:static}div.CodeMirror-cursors{visibility:hidden;position:relative;z-index:3}div.CodeMirror-dragcursors{visibility:visible}.CodeMirror-focused div.CodeMirror-cursors{visibility:visible}.CodeMirror-selected{background:#d9d9d9}.CodeMirror-focused .CodeMirror-selected{background:#d7d4f0}.CodeMirror-crosshair{cursor:crosshair}.CodeMirror-line::selection,.CodeMirror-line>span::selection,.CodeMirror-line>span>span::selection{background:#d7d4f0}.CodeMirror-line::-moz-selection,.CodeMirror-line>span::-moz-selection,.CodeMirror-line>span>span::-moz-selection{background:#d7d4f0}.cm-searching{background-color:#ffa;background-color:rgba(255,255,0,.4)}.cm-force-border{padding-right:.1px}@media print{.CodeMirror div.CodeMirror-cursors{visibility:hidden}}.cm-tab-wrap-hack:after{content:''}span.CodeMirror-selectedtext{background:0 0}
/*# sourceMappingURL=codemirror.min.css.map */

      .severity-low {
  background-color: #669603;
}

.severity-low:after {
  content : 'L';
}

.severity-unspecified {
  background-color: #666666;
}

.severity-unspecified:after {
  content : 'U';
}

.severity-style {
  background-color: #9932cc;
}

.severity-style:after {
  content : 'S';
}

.severity-medium {
  background-color: #a9d323;
  color: black;
}

.severity-medium:after {
  content : 'M';
}

.severity-high {
  background-color: #ffa800;
}

.severity-high:after {
  content : 'H';
}

.severity-critical {
  background-color: #e92625;
}

.severity-critical:after {
  content : 'C';
}

i[class*="severity-"] {
  line-height: normal;
  text-transform: capitalize;
  font-size: 0.8em;
  font-weight: bold;
  color: white;
  display: inline-block;
  width: 16px;
  height: 16px;
  text-align: center;
  font-family: sans-serif;
}

      html, body {
  width: 100%;
  height: 100%;
  padding: 0px;
  margin: 0px;
}

div.container {
  padding: 10px;
}

#content {
  height: 100%;
  display: block;
  overflow: hidden;
}

#content > div {
  margin: 10px;
  overflow: hidden;
  border: 1px solid #ddd;
  border-radius: 3px;
  overflow: hidden;
  height: 97%;
}

.button {
  background-color: #f1f1f1;
  text-decoration: none;
  display: inline-block;
  padding: 8px 16px;
  color: black;
  cursor: pointer;
}

.button:hover {
  background-color: #ddd;
  color: black;
}

.review-status {
  color: white;
  text-align: center;
}

.review-status-confirmed {
  background-color: #e92625;
}

.review-status-false-positive {
  background-color: grey;
}

.review-status-intentional {
  background-color: #669603;
}

      div.container {
  width: 100%;
  height: 100%;
  padding: 0px;
}

#editor-wrapper {
  margin: 10px;
}

#side-bar {
  float: left;
  width: 260px;
  margin: 0px;
}

#report-nav ul {
  list-style-type: none;
  padding: 0;
  margin: 0;
  overflow-y: auto;
  height: 100%;
}

#report-nav ul > li {
  padding: .4em;
  background-color: #fff;
  border-bottom: 1px solid rgba(0,0,0,.125);
  text-align: left;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

#report-nav ul > li.active {
  background-color: #427ea9;
  color: white;
}

#report-nav ul > li:hover {
  background-color: #427ea9;
  color: white;
  cursor: pointer;
}

#report-nav ul a {
  text-decoration: none;
}

#report-nav i[class*="severity-"] {
  margin-right: 5px;
}

.header {
  border-bottom: 1px solid lightgrey;
  font-family: monospace;
  padding: 10px;
  background-color: #fafbfc;
  border-bottom: 1px solid #e1e4e8;
  border-top-left-radius: 2px;
  border-top-right-radius: 2px;
}

#report-nav .header {
  font-weight: bold;
}

#editor-wrapper .header > div {
  padding-top: 2px;
}

#file-path,
#checker-name {
  color: #195ea2;
}

#review-status {
  padding: 0px 5px;
}

#file-path {
  font-family: monospace;
}

.check-msg {
  display: inline-block;
  padding: 3px 6px;
  margin: 1px;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
  border-radius: 5px;
}

.check-msg.info {
  color: #00546f;
  background-color: #bfdfe9;
  border: 1px solid #87a8b3;
}

.check-msg.error {
  background-color: #f2dede;
  color: #a94442;
  border: 1px solid #ebcccc;
}

.check-msg.macro {
  background-color: #d7dac2;
  color: #4f5c6d;
  border: 1px solid #d7dac2;
}

.check-msg.note {
  background-color: #d7d7d7;
  color: #4f5c6d;
  border: 1px solid #bfbfbf;
}

.check-msg.current {
  border: 2px dashed #3692ff;
}

.check-msg .tag {
  padding: 1px 5px;
  text-align: center;
  border-radius: 2px;
  margin-right: 5px;
  text-decoration: inherit;
}

.check-msg .tag.macro {
  background-color: #83876a;
  color: white;
  text-transform: capitalize;
}

.check-msg .tag.note {
  background-color: #9299a1;
  color: white;
  text-transform: capitalize;
}

.checker-enum {
  color: white;
  padding: 1px 5px;
  text-align: center;
  border-radius: 25px;
  margin-right: 5px;
  text-decoration: inherit;
}

.checker-enum.info {
  background-color: #427ea9;
}

.checker-enum.error {
  background-color: #a94442;
}

.arrow {
  border: solid black;
  border-width: 0 3px 3px 0;
  display: inline-block;
  padding: 3px;
  cursor: pointer;
  margin: 0px 5px;
}

.arrow:hover {
  border: solid #437ea8;
  border-width: 0 3px 3px 0;
}

.left-arrow {
  transform: rotate(135deg);
  -webkit-transform: rotate(135deg);
}

.right-arrow {
  transform: rotate(-45deg);
  -webkit-transform: rotate(-45deg);
}

    </style>

    <script type="text/javascript">
      function setNonCompatibleBrowserMessage() {
  document.body.innerHTML =
    '<h2 style="margin-left: 20px;">Your browser is not compatible with CodeChecker Viewer!</h2> \
     <p style="margin-left: 20px;">The version required for the following browsers are:</p> \
     <ul style="margin-left: 20px;"> \
     <li>Internet Explorer: version 9 or newer</li> \
     <li>Firefox: version 22.0 or newer</li> \
     </ul>';
}

// http://stackoverflow.com/questions/5916900/how-can-you-detect-the-version-of-a-browser
var browserVersion = (function(){
  var ua = navigator.userAgent, tem,
    M = ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];

  if (/trident/i.test(M[1])) {
    tem = /\brv[ :]+(\d+)/g.exec(ua) || [];
    return 'IE ' + (tem[1] || '');
  }

  if (M[1] === 'Chrome') {
    tem = ua.match(/\b(OPR|Edge)\/(\d+)/);
    if (tem != null) return tem.slice(1).join(' ').replace('OPR', 'Opera');
  }

  M = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, '-?'];
  if ((tem = ua.match(/version\/(\d+)/i)) != null) M.splice(1, 1, tem[1]);
    return M.join(' ');
})();

var pos = browserVersion.indexOf(' ');
var browser = browserVersion.substr(0, pos);
var version = parseInt(browserVersion.substr(pos + 1));

var browserCompatible
  = browser === 'Firefox'
  ? version >= 22
  : browser === 'IE'
  ? version >= 9
  : true;


      /* MIT License

Copyright (C) 2017 by Marijn Haverbeke <marijnh@gmail.com> and others

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
 */
      !function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.CodeMirror=t()}(this,function(){"use strict";function e(e){return new RegExp("(^|\\s)"+e+"(?:$|\\s)\\s*")}function t(e){for(var t=e.childNodes.length;t>0;--t)e.removeChild(e.firstChild);return e}function r(e,r){return t(e).appendChild(r)}function n(e,t,r,n){var i=document.createElement(e);if(r&&(i.className=r),n&&(i.style.cssText=n),"string"==typeof t)i.appendChild(document.createTextNode(t));else if(t)for(var o=0;o<t.length;++o)i.appendChild(t[o]);return i}function i(e,t,r,i){var o=n(e,t,r,i);return o.setAttribute("role","presentation"),o}function o(e,t){if(3==t.nodeType&&(t=t.parentNode),e.contains)return e.contains(t);do{if(11==t.nodeType&&(t=t.host),t==e)return!0}while(t=t.parentNode)}function l(){var e;try{e=document.activeElement}catch(t){e=document.body||null}for(;e&&e.shadowRoot&&e.shadowRoot.activeElement;)e=e.shadowRoot.activeElement;return e}function s(t,r){var n=t.className;e(r).test(n)||(t.className+=(n?" ":"")+r)}function a(t,r){for(var n=t.split(" "),i=0;i<n.length;i++)n[i]&&!e(n[i]).test(r)&&(r+=" "+n[i]);return r}function u(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t)}}function c(e,t,r){t||(t={});for(var n in e)!e.hasOwnProperty(n)||!1===r&&t.hasOwnProperty(n)||(t[n]=e[n]);return t}function f(e,t,r,n,i){null==t&&-1==(t=e.search(/[^\s\u00a0]/))&&(t=e.length);for(var o=n||0,l=i||0;;){var s=e.indexOf("\t",o);if(s<0||s>=t)return l+(t-o);l+=s-o,l+=r-l%r,o=s+1}}function h(e,t){for(var r=0;r<e.length;++r)if(e[r]==t)return r;return-1}function d(e,t,r){for(var n=0,i=0;;){var o=e.indexOf("\t",n);-1==o&&(o=e.length);var l=o-n;if(o==e.length||i+l>=t)return n+Math.min(l,t-i);if(i+=o-n,i+=r-i%r,n=o+1,i>=t)return n}}function p(e){for(;Kl.length<=e;)Kl.push(g(Kl)+" ");return Kl[e]}function g(e){return e[e.length-1]}function v(e,t){for(var r=[],n=0;n<e.length;n++)r[n]=t(e[n],n);return r}function m(e,t,r){for(var n=0,i=r(t);n<e.length&&r(e[n])<=i;)n++;e.splice(n,0,t)}function y(){}function b(e,t){var r;return Object.create?r=Object.create(e):(y.prototype=e,r=new y),t&&c(t,r),r}function w(e){return/\w/.test(e)||e>""&&(e.toUpperCase()!=e.toLowerCase()||jl.test(e))}function x(e,t){return t?!!(t.source.indexOf("\\w")>-1&&w(e))||t.test(e):w(e)}function C(e){for(var t in e)if(e.hasOwnProperty(t)&&e[t])return!1;return!0}function S(e){return e.charCodeAt(0)>=768&&Xl.test(e)}function L(e,t,r){for(;(r<0?t>0:t<e.length)&&S(e.charAt(t));)t+=r;return t}function k(e,t,r){for(var n=t>r?-1:1;;){if(t==r)return t;var i=(t+r)/2,o=n<0?Math.ceil(i):Math.floor(i);if(o==t)return e(o)?t:r;e(o)?r=o:t=o+n}}function T(e,t,r){var o=this;this.input=r,o.scrollbarFiller=n("div",null,"CodeMirror-scrollbar-filler"),o.scrollbarFiller.setAttribute("cm-not-content","true"),o.gutterFiller=n("div",null,"CodeMirror-gutter-filler"),o.gutterFiller.setAttribute("cm-not-content","true"),o.lineDiv=i("div",null,"CodeMirror-code"),o.selectionDiv=n("div",null,null,"position: relative; z-index: 1"),o.cursorDiv=n("div",null,"CodeMirror-cursors"),o.measure=n("div",null,"CodeMirror-measure"),o.lineMeasure=n("div",null,"CodeMirror-measure"),o.lineSpace=i("div",[o.measure,o.lineMeasure,o.selectionDiv,o.cursorDiv,o.lineDiv],null,"position: relative; outline: none");var l=i("div",[o.lineSpace],"CodeMirror-lines");o.mover=n("div",[l],null,"position: relative"),o.sizer=n("div",[o.mover],"CodeMirror-sizer"),o.sizerWidth=null,o.heightForcer=n("div",null,null,"position: absolute; height: "+Rl+"px; width: 1px;"),o.gutters=n("div",null,"CodeMirror-gutters"),o.lineGutter=null,o.scroller=n("div",[o.sizer,o.heightForcer,o.gutters],"CodeMirror-scroll"),o.scroller.setAttribute("tabIndex","-1"),o.wrapper=n("div",[o.scrollbarFiller,o.gutterFiller,o.scroller],"CodeMirror"),gl&&vl<8&&(o.gutters.style.zIndex=-1,o.scroller.style.paddingRight=0),ml||fl&&Tl||(o.scroller.draggable=!0),e&&(e.appendChild?e.appendChild(o.wrapper):e(o.wrapper)),o.viewFrom=o.viewTo=t.first,o.reportedViewFrom=o.reportedViewTo=t.first,o.view=[],o.renderedView=null,o.externalMeasured=null,o.viewOffset=0,o.lastWrapHeight=o.lastWrapWidth=0,o.updateLineNumbers=null,o.nativeBarWidth=o.barHeight=o.barWidth=0,o.scrollbarsClipped=!1,o.lineNumWidth=o.lineNumInnerWidth=o.lineNumChars=null,o.alignWidgets=!1,o.cachedCharWidth=o.cachedTextHeight=o.cachedPaddingH=null,o.maxLine=null,o.maxLineLength=0,o.maxLineChanged=!1,o.wheelDX=o.wheelDY=o.wheelStartX=o.wheelStartY=null,o.shift=!1,o.selForContextMenu=null,o.activeTouch=null,r.init(o)}function M(e,t){if((t-=e.first)<0||t>=e.size)throw new Error("There is no line "+(t+e.first)+" in the document.");for(var r=e;!r.lines;)for(var n=0;;++n){var i=r.children[n],o=i.chunkSize();if(t<o){r=i;break}t-=o}return r.lines[t]}function N(e,t,r){var n=[],i=t.line;return e.iter(t.line,r.line+1,function(e){var o=e.text;i==r.line&&(o=o.slice(0,r.ch)),i==t.line&&(o=o.slice(t.ch)),n.push(o),++i}),n}function O(e,t,r){var n=[];return e.iter(t,r,function(e){n.push(e.text)}),n}function A(e,t){var r=t-e.height;if(r)for(var n=e;n;n=n.parent)n.height+=r}function W(e){if(null==e.parent)return null;for(var t=e.parent,r=h(t.lines,e),n=t.parent;n;t=n,n=n.parent)for(var i=0;n.children[i]!=t;++i)r+=n.children[i].chunkSize();return r+t.first}function D(e,t){var r=e.first;e:do{for(var n=0;n<e.children.length;++n){var i=e.children[n],o=i.height;if(t<o){e=i;continue e}t-=o,r+=i.chunkSize()}return r}while(!e.lines);for(var l=0;l<e.lines.length;++l){var s=e.lines[l].height;if(t<s)break;t-=s}return r+l}function H(e,t){return t>=e.first&&t<e.first+e.size}function F(e,t){return String(e.lineNumberFormatter(t+e.firstLineNumber))}function E(e,t,r){if(void 0===r&&(r=null),!(this instanceof E))return new E(e,t,r);this.line=e,this.ch=t,this.sticky=r}function P(e,t){return e.line-t.line||e.ch-t.ch}function I(e,t){return e.sticky==t.sticky&&0==P(e,t)}function z(e){return E(e.line,e.ch)}function R(e,t){return P(e,t)<0?t:e}function B(e,t){return P(e,t)<0?e:t}function G(e,t){return Math.max(e.first,Math.min(t,e.first+e.size-1))}function U(e,t){if(t.line<e.first)return E(e.first,0);var r=e.first+e.size-1;return t.line>r?E(r,M(e,r).text.length):V(t,M(e,t.line).text.length)}function V(e,t){var r=e.ch;return null==r||r>t?E(e.line,t):r<0?E(e.line,0):e}function K(e,t){for(var r=[],n=0;n<t.length;n++)r[n]=U(e,t[n]);return r}function j(){Yl=!0}function X(){_l=!0}function Y(e,t,r){this.marker=e,this.from=t,this.to=r}function _(e,t){if(e)for(var r=0;r<e.length;++r){var n=e[r];if(n.marker==t)return n}}function $(e,t){for(var r,n=0;n<e.length;++n)e[n]!=t&&(r||(r=[])).push(e[n]);return r}function q(e,t){e.markedSpans=e.markedSpans?e.markedSpans.concat([t]):[t],t.marker.attachLine(e)}function Z(e,t,r){var n;if(e)for(var i=0;i<e.length;++i){var o=e[i],l=o.marker;if(null==o.from||(l.inclusiveLeft?o.from<=t:o.from<t)||o.from==t&&"bookmark"==l.type&&(!r||!o.marker.insertLeft)){var s=null==o.to||(l.inclusiveRight?o.to>=t:o.to>t);(n||(n=[])).push(new Y(l,o.from,s?null:o.to))}}return n}function Q(e,t,r){var n;if(e)for(var i=0;i<e.length;++i){var o=e[i],l=o.marker;if(null==o.to||(l.inclusiveRight?o.to>=t:o.to>t)||o.from==t&&"bookmark"==l.type&&(!r||o.marker.insertLeft)){var s=null==o.from||(l.inclusiveLeft?o.from<=t:o.from<t);(n||(n=[])).push(new Y(l,s?null:o.from-t,null==o.to?null:o.to-t))}}return n}function J(e,t){if(t.full)return null;var r=H(e,t.from.line)&&M(e,t.from.line).markedSpans,n=H(e,t.to.line)&&M(e,t.to.line).markedSpans;if(!r&&!n)return null;var i=t.from.ch,o=t.to.ch,l=0==P(t.from,t.to),s=Z(r,i,l),a=Q(n,o,l),u=1==t.text.length,c=g(t.text).length+(u?i:0);if(s)for(var f=0;f<s.length;++f){var h=s[f];if(null==h.to){var d=_(a,h.marker);d?u&&(h.to=null==d.to?null:d.to+c):h.to=i}}if(a)for(var p=0;p<a.length;++p){var v=a[p];null!=v.to&&(v.to+=c),null==v.from?_(s,v.marker)||(v.from=c,u&&(s||(s=[])).push(v)):(v.from+=c,u&&(s||(s=[])).push(v))}s&&(s=ee(s)),a&&a!=s&&(a=ee(a));var m=[s];if(!u){var y,b=t.text.length-2;if(b>0&&s)for(var w=0;w<s.length;++w)null==s[w].to&&(y||(y=[])).push(new Y(s[w].marker,null,null));for(var x=0;x<b;++x)m.push(y);m.push(a)}return m}function ee(e){for(var t=0;t<e.length;++t){var r=e[t];null!=r.from&&r.from==r.to&&!1!==r.marker.clearWhenEmpty&&e.splice(t--,1)}return e.length?e:null}function te(e,t,r){var n=null;if(e.iter(t.line,r.line+1,function(e){if(e.markedSpans)for(var t=0;t<e.markedSpans.length;++t){var r=e.markedSpans[t].marker;!r.readOnly||n&&-1!=h(n,r)||(n||(n=[])).push(r)}}),!n)return null;for(var i=[{from:t,to:r}],o=0;o<n.length;++o)for(var l=n[o],s=l.find(0),a=0;a<i.length;++a){var u=i[a];if(!(P(u.to,s.from)<0||P(u.from,s.to)>0)){var c=[a,1],f=P(u.from,s.from),d=P(u.to,s.to);(f<0||!l.inclusiveLeft&&!f)&&c.push({from:u.from,to:s.from}),(d>0||!l.inclusiveRight&&!d)&&c.push({from:s.to,to:u.to}),i.splice.apply(i,c),a+=c.length-3}}return i}function re(e){var t=e.markedSpans;if(t){for(var r=0;r<t.length;++r)t[r].marker.detachLine(e);e.markedSpans=null}}function ne(e,t){if(t){for(var r=0;r<t.length;++r)t[r].marker.attachLine(e);e.markedSpans=t}}function ie(e){return e.inclusiveLeft?-1:0}function oe(e){return e.inclusiveRight?1:0}function le(e,t){var r=e.lines.length-t.lines.length;if(0!=r)return r;var n=e.find(),i=t.find(),o=P(n.from,i.from)||ie(e)-ie(t);if(o)return-o;var l=P(n.to,i.to)||oe(e)-oe(t);return l||t.id-e.id}function se(e,t){var r,n=_l&&e.markedSpans;if(n)for(var i=void 0,o=0;o<n.length;++o)(i=n[o]).marker.collapsed&&null==(t?i.from:i.to)&&(!r||le(r,i.marker)<0)&&(r=i.marker);return r}function ae(e){return se(e,!0)}function ue(e){return se(e,!1)}function ce(e,t,r,n,i){var o=M(e,t),l=_l&&o.markedSpans;if(l)for(var s=0;s<l.length;++s){var a=l[s];if(a.marker.collapsed){var u=a.marker.find(0),c=P(u.from,r)||ie(a.marker)-ie(i),f=P(u.to,n)||oe(a.marker)-oe(i);if(!(c>=0&&f<=0||c<=0&&f>=0)&&(c<=0&&(a.marker.inclusiveRight&&i.inclusiveLeft?P(u.to,r)>=0:P(u.to,r)>0)||c>=0&&(a.marker.inclusiveRight&&i.inclusiveLeft?P(u.from,n)<=0:P(u.from,n)<0)))return!0}}}function fe(e){for(var t;t=ae(e);)e=t.find(-1,!0).line;return e}function he(e){for(var t;t=ue(e);)e=t.find(1,!0).line;return e}function de(e){for(var t,r;t=ue(e);)e=t.find(1,!0).line,(r||(r=[])).push(e);return r}function pe(e,t){var r=M(e,t),n=fe(r);return r==n?t:W(n)}function ge(e,t){if(t>e.lastLine())return t;var r,n=M(e,t);if(!ve(e,n))return t;for(;r=ue(n);)n=r.find(1,!0).line;return W(n)+1}function ve(e,t){var r=_l&&t.markedSpans;if(r)for(var n=void 0,i=0;i<r.length;++i)if((n=r[i]).marker.collapsed){if(null==n.from)return!0;if(!n.marker.widgetNode&&0==n.from&&n.marker.inclusiveLeft&&me(e,t,n))return!0}}function me(e,t,r){if(null==r.to){var n=r.marker.find(1,!0);return me(e,n.line,_(n.line.markedSpans,r.marker))}if(r.marker.inclusiveRight&&r.to==t.text.length)return!0;for(var i=void 0,o=0;o<t.markedSpans.length;++o)if((i=t.markedSpans[o]).marker.collapsed&&!i.marker.widgetNode&&i.from==r.to&&(null==i.to||i.to!=r.from)&&(i.marker.inclusiveLeft||r.marker.inclusiveRight)&&me(e,t,i))return!0}function ye(e){for(var t=0,r=(e=fe(e)).parent,n=0;n<r.lines.length;++n){var i=r.lines[n];if(i==e)break;t+=i.height}for(var o=r.parent;o;r=o,o=r.parent)for(var l=0;l<o.children.length;++l){var s=o.children[l];if(s==r)break;t+=s.height}return t}function be(e){if(0==e.height)return 0;for(var t,r=e.text.length,n=e;t=ae(n);){var i=t.find(0,!0);n=i.from.line,r+=i.from.ch-i.to.ch}for(n=e;t=ue(n);){var o=t.find(0,!0);r-=n.text.length-o.from.ch,r+=(n=o.to.line).text.length-o.to.ch}return r}function we(e){var t=e.display,r=e.doc;t.maxLine=M(r,r.first),t.maxLineLength=be(t.maxLine),t.maxLineChanged=!0,r.iter(function(e){var r=be(e);r>t.maxLineLength&&(t.maxLineLength=r,t.maxLine=e)})}function xe(e,t,r,n){if(!e)return n(t,r,"ltr",0);for(var i=!1,o=0;o<e.length;++o){var l=e[o];(l.from<r&&l.to>t||t==r&&l.to==t)&&(n(Math.max(l.from,t),Math.min(l.to,r),1==l.level?"rtl":"ltr",o),i=!0)}i||n(t,r,"ltr")}function Ce(e,t,r){var n;$l=null;for(var i=0;i<e.length;++i){var o=e[i];if(o.from<t&&o.to>t)return i;o.to==t&&(o.from!=o.to&&"before"==r?n=i:$l=i),o.from==t&&(o.from!=o.to&&"before"!=r?n=i:$l=i)}return null!=n?n:$l}function Se(e,t){var r=e.order;return null==r&&(r=e.order=ql(e.text,t)),r}function Le(e,t){return e._handlers&&e._handlers[t]||Zl}function ke(e,t,r){if(e.removeEventListener)e.removeEventListener(t,r,!1);else if(e.detachEvent)e.detachEvent("on"+t,r);else{var n=e._handlers,i=n&&n[t];if(i){var o=h(i,r);o>-1&&(n[t]=i.slice(0,o).concat(i.slice(o+1)))}}}function Te(e,t){var r=Le(e,t);if(r.length)for(var n=Array.prototype.slice.call(arguments,2),i=0;i<r.length;++i)r[i].apply(null,n)}function Me(e,t,r){return"string"==typeof t&&(t={type:t,preventDefault:function(){this.defaultPrevented=!0}}),Te(e,r||t.type,e,t),He(t)||t.codemirrorIgnore}function Ne(e){var t=e._handlers&&e._handlers.cursorActivity;if(t)for(var r=e.curOp.cursorActivityHandlers||(e.curOp.cursorActivityHandlers=[]),n=0;n<t.length;++n)-1==h(r,t[n])&&r.push(t[n])}function Oe(e,t){return Le(e,t).length>0}function Ae(e){e.prototype.on=function(e,t){Ql(this,e,t)},e.prototype.off=function(e,t){ke(this,e,t)}}function We(e){e.preventDefault?e.preventDefault():e.returnValue=!1}function De(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}function He(e){return null!=e.defaultPrevented?e.defaultPrevented:0==e.returnValue}function Fe(e){We(e),De(e)}function Ee(e){return e.target||e.srcElement}function Pe(e){var t=e.which;return null==t&&(1&e.button?t=1:2&e.button?t=3:4&e.button&&(t=2)),Ml&&e.ctrlKey&&1==t&&(t=3),t}function Ie(e){if(null==Il){var t=n("span","​");r(e,n("span",[t,document.createTextNode("x")])),0!=e.firstChild.offsetHeight&&(Il=t.offsetWidth<=1&&t.offsetHeight>2&&!(gl&&vl<8))}var i=Il?n("span","​"):n("span"," ",null,"display: inline-block; width: 1px; margin-right: -1px");return i.setAttribute("cm-text",""),i}function ze(e){if(null!=zl)return zl;var n=r(e,document.createTextNode("AخA")),i=Wl(n,0,1).getBoundingClientRect(),o=Wl(n,1,2).getBoundingClientRect();return t(e),!(!i||i.left==i.right)&&(zl=o.right-i.right<3)}function Re(e){if(null!=ns)return ns;var t=r(e,n("span","x")),i=t.getBoundingClientRect(),o=Wl(t,0,1).getBoundingClientRect();return ns=Math.abs(i.left-o.left)>1}function Be(e,t){arguments.length>2&&(t.dependencies=Array.prototype.slice.call(arguments,2)),is[e]=t}function Ge(e){if("string"==typeof e&&os.hasOwnProperty(e))e=os[e];else if(e&&"string"==typeof e.name&&os.hasOwnProperty(e.name)){var t=os[e.name];"string"==typeof t&&(t={name:t}),(e=b(t,e)).name=t.name}else{if("string"==typeof e&&/^[\w\-]+\/[\w\-]+\+xml$/.test(e))return Ge("application/xml");if("string"==typeof e&&/^[\w\-]+\/[\w\-]+\+json$/.test(e))return Ge("application/json")}return"string"==typeof e?{name:e}:e||{name:"null"}}function Ue(e,t){t=Ge(t);var r=is[t.name];if(!r)return Ue(e,"text/plain");var n=r(e,t);if(ls.hasOwnProperty(t.name)){var i=ls[t.name];for(var o in i)i.hasOwnProperty(o)&&(n.hasOwnProperty(o)&&(n["_"+o]=n[o]),n[o]=i[o])}if(n.name=t.name,t.helperType&&(n.helperType=t.helperType),t.modeProps)for(var l in t.modeProps)n[l]=t.modeProps[l];return n}function Ve(e,t){c(t,ls.hasOwnProperty(e)?ls[e]:ls[e]={})}function Ke(e,t){if(!0===t)return t;if(e.copyState)return e.copyState(t);var r={};for(var n in t){var i=t[n];i instanceof Array&&(i=i.concat([])),r[n]=i}return r}function je(e,t){for(var r;e.innerMode&&(r=e.innerMode(t))&&r.mode!=e;)t=r.state,e=r.mode;return r||{mode:e,state:t}}function Xe(e,t,r){return!e.startState||e.startState(t,r)}function Ye(e,t,r,n){var i=[e.state.modeGen],o={};tt(e,t.text,e.doc.mode,r,function(e,t){return i.push(e,t)},o,n);for(var l=r.state,s=0;s<e.state.overlays.length;++s)!function(n){var l=e.state.overlays[n],s=1,a=0;r.state=!0,tt(e,t.text,l.mode,r,function(e,t){for(var r=s;a<e;){var n=i[s];n>e&&i.splice(s,1,e,i[s+1],n),s+=2,a=Math.min(e,n)}if(t)if(l.opaque)i.splice(r,s-r,e,"overlay "+t),s=r+2;else for(;r<s;r+=2){var o=i[r+1];i[r+1]=(o?o+" ":"")+"overlay "+t}},o)}(s);return r.state=l,{styles:i,classes:o.bgClass||o.textClass?o:null}}function _e(e,t,r){if(!t.styles||t.styles[0]!=e.state.modeGen){var n=$e(e,W(t)),i=t.text.length>e.options.maxHighlightLength&&Ke(e.doc.mode,n.state),o=Ye(e,t,n);i&&(n.state=i),t.stateAfter=n.save(!i),t.styles=o.styles,o.classes?t.styleClasses=o.classes:t.styleClasses&&(t.styleClasses=null),r===e.doc.highlightFrontier&&(e.doc.modeFrontier=Math.max(e.doc.modeFrontier,++e.doc.highlightFrontier))}return t.styles}function $e(e,t,r){var n=e.doc,i=e.display;if(!n.mode.startState)return new us(n,!0,t);var o=rt(e,t,r),l=o>n.first&&M(n,o-1).stateAfter,s=l?us.fromSaved(n,l,o):new us(n,Xe(n.mode),o);return n.iter(o,t,function(r){qe(e,r.text,s);var n=s.line;r.stateAfter=n==t-1||n%5==0||n>=i.viewFrom&&n<i.viewTo?s.save():null,s.nextLine()}),r&&(n.modeFrontier=s.line),s}function qe(e,t,r,n){var i=e.doc.mode,o=new ss(t,e.options.tabSize,r);for(o.start=o.pos=n||0,""==t&&Ze(i,r.state);!o.eol();)Qe(i,o,r.state),o.start=o.pos}function Ze(e,t){if(e.blankLine)return e.blankLine(t);if(e.innerMode){var r=je(e,t);return r.mode.blankLine?r.mode.blankLine(r.state):void 0}}function Qe(e,t,r,n){for(var i=0;i<10;i++){n&&(n[0]=je(e,r).mode);var o=e.token(t,r);if(t.pos>t.start)return o}throw new Error("Mode "+e.name+" failed to advance stream.")}function Je(e,t,r,n){var i,o,l=e.doc,s=l.mode,a=M(l,(t=U(l,t)).line),u=$e(e,t.line,r),c=new ss(a.text,e.options.tabSize,u);for(n&&(o=[]);(n||c.pos<t.ch)&&!c.eol();)c.start=c.pos,i=Qe(s,c,u.state),n&&o.push(new cs(c,i,Ke(l.mode,u.state)));return n?o:new cs(c,i,u.state)}function et(e,t){if(e)for(;;){var r=e.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!r)break;e=e.slice(0,r.index)+e.slice(r.index+r[0].length);var n=r[1]?"bgClass":"textClass";null==t[n]?t[n]=r[2]:new RegExp("(?:^|s)"+r[2]+"(?:$|s)").test(t[n])||(t[n]+=" "+r[2])}return e}function tt(e,t,r,n,i,o,l){var s=r.flattenSpans;null==s&&(s=e.options.flattenSpans);var a,u=0,c=null,f=new ss(t,e.options.tabSize,n),h=e.options.addModeClass&&[null];for(""==t&&et(Ze(r,n.state),o);!f.eol();){if(f.pos>e.options.maxHighlightLength?(s=!1,l&&qe(e,t,n,f.pos),f.pos=t.length,a=null):a=et(Qe(r,f,n.state,h),o),h){var d=h[0].name;d&&(a="m-"+(a?d+" "+a:d))}if(!s||c!=a){for(;u<f.start;)i(u=Math.min(f.start,u+5e3),c);c=a}f.start=f.pos}for(;u<f.pos;){var p=Math.min(f.pos,u+5e3);i(p,c),u=p}}function rt(e,t,r){for(var n,i,o=e.doc,l=r?-1:t-(e.doc.mode.innerMode?1e3:100),s=t;s>l;--s){if(s<=o.first)return o.first;var a=M(o,s-1),u=a.stateAfter;if(u&&(!r||s+(u instanceof as?u.lookAhead:0)<=o.modeFrontier))return s;var c=f(a.text,null,e.options.tabSize);(null==i||n>c)&&(i=s-1,n=c)}return i}function nt(e,t){if(e.modeFrontier=Math.min(e.modeFrontier,t),!(e.highlightFrontier<t-10)){for(var r=e.first,n=t-1;n>r;n--){var i=M(e,n).stateAfter;if(i&&(!(i instanceof as)||n+i.lookAhead<t)){r=n+1;break}}e.highlightFrontier=Math.min(e.highlightFrontier,r)}}function it(e,t,r,n){e.text=t,e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null),null!=e.order&&(e.order=null),re(e),ne(e,r);var i=n?n(e):1;i!=e.height&&A(e,i)}function ot(e){e.parent=null,re(e)}function lt(e,t){if(!e||/^\s*$/.test(e))return null;var r=t.addModeClass?ps:ds;return r[e]||(r[e]=e.replace(/\S+/g,"cm-$&"))}function st(e,t){var r=i("span",null,null,ml?"padding-right: .1px":null),n={pre:i("pre",[r],"CodeMirror-line"),content:r,col:0,pos:0,cm:e,trailingSpace:!1,splitSpaces:(gl||ml)&&e.getOption("lineWrapping")};t.measure={};for(var o=0;o<=(t.rest?t.rest.length:0);o++){var l=o?t.rest[o-1]:t.line,s=void 0;n.pos=0,n.addToken=ut,ze(e.display.measure)&&(s=Se(l,e.doc.direction))&&(n.addToken=ft(n.addToken,s)),n.map=[],dt(l,n,_e(e,l,t!=e.display.externalMeasured&&W(l))),l.styleClasses&&(l.styleClasses.bgClass&&(n.bgClass=a(l.styleClasses.bgClass,n.bgClass||"")),l.styleClasses.textClass&&(n.textClass=a(l.styleClasses.textClass,n.textClass||""))),0==n.map.length&&n.map.push(0,0,n.content.appendChild(Ie(e.display.measure))),0==o?(t.measure.map=n.map,t.measure.cache={}):((t.measure.maps||(t.measure.maps=[])).push(n.map),(t.measure.caches||(t.measure.caches=[])).push({}))}if(ml){var u=n.content.lastChild;(/\bcm-tab\b/.test(u.className)||u.querySelector&&u.querySelector(".cm-tab"))&&(n.content.className="cm-tab-wrap-hack")}return Te(e,"renderLine",e,t.line,n.pre),n.pre.className&&(n.textClass=a(n.pre.className,n.textClass||"")),n}function at(e){var t=n("span","•","cm-invalidchar");return t.title="\\u"+e.charCodeAt(0).toString(16),t.setAttribute("aria-label",t.title),t}function ut(e,t,r,i,o,l,s){if(t){var a,u=e.splitSpaces?ct(t,e.trailingSpace):t,c=e.cm.state.specialChars,f=!1;if(c.test(t)){a=document.createDocumentFragment();for(var h=0;;){c.lastIndex=h;var d=c.exec(t),g=d?d.index-h:t.length-h;if(g){var v=document.createTextNode(u.slice(h,h+g));gl&&vl<9?a.appendChild(n("span",[v])):a.appendChild(v),e.map.push(e.pos,e.pos+g,v),e.col+=g,e.pos+=g}if(!d)break;h+=g+1;var m=void 0;if("\t"==d[0]){var y=e.cm.options.tabSize,b=y-e.col%y;(m=a.appendChild(n("span",p(b),"cm-tab"))).setAttribute("role","presentation"),m.setAttribute("cm-text","\t"),e.col+=b}else"\r"==d[0]||"\n"==d[0]?((m=a.appendChild(n("span","\r"==d[0]?"␍":"␤","cm-invalidchar"))).setAttribute("cm-text",d[0]),e.col+=1):((m=e.cm.options.specialCharPlaceholder(d[0])).setAttribute("cm-text",d[0]),gl&&vl<9?a.appendChild(n("span",[m])):a.appendChild(m),e.col+=1);e.map.push(e.pos,e.pos+1,m),e.pos++}}else e.col+=t.length,a=document.createTextNode(u),e.map.push(e.pos,e.pos+t.length,a),gl&&vl<9&&(f=!0),e.pos+=t.length;if(e.trailingSpace=32==u.charCodeAt(t.length-1),r||i||o||f||s){var w=r||"";i&&(w+=i),o&&(w+=o);var x=n("span",[a],w,s);return l&&(x.title=l),e.content.appendChild(x)}e.content.appendChild(a)}}function ct(e,t){if(e.length>1&&!/  /.test(e))return e;for(var r=t,n="",i=0;i<e.length;i++){var o=e.charAt(i);" "!=o||!r||i!=e.length-1&&32!=e.charCodeAt(i+1)||(o=" "),n+=o,r=" "==o}return n}function ft(e,t){return function(r,n,i,o,l,s,a){i=i?i+" cm-force-border":"cm-force-border";for(var u=r.pos,c=u+n.length;;){for(var f=void 0,h=0;h<t.length&&!((f=t[h]).to>u&&f.from<=u);h++);if(f.to>=c)return e(r,n,i,o,l,s,a);e(r,n.slice(0,f.to-u),i,o,null,s,a),o=null,n=n.slice(f.to-u),u=f.to}}}function ht(e,t,r,n){var i=!n&&r.widgetNode;i&&e.map.push(e.pos,e.pos+t,i),!n&&e.cm.display.input.needsContentAttribute&&(i||(i=e.content.appendChild(document.createElement("span"))),i.setAttribute("cm-marker",r.id)),i&&(e.cm.display.input.setUneditable(i),e.content.appendChild(i)),e.pos+=t,e.trailingSpace=!1}function dt(e,t,r){var n=e.markedSpans,i=e.text,o=0;if(n)for(var l,s,a,u,c,f,h,d=i.length,p=0,g=1,v="",m=0;;){if(m==p){a=u=c=f=s="",h=null,m=1/0;for(var y=[],b=void 0,w=0;w<n.length;++w){var x=n[w],C=x.marker;"bookmark"==C.type&&x.from==p&&C.widgetNode?y.push(C):x.from<=p&&(null==x.to||x.to>p||C.collapsed&&x.to==p&&x.from==p)?(null!=x.to&&x.to!=p&&m>x.to&&(m=x.to,u=""),C.className&&(a+=" "+C.className),C.css&&(s=(s?s+";":"")+C.css),C.startStyle&&x.from==p&&(c+=" "+C.startStyle),C.endStyle&&x.to==m&&(b||(b=[])).push(C.endStyle,x.to),C.title&&!f&&(f=C.title),C.collapsed&&(!h||le(h.marker,C)<0)&&(h=x)):x.from>p&&m>x.from&&(m=x.from)}if(b)for(var S=0;S<b.length;S+=2)b[S+1]==m&&(u+=" "+b[S]);if(!h||h.from==p)for(var L=0;L<y.length;++L)ht(t,0,y[L]);if(h&&(h.from||0)==p){if(ht(t,(null==h.to?d+1:h.to)-p,h.marker,null==h.from),null==h.to)return;h.to==p&&(h=!1)}}if(p>=d)break;for(var k=Math.min(d,m);;){if(v){var T=p+v.length;if(!h){var M=T>k?v.slice(0,k-p):v;t.addToken(t,M,l?l+a:a,c,p+M.length==m?u:"",f,s)}if(T>=k){v=v.slice(k-p),p=k;break}p=T,c=""}v=i.slice(o,o=r[g++]),l=lt(r[g++],t.cm.options)}}else for(var N=1;N<r.length;N+=2)t.addToken(t,i.slice(o,o=r[N]),lt(r[N+1],t.cm.options))}function pt(e,t,r){this.line=t,this.rest=de(t),this.size=this.rest?W(g(this.rest))-r+1:1,this.node=this.text=null,this.hidden=ve(e,t)}function gt(e,t,r){for(var n,i=[],o=t;o<r;o=n){var l=new pt(e.doc,M(e.doc,o),o);n=o+l.size,i.push(l)}return i}function vt(e){gs?gs.ops.push(e):e.ownsGroup=gs={ops:[e],delayedCallbacks:[]}}function mt(e){var t=e.delayedCallbacks,r=0;do{for(;r<t.length;r++)t[r].call(null);for(var n=0;n<e.ops.length;n++){var i=e.ops[n];if(i.cursorActivityHandlers)for(;i.cursorActivityCalled<i.cursorActivityHandlers.length;)i.cursorActivityHandlers[i.cursorActivityCalled++].call(null,i.cm)}}while(r<t.length)}function yt(e,t){var r=e.ownsGroup;if(r)try{mt(r)}finally{gs=null,t(r)}}function bt(e,t){var r=Le(e,t);if(r.length){var n,i=Array.prototype.slice.call(arguments,2);gs?n=gs.delayedCallbacks:vs?n=vs:(n=vs=[],setTimeout(wt,0));for(var o=0;o<r.length;++o)!function(e){n.push(function(){return r[e].apply(null,i)})}(o)}}function wt(){var e=vs;vs=null;for(var t=0;t<e.length;++t)e[t]()}function xt(e,t,r,n){for(var i=0;i<t.changes.length;i++){var o=t.changes[i];"text"==o?kt(e,t):"gutter"==o?Mt(e,t,r,n):"class"==o?Tt(e,t):"widget"==o&&Nt(e,t,n)}t.changes=null}function Ct(e){return e.node==e.text&&(e.node=n("div",null,null,"position: relative"),e.text.parentNode&&e.text.parentNode.replaceChild(e.node,e.text),e.node.appendChild(e.text),gl&&vl<8&&(e.node.style.zIndex=2)),e.node}function St(e,t){var r=t.bgClass?t.bgClass+" "+(t.line.bgClass||""):t.line.bgClass;if(r&&(r+=" CodeMirror-linebackground"),t.background)r?t.background.className=r:(t.background.parentNode.removeChild(t.background),t.background=null);else if(r){var i=Ct(t);t.background=i.insertBefore(n("div",null,r),i.firstChild),e.display.input.setUneditable(t.background)}}function Lt(e,t){var r=e.display.externalMeasured;return r&&r.line==t.line?(e.display.externalMeasured=null,t.measure=r.measure,r.built):st(e,t)}function kt(e,t){var r=t.text.className,n=Lt(e,t);t.text==t.node&&(t.node=n.pre),t.text.parentNode.replaceChild(n.pre,t.text),t.text=n.pre,n.bgClass!=t.bgClass||n.textClass!=t.textClass?(t.bgClass=n.bgClass,t.textClass=n.textClass,Tt(e,t)):r&&(t.text.className=r)}function Tt(e,t){St(e,t),t.line.wrapClass?Ct(t).className=t.line.wrapClass:t.node!=t.text&&(t.node.className="");var r=t.textClass?t.textClass+" "+(t.line.textClass||""):t.line.textClass;t.text.className=r||""}function Mt(e,t,r,i){if(t.gutter&&(t.node.removeChild(t.gutter),t.gutter=null),t.gutterBackground&&(t.node.removeChild(t.gutterBackground),t.gutterBackground=null),t.line.gutterClass){var o=Ct(t);t.gutterBackground=n("div",null,"CodeMirror-gutter-background "+t.line.gutterClass,"left: "+(e.options.fixedGutter?i.fixedPos:-i.gutterTotalWidth)+"px; width: "+i.gutterTotalWidth+"px"),e.display.input.setUneditable(t.gutterBackground),o.insertBefore(t.gutterBackground,t.text)}var l=t.line.gutterMarkers;if(e.options.lineNumbers||l){var s=Ct(t),a=t.gutter=n("div",null,"CodeMirror-gutter-wrapper","left: "+(e.options.fixedGutter?i.fixedPos:-i.gutterTotalWidth)+"px");if(e.display.input.setUneditable(a),s.insertBefore(a,t.text),t.line.gutterClass&&(a.className+=" "+t.line.gutterClass),!e.options.lineNumbers||l&&l["CodeMirror-linenumbers"]||(t.lineNumber=a.appendChild(n("div",F(e.options,r),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+i.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+e.display.lineNumInnerWidth+"px"))),l)for(var u=0;u<e.options.gutters.length;++u){var c=e.options.gutters[u],f=l.hasOwnProperty(c)&&l[c];f&&a.appendChild(n("div",[f],"CodeMirror-gutter-elt","left: "+i.gutterLeft[c]+"px; width: "+i.gutterWidth[c]+"px"))}}}function Nt(e,t,r){t.alignable&&(t.alignable=null);for(var n=t.node.firstChild,i=void 0;n;n=i)i=n.nextSibling,"CodeMirror-linewidget"==n.className&&t.node.removeChild(n);At(e,t,r)}function Ot(e,t,r,n){var i=Lt(e,t);return t.text=t.node=i.pre,i.bgClass&&(t.bgClass=i.bgClass),i.textClass&&(t.textClass=i.textClass),Tt(e,t),Mt(e,t,r,n),At(e,t,n),t.node}function At(e,t,r){if(Wt(e,t.line,t,r,!0),t.rest)for(var n=0;n<t.rest.length;n++)Wt(e,t.rest[n],t,r,!1)}function Wt(e,t,r,i,o){if(t.widgets)for(var l=Ct(r),s=0,a=t.widgets;s<a.length;++s){var u=a[s],c=n("div",[u.node],"CodeMirror-linewidget");u.handleMouseEvents||c.setAttribute("cm-ignore-events","true"),Dt(u,c,r,i),e.display.input.setUneditable(c),o&&u.above?l.insertBefore(c,r.gutter||r.text):l.appendChild(c),bt(u,"redraw")}}function Dt(e,t,r,n){if(e.noHScroll){(r.alignable||(r.alignable=[])).push(t);var i=n.wrapperWidth;t.style.left=n.fixedPos+"px",e.coverGutter||(i-=n.gutterTotalWidth,t.style.paddingLeft=n.gutterTotalWidth+"px"),t.style.width=i+"px"}e.coverGutter&&(t.style.zIndex=5,t.style.position="relative",e.noHScroll||(t.style.marginLeft=-n.gutterTotalWidth+"px"))}function Ht(e){if(null!=e.height)return e.height;var t=e.doc.cm;if(!t)return 0;if(!o(document.body,e.node)){var i="position: relative;";e.coverGutter&&(i+="margin-left: -"+t.display.gutters.offsetWidth+"px;"),e.noHScroll&&(i+="width: "+t.display.wrapper.clientWidth+"px;"),r(t.display.measure,n("div",[e.node],null,i))}return e.height=e.node.parentNode.offsetHeight}function Ft(e,t){for(var r=Ee(t);r!=e.wrapper;r=r.parentNode)if(!r||1==r.nodeType&&"true"==r.getAttribute("cm-ignore-events")||r.parentNode==e.sizer&&r!=e.mover)return!0}function Et(e){return e.lineSpace.offsetTop}function Pt(e){return e.mover.offsetHeight-e.lineSpace.offsetHeight}function It(e){if(e.cachedPaddingH)return e.cachedPaddingH;var t=r(e.measure,n("pre","x")),i=window.getComputedStyle?window.getComputedStyle(t):t.currentStyle,o={left:parseInt(i.paddingLeft),right:parseInt(i.paddingRight)};return isNaN(o.left)||isNaN(o.right)||(e.cachedPaddingH=o),o}function zt(e){return Rl-e.display.nativeBarWidth}function Rt(e){return e.display.scroller.clientWidth-zt(e)-e.display.barWidth}function Bt(e){return e.display.scroller.clientHeight-zt(e)-e.display.barHeight}function Gt(e,t,r){var n=e.options.lineWrapping,i=n&&Rt(e);if(!t.measure.heights||n&&t.measure.width!=i){var o=t.measure.heights=[];if(n){t.measure.width=i;for(var l=t.text.firstChild.getClientRects(),s=0;s<l.length-1;s++){var a=l[s],u=l[s+1];Math.abs(a.bottom-u.bottom)>2&&o.push((a.bottom+u.top)/2-r.top)}}o.push(r.bottom-r.top)}}function Ut(e,t,r){if(e.line==t)return{map:e.measure.map,cache:e.measure.cache};for(var n=0;n<e.rest.length;n++)if(e.rest[n]==t)return{map:e.measure.maps[n],cache:e.measure.caches[n]};for(var i=0;i<e.rest.length;i++)if(W(e.rest[i])>r)return{map:e.measure.maps[i],cache:e.measure.caches[i],before:!0}}function Vt(e,t){var n=W(t=fe(t)),i=e.display.externalMeasured=new pt(e.doc,t,n);i.lineN=n;var o=i.built=st(e,i);return i.text=o.pre,r(e.display.lineMeasure,o.pre),i}function Kt(e,t,r,n){return Yt(e,Xt(e,t),r,n)}function jt(e,t){if(t>=e.display.viewFrom&&t<e.display.viewTo)return e.display.view[Lr(e,t)];var r=e.display.externalMeasured;return r&&t>=r.lineN&&t<r.lineN+r.size?r:void 0}function Xt(e,t){var r=W(t),n=jt(e,r);n&&!n.text?n=null:n&&n.changes&&(xt(e,n,r,br(e)),e.curOp.forceUpdate=!0),n||(n=Vt(e,t));var i=Ut(n,t,r);return{line:t,view:n,rect:null,map:i.map,cache:i.cache,before:i.before,hasHeights:!1}}function Yt(e,t,r,n,i){t.before&&(r=-1);var o,l=r+(n||"");return t.cache.hasOwnProperty(l)?o=t.cache[l]:(t.rect||(t.rect=t.view.text.getBoundingClientRect()),t.hasHeights||(Gt(e,t.view,t.rect),t.hasHeights=!0),(o=qt(e,t,r,n)).bogus||(t.cache[l]=o)),{left:o.left,right:o.right,top:i?o.rtop:o.top,bottom:i?o.rbottom:o.bottom}}function _t(e,t,r){for(var n,i,o,l,s,a,u=0;u<e.length;u+=3)if(s=e[u],a=e[u+1],t<s?(i=0,o=1,l="left"):t<a?o=(i=t-s)+1:(u==e.length-3||t==a&&e[u+3]>t)&&(i=(o=a-s)-1,t>=a&&(l="right")),null!=i){if(n=e[u+2],s==a&&r==(n.insertLeft?"left":"right")&&(l=r),"left"==r&&0==i)for(;u&&e[u-2]==e[u-3]&&e[u-1].insertLeft;)n=e[2+(u-=3)],l="left";if("right"==r&&i==a-s)for(;u<e.length-3&&e[u+3]==e[u+4]&&!e[u+5].insertLeft;)n=e[(u+=3)+2],l="right";break}return{node:n,start:i,end:o,collapse:l,coverStart:s,coverEnd:a}}function $t(e,t){var r=ms;if("left"==t)for(var n=0;n<e.length&&(r=e[n]).left==r.right;n++);else for(var i=e.length-1;i>=0&&(r=e[i]).left==r.right;i--);return r}function qt(e,t,r,n){var i,o=_t(t.map,r,n),l=o.node,s=o.start,a=o.end,u=o.collapse;if(3==l.nodeType){for(var c=0;c<4;c++){for(;s&&S(t.line.text.charAt(o.coverStart+s));)--s;for(;o.coverStart+a<o.coverEnd&&S(t.line.text.charAt(o.coverStart+a));)++a;if((i=gl&&vl<9&&0==s&&a==o.coverEnd-o.coverStart?l.parentNode.getBoundingClientRect():$t(Wl(l,s,a).getClientRects(),n)).left||i.right||0==s)break;a=s,s-=1,u="right"}gl&&vl<11&&(i=Zt(e.display.measure,i))}else{s>0&&(u=n="right");var f;i=e.options.lineWrapping&&(f=l.getClientRects()).length>1?f["right"==n?f.length-1:0]:l.getBoundingClientRect()}if(gl&&vl<9&&!s&&(!i||!i.left&&!i.right)){var h=l.parentNode.getClientRects()[0];i=h?{left:h.left,right:h.left+yr(e.display),top:h.top,bottom:h.bottom}:ms}for(var d=i.top-t.rect.top,p=i.bottom-t.rect.top,g=(d+p)/2,v=t.view.measure.heights,m=0;m<v.length-1&&!(g<v[m]);m++);var y=m?v[m-1]:0,b=v[m],w={left:("right"==u?i.right:i.left)-t.rect.left,right:("left"==u?i.left:i.right)-t.rect.left,top:y,bottom:b};return i.left||i.right||(w.bogus=!0),e.options.singleCursorHeightPerLine||(w.rtop=d,w.rbottom=p),w}function Zt(e,t){if(!window.screen||null==screen.logicalXDPI||screen.logicalXDPI==screen.deviceXDPI||!Re(e))return t;var r=screen.logicalXDPI/screen.deviceXDPI,n=screen.logicalYDPI/screen.deviceYDPI;return{left:t.left*r,right:t.right*r,top:t.top*n,bottom:t.bottom*n}}function Qt(e){if(e.measure&&(e.measure.cache={},e.measure.heights=null,e.rest))for(var t=0;t<e.rest.length;t++)e.measure.caches[t]={}}function Jt(e){e.display.externalMeasure=null,t(e.display.lineMeasure);for(var r=0;r<e.display.view.length;r++)Qt(e.display.view[r])}function er(e){Jt(e),e.display.cachedCharWidth=e.display.cachedTextHeight=e.display.cachedPaddingH=null,e.options.lineWrapping||(e.display.maxLineChanged=!0),e.display.lineNumChars=null}function tr(){return bl&&kl?-(document.body.getBoundingClientRect().left-parseInt(getComputedStyle(document.body).marginLeft)):window.pageXOffset||(document.documentElement||document.body).scrollLeft}function rr(){return bl&&kl?-(document.body.getBoundingClientRect().top-parseInt(getComputedStyle(document.body).marginTop)):window.pageYOffset||(document.documentElement||document.body).scrollTop}function nr(e){var t=0;if(e.widgets)for(var r=0;r<e.widgets.length;++r)e.widgets[r].above&&(t+=Ht(e.widgets[r]));return t}function ir(e,t,r,n,i){if(!i){var o=nr(t);r.top+=o,r.bottom+=o}if("line"==n)return r;n||(n="local");var l=ye(t);if("local"==n?l+=Et(e.display):l-=e.display.viewOffset,"page"==n||"window"==n){var s=e.display.lineSpace.getBoundingClientRect();l+=s.top+("window"==n?0:rr());var a=s.left+("window"==n?0:tr());r.left+=a,r.right+=a}return r.top+=l,r.bottom+=l,r}function or(e,t,r){if("div"==r)return t;var n=t.left,i=t.top;if("page"==r)n-=tr(),i-=rr();else if("local"==r||!r){var o=e.display.sizer.getBoundingClientRect();n+=o.left,i+=o.top}var l=e.display.lineSpace.getBoundingClientRect();return{left:n-l.left,top:i-l.top}}function lr(e,t,r,n,i){return n||(n=M(e.doc,t.line)),ir(e,n,Kt(e,n,t.ch,i),r)}function sr(e,t,r,n,i,o){function l(t,l){var s=Yt(e,i,t,l?"right":"left",o);return l?s.left=s.right:s.right=s.left,ir(e,n,s,r)}function s(e,t,r){var n=1==a[t].level;return l(r?e-1:e,n!=r)}n=n||M(e.doc,t.line),i||(i=Xt(e,n));var a=Se(n,e.doc.direction),u=t.ch,c=t.sticky;if(u>=n.text.length?(u=n.text.length,c="before"):u<=0&&(u=0,c="after"),!a)return l("before"==c?u-1:u,"before"==c);var f=Ce(a,u,c),h=$l,d=s(u,f,"before"==c);return null!=h&&(d.other=s(u,h,"before"!=c)),d}function ar(e,t){var r=0;t=U(e.doc,t),e.options.lineWrapping||(r=yr(e.display)*t.ch);var n=M(e.doc,t.line),i=ye(n)+Et(e.display);return{left:r,right:r,top:i,bottom:i+n.height}}function ur(e,t,r,n,i){var o=E(e,t,r);return o.xRel=i,n&&(o.outside=!0),o}function cr(e,t,r){var n=e.doc;if((r+=e.display.viewOffset)<0)return ur(n.first,0,null,!0,-1);var i=D(n,r),o=n.first+n.size-1;if(i>o)return ur(n.first+n.size-1,M(n,o).text.length,null,!0,1);t<0&&(t=0);for(var l=M(n,i);;){var s=pr(e,l,i,t,r),a=ue(l),u=a&&a.find(0,!0);if(!a||!(s.ch>u.from.ch||s.ch==u.from.ch&&s.xRel>0))return s;i=W(l=u.to.line)}}function fr(e,t,r,n){n-=nr(t);var i=t.text.length,o=k(function(t){return Yt(e,r,t-1).bottom<=n},i,0);return i=k(function(t){return Yt(e,r,t).top>n},o,i),{begin:o,end:i}}function hr(e,t,r,n){return r||(r=Xt(e,t)),fr(e,t,r,ir(e,t,Yt(e,r,n),"line").top)}function dr(e,t,r,n){return!(e.bottom<=r)&&(e.top>r||(n?e.left:e.right)>t)}function pr(e,t,r,n,i){i-=ye(t);var o=Xt(e,t),l=nr(t),s=0,a=t.text.length,u=!0,c=Se(t,e.doc.direction);if(c){var f=(e.options.lineWrapping?vr:gr)(e,t,r,o,c,n,i);s=(u=1!=f.level)?f.from:f.to-1,a=u?f.to:f.from-1}var h,d,p=null,g=null,v=k(function(t){var r=Yt(e,o,t);return r.top+=l,r.bottom+=l,!!dr(r,n,i,!1)&&(r.top<=i&&r.left<=n&&(p=t,g=r),!0)},s,a),m=!1;if(g){var y=n-g.left<g.right-n,b=y==u;v=p+(b?0:1),d=b?"after":"before",h=y?g.left:g.right}else{u||v!=a&&v!=s||v++,d=0==v?"after":v==t.text.length?"before":Yt(e,o,v-(u?1:0)).bottom+l<=i==u?"after":"before";var w=sr(e,E(r,v,d),"line",t,o);h=w.left,m=i<w.top||i>=w.bottom}return v=L(t.text,v,1),ur(r,v,d,m,n-h)}function gr(e,t,r,n,i,o,l){var s=k(function(s){var a=i[s],u=1!=a.level;return dr(sr(e,E(r,u?a.to:a.from,u?"before":"after"),"line",t,n),o,l,!0)},0,i.length-1),a=i[s];if(s>0){var u=1!=a.level,c=sr(e,E(r,u?a.from:a.to,u?"after":"before"),"line",t,n);dr(c,o,l,!0)&&c.top>l&&(a=i[s-1])}return a}function vr(e,t,r,n,i,o,l){for(var s=fr(e,t,n,l),a=s.begin,u=s.end,c=null,f=null,h=0;h<i.length;h++){var d=i[h];if(!(d.from>=u||d.to<=a)){var p=Yt(e,n,1!=d.level?Math.min(u,d.to)-1:Math.max(a,d.from)).right,g=p<o?o-p+1e9:p-o;(!c||f>g)&&(c=d,f=g)}}return c||(c=i[i.length-1]),c.from<a&&(c={from:a,to:c.to,level:c.level}),c.to>u&&(c={from:c.from,to:u,level:c.level}),c}function mr(e){if(null!=e.cachedTextHeight)return e.cachedTextHeight;if(null==hs){hs=n("pre");for(var i=0;i<49;++i)hs.appendChild(document.createTextNode("x")),hs.appendChild(n("br"));hs.appendChild(document.createTextNode("x"))}r(e.measure,hs);var o=hs.offsetHeight/50;return o>3&&(e.cachedTextHeight=o),t(e.measure),o||1}function yr(e){if(null!=e.cachedCharWidth)return e.cachedCharWidth;var t=n("span","xxxxxxxxxx"),i=n("pre",[t]);r(e.measure,i);var o=t.getBoundingClientRect(),l=(o.right-o.left)/10;return l>2&&(e.cachedCharWidth=l),l||10}function br(e){for(var t=e.display,r={},n={},i=t.gutters.clientLeft,o=t.gutters.firstChild,l=0;o;o=o.nextSibling,++l)r[e.options.gutters[l]]=o.offsetLeft+o.clientLeft+i,n[e.options.gutters[l]]=o.clientWidth;return{fixedPos:wr(t),gutterTotalWidth:t.gutters.offsetWidth,gutterLeft:r,gutterWidth:n,wrapperWidth:t.wrapper.clientWidth}}function wr(e){return e.scroller.getBoundingClientRect().left-e.sizer.getBoundingClientRect().left}function xr(e){var t=mr(e.display),r=e.options.lineWrapping,n=r&&Math.max(5,e.display.scroller.clientWidth/yr(e.display)-3);return function(i){if(ve(e.doc,i))return 0;var o=0;if(i.widgets)for(var l=0;l<i.widgets.length;l++)i.widgets[l].height&&(o+=i.widgets[l].height);return r?o+(Math.ceil(i.text.length/n)||1)*t:o+t}}function Cr(e){var t=e.doc,r=xr(e);t.iter(function(e){var t=r(e);t!=e.height&&A(e,t)})}function Sr(e,t,r,n){var i=e.display;if(!r&&"true"==Ee(t).getAttribute("cm-not-content"))return null;var o,l,s=i.lineSpace.getBoundingClientRect();try{o=t.clientX-s.left,l=t.clientY-s.top}catch(t){return null}var a,u=cr(e,o,l);if(n&&1==u.xRel&&(a=M(e.doc,u.line).text).length==u.ch){var c=f(a,a.length,e.options.tabSize)-a.length;u=E(u.line,Math.max(0,Math.round((o-It(e.display).left)/yr(e.display))-c))}return u}function Lr(e,t){if(t>=e.display.viewTo)return null;if((t-=e.display.viewFrom)<0)return null;for(var r=e.display.view,n=0;n<r.length;n++)if((t-=r[n].size)<0)return n}function kr(e){e.display.input.showSelection(e.display.input.prepareSelection())}function Tr(e,t){void 0===t&&(t=!0);for(var r=e.doc,n={},i=n.cursors=document.createDocumentFragment(),o=n.selection=document.createDocumentFragment(),l=0;l<r.sel.ranges.length;l++)if(t||l!=r.sel.primIndex){var s=r.sel.ranges[l];if(!(s.from().line>=e.display.viewTo||s.to().line<e.display.viewFrom)){var a=s.empty();(a||e.options.showCursorWhenSelecting)&&Mr(e,s.head,i),a||Or(e,s,o)}}return n}function Mr(e,t,r){var i=sr(e,t,"div",null,null,!e.options.singleCursorHeightPerLine),o=r.appendChild(n("div"," ","CodeMirror-cursor"));if(o.style.left=i.left+"px",o.style.top=i.top+"px",o.style.height=Math.max(0,i.bottom-i.top)*e.options.cursorHeight+"px",i.other){var l=r.appendChild(n("div"," ","CodeMirror-cursor CodeMirror-secondarycursor"));l.style.display="",l.style.left=i.other.left+"px",l.style.top=i.other.top+"px",l.style.height=.85*(i.other.bottom-i.other.top)+"px"}}function Nr(e,t){return e.top-t.top||e.left-t.left}function Or(e,t,r){function i(e,t,r,i){t<0&&(t=0),t=Math.round(t),i=Math.round(i),a.appendChild(n("div",null,"CodeMirror-selected","position: absolute; left: "+e+"px;\n                             top: "+t+"px; width: "+(null==r?f-e:r)+"px;\n                             height: "+(i-t)+"px"))}function o(t,r,n){function o(r,n){return lr(e,E(t,r),"div",u,n)}var l,a,u=M(s,t),h=u.text.length,d=Se(u,s.direction);return xe(d,r||0,null==n?h:n,function(t,s,p,g){var v=o(t,"ltr"==p?"left":"right"),m=o(s-1,"ltr"==p?"right":"left");if("ltr"==p){var y=null==r&&0==t?c:v.left,b=null==n&&s==h?f:m.right;m.top-v.top<=3?i(y,m.top,b-y,m.bottom):(i(y,v.top,null,v.bottom),v.bottom<m.top&&i(c,v.bottom,null,m.top),i(c,m.top,m.right,m.bottom))}else if(t<s){var w=null==r&&0==t?f:v.right,x=null==n&&s==h?c:m.left;if(m.top-v.top<=3)i(x,m.top,w-x,m.bottom);else{var C=c;if(g){var S=hr(e,u,null,t).end;C=o(S-(/\s/.test(u.text.charAt(S-1))?2:1),"left").left}i(C,v.top,w-C,v.bottom),v.bottom<m.top&&i(c,v.bottom,null,m.top);var L=null;d.length,L=o(hr(e,u,null,s).begin,"right").right-x,i(x,m.top,L,m.bottom)}}(!l||Nr(v,l)<0)&&(l=v),Nr(m,l)<0&&(l=m),(!a||Nr(v,a)<0)&&(a=v),Nr(m,a)<0&&(a=m)}),{start:l,end:a}}var l=e.display,s=e.doc,a=document.createDocumentFragment(),u=It(e.display),c=u.left,f=Math.max(l.sizerWidth,Rt(e)-l.sizer.offsetLeft)-u.right,h=t.from(),d=t.to();if(h.line==d.line)o(h.line,h.ch,d.ch);else{var p=M(s,h.line),g=M(s,d.line),v=fe(p)==fe(g),m=o(h.line,h.ch,v?p.text.length+1:null).end,y=o(d.line,v?0:null,d.ch).start;v&&(m.top<y.top-2?(i(m.right,m.top,null,m.bottom),i(c,y.top,y.left,y.bottom)):i(m.right,m.top,y.left-m.right,m.bottom)),m.bottom<y.top&&i(c,m.bottom,null,y.top)}r.appendChild(a)}function Ar(e){if(e.state.focused){var t=e.display;clearInterval(t.blinker);var r=!0;t.cursorDiv.style.visibility="",e.options.cursorBlinkRate>0?t.blinker=setInterval(function(){return t.cursorDiv.style.visibility=(r=!r)?"":"hidden"},e.options.cursorBlinkRate):e.options.cursorBlinkRate<0&&(t.cursorDiv.style.visibility="hidden")}}function Wr(e){e.state.focused||(e.display.input.focus(),Hr(e))}function Dr(e){e.state.delayingBlurEvent=!0,setTimeout(function(){e.state.delayingBlurEvent&&(e.state.delayingBlurEvent=!1,Fr(e))},100)}function Hr(e,t){e.state.delayingBlurEvent&&(e.state.delayingBlurEvent=!1),"nocursor"!=e.options.readOnly&&(e.state.focused||(Te(e,"focus",e,t),e.state.focused=!0,s(e.display.wrapper,"CodeMirror-focused"),e.curOp||e.display.selForContextMenu==e.doc.sel||(e.display.input.reset(),ml&&setTimeout(function(){return e.display.input.reset(!0)},20)),e.display.input.receivedFocus()),Ar(e))}function Fr(e,t){e.state.delayingBlurEvent||(e.state.focused&&(Te(e,"blur",e,t),e.state.focused=!1,Fl(e.display.wrapper,"CodeMirror-focused")),clearInterval(e.display.blinker),setTimeout(function(){e.state.focused||(e.display.shift=!1)},150))}function Er(e){for(var t=e.display,r=t.lineDiv.offsetTop,n=0;n<t.view.length;n++){var i=t.view[n],o=void 0;if(!i.hidden){if(gl&&vl<8){var l=i.node.offsetTop+i.node.offsetHeight;o=l-r,r=l}else{var s=i.node.getBoundingClientRect();o=s.bottom-s.top}var a=i.line.height-o;if(o<2&&(o=mr(t)),(a>.005||a<-.005)&&(A(i.line,o),Pr(i.line),i.rest))for(var u=0;u<i.rest.length;u++)Pr(i.rest[u])}}}function Pr(e){if(e.widgets)for(var t=0;t<e.widgets.length;++t)e.widgets[t].height=e.widgets[t].node.parentNode.offsetHeight}function Ir(e,t,r){var n=r&&null!=r.top?Math.max(0,r.top):e.scroller.scrollTop;n=Math.floor(n-Et(e));var i=r&&null!=r.bottom?r.bottom:n+e.wrapper.clientHeight,o=D(t,n),l=D(t,i);if(r&&r.ensure){var s=r.ensure.from.line,a=r.ensure.to.line;s<o?(o=s,l=D(t,ye(M(t,s))+e.wrapper.clientHeight)):Math.min(a,t.lastLine())>=l&&(o=D(t,ye(M(t,a))-e.wrapper.clientHeight),l=a)}return{from:o,to:Math.max(l,o+1)}}function zr(e){var t=e.display,r=t.view;if(t.alignWidgets||t.gutters.firstChild&&e.options.fixedGutter){for(var n=wr(t)-t.scroller.scrollLeft+e.doc.scrollLeft,i=t.gutters.offsetWidth,o=n+"px",l=0;l<r.length;l++)if(!r[l].hidden){e.options.fixedGutter&&(r[l].gutter&&(r[l].gutter.style.left=o),r[l].gutterBackground&&(r[l].gutterBackground.style.left=o));var s=r[l].alignable;if(s)for(var a=0;a<s.length;a++)s[a].style.left=o}e.options.fixedGutter&&(t.gutters.style.left=n+i+"px")}}function Rr(e){if(!e.options.lineNumbers)return!1;var t=e.doc,r=F(e.options,t.first+t.size-1),i=e.display;if(r.length!=i.lineNumChars){var o=i.measure.appendChild(n("div",[n("div",r)],"CodeMirror-linenumber CodeMirror-gutter-elt")),l=o.firstChild.offsetWidth,s=o.offsetWidth-l;return i.lineGutter.style.width="",i.lineNumInnerWidth=Math.max(l,i.lineGutter.offsetWidth-s)+1,i.lineNumWidth=i.lineNumInnerWidth+s,i.lineNumChars=i.lineNumInnerWidth?r.length:-1,i.lineGutter.style.width=i.lineNumWidth+"px",Wn(e),!0}return!1}function Br(e,t){if(!Me(e,"scrollCursorIntoView")){var r=e.display,i=r.sizer.getBoundingClientRect(),o=null;if(t.top+i.top<0?o=!0:t.bottom+i.top>(window.innerHeight||document.documentElement.clientHeight)&&(o=!1),null!=o&&!Sl){var l=n("div","​",null,"position: absolute;\n                         top: "+(t.top-r.viewOffset-Et(e.display))+"px;\n                         height: "+(t.bottom-t.top+zt(e)+r.barHeight)+"px;\n                         left: "+t.left+"px; width: "+Math.max(2,t.right-t.left)+"px;");e.display.lineSpace.appendChild(l),l.scrollIntoView(o),e.display.lineSpace.removeChild(l)}}}function Gr(e,t,r,n){null==n&&(n=0);var i;e.options.lineWrapping||t!=r||(r="before"==(t=t.ch?E(t.line,"before"==t.sticky?t.ch-1:t.ch,"after"):t).sticky?E(t.line,t.ch+1,"before"):t);for(var o=0;o<5;o++){var l=!1,s=sr(e,t),a=r&&r!=t?sr(e,r):s,u=Vr(e,i={left:Math.min(s.left,a.left),top:Math.min(s.top,a.top)-n,right:Math.max(s.left,a.left),bottom:Math.max(s.bottom,a.bottom)+n}),c=e.doc.scrollTop,f=e.doc.scrollLeft;if(null!=u.scrollTop&&(qr(e,u.scrollTop),Math.abs(e.doc.scrollTop-c)>1&&(l=!0)),null!=u.scrollLeft&&(Qr(e,u.scrollLeft),Math.abs(e.doc.scrollLeft-f)>1&&(l=!0)),!l)break}return i}function Ur(e,t){var r=Vr(e,t);null!=r.scrollTop&&qr(e,r.scrollTop),null!=r.scrollLeft&&Qr(e,r.scrollLeft)}function Vr(e,t){var r=e.display,n=mr(e.display);t.top<0&&(t.top=0);var i=e.curOp&&null!=e.curOp.scrollTop?e.curOp.scrollTop:r.scroller.scrollTop,o=Bt(e),l={};t.bottom-t.top>o&&(t.bottom=t.top+o);var s=e.doc.height+Pt(r),a=t.top<n,u=t.bottom>s-n;if(t.top<i)l.scrollTop=a?0:t.top;else if(t.bottom>i+o){var c=Math.min(t.top,(u?s:t.bottom)-o);c!=i&&(l.scrollTop=c)}var f=e.curOp&&null!=e.curOp.scrollLeft?e.curOp.scrollLeft:r.scroller.scrollLeft,h=Rt(e)-(e.options.fixedGutter?r.gutters.offsetWidth:0),d=t.right-t.left>h;return d&&(t.right=t.left+h),t.left<10?l.scrollLeft=0:t.left<f?l.scrollLeft=Math.max(0,t.left-(d?0:10)):t.right>h+f-3&&(l.scrollLeft=t.right+(d?0:10)-h),l}function Kr(e,t){null!=t&&(_r(e),e.curOp.scrollTop=(null==e.curOp.scrollTop?e.doc.scrollTop:e.curOp.scrollTop)+t)}function jr(e){_r(e);var t=e.getCursor();e.curOp.scrollToPos={from:t,to:t,margin:e.options.cursorScrollMargin}}function Xr(e,t,r){null==t&&null==r||_r(e),null!=t&&(e.curOp.scrollLeft=t),null!=r&&(e.curOp.scrollTop=r)}function Yr(e,t){_r(e),e.curOp.scrollToPos=t}function _r(e){var t=e.curOp.scrollToPos;t&&(e.curOp.scrollToPos=null,$r(e,ar(e,t.from),ar(e,t.to),t.margin))}function $r(e,t,r,n){var i=Vr(e,{left:Math.min(t.left,r.left),top:Math.min(t.top,r.top)-n,right:Math.max(t.right,r.right),bottom:Math.max(t.bottom,r.bottom)+n});Xr(e,i.scrollLeft,i.scrollTop)}function qr(e,t){Math.abs(e.doc.scrollTop-t)<2||(fl||On(e,{top:t}),Zr(e,t,!0),fl&&On(e),Cn(e,100))}function Zr(e,t,r){t=Math.min(e.display.scroller.scrollHeight-e.display.scroller.clientHeight,t),(e.display.scroller.scrollTop!=t||r)&&(e.doc.scrollTop=t,e.display.scrollbars.setScrollTop(t),e.display.scroller.scrollTop!=t&&(e.display.scroller.scrollTop=t))}function Qr(e,t,r,n){t=Math.min(t,e.display.scroller.scrollWidth-e.display.scroller.clientWidth),(r?t==e.doc.scrollLeft:Math.abs(e.doc.scrollLeft-t)<2)&&!n||(e.doc.scrollLeft=t,zr(e),e.display.scroller.scrollLeft!=t&&(e.display.scroller.scrollLeft=t),e.display.scrollbars.setScrollLeft(t))}function Jr(e){var t=e.display,r=t.gutters.offsetWidth,n=Math.round(e.doc.height+Pt(e.display));return{clientHeight:t.scroller.clientHeight,viewHeight:t.wrapper.clientHeight,scrollWidth:t.scroller.scrollWidth,clientWidth:t.scroller.clientWidth,viewWidth:t.wrapper.clientWidth,barLeft:e.options.fixedGutter?r:0,docHeight:n,scrollHeight:n+zt(e)+t.barHeight,nativeBarWidth:t.nativeBarWidth,gutterWidth:r}}function en(e,t){t||(t=Jr(e));var r=e.display.barWidth,n=e.display.barHeight;tn(e,t);for(var i=0;i<4&&r!=e.display.barWidth||n!=e.display.barHeight;i++)r!=e.display.barWidth&&e.options.lineWrapping&&Er(e),tn(e,Jr(e)),r=e.display.barWidth,n=e.display.barHeight}function tn(e,t){var r=e.display,n=r.scrollbars.update(t);r.sizer.style.paddingRight=(r.barWidth=n.right)+"px",r.sizer.style.paddingBottom=(r.barHeight=n.bottom)+"px",r.heightForcer.style.borderBottom=n.bottom+"px solid transparent",n.right&&n.bottom?(r.scrollbarFiller.style.display="block",r.scrollbarFiller.style.height=n.bottom+"px",r.scrollbarFiller.style.width=n.right+"px"):r.scrollbarFiller.style.display="",n.bottom&&e.options.coverGutterNextToScrollbar&&e.options.fixedGutter?(r.gutterFiller.style.display="block",r.gutterFiller.style.height=n.bottom+"px",r.gutterFiller.style.width=t.gutterWidth+"px"):r.gutterFiller.style.display=""}function rn(e){e.display.scrollbars&&(e.display.scrollbars.clear(),e.display.scrollbars.addClass&&Fl(e.display.wrapper,e.display.scrollbars.addClass)),e.display.scrollbars=new ws[e.options.scrollbarStyle](function(t){e.display.wrapper.insertBefore(t,e.display.scrollbarFiller),Ql(t,"mousedown",function(){e.state.focused&&setTimeout(function(){return e.display.input.focus()},0)}),t.setAttribute("cm-not-content","true")},function(t,r){"horizontal"==r?Qr(e,t):qr(e,t)},e),e.display.scrollbars.addClass&&s(e.display.wrapper,e.display.scrollbars.addClass)}function nn(e){e.curOp={cm:e,viewChanged:!1,startHeight:e.doc.height,forceUpdate:!1,updateInput:null,typing:!1,changeObjs:null,cursorActivityHandlers:null,cursorActivityCalled:0,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,focus:!1,id:++xs},vt(e.curOp)}function on(e){yt(e.curOp,function(e){for(var t=0;t<e.ops.length;t++)e.ops[t].cm.curOp=null;ln(e)})}function ln(e){for(var t=e.ops,r=0;r<t.length;r++)sn(t[r]);for(var n=0;n<t.length;n++)an(t[n]);for(var i=0;i<t.length;i++)un(t[i]);for(var o=0;o<t.length;o++)cn(t[o]);for(var l=0;l<t.length;l++)fn(t[l])}function sn(e){var t=e.cm,r=t.display;Ln(t),e.updateMaxLine&&we(t),e.mustUpdate=e.viewChanged||e.forceUpdate||null!=e.scrollTop||e.scrollToPos&&(e.scrollToPos.from.line<r.viewFrom||e.scrollToPos.to.line>=r.viewTo)||r.maxLineChanged&&t.options.lineWrapping,e.update=e.mustUpdate&&new Cs(t,e.mustUpdate&&{top:e.scrollTop,ensure:e.scrollToPos},e.forceUpdate)}function an(e){e.updatedDisplay=e.mustUpdate&&Mn(e.cm,e.update)}function un(e){var t=e.cm,r=t.display;e.updatedDisplay&&Er(t),e.barMeasure=Jr(t),r.maxLineChanged&&!t.options.lineWrapping&&(e.adjustWidthTo=Kt(t,r.maxLine,r.maxLine.text.length).left+3,t.display.sizerWidth=e.adjustWidthTo,e.barMeasure.scrollWidth=Math.max(r.scroller.clientWidth,r.sizer.offsetLeft+e.adjustWidthTo+zt(t)+t.display.barWidth),e.maxScrollLeft=Math.max(0,r.sizer.offsetLeft+e.adjustWidthTo-Rt(t))),(e.updatedDisplay||e.selectionChanged)&&(e.preparedSelection=r.input.prepareSelection())}function cn(e){var t=e.cm;null!=e.adjustWidthTo&&(t.display.sizer.style.minWidth=e.adjustWidthTo+"px",e.maxScrollLeft<t.doc.scrollLeft&&Qr(t,Math.min(t.display.scroller.scrollLeft,e.maxScrollLeft),!0),t.display.maxLineChanged=!1);var r=e.focus&&e.focus==l();e.preparedSelection&&t.display.input.showSelection(e.preparedSelection,r),(e.updatedDisplay||e.startHeight!=t.doc.height)&&en(t,e.barMeasure),e.updatedDisplay&&Dn(t,e.barMeasure),e.selectionChanged&&Ar(t),t.state.focused&&e.updateInput&&t.display.input.reset(e.typing),r&&Wr(e.cm)}function fn(e){var t=e.cm,r=t.display,n=t.doc;e.updatedDisplay&&Nn(t,e.update),null==r.wheelStartX||null==e.scrollTop&&null==e.scrollLeft&&!e.scrollToPos||(r.wheelStartX=r.wheelStartY=null),null!=e.scrollTop&&Zr(t,e.scrollTop,e.forceScroll),null!=e.scrollLeft&&Qr(t,e.scrollLeft,!0,!0),e.scrollToPos&&Br(t,Gr(t,U(n,e.scrollToPos.from),U(n,e.scrollToPos.to),e.scrollToPos.margin));var i=e.maybeHiddenMarkers,o=e.maybeUnhiddenMarkers;if(i)for(var l=0;l<i.length;++l)i[l].lines.length||Te(i[l],"hide");if(o)for(var s=0;s<o.length;++s)o[s].lines.length&&Te(o[s],"unhide");r.wrapper.offsetHeight&&(n.scrollTop=t.display.scroller.scrollTop),e.changeObjs&&Te(t,"changes",t,e.changeObjs),e.update&&e.update.finish()}function hn(e,t){if(e.curOp)return t();nn(e);try{return t()}finally{on(e)}}function dn(e,t){return function(){if(e.curOp)return t.apply(e,arguments);nn(e);try{return t.apply(e,arguments)}finally{on(e)}}}function pn(e){return function(){if(this.curOp)return e.apply(this,arguments);nn(this);try{return e.apply(this,arguments)}finally{on(this)}}}function gn(e){return function(){var t=this.cm;if(!t||t.curOp)return e.apply(this,arguments);nn(t);try{return e.apply(this,arguments)}finally{on(t)}}}function vn(e,t,r,n){null==t&&(t=e.doc.first),null==r&&(r=e.doc.first+e.doc.size),n||(n=0);var i=e.display;if(n&&r<i.viewTo&&(null==i.updateLineNumbers||i.updateLineNumbers>t)&&(i.updateLineNumbers=t),e.curOp.viewChanged=!0,t>=i.viewTo)_l&&pe(e.doc,t)<i.viewTo&&yn(e);else if(r<=i.viewFrom)_l&&ge(e.doc,r+n)>i.viewFrom?yn(e):(i.viewFrom+=n,i.viewTo+=n);else if(t<=i.viewFrom&&r>=i.viewTo)yn(e);else if(t<=i.viewFrom){var o=bn(e,r,r+n,1);o?(i.view=i.view.slice(o.index),i.viewFrom=o.lineN,i.viewTo+=n):yn(e)}else if(r>=i.viewTo){var l=bn(e,t,t,-1);l?(i.view=i.view.slice(0,l.index),i.viewTo=l.lineN):yn(e)}else{var s=bn(e,t,t,-1),a=bn(e,r,r+n,1);s&&a?(i.view=i.view.slice(0,s.index).concat(gt(e,s.lineN,a.lineN)).concat(i.view.slice(a.index)),i.viewTo+=n):yn(e)}var u=i.externalMeasured;u&&(r<u.lineN?u.lineN+=n:t<u.lineN+u.size&&(i.externalMeasured=null))}function mn(e,t,r){e.curOp.viewChanged=!0;var n=e.display,i=e.display.externalMeasured;if(i&&t>=i.lineN&&t<i.lineN+i.size&&(n.externalMeasured=null),!(t<n.viewFrom||t>=n.viewTo)){var o=n.view[Lr(e,t)];if(null!=o.node){var l=o.changes||(o.changes=[]);-1==h(l,r)&&l.push(r)}}}function yn(e){e.display.viewFrom=e.display.viewTo=e.doc.first,e.display.view=[],e.display.viewOffset=0}function bn(e,t,r,n){var i,o=Lr(e,t),l=e.display.view;if(!_l||r==e.doc.first+e.doc.size)return{index:o,lineN:r};for(var s=e.display.viewFrom,a=0;a<o;a++)s+=l[a].size;if(s!=t){if(n>0){if(o==l.length-1)return null;i=s+l[o].size-t,o++}else i=s-t;t+=i,r+=i}for(;pe(e.doc,r)!=r;){if(o==(n<0?0:l.length-1))return null;r+=n*l[o-(n<0?1:0)].size,o+=n}return{index:o,lineN:r}}function wn(e,t,r){var n=e.display;0==n.view.length||t>=n.viewTo||r<=n.viewFrom?(n.view=gt(e,t,r),n.viewFrom=t):(n.viewFrom>t?n.view=gt(e,t,n.viewFrom).concat(n.view):n.viewFrom<t&&(n.view=n.view.slice(Lr(e,t))),n.viewFrom=t,n.viewTo<r?n.view=n.view.concat(gt(e,n.viewTo,r)):n.viewTo>r&&(n.view=n.view.slice(0,Lr(e,r)))),n.viewTo=r}function xn(e){for(var t=e.display.view,r=0,n=0;n<t.length;n++){var i=t[n];i.hidden||i.node&&!i.changes||++r}return r}function Cn(e,t){e.doc.highlightFrontier<e.display.viewTo&&e.state.highlight.set(t,u(Sn,e))}function Sn(e){var t=e.doc;if(!(t.highlightFrontier>=e.display.viewTo)){var r=+new Date+e.options.workTime,n=$e(e,t.highlightFrontier),i=[];t.iter(n.line,Math.min(t.first+t.size,e.display.viewTo+500),function(o){if(n.line>=e.display.viewFrom){var l=o.styles,s=o.text.length>e.options.maxHighlightLength?Ke(t.mode,n.state):null,a=Ye(e,o,n,!0);s&&(n.state=s),o.styles=a.styles;var u=o.styleClasses,c=a.classes;c?o.styleClasses=c:u&&(o.styleClasses=null);for(var f=!l||l.length!=o.styles.length||u!=c&&(!u||!c||u.bgClass!=c.bgClass||u.textClass!=c.textClass),h=0;!f&&h<l.length;++h)f=l[h]!=o.styles[h];f&&i.push(n.line),o.stateAfter=n.save(),n.nextLine()}else o.text.length<=e.options.maxHighlightLength&&qe(e,o.text,n),o.stateAfter=n.line%5==0?n.save():null,n.nextLine();if(+new Date>r)return Cn(e,e.options.workDelay),!0}),t.highlightFrontier=n.line,t.modeFrontier=Math.max(t.modeFrontier,n.line),i.length&&hn(e,function(){for(var t=0;t<i.length;t++)mn(e,i[t],"text")})}}function Ln(e){var t=e.display;!t.scrollbarsClipped&&t.scroller.offsetWidth&&(t.nativeBarWidth=t.scroller.offsetWidth-t.scroller.clientWidth,t.heightForcer.style.height=zt(e)+"px",t.sizer.style.marginBottom=-t.nativeBarWidth+"px",t.sizer.style.borderRightWidth=zt(e)+"px",t.scrollbarsClipped=!0)}function kn(e){if(e.hasFocus())return null;var t=l();if(!t||!o(e.display.lineDiv,t))return null;var r={activeElt:t};if(window.getSelection){var n=window.getSelection();n.anchorNode&&n.extend&&o(e.display.lineDiv,n.anchorNode)&&(r.anchorNode=n.anchorNode,r.anchorOffset=n.anchorOffset,r.focusNode=n.focusNode,r.focusOffset=n.focusOffset)}return r}function Tn(e){if(e&&e.activeElt&&e.activeElt!=l()&&(e.activeElt.focus(),e.anchorNode&&o(document.body,e.anchorNode)&&o(document.body,e.focusNode))){var t=window.getSelection(),r=document.createRange();r.setEnd(e.anchorNode,e.anchorOffset),r.collapse(!1),t.removeAllRanges(),t.addRange(r),t.extend(e.focusNode,e.focusOffset)}}function Mn(e,r){var n=e.display,i=e.doc;if(r.editorIsHidden)return yn(e),!1;if(!r.force&&r.visible.from>=n.viewFrom&&r.visible.to<=n.viewTo&&(null==n.updateLineNumbers||n.updateLineNumbers>=n.viewTo)&&n.renderedView==n.view&&0==xn(e))return!1;Rr(e)&&(yn(e),r.dims=br(e));var o=i.first+i.size,l=Math.max(r.visible.from-e.options.viewportMargin,i.first),s=Math.min(o,r.visible.to+e.options.viewportMargin);n.viewFrom<l&&l-n.viewFrom<20&&(l=Math.max(i.first,n.viewFrom)),n.viewTo>s&&n.viewTo-s<20&&(s=Math.min(o,n.viewTo)),_l&&(l=pe(e.doc,l),s=ge(e.doc,s));var a=l!=n.viewFrom||s!=n.viewTo||n.lastWrapHeight!=r.wrapperHeight||n.lastWrapWidth!=r.wrapperWidth;wn(e,l,s),n.viewOffset=ye(M(e.doc,n.viewFrom)),e.display.mover.style.top=n.viewOffset+"px";var u=xn(e);if(!a&&0==u&&!r.force&&n.renderedView==n.view&&(null==n.updateLineNumbers||n.updateLineNumbers>=n.viewTo))return!1;var c=kn(e);return u>4&&(n.lineDiv.style.display="none"),An(e,n.updateLineNumbers,r.dims),u>4&&(n.lineDiv.style.display=""),n.renderedView=n.view,Tn(c),t(n.cursorDiv),t(n.selectionDiv),n.gutters.style.height=n.sizer.style.minHeight=0,a&&(n.lastWrapHeight=r.wrapperHeight,n.lastWrapWidth=r.wrapperWidth,Cn(e,400)),n.updateLineNumbers=null,!0}function Nn(e,t){for(var r=t.viewport,n=!0;(n&&e.options.lineWrapping&&t.oldDisplayWidth!=Rt(e)||(r&&null!=r.top&&(r={top:Math.min(e.doc.height+Pt(e.display)-Bt(e),r.top)}),t.visible=Ir(e.display,e.doc,r),!(t.visible.from>=e.display.viewFrom&&t.visible.to<=e.display.viewTo)))&&Mn(e,t);n=!1){Er(e);var i=Jr(e);kr(e),en(e,i),Dn(e,i),t.force=!1}t.signal(e,"update",e),e.display.viewFrom==e.display.reportedViewFrom&&e.display.viewTo==e.display.reportedViewTo||(t.signal(e,"viewportChange",e,e.display.viewFrom,e.display.viewTo),e.display.reportedViewFrom=e.display.viewFrom,e.display.reportedViewTo=e.display.viewTo)}function On(e,t){var r=new Cs(e,t);if(Mn(e,r)){Er(e),Nn(e,r);var n=Jr(e);kr(e),en(e,n),Dn(e,n),r.finish()}}function An(e,r,n){function i(t){var r=t.nextSibling;return ml&&Ml&&e.display.currentWheelTarget==t?t.style.display="none":t.parentNode.removeChild(t),r}for(var o=e.display,l=e.options.lineNumbers,s=o.lineDiv,a=s.firstChild,u=o.view,c=o.viewFrom,f=0;f<u.length;f++){var d=u[f];if(d.hidden);else if(d.node&&d.node.parentNode==s){for(;a!=d.node;)a=i(a);var p=l&&null!=r&&r<=c&&d.lineNumber;d.changes&&(h(d.changes,"gutter")>-1&&(p=!1),xt(e,d,c,n)),p&&(t(d.lineNumber),d.lineNumber.appendChild(document.createTextNode(F(e.options,c)))),a=d.node.nextSibling}else{var g=Ot(e,d,c,n);s.insertBefore(g,a)}c+=d.size}for(;a;)a=i(a)}function Wn(e){var t=e.display.gutters.offsetWidth;e.display.sizer.style.marginLeft=t+"px"}function Dn(e,t){e.display.sizer.style.minHeight=t.docHeight+"px",e.display.heightForcer.style.top=t.docHeight+"px",e.display.gutters.style.height=t.docHeight+e.display.barHeight+zt(e)+"px"}function Hn(e){var r=e.display.gutters,i=e.options.gutters;t(r);for(var o=0;o<i.length;++o){var l=i[o],s=r.appendChild(n("div",null,"CodeMirror-gutter "+l));"CodeMirror-linenumbers"==l&&(e.display.lineGutter=s,s.style.width=(e.display.lineNumWidth||1)+"px")}r.style.display=o?"":"none",Wn(e)}function Fn(e){var t=h(e.gutters,"CodeMirror-linenumbers");-1==t&&e.lineNumbers?e.gutters=e.gutters.concat(["CodeMirror-linenumbers"]):t>-1&&!e.lineNumbers&&(e.gutters=e.gutters.slice(0),e.gutters.splice(t,1))}function En(e){var t=e.wheelDeltaX,r=e.wheelDeltaY;return null==t&&e.detail&&e.axis==e.HORIZONTAL_AXIS&&(t=e.detail),null==r&&e.detail&&e.axis==e.VERTICAL_AXIS?r=e.detail:null==r&&(r=e.wheelDelta),{x:t,y:r}}function Pn(e){var t=En(e);return t.x*=Ls,t.y*=Ls,t}function In(e,t){var r=En(t),n=r.x,i=r.y,o=e.display,l=o.scroller,s=l.scrollWidth>l.clientWidth,a=l.scrollHeight>l.clientHeight;if(n&&s||i&&a){if(i&&Ml&&ml)e:for(var u=t.target,c=o.view;u!=l;u=u.parentNode)for(var f=0;f<c.length;f++)if(c[f].node==u){e.display.currentWheelTarget=u;break e}if(n&&!fl&&!wl&&null!=Ls)return i&&a&&qr(e,Math.max(0,l.scrollTop+i*Ls)),Qr(e,Math.max(0,l.scrollLeft+n*Ls)),(!i||i&&a)&&We(t),void(o.wheelStartX=null);if(i&&null!=Ls){var h=i*Ls,d=e.doc.scrollTop,p=d+o.wrapper.clientHeight;h<0?d=Math.max(0,d+h-50):p=Math.min(e.doc.height,p+h+50),On(e,{top:d,bottom:p})}Ss<20&&(null==o.wheelStartX?(o.wheelStartX=l.scrollLeft,o.wheelStartY=l.scrollTop,o.wheelDX=n,o.wheelDY=i,setTimeout(function(){if(null!=o.wheelStartX){var e=l.scrollLeft-o.wheelStartX,t=l.scrollTop-o.wheelStartY,r=t&&o.wheelDY&&t/o.wheelDY||e&&o.wheelDX&&e/o.wheelDX;o.wheelStartX=o.wheelStartY=null,r&&(Ls=(Ls*Ss+r)/(Ss+1),++Ss)}},200)):(o.wheelDX+=n,o.wheelDY+=i))}}function zn(e,t){var r=e[t];e.sort(function(e,t){return P(e.from(),t.from())}),t=h(e,r);for(var n=1;n<e.length;n++){var i=e[n],o=e[n-1];if(P(o.to(),i.from())>=0){var l=B(o.from(),i.from()),s=R(o.to(),i.to()),a=o.empty()?i.from()==i.head:o.from()==o.head;n<=t&&--t,e.splice(--n,2,new Ts(a?s:l,a?l:s))}}return new ks(e,t)}function Rn(e,t){return new ks([new Ts(e,t||e)],0)}function Bn(e){return e.text?E(e.from.line+e.text.length-1,g(e.text).length+(1==e.text.length?e.from.ch:0)):e.to}function Gn(e,t){if(P(e,t.from)<0)return e;if(P(e,t.to)<=0)return Bn(t);var r=e.line+t.text.length-(t.to.line-t.from.line)-1,n=e.ch;return e.line==t.to.line&&(n+=Bn(t).ch-t.to.ch),E(r,n)}function Un(e,t){for(var r=[],n=0;n<e.sel.ranges.length;n++){var i=e.sel.ranges[n];r.push(new Ts(Gn(i.anchor,t),Gn(i.head,t)))}return zn(r,e.sel.primIndex)}function Vn(e,t,r){return e.line==t.line?E(r.line,e.ch-t.ch+r.ch):E(r.line+(e.line-t.line),e.ch)}function Kn(e,t,r){for(var n=[],i=E(e.first,0),o=i,l=0;l<t.length;l++){var s=t[l],a=Vn(s.from,i,o),u=Vn(Bn(s),i,o);if(i=s.to,o=u,"around"==r){var c=e.sel.ranges[l],f=P(c.head,c.anchor)<0;n[l]=new Ts(f?u:a,f?a:u)}else n[l]=new Ts(a,a)}return new ks(n,e.sel.primIndex)}function jn(e){e.doc.mode=Ue(e.options,e.doc.modeOption),Xn(e)}function Xn(e){e.doc.iter(function(e){e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null)}),e.doc.modeFrontier=e.doc.highlightFrontier=e.doc.first,Cn(e,100),e.state.modeGen++,e.curOp&&vn(e)}function Yn(e,t){return 0==t.from.ch&&0==t.to.ch&&""==g(t.text)&&(!e.cm||e.cm.options.wholeLineUpdateBefore)}function _n(e,t,r,n){function i(e){return r?r[e]:null}function o(e,r,i){it(e,r,i,n),bt(e,"change",e,t)}function l(e,t){for(var r=[],o=e;o<t;++o)r.push(new fs(u[o],i(o),n));return r}var s=t.from,a=t.to,u=t.text,c=M(e,s.line),f=M(e,a.line),h=g(u),d=i(u.length-1),p=a.line-s.line;if(t.full)e.insert(0,l(0,u.length)),e.remove(u.length,e.size-u.length);else if(Yn(e,t)){var v=l(0,u.length-1);o(f,f.text,d),p&&e.remove(s.line,p),v.length&&e.insert(s.line,v)}else if(c==f)if(1==u.length)o(c,c.text.slice(0,s.ch)+h+c.text.slice(a.ch),d);else{var m=l(1,u.length-1);m.push(new fs(h+c.text.slice(a.ch),d,n)),o(c,c.text.slice(0,s.ch)+u[0],i(0)),e.insert(s.line+1,m)}else if(1==u.length)o(c,c.text.slice(0,s.ch)+u[0]+f.text.slice(a.ch),i(0)),e.remove(s.line+1,p);else{o(c,c.text.slice(0,s.ch)+u[0],i(0)),o(f,h+f.text.slice(a.ch),d);var y=l(1,u.length-1);p>1&&e.remove(s.line+1,p-1),e.insert(s.line+1,y)}bt(e,"change",e,t)}function $n(e,t,r){function n(e,i,o){if(e.linked)for(var l=0;l<e.linked.length;++l){var s=e.linked[l];if(s.doc!=i){var a=o&&s.sharedHist;r&&!a||(t(s.doc,a),n(s.doc,e,a))}}}n(e,null,!0)}function qn(e,t){if(t.cm)throw new Error("This document is already in use.");e.doc=t,t.cm=e,Cr(e),jn(e),Zn(e),e.options.lineWrapping||we(e),e.options.mode=t.modeOption,vn(e)}function Zn(e){("rtl"==e.doc.direction?s:Fl)(e.display.lineDiv,"CodeMirror-rtl")}function Qn(e){hn(e,function(){Zn(e),vn(e)})}function Jn(e){this.done=[],this.undone=[],this.undoDepth=1/0,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=e||1}function ei(e,t){var r={from:z(t.from),to:Bn(t),text:N(e,t.from,t.to)};return si(e,r,t.from.line,t.to.line+1),$n(e,function(e){return si(e,r,t.from.line,t.to.line+1)},!0),r}function ti(e){for(;e.length&&g(e).ranges;)e.pop()}function ri(e,t){return t?(ti(e.done),g(e.done)):e.done.length&&!g(e.done).ranges?g(e.done):e.done.length>1&&!e.done[e.done.length-2].ranges?(e.done.pop(),g(e.done)):void 0}function ni(e,t,r,n){var i=e.history;i.undone.length=0;var o,l,s=+new Date;if((i.lastOp==n||i.lastOrigin==t.origin&&t.origin&&("+"==t.origin.charAt(0)&&e.cm&&i.lastModTime>s-e.cm.options.historyEventDelay||"*"==t.origin.charAt(0)))&&(o=ri(i,i.lastOp==n)))l=g(o.changes),0==P(t.from,t.to)&&0==P(t.from,l.to)?l.to=Bn(t):o.changes.push(ei(e,t));else{var a=g(i.done);for(a&&a.ranges||li(e.sel,i.done),o={changes:[ei(e,t)],generation:i.generation},i.done.push(o);i.done.length>i.undoDepth;)i.done.shift(),i.done[0].ranges||i.done.shift()}i.done.push(r),i.generation=++i.maxGeneration,i.lastModTime=i.lastSelTime=s,i.lastOp=i.lastSelOp=n,i.lastOrigin=i.lastSelOrigin=t.origin,l||Te(e,"historyAdded")}function ii(e,t,r,n){var i=t.charAt(0);return"*"==i||"+"==i&&r.ranges.length==n.ranges.length&&r.somethingSelected()==n.somethingSelected()&&new Date-e.history.lastSelTime<=(e.cm?e.cm.options.historyEventDelay:500)}function oi(e,t,r,n){var i=e.history,o=n&&n.origin;r==i.lastSelOp||o&&i.lastSelOrigin==o&&(i.lastModTime==i.lastSelTime&&i.lastOrigin==o||ii(e,o,g(i.done),t))?i.done[i.done.length-1]=t:li(t,i.done),i.lastSelTime=+new Date,i.lastSelOrigin=o,i.lastSelOp=r,n&&!1!==n.clearRedo&&ti(i.undone)}function li(e,t){var r=g(t);r&&r.ranges&&r.equals(e)||t.push(e)}function si(e,t,r,n){var i=t["spans_"+e.id],o=0;e.iter(Math.max(e.first,r),Math.min(e.first+e.size,n),function(r){r.markedSpans&&((i||(i=t["spans_"+e.id]={}))[o]=r.markedSpans),++o})}function ai(e){if(!e)return null;for(var t,r=0;r<e.length;++r)e[r].marker.explicitlyCleared?t||(t=e.slice(0,r)):t&&t.push(e[r]);return t?t.length?t:null:e}function ui(e,t){var r=t["spans_"+e.id];if(!r)return null;for(var n=[],i=0;i<t.text.length;++i)n.push(ai(r[i]));return n}function ci(e,t){var r=ui(e,t),n=J(e,t);if(!r)return n;if(!n)return r;for(var i=0;i<r.length;++i){var o=r[i],l=n[i];if(o&&l)e:for(var s=0;s<l.length;++s){for(var a=l[s],u=0;u<o.length;++u)if(o[u].marker==a.marker)continue e;o.push(a)}else l&&(r[i]=l)}return r}function fi(e,t,r){for(var n=[],i=0;i<e.length;++i){var o=e[i];if(o.ranges)n.push(r?ks.prototype.deepCopy.call(o):o);else{var l=o.changes,s=[];n.push({changes:s});for(var a=0;a<l.length;++a){var u=l[a],c=void 0;if(s.push({from:u.from,to:u.to,text:u.text}),t)for(var f in u)(c=f.match(/^spans_(\d+)$/))&&h(t,Number(c[1]))>-1&&(g(s)[f]=u[f],delete u[f])}}}return n}function hi(e,t,r,n){if(n){var i=e.anchor;if(r){var o=P(t,i)<0;o!=P(r,i)<0?(i=t,t=r):o!=P(t,r)<0&&(t=r)}return new Ts(i,t)}return new Ts(r||t,t)}function di(e,t,r,n,i){null==i&&(i=e.cm&&(e.cm.display.shift||e.extend)),bi(e,new ks([hi(e.sel.primary(),t,r,i)],0),n)}function pi(e,t,r){for(var n=[],i=e.cm&&(e.cm.display.shift||e.extend),o=0;o<e.sel.ranges.length;o++)n[o]=hi(e.sel.ranges[o],t[o],null,i);bi(e,zn(n,e.sel.primIndex),r)}function gi(e,t,r,n){var i=e.sel.ranges.slice(0);i[t]=r,bi(e,zn(i,e.sel.primIndex),n)}function vi(e,t,r,n){bi(e,Rn(t,r),n)}function mi(e,t,r){var n={ranges:t.ranges,update:function(t){var r=this;this.ranges=[];for(var n=0;n<t.length;n++)r.ranges[n]=new Ts(U(e,t[n].anchor),U(e,t[n].head))},origin:r&&r.origin};return Te(e,"beforeSelectionChange",e,n),e.cm&&Te(e.cm,"beforeSelectionChange",e.cm,n),n.ranges!=t.ranges?zn(n.ranges,n.ranges.length-1):t}function yi(e,t,r){var n=e.history.done,i=g(n);i&&i.ranges?(n[n.length-1]=t,wi(e,t,r)):bi(e,t,r)}function bi(e,t,r){wi(e,t,r),oi(e,e.sel,e.cm?e.cm.curOp.id:NaN,r)}function wi(e,t,r){(Oe(e,"beforeSelectionChange")||e.cm&&Oe(e.cm,"beforeSelectionChange"))&&(t=mi(e,t,r)),xi(e,Si(e,t,r&&r.bias||(P(t.primary().head,e.sel.primary().head)<0?-1:1),!0)),r&&!1===r.scroll||!e.cm||jr(e.cm)}function xi(e,t){t.equals(e.sel)||(e.sel=t,e.cm&&(e.cm.curOp.updateInput=e.cm.curOp.selectionChanged=!0,Ne(e.cm)),bt(e,"cursorActivity",e))}function Ci(e){xi(e,Si(e,e.sel,null,!1))}function Si(e,t,r,n){for(var i,o=0;o<t.ranges.length;o++){var l=t.ranges[o],s=t.ranges.length==e.sel.ranges.length&&e.sel.ranges[o],a=ki(e,l.anchor,s&&s.anchor,r,n),u=ki(e,l.head,s&&s.head,r,n);(i||a!=l.anchor||u!=l.head)&&(i||(i=t.ranges.slice(0,o)),i[o]=new Ts(a,u))}return i?zn(i,t.primIndex):t}function Li(e,t,r,n,i){var o=M(e,t.line);if(o.markedSpans)for(var l=0;l<o.markedSpans.length;++l){var s=o.markedSpans[l],a=s.marker;if((null==s.from||(a.inclusiveLeft?s.from<=t.ch:s.from<t.ch))&&(null==s.to||(a.inclusiveRight?s.to>=t.ch:s.to>t.ch))){if(i&&(Te(a,"beforeCursorEnter"),a.explicitlyCleared)){if(o.markedSpans){--l;continue}break}if(!a.atomic)continue;if(r){var u=a.find(n<0?1:-1),c=void 0;if((n<0?a.inclusiveRight:a.inclusiveLeft)&&(u=Ti(e,u,-n,u&&u.line==t.line?o:null)),u&&u.line==t.line&&(c=P(u,r))&&(n<0?c<0:c>0))return Li(e,u,t,n,i)}var f=a.find(n<0?-1:1);return(n<0?a.inclusiveLeft:a.inclusiveRight)&&(f=Ti(e,f,n,f.line==t.line?o:null)),f?Li(e,f,t,n,i):null}}return t}function ki(e,t,r,n,i){var o=n||1,l=Li(e,t,r,o,i)||!i&&Li(e,t,r,o,!0)||Li(e,t,r,-o,i)||!i&&Li(e,t,r,-o,!0);return l||(e.cantEdit=!0,E(e.first,0))}function Ti(e,t,r,n){return r<0&&0==t.ch?t.line>e.first?U(e,E(t.line-1)):null:r>0&&t.ch==(n||M(e,t.line)).text.length?t.line<e.first+e.size-1?E(t.line+1,0):null:new E(t.line,t.ch+r)}function Mi(e){e.setSelection(E(e.firstLine(),0),E(e.lastLine()),Gl)}function Ni(e,t,r){var n={canceled:!1,from:t.from,to:t.to,text:t.text,origin:t.origin,cancel:function(){return n.canceled=!0}};return r&&(n.update=function(t,r,i,o){t&&(n.from=U(e,t)),r&&(n.to=U(e,r)),i&&(n.text=i),void 0!==o&&(n.origin=o)}),Te(e,"beforeChange",e,n),e.cm&&Te(e.cm,"beforeChange",e.cm,n),n.canceled?null:{from:n.from,to:n.to,text:n.text,origin:n.origin}}function Oi(e,t,r){if(e.cm){if(!e.cm.curOp)return dn(e.cm,Oi)(e,t,r);if(e.cm.state.suppressEdits)return}if(!(Oe(e,"beforeChange")||e.cm&&Oe(e.cm,"beforeChange"))||(t=Ni(e,t,!0))){var n=Yl&&!r&&te(e,t.from,t.to);if(n)for(var i=n.length-1;i>=0;--i)Ai(e,{from:n[i].from,to:n[i].to,text:i?[""]:t.text,origin:t.origin});else Ai(e,t)}}function Ai(e,t){if(1!=t.text.length||""!=t.text[0]||0!=P(t.from,t.to)){var r=Un(e,t);ni(e,t,r,e.cm?e.cm.curOp.id:NaN),Hi(e,t,r,J(e,t));var n=[];$n(e,function(e,r){r||-1!=h(n,e.history)||(zi(e.history,t),n.push(e.history)),Hi(e,t,null,J(e,t))})}}function Wi(e,t,r){if(!e.cm||!e.cm.state.suppressEdits||r){for(var n,i=e.history,o=e.sel,l="undo"==t?i.done:i.undone,s="undo"==t?i.undone:i.done,a=0;a<l.length&&(n=l[a],r?!n.ranges||n.equals(e.sel):n.ranges);a++);if(a!=l.length){for(i.lastOrigin=i.lastSelOrigin=null;(n=l.pop()).ranges;){if(li(n,s),r&&!n.equals(e.sel))return void bi(e,n,{clearRedo:!1});o=n}var u=[];li(o,s),s.push({changes:u,generation:i.generation}),i.generation=n.generation||++i.maxGeneration;for(var c=Oe(e,"beforeChange")||e.cm&&Oe(e.cm,"beforeChange"),f=n.changes.length-1;f>=0;--f){var d=function(r){var i=n.changes[r];if(i.origin=t,c&&!Ni(e,i,!1))return l.length=0,{};u.push(ei(e,i));var o=r?Un(e,i):g(l);Hi(e,i,o,ci(e,i)),!r&&e.cm&&e.cm.scrollIntoView({from:i.from,to:Bn(i)});var s=[];$n(e,function(e,t){t||-1!=h(s,e.history)||(zi(e.history,i),s.push(e.history)),Hi(e,i,null,ci(e,i))})}(f);if(d)return d.v}}}}function Di(e,t){if(0!=t&&(e.first+=t,e.sel=new ks(v(e.sel.ranges,function(e){return new Ts(E(e.anchor.line+t,e.anchor.ch),E(e.head.line+t,e.head.ch))}),e.sel.primIndex),e.cm)){vn(e.cm,e.first,e.first-t,t);for(var r=e.cm.display,n=r.viewFrom;n<r.viewTo;n++)mn(e.cm,n,"gutter")}}function Hi(e,t,r,n){if(e.cm&&!e.cm.curOp)return dn(e.cm,Hi)(e,t,r,n);if(t.to.line<e.first)Di(e,t.text.length-1-(t.to.line-t.from.line));else if(!(t.from.line>e.lastLine())){if(t.from.line<e.first){var i=t.text.length-1-(e.first-t.from.line);Di(e,i),t={from:E(e.first,0),to:E(t.to.line+i,t.to.ch),text:[g(t.text)],origin:t.origin}}var o=e.lastLine();t.to.line>o&&(t={from:t.from,to:E(o,M(e,o).text.length),text:[t.text[0]],origin:t.origin}),t.removed=N(e,t.from,t.to),r||(r=Un(e,t)),e.cm?Fi(e.cm,t,n):_n(e,t,n),wi(e,r,Gl)}}function Fi(e,t,r){var n=e.doc,i=e.display,o=t.from,l=t.to,s=!1,a=o.line;e.options.lineWrapping||(a=W(fe(M(n,o.line))),n.iter(a,l.line+1,function(e){if(e==i.maxLine)return s=!0,!0})),n.sel.contains(t.from,t.to)>-1&&Ne(e),_n(n,t,r,xr(e)),e.options.lineWrapping||(n.iter(a,o.line+t.text.length,function(e){var t=be(e);t>i.maxLineLength&&(i.maxLine=e,i.maxLineLength=t,i.maxLineChanged=!0,s=!1)}),s&&(e.curOp.updateMaxLine=!0)),nt(n,o.line),Cn(e,400);var u=t.text.length-(l.line-o.line)-1;t.full?vn(e):o.line!=l.line||1!=t.text.length||Yn(e.doc,t)?vn(e,o.line,l.line+1,u):mn(e,o.line,"text");var c=Oe(e,"changes"),f=Oe(e,"change");if(f||c){var h={from:o,to:l,text:t.text,removed:t.removed,origin:t.origin};f&&bt(e,"change",e,h),c&&(e.curOp.changeObjs||(e.curOp.changeObjs=[])).push(h)}e.display.selForContextMenu=null}function Ei(e,t,r,n,i){if(n||(n=r),P(n,r)<0){var o;r=(o=[n,r])[0],n=o[1]}"string"==typeof t&&(t=e.splitLines(t)),Oi(e,{from:r,to:n,text:t,origin:i})}function Pi(e,t,r,n){r<e.line?e.line+=n:t<e.line&&(e.line=t,e.ch=0)}function Ii(e,t,r,n){for(var i=0;i<e.length;++i){var o=e[i],l=!0;if(o.ranges){o.copied||((o=e[i]=o.deepCopy()).copied=!0);for(var s=0;s<o.ranges.length;s++)Pi(o.ranges[s].anchor,t,r,n),Pi(o.ranges[s].head,t,r,n)}else{for(var a=0;a<o.changes.length;++a){var u=o.changes[a];if(r<u.from.line)u.from=E(u.from.line+n,u.from.ch),u.to=E(u.to.line+n,u.to.ch);else if(t<=u.to.line){l=!1;break}}l||(e.splice(0,i+1),i=0)}}}function zi(e,t){var r=t.from.line,n=t.to.line,i=t.text.length-(n-r)-1;Ii(e.done,r,n,i),Ii(e.undone,r,n,i)}function Ri(e,t,r,n){var i=t,o=t;return"number"==typeof t?o=M(e,G(e,t)):i=W(t),null==i?null:(n(o,i)&&e.cm&&mn(e.cm,i,r),o)}function Bi(e){var t=this;this.lines=e,this.parent=null;for(var r=0,n=0;n<e.length;++n)e[n].parent=t,r+=e[n].height;this.height=r}function Gi(e){var t=this;this.children=e;for(var r=0,n=0,i=0;i<e.length;++i){var o=e[i];r+=o.chunkSize(),n+=o.height,o.parent=t}this.size=r,this.height=n,this.parent=null}function Ui(e,t,r){ye(t)<(e.curOp&&e.curOp.scrollTop||e.doc.scrollTop)&&Kr(e,r)}function Vi(e,t,r,n){var i=new Ms(e,r,n),o=e.cm;return o&&i.noHScroll&&(o.display.alignWidgets=!0),Ri(e,t,"widget",function(t){var r=t.widgets||(t.widgets=[]);if(null==i.insertAt?r.push(i):r.splice(Math.min(r.length-1,Math.max(0,i.insertAt)),0,i),i.line=t,o&&!ve(e,t)){var n=ye(t)<e.scrollTop;A(t,t.height+Ht(i)),n&&Kr(o,i.height),o.curOp.forceUpdate=!0}return!0}),bt(o,"lineWidgetAdded",o,i,"number"==typeof t?t:W(t)),i}function Ki(e,t,r,n,o){if(n&&n.shared)return ji(e,t,r,n,o);if(e.cm&&!e.cm.curOp)return dn(e.cm,Ki)(e,t,r,n,o);var l=new Os(e,o),s=P(t,r);if(n&&c(n,l,!1),s>0||0==s&&!1!==l.clearWhenEmpty)return l;if(l.replacedWith&&(l.collapsed=!0,l.widgetNode=i("span",[l.replacedWith],"CodeMirror-widget"),n.handleMouseEvents||l.widgetNode.setAttribute("cm-ignore-events","true"),n.insertLeft&&(l.widgetNode.insertLeft=!0)),l.collapsed){if(ce(e,t.line,t,r,l)||t.line!=r.line&&ce(e,r.line,t,r,l))throw new Error("Inserting collapsed marker partially overlapping an existing one");X()}l.addToHistory&&ni(e,{from:t,to:r,origin:"markText"},e.sel,NaN);var a,u=t.line,f=e.cm;if(e.iter(u,r.line+1,function(e){f&&l.collapsed&&!f.options.lineWrapping&&fe(e)==f.display.maxLine&&(a=!0),l.collapsed&&u!=t.line&&A(e,0),q(e,new Y(l,u==t.line?t.ch:null,u==r.line?r.ch:null)),++u}),l.collapsed&&e.iter(t.line,r.line+1,function(t){ve(e,t)&&A(t,0)}),l.clearOnEnter&&Ql(l,"beforeCursorEnter",function(){return l.clear()}),l.readOnly&&(j(),(e.history.done.length||e.history.undone.length)&&e.clearHistory()),l.collapsed&&(l.id=++Ns,l.atomic=!0),f){if(a&&(f.curOp.updateMaxLine=!0),l.collapsed)vn(f,t.line,r.line+1);else if(l.className||l.title||l.startStyle||l.endStyle||l.css)for(var h=t.line;h<=r.line;h++)mn(f,h,"text");l.atomic&&Ci(f.doc),bt(f,"markerAdded",f,l)}return l}function ji(e,t,r,n,i){(n=c(n)).shared=!1;var o=[Ki(e,t,r,n,i)],l=o[0],s=n.widgetNode;return $n(e,function(e){s&&(n.widgetNode=s.cloneNode(!0)),o.push(Ki(e,U(e,t),U(e,r),n,i));for(var a=0;a<e.linked.length;++a)if(e.linked[a].isParent)return;l=g(o)}),new As(o,l)}function Xi(e){return e.findMarks(E(e.first,0),e.clipPos(E(e.lastLine())),function(e){return e.parent})}function Yi(e,t){for(var r=0;r<t.length;r++){var n=t[r],i=n.find(),o=e.clipPos(i.from),l=e.clipPos(i.to);if(P(o,l)){var s=Ki(e,o,l,n.primary,n.primary.type);n.markers.push(s),s.parent=n}}}function _i(e){for(var t=0;t<e.length;t++)!function(t){var r=e[t],n=[r.primary.doc];$n(r.primary.doc,function(e){return n.push(e)});for(var i=0;i<r.markers.length;i++){var o=r.markers[i];-1==h(n,o.doc)&&(o.parent=null,r.markers.splice(i--,1))}}(t)}function $i(e){var t=this;if(Qi(t),!Me(t,e)&&!Ft(t.display,e)){We(e),gl&&(Hs=+new Date);var r=Sr(t,e,!0),n=e.dataTransfer.files;if(r&&!t.isReadOnly())if(n&&n.length&&window.FileReader&&window.File)for(var i=n.length,o=Array(i),l=0,s=0;s<i;++s)!function(e,n){if(!t.options.allowDropFileTypes||-1!=h(t.options.allowDropFileTypes,e.type)){var s=new FileReader;s.onload=dn(t,function(){var e=s.result;if(/[\x00-\x08\x0e-\x1f]{2}/.test(e)&&(e=""),o[n]=e,++l==i){var a={from:r=U(t.doc,r),to:r,text:t.doc.splitLines(o.join(t.doc.lineSeparator())),origin:"paste"};Oi(t.doc,a),yi(t.doc,Rn(r,Bn(a)))}}),s.readAsText(e)}}(n[s],s);else{if(t.state.draggingText&&t.doc.sel.contains(r)>-1)return t.state.draggingText(e),void setTimeout(function(){return t.display.input.focus()},20);try{var a=e.dataTransfer.getData("Text");if(a){var u;if(t.state.draggingText&&!t.state.draggingText.copy&&(u=t.listSelections()),wi(t.doc,Rn(r,r)),u)for(var c=0;c<u.length;++c)Ei(t.doc,"",u[c].anchor,u[c].head,"drag");t.replaceSelection(a,"around","paste"),t.display.input.focus()}}catch(e){}}}}function qi(e,t){if(gl&&(!e.state.draggingText||+new Date-Hs<100))Fe(t);else if(!Me(e,t)&&!Ft(e.display,t)&&(t.dataTransfer.setData("Text",e.getSelection()),t.dataTransfer.effectAllowed="copyMove",t.dataTransfer.setDragImage&&!xl)){var r=n("img",null,null,"position: fixed; left: 0; top: 0;");r.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",wl&&(r.width=r.height=1,e.display.wrapper.appendChild(r),r._top=r.offsetTop),t.dataTransfer.setDragImage(r,0,0),wl&&r.parentNode.removeChild(r)}}function Zi(e,t){var i=Sr(e,t);if(i){var o=document.createDocumentFragment();Mr(e,i,o),e.display.dragCursor||(e.display.dragCursor=n("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),e.display.lineSpace.insertBefore(e.display.dragCursor,e.display.cursorDiv)),r(e.display.dragCursor,o)}}function Qi(e){e.display.dragCursor&&(e.display.lineSpace.removeChild(e.display.dragCursor),e.display.dragCursor=null)}function Ji(e){if(document.getElementsByClassName)for(var t=document.getElementsByClassName("CodeMirror"),r=0;r<t.length;r++){var n=t[r].CodeMirror;n&&e(n)}}function eo(){Fs||(to(),Fs=!0)}function to(){var e;Ql(window,"resize",function(){null==e&&(e=setTimeout(function(){e=null,Ji(ro)},100))}),Ql(window,"blur",function(){return Ji(Fr)})}function ro(e){var t=e.display;t.lastWrapHeight==t.wrapper.clientHeight&&t.lastWrapWidth==t.wrapper.clientWidth||(t.cachedCharWidth=t.cachedTextHeight=t.cachedPaddingH=null,t.scrollbarsClipped=!1,e.setSize())}function no(e){var t=e.split(/-(?!$)/);e=t[t.length-1];for(var r,n,i,o,l=0;l<t.length-1;l++){var s=t[l];if(/^(cmd|meta|m)$/i.test(s))o=!0;else if(/^a(lt)?$/i.test(s))r=!0;else if(/^(c|ctrl|control)$/i.test(s))n=!0;else{if(!/^s(hift)?$/i.test(s))throw new Error("Unrecognized modifier name: "+s);i=!0}}return r&&(e="Alt-"+e),n&&(e="Ctrl-"+e),o&&(e="Cmd-"+e),i&&(e="Shift-"+e),e}function io(e){var t={};for(var r in e)if(e.hasOwnProperty(r)){var n=e[r];if(/^(name|fallthrough|(de|at)tach)$/.test(r))continue;if("..."==n){delete e[r];continue}for(var i=v(r.split(" "),no),o=0;o<i.length;o++){var l=void 0,s=void 0;o==i.length-1?(s=i.join(" "),l=n):(s=i.slice(0,o+1).join(" "),l="...");var a=t[s];if(a){if(a!=l)throw new Error("Inconsistent bindings for "+s)}else t[s]=l}delete e[r]}for(var u in t)e[u]=t[u];return e}function oo(e,t,r,n){var i=(t=uo(t)).call?t.call(e,n):t[e];if(!1===i)return"nothing";if("..."===i)return"multi";if(null!=i&&r(i))return"handled";if(t.fallthrough){if("[object Array]"!=Object.prototype.toString.call(t.fallthrough))return oo(e,t.fallthrough,r,n);for(var o=0;o<t.fallthrough.length;o++){var l=oo(e,t.fallthrough[o],r,n);if(l)return l}}}function lo(e){var t="string"==typeof e?e:Es[e.keyCode];return"Ctrl"==t||"Alt"==t||"Shift"==t||"Mod"==t}function so(e,t,r){var n=e;return t.altKey&&"Alt"!=n&&(e="Alt-"+e),(Dl?t.metaKey:t.ctrlKey)&&"Ctrl"!=n&&(e="Ctrl-"+e),(Dl?t.ctrlKey:t.metaKey)&&"Cmd"!=n&&(e="Cmd-"+e),!r&&t.shiftKey&&"Shift"!=n&&(e="Shift-"+e),e}function ao(e,t){if(wl&&34==e.keyCode&&e.char)return!1;var r=Es[e.keyCode];return null!=r&&!e.altGraphKey&&so(r,e,t)}function uo(e){return"string"==typeof e?Rs[e]:e}function co(e,t){for(var r=e.doc.sel.ranges,n=[],i=0;i<r.length;i++){for(var o=t(r[i]);n.length&&P(o.from,g(n).to)<=0;){var l=n.pop();if(P(l.from,o.from)<0){o.from=l.from;break}}n.push(o)}hn(e,function(){for(var t=n.length-1;t>=0;t--)Ei(e.doc,"",n[t].from,n[t].to,"+delete");jr(e)})}function fo(e,t,r){var n=L(e.text,t+r,r);return n<0||n>e.text.length?null:n}function ho(e,t,r){var n=fo(e,t.ch,r);return null==n?null:new E(t.line,n,r<0?"after":"before")}function po(e,t,r,n,i){if(e){var o=Se(r,t.doc.direction);if(o){var l,s=i<0?g(o):o[0],a=i<0==(1==s.level)?"after":"before";if(s.level>0){var u=Xt(t,r);l=i<0?r.text.length-1:0;var c=Yt(t,u,l).top;l=k(function(e){return Yt(t,u,e).top==c},i<0==(1==s.level)?s.from:s.to-1,l),"before"==a&&(l=fo(r,l,1))}else l=i<0?s.to:s.from;return new E(n,l,a)}}return new E(n,i<0?r.text.length:0,i<0?"before":"after")}function go(e,t,r,n){var i=Se(t,e.doc.direction);if(!i)return ho(t,r,n);r.ch>=t.text.length?(r.ch=t.text.length,r.sticky="before"):r.ch<=0&&(r.ch=0,r.sticky="after");var o=Ce(i,r.ch,r.sticky),l=i[o];if("ltr"==e.doc.direction&&l.level%2==0&&(n>0?l.to>r.ch:l.from<r.ch))return ho(t,r,n);var s,a=function(e,r){return fo(t,e instanceof E?e.ch:e,r)},u=function(r){return e.options.lineWrapping?(s=s||Xt(e,t),hr(e,t,s,r)):{begin:0,end:t.text.length}},c=u("before"==r.sticky?a(r,-1):r.ch);if("rtl"==e.doc.direction||1==l.level){var f=1==l.level==n<0,h=a(r,f?1:-1);if(null!=h&&(f?h<=l.to&&h<=c.end:h>=l.from&&h>=c.begin)){var d=f?"before":"after";return new E(r.line,h,d)}}var p=function(e,t,n){for(var o=function(e,t){return t?new E(r.line,a(e,1),"before"):new E(r.line,e,"after")};e>=0&&e<i.length;e+=t){var l=i[e],s=t>0==(1!=l.level),u=s?n.begin:a(n.end,-1);if(l.from<=u&&u<l.to)return o(u,s);if(u=s?l.from:a(l.to,-1),n.begin<=u&&u<n.end)return o(u,s)}},g=p(o+n,n,c);if(g)return g;var v=n>0?c.end:a(c.begin,-1);return null==v||n>0&&v==t.text.length||!(g=p(n>0?0:i.length-1,n,u(v)))?null:g}function vo(e,t){var r=M(e.doc,t),n=fe(r);return n!=r&&(t=W(n)),po(!0,e,n,t,1)}function mo(e,t){var r=M(e.doc,t),n=he(r);return n!=r&&(t=W(n)),po(!0,e,r,t,-1)}function yo(e,t){var r=vo(e,t.line),n=M(e.doc,r.line),i=Se(n,e.doc.direction);if(!i||0==i[0].level){var o=Math.max(0,n.text.search(/\S/)),l=t.line==r.line&&t.ch<=o&&t.ch;return E(r.line,l?0:o,r.sticky)}return r}function bo(e,t,r){if("string"==typeof t&&!(t=Bs[t]))return!1;e.display.input.ensurePolled();var n=e.display.shift,i=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),r&&(e.display.shift=!1),i=t(e)!=Bl}finally{e.display.shift=n,e.state.suppressEdits=!1}return i}function wo(e,t,r){for(var n=0;n<e.state.keyMaps.length;n++){var i=oo(t,e.state.keyMaps[n],r,e);if(i)return i}return e.options.extraKeys&&oo(t,e.options.extraKeys,r,e)||oo(t,e.options.keyMap,r,e)}function xo(e,t,r,n){var i=e.state.keySeq;if(i){if(lo(t))return"handled";Gs.set(50,function(){e.state.keySeq==i&&(e.state.keySeq=null,e.display.input.reset())}),t=i+" "+t}var o=wo(e,t,n);return"multi"==o&&(e.state.keySeq=t),"handled"==o&&bt(e,"keyHandled",e,t,r),"handled"!=o&&"multi"!=o||(We(r),Ar(e)),i&&!o&&/\'$/.test(t)?(We(r),!0):!!o}function Co(e,t){var r=ao(t,!0);return!!r&&(t.shiftKey&&!e.state.keySeq?xo(e,"Shift-"+r,t,function(t){return bo(e,t,!0)})||xo(e,r,t,function(t){if("string"==typeof t?/^go[A-Z]/.test(t):t.motion)return bo(e,t)}):xo(e,r,t,function(t){return bo(e,t)}))}function So(e,t,r){return xo(e,"'"+r+"'",t,function(t){return bo(e,t,!0)})}function Lo(e){var t=this;if(t.curOp.focus=l(),!Me(t,e)){gl&&vl<11&&27==e.keyCode&&(e.returnValue=!1);var r=e.keyCode;t.display.shift=16==r||e.shiftKey;var n=Co(t,e);wl&&(Us=n?r:null,!n&&88==r&&!rs&&(Ml?e.metaKey:e.ctrlKey)&&t.replaceSelection("",null,"cut")),18!=r||/\bCodeMirror-crosshair\b/.test(t.display.lineDiv.className)||ko(t)}}function ko(e){function t(e){18!=e.keyCode&&e.altKey||(Fl(r,"CodeMirror-crosshair"),ke(document,"keyup",t),ke(document,"mouseover",t))}var r=e.display.lineDiv;s(r,"CodeMirror-crosshair"),Ql(document,"keyup",t),Ql(document,"mouseover",t)}function To(e){16==e.keyCode&&(this.doc.sel.shift=!1),Me(this,e)}function Mo(e){var t=this;if(!(Ft(t.display,e)||Me(t,e)||e.ctrlKey&&!e.altKey||Ml&&e.metaKey)){var r=e.keyCode,n=e.charCode;if(wl&&r==Us)return Us=null,void We(e);if(!wl||e.which&&!(e.which<10)||!Co(t,e)){var i=String.fromCharCode(null==n?r:n);"\b"!=i&&(So(t,e,i)||t.display.input.onKeyPress(e))}}}function No(e,t){var r=+new Date;return js&&js.compare(r,e,t)?(Ks=js=null,"triple"):Ks&&Ks.compare(r,e,t)?(js=new Vs(r,e,t),Ks=null,"double"):(Ks=new Vs(r,e,t),js=null,"single")}function Oo(e){var t=this,r=t.display;if(!(Me(t,e)||r.activeTouch&&r.input.supportsTouch()))if(r.input.ensurePolled(),r.shift=e.shiftKey,Ft(r,e))ml||(r.scroller.draggable=!1,setTimeout(function(){return r.scroller.draggable=!0},100));else if(!zo(t,e)){var n=Sr(t,e),i=Pe(e),o=n?No(n,i):"single";window.focus(),1==i&&t.state.selectingText&&t.state.selectingText(e),n&&Ao(t,i,n,o,e)||(1==i?n?Do(t,n,o,e):Ee(e)==r.scroller&&We(e):2==i?(n&&di(t.doc,n),setTimeout(function(){return r.input.focus()},20)):3==i&&(Hl?Ro(t,e):Dr(t)))}}function Ao(e,t,r,n,i){var o="Click";return"double"==n?o="Double"+o:"triple"==n&&(o="Triple"+o),o=(1==t?"Left":2==t?"Middle":"Right")+o,xo(e,so(o,i),i,function(t){if("string"==typeof t&&(t=Bs[t]),!t)return!1;var n=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),n=t(e,r)!=Bl}finally{e.state.suppressEdits=!1}return n})}function Wo(e,t,r){var n=e.getOption("configureMouse"),i=n?n(e,t,r):{};if(null==i.unit){var o=Nl?r.shiftKey&&r.metaKey:r.altKey;i.unit=o?"rectangle":"single"==t?"char":"double"==t?"word":"line"}return(null==i.extend||e.doc.extend)&&(i.extend=e.doc.extend||r.shiftKey),null==i.addNew&&(i.addNew=Ml?r.metaKey:r.ctrlKey),null==i.moveOnDrag&&(i.moveOnDrag=!(Ml?r.altKey:r.ctrlKey)),i}function Do(e,t,r,n){gl?setTimeout(u(Wr,e),0):e.curOp.focus=l();var i,o=Wo(e,r,n),s=e.doc.sel;e.options.dragDrop&&Jl&&!e.isReadOnly()&&"single"==r&&(i=s.contains(t))>-1&&(P((i=s.ranges[i]).from(),t)<0||t.xRel>0)&&(P(i.to(),t)>0||t.xRel<0)?Ho(e,n,t,o):Eo(e,n,t,o)}function Ho(e,t,r,n){var i=e.display,o=!1,l=dn(e,function(t){ml&&(i.scroller.draggable=!1),e.state.draggingText=!1,ke(document,"mouseup",l),ke(document,"mousemove",s),ke(i.scroller,"dragstart",a),ke(i.scroller,"drop",l),o||(We(t),n.addNew||di(e.doc,r,null,null,n.extend),ml||gl&&9==vl?setTimeout(function(){document.body.focus(),i.input.focus()},20):i.input.focus())}),s=function(e){o=o||Math.abs(t.clientX-e.clientX)+Math.abs(t.clientY-e.clientY)>=10},a=function(){return o=!0};ml&&(i.scroller.draggable=!0),e.state.draggingText=l,l.copy=!n.moveOnDrag,i.scroller.dragDrop&&i.scroller.dragDrop(),Ql(document,"mouseup",l),Ql(document,"mousemove",s),Ql(i.scroller,"dragstart",a),Ql(i.scroller,"drop",l),Dr(e),setTimeout(function(){return i.input.focus()},20)}function Fo(e,t,r){if("char"==r)return new Ts(t,t);if("word"==r)return e.findWordAt(t);if("line"==r)return new Ts(E(t.line,0),U(e.doc,E(t.line+1,0)));var n=r(e,t);return new Ts(n.from,n.to)}function Eo(e,t,r,n){function i(t){if(0!=P(m,t))if(m=t,"rectangle"==n.unit){for(var i=[],o=e.options.tabSize,l=f(M(u,r.line).text,r.ch,o),s=f(M(u,t.line).text,t.ch,o),a=Math.min(l,s),g=Math.max(l,s),v=Math.min(r.line,t.line),y=Math.min(e.lastLine(),Math.max(r.line,t.line));v<=y;v++){var b=M(u,v).text,w=d(b,a,o);a==g?i.push(new Ts(E(v,w),E(v,w))):b.length>w&&i.push(new Ts(E(v,w),E(v,d(b,g,o))))}i.length||i.push(new Ts(r,r)),bi(u,zn(p.ranges.slice(0,h).concat(i),h),{origin:"*mouse",scroll:!1}),e.scrollIntoView(t)}else{var x,C=c,S=Fo(e,t,n.unit),L=C.anchor;P(S.anchor,L)>0?(x=S.head,L=B(C.from(),S.anchor)):(x=S.anchor,L=R(C.to(),S.head));var k=p.ranges.slice(0);k[h]=Po(e,new Ts(U(u,L),x)),bi(u,zn(k,h),Ul)}}function o(t){var r=++b,s=Sr(e,t,!0,"rectangle"==n.unit);if(s)if(0!=P(s,m)){e.curOp.focus=l(),i(s);var c=Ir(a,u);(s.line>=c.to||s.line<c.from)&&setTimeout(dn(e,function(){b==r&&o(t)}),150)}else{var f=t.clientY<y.top?-20:t.clientY>y.bottom?20:0;f&&setTimeout(dn(e,function(){b==r&&(a.scroller.scrollTop+=f,o(t))}),50)}}function s(t){e.state.selectingText=!1,b=1/0,We(t),a.input.focus(),ke(document,"mousemove",w),ke(document,"mouseup",x),u.history.lastSelOrigin=null}var a=e.display,u=e.doc;We(t);var c,h,p=u.sel,g=p.ranges;if(n.addNew&&!n.extend?(h=u.sel.contains(r),c=h>-1?g[h]:new Ts(r,r)):(c=u.sel.primary(),h=u.sel.primIndex),"rectangle"==n.unit)n.addNew||(c=new Ts(r,r)),r=Sr(e,t,!0,!0),h=-1;else{var v=Fo(e,r,n.unit);c=n.extend?hi(c,v.anchor,v.head,n.extend):v}n.addNew?-1==h?(h=g.length,bi(u,zn(g.concat([c]),h),{scroll:!1,origin:"*mouse"})):g.length>1&&g[h].empty()&&"char"==n.unit&&!n.extend?(bi(u,zn(g.slice(0,h).concat(g.slice(h+1)),0),{scroll:!1,origin:"*mouse"}),p=u.sel):gi(u,h,c,Ul):(h=0,bi(u,new ks([c],0),Ul),p=u.sel);var m=r,y=a.wrapper.getBoundingClientRect(),b=0,w=dn(e,function(e){Pe(e)?o(e):s(e)}),x=dn(e,s);e.state.selectingText=x,Ql(document,"mousemove",w),Ql(document,"mouseup",x)}function Po(e,t){var r=t.anchor,n=t.head,i=M(e.doc,r.line);if(0==P(r,n)&&r.sticky==n.sticky)return t;var o=Se(i);if(!o)return t;var l=Ce(o,r.ch,r.sticky),s=o[l];if(s.from!=r.ch&&s.to!=r.ch)return t;var a=l+(s.from==r.ch==(1!=s.level)?0:1);if(0==a||a==o.length)return t;var u;if(n.line!=r.line)u=(n.line-r.line)*("ltr"==e.doc.direction?1:-1)>0;else{var c=Ce(o,n.ch,n.sticky),f=c-l||(n.ch-r.ch)*(1==s.level?-1:1);u=c==a-1||c==a?f<0:f>0}var h=o[a+(u?-1:0)],d=u==(1==h.level),p=d?h.from:h.to,g=d?"after":"before";return r.ch==p&&r.sticky==g?t:new Ts(new E(r.line,p,g),n)}function Io(e,t,r,n){var i,o;if(t.touches)i=t.touches[0].clientX,o=t.touches[0].clientY;else try{i=t.clientX,o=t.clientY}catch(t){return!1}if(i>=Math.floor(e.display.gutters.getBoundingClientRect().right))return!1;n&&We(t);var l=e.display,s=l.lineDiv.getBoundingClientRect();if(o>s.bottom||!Oe(e,r))return He(t);o-=s.top-l.viewOffset;for(var a=0;a<e.options.gutters.length;++a){var u=l.gutters.childNodes[a];if(u&&u.getBoundingClientRect().right>=i)return Te(e,r,e,D(e.doc,o),e.options.gutters[a],t),He(t)}}function zo(e,t){return Io(e,t,"gutterClick",!0)}function Ro(e,t){Ft(e.display,t)||Bo(e,t)||Me(e,t,"contextmenu")||e.display.input.onContextMenu(t)}function Bo(e,t){return!!Oe(e,"gutterContextMenu")&&Io(e,t,"gutterContextMenu",!1)}function Go(e){e.display.wrapper.className=e.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+e.options.theme.replace(/(^|\s)\s*/g," cm-s-"),er(e)}function Uo(e){Hn(e),vn(e),zr(e)}function Vo(e,t,r){if(!t!=!(r&&r!=Xs)){var n=e.display.dragFunctions,i=t?Ql:ke;i(e.display.scroller,"dragstart",n.start),i(e.display.scroller,"dragenter",n.enter),i(e.display.scroller,"dragover",n.over),i(e.display.scroller,"dragleave",n.leave),i(e.display.scroller,"drop",n.drop)}}function Ko(e){e.options.lineWrapping?(s(e.display.wrapper,"CodeMirror-wrap"),e.display.sizer.style.minWidth="",e.display.sizerWidth=null):(Fl(e.display.wrapper,"CodeMirror-wrap"),we(e)),Cr(e),vn(e),er(e),setTimeout(function(){return en(e)},100)}function jo(e,t){var r=this;if(!(this instanceof jo))return new jo(e,t);this.options=t=t?c(t):{},c(Ys,t,!1),Fn(t);var n=t.value;"string"==typeof n&&(n=new Ds(n,t.mode,null,t.lineSeparator,t.direction)),this.doc=n;var i=new jo.inputStyles[t.inputStyle](this),o=this.display=new T(e,n,i);o.wrapper.CodeMirror=this,Hn(this),Go(this),t.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),rn(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,delayingBlurEvent:!1,focused:!1,suppressEdits:!1,pasteIncoming:!1,cutIncoming:!1,selectingText:!1,draggingText:!1,highlight:new Pl,keySeq:null,specialChars:null},t.autofocus&&!Tl&&o.input.focus(),gl&&vl<11&&setTimeout(function(){return r.display.input.reset(!0)},20),Xo(this),eo(),nn(this),this.curOp.forceUpdate=!0,qn(this,n),t.autofocus&&!Tl||this.hasFocus()?setTimeout(u(Hr,this),20):Fr(this);for(var l in _s)_s.hasOwnProperty(l)&&_s[l](r,t[l],Xs);Rr(this),t.finishInit&&t.finishInit(this);for(var s=0;s<$s.length;++s)$s[s](r);on(this),ml&&t.lineWrapping&&"optimizelegibility"==getComputedStyle(o.lineDiv).textRendering&&(o.lineDiv.style.textRendering="auto")}function Xo(e){function t(){i.activeTouch&&(o=setTimeout(function(){return i.activeTouch=null},1e3),(l=i.activeTouch).end=+new Date)}function r(e){if(1!=e.touches.length)return!1;var t=e.touches[0];return t.radiusX<=1&&t.radiusY<=1}function n(e,t){if(null==t.left)return!0;var r=t.left-e.left,n=t.top-e.top;return r*r+n*n>400}var i=e.display;Ql(i.scroller,"mousedown",dn(e,Oo)),gl&&vl<11?Ql(i.scroller,"dblclick",dn(e,function(t){if(!Me(e,t)){var r=Sr(e,t);if(r&&!zo(e,t)&&!Ft(e.display,t)){We(t);var n=e.findWordAt(r);di(e.doc,n.anchor,n.head)}}})):Ql(i.scroller,"dblclick",function(t){return Me(e,t)||We(t)}),Hl||Ql(i.scroller,"contextmenu",function(t){return Ro(e,t)});var o,l={end:0};Ql(i.scroller,"touchstart",function(t){if(!Me(e,t)&&!r(t)&&!zo(e,t)){i.input.ensurePolled(),clearTimeout(o);var n=+new Date;i.activeTouch={start:n,moved:!1,prev:n-l.end<=300?l:null},1==t.touches.length&&(i.activeTouch.left=t.touches[0].pageX,i.activeTouch.top=t.touches[0].pageY)}}),Ql(i.scroller,"touchmove",function(){i.activeTouch&&(i.activeTouch.moved=!0)}),Ql(i.scroller,"touchend",function(r){var o=i.activeTouch;if(o&&!Ft(i,r)&&null!=o.left&&!o.moved&&new Date-o.start<300){var l,s=e.coordsChar(i.activeTouch,"page");l=!o.prev||n(o,o.prev)?new Ts(s,s):!o.prev.prev||n(o,o.prev.prev)?e.findWordAt(s):new Ts(E(s.line,0),U(e.doc,E(s.line+1,0))),e.setSelection(l.anchor,l.head),e.focus(),We(r)}t()}),Ql(i.scroller,"touchcancel",t),Ql(i.scroller,"scroll",function(){i.scroller.clientHeight&&(qr(e,i.scroller.scrollTop),Qr(e,i.scroller.scrollLeft,!0),Te(e,"scroll",e))}),Ql(i.scroller,"mousewheel",function(t){return In(e,t)}),Ql(i.scroller,"DOMMouseScroll",function(t){return In(e,t)}),Ql(i.wrapper,"scroll",function(){return i.wrapper.scrollTop=i.wrapper.scrollLeft=0}),i.dragFunctions={enter:function(t){Me(e,t)||Fe(t)},over:function(t){Me(e,t)||(Zi(e,t),Fe(t))},start:function(t){return qi(e,t)},drop:dn(e,$i),leave:function(t){Me(e,t)||Qi(e)}};var s=i.input.getField();Ql(s,"keyup",function(t){return To.call(e,t)}),Ql(s,"keydown",dn(e,Lo)),Ql(s,"keypress",dn(e,Mo)),Ql(s,"focus",function(t){return Hr(e,t)}),Ql(s,"blur",function(t){return Fr(e,t)})}function Yo(e,t,r,n){var i,o=e.doc;null==r&&(r="add"),"smart"==r&&(o.mode.indent?i=$e(e,t).state:r="prev");var l=e.options.tabSize,s=M(o,t),a=f(s.text,null,l);s.stateAfter&&(s.stateAfter=null);var u,c=s.text.match(/^\s*/)[0];if(n||/\S/.test(s.text)){if("smart"==r&&((u=o.mode.indent(i,s.text.slice(c.length),s.text))==Bl||u>150)){if(!n)return;r="prev"}}else u=0,r="not";"prev"==r?u=t>o.first?f(M(o,t-1).text,null,l):0:"add"==r?u=a+e.options.indentUnit:"subtract"==r?u=a-e.options.indentUnit:"number"==typeof r&&(u=a+r),u=Math.max(0,u);var h="",d=0;if(e.options.indentWithTabs)for(var g=Math.floor(u/l);g;--g)d+=l,h+="\t";if(d<u&&(h+=p(u-d)),h!=c)return Ei(o,h,E(t,0),E(t,c.length),"+input"),s.stateAfter=null,!0;for(var v=0;v<o.sel.ranges.length;v++){var m=o.sel.ranges[v];if(m.head.line==t&&m.head.ch<c.length){var y=E(t,c.length);gi(o,v,new Ts(y,y));break}}}function _o(e){qs=e}function $o(e,t,r,n,i){var o=e.doc;e.display.shift=!1,n||(n=o.sel);var l=e.state.pasteIncoming||"paste"==i,s=es(t),a=null;if(l&&n.ranges.length>1)if(qs&&qs.text.join("\n")==t){if(n.ranges.length%qs.text.length==0){a=[];for(var u=0;u<qs.text.length;u++)a.push(o.splitLines(qs.text[u]))}}else s.length==n.ranges.length&&e.options.pasteLinesPerSelection&&(a=v(s,function(e){return[e]}));for(var c,f=n.ranges.length-1;f>=0;f--){var h=n.ranges[f],d=h.from(),p=h.to();h.empty()&&(r&&r>0?d=E(d.line,d.ch-r):e.state.overwrite&&!l?p=E(p.line,Math.min(M(o,p.line).text.length,p.ch+g(s).length)):qs&&qs.lineWise&&qs.text.join("\n")==t&&(d=p=E(d.line,0))),c=e.curOp.updateInput;var m={from:d,to:p,text:a?a[f%a.length]:s,origin:i||(l?"paste":e.state.cutIncoming?"cut":"+input")};Oi(e.doc,m),bt(e,"inputRead",e,m)}t&&!l&&Zo(e,t),jr(e),e.curOp.updateInput=c,e.curOp.typing=!0,e.state.pasteIncoming=e.state.cutIncoming=!1}function qo(e,t){var r=e.clipboardData&&e.clipboardData.getData("Text");if(r)return e.preventDefault(),t.isReadOnly()||t.options.disableInput||hn(t,function(){return $o(t,r,0,null,"paste")}),!0}function Zo(e,t){if(e.options.electricChars&&e.options.smartIndent)for(var r=e.doc.sel,n=r.ranges.length-1;n>=0;n--){var i=r.ranges[n];if(!(i.head.ch>100||n&&r.ranges[n-1].head.line==i.head.line)){var o=e.getModeAt(i.head),l=!1;if(o.electricChars){for(var s=0;s<o.electricChars.length;s++)if(t.indexOf(o.electricChars.charAt(s))>-1){l=Yo(e,i.head.line,"smart");break}}else o.electricInput&&o.electricInput.test(M(e.doc,i.head.line).text.slice(0,i.head.ch))&&(l=Yo(e,i.head.line,"smart"));l&&bt(e,"electricInput",e,i.head.line)}}}function Qo(e){for(var t=[],r=[],n=0;n<e.doc.sel.ranges.length;n++){var i=e.doc.sel.ranges[n].head.line,o={anchor:E(i,0),head:E(i+1,0)};r.push(o),t.push(e.getRange(o.anchor,o.head))}return{text:t,ranges:r}}function Jo(e,t){e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!!t)}function el(){var e=n("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; outline: none"),t=n("div",[e],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return ml?e.style.width="1000px":e.setAttribute("wrap","off"),Ll&&(e.style.border="1px solid black"),Jo(e),t}function tl(e,t,r,n,i){function o(){var n=t.line+r;return!(n<e.first||n>=e.first+e.size)&&(t=new E(n,t.ch,t.sticky),u=M(e,n))}function l(n){var l;if(null==(l=i?go(e.cm,u,t,r):ho(u,t,r))){if(n||!o())return!1;t=po(i,e.cm,u,t.line,r)}else t=l;return!0}var s=t,a=r,u=M(e,t.line);if("char"==n)l();else if("column"==n)l(!0);else if("word"==n||"group"==n)for(var c=null,f="group"==n,h=e.cm&&e.cm.getHelper(t,"wordChars"),d=!0;!(r<0)||l(!d);d=!1){var p=u.text.charAt(t.ch)||"\n",g=x(p,h)?"w":f&&"\n"==p?"n":!f||/\s/.test(p)?null:"p";if(!f||d||g||(g="s"),c&&c!=g){r<0&&(r=1,l(),t.sticky="after");break}if(g&&(c=g),r>0&&!l(!d))break}var v=ki(e,t,s,a,!0);return I(s,v)&&(v.hitSide=!0),v}function rl(e,t,r,n){var i,o=e.doc,l=t.left;if("page"==n){var s=Math.min(e.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight),a=Math.max(s-.5*mr(e.display),3);i=(r>0?t.bottom:t.top)+r*a}else"line"==n&&(i=r>0?t.bottom+3:t.top-3);for(var u;(u=cr(e,l,i)).outside;){if(r<0?i<=0:i>=o.height){u.hitSide=!0;break}i+=5*r}return u}function nl(e,t){var r=jt(e,t.line);if(!r||r.hidden)return null;var n=M(e.doc,t.line),i=Ut(r,n,t.line),o=Se(n,e.doc.direction),l="left";o&&(l=Ce(o,t.ch)%2?"right":"left");var s=_t(i.map,t.ch,l);return s.offset="right"==s.collapse?s.end:s.start,s}function il(e){for(var t=e;t;t=t.parentNode)if(/CodeMirror-gutter-wrapper/.test(t.className))return!0;return!1}function ol(e,t){return t&&(e.bad=!0),e}function ll(e,t,r,n,i){function o(e){return function(t){return t.id==e}}function l(){c&&(u+=f,c=!1)}function s(e){e&&(l(),u+=e)}function a(t){if(1==t.nodeType){var r=t.getAttribute("cm-text");if(null!=r)return void s(r||t.textContent.replace(/\u200b/g,""));var u,h=t.getAttribute("cm-marker");if(h){var d=e.findMarks(E(n,0),E(i+1,0),o(+h));return void(d.length&&(u=d[0].find(0))&&s(N(e.doc,u.from,u.to).join(f)))}if("false"==t.getAttribute("contenteditable"))return;var p=/^(pre|div|p)$/i.test(t.nodeName);p&&l();for(var g=0;g<t.childNodes.length;g++)a(t.childNodes[g]);p&&(c=!0)}else 3==t.nodeType&&s(t.nodeValue)}for(var u="",c=!1,f=e.doc.lineSeparator();a(t),t!=r;)t=t.nextSibling;return u}function sl(e,t,r){var n;if(t==e.display.lineDiv){if(!(n=e.display.lineDiv.childNodes[r]))return ol(e.clipPos(E(e.display.viewTo-1)),!0);t=null,r=0}else for(n=t;;n=n.parentNode){if(!n||n==e.display.lineDiv)return null;if(n.parentNode&&n.parentNode==e.display.lineDiv)break}for(var i=0;i<e.display.view.length;i++){var o=e.display.view[i];if(o.node==n)return al(o,t,r)}}function al(e,t,r){function n(t,r,n){for(var i=-1;i<(f?f.length:0);i++)for(var o=i<0?c.map:f[i],l=0;l<o.length;l+=3){var s=o[l+2];if(s==t||s==r){var a=W(i<0?e.line:e.rest[i]),u=o[l]+n;return(n<0||s!=t)&&(u=o[l+(n?1:0)]),E(a,u)}}}var i=e.text.firstChild,l=!1;if(!t||!o(i,t))return ol(E(W(e.line),0),!0);if(t==i&&(l=!0,t=i.childNodes[r],r=0,!t)){var s=e.rest?g(e.rest):e.line;return ol(E(W(s),s.text.length),l)}var a=3==t.nodeType?t:null,u=t;for(a||1!=t.childNodes.length||3!=t.firstChild.nodeType||(a=t.firstChild,r&&(r=a.nodeValue.length));u.parentNode!=i;)u=u.parentNode;var c=e.measure,f=c.maps,h=n(a,u,r);if(h)return ol(h,l);for(var d=u.nextSibling,p=a?a.nodeValue.length-r:0;d;d=d.nextSibling){if(h=n(d,d.firstChild,0))return ol(E(h.line,h.ch-p),l);p+=d.textContent.length}for(var v=u.previousSibling,m=r;v;v=v.previousSibling){if(h=n(v,v.firstChild,-1))return ol(E(h.line,h.ch+m),l);m+=v.textContent.length}}var ul=navigator.userAgent,cl=navigator.platform,fl=/gecko\/\d/i.test(ul),hl=/MSIE \d/.test(ul),dl=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(ul),pl=/Edge\/(\d+)/.exec(ul),gl=hl||dl||pl,vl=gl&&(hl?document.documentMode||6:+(pl||dl)[1]),ml=!pl&&/WebKit\//.test(ul),yl=ml&&/Qt\/\d+\.\d+/.test(ul),bl=!pl&&/Chrome\//.test(ul),wl=/Opera\//.test(ul),xl=/Apple Computer/.test(navigator.vendor),Cl=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(ul),Sl=/PhantomJS/.test(ul),Ll=!pl&&/AppleWebKit/.test(ul)&&/Mobile\/\w+/.test(ul),kl=/Android/.test(ul),Tl=Ll||kl||/webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(ul),Ml=Ll||/Mac/.test(cl),Nl=/\bCrOS\b/.test(ul),Ol=/win/i.test(cl),Al=wl&&ul.match(/Version\/(\d*\.\d*)/);Al&&(Al=Number(Al[1])),Al&&Al>=15&&(wl=!1,ml=!0);var Wl,Dl=Ml&&(yl||wl&&(null==Al||Al<12.11)),Hl=fl||gl&&vl>=9,Fl=function(t,r){var n=t.className,i=e(r).exec(n);if(i){var o=n.slice(i.index+i[0].length);t.className=n.slice(0,i.index)+(o?i[1]+o:"")}};Wl=document.createRange?function(e,t,r,n){var i=document.createRange();return i.setEnd(n||e,r),i.setStart(e,t),i}:function(e,t,r){var n=document.body.createTextRange();try{n.moveToElementText(e.parentNode)}catch(e){return n}return n.collapse(!0),n.moveEnd("character",r),n.moveStart("character",t),n};var El=function(e){e.select()};Ll?El=function(e){e.selectionStart=0,e.selectionEnd=e.value.length}:gl&&(El=function(e){try{e.select()}catch(e){}});var Pl=function(){this.id=null};Pl.prototype.set=function(e,t){clearTimeout(this.id),this.id=setTimeout(t,e)};var Il,zl,Rl=30,Bl={toString:function(){return"CodeMirror.Pass"}},Gl={scroll:!1},Ul={origin:"*mouse"},Vl={origin:"+move"},Kl=[""],jl=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/,Xl=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/,Yl=!1,_l=!1,$l=null,ql=function(){function e(e){return e<=247?r.charAt(e):1424<=e&&e<=1524?"R":1536<=e&&e<=1785?n.charAt(e-1536):1774<=e&&e<=2220?"r":8192<=e&&e<=8203?"w":8204==e?"b":"L"}function t(e,t,r){this.level=e,this.from=t,this.to=r}var r="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",n="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111",i=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,o=/[stwN]/,l=/[LRr]/,s=/[Lb1n]/,a=/[1n]/;return function(r,n){var u="ltr"==n?"L":"R";if(0==r.length||"ltr"==n&&!i.test(r))return!1;for(var c=r.length,f=[],h=0;h<c;++h)f.push(e(r.charCodeAt(h)));for(var d=0,p=u;d<c;++d){var v=f[d];"m"==v?f[d]=p:p=v}for(var m=0,y=u;m<c;++m){var b=f[m];"1"==b&&"r"==y?f[m]="n":l.test(b)&&(y=b,"r"==b&&(f[m]="R"))}for(var w=1,x=f[0];w<c-1;++w){var C=f[w];"+"==C&&"1"==x&&"1"==f[w+1]?f[w]="1":","!=C||x!=f[w+1]||"1"!=x&&"n"!=x||(f[w]=x),x=C}for(var S=0;S<c;++S){var L=f[S];if(","==L)f[S]="N";else if("%"==L){var k=void 0;for(k=S+1;k<c&&"%"==f[k];++k);for(var T=S&&"!"==f[S-1]||k<c&&"1"==f[k]?"1":"N",M=S;M<k;++M)f[M]=T;S=k-1}}for(var N=0,O=u;N<c;++N){var A=f[N];"L"==O&&"1"==A?f[N]="L":l.test(A)&&(O=A)}for(var W=0;W<c;++W)if(o.test(f[W])){var D=void 0;for(D=W+1;D<c&&o.test(f[D]);++D);for(var H="L"==(W?f[W-1]:u),F=H==("L"==(D<c?f[D]:u))?H?"L":"R":u,E=W;E<D;++E)f[E]=F;W=D-1}for(var P,I=[],z=0;z<c;)if(s.test(f[z])){var R=z;for(++z;z<c&&s.test(f[z]);++z);I.push(new t(0,R,z))}else{var B=z,G=I.length;for(++z;z<c&&"L"!=f[z];++z);for(var U=B;U<z;)if(a.test(f[U])){B<U&&I.splice(G,0,new t(1,B,U));var V=U;for(++U;U<z&&a.test(f[U]);++U);I.splice(G,0,new t(2,V,U)),B=U}else++U;B<z&&I.splice(G,0,new t(1,B,z))}return 1==I[0].level&&(P=r.match(/^\s+/))&&(I[0].from=P[0].length,I.unshift(new t(0,0,P[0].length))),1==g(I).level&&(P=r.match(/\s+$/))&&(g(I).to-=P[0].length,I.push(new t(0,c-P[0].length,c))),"rtl"==n?I.reverse():I}}(),Zl=[],Ql=function(e,t,r){if(e.addEventListener)e.addEventListener(t,r,!1);else if(e.attachEvent)e.attachEvent("on"+t,r);else{var n=e._handlers||(e._handlers={});n[t]=(n[t]||Zl).concat(r)}},Jl=function(){if(gl&&vl<9)return!1;var e=n("div");return"draggable"in e||"dragDrop"in e}(),es=3!="\n\nb".split(/\n/).length?function(e){for(var t=0,r=[],n=e.length;t<=n;){var i=e.indexOf("\n",t);-1==i&&(i=e.length);var o=e.slice(t,"\r"==e.charAt(i-1)?i-1:i),l=o.indexOf("\r");-1!=l?(r.push(o.slice(0,l)),t+=l+1):(r.push(o),t=i+1)}return r}:function(e){return e.split(/\r\n?|\n/)},ts=window.getSelection?function(e){try{return e.selectionStart!=e.selectionEnd}catch(e){return!1}}:function(e){var t;try{t=e.ownerDocument.selection.createRange()}catch(e){}return!(!t||t.parentElement()!=e)&&0!=t.compareEndPoints("StartToEnd",t)},rs=function(){var e=n("div");return"oncopy"in e||(e.setAttribute("oncopy","return;"),"function"==typeof e.oncopy)}(),ns=null,is={},os={},ls={},ss=function(e,t,r){this.pos=this.start=0,this.string=e,this.tabSize=t||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0,this.lineOracle=r};ss.prototype.eol=function(){return this.pos>=this.string.length},ss.prototype.sol=function(){return this.pos==this.lineStart},ss.prototype.peek=function(){return this.string.charAt(this.pos)||void 0},ss.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},ss.prototype.eat=function(e){var t=this.string.charAt(this.pos);if("string"==typeof e?t==e:t&&(e.test?e.test(t):e(t)))return++this.pos,t},ss.prototype.eatWhile=function(e){for(var t=this.pos;this.eat(e););return this.pos>t},ss.prototype.eatSpace=function(){for(var e=this,t=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++e.pos;return this.pos>t},ss.prototype.skipToEnd=function(){this.pos=this.string.length},ss.prototype.skipTo=function(e){var t=this.string.indexOf(e,this.pos);if(t>-1)return this.pos=t,!0},ss.prototype.backUp=function(e){this.pos-=e},ss.prototype.column=function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=f(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?f(this.string,this.lineStart,this.tabSize):0)},ss.prototype.indentation=function(){return f(this.string,null,this.tabSize)-(this.lineStart?f(this.string,this.lineStart,this.tabSize):0)},ss.prototype.match=function(e,t,r){if("string"!=typeof e){var n=this.string.slice(this.pos).match(e);return n&&n.index>0?null:(n&&!1!==t&&(this.pos+=n[0].length),n)}var i=function(e){return r?e.toLowerCase():e};if(i(this.string.substr(this.pos,e.length))==i(e))return!1!==t&&(this.pos+=e.length),!0},ss.prototype.current=function(){return this.string.slice(this.start,this.pos)},ss.prototype.hideFirstChars=function(e,t){this.lineStart+=e;try{return t()}finally{this.lineStart-=e}},ss.prototype.lookAhead=function(e){var t=this.lineOracle;return t&&t.lookAhead(e)};var as=function(e,t){this.state=e,this.lookAhead=t},us=function(e,t,r,n){this.state=t,this.doc=e,this.line=r,this.maxLookAhead=n||0};us.prototype.lookAhead=function(e){var t=this.doc.getLine(this.line+e);return null!=t&&e>this.maxLookAhead&&(this.maxLookAhead=e),t},us.prototype.nextLine=function(){this.line++,this.maxLookAhead>0&&this.maxLookAhead--},us.fromSaved=function(e,t,r){return t instanceof as?new us(e,Ke(e.mode,t.state),r,t.lookAhead):new us(e,Ke(e.mode,t),r)},us.prototype.save=function(e){var t=!1!==e?Ke(this.doc.mode,this.state):this.state;return this.maxLookAhead>0?new as(t,this.maxLookAhead):t};var cs=function(e,t,r){this.start=e.start,this.end=e.pos,this.string=e.current(),this.type=t||null,this.state=r},fs=function(e,t,r){this.text=e,ne(this,t),this.height=r?r(this):1};fs.prototype.lineNo=function(){return W(this)},Ae(fs);var hs,ds={},ps={},gs=null,vs=null,ms={left:0,right:0,top:0,bottom:0},ys=function(e,t,r){this.cm=r;var i=this.vert=n("div",[n("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),o=this.horiz=n("div",[n("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");e(i),e(o),Ql(i,"scroll",function(){i.clientHeight&&t(i.scrollTop,"vertical")}),Ql(o,"scroll",function(){o.clientWidth&&t(o.scrollLeft,"horizontal")}),this.checkedZeroWidth=!1,gl&&vl<8&&(this.horiz.style.minHeight=this.vert.style.minWidth="18px")};ys.prototype.update=function(e){var t=e.scrollWidth>e.clientWidth+1,r=e.scrollHeight>e.clientHeight+1,n=e.nativeBarWidth;if(r){this.vert.style.display="block",this.vert.style.bottom=t?n+"px":"0";var i=e.viewHeight-(t?n:0);this.vert.firstChild.style.height=Math.max(0,e.scrollHeight-e.clientHeight+i)+"px"}else this.vert.style.display="",this.vert.firstChild.style.height="0";if(t){this.horiz.style.display="block",this.horiz.style.right=r?n+"px":"0",this.horiz.style.left=e.barLeft+"px";var o=e.viewWidth-e.barLeft-(r?n:0);this.horiz.firstChild.style.width=Math.max(0,e.scrollWidth-e.clientWidth+o)+"px"}else this.horiz.style.display="",this.horiz.firstChild.style.width="0";return!this.checkedZeroWidth&&e.clientHeight>0&&(0==n&&this.zeroWidthHack(),this.checkedZeroWidth=!0),{right:r?n:0,bottom:t?n:0}},ys.prototype.setScrollLeft=function(e){this.horiz.scrollLeft!=e&&(this.horiz.scrollLeft=e),this.disableHoriz&&this.enableZeroWidthBar(this.horiz,this.disableHoriz,"horiz")},ys.prototype.setScrollTop=function(e){this.vert.scrollTop!=e&&(this.vert.scrollTop=e),this.disableVert&&this.enableZeroWidthBar(this.vert,this.disableVert,"vert")},ys.prototype.zeroWidthHack=function(){var e=Ml&&!Cl?"12px":"18px";this.horiz.style.height=this.vert.style.width=e,this.horiz.style.pointerEvents=this.vert.style.pointerEvents="none",this.disableHoriz=new Pl,this.disableVert=new Pl},ys.prototype.enableZeroWidthBar=function(e,t,r){function n(){var i=e.getBoundingClientRect();("vert"==r?document.elementFromPoint(i.right-1,(i.top+i.bottom)/2):document.elementFromPoint((i.right+i.left)/2,i.bottom-1))!=e?e.style.pointerEvents="none":t.set(1e3,n)}e.style.pointerEvents="auto",t.set(1e3,n)},ys.prototype.clear=function(){var e=this.horiz.parentNode;e.removeChild(this.horiz),e.removeChild(this.vert)};var bs=function(){};bs.prototype.update=function(){return{bottom:0,right:0}},bs.prototype.setScrollLeft=function(){},bs.prototype.setScrollTop=function(){},bs.prototype.clear=function(){};var ws={native:ys,null:bs},xs=0,Cs=function(e,t,r){var n=e.display;this.viewport=t,this.visible=Ir(n,e.doc,t),this.editorIsHidden=!n.wrapper.offsetWidth,this.wrapperHeight=n.wrapper.clientHeight,this.wrapperWidth=n.wrapper.clientWidth,this.oldDisplayWidth=Rt(e),this.force=r,this.dims=br(e),this.events=[]};Cs.prototype.signal=function(e,t){Oe(e,t)&&this.events.push(arguments)},Cs.prototype.finish=function(){for(var e=this,t=0;t<this.events.length;t++)Te.apply(null,e.events[t])};var Ss=0,Ls=null;gl?Ls=-.53:fl?Ls=15:bl?Ls=-.7:xl&&(Ls=-1/3);var ks=function(e,t){this.ranges=e,this.primIndex=t};ks.prototype.primary=function(){return this.ranges[this.primIndex]},ks.prototype.equals=function(e){var t=this;if(e==this)return!0;if(e.primIndex!=this.primIndex||e.ranges.length!=this.ranges.length)return!1;for(var r=0;r<this.ranges.length;r++){var n=t.ranges[r],i=e.ranges[r];if(!I(n.anchor,i.anchor)||!I(n.head,i.head))return!1}return!0},ks.prototype.deepCopy=function(){for(var e=this,t=[],r=0;r<this.ranges.length;r++)t[r]=new Ts(z(e.ranges[r].anchor),z(e.ranges[r].head));return new ks(t,this.primIndex)},ks.prototype.somethingSelected=function(){for(var e=this,t=0;t<this.ranges.length;t++)if(!e.ranges[t].empty())return!0;return!1},ks.prototype.contains=function(e,t){var r=this;t||(t=e);for(var n=0;n<this.ranges.length;n++){var i=r.ranges[n];if(P(t,i.from())>=0&&P(e,i.to())<=0)return n}return-1};var Ts=function(e,t){this.anchor=e,this.head=t};Ts.prototype.from=function(){return B(this.anchor,this.head)},Ts.prototype.to=function(){return R(this.anchor,this.head)},Ts.prototype.empty=function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch},Bi.prototype={chunkSize:function(){return this.lines.length},removeInner:function(e,t){for(var r=this,n=e,i=e+t;n<i;++n){var o=r.lines[n];r.height-=o.height,ot(o),bt(o,"delete")}this.lines.splice(e,t)},collapse:function(e){e.push.apply(e,this.lines)},insertInner:function(e,t,r){var n=this;this.height+=r,this.lines=this.lines.slice(0,e).concat(t).concat(this.lines.slice(e));for(var i=0;i<t.length;++i)t[i].parent=n},iterN:function(e,t,r){for(var n=this,i=e+t;e<i;++e)if(r(n.lines[e]))return!0}},Gi.prototype={chunkSize:function(){return this.size},removeInner:function(e,t){var r=this;this.size-=t;for(var n=0;n<this.children.length;++n){var i=r.children[n],o=i.chunkSize();if(e<o){var l=Math.min(t,o-e),s=i.height;if(i.removeInner(e,l),r.height-=s-i.height,o==l&&(r.children.splice(n--,1),i.parent=null),0==(t-=l))break;e=0}else e-=o}if(this.size-t<25&&(this.children.length>1||!(this.children[0]instanceof Bi))){var a=[];this.collapse(a),this.children=[new Bi(a)],this.children[0].parent=this}},collapse:function(e){for(var t=this,r=0;r<this.children.length;++r)t.children[r].collapse(e)},insertInner:function(e,t,r){var n=this;this.size+=t.length,this.height+=r;for(var i=0;i<this.children.length;++i){var o=n.children[i],l=o.chunkSize();if(e<=l){if(o.insertInner(e,t,r),o.lines&&o.lines.length>50){for(var s=o.lines.length%25+25,a=s;a<o.lines.length;){var u=new Bi(o.lines.slice(a,a+=25));o.height-=u.height,n.children.splice(++i,0,u),u.parent=n}o.lines=o.lines.slice(0,s),n.maybeSpill()}break}e-=l}},maybeSpill:function(){if(!(this.children.length<=10)){var e=this;do{var t=new Gi(e.children.splice(e.children.length-5,5));if(e.parent){e.size-=t.size,e.height-=t.height;var r=h(e.parent.children,e);e.parent.children.splice(r+1,0,t)}else{var n=new Gi(e.children);n.parent=e,e.children=[n,t],e=n}t.parent=e.parent}while(e.children.length>10);e.parent.maybeSpill()}},iterN:function(e,t,r){for(var n=this,i=0;i<this.children.length;++i){var o=n.children[i],l=o.chunkSize();if(e<l){var s=Math.min(t,l-e);if(o.iterN(e,s,r))return!0;if(0==(t-=s))break;e=0}else e-=l}}};var Ms=function(e,t,r){var n=this;if(r)for(var i in r)r.hasOwnProperty(i)&&(n[i]=r[i]);this.doc=e,this.node=t};Ms.prototype.clear=function(){var e=this,t=this.doc.cm,r=this.line.widgets,n=this.line,i=W(n);if(null!=i&&r){for(var o=0;o<r.length;++o)r[o]==e&&r.splice(o--,1);r.length||(n.widgets=null);var l=Ht(this);A(n,Math.max(0,n.height-l)),t&&(hn(t,function(){Ui(t,n,-l),mn(t,i,"widget")}),bt(t,"lineWidgetCleared",t,this,i))}},Ms.prototype.changed=function(){var e=this,t=this.height,r=this.doc.cm,n=this.line;this.height=null;var i=Ht(this)-t;i&&(A(n,n.height+i),r&&hn(r,function(){r.curOp.forceUpdate=!0,Ui(r,n,i),bt(r,"lineWidgetChanged",r,e,W(n))}))},Ae(Ms);var Ns=0,Os=function(e,t){this.lines=[],this.type=t,this.doc=e,this.id=++Ns};Os.prototype.clear=function(){var e=this;if(!this.explicitlyCleared){var t=this.doc.cm,r=t&&!t.curOp;if(r&&nn(t),Oe(this,"clear")){var n=this.find();n&&bt(this,"clear",n.from,n.to)}for(var i=null,o=null,l=0;l<this.lines.length;++l){var s=e.lines[l],a=_(s.markedSpans,e);t&&!e.collapsed?mn(t,W(s),"text"):t&&(null!=a.to&&(o=W(s)),null!=a.from&&(i=W(s))),s.markedSpans=$(s.markedSpans,a),null==a.from&&e.collapsed&&!ve(e.doc,s)&&t&&A(s,mr(t.display))}if(t&&this.collapsed&&!t.options.lineWrapping)for(var u=0;u<this.lines.length;++u){var c=fe(e.lines[u]),f=be(c);f>t.display.maxLineLength&&(t.display.maxLine=c,t.display.maxLineLength=f,t.display.maxLineChanged=!0)}null!=i&&t&&this.collapsed&&vn(t,i,o+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,t&&Ci(t.doc)),t&&bt(t,"markerCleared",t,this,i,o),r&&on(t),this.parent&&this.parent.clear()}},Os.prototype.find=function(e,t){var r=this;null==e&&"bookmark"==this.type&&(e=1);for(var n,i,o=0;o<this.lines.length;++o){var l=r.lines[o],s=_(l.markedSpans,r);if(null!=s.from&&(n=E(t?l:W(l),s.from),-1==e))return n;if(null!=s.to&&(i=E(t?l:W(l),s.to),1==e))return i}return n&&{from:n,to:i}},Os.prototype.changed=function(){var e=this,t=this.find(-1,!0),r=this,n=this.doc.cm;t&&n&&hn(n,function(){var i=t.line,o=W(t.line),l=jt(n,o);if(l&&(Qt(l),n.curOp.selectionChanged=n.curOp.forceUpdate=!0),n.curOp.updateMaxLine=!0,!ve(r.doc,i)&&null!=r.height){var s=r.height;r.height=null;var a=Ht(r)-s;a&&A(i,i.height+a)}bt(n,"markerChanged",n,e)})},Os.prototype.attachLine=function(e){if(!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;t.maybeHiddenMarkers&&-1!=h(t.maybeHiddenMarkers,this)||(t.maybeUnhiddenMarkers||(t.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(e)},Os.prototype.detachLine=function(e){if(this.lines.splice(h(this.lines,e),1),!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;(t.maybeHiddenMarkers||(t.maybeHiddenMarkers=[])).push(this)}},Ae(Os);var As=function(e,t){var r=this;this.markers=e,this.primary=t;for(var n=0;n<e.length;++n)e[n].parent=r};As.prototype.clear=function(){var e=this;if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var t=0;t<this.markers.length;++t)e.markers[t].clear();bt(this,"clear")}},As.prototype.find=function(e,t){return this.primary.find(e,t)},Ae(As);var Ws=0,Ds=function(e,t,r,n,i){if(!(this instanceof Ds))return new Ds(e,t,r,n,i);null==r&&(r=0),Gi.call(this,[new Bi([new fs("",null)])]),this.first=r,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=r;var o=E(r,0);this.sel=Rn(o),this.history=new Jn(null),this.id=++Ws,this.modeOption=t,this.lineSep=n,this.direction="rtl"==i?"rtl":"ltr",this.extend=!1,"string"==typeof e&&(e=this.splitLines(e)),_n(this,{from:o,to:o,text:e}),bi(this,Rn(o),Gl)};Ds.prototype=b(Gi.prototype,{constructor:Ds,iter:function(e,t,r){r?this.iterN(e-this.first,t-e,r):this.iterN(this.first,this.first+this.size,e)},insert:function(e,t){for(var r=0,n=0;n<t.length;++n)r+=t[n].height;this.insertInner(e-this.first,t,r)},remove:function(e,t){this.removeInner(e-this.first,t)},getValue:function(e){var t=O(this,this.first,this.first+this.size);return!1===e?t:t.join(e||this.lineSeparator())},setValue:gn(function(e){var t=E(this.first,0),r=this.first+this.size-1;Oi(this,{from:t,to:E(r,M(this,r).text.length),text:this.splitLines(e),origin:"setValue",full:!0},!0),this.cm&&Xr(this.cm,0,0),bi(this,Rn(t),Gl)}),replaceRange:function(e,t,r,n){Ei(this,e,t=U(this,t),r=r?U(this,r):t,n)},getRange:function(e,t,r){var n=N(this,U(this,e),U(this,t));return!1===r?n:n.join(r||this.lineSeparator())},getLine:function(e){var t=this.getLineHandle(e);return t&&t.text},getLineHandle:function(e){if(H(this,e))return M(this,e)},getLineNumber:function(e){return W(e)},getLineHandleVisualStart:function(e){return"number"==typeof e&&(e=M(this,e)),fe(e)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(e){return U(this,e)},getCursor:function(e){var t=this.sel.primary();return null==e||"head"==e?t.head:"anchor"==e?t.anchor:"end"==e||"to"==e||!1===e?t.to():t.from()},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:gn(function(e,t,r){vi(this,U(this,"number"==typeof e?E(e,t||0):e),null,r)}),setSelection:gn(function(e,t,r){vi(this,U(this,e),U(this,t||e),r)}),extendSelection:gn(function(e,t,r){di(this,U(this,e),t&&U(this,t),r)}),extendSelections:gn(function(e,t){pi(this,K(this,e),t)}),extendSelectionsBy:gn(function(e,t){pi(this,K(this,v(this.sel.ranges,e)),t)}),setSelections:gn(function(e,t,r){var n=this;if(e.length){for(var i=[],o=0;o<e.length;o++)i[o]=new Ts(U(n,e[o].anchor),U(n,e[o].head));null==t&&(t=Math.min(e.length-1,this.sel.primIndex)),bi(this,zn(i,t),r)}}),addSelection:gn(function(e,t,r){var n=this.sel.ranges.slice(0);n.push(new Ts(U(this,e),U(this,t||e))),bi(this,zn(n,n.length-1),r)}),getSelection:function(e){for(var t,r=this,n=this.sel.ranges,i=0;i<n.length;i++){var o=N(r,n[i].from(),n[i].to());t=t?t.concat(o):o}return!1===e?t:t.join(e||this.lineSeparator())},getSelections:function(e){for(var t=this,r=[],n=this.sel.ranges,i=0;i<n.length;i++){var o=N(t,n[i].from(),n[i].to());!1!==e&&(o=o.join(e||t.lineSeparator())),r[i]=o}return r},replaceSelection:function(e,t,r){for(var n=[],i=0;i<this.sel.ranges.length;i++)n[i]=e;this.replaceSelections(n,t,r||"+input")},replaceSelections:gn(function(e,t,r){for(var n=this,i=[],o=this.sel,l=0;l<o.ranges.length;l++){var s=o.ranges[l];i[l]={from:s.from(),to:s.to(),text:n.splitLines(e[l]),origin:r}}for(var a=t&&"end"!=t&&Kn(this,i,t),u=i.length-1;u>=0;u--)Oi(n,i[u]);a?yi(this,a):this.cm&&jr(this.cm)}),undo:gn(function(){Wi(this,"undo")}),redo:gn(function(){Wi(this,"redo")}),undoSelection:gn(function(){Wi(this,"undo",!0)}),redoSelection:gn(function(){Wi(this,"redo",!0)}),setExtending:function(e){this.extend=e},getExtending:function(){return this.extend},historySize:function(){for(var e=this.history,t=0,r=0,n=0;n<e.done.length;n++)e.done[n].ranges||++t;for(var i=0;i<e.undone.length;i++)e.undone[i].ranges||++r;return{undo:t,redo:r}},clearHistory:function(){this.history=new Jn(this.history.maxGeneration)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(e){return e&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(e){return this.history.generation==(e||this.cleanGeneration)},getHistory:function(){return{done:fi(this.history.done),undone:fi(this.history.undone)}},setHistory:function(e){var t=this.history=new Jn(this.history.maxGeneration);t.done=fi(e.done.slice(0),null,!0),t.undone=fi(e.undone.slice(0),null,!0)},setGutterMarker:gn(function(e,t,r){return Ri(this,e,"gutter",function(e){var n=e.gutterMarkers||(e.gutterMarkers={});return n[t]=r,!r&&C(n)&&(e.gutterMarkers=null),!0})}),clearGutter:gn(function(e){var t=this;this.iter(function(r){r.gutterMarkers&&r.gutterMarkers[e]&&Ri(t,r,"gutter",function(){return r.gutterMarkers[e]=null,C(r.gutterMarkers)&&(r.gutterMarkers=null),!0})})}),lineInfo:function(e){var t;if("number"==typeof e){if(!H(this,e))return null;if(t=e,!(e=M(this,e)))return null}else if(null==(t=W(e)))return null;return{line:t,handle:e,text:e.text,gutterMarkers:e.gutterMarkers,textClass:e.textClass,bgClass:e.bgClass,wrapClass:e.wrapClass,widgets:e.widgets}},addLineClass:gn(function(t,r,n){return Ri(this,t,"gutter"==r?"gutter":"class",function(t){var i="text"==r?"textClass":"background"==r?"bgClass":"gutter"==r?"gutterClass":"wrapClass";if(t[i]){if(e(n).test(t[i]))return!1;t[i]+=" "+n}else t[i]=n;return!0})}),removeLineClass:gn(function(t,r,n){return Ri(this,t,"gutter"==r?"gutter":"class",function(t){var i="text"==r?"textClass":"background"==r?"bgClass":"gutter"==r?"gutterClass":"wrapClass",o=t[i];if(!o)return!1;if(null==n)t[i]=null;else{var l=o.match(e(n));if(!l)return!1;var s=l.index+l[0].length;t[i]=o.slice(0,l.index)+(l.index&&s!=o.length?" ":"")+o.slice(s)||null}return!0})}),addLineWidget:gn(function(e,t,r){return Vi(this,e,t,r)}),removeLineWidget:function(e){e.clear()},markText:function(e,t,r){return Ki(this,U(this,e),U(this,t),r,r&&r.type||"range")},setBookmark:function(e,t){var r={replacedWith:t&&(null==t.nodeType?t.widget:t),insertLeft:t&&t.insertLeft,clearWhenEmpty:!1,shared:t&&t.shared,handleMouseEvents:t&&t.handleMouseEvents};return e=U(this,e),Ki(this,e,e,r,"bookmark")},findMarksAt:function(e){var t=[],r=M(this,(e=U(this,e)).line).markedSpans;if(r)for(var n=0;n<r.length;++n){var i=r[n];(null==i.from||i.from<=e.ch)&&(null==i.to||i.to>=e.ch)&&t.push(i.marker.parent||i.marker)}return t},findMarks:function(e,t,r){e=U(this,e),t=U(this,t);var n=[],i=e.line;return this.iter(e.line,t.line+1,function(o){var l=o.markedSpans;if(l)for(var s=0;s<l.length;s++){var a=l[s];null!=a.to&&i==e.line&&e.ch>=a.to||null==a.from&&i!=e.line||null!=a.from&&i==t.line&&a.from>=t.ch||r&&!r(a.marker)||n.push(a.marker.parent||a.marker)}++i}),n},getAllMarks:function(){var e=[];return this.iter(function(t){var r=t.markedSpans;if(r)for(var n=0;n<r.length;++n)null!=r[n].from&&e.push(r[n].marker)}),e},posFromIndex:function(e){var t,r=this.first,n=this.lineSeparator().length;return this.iter(function(i){var o=i.text.length+n;if(o>e)return t=e,!0;e-=o,++r}),U(this,E(r,t))},indexFromPos:function(e){var t=(e=U(this,e)).ch;if(e.line<this.first||e.ch<0)return 0;var r=this.lineSeparator().length;return this.iter(this.first,e.line,function(e){t+=e.text.length+r}),t},copy:function(e){var t=new Ds(O(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return t.scrollTop=this.scrollTop,t.scrollLeft=this.scrollLeft,t.sel=this.sel,t.extend=!1,e&&(t.history.undoDepth=this.history.undoDepth,t.setHistory(this.getHistory())),t},linkedDoc:function(e){e||(e={});var t=this.first,r=this.first+this.size;null!=e.from&&e.from>t&&(t=e.from),null!=e.to&&e.to<r&&(r=e.to);var n=new Ds(O(this,t,r),e.mode||this.modeOption,t,this.lineSep,this.direction);return e.sharedHist&&(n.history=this.history),(this.linked||(this.linked=[])).push({doc:n,sharedHist:e.sharedHist}),n.linked=[{doc:this,isParent:!0,sharedHist:e.sharedHist}],Yi(n,Xi(this)),n},unlinkDoc:function(e){var t=this;if(e instanceof jo&&(e=e.doc),this.linked)for(var r=0;r<this.linked.length;++r)if(t.linked[r].doc==e){t.linked.splice(r,1),e.unlinkDoc(t),_i(Xi(t));break}if(e.history==this.history){var n=[e.id];$n(e,function(e){return n.push(e.id)},!0),e.history=new Jn(null),e.history.done=fi(this.history.done,n),e.history.undone=fi(this.history.undone,n)}},iterLinkedDocs:function(e){$n(this,e)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(e){return this.lineSep?e.split(this.lineSep):es(e)},lineSeparator:function(){return this.lineSep||"\n"},setDirection:gn(function(e){"rtl"!=e&&(e="ltr"),e!=this.direction&&(this.direction=e,this.iter(function(e){return e.order=null}),this.cm&&Qn(this.cm))})}),Ds.prototype.eachLine=Ds.prototype.iter;for(var Hs=0,Fs=!1,Es={3:"Enter",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",106:"*",107:"=",109:"-",110:".",111:"/",127:"Delete",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},Ps=0;Ps<10;Ps++)Es[Ps+48]=Es[Ps+96]=String(Ps);for(var Is=65;Is<=90;Is++)Es[Is]=String.fromCharCode(Is);for(var zs=1;zs<=12;zs++)Es[zs+111]=Es[zs+63235]="F"+zs;var Rs={};Rs.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},Rs.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Up":"goLineUp","Ctrl-Down":"goLineDown","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},Rs.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Alt-F":"goWordRight","Alt-B":"goWordLeft","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-D":"delWordAfter","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars","Ctrl-O":"openLine"},Rs.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Home":"goDocStart","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineLeft","Cmd-Right":"goLineRight","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delWrappedLineLeft","Cmd-Delete":"delWrappedLineRight","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd",fallthrough:["basic","emacsy"]},Rs.default=Ml?Rs.macDefault:Rs.pcDefault;var Bs={selectAll:Mi,singleSelection:function(e){return e.setSelection(e.getCursor("anchor"),e.getCursor("head"),Gl)},killLine:function(e){return co(e,function(t){if(t.empty()){var r=M(e.doc,t.head.line).text.length;return t.head.ch==r&&t.head.line<e.lastLine()?{from:t.head,to:E(t.head.line+1,0)}:{from:t.head,to:E(t.head.line,r)}}return{from:t.from(),to:t.to()}})},deleteLine:function(e){return co(e,function(t){return{from:E(t.from().line,0),to:U(e.doc,E(t.to().line+1,0))}})},delLineLeft:function(e){return co(e,function(e){return{from:E(e.from().line,0),to:e.from()}})},delWrappedLineLeft:function(e){return co(e,function(t){var r=e.charCoords(t.head,"div").top+5;return{from:e.coordsChar({left:0,top:r},"div"),to:t.from()}})},delWrappedLineRight:function(e){return co(e,function(t){var r=e.charCoords(t.head,"div").top+5,n=e.coordsChar({left:e.display.lineDiv.offsetWidth+100,top:r},"div");return{from:t.from(),to:n}})},undo:function(e){return e.undo()},redo:function(e){return e.redo()},undoSelection:function(e){return e.undoSelection()},redoSelection:function(e){return e.redoSelection()},goDocStart:function(e){return e.extendSelection(E(e.firstLine(),0))},goDocEnd:function(e){return e.extendSelection(E(e.lastLine()))},goLineStart:function(e){return e.extendSelectionsBy(function(t){return vo(e,t.head.line)},{origin:"+move",bias:1})},goLineStartSmart:function(e){return e.extendSelectionsBy(function(t){return yo(e,t.head)},{origin:"+move",bias:1})},goLineEnd:function(e){return e.extendSelectionsBy(function(t){return mo(e,t.head.line)},{origin:"+move",bias:-1})},goLineRight:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5;return e.coordsChar({left:e.display.lineDiv.offsetWidth+100,top:r},"div")},Vl)},goLineLeft:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5;return e.coordsChar({left:0,top:r},"div")},Vl)},goLineLeftSmart:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5,n=e.coordsChar({left:0,top:r},"div");return n.ch<e.getLine(n.line).search(/\S/)?yo(e,t.head):n},Vl)},goLineUp:function(e){return e.moveV(-1,"line")},goLineDown:function(e){return e.moveV(1,"line")},goPageUp:function(e){return e.moveV(-1,"page")},goPageDown:function(e){return e.moveV(1,"page")},goCharLeft:function(e){return e.moveH(-1,"char")},goCharRight:function(e){return e.moveH(1,"char")},goColumnLeft:function(e){return e.moveH(-1,"column")},goColumnRight:function(e){return e.moveH(1,"column")},goWordLeft:function(e){return e.moveH(-1,"word")},goGroupRight:function(e){return e.moveH(1,"group")},goGroupLeft:function(e){return e.moveH(-1,"group")},goWordRight:function(e){return e.moveH(1,"word")},delCharBefore:function(e){return e.deleteH(-1,"char")},delCharAfter:function(e){return e.deleteH(1,"char")},delWordBefore:function(e){return e.deleteH(-1,"word")},delWordAfter:function(e){return e.deleteH(1,"word")},delGroupBefore:function(e){return e.deleteH(-1,"group")},delGroupAfter:function(e){return e.deleteH(1,"group")},indentAuto:function(e){return e.indentSelection("smart")},indentMore:function(e){return e.indentSelection("add")},indentLess:function(e){return e.indentSelection("subtract")},insertTab:function(e){return e.replaceSelection("\t")},insertSoftTab:function(e){for(var t=[],r=e.listSelections(),n=e.options.tabSize,i=0;i<r.length;i++){var o=r[i].from(),l=f(e.getLine(o.line),o.ch,n);t.push(p(n-l%n))}e.replaceSelections(t)},defaultTab:function(e){e.somethingSelected()?e.indentSelection("add"):e.execCommand("insertTab")},transposeChars:function(e){return hn(e,function(){for(var t=e.listSelections(),r=[],n=0;n<t.length;n++)if(t[n].empty()){var i=t[n].head,o=M(e.doc,i.line).text;if(o)if(i.ch==o.length&&(i=new E(i.line,i.ch-1)),i.ch>0)i=new E(i.line,i.ch+1),e.replaceRange(o.charAt(i.ch-1)+o.charAt(i.ch-2),E(i.line,i.ch-2),i,"+transpose");else if(i.line>e.doc.first){var l=M(e.doc,i.line-1).text;l&&(i=new E(i.line,1),e.replaceRange(o.charAt(0)+e.doc.lineSeparator()+l.charAt(l.length-1),E(i.line-1,l.length-1),i,"+transpose"))}r.push(new Ts(i,i))}e.setSelections(r)})},newlineAndIndent:function(e){return hn(e,function(){for(var t=e.listSelections(),r=t.length-1;r>=0;r--)e.replaceRange(e.doc.lineSeparator(),t[r].anchor,t[r].head,"+input");t=e.listSelections();for(var n=0;n<t.length;n++)e.indentLine(t[n].from().line,null,!0);jr(e)})},openLine:function(e){return e.replaceSelection("\n","start")},toggleOverwrite:function(e){return e.toggleOverwrite()}},Gs=new Pl,Us=null,Vs=function(e,t,r){this.time=e,this.pos=t,this.button=r};Vs.prototype.compare=function(e,t,r){return this.time+400>e&&0==P(t,this.pos)&&r==this.button};var Ks,js,Xs={toString:function(){return"CodeMirror.Init"}},Ys={},_s={};jo.defaults=Ys,jo.optionHandlers=_s;var $s=[];jo.defineInitHook=function(e){return $s.push(e)};var qs=null,Zs=function(e){this.cm=e,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new Pl,this.composing=null,this.gracePeriod=!1,this.readDOMTimeout=null};Zs.prototype.init=function(e){function t(e){if(!Me(i,e)){if(i.somethingSelected())_o({lineWise:!1,text:i.getSelections()}),"cut"==e.type&&i.replaceSelection("",null,"cut");else{if(!i.options.lineWiseCopyCut)return;var t=Qo(i);_o({lineWise:!0,text:t.text}),"cut"==e.type&&i.operation(function(){i.setSelections(t.ranges,0,Gl),i.replaceSelection("",null,"cut")})}if(e.clipboardData){e.clipboardData.clearData();var r=qs.text.join("\n");if(e.clipboardData.setData("Text",r),e.clipboardData.getData("Text")==r)return void e.preventDefault()}var l=el(),s=l.firstChild;i.display.lineSpace.insertBefore(l,i.display.lineSpace.firstChild),s.value=qs.text.join("\n");var a=document.activeElement;El(s),setTimeout(function(){i.display.lineSpace.removeChild(l),a.focus(),a==o&&n.showPrimarySelection()},50)}}var r=this,n=this,i=n.cm,o=n.div=e.lineDiv;Jo(o,i.options.spellcheck),Ql(o,"paste",function(e){Me(i,e)||qo(e,i)||vl<=11&&setTimeout(dn(i,function(){return r.updateFromDOM()}),20)}),Ql(o,"compositionstart",function(e){r.composing={data:e.data,done:!1}}),Ql(o,"compositionupdate",function(e){r.composing||(r.composing={data:e.data,done:!1})}),Ql(o,"compositionend",function(e){r.composing&&(e.data!=r.composing.data&&r.readFromDOMSoon(),r.composing.done=!0)}),Ql(o,"touchstart",function(){return n.forceCompositionEnd()}),Ql(o,"input",function(){r.composing||r.readFromDOMSoon()}),Ql(o,"copy",t),Ql(o,"cut",t)},Zs.prototype.prepareSelection=function(){var e=Tr(this.cm,!1);return e.focus=this.cm.state.focused,e},Zs.prototype.showSelection=function(e,t){e&&this.cm.display.view.length&&((e.focus||t)&&this.showPrimarySelection(),this.showMultipleSelections(e))},Zs.prototype.showPrimarySelection=function(){var e=window.getSelection(),t=this.cm,r=t.doc.sel.primary(),n=r.from(),i=r.to();if(t.display.viewTo==t.display.viewFrom||n.line>=t.display.viewTo||i.line<t.display.viewFrom)e.removeAllRanges();else{var o=sl(t,e.anchorNode,e.anchorOffset),l=sl(t,e.focusNode,e.focusOffset);if(!o||o.bad||!l||l.bad||0!=P(B(o,l),n)||0!=P(R(o,l),i)){var s=t.display.view,a=n.line>=t.display.viewFrom&&nl(t,n)||{node:s[0].measure.map[2],offset:0},u=i.line<t.display.viewTo&&nl(t,i);if(!u){var c=s[s.length-1].measure,f=c.maps?c.maps[c.maps.length-1]:c.map;u={node:f[f.length-1],offset:f[f.length-2]-f[f.length-3]}}if(a&&u){var h,d=e.rangeCount&&e.getRangeAt(0);try{h=Wl(a.node,a.offset,u.offset,u.node)}catch(e){}h&&(!fl&&t.state.focused?(e.collapse(a.node,a.offset),h.collapsed||(e.removeAllRanges(),e.addRange(h))):(e.removeAllRanges(),e.addRange(h)),d&&null==e.anchorNode?e.addRange(d):fl&&this.startGracePeriod()),this.rememberSelection()}else e.removeAllRanges()}}},Zs.prototype.startGracePeriod=function(){var e=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout(function(){e.gracePeriod=!1,e.selectionChanged()&&e.cm.operation(function(){return e.cm.curOp.selectionChanged=!0})},20)},Zs.prototype.showMultipleSelections=function(e){r(this.cm.display.cursorDiv,e.cursors),r(this.cm.display.selectionDiv,e.selection)},Zs.prototype.rememberSelection=function(){var e=window.getSelection();this.lastAnchorNode=e.anchorNode,this.lastAnchorOffset=e.anchorOffset,this.lastFocusNode=e.focusNode,this.lastFocusOffset=e.focusOffset},Zs.prototype.selectionInEditor=function(){var e=window.getSelection();if(!e.rangeCount)return!1;var t=e.getRangeAt(0).commonAncestorContainer;return o(this.div,t)},Zs.prototype.focus=function(){"nocursor"!=this.cm.options.readOnly&&(this.selectionInEditor()||this.showSelection(this.prepareSelection(),!0),this.div.focus())},Zs.prototype.blur=function(){this.div.blur()},Zs.prototype.getField=function(){return this.div},Zs.prototype.supportsTouch=function(){return!0},Zs.prototype.receivedFocus=function(){function e(){t.cm.state.focused&&(t.pollSelection(),t.polling.set(t.cm.options.pollInterval,e))}var t=this;this.selectionInEditor()?this.pollSelection():hn(this.cm,function(){return t.cm.curOp.selectionChanged=!0}),this.polling.set(this.cm.options.pollInterval,e)},Zs.prototype.selectionChanged=function(){var e=window.getSelection();return e.anchorNode!=this.lastAnchorNode||e.anchorOffset!=this.lastAnchorOffset||e.focusNode!=this.lastFocusNode||e.focusOffset!=this.lastFocusOffset},Zs.prototype.pollSelection=function(){if(null==this.readDOMTimeout&&!this.gracePeriod&&this.selectionChanged()){var e=window.getSelection(),t=this.cm;if(kl&&bl&&this.cm.options.gutters.length&&il(e.anchorNode))return this.cm.triggerOnKeyDown({type:"keydown",keyCode:8,preventDefault:Math.abs}),this.blur(),void this.focus();if(!this.composing){this.rememberSelection();var r=sl(t,e.anchorNode,e.anchorOffset),n=sl(t,e.focusNode,e.focusOffset);r&&n&&hn(t,function(){bi(t.doc,Rn(r,n),Gl),(r.bad||n.bad)&&(t.curOp.selectionChanged=!0)})}}},Zs.prototype.pollContent=function(){null!=this.readDOMTimeout&&(clearTimeout(this.readDOMTimeout),this.readDOMTimeout=null);var e=this.cm,t=e.display,r=e.doc.sel.primary(),n=r.from(),i=r.to();if(0==n.ch&&n.line>e.firstLine()&&(n=E(n.line-1,M(e.doc,n.line-1).length)),i.ch==M(e.doc,i.line).text.length&&i.line<e.lastLine()&&(i=E(i.line+1,0)),n.line<t.viewFrom||i.line>t.viewTo-1)return!1;var o,l,s;n.line==t.viewFrom||0==(o=Lr(e,n.line))?(l=W(t.view[0].line),s=t.view[0].node):(l=W(t.view[o].line),s=t.view[o-1].node.nextSibling);var a,u,c=Lr(e,i.line);if(c==t.view.length-1?(a=t.viewTo-1,u=t.lineDiv.lastChild):(a=W(t.view[c+1].line)-1,u=t.view[c+1].node.previousSibling),!s)return!1;for(var f=e.doc.splitLines(ll(e,s,u,l,a)),h=N(e.doc,E(l,0),E(a,M(e.doc,a).text.length));f.length>1&&h.length>1;)if(g(f)==g(h))f.pop(),h.pop(),a--;else{if(f[0]!=h[0])break;f.shift(),h.shift(),l++}for(var d=0,p=0,v=f[0],m=h[0],y=Math.min(v.length,m.length);d<y&&v.charCodeAt(d)==m.charCodeAt(d);)++d;for(var b=g(f),w=g(h),x=Math.min(b.length-(1==f.length?d:0),w.length-(1==h.length?d:0));p<x&&b.charCodeAt(b.length-p-1)==w.charCodeAt(w.length-p-1);)++p;if(1==f.length&&1==h.length&&l==n.line)for(;d&&d>n.ch&&b.charCodeAt(b.length-p-1)==w.charCodeAt(w.length-p-1);)d--,p++;f[f.length-1]=b.slice(0,b.length-p).replace(/^\u200b+/,""),f[0]=f[0].slice(d).replace(/\u200b+$/,"");var C=E(l,d),S=E(a,h.length?g(h).length-p:0);return f.length>1||f[0]||P(C,S)?(Ei(e.doc,f,C,S,"+input"),!0):void 0},Zs.prototype.ensurePolled=function(){this.forceCompositionEnd()},Zs.prototype.reset=function(){this.forceCompositionEnd()},Zs.prototype.forceCompositionEnd=function(){this.composing&&(clearTimeout(this.readDOMTimeout),this.composing=null,this.updateFromDOM(),this.div.blur(),this.div.focus())},Zs.prototype.readFromDOMSoon=function(){var e=this;null==this.readDOMTimeout&&(this.readDOMTimeout=setTimeout(function(){if(e.readDOMTimeout=null,e.composing){if(!e.composing.done)return;e.composing=null}e.updateFromDOM()},80))},Zs.prototype.updateFromDOM=function(){var e=this;!this.cm.isReadOnly()&&this.pollContent()||hn(this.cm,function(){return vn(e.cm)})},Zs.prototype.setUneditable=function(e){e.contentEditable="false"},Zs.prototype.onKeyPress=function(e){0!=e.charCode&&(e.preventDefault(),this.cm.isReadOnly()||dn(this.cm,$o)(this.cm,String.fromCharCode(null==e.charCode?e.keyCode:e.charCode),0))},Zs.prototype.readOnlyChanged=function(e){this.div.contentEditable=String("nocursor"!=e)},Zs.prototype.onContextMenu=function(){},Zs.prototype.resetPosition=function(){},Zs.prototype.needsContentAttribute=!0;var Qs=function(e){this.cm=e,this.prevInput="",this.pollingFast=!1,this.polling=new Pl,this.hasSelection=!1,this.composing=null};Qs.prototype.init=function(e){function t(e){if(!Me(i,e)){if(i.somethingSelected())_o({lineWise:!1,text:i.getSelections()});else{if(!i.options.lineWiseCopyCut)return;var t=Qo(i);_o({lineWise:!0,text:t.text}),"cut"==e.type?i.setSelections(t.ranges,null,Gl):(n.prevInput="",l.value=t.text.join("\n"),El(l))}"cut"==e.type&&(i.state.cutIncoming=!0)}}var r=this,n=this,i=this.cm,o=this.wrapper=el(),l=this.textarea=o.firstChild;e.wrapper.insertBefore(o,e.wrapper.firstChild),Ll&&(l.style.width="0px"),Ql(l,"input",function(){gl&&vl>=9&&r.hasSelection&&(r.hasSelection=null),n.poll()}),Ql(l,"paste",function(e){Me(i,e)||qo(e,i)||(i.state.pasteIncoming=!0,n.fastPoll())}),Ql(l,"cut",t),Ql(l,"copy",t),Ql(e.scroller,"paste",function(t){Ft(e,t)||Me(i,t)||(i.state.pasteIncoming=!0,n.focus())}),Ql(e.lineSpace,"selectstart",function(t){Ft(e,t)||We(t)}),Ql(l,"compositionstart",function(){var e=i.getCursor("from");n.composing&&n.composing.range.clear(),n.composing={start:e,range:i.markText(e,i.getCursor("to"),{className:"CodeMirror-composing"})}}),Ql(l,"compositionend",function(){n.composing&&(n.poll(),n.composing.range.clear(),n.composing=null)})},Qs.prototype.prepareSelection=function(){var e=this.cm,t=e.display,r=e.doc,n=Tr(e);if(e.options.moveInputWithCursor){var i=sr(e,r.sel.primary().head,"div"),o=t.wrapper.getBoundingClientRect(),l=t.lineDiv.getBoundingClientRect();n.teTop=Math.max(0,Math.min(t.wrapper.clientHeight-10,i.top+l.top-o.top)),n.teLeft=Math.max(0,Math.min(t.wrapper.clientWidth-10,i.left+l.left-o.left))}return n},Qs.prototype.showSelection=function(e){var t=this.cm.display;r(t.cursorDiv,e.cursors),r(t.selectionDiv,e.selection),null!=e.teTop&&(this.wrapper.style.top=e.teTop+"px",this.wrapper.style.left=e.teLeft+"px")},Qs.prototype.reset=function(e){if(!this.contextMenuPending&&!this.composing){var t=this.cm;if(t.somethingSelected()){this.prevInput="";var r=t.getSelection();this.textarea.value=r,t.state.focused&&El(this.textarea),gl&&vl>=9&&(this.hasSelection=r)}else e||(this.prevInput=this.textarea.value="",gl&&vl>=9&&(this.hasSelection=null))}},Qs.prototype.getField=function(){return this.textarea},Qs.prototype.supportsTouch=function(){return!1},Qs.prototype.focus=function(){if("nocursor"!=this.cm.options.readOnly&&(!Tl||l()!=this.textarea))try{this.textarea.focus()}catch(e){}},Qs.prototype.blur=function(){this.textarea.blur()},Qs.prototype.resetPosition=function(){this.wrapper.style.top=this.wrapper.style.left=0},Qs.prototype.receivedFocus=function(){this.slowPoll()},Qs.prototype.slowPoll=function(){var e=this;this.pollingFast||this.polling.set(this.cm.options.pollInterval,function(){e.poll(),e.cm.state.focused&&e.slowPoll()})},Qs.prototype.fastPoll=function(){function e(){r.poll()||t?(r.pollingFast=!1,r.slowPoll()):(t=!0,r.polling.set(60,e))}var t=!1,r=this;r.pollingFast=!0,r.polling.set(20,e)},Qs.prototype.poll=function(){var e=this,t=this.cm,r=this.textarea,n=this.prevInput;if(this.contextMenuPending||!t.state.focused||ts(r)&&!n&&!this.composing||t.isReadOnly()||t.options.disableInput||t.state.keySeq)return!1;var i=r.value;if(i==n&&!t.somethingSelected())return!1;if(gl&&vl>=9&&this.hasSelection===i||Ml&&/[\uf700-\uf7ff]/.test(i))return t.display.input.reset(),!1;if(t.doc.sel==t.display.selForContextMenu){var o=i.charCodeAt(0);if(8203!=o||n||(n="​"),8666==o)return this.reset(),this.cm.execCommand("undo")}for(var l=0,s=Math.min(n.length,i.length);l<s&&n.charCodeAt(l)==i.charCodeAt(l);)++l;return hn(t,function(){$o(t,i.slice(l),n.length-l,null,e.composing?"*compose":null),i.length>1e3||i.indexOf("\n")>-1?r.value=e.prevInput="":e.prevInput=i,e.composing&&(e.composing.range.clear(),e.composing.range=t.markText(e.composing.start,t.getCursor("to"),{className:"CodeMirror-composing"}))}),!0},Qs.prototype.ensurePolled=function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},Qs.prototype.onKeyPress=function(){gl&&vl>=9&&(this.hasSelection=null),this.fastPoll()},Qs.prototype.onContextMenu=function(e){function t(){if(null!=l.selectionStart){var e=i.somethingSelected(),t="​"+(e?l.value:"");l.value="⇚",l.value=t,n.prevInput=e?"":"​",l.selectionStart=1,l.selectionEnd=t.length,o.selForContextMenu=i.doc.sel}}function r(){if(n.contextMenuPending=!1,n.wrapper.style.cssText=c,l.style.cssText=u,gl&&vl<9&&o.scrollbars.setScrollTop(o.scroller.scrollTop=a),null!=l.selectionStart){(!gl||gl&&vl<9)&&t();var e=0,r=function(){o.selForContextMenu==i.doc.sel&&0==l.selectionStart&&l.selectionEnd>0&&"​"==n.prevInput?dn(i,Mi)(i):e++<10?o.detectingSelectAll=setTimeout(r,500):(o.selForContextMenu=null,o.input.reset())};o.detectingSelectAll=setTimeout(r,200)}}var n=this,i=n.cm,o=i.display,l=n.textarea,s=Sr(i,e),a=o.scroller.scrollTop;if(s&&!wl){i.options.resetSelectionOnContextMenu&&-1==i.doc.sel.contains(s)&&dn(i,bi)(i.doc,Rn(s),Gl);var u=l.style.cssText,c=n.wrapper.style.cssText;n.wrapper.style.cssText="position: absolute";var f=n.wrapper.getBoundingClientRect();l.style.cssText="position: absolute; width: 30px; height: 30px;\n      top: "+(e.clientY-f.top-5)+"px; left: "+(e.clientX-f.left-5)+"px;\n      z-index: 1000; background: "+(gl?"rgba(255, 255, 255, .05)":"transparent")+";\n      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);";var h;if(ml&&(h=window.scrollY),o.input.focus(),ml&&window.scrollTo(null,h),o.input.reset(),i.somethingSelected()||(l.value=n.prevInput=" "),n.contextMenuPending=!0,o.selForContextMenu=i.doc.sel,clearTimeout(o.detectingSelectAll),gl&&vl>=9&&t(),Hl){Fe(e);var d=function(){ke(window,"mouseup",d),setTimeout(r,20)};Ql(window,"mouseup",d)}else setTimeout(r,50)}},Qs.prototype.readOnlyChanged=function(e){e||this.reset(),this.textarea.disabled="nocursor"==e},Qs.prototype.setUneditable=function(){},Qs.prototype.needsContentAttribute=!1,function(e){function t(t,n,i,o){e.defaults[t]=n,i&&(r[t]=o?function(e,t,r){r!=Xs&&i(e,t,r)}:i)}var r=e.optionHandlers;e.defineOption=t,e.Init=Xs,t("value","",function(e,t){return e.setValue(t)},!0),t("mode",null,function(e,t){e.doc.modeOption=t,jn(e)},!0),t("indentUnit",2,jn,!0),t("indentWithTabs",!1),t("smartIndent",!0),t("tabSize",4,function(e){Xn(e),er(e),vn(e)},!0),t("lineSeparator",null,function(e,t){if(e.doc.lineSep=t,t){var r=[],n=e.doc.first;e.doc.iter(function(e){for(var i=0;;){var o=e.text.indexOf(t,i);if(-1==o)break;i=o+t.length,r.push(E(n,o))}n++});for(var i=r.length-1;i>=0;i--)Ei(e.doc,t,r[i],E(r[i].line,r[i].ch+t.length))}}),t("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b-\u200f\u2028\u2029\ufeff]/g,function(e,t,r){e.state.specialChars=new RegExp(t.source+(t.test("\t")?"":"|\t"),"g"),r!=Xs&&e.refresh()}),t("specialCharPlaceholder",at,function(e){return e.refresh()},!0),t("electricChars",!0),t("inputStyle",Tl?"contenteditable":"textarea",function(){throw new Error("inputStyle can not (yet) be changed in a running editor")},!0),t("spellcheck",!1,function(e,t){return e.getInputField().spellcheck=t},!0),t("rtlMoveVisually",!Ol),t("wholeLineUpdateBefore",!0),t("theme","default",function(e){Go(e),Uo(e)},!0),t("keyMap","default",function(e,t,r){var n=uo(t),i=r!=Xs&&uo(r);i&&i.detach&&i.detach(e,n),n.attach&&n.attach(e,i||null)}),t("extraKeys",null),t("configureMouse",null),t("lineWrapping",!1,Ko,!0),t("gutters",[],function(e){Fn(e.options),Uo(e)},!0),t("fixedGutter",!0,function(e,t){e.display.gutters.style.left=t?wr(e.display)+"px":"0",e.refresh()},!0),t("coverGutterNextToScrollbar",!1,function(e){return en(e)},!0),t("scrollbarStyle","native",function(e){rn(e),en(e),e.display.scrollbars.setScrollTop(e.doc.scrollTop),e.display.scrollbars.setScrollLeft(e.doc.scrollLeft)},!0),t("lineNumbers",!1,function(e){Fn(e.options),Uo(e)},!0),t("firstLineNumber",1,Uo,!0),t("lineNumberFormatter",function(e){return e},Uo,!0),t("showCursorWhenSelecting",!1,kr,!0),t("resetSelectionOnContextMenu",!0),t("lineWiseCopyCut",!0),t("pasteLinesPerSelection",!0),t("readOnly",!1,function(e,t){"nocursor"==t&&(Fr(e),e.display.input.blur()),e.display.input.readOnlyChanged(t)}),t("disableInput",!1,function(e,t){t||e.display.input.reset()},!0),t("dragDrop",!0,Vo),t("allowDropFileTypes",null),t("cursorBlinkRate",530),t("cursorScrollMargin",0),t("cursorHeight",1,kr,!0),t("singleCursorHeightPerLine",!0,kr,!0),t("workTime",100),t("workDelay",100),t("flattenSpans",!0,Xn,!0),t("addModeClass",!1,Xn,!0),t("pollInterval",100),t("undoDepth",200,function(e,t){return e.doc.history.undoDepth=t}),t("historyEventDelay",1250),t("viewportMargin",10,function(e){return e.refresh()},!0),t("maxHighlightLength",1e4,Xn,!0),t("moveInputWithCursor",!0,function(e,t){t||e.display.input.resetPosition()}),t("tabindex",null,function(e,t){return e.display.input.getField().tabIndex=t||""}),t("autofocus",null),t("direction","ltr",function(e,t){return e.doc.setDirection(t)},!0)}(jo),function(e){var t=e.optionHandlers,r=e.helpers={};e.prototype={constructor:e,focus:function(){window.focus(),this.display.input.focus()},setOption:function(e,r){var n=this.options,i=n[e];n[e]==r&&"mode"!=e||(n[e]=r,t.hasOwnProperty(e)&&dn(this,t[e])(this,r,i),Te(this,"optionChange",this,e))},getOption:function(e){return this.options[e]},getDoc:function(){return this.doc},addKeyMap:function(e,t){this.state.keyMaps[t?"push":"unshift"](uo(e))},removeKeyMap:function(e){for(var t=this.state.keyMaps,r=0;r<t.length;++r)if(t[r]==e||t[r].name==e)return t.splice(r,1),!0},addOverlay:pn(function(t,r){var n=t.token?t:e.getMode(this.options,t);if(n.startState)throw new Error("Overlays may not be stateful.");m(this.state.overlays,{mode:n,modeSpec:t,opaque:r&&r.opaque,priority:r&&r.priority||0},function(e){return e.priority}),this.state.modeGen++,vn(this)}),removeOverlay:pn(function(e){for(var t=this,r=this.state.overlays,n=0;n<r.length;++n){var i=r[n].modeSpec;if(i==e||"string"==typeof e&&i.name==e)return r.splice(n,1),t.state.modeGen++,void vn(t)}}),indentLine:pn(function(e,t,r){"string"!=typeof t&&"number"!=typeof t&&(t=null==t?this.options.smartIndent?"smart":"prev":t?"add":"subtract"),H(this.doc,e)&&Yo(this,e,t,r)}),indentSelection:pn(function(e){for(var t=this,r=this.doc.sel.ranges,n=-1,i=0;i<r.length;i++){var o=r[i];if(o.empty())o.head.line>n&&(Yo(t,o.head.line,e,!0),n=o.head.line,i==t.doc.sel.primIndex&&jr(t));else{var l=o.from(),s=o.to(),a=Math.max(n,l.line);n=Math.min(t.lastLine(),s.line-(s.ch?0:1))+1;for(var u=a;u<n;++u)Yo(t,u,e);var c=t.doc.sel.ranges;0==l.ch&&r.length==c.length&&c[i].from().ch>0&&gi(t.doc,i,new Ts(l,c[i].to()),Gl)}}}),getTokenAt:function(e,t){return Je(this,e,t)},getLineTokens:function(e,t){return Je(this,E(e),t,!0)},getTokenTypeAt:function(e){e=U(this.doc,e);var t,r=_e(this,M(this.doc,e.line)),n=0,i=(r.length-1)/2,o=e.ch;if(0==o)t=r[2];else for(;;){var l=n+i>>1;if((l?r[2*l-1]:0)>=o)i=l;else{if(!(r[2*l+1]<o)){t=r[2*l+2];break}n=l+1}}var s=t?t.indexOf("overlay "):-1;return s<0?t:0==s?null:t.slice(0,s-1)},getModeAt:function(t){var r=this.doc.mode;return r.innerMode?e.innerMode(r,this.getTokenAt(t).state).mode:r},getHelper:function(e,t){return this.getHelpers(e,t)[0]},getHelpers:function(e,t){var n=this,i=[];if(!r.hasOwnProperty(t))return i;var o=r[t],l=this.getModeAt(e);if("string"==typeof l[t])o[l[t]]&&i.push(o[l[t]]);else if(l[t])for(var s=0;s<l[t].length;s++){var a=o[l[t][s]];a&&i.push(a)}else l.helperType&&o[l.helperType]?i.push(o[l.helperType]):o[l.name]&&i.push(o[l.name]);for(var u=0;u<o._global.length;u++){var c=o._global[u];c.pred(l,n)&&-1==h(i,c.val)&&i.push(c.val)}return i},getStateAfter:function(e,t){var r=this.doc;return e=G(r,null==e?r.first+r.size-1:e),$e(this,e+1,t).state},cursorCoords:function(e,t){var r,n=this.doc.sel.primary();return r=null==e?n.head:"object"==typeof e?U(this.doc,e):e?n.from():n.to(),sr(this,r,t||"page")},charCoords:function(e,t){return lr(this,U(this.doc,e),t||"page")},coordsChar:function(e,t){return e=or(this,e,t||"page"),cr(this,e.left,e.top)},lineAtHeight:function(e,t){return e=or(this,{top:e,left:0},t||"page").top,D(this.doc,e+this.display.viewOffset)},heightAtLine:function(e,t,r){var n,i=!1;if("number"==typeof e){var o=this.doc.first+this.doc.size-1;e<this.doc.first?e=this.doc.first:e>o&&(e=o,i=!0),n=M(this.doc,e)}else n=e;return ir(this,n,{top:0,left:0},t||"page",r||i).top+(i?this.doc.height-ye(n):0)},defaultTextHeight:function(){return mr(this.display)},defaultCharWidth:function(){return yr(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(e,t,r,n,i){var o=this.display,l=(e=sr(this,U(this.doc,e))).bottom,s=e.left;if(t.style.position="absolute",t.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(t),o.sizer.appendChild(t),"over"==n)l=e.top;else if("above"==n||"near"==n){var a=Math.max(o.wrapper.clientHeight,this.doc.height),u=Math.max(o.sizer.clientWidth,o.lineSpace.clientWidth);("above"==n||e.bottom+t.offsetHeight>a)&&e.top>t.offsetHeight?l=e.top-t.offsetHeight:e.bottom+t.offsetHeight<=a&&(l=e.bottom),s+t.offsetWidth>u&&(s=u-t.offsetWidth)}t.style.top=l+"px",t.style.left=t.style.right="","right"==i?(s=o.sizer.clientWidth-t.offsetWidth,t.style.right="0px"):("left"==i?s=0:"middle"==i&&(s=(o.sizer.clientWidth-t.offsetWidth)/2),t.style.left=s+"px"),r&&Ur(this,{left:s,top:l,right:s+t.offsetWidth,bottom:l+t.offsetHeight})},triggerOnKeyDown:pn(Lo),triggerOnKeyPress:pn(Mo),triggerOnKeyUp:To,triggerOnMouseDown:pn(Oo),execCommand:function(e){if(Bs.hasOwnProperty(e))return Bs[e].call(null,this)},triggerElectric:pn(function(e){Zo(this,e)}),findPosH:function(e,t,r,n){var i=this,o=1;t<0&&(o=-1,t=-t);for(var l=U(this.doc,e),s=0;s<t&&!(l=tl(i.doc,l,o,r,n)).hitSide;++s);return l},moveH:pn(function(e,t){var r=this;this.extendSelectionsBy(function(n){return r.display.shift||r.doc.extend||n.empty()?tl(r.doc,n.head,e,t,r.options.rtlMoveVisually):e<0?n.from():n.to()},Vl)}),deleteH:pn(function(e,t){var r=this.doc.sel,n=this.doc;r.somethingSelected()?n.replaceSelection("",null,"+delete"):co(this,function(r){var i=tl(n,r.head,e,t,!1);return e<0?{from:i,to:r.head}:{from:r.head,to:i}})}),findPosV:function(e,t,r,n){var i=this,o=1,l=n;t<0&&(o=-1,t=-t);for(var s=U(this.doc,e),a=0;a<t;++a){var u=sr(i,s,"div");if(null==l?l=u.left:u.left=l,(s=rl(i,u,o,r)).hitSide)break}return s},moveV:pn(function(e,t){var r=this,n=this.doc,i=[],o=!this.display.shift&&!n.extend&&n.sel.somethingSelected();if(n.extendSelectionsBy(function(l){if(o)return e<0?l.from():l.to();var s=sr(r,l.head,"div");null!=l.goalColumn&&(s.left=l.goalColumn),i.push(s.left);var a=rl(r,s,e,t);return"page"==t&&l==n.sel.primary()&&Kr(r,lr(r,a,"div").top-s.top),a},Vl),i.length)for(var l=0;l<n.sel.ranges.length;l++)n.sel.ranges[l].goalColumn=i[l]}),findWordAt:function(e){var t=M(this.doc,e.line).text,r=e.ch,n=e.ch;if(t){var i=this.getHelper(e,"wordChars");"before"!=e.sticky&&n!=t.length||!r?++n:--r;for(var o=t.charAt(r),l=x(o,i)?function(e){return x(e,i)}:/\s/.test(o)?function(e){return/\s/.test(e)}:function(e){return!/\s/.test(e)&&!x(e)};r>0&&l(t.charAt(r-1));)--r;for(;n<t.length&&l(t.charAt(n));)++n}return new Ts(E(e.line,r),E(e.line,n))},toggleOverwrite:function(e){null!=e&&e==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?s(this.display.cursorDiv,"CodeMirror-overwrite"):Fl(this.display.cursorDiv,"CodeMirror-overwrite"),Te(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==l()},isReadOnly:function(){return!(!this.options.readOnly&&!this.doc.cantEdit)},scrollTo:pn(function(e,t){Xr(this,e,t)}),getScrollInfo:function(){var e=this.display.scroller;return{left:e.scrollLeft,top:e.scrollTop,height:e.scrollHeight-zt(this)-this.display.barHeight,width:e.scrollWidth-zt(this)-this.display.barWidth,clientHeight:Bt(this),clientWidth:Rt(this)}},scrollIntoView:pn(function(e,t){null==e?(e={from:this.doc.sel.primary().head,to:null},null==t&&(t=this.options.cursorScrollMargin)):"number"==typeof e?e={from:E(e,0),to:null}:null==e.from&&(e={from:e,to:null}),e.to||(e.to=e.from),e.margin=t||0,null!=e.from.line?Yr(this,e):$r(this,e.from,e.to,e.margin)}),setSize:pn(function(e,t){var r=this,n=function(e){return"number"==typeof e||/^\d+$/.test(String(e))?e+"px":e};null!=e&&(this.display.wrapper.style.width=n(e)),null!=t&&(this.display.wrapper.style.height=n(t)),this.options.lineWrapping&&Jt(this);var i=this.display.viewFrom;this.doc.iter(i,this.display.viewTo,function(e){if(e.widgets)for(var t=0;t<e.widgets.length;t++)if(e.widgets[t].noHScroll){mn(r,i,"widget");break}++i}),this.curOp.forceUpdate=!0,Te(this,"refresh",this)}),operation:function(e){return hn(this,e)},startOperation:function(){return nn(this)},endOperation:function(){return on(this)},refresh:pn(function(){var e=this.display.cachedTextHeight;vn(this),this.curOp.forceUpdate=!0,er(this),Xr(this,this.doc.scrollLeft,this.doc.scrollTop),Wn(this),(null==e||Math.abs(e-mr(this.display))>.5)&&Cr(this),Te(this,"refresh",this)}),swapDoc:pn(function(e){var t=this.doc;return t.cm=null,qn(this,e),er(this),this.display.input.reset(),Xr(this,e.scrollLeft,e.scrollTop),this.curOp.forceScroll=!0,bt(this,"swapDoc",this,t),t}),getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},Ae(e),e.registerHelper=function(t,n,i){r.hasOwnProperty(t)||(r[t]=e[t]={_global:[]}),r[t][n]=i},e.registerGlobalHelper=function(t,n,i,o){e.registerHelper(t,n,o),r[t]._global.push({pred:i,val:o})}}(jo);var Js="iter insert remove copy getEditor constructor".split(" ");for(var ea in Ds.prototype)Ds.prototype.hasOwnProperty(ea)&&h(Js,ea)<0&&(jo.prototype[ea]=function(e){return function(){return e.apply(this.doc,arguments)}}(Ds.prototype[ea]));return Ae(Ds),jo.inputStyles={textarea:Qs,contenteditable:Zs},jo.defineMode=function(e){jo.defaults.mode||"null"==e||(jo.defaults.mode=e),Be.apply(this,arguments)},jo.defineMIME=function(e,t){os[e]=t},jo.defineMode("null",function(){return{token:function(e){return e.skipToEnd()}}}),jo.defineMIME("text/plain","null"),jo.defineExtension=function(e,t){jo.prototype[e]=t},jo.defineDocExtension=function(e,t){Ds.prototype[e]=t},jo.fromTextArea=function(e,t){function r(){e.value=a.getValue()}if(t=t?c(t):{},t.value=e.value,!t.tabindex&&e.tabIndex&&(t.tabindex=e.tabIndex),!t.placeholder&&e.placeholder&&(t.placeholder=e.placeholder),null==t.autofocus){var n=l();t.autofocus=n==e||null!=e.getAttribute("autofocus")&&n==document.body}var i;if(e.form&&(Ql(e.form,"submit",r),!t.leaveSubmitMethodAlone)){var o=e.form;i=o.submit;try{var s=o.submit=function(){r(),o.submit=i,o.submit(),o.submit=s}}catch(e){}}t.finishInit=function(t){t.save=r,t.getTextArea=function(){return e},t.toTextArea=function(){t.toTextArea=isNaN,r(),e.parentNode.removeChild(t.getWrapperElement()),e.style.display="",e.form&&(ke(e.form,"submit",r),"function"==typeof e.form.submit&&(e.form.submit=i))}},e.style.display="none";var a=jo(function(t){return e.parentNode.insertBefore(t,e.nextSibling)},t);return a},function(e){e.off=ke,e.on=Ql,e.wheelEventPixels=Pn,e.Doc=Ds,e.splitLines=es,e.countColumn=f,e.findColumn=d,e.isWordChar=w,e.Pass=Bl,e.signal=Te,e.Line=fs,e.changeEnd=Bn,e.scrollbarModel=ws,e.Pos=E,e.cmpPos=P,e.modes=is,e.mimeModes=os,e.resolveMode=Ge,e.getMode=Ue,e.modeExtensions=ls,e.extendMode=Ve,e.copyState=Ke,e.startState=Xe,e.innerMode=je,e.commands=Bs,e.keyMap=Rs,e.keyName=ao,e.isModifierKey=lo,e.lookupKey=oo,e.normalizeKeyMap=io,e.StringStream=ss,e.SharedTextMarker=As,e.TextMarker=Os,e.LineWidget=Ms,e.e_preventDefault=We,e.e_stopPropagation=De,e.e_stop=Fe,e.addClass=s,e.contains=o,e.rmClass=Fl,e.keyNames=Es}(jo),jo.version="5.30.0",jo});
      !function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){"use strict";function t(e,t,n,r,o,a){this.indented=e,this.column=t,this.type=n,this.info=r,this.align=o,this.prev=a}function n(e,n,r,o){var a=e.indented;return e.context&&"statement"==e.context.type&&"statement"!=r&&(a=e.context.indented),e.context=new t(a,n,r,o,null,e.context)}function r(e){var t=e.context.type;return")"!=t&&"]"!=t&&"}"!=t||(e.indented=e.context.indented),e.context=e.context.prev}function o(e,t,n){return"variable"==t.prevToken||"type"==t.prevToken||(!!/\S(?:[^- ]>|[*\]])\s*$|\*$/.test(e.string.slice(0,n))||(!(!t.typeAtEndOfLine||e.column()!=e.indentation())||void 0))}function a(e){for(;;){if(!e||"top"==e.type)return!0;if("}"==e.type&&"namespace"!=e.prev.info)return!1;e=e.prev}}function i(e){for(var t={},n=e.split(" "),r=0;r<n.length;++r)t[n[r]]=!0;return t}function l(e,t){return"function"==typeof e?e(t):e.propertyIsEnumerable(t)}function s(e,t){if(!t.startOfLine)return!1;for(var n,r=null;n=e.peek();){if("\\"==n&&e.match(/^.$/)){r=s;break}if("/"==n&&e.match(/^\/[\/\*]/,!1))break;e.next()}return t.tokenize=r,"meta"}function c(e,t){return"type"==t.prevToken&&"type"}function u(e){return e.eatWhile(/[\w\.']/),"number"}function d(e,t){if(e.backUp(1),e.match(/(R|u8R|uR|UR|LR)/)){var n=e.match(/"([^\s\\()]{0,16})\(/);return!!n&&(t.cpp11RawStringDelim=n[1],t.tokenize=m,m(e,t))}return e.match(/(u8|u|U|L)/)?!!e.match(/["']/,!1)&&"string":(e.next(),!1)}function f(e){var t=/(\w+)::~?(\w+)$/.exec(e);return t&&t[1]==t[2]}function p(e,t){for(var n;null!=(n=e.next());)if('"'==n&&!e.eat('"')){t.tokenize=null;break}return"string"}function m(e,t){var n=t.cpp11RawStringDelim.replace(/[^\w\s]/g,"\\$&");return e.match(new RegExp(".*?\\)"+n+'"'))?t.tokenize=null:e.skipToEnd(),"string"}function h(t,n){function r(e){if(e)for(var t in e)e.hasOwnProperty(t)&&o.push(t)}"string"==typeof t&&(t=[t]);var o=[];r(n.keywords),r(n.types),r(n.builtin),r(n.atoms),o.length&&(n.helperType=t[0],e.registerHelper("hintWords",t[0],o));for(var a=0;a<t.length;++a)e.defineMIME(t[a],n)}function g(e,t){for(var n=!1;!e.eol();){if(!n&&e.match('"""')){t.tokenize=null;break}n="\\"==e.next()&&!n}return"string"}function y(e){return function(t,n){for(var r,o=!1,a=!1;!t.eol();){if(!e&&!o&&t.match('"')){a=!0;break}if(e&&t.match('"""')){a=!0;break}r=t.next(),!o&&"$"==r&&t.match("{")&&t.skipTo("}"),o=!o&&"\\"==r&&!e}return!a&&e||(n.tokenize=null),"string"}}function x(e){return function(t,n){for(var r,o=!1,a=!1;!t.eol();){if(!o&&t.match('"')&&("single"==e||t.match('""'))){a=!0;break}if(!o&&t.match("``")){w=x(e),a=!0;break}r=t.next(),o="single"==e&&!o&&"\\"==r}return a&&(n.tokenize=null),"string"}}e.defineMode("clike",function(i,s){function c(e,t){var n=e.next();if(S[n]){var r=S[n](e,t);if(!1!==r)return r}if('"'==n||"'"==n)return t.tokenize=u(n),t.tokenize(e,t);if(D.test(n))return p=n,null;if(L.test(n)){if(e.backUp(1),e.match(I))return"number";e.next()}if("/"==n){if(e.eat("*"))return t.tokenize=d,d(e,t);if(e.eat("/"))return e.skipToEnd(),"comment"}if(F.test(n)){for(;!e.match(/^\/[\/*]/,!1)&&e.eat(F););return"operator"}if(e.eatWhile(z),P)for(;e.match(P);)e.eatWhile(z);var o=e.current();return l(x,o)?(l(w,o)&&(p="newstatement"),l(v,o)&&(m=!0),"keyword"):l(b,o)?"type":l(k,o)?(l(w,o)&&(p="newstatement"),"builtin"):l(_,o)?"atom":"variable"}function u(e){return function(t,n){for(var r,o=!1,a=!1;null!=(r=t.next());){if(r==e&&!o){a=!0;break}o=!o&&"\\"==r}return(a||!o&&!C)&&(n.tokenize=null),"string"}}function d(e,t){for(var n,r=!1;n=e.next();){if("/"==n&&r){t.tokenize=null;break}r="*"==n}return"comment"}function f(e,t){s.typeFirstDefinitions&&e.eol()&&a(t.context)&&(t.typeAtEndOfLine=o(e,t,e.pos))}var p,m,h=i.indentUnit,g=s.statementIndentUnit||h,y=s.dontAlignCalls,x=s.keywords||{},b=s.types||{},k=s.builtin||{},w=s.blockKeywords||{},v=s.defKeywords||{},_=s.atoms||{},S=s.hooks||{},C=s.multiLineStrings,T=!1!==s.indentStatements,M=!1!==s.indentSwitch,P=s.namespaceSeparator,D=s.isPunctuationChar||/[\[\]{}\(\),;\:\.]/,L=s.numberStart||/[\d\.]/,I=s.number||/^(?:0x[a-f\d]+|0b[01]+|(?:\d+\.?\d*|\.\d+)(?:e[-+]?\d+)?)(u|ll?|l|f)?/i,F=s.isOperatorChar||/[+\-*&%=<>!?|\/]/,z=s.isIdentifierChar||/[\w\$_\xa1-\uffff]/;return{startState:function(e){return{tokenize:null,context:new t((e||0)-h,0,"top",null,!1),indented:0,startOfLine:!0,prevToken:null}},token:function(e,t){var i=t.context;if(e.sol()&&(null==i.align&&(i.align=!1),t.indented=e.indentation(),t.startOfLine=!0),e.eatSpace())return f(e,t),null;p=m=null;var l=(t.tokenize||c)(e,t);if("comment"==l||"meta"==l)return l;if(null==i.align&&(i.align=!0),";"==p||":"==p||","==p&&e.match(/^\s*(?:\/\/.*)?$/,!1))for(;"statement"==t.context.type;)r(t);else if("{"==p)n(t,e.column(),"}");else if("["==p)n(t,e.column(),"]");else if("("==p)n(t,e.column(),")");else if("}"==p){for(;"statement"==i.type;)i=r(t);for("}"==i.type&&(i=r(t));"statement"==i.type;)i=r(t)}else p==i.type?r(t):T&&(("}"==i.type||"top"==i.type)&&";"!=p||"statement"==i.type&&"newstatement"==p)&&n(t,e.column(),"statement",e.current());if("variable"==l&&("def"==t.prevToken||s.typeFirstDefinitions&&o(e,t,e.start)&&a(t.context)&&e.match(/^\s*\(/,!1))&&(l="def"),S.token){var u=S.token(e,t,l);void 0!==u&&(l=u)}return"def"==l&&!1===s.styleDefs&&(l="variable"),t.startOfLine=!1,t.prevToken=m?"def":l||p,f(e,t),l},indent:function(t,n){if(t.tokenize!=c&&null!=t.tokenize||t.typeAtEndOfLine)return e.Pass;var r=t.context,o=n&&n.charAt(0);if("statement"==r.type&&"}"==o&&(r=r.prev),s.dontIndentStatements)for(;"statement"==r.type&&s.dontIndentStatements.test(r.info);)r=r.prev;if(S.indent){var a=S.indent(t,r,n);if("number"==typeof a)return a}var i=o==r.type,l=r.prev&&"switch"==r.prev.info;if(s.allmanIndentation&&/[{(]/.test(o)){for(;"top"!=r.type&&"}"!=r.type;)r=r.prev;return r.indented}return"statement"==r.type?r.indented+("{"==o?0:g):!r.align||y&&")"==r.type?")"!=r.type||i?r.indented+(i?0:h)+(i||!l||/^(?:case|default)\b/.test(n)?0:h):r.indented+g:r.column+(i?0:1)},electricInput:M?/^\s*(?:case .*?:|default:|\{\}?|\})$/:/^\s*[{}]$/,blockCommentStart:"/*",blockCommentEnd:"*/",lineComment:"//",fold:"brace"}});var b="auto if break case register continue return default do sizeof static else struct switch extern typedef union for goto while enum const volatile",k="int long char short double float unsigned signed void size_t ptrdiff_t";h(["text/x-csrc","text/x-c","text/x-chdr"],{name:"clike",keywords:i(b),types:i(k+" bool _Complex _Bool float_t double_t intptr_t intmax_t int8_t int16_t int32_t int64_t uintptr_t uintmax_t uint8_t uint16_t uint32_t uint64_t"),blockKeywords:i("case do else for if switch while struct"),defKeywords:i("struct"),typeFirstDefinitions:!0,atoms:i("null true false"),hooks:{"#":s,"*":c},modeProps:{fold:["brace","include"]}}),h(["text/x-c++src","text/x-c++hdr"],{name:"clike",keywords:i(b+" asm dynamic_cast namespace reinterpret_cast try explicit new static_cast typeid catch operator template typename class friend private this using const_cast inline public throw virtual delete mutable protected alignas alignof constexpr decltype nullptr noexcept thread_local final static_assert override"),types:i(k+" bool wchar_t"),blockKeywords:i("catch class do else finally for if struct switch try while"),defKeywords:i("class namespace struct enum union"),typeFirstDefinitions:!0,atoms:i("true false null"),dontIndentStatements:/^template$/,isIdentifierChar:/[\w\$_~\xa1-\uffff]/,hooks:{"#":s,"*":c,u:d,U:d,L:d,R:d,0:u,1:u,2:u,3:u,4:u,5:u,6:u,7:u,8:u,9:u,token:function(e,t,n){if("variable"==n&&"("==e.peek()&&(";"==t.prevToken||null==t.prevToken||"}"==t.prevToken)&&f(e.current()))return"def"}},namespaceSeparator:"::",modeProps:{fold:["brace","include"]}}),h("text/x-java",{name:"clike",keywords:i("abstract assert break case catch class const continue default do else enum extends final finally float for goto if implements import instanceof interface native new package private protected public return static strictfp super switch synchronized this throw throws transient try volatile while @interface"),types:i("byte short int long float double boolean char void Boolean Byte Character Double Float Integer Long Number Object Short String StringBuffer StringBuilder Void"),blockKeywords:i("catch class do else finally for if switch try while"),defKeywords:i("class interface package enum @interface"),typeFirstDefinitions:!0,atoms:i("true false null"),number:/^(?:0x[a-f\d_]+|0b[01_]+|(?:[\d_]+\.?\d*|\.\d+)(?:e[-+]?[\d_]+)?)(u|ll?|l|f)?/i,hooks:{"@":function(e){return!e.match("interface",!1)&&(e.eatWhile(/[\w\$_]/),"meta")}},modeProps:{fold:["brace","import"]}}),h("text/x-csharp",{name:"clike",keywords:i("abstract as async await base break case catch checked class const continue default delegate do else enum event explicit extern finally fixed for foreach goto if implicit in interface internal is lock namespace new operator out override params private protected public readonly ref return sealed sizeof stackalloc static struct switch this throw try typeof unchecked unsafe using virtual void volatile while add alias ascending descending dynamic from get global group into join let orderby partial remove select set value var yield"),types:i("Action Boolean Byte Char DateTime DateTimeOffset Decimal Double Func Guid Int16 Int32 Int64 Object SByte Single String Task TimeSpan UInt16 UInt32 UInt64 bool byte char decimal double short int long object sbyte float string ushort uint ulong"),blockKeywords:i("catch class do else finally for foreach if struct switch try while"),defKeywords:i("class interface namespace struct var"),typeFirstDefinitions:!0,atoms:i("true false null"),hooks:{"@":function(e,t){return e.eat('"')?(t.tokenize=p,p(e,t)):(e.eatWhile(/[\w\$_]/),"meta")}}}),h("text/x-scala",{name:"clike",keywords:i("abstract case catch class def do else extends final finally for forSome if implicit import lazy match new null object override package private protected return sealed super this throw trait try type val var while with yield _ assert assume require print println printf readLine readBoolean readByte readShort readChar readInt readLong readFloat readDouble"),types:i("AnyVal App Application Array BufferedIterator BigDecimal BigInt Char Console Either Enumeration Equiv Error Exception Fractional Function IndexedSeq Int Integral Iterable Iterator List Map Numeric Nil NotNull Option Ordered Ordering PartialFunction PartialOrdering Product Proxy Range Responder Seq Serializable Set Specializable Stream StringBuilder StringContext Symbol Throwable Traversable TraversableOnce Tuple Unit Vector Boolean Byte Character CharSequence Class ClassLoader Cloneable Comparable Compiler Double Exception Float Integer Long Math Number Object Package Pair Process Runtime Runnable SecurityManager Short StackTraceElement StrictMath String StringBuffer System Thread ThreadGroup ThreadLocal Throwable Triple Void"),multiLineStrings:!0,blockKeywords:i("catch class enum do else finally for forSome if match switch try while"),defKeywords:i("class enum def object package trait type val var"),atoms:i("true false null"),indentStatements:!1,indentSwitch:!1,isOperatorChar:/[+\-*&%=<>!?|\/#:@]/,hooks:{"@":function(e){return e.eatWhile(/[\w\$_]/),"meta"},'"':function(e,t){return!!e.match('""')&&(t.tokenize=g,t.tokenize(e,t))},"'":function(e){return e.eatWhile(/[\w\$_\xa1-\uffff]/),"atom"},"=":function(e,n){var r=n.context;return!("}"!=r.type||!r.align||!e.eat(">"))&&(n.context=new t(r.indented,r.column,r.type,r.info,null,r.prev),"operator")}},modeProps:{closeBrackets:{triples:'"'}}}),h("text/x-kotlin",{name:"clike",keywords:i("package as typealias class interface this super val var fun for is in This throw return break continue object if else while do try when !in !is as? file import where by get set abstract enum open inner override private public internal protected catch finally out final vararg reified dynamic companion constructor init sealed field property receiver param sparam lateinit data inline noinline tailrec external annotation crossinline const operator infix suspend"),types:i("Boolean Byte Character CharSequence Class ClassLoader Cloneable Comparable Compiler Double Exception Float Integer Long Math Number Object Package Pair Process Runtime Runnable SecurityManager Short StackTraceElement StrictMath String StringBuffer System Thread ThreadGroup ThreadLocal Throwable Triple Void"),intendSwitch:!1,indentStatements:!1,multiLineStrings:!0,number:/^(?:0x[a-f\d_]+|0b[01_]+|(?:[\d_]+\.?\d*|\.\d+)(?:e[-+]?[\d_]+)?)(u|ll?|l|f)?/i,blockKeywords:i("catch class do else finally for if where try while enum"),defKeywords:i("class val var object package interface fun"),atoms:i("true false null this"),hooks:{'"':function(e,t){return t.tokenize=y(e.match('""')),t.tokenize(e,t)}},modeProps:{closeBrackets:{triples:'"'}}}),h(["x-shader/x-vertex","x-shader/x-fragment"],{name:"clike",keywords:i("sampler1D sampler2D sampler3D samplerCube sampler1DShadow sampler2DShadow const attribute uniform varying break continue discard return for while do if else struct in out inout"),types:i("float int bool void vec2 vec3 vec4 ivec2 ivec3 ivec4 bvec2 bvec3 bvec4 mat2 mat3 mat4"),blockKeywords:i("for while do if else struct"),builtin:i("radians degrees sin cos tan asin acos atan pow exp log exp2 sqrt inversesqrt abs sign floor ceil fract mod min max clamp mix step smoothstep length distance dot cross normalize ftransform faceforward reflect refract matrixCompMult lessThan lessThanEqual greaterThan greaterThanEqual equal notEqual any all not texture1D texture1DProj texture1DLod texture1DProjLod texture2D texture2DProj texture2DLod texture2DProjLod texture3D texture3DProj texture3DLod texture3DProjLod textureCube textureCubeLod shadow1D shadow2D shadow1DProj shadow2DProj shadow1DLod shadow2DLod shadow1DProjLod shadow2DProjLod dFdx dFdy fwidth noise1 noise2 noise3 noise4"),atoms:i("true false gl_FragColor gl_SecondaryColor gl_Normal gl_Vertex gl_MultiTexCoord0 gl_MultiTexCoord1 gl_MultiTexCoord2 gl_MultiTexCoord3 gl_MultiTexCoord4 gl_MultiTexCoord5 gl_MultiTexCoord6 gl_MultiTexCoord7 gl_FogCoord gl_PointCoord gl_Position gl_PointSize gl_ClipVertex gl_FrontColor gl_BackColor gl_FrontSecondaryColor gl_BackSecondaryColor gl_TexCoord gl_FogFragCoord gl_FragCoord gl_FrontFacing gl_FragData gl_FragDepth gl_ModelViewMatrix gl_ProjectionMatrix gl_ModelViewProjectionMatrix gl_TextureMatrix gl_NormalMatrix gl_ModelViewMatrixInverse gl_ProjectionMatrixInverse gl_ModelViewProjectionMatrixInverse gl_TexureMatrixTranspose gl_ModelViewMatrixInverseTranspose gl_ProjectionMatrixInverseTranspose gl_ModelViewProjectionMatrixInverseTranspose gl_TextureMatrixInverseTranspose gl_NormalScale gl_DepthRange gl_ClipPlane gl_Point gl_FrontMaterial gl_BackMaterial gl_LightSource gl_LightModel gl_FrontLightModelProduct gl_BackLightModelProduct gl_TextureColor gl_EyePlaneS gl_EyePlaneT gl_EyePlaneR gl_EyePlaneQ gl_FogParameters gl_MaxLights gl_MaxClipPlanes gl_MaxTextureUnits gl_MaxTextureCoords gl_MaxVertexAttribs gl_MaxVertexUniformComponents gl_MaxVaryingFloats gl_MaxVertexTextureImageUnits gl_MaxTextureImageUnits gl_MaxFragmentUniformComponents gl_MaxCombineTextureImageUnits gl_MaxDrawBuffers"),indentSwitch:!1,hooks:{"#":s},modeProps:{fold:["brace","include"]}}),h("text/x-nesc",{name:"clike",keywords:i(b+"as atomic async call command component components configuration event generic implementation includes interface module new norace nx_struct nx_union post provides signal task uses abstract extends"),types:i(k),blockKeywords:i("case do else for if switch while struct"),atoms:i("null true false"),hooks:{"#":s},modeProps:{fold:["brace","include"]}}),h("text/x-objectivec",{name:"clike",keywords:i(b+"inline restrict _Bool _Complex _Imaginary BOOL Class bycopy byref id IMP in inout nil oneway out Protocol SEL self super atomic nonatomic retain copy readwrite readonly"),types:i(k),atoms:i("YES NO NULL NILL ON OFF true false"),hooks:{"@":function(e){return e.eatWhile(/[\w\$]/),"keyword"},"#":s,indent:function(e,t,n){if("statement"==t.type&&/^@\w/.test(n))return t.indented}},modeProps:{fold:"brace"}}),h("text/x-squirrel",{name:"clike",keywords:i("base break clone continue const default delete enum extends function in class foreach local resume return this throw typeof yield constructor instanceof static"),types:i(k),blockKeywords:i("case catch class else for foreach if switch try while"),defKeywords:i("function local class"),typeFirstDefinitions:!0,atoms:i("true false null"),hooks:{"#":s},modeProps:{fold:["brace","include"]}});var w=null;h("text/x-ceylon",{name:"clike",keywords:i("abstracts alias assembly assert assign break case catch class continue dynamic else exists extends finally for function given if import in interface is let module new nonempty object of out outer package return satisfies super switch then this throw try value void while"),types:function(e){var t=e.charAt(0);return t===t.toUpperCase()&&t!==t.toLowerCase()},blockKeywords:i("case catch class dynamic else finally for function if interface module new object switch try while"),defKeywords:i("class dynamic function interface module object package value"),builtin:i("abstract actual aliased annotation by default deprecated doc final formal late license native optional sealed see serializable shared suppressWarnings tagged throws variable"),isPunctuationChar:/[\[\]{}\(\),;\:\.`]/,isOperatorChar:/[+\-*&%=<>!?|^~:\/]/,numberStart:/[\d#$]/,number:/^(?:#[\da-fA-F_]+|\$[01_]+|[\d_]+[kMGTPmunpf]?|[\d_]+\.[\d_]+(?:[eE][-+]?\d+|[kMGTPmunpf]|)|)/i,multiLineStrings:!0,typeFirstDefinitions:!0,atoms:i("true false null larger smaller equal empty finished"),indentSwitch:!1,styleDefs:!1,hooks:{"@":function(e){return e.eatWhile(/[\w\$_]/),"meta"},'"':function(e,t){return t.tokenize=x(e.match('""')?"triple":"single"),t.tokenize(e,t)},"`":function(e,t){return!(!w||!e.match("`"))&&(t.tokenize=w,w=null,t.tokenize(e,t))},"'":function(e){return e.eatWhile(/[\w\$_\xa1-\uffff]/),"atom"},token:function(e,t,n){if(("variable"==n||"type"==n)&&"."==t.prevToken)return"variable-2"}},modeProps:{fold:["brace","import"],closeBrackets:{triples:'"'}}})});
      // -------------------------------------------------------------------------
//  Part of the CodeChecker project, under the Apache License v2.0 with
//  LLVM Exceptions. See LICENSE for license information.
//  SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
// -------------------------------------------------------------------------

var BugViewer = {
  _files : [],
  _reports : [],
  _lineWidgets : [],
  _navigationMenuItems : [],
  _sourceFileData : null,
  _currentReport : null,
  _lastBugEvent  : null,

  init : function (files, reports) {
    this._files = files;
    this._reports = reports;

    this.initEscapeChars();
  },

  initEscapeChars : function () {
    this.escapeChars = {
      ' ' : 'nbsp',
      '<' : 'lt',
      '>' : 'gt',
      '"' : 'quot',
      '&' : 'amp'
    };

    var regexString = '[';
    for (var key in this.escapeChars) {
      regexString += key;
    }
    regexString += ']';

    this.escapeRegExp = new RegExp( regexString, 'g');
  },

  escapeHTML : function (str) {
    var that = this;

    return str.replace(this.escapeRegExp, function (m) {
      return '&' + that.escapeChars[m] + ';';
    });
  },

  initByUrl : function () {
    if (!this._reports) return;

    var state = {};
    window.location.hash.substr(1).split('&').forEach(function (s) {
      var parts = s.split('=');
      state[parts[0]] = parts[1];
    });

    for (var key in this._reports) {
      var report = this._reports[key];
      if (report.reportHash === state['reportHash']) {
        this.navigate(report);
        return;
      }
    }

    this.navigate(this._reports[0]);
  },

  create : function () {
    this._content = document.getElementById('editor-wrapper');
    this._filepath = document.getElementById('file-path');
    this._checkerName = document.getElementById('checker-name');
    this._reviewStatusWrapper =
      document.getElementById('review-status-wrapper');
    this._reviewStatus = document.getElementById('review-status');
    this._editor = document.getElementById('editor');

    this._codeMirror = CodeMirror(this._editor, {
      mode: 'text/x-c++src',
      matchBrackets : true,
      lineNumbers : true,
      readOnly : true,
      foldGutter : true,
      extraKeys : {},
      viewportMargin : 100
    });

    this._createNavigationMenu();
  },

  navigate : function (report, item) {
    if (!item) {
      var items = this._navigationMenuItems.filter(function (navItem) {
        return navItem.report.reportHash === report.reportHash;
      });

      if (!items.length) return;

      item = items[0].widget;
    }

    this._selectedReport.classList.remove('active');
    this._selectedReport = item;
    this._selectedReport.classList.add('active');
    this.setReport(report);
  },

  _createNavigationMenu : function () {
    var that = this;

    var nav = document.getElementById('report-nav');
    var list = document.createElement('ul');
    this._reports.forEach(function (report) {
      var events = report['events'];
      var lastBugEvent = events[events.length - 1];
      var item = document.createElement('li');

      var severity = document.createElement('i');
      severity.className = 'severity-' + report.severity.toLowerCase();

      item.appendChild(severity);
      item.appendChild(document.createTextNode(lastBugEvent.message));

      item.addEventListener('click', function () {
        that.navigate(report, item);
      })
      list.appendChild(item);
      that._navigationMenuItems.push({ report : report, widget : item });
    });

    if (!this._selectedReport && list.childNodes.length) {
      this._selectedReport = list.childNodes[0];
      this._selectedReport.classList.add('active');
    }

    nav.appendChild(list);
  },

  setReport : function (report) {
    this._currentReport = report;
    var events = report['events'];
    var lastBugEvent = events[events.length - 1];
    this.setCurrentBugEvent(lastBugEvent, events.length - 1);
    this.setCheckerName(report.checkerName);
    this.setReviewStatus(report.reviewStatus);

    window.location.hash = '#reportHash=' + report.reportHash;
  },

  setCurrentBugEvent : function (event, idx) {
    this._currentBugEvent = event;
    this.setSourceFileData(this._files[event.location.file]);
    this.drawBugPath();

    this.jumpTo(event.location.line, 0);
    this.highlightBugEvent(event, idx);
  },

  highlightBugEvent : function (event, idx) {
    this._lineWidgets.forEach(function (widget) {
      var lineIdx = widget.node.getAttribute('idx');
      if (parseInt(lineIdx) === idx) {
        widget.node.classList.add('current');
      }
    });
  },

  setCheckerName : function (checkerName) {
    this._checkerName.innerHTML = checkerName;
  },

  setReviewStatus : function (status) {
    if (status) {
      var className =
        'review-status-' + status.toLowerCase().split(' ').join('-');
      this._reviewStatus.className = "review-status " + className;

      this._reviewStatus.innerHTML = status;
      this._reviewStatusWrapper.style.display = 'block';
    } else {
      this._reviewStatusWrapper.style.display = 'none';
    }
  },

  setSourceFileData : function (file) {
    if (this._sourceFileData && file.id === this._sourceFileData.id) {
      return;
    }

    this._sourceFileData = file;
    this._filepath.innerHTML = file.path;
    this._codeMirror.doc.setValue(file.content);
    this._refresh();
  },

  _refresh : function () {
    var that = this;
    setTimeout(function () {
      var fullHeight = parseInt(that._content.clientHeight);
      var headerHeight = that._filepath.clientHeight;

      that._codeMirror.setSize('auto', fullHeight - headerHeight);
      that._codeMirror.refresh();
    }, 200);
  },

  clearBubbles : function () {
    this._lineWidgets.forEach(function (widget) { widget.clear(); });
    this._lineWidgets = [];
  },

  getMessage : function (event, kind) {
    if (kind === 'macro') {
      var name = 'macro expansion' + (event.name ? ': ' + event.name : '');

      return '<span class="tag macro">' + name + '</span>'
        + this.escapeHTML(event.expansion).replace(/(?:\r\n|\r|\n)/g, '<br>');
    } else if (kind === 'note') {
      return '<span class="tag note">note</span>'
        +  this.escapeHTML(event.message).replace(/(?:\r\n|\r|\n)/g, '<br>');
    }
  },

  addExtraPathEvents : function (events, kind) {
    var that = this;

    if (!events) {
      return;
    }

    events.forEach(function (event) {
      if (event.location.file !== that._currentBugEvent.location.file) {
        return;
      }

      var left =
        that._codeMirror.defaultCharWidth() * event.location.col + 'px';

      var element = document.createElement('div');
      element.setAttribute('style', 'margin-left: ' + left);
      element.setAttribute('class', 'check-msg ' + kind);

      var msg = document.createElement('span');
      msg.innerHTML = that.getMessage(event, kind);
      element.appendChild(msg);

      that._lineWidgets.push(that._codeMirror.addLineWidget(
        event.location.line - 1, element));
    });
  },

  drawBugPath : function () {
    var that = this;

    this.clearBubbles();

    this.addExtraPathEvents(this._currentReport.macros, 'macro');
    this.addExtraPathEvents(this._currentReport.notes, 'note');

    // Processing bug path events.
    var currentEvents = this._currentReport.events;
    currentEvents.forEach(function (event, step) {
      if (event.location.file !== that._currentBugEvent.location.file)
        return;

      var left =
        that._codeMirror.defaultCharWidth() * event.location.col + 'px';
      var type = step === currentEvents.length - 1 ? 'error' : 'info';

      var element = document.createElement('div');
      element.setAttribute('style', 'margin-left: ' + left);
      element.setAttribute('class', 'check-msg ' + type);
      element.setAttribute('idx', step);

      var enumeration = document.createElement('span');
      enumeration.setAttribute('class', 'checker-enum ' + type);
      enumeration.innerHTML = step + 1;

      if (currentEvents.length > 1)
        element.appendChild(enumeration);

      var prevBugEvent = step - 1;
      if (step > 0) {
        var prevBug = document.createElement('span');
        prevBug.setAttribute('class', 'arrow left-arrow');
        prevBug.addEventListener('click', function () {
          var event = currentEvents[prevBugEvent];
          that.setCurrentBugEvent(event, prevBugEvent);
        });
        element.appendChild(prevBug);
      }

      var msg = document.createElement('span');
      msg.innerHTML = that.escapeHTML(event.message)
        .replace(/(?:\r\n|\r|\n)/g, '<br>');

      element.appendChild(msg);

      var nextBugEvent = step + 1;
      if (nextBugEvent < currentEvents.length) {
        var nextBug = document.createElement('span');
        nextBug.setAttribute('class', 'arrow right-arrow');
        nextBug.addEventListener('click', function () {
          var event = currentEvents[nextBugEvent];
          that.setCurrentBugEvent(event, nextBugEvent);
        });
        element.appendChild(nextBug);
      }


      that._lineWidgets.push(that._codeMirror.addLineWidget(
        event.location.line - 1, element));
    });
  },

  jumpTo : function (line, column) {
    var that = this;

    setTimeout(function () {
      var selPosPixel
        = that._codeMirror.charCoords({ line : line, ch : column }, 'local');
      var editorSize = {
        width  : that._editor.clientWidth,
        height : that._editor.clientHeight
      };

      that._codeMirror.scrollIntoView({
        top    : selPosPixel.top - 100,
        bottom : selPosPixel.top + editorSize.height - 150,
        left   : selPosPixel.left < editorSize.width - 100
               ? 0
               : selPosPixel.left - 50,
        right  : selPosPixel.left < editorSize.width - 100
               ? 10
               : selPosPixel.left + editorSize.width - 100
      });
    }, 0);
  }
}


      var data = {"files": {"0": {"id": 0, "path": "/src/drivers/ata/libata-eh.c", "content": "// SPDX-License-Identifier: GPL-2.0-or-later\n/*\n *  libata-eh.c - libata error handling\n *\n *  Copyright 2006 Tejun Heo <htejun@gmail.com>\n *\n *  libata documentation is available via 'make {ps|pdf}docs',\n *  as Documentation/driver-api/libata.rst\n *\n *  Hardware documentation available from http://www.t13.org/ and\n *  http://www.sata-io.org/\n */\n\n#include <linux/kernel.h>\n#include <linux/blkdev.h>\n#include <linux/export.h>\n#include <linux/pci.h>\n#include <scsi/scsi.h>\n#include <scsi/scsi_host.h>\n#include <scsi/scsi_eh.h>\n#include <scsi/scsi_device.h>\n#include <scsi/scsi_cmnd.h>\n#include <scsi/scsi_dbg.h>\n#include \"../scsi/scsi_transport_api.h\"\n\n#include <linux/libata.h>\n\n#include <trace/events/libata.h>\n#include \"libata.h\"\n\nenum {\n\t/* speed down verdicts */\n\tATA_EH_SPDN_NCQ_OFF\t\t= (1 << 0),\n\tATA_EH_SPDN_SPEED_DOWN\t\t= (1 << 1),\n\tATA_EH_SPDN_FALLBACK_TO_PIO\t= (1 << 2),\n\tATA_EH_SPDN_KEEP_ERRORS\t\t= (1 << 3),\n\n\t/* error flags */\n\tATA_EFLAG_IS_IO\t\t\t= (1 << 0),\n\tATA_EFLAG_DUBIOUS_XFER\t\t= (1 << 1),\n\tATA_EFLAG_OLD_ER                = (1 << 31),\n\n\t/* error categories */\n\tATA_ECAT_NONE\t\t\t= 0,\n\tATA_ECAT_ATA_BUS\t\t= 1,\n\tATA_ECAT_TOUT_HSM\t\t= 2,\n\tATA_ECAT_UNK_DEV\t\t= 3,\n\tATA_ECAT_DUBIOUS_NONE\t\t= 4,\n\tATA_ECAT_DUBIOUS_ATA_BUS\t= 5,\n\tATA_ECAT_DUBIOUS_TOUT_HSM\t= 6,\n\tATA_ECAT_DUBIOUS_UNK_DEV\t= 7,\n\tATA_ECAT_NR\t\t\t= 8,\n\n\tATA_EH_CMD_DFL_TIMEOUT\t\t=  5000,\n\n\t/* always put at least this amount of time between resets */\n\tATA_EH_RESET_COOL_DOWN\t\t=  5000,\n\n\t/* Waiting in ->prereset can never be reliable.  It's\n\t * sometimes nice to wait there but it can't be depended upon;\n\t * otherwise, we wouldn't be resetting.  Just give it enough\n\t * time for most drives to spin up.\n\t */\n\tATA_EH_PRERESET_TIMEOUT\t\t= 10000,\n\tATA_EH_FASTDRAIN_INTERVAL\t=  3000,\n\n\tATA_EH_UA_TRIES\t\t\t= 5,\n\n\t/* probe speed down parameters, see ata_eh_schedule_probe() */\n\tATA_EH_PROBE_TRIAL_INTERVAL\t= 60000,\t/* 1 min */\n\tATA_EH_PROBE_TRIALS\t\t= 2,\n};\n\n/* The following table determines how we sequence resets.  Each entry\n * represents timeout for that try.  The first try can be soft or\n * hardreset.  All others are hardreset if available.  In most cases\n * the first reset w/ 10sec timeout should succeed.  Following entries\n * are mostly for error handling, hotplug and those outlier devices that\n * take an exceptionally long time to recover from reset.\n */\nstatic const unsigned long ata_eh_reset_timeouts[] = {\n\t10000,\t/* most drives spin up by 10sec */\n\t10000,\t/* > 99% working drives spin up before 20sec */\n\t35000,\t/* give > 30 secs of idleness for outlier devices */\n\t 5000,\t/* and sweet one last chance */\n\tULONG_MAX, /* > 1 min has elapsed, give up */\n};\n\nstatic const unsigned long ata_eh_identify_timeouts[] = {\n\t 5000,\t/* covers > 99% of successes and not too boring on failures */\n\t10000,  /* combined time till here is enough even for media access */\n\t30000,\t/* for true idiots */\n\tULONG_MAX,\n};\n\nstatic const unsigned long ata_eh_flush_timeouts[] = {\n\t15000,\t/* be generous with flush */\n\t15000,  /* ditto */\n\t30000,\t/* and even more generous */\n\tULONG_MAX,\n};\n\nstatic const unsigned long ata_eh_other_timeouts[] = {\n\t 5000,\t/* same rationale as identify timeout */\n\t10000,\t/* ditto */\n\t/* but no merciful 30sec for other commands, it just isn't worth it */\n\tULONG_MAX,\n};\n\nstruct ata_eh_cmd_timeout_ent {\n\tconst u8\t\t*commands;\n\tconst unsigned long\t*timeouts;\n};\n\n/* The following table determines timeouts to use for EH internal\n * commands.  Each table entry is a command class and matches the\n * commands the entry applies to and the timeout table to use.\n *\n * On the retry after a command timed out, the next timeout value from\n * the table is used.  If the table doesn't contain further entries,\n * the last value is used.\n *\n * ehc->cmd_timeout_idx keeps track of which timeout to use per\n * command class, so if SET_FEATURES times out on the first try, the\n * next try will use the second timeout value only for that class.\n */\n#define CMDS(cmds...)\t(const u8 []){ cmds, 0 }\nstatic const struct ata_eh_cmd_timeout_ent\nata_eh_cmd_timeout_table[ATA_EH_CMD_TIMEOUT_TABLE_SIZE] = {\n\t{ .commands = CMDS(ATA_CMD_ID_ATA, ATA_CMD_ID_ATAPI),\n\t  .timeouts = ata_eh_identify_timeouts, },\n\t{ .commands = CMDS(ATA_CMD_READ_NATIVE_MAX, ATA_CMD_READ_NATIVE_MAX_EXT),\n\t  .timeouts = ata_eh_other_timeouts, },\n\t{ .commands = CMDS(ATA_CMD_SET_MAX, ATA_CMD_SET_MAX_EXT),\n\t  .timeouts = ata_eh_other_timeouts, },\n\t{ .commands = CMDS(ATA_CMD_SET_FEATURES),\n\t  .timeouts = ata_eh_other_timeouts, },\n\t{ .commands = CMDS(ATA_CMD_INIT_DEV_PARAMS),\n\t  .timeouts = ata_eh_other_timeouts, },\n\t{ .commands = CMDS(ATA_CMD_FLUSH, ATA_CMD_FLUSH_EXT),\n\t  .timeouts = ata_eh_flush_timeouts },\n};\n#undef CMDS\n\nstatic void __ata_port_freeze(struct ata_port *ap);\n#ifdef CONFIG_PM\nstatic void ata_eh_handle_port_suspend(struct ata_port *ap);\nstatic void ata_eh_handle_port_resume(struct ata_port *ap);\n#else /* CONFIG_PM */\nstatic void ata_eh_handle_port_suspend(struct ata_port *ap)\n{ }\n\nstatic void ata_eh_handle_port_resume(struct ata_port *ap)\n{ }\n#endif /* CONFIG_PM */\n\nstatic __printf(2, 0) void __ata_ehi_pushv_desc(struct ata_eh_info *ehi,\n\t\t\t\t const char *fmt, va_list args)\n{\n\tehi->desc_len += vscnprintf(ehi->desc + ehi->desc_len,\n\t\t\t\t     ATA_EH_DESC_LEN - ehi->desc_len,\n\t\t\t\t     fmt, args);\n}\n\n/**\n *\t__ata_ehi_push_desc - push error description without adding separator\n *\t@ehi: target EHI\n *\t@fmt: printf format string\n *\n *\tFormat string according to @fmt and append it to @ehi->desc.\n *\n *\tLOCKING:\n *\tspin_lock_irqsave(host lock)\n */\nvoid __ata_ehi_push_desc(struct ata_eh_info *ehi, const char *fmt, ...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\t__ata_ehi_pushv_desc(ehi, fmt, args);\n\tva_end(args);\n}\nEXPORT_SYMBOL_GPL(__ata_ehi_push_desc);\n\n/**\n *\tata_ehi_push_desc - push error description with separator\n *\t@ehi: target EHI\n *\t@fmt: printf format string\n *\n *\tFormat string according to @fmt and append it to @ehi->desc.\n *\tIf @ehi->desc is not empty, \", \" is added in-between.\n *\n *\tLOCKING:\n *\tspin_lock_irqsave(host lock)\n */\nvoid ata_ehi_push_desc(struct ata_eh_info *ehi, const char *fmt, ...)\n{\n\tva_list args;\n\n\tif (ehi->desc_len)\n\t\t__ata_ehi_push_desc(ehi, \", \");\n\n\tva_start(args, fmt);\n\t__ata_ehi_pushv_desc(ehi, fmt, args);\n\tva_end(args);\n}\nEXPORT_SYMBOL_GPL(ata_ehi_push_desc);\n\n/**\n *\tata_ehi_clear_desc - clean error description\n *\t@ehi: target EHI\n *\n *\tClear @ehi->desc.\n *\n *\tLOCKING:\n *\tspin_lock_irqsave(host lock)\n */\nvoid ata_ehi_clear_desc(struct ata_eh_info *ehi)\n{\n\tehi->desc[0] = '\\0';\n\tehi->desc_len = 0;\n}\nEXPORT_SYMBOL_GPL(ata_ehi_clear_desc);\n\n/**\n *\tata_port_desc - append port description\n *\t@ap: target ATA port\n *\t@fmt: printf format string\n *\n *\tFormat string according to @fmt and append it to port\n *\tdescription.  If port description is not empty, \" \" is added\n *\tin-between.  This function is to be used while initializing\n *\tata_host.  The description is printed on host registration.\n *\n *\tLOCKING:\n *\tNone.\n */\nvoid ata_port_desc(struct ata_port *ap, const char *fmt, ...)\n{\n\tva_list args;\n\n\tWARN_ON(!(ap->pflags & ATA_PFLAG_INITIALIZING));\n\n\tif (ap->link.eh_info.desc_len)\n\t\t__ata_ehi_push_desc(&ap->link.eh_info, \" \");\n\n\tva_start(args, fmt);\n\t__ata_ehi_pushv_desc(&ap->link.eh_info, fmt, args);\n\tva_end(args);\n}\nEXPORT_SYMBOL_GPL(ata_port_desc);\n\n#ifdef CONFIG_PCI\n/**\n *\tata_port_pbar_desc - append PCI BAR description\n *\t@ap: target ATA port\n *\t@bar: target PCI BAR\n *\t@offset: offset into PCI BAR\n *\t@name: name of the area\n *\n *\tIf @offset is negative, this function formats a string which\n *\tcontains the name, address, size and type of the BAR and\n *\tappends it to the port description.  If @offset is zero or\n *\tpositive, only name and offsetted address is appended.\n *\n *\tLOCKING:\n *\tNone.\n */\nvoid ata_port_pbar_desc(struct ata_port *ap, int bar, ssize_t offset,\n\t\t\tconst char *name)\n{\n\tstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\n\tchar *type = \"\";\n\tunsigned long long start, len;\n\n\tif (pci_resource_flags(pdev, bar) & IORESOURCE_MEM)\n\t\ttype = \"m\";\n\telse if (pci_resource_flags(pdev, bar) & IORESOURCE_IO)\n\t\ttype = \"i\";\n\n\tstart = (unsigned long long)pci_resource_start(pdev, bar);\n\tlen = (unsigned long long)pci_resource_len(pdev, bar);\n\n\tif (offset < 0)\n\t\tata_port_desc(ap, \"%s %s%llu@0x%llx\", name, type, len, start);\n\telse\n\t\tata_port_desc(ap, \"%s 0x%llx\", name,\n\t\t\t\tstart + (unsigned long long)offset);\n}\nEXPORT_SYMBOL_GPL(ata_port_pbar_desc);\n#endif /* CONFIG_PCI */\n\nstatic int ata_lookup_timeout_table(u8 cmd)\n{\n\tint i;\n\n\tfor (i = 0; i < ATA_EH_CMD_TIMEOUT_TABLE_SIZE; i++) {\n\t\tconst u8 *cur;\n\n\t\tfor (cur = ata_eh_cmd_timeout_table[i].commands; *cur; cur++)\n\t\t\tif (*cur == cmd)\n\t\t\t\treturn i;\n\t}\n\n\treturn -1;\n}\n\n/**\n *\tata_internal_cmd_timeout - determine timeout for an internal command\n *\t@dev: target device\n *\t@cmd: internal command to be issued\n *\n *\tDetermine timeout for internal command @cmd for @dev.\n *\n *\tLOCKING:\n *\tEH context.\n *\n *\tRETURNS:\n *\tDetermined timeout.\n */\nunsigned long ata_internal_cmd_timeout(struct ata_device *dev, u8 cmd)\n{\n\tstruct ata_eh_context *ehc = &dev->link->eh_context;\n\tint ent = ata_lookup_timeout_table(cmd);\n\tint idx;\n\n\tif (ent < 0)\n\t\treturn ATA_EH_CMD_DFL_TIMEOUT;\n\n\tidx = ehc->cmd_timeout_idx[dev->devno][ent];\n\treturn ata_eh_cmd_timeout_table[ent].timeouts[idx];\n}\n\n/**\n *\tata_internal_cmd_timed_out - notification for internal command timeout\n *\t@dev: target device\n *\t@cmd: internal command which timed out\n *\n *\tNotify EH that internal command @cmd for @dev timed out.  This\n *\tfunction should be called only for commands whose timeouts are\n *\tdetermined using ata_internal_cmd_timeout().\n *\n *\tLOCKING:\n *\tEH context.\n */\nvoid ata_internal_cmd_timed_out(struct ata_device *dev, u8 cmd)\n{\n\tstruct ata_eh_context *ehc = &dev->link->eh_context;\n\tint ent = ata_lookup_timeout_table(cmd);\n\tint idx;\n\n\tif (ent < 0)\n\t\treturn;\n\n\tidx = ehc->cmd_timeout_idx[dev->devno][ent];\n\tif (ata_eh_cmd_timeout_table[ent].timeouts[idx + 1] != ULONG_MAX)\n\t\tehc->cmd_timeout_idx[dev->devno][ent]++;\n}\n\nstatic void ata_ering_record(struct ata_ering *ering, unsigned int eflags,\n\t\t\t     unsigned int err_mask)\n{\n\tstruct ata_ering_entry *ent;\n\n\tWARN_ON(!err_mask);\n\n\tering->cursor++;\n\tering->cursor %= ATA_ERING_SIZE;\n\n\tent = &ering->ring[ering->cursor];\n\tent->eflags = eflags;\n\tent->err_mask = err_mask;\n\tent->timestamp = get_jiffies_64();\n}\n\nstatic struct ata_ering_entry *ata_ering_top(struct ata_ering *ering)\n{\n\tstruct ata_ering_entry *ent = &ering->ring[ering->cursor];\n\n\tif (ent->err_mask)\n\t\treturn ent;\n\treturn NULL;\n}\n\nint ata_ering_map(struct ata_ering *ering,\n\t\t  int (*map_fn)(struct ata_ering_entry *, void *),\n\t\t  void *arg)\n{\n\tint idx, rc = 0;\n\tstruct ata_ering_entry *ent;\n\n\tidx = ering->cursor;\n\tdo {\n\t\tent = &ering->ring[idx];\n\t\tif (!ent->err_mask)\n\t\t\tbreak;\n\t\trc = map_fn(ent, arg);\n\t\tif (rc)\n\t\t\tbreak;\n\t\tidx = (idx - 1 + ATA_ERING_SIZE) % ATA_ERING_SIZE;\n\t} while (idx != ering->cursor);\n\n\treturn rc;\n}\n\nstatic int ata_ering_clear_cb(struct ata_ering_entry *ent, void *void_arg)\n{\n\tent->eflags |= ATA_EFLAG_OLD_ER;\n\treturn 0;\n}\n\nstatic void ata_ering_clear(struct ata_ering *ering)\n{\n\tata_ering_map(ering, ata_ering_clear_cb, NULL);\n}\n\nstatic unsigned int ata_eh_dev_action(struct ata_device *dev)\n{\n\tstruct ata_eh_context *ehc = &dev->link->eh_context;\n\n\treturn ehc->i.action | ehc->i.dev_action[dev->devno];\n}\n\nstatic void ata_eh_clear_action(struct ata_link *link, struct ata_device *dev,\n\t\t\t\tstruct ata_eh_info *ehi, unsigned int action)\n{\n\tstruct ata_device *tdev;\n\n\tif (!dev) {\n\t\tehi->action &= ~action;\n\t\tata_for_each_dev(tdev, link, ALL)\n\t\t\tehi->dev_action[tdev->devno] &= ~action;\n\t} else {\n\t\t/* doesn't make sense for port-wide EH actions */\n\t\tWARN_ON(!(action & ATA_EH_PERDEV_MASK));\n\n\t\t/* break ehi->action into ehi->dev_action */\n\t\tif (ehi->action & action) {\n\t\t\tata_for_each_dev(tdev, link, ALL)\n\t\t\t\tehi->dev_action[tdev->devno] |=\n\t\t\t\t\tehi->action & action;\n\t\t\tehi->action &= ~action;\n\t\t}\n\n\t\t/* turn off the specified per-dev action */\n\t\tehi->dev_action[dev->devno] &= ~action;\n\t}\n}\n\n/**\n *\tata_eh_acquire - acquire EH ownership\n *\t@ap: ATA port to acquire EH ownership for\n *\n *\tAcquire EH ownership for @ap.  This is the basic exclusion\n *\tmechanism for ports sharing a host.  Only one port hanging off\n *\tthe same host can claim the ownership of EH.\n *\n *\tLOCKING:\n *\tEH context.\n */\nvoid ata_eh_acquire(struct ata_port *ap)\n{\n\tmutex_lock(&ap->host->eh_mutex);\n\tWARN_ON_ONCE(ap->host->eh_owner);\n\tap->host->eh_owner = current;\n}\n\n/**\n *\tata_eh_release - release EH ownership\n *\t@ap: ATA port to release EH ownership for\n *\n *\tRelease EH ownership for @ap if the caller.  The caller must\n *\thave acquired EH ownership using ata_eh_acquire() previously.\n *\n *\tLOCKING:\n *\tEH context.\n */\nvoid ata_eh_release(struct ata_port *ap)\n{\n\tWARN_ON_ONCE(ap->host->eh_owner != current);\n\tap->host->eh_owner = NULL;\n\tmutex_unlock(&ap->host->eh_mutex);\n}\n\nstatic void ata_eh_unload(struct ata_port *ap)\n{\n\tstruct ata_link *link;\n\tstruct ata_device *dev;\n\tunsigned long flags;\n\n\t/* Restore SControl IPM and SPD for the next driver and\n\t * disable attached devices.\n\t */\n\tata_for_each_link(link, ap, PMP_FIRST) {\n\t\tsata_scr_write(link, SCR_CONTROL, link->saved_scontrol & 0xff0);\n\t\tata_for_each_dev(dev, link, ALL)\n\t\t\tata_dev_disable(dev);\n\t}\n\n\t/* freeze and set UNLOADED */\n\tspin_lock_irqsave(ap->lock, flags);\n\n\tata_port_freeze(ap);\t\t\t/* won't be thawed */\n\tap->pflags &= ~ATA_PFLAG_EH_PENDING;\t/* clear pending from freeze */\n\tap->pflags |= ATA_PFLAG_UNLOADED;\n\n\tspin_unlock_irqrestore(ap->lock, flags);\n}\n\n/**\n *\tata_scsi_error - SCSI layer error handler callback\n *\t@host: SCSI host on which error occurred\n *\n *\tHandles SCSI-layer-thrown error events.\n *\n *\tLOCKING:\n *\tInherited from SCSI layer (none, can sleep)\n *\n *\tRETURNS:\n *\tZero.\n */\nvoid ata_scsi_error(struct Scsi_Host *host)\n{\n\tstruct ata_port *ap = ata_shost_to_port(host);\n\tunsigned long flags;\n\tLIST_HEAD(eh_work_q);\n\n\tDPRINTK(\"ENTER\\n\");\n\n\tspin_lock_irqsave(host->host_lock, flags);\n\tlist_splice_init(&host->eh_cmd_q, &eh_work_q);\n\tspin_unlock_irqrestore(host->host_lock, flags);\n\n\tata_scsi_cmd_error_handler(host, ap, &eh_work_q);\n\n\t/* If we timed raced normal completion and there is nothing to\n\t   recover nr_timedout == 0 why exactly are we doing error recovery ? */\n\tata_scsi_port_error_handler(host, ap);\n\n\t/* finish or retry handled scmd's and clean up */\n\tWARN_ON(!list_empty(&eh_work_q));\n\n\tDPRINTK(\"EXIT\\n\");\n}\n\n/**\n * ata_scsi_cmd_error_handler - error callback for a list of commands\n * @host:\tscsi host containing the port\n * @ap:\t\tATA port within the host\n * @eh_work_q:\tlist of commands to process\n *\n * process the given list of commands and return those finished to the\n * ap->eh_done_q.  This function is the first part of the libata error\n * handler which processes a given list of failed commands.\n */\nvoid ata_scsi_cmd_error_handler(struct Scsi_Host *host, struct ata_port *ap,\n\t\t\t\tstruct list_head *eh_work_q)\n{\n\tint i;\n\tunsigned long flags;\n\n\t/* make sure sff pio task is not running */\n\tata_sff_flush_pio_task(ap);\n\n\t/* synchronize with host lock and sort out timeouts */\n\n\t/* For new EH, all qcs are finished in one of three ways -\n\t * normal completion, error completion, and SCSI timeout.\n\t * Both completions can race against SCSI timeout.  When normal\n\t * completion wins, the qc never reaches EH.  When error\n\t * completion wins, the qc has ATA_QCFLAG_FAILED set.\n\t *\n\t * When SCSI timeout wins, things are a bit more complex.\n\t * Normal or error completion can occur after the timeout but\n\t * before this point.  In such cases, both types of\n\t * completions are honored.  A scmd is determined to have\n\t * timed out iff its associated qc is active and not failed.\n\t */\n\tspin_lock_irqsave(ap->lock, flags);\n\tif (ap->ops->error_handler) {\n\t\tstruct scsi_cmnd *scmd, *tmp;\n\t\tint nr_timedout = 0;\n\n\t\t/* This must occur under the ap->lock as we don't want\n\t\t   a polled recovery to race the real interrupt handler\n\n\t\t   The lost_interrupt handler checks for any completed but\n\t\t   non-notified command and completes much like an IRQ handler.\n\n\t\t   We then fall into the error recovery code which will treat\n\t\t   this as if normal completion won the race */\n\n\t\tif (ap->ops->lost_interrupt)\n\t\t\tap->ops->lost_interrupt(ap);\n\n\t\tlist_for_each_entry_safe(scmd, tmp, eh_work_q, eh_entry) {\n\t\t\tstruct ata_queued_cmd *qc;\n\n\t\t\tata_qc_for_each_raw(ap, qc, i) {\n\t\t\t\tif (qc->flags & ATA_QCFLAG_ACTIVE &&\n\t\t\t\t    qc->scsicmd == scmd)\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (i < ATA_MAX_QUEUE) {\n\t\t\t\t/* the scmd has an associated qc */\n\t\t\t\tif (!(qc->flags & ATA_QCFLAG_FAILED)) {\n\t\t\t\t\t/* which hasn't failed yet, timeout */\n\t\t\t\t\tqc->err_mask |= AC_ERR_TIMEOUT;\n\t\t\t\t\tqc->flags |= ATA_QCFLAG_FAILED;\n\t\t\t\t\tnr_timedout++;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t/* Normal completion occurred after\n\t\t\t\t * SCSI timeout but before this point.\n\t\t\t\t * Successfully complete it.\n\t\t\t\t */\n\t\t\t\tscmd->retries = scmd->allowed;\n\t\t\t\tscsi_eh_finish_cmd(scmd, &ap->eh_done_q);\n\t\t\t}\n\t\t}\n\n\t\t/* If we have timed out qcs.  They belong to EH from\n\t\t * this point but the state of the controller is\n\t\t * unknown.  Freeze the port to make sure the IRQ\n\t\t * handler doesn't diddle with those qcs.  This must\n\t\t * be done atomically w.r.t. setting QCFLAG_FAILED.\n\t\t */\n\t\tif (nr_timedout)\n\t\t\t__ata_port_freeze(ap);\n\n\n\t\t/* initialize eh_tries */\n\t\tap->eh_tries = ATA_EH_MAX_TRIES;\n\t}\n\tspin_unlock_irqrestore(ap->lock, flags);\n\n}\nEXPORT_SYMBOL(ata_scsi_cmd_error_handler);\n\n/**\n * ata_scsi_port_error_handler - recover the port after the commands\n * @host:\tSCSI host containing the port\n * @ap:\t\tthe ATA port\n *\n * Handle the recovery of the port @ap after all the commands\n * have been recovered.\n */\nvoid ata_scsi_port_error_handler(struct Scsi_Host *host, struct ata_port *ap)\n{\n\tunsigned long flags;\n\n\t/* invoke error handler */\n\tif (ap->ops->error_handler) {\n\t\tstruct ata_link *link;\n\n\t\t/* acquire EH ownership */\n\t\tata_eh_acquire(ap);\n repeat:\n\t\t/* kill fast drain timer */\n\t\tdel_timer_sync(&ap->fastdrain_timer);\n\n\t\t/* process port resume request */\n\t\tata_eh_handle_port_resume(ap);\n\n\t\t/* fetch & clear EH info */\n\t\tspin_lock_irqsave(ap->lock, flags);\n\n\t\tata_for_each_link(link, ap, HOST_FIRST) {\n\t\t\tstruct ata_eh_context *ehc = &link->eh_context;\n\t\t\tstruct ata_device *dev;\n\n\t\t\tmemset(&link->eh_context, 0, sizeof(link->eh_context));\n\t\t\tlink->eh_context.i = link->eh_info;\n\t\t\tmemset(&link->eh_info, 0, sizeof(link->eh_info));\n\n\t\t\tata_for_each_dev(dev, link, ENABLED) {\n\t\t\t\tint devno = dev->devno;\n\n\t\t\t\tehc->saved_xfer_mode[devno] = dev->xfer_mode;\n\t\t\t\tif (ata_ncq_enabled(dev))\n\t\t\t\t\tehc->saved_ncq_enabled |= 1 << devno;\n\t\t\t}\n\t\t}\n\n\t\tap->pflags |= ATA_PFLAG_EH_IN_PROGRESS;\n\t\tap->pflags &= ~ATA_PFLAG_EH_PENDING;\n\t\tap->excl_link = NULL;\t/* don't maintain exclusion over EH */\n\n\t\tspin_unlock_irqrestore(ap->lock, flags);\n\n\t\t/* invoke EH, skip if unloading or suspended */\n\t\tif (!(ap->pflags & (ATA_PFLAG_UNLOADING | ATA_PFLAG_SUSPENDED)))\n\t\t\tap->ops->error_handler(ap);\n\t\telse {\n\t\t\t/* if unloading, commence suicide */\n\t\t\tif ((ap->pflags & ATA_PFLAG_UNLOADING) &&\n\t\t\t    !(ap->pflags & ATA_PFLAG_UNLOADED))\n\t\t\t\tata_eh_unload(ap);\n\t\t\tata_eh_finish(ap);\n\t\t}\n\n\t\t/* process port suspend request */\n\t\tata_eh_handle_port_suspend(ap);\n\n\t\t/* Exception might have happened after ->error_handler\n\t\t * recovered the port but before this point.  Repeat\n\t\t * EH in such case.\n\t\t */\n\t\tspin_lock_irqsave(ap->lock, flags);\n\n\t\tif (ap->pflags & ATA_PFLAG_EH_PENDING) {\n\t\t\tif (--ap->eh_tries) {\n\t\t\t\tspin_unlock_irqrestore(ap->lock, flags);\n\t\t\t\tgoto repeat;\n\t\t\t}\n\t\t\tata_port_err(ap,\n\t\t\t\t     \"EH pending after %d tries, giving up\\n\",\n\t\t\t\t     ATA_EH_MAX_TRIES);\n\t\t\tap->pflags &= ~ATA_PFLAG_EH_PENDING;\n\t\t}\n\n\t\t/* this run is complete, make sure EH info is clear */\n\t\tata_for_each_link(link, ap, HOST_FIRST)\n\t\t\tmemset(&link->eh_info, 0, sizeof(link->eh_info));\n\n\t\t/* end eh (clear host_eh_scheduled) while holding\n\t\t * ap->lock such that if exception occurs after this\n\t\t * point but before EH completion, SCSI midlayer will\n\t\t * re-initiate EH.\n\t\t */\n\t\tap->ops->end_eh(ap);\n\n\t\tspin_unlock_irqrestore(ap->lock, flags);\n\t\tata_eh_release(ap);\n\t} else {\n\t\tWARN_ON(ata_qc_from_tag(ap, ap->link.active_tag) == NULL);\n\t\tap->ops->eng_timeout(ap);\n\t}\n\n\tscsi_eh_flush_done_q(&ap->eh_done_q);\n\n\t/* clean up */\n\tspin_lock_irqsave(ap->lock, flags);\n\n\tif (ap->pflags & ATA_PFLAG_LOADING)\n\t\tap->pflags &= ~ATA_PFLAG_LOADING;\n\telse if ((ap->pflags & ATA_PFLAG_SCSI_HOTPLUG) &&\n\t\t!(ap->flags & ATA_FLAG_SAS_HOST))\n\t\tschedule_delayed_work(&ap->hotplug_task, 0);\n\n\tif (ap->pflags & ATA_PFLAG_RECOVERED)\n\t\tata_port_info(ap, \"EH complete\\n\");\n\n\tap->pflags &= ~(ATA_PFLAG_SCSI_HOTPLUG | ATA_PFLAG_RECOVERED);\n\n\t/* tell wait_eh that we're done */\n\tap->pflags &= ~ATA_PFLAG_EH_IN_PROGRESS;\n\twake_up_all(&ap->eh_wait_q);\n\n\tspin_unlock_irqrestore(ap->lock, flags);\n}\nEXPORT_SYMBOL_GPL(ata_scsi_port_error_handler);\n\n/**\n *\tata_port_wait_eh - Wait for the currently pending EH to complete\n *\t@ap: Port to wait EH for\n *\n *\tWait until the currently pending EH is complete.\n *\n *\tLOCKING:\n *\tKernel thread context (may sleep).\n */\nvoid ata_port_wait_eh(struct ata_port *ap)\n{\n\tunsigned long flags;\n\tDEFINE_WAIT(wait);\n\n retry:\n\tspin_lock_irqsave(ap->lock, flags);\n\n\twhile (ap->pflags & (ATA_PFLAG_EH_PENDING | ATA_PFLAG_EH_IN_PROGRESS)) {\n\t\tprepare_to_wait(&ap->eh_wait_q, &wait, TASK_UNINTERRUPTIBLE);\n\t\tspin_unlock_irqrestore(ap->lock, flags);\n\t\tschedule();\n\t\tspin_lock_irqsave(ap->lock, flags);\n\t}\n\tfinish_wait(&ap->eh_wait_q, &wait);\n\n\tspin_unlock_irqrestore(ap->lock, flags);\n\n\t/* make sure SCSI EH is complete */\n\tif (scsi_host_in_recovery(ap->scsi_host)) {\n\t\tata_msleep(ap, 10);\n\t\tgoto retry;\n\t}\n}\nEXPORT_SYMBOL_GPL(ata_port_wait_eh);\n\nstatic int ata_eh_nr_in_flight(struct ata_port *ap)\n{\n\tstruct ata_queued_cmd *qc;\n\tunsigned int tag;\n\tint nr = 0;\n\n\t/* count only non-internal commands */\n\tata_qc_for_each(ap, qc, tag) {\n\t\tif (qc)\n\t\t\tnr++;\n\t}\n\n\treturn nr;\n}\n\nvoid ata_eh_fastdrain_timerfn(struct timer_list *t)\n{\n\tstruct ata_port *ap = from_timer(ap, t, fastdrain_timer);\n\tunsigned long flags;\n\tint cnt;\n\n\tspin_lock_irqsave(ap->lock, flags);\n\n\tcnt = ata_eh_nr_in_flight(ap);\n\n\t/* are we done? */\n\tif (!cnt)\n\t\tgoto out_unlock;\n\n\tif (cnt == ap->fastdrain_cnt) {\n\t\tstruct ata_queued_cmd *qc;\n\t\tunsigned int tag;\n\n\t\t/* No progress during the last interval, tag all\n\t\t * in-flight qcs as timed out and freeze the port.\n\t\t */\n\t\tata_qc_for_each(ap, qc, tag) {\n\t\t\tif (qc)\n\t\t\t\tqc->err_mask |= AC_ERR_TIMEOUT;\n\t\t}\n\n\t\tata_port_freeze(ap);\n\t} else {\n\t\t/* some qcs have finished, give it another chance */\n\t\tap->fastdrain_cnt = cnt;\n\t\tap->fastdrain_timer.expires =\n\t\t\tata_deadline(jiffies, ATA_EH_FASTDRAIN_INTERVAL);\n\t\tadd_timer(&ap->fastdrain_timer);\n\t}\n\n out_unlock:\n\tspin_unlock_irqrestore(ap->lock, flags);\n}\n\n/**\n *\tata_eh_set_pending - set ATA_PFLAG_EH_PENDING and activate fast drain\n *\t@ap: target ATA port\n *\t@fastdrain: activate fast drain\n *\n *\tSet ATA_PFLAG_EH_PENDING and activate fast drain if @fastdrain\n *\tis non-zero and EH wasn't pending before.  Fast drain ensures\n *\tthat EH kicks in in timely manner.\n *\n *\tLOCKING:\n *\tspin_lock_irqsave(host lock)\n */\nstatic void ata_eh_set_pending(struct ata_port *ap, int fastdrain)\n{\n\tint cnt;\n\n\t/* already scheduled? */\n\tif (ap->pflags & ATA_PFLAG_EH_PENDING)\n\t\treturn;\n\n\tap->pflags |= ATA_PFLAG_EH_PENDING;\n\n\tif (!fastdrain)\n\t\treturn;\n\n\t/* do we have in-flight qcs? */\n\tcnt = ata_eh_nr_in_flight(ap);\n\tif (!cnt)\n\t\treturn;\n\n\t/* activate fast drain */\n\tap->fastdrain_cnt = cnt;\n\tap->fastdrain_timer.expires =\n\t\tata_deadline(jiffies, ATA_EH_FASTDRAIN_INTERVAL);\n\tadd_timer(&ap->fastdrain_timer);\n}\n\n/**\n *\tata_qc_schedule_eh - schedule qc for error handling\n *\t@qc: command to schedule error handling for\n *\n *\tSchedule error handling for @qc.  EH will kick in as soon as\n *\tother commands are drained.\n *\n *\tLOCKING:\n *\tspin_lock_irqsave(host lock)\n */\nvoid ata_qc_schedule_eh(struct ata_queued_cmd *qc)\n{\n\tstruct ata_port *ap = qc->ap;\n\n\tWARN_ON(!ap->ops->error_handler);\n\n\tqc->flags |= ATA_QCFLAG_FAILED;\n\tata_eh_set_pending(ap, 1);\n\n\t/* The following will fail if timeout has already expired.\n\t * ata_scsi_error() takes care of such scmds on EH entry.\n\t * Note that ATA_QCFLAG_FAILED is unconditionally set after\n\t * this function completes.\n\t */\n\tblk_abort_request(qc->scsicmd->request);\n}\n\n/**\n * ata_std_sched_eh - non-libsas ata_ports issue eh with this common routine\n * @ap: ATA port to schedule EH for\n *\n *\tLOCKING: inherited from ata_port_schedule_eh\n *\tspin_lock_irqsave(host lock)\n */\nvoid ata_std_sched_eh(struct ata_port *ap)\n{\n\tWARN_ON(!ap->ops->error_handler);\n\n\tif (ap->pflags & ATA_PFLAG_INITIALIZING)\n\t\treturn;\n\n\tata_eh_set_pending(ap, 1);\n\tscsi_schedule_eh(ap->scsi_host);\n\n\tDPRINTK(\"port EH scheduled\\n\");\n}\nEXPORT_SYMBOL_GPL(ata_std_sched_eh);\n\n/**\n * ata_std_end_eh - non-libsas ata_ports complete eh with this common routine\n * @ap: ATA port to end EH for\n *\n * In the libata object model there is a 1:1 mapping of ata_port to\n * shost, so host fields can be directly manipulated under ap->lock, in\n * the libsas case we need to hold a lock at the ha->level to coordinate\n * these events.\n *\n *\tLOCKING:\n *\tspin_lock_irqsave(host lock)\n */\nvoid ata_std_end_eh(struct ata_port *ap)\n{\n\tstruct Scsi_Host *host = ap->scsi_host;\n\n\thost->host_eh_scheduled = 0;\n}\nEXPORT_SYMBOL(ata_std_end_eh);\n\n\n/**\n *\tata_port_schedule_eh - schedule error handling without a qc\n *\t@ap: ATA port to schedule EH for\n *\n *\tSchedule error handling for @ap.  EH will kick in as soon as\n *\tall commands are drained.\n *\n *\tLOCKING:\n *\tspin_lock_irqsave(host lock)\n */\nvoid ata_port_schedule_eh(struct ata_port *ap)\n{\n\t/* see: ata_std_sched_eh, unless you know better */\n\tap->ops->sched_eh(ap);\n}\nEXPORT_SYMBOL_GPL(ata_port_schedule_eh);\n\nstatic int ata_do_link_abort(struct ata_port *ap, struct ata_link *link)\n{\n\tstruct ata_queued_cmd *qc;\n\tint tag, nr_aborted = 0;\n\n\tWARN_ON(!ap->ops->error_handler);\n\n\t/* we're gonna abort all commands, no need for fast drain */\n\tata_eh_set_pending(ap, 0);\n\n\t/* include internal tag in iteration */\n\tata_qc_for_each_with_internal(ap, qc, tag) {\n\t\tif (qc && (!link || qc->dev->link == link)) {\n\t\t\tqc->flags |= ATA_QCFLAG_FAILED;\n\t\t\tata_qc_complete(qc);\n\t\t\tnr_aborted++;\n\t\t}\n\t}\n\n\tif (!nr_aborted)\n\t\tata_port_schedule_eh(ap);\n\n\treturn nr_aborted;\n}\n\n/**\n *\tata_link_abort - abort all qc's on the link\n *\t@link: ATA link to abort qc's for\n *\n *\tAbort all active qc's active on @link and schedule EH.\n *\n *\tLOCKING:\n *\tspin_lock_irqsave(host lock)\n *\n *\tRETURNS:\n *\tNumber of aborted qc's.\n */\nint ata_link_abort(struct ata_link *link)\n{\n\treturn ata_do_link_abort(link->ap, link);\n}\nEXPORT_SYMBOL_GPL(ata_link_abort);\n\n/**\n *\tata_port_abort - abort all qc's on the port\n *\t@ap: ATA port to abort qc's for\n *\n *\tAbort all active qc's of @ap and schedule EH.\n *\n *\tLOCKING:\n *\tspin_lock_irqsave(host_set lock)\n *\n *\tRETURNS:\n *\tNumber of aborted qc's.\n */\nint ata_port_abort(struct ata_port *ap)\n{\n\treturn ata_do_link_abort(ap, NULL);\n}\nEXPORT_SYMBOL_GPL(ata_port_abort);\n\n/**\n *\t__ata_port_freeze - freeze port\n *\t@ap: ATA port to freeze\n *\n *\tThis function is called when HSM violation or some other\n *\tcondition disrupts normal operation of the port.  Frozen port\n *\tis not allowed to perform any operation until the port is\n *\tthawed, which usually follows a successful reset.\n *\n *\tap->ops->freeze() callback can be used for freezing the port\n *\thardware-wise (e.g. mask interrupt and stop DMA engine).  If a\n *\tport cannot be frozen hardware-wise, the interrupt handler\n *\tmust ack and clear interrupts unconditionally while the port\n *\tis frozen.\n *\n *\tLOCKING:\n *\tspin_lock_irqsave(host lock)\n */\nstatic void __ata_port_freeze(struct ata_port *ap)\n{\n\tWARN_ON(!ap->ops->error_handler);\n\n\tif (ap->ops->freeze)\n\t\tap->ops->freeze(ap);\n\n\tap->pflags |= ATA_PFLAG_FROZEN;\n\n\tDPRINTK(\"ata%u port frozen\\n\", ap->print_id);\n}\n\n/**\n *\tata_port_freeze - abort & freeze port\n *\t@ap: ATA port to freeze\n *\n *\tAbort and freeze @ap.  The freeze operation must be called\n *\tfirst, because some hardware requires special operations\n *\tbefore the taskfile registers are accessible.\n *\n *\tLOCKING:\n *\tspin_lock_irqsave(host lock)\n *\n *\tRETURNS:\n *\tNumber of aborted commands.\n */\nint ata_port_freeze(struct ata_port *ap)\n{\n\tint nr_aborted;\n\n\tWARN_ON(!ap->ops->error_handler);\n\n\t__ata_port_freeze(ap);\n\tnr_aborted = ata_port_abort(ap);\n\n\treturn nr_aborted;\n}\nEXPORT_SYMBOL_GPL(ata_port_freeze);\n\n/**\n *\tata_eh_freeze_port - EH helper to freeze port\n *\t@ap: ATA port to freeze\n *\n *\tFreeze @ap.\n *\n *\tLOCKING:\n *\tNone.\n */\nvoid ata_eh_freeze_port(struct ata_port *ap)\n{\n\tunsigned long flags;\n\n\tif (!ap->ops->error_handler)\n\t\treturn;\n\n\tspin_lock_irqsave(ap->lock, flags);\n\t__ata_port_freeze(ap);\n\tspin_unlock_irqrestore(ap->lock, flags);\n}\nEXPORT_SYMBOL_GPL(ata_eh_freeze_port);\n\n/**\n *\tata_eh_thaw_port - EH helper to thaw port\n *\t@ap: ATA port to thaw\n *\n *\tThaw frozen port @ap.\n *\n *\tLOCKING:\n *\tNone.\n */\nvoid ata_eh_thaw_port(struct ata_port *ap)\n{\n\tunsigned long flags;\n\n\tif (!ap->ops->error_handler)\n\t\treturn;\n\n\tspin_lock_irqsave(ap->lock, flags);\n\n\tap->pflags &= ~ATA_PFLAG_FROZEN;\n\n\tif (ap->ops->thaw)\n\t\tap->ops->thaw(ap);\n\n\tspin_unlock_irqrestore(ap->lock, flags);\n\n\tDPRINTK(\"ata%u port thawed\\n\", ap->print_id);\n}\n\nstatic void ata_eh_scsidone(struct scsi_cmnd *scmd)\n{\n\t/* nada */\n}\n\nstatic void __ata_eh_qc_complete(struct ata_queued_cmd *qc)\n{\n\tstruct ata_port *ap = qc->ap;\n\tstruct scsi_cmnd *scmd = qc->scsicmd;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(ap->lock, flags);\n\tqc->scsidone = ata_eh_scsidone;\n\t__ata_qc_complete(qc);\n\tWARN_ON(ata_tag_valid(qc->tag));\n\tspin_unlock_irqrestore(ap->lock, flags);\n\n\tscsi_eh_finish_cmd(scmd, &ap->eh_done_q);\n}\n\n/**\n *\tata_eh_qc_complete - Complete an active ATA command from EH\n *\t@qc: Command to complete\n *\n *\tIndicate to the mid and upper layers that an ATA command has\n *\tcompleted.  To be used from EH.\n */\nvoid ata_eh_qc_complete(struct ata_queued_cmd *qc)\n{\n\tstruct scsi_cmnd *scmd = qc->scsicmd;\n\tscmd->retries = scmd->allowed;\n\t__ata_eh_qc_complete(qc);\n}\n\n/**\n *\tata_eh_qc_retry - Tell midlayer to retry an ATA command after EH\n *\t@qc: Command to retry\n *\n *\tIndicate to the mid and upper layers that an ATA command\n *\tshould be retried.  To be used from EH.\n *\n *\tSCSI midlayer limits the number of retries to scmd->allowed.\n *\tscmd->allowed is incremented for commands which get retried\n *\tdue to unrelated failures (qc->err_mask is zero).\n */\nvoid ata_eh_qc_retry(struct ata_queued_cmd *qc)\n{\n\tstruct scsi_cmnd *scmd = qc->scsicmd;\n\tif (!qc->err_mask)\n\t\tscmd->allowed++;\n\t__ata_eh_qc_complete(qc);\n}\n\n/**\n *\tata_dev_disable - disable ATA device\n *\t@dev: ATA device to disable\n *\n *\tDisable @dev.\n *\n *\tLocking:\n *\tEH context.\n */\nvoid ata_dev_disable(struct ata_device *dev)\n{\n\tif (!ata_dev_enabled(dev))\n\t\treturn;\n\n\tif (ata_msg_drv(dev->link->ap))\n\t\tata_dev_warn(dev, \"disabled\\n\");\n\tata_acpi_on_disable(dev);\n\tata_down_xfermask_limit(dev, ATA_DNXFER_FORCE_PIO0 | ATA_DNXFER_QUIET);\n\tdev->class++;\n\n\t/* From now till the next successful probe, ering is used to\n\t * track probe failures.  Clear accumulated device error info.\n\t */\n\tata_ering_clear(&dev->ering);\n}\nEXPORT_SYMBOL_GPL(ata_dev_disable);\n\n/**\n *\tata_eh_detach_dev - detach ATA device\n *\t@dev: ATA device to detach\n *\n *\tDetach @dev.\n *\n *\tLOCKING:\n *\tNone.\n */\nvoid ata_eh_detach_dev(struct ata_device *dev)\n{\n\tstruct ata_link *link = dev->link;\n\tstruct ata_port *ap = link->ap;\n\tstruct ata_eh_context *ehc = &link->eh_context;\n\tunsigned long flags;\n\n\tata_dev_disable(dev);\n\n\tspin_lock_irqsave(ap->lock, flags);\n\n\tdev->flags &= ~ATA_DFLAG_DETACH;\n\n\tif (ata_scsi_offline_dev(dev)) {\n\t\tdev->flags |= ATA_DFLAG_DETACHED;\n\t\tap->pflags |= ATA_PFLAG_SCSI_HOTPLUG;\n\t}\n\n\t/* clear per-dev EH info */\n\tata_eh_clear_action(link, dev, &link->eh_info, ATA_EH_PERDEV_MASK);\n\tata_eh_clear_action(link, dev, &link->eh_context.i, ATA_EH_PERDEV_MASK);\n\tehc->saved_xfer_mode[dev->devno] = 0;\n\tehc->saved_ncq_enabled &= ~(1 << dev->devno);\n\n\tspin_unlock_irqrestore(ap->lock, flags);\n}\n\n/**\n *\tata_eh_about_to_do - about to perform eh_action\n *\t@link: target ATA link\n *\t@dev: target ATA dev for per-dev action (can be NULL)\n *\t@action: action about to be performed\n *\n *\tCalled just before performing EH actions to clear related bits\n *\tin @link->eh_info such that eh actions are not unnecessarily\n *\trepeated.\n *\n *\tLOCKING:\n *\tNone.\n */\nvoid ata_eh_about_to_do(struct ata_link *link, struct ata_device *dev,\n\t\t\tunsigned int action)\n{\n\tstruct ata_port *ap = link->ap;\n\tstruct ata_eh_info *ehi = &link->eh_info;\n\tstruct ata_eh_context *ehc = &link->eh_context;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(ap->lock, flags);\n\n\tata_eh_clear_action(link, dev, ehi, action);\n\n\t/* About to take EH action, set RECOVERED.  Ignore actions on\n\t * slave links as master will do them again.\n\t */\n\tif (!(ehc->i.flags & ATA_EHI_QUIET) && link != ap->slave_link)\n\t\tap->pflags |= ATA_PFLAG_RECOVERED;\n\n\tspin_unlock_irqrestore(ap->lock, flags);\n}\n\n/**\n *\tata_eh_done - EH action complete\n *\t@link: ATA link for which EH actions are complete\n *\t@dev: target ATA dev for per-dev action (can be NULL)\n *\t@action: action just completed\n *\n *\tCalled right after performing EH actions to clear related bits\n *\tin @link->eh_context.\n *\n *\tLOCKING:\n *\tNone.\n */\nvoid ata_eh_done(struct ata_link *link, struct ata_device *dev,\n\t\t unsigned int action)\n{\n\tstruct ata_eh_context *ehc = &link->eh_context;\n\n\tata_eh_clear_action(link, dev, &ehc->i, action);\n}\n\n/**\n *\tata_err_string - convert err_mask to descriptive string\n *\t@err_mask: error mask to convert to string\n *\n *\tConvert @err_mask to descriptive string.  Errors are\n *\tprioritized according to severity and only the most severe\n *\terror is reported.\n *\n *\tLOCKING:\n *\tNone.\n *\n *\tRETURNS:\n *\tDescriptive string for @err_mask\n */\nstatic const char *ata_err_string(unsigned int err_mask)\n{\n\tif (err_mask & AC_ERR_HOST_BUS)\n\t\treturn \"host bus error\";\n\tif (err_mask & AC_ERR_ATA_BUS)\n\t\treturn \"ATA bus error\";\n\tif (err_mask & AC_ERR_TIMEOUT)\n\t\treturn \"timeout\";\n\tif (err_mask & AC_ERR_HSM)\n\t\treturn \"HSM violation\";\n\tif (err_mask & AC_ERR_SYSTEM)\n\t\treturn \"internal error\";\n\tif (err_mask & AC_ERR_MEDIA)\n\t\treturn \"media error\";\n\tif (err_mask & AC_ERR_INVALID)\n\t\treturn \"invalid argument\";\n\tif (err_mask & AC_ERR_DEV)\n\t\treturn \"device error\";\n\tif (err_mask & AC_ERR_NCQ)\n\t\treturn \"NCQ error\";\n\tif (err_mask & AC_ERR_NODEV_HINT)\n\t\treturn \"Polling detection error\";\n\treturn \"unknown error\";\n}\n\n/**\n *\tatapi_eh_tur - perform ATAPI TEST_UNIT_READY\n *\t@dev: target ATAPI device\n *\t@r_sense_key: out parameter for sense_key\n *\n *\tPerform ATAPI TEST_UNIT_READY.\n *\n *\tLOCKING:\n *\tEH context (may sleep).\n *\n *\tRETURNS:\n *\t0 on success, AC_ERR_* mask on failure.\n */\nunsigned int atapi_eh_tur(struct ata_device *dev, u8 *r_sense_key)\n{\n\tu8 cdb[ATAPI_CDB_LEN] = { TEST_UNIT_READY, 0, 0, 0, 0, 0 };\n\tstruct ata_taskfile tf;\n\tunsigned int err_mask;\n\n\tata_tf_init(dev, &tf);\n\n\ttf.flags |= ATA_TFLAG_ISADDR | ATA_TFLAG_DEVICE;\n\ttf.command = ATA_CMD_PACKET;\n\ttf.protocol = ATAPI_PROT_NODATA;\n\n\terr_mask = ata_exec_internal(dev, &tf, cdb, DMA_NONE, NULL, 0, 0);\n\tif (err_mask == AC_ERR_DEV)\n\t\t*r_sense_key = tf.feature >> 4;\n\treturn err_mask;\n}\n\n/**\n *\tata_eh_request_sense - perform REQUEST_SENSE_DATA_EXT\n *\t@qc: qc to perform REQUEST_SENSE_SENSE_DATA_EXT to\n *\t@cmd: scsi command for which the sense code should be set\n *\n *\tPerform REQUEST_SENSE_DATA_EXT after the device reported CHECK\n *\tSENSE.  This function is an EH helper.\n *\n *\tLOCKING:\n *\tKernel thread context (may sleep).\n */\nstatic void ata_eh_request_sense(struct ata_queued_cmd *qc,\n\t\t\t\t struct scsi_cmnd *cmd)\n{\n\tstruct ata_device *dev = qc->dev;\n\tstruct ata_taskfile tf;\n\tunsigned int err_mask;\n\n\tif (qc->ap->pflags & ATA_PFLAG_FROZEN) {\n\t\tata_dev_warn(dev, \"sense data available but port frozen\\n\");\n\t\treturn;\n\t}\n\n\tif (!cmd || qc->flags & ATA_QCFLAG_SENSE_VALID)\n\t\treturn;\n\n\tif (!ata_id_sense_reporting_enabled(dev->id)) {\n\t\tata_dev_warn(qc->dev, \"sense data reporting disabled\\n\");\n\t\treturn;\n\t}\n\n\tDPRINTK(\"ATA request sense\\n\");\n\n\tata_tf_init(dev, &tf);\n\ttf.flags |= ATA_TFLAG_ISADDR | ATA_TFLAG_DEVICE;\n\ttf.flags |= ATA_TFLAG_LBA | ATA_TFLAG_LBA48;\n\ttf.command = ATA_CMD_REQ_SENSE_DATA;\n\ttf.protocol = ATA_PROT_NODATA;\n\n\terr_mask = ata_exec_internal(dev, &tf, NULL, DMA_NONE, NULL, 0, 0);\n\t/* Ignore err_mask; ATA_ERR might be set */\n\tif (tf.command & ATA_SENSE) {\n\t\tata_scsi_set_sense(dev, cmd, tf.lbah, tf.lbam, tf.lbal);\n\t\tqc->flags |= ATA_QCFLAG_SENSE_VALID;\n\t} else {\n\t\tata_dev_warn(dev, \"request sense failed stat %02x emask %x\\n\",\n\t\t\t     tf.command, err_mask);\n\t}\n}\n\n/**\n *\tatapi_eh_request_sense - perform ATAPI REQUEST_SENSE\n *\t@dev: device to perform REQUEST_SENSE to\n *\t@sense_buf: result sense data buffer (SCSI_SENSE_BUFFERSIZE bytes long)\n *\t@dfl_sense_key: default sense key to use\n *\n *\tPerform ATAPI REQUEST_SENSE after the device reported CHECK\n *\tSENSE.  This function is EH helper.\n *\n *\tLOCKING:\n *\tKernel thread context (may sleep).\n *\n *\tRETURNS:\n *\t0 on success, AC_ERR_* mask on failure\n */\nunsigned int atapi_eh_request_sense(struct ata_device *dev,\n\t\t\t\t\t   u8 *sense_buf, u8 dfl_sense_key)\n{\n\tu8 cdb[ATAPI_CDB_LEN] =\n\t\t{ REQUEST_SENSE, 0, 0, 0, SCSI_SENSE_BUFFERSIZE, 0 };\n\tstruct ata_port *ap = dev->link->ap;\n\tstruct ata_taskfile tf;\n\n\tDPRINTK(\"ATAPI request sense\\n\");\n\n\tmemset(sense_buf, 0, SCSI_SENSE_BUFFERSIZE);\n\n\t/* initialize sense_buf with the error register,\n\t * for the case where they are -not- overwritten\n\t */\n\tsense_buf[0] = 0x70;\n\tsense_buf[2] = dfl_sense_key;\n\n\t/* some devices time out if garbage left in tf */\n\tata_tf_init(dev, &tf);\n\n\ttf.flags |= ATA_TFLAG_ISADDR | ATA_TFLAG_DEVICE;\n\ttf.command = ATA_CMD_PACKET;\n\n\t/* is it pointless to prefer PIO for \"safety reasons\"? */\n\tif (ap->flags & ATA_FLAG_PIO_DMA) {\n\t\ttf.protocol = ATAPI_PROT_DMA;\n\t\ttf.feature |= ATAPI_PKT_DMA;\n\t} else {\n\t\ttf.protocol = ATAPI_PROT_PIO;\n\t\ttf.lbam = SCSI_SENSE_BUFFERSIZE;\n\t\ttf.lbah = 0;\n\t}\n\n\treturn ata_exec_internal(dev, &tf, cdb, DMA_FROM_DEVICE,\n\t\t\t\t sense_buf, SCSI_SENSE_BUFFERSIZE, 0);\n}\n\n/**\n *\tata_eh_analyze_serror - analyze SError for a failed port\n *\t@link: ATA link to analyze SError for\n *\n *\tAnalyze SError if available and further determine cause of\n *\tfailure.\n *\n *\tLOCKING:\n *\tNone.\n */\nstatic void ata_eh_analyze_serror(struct ata_link *link)\n{\n\tstruct ata_eh_context *ehc = &link->eh_context;\n\tu32 serror = ehc->i.serror;\n\tunsigned int err_mask = 0, action = 0;\n\tu32 hotplug_mask;\n\n\tif (serror & (SERR_PERSISTENT | SERR_DATA)) {\n\t\terr_mask |= AC_ERR_ATA_BUS;\n\t\taction |= ATA_EH_RESET;\n\t}\n\tif (serror & SERR_PROTOCOL) {\n\t\terr_mask |= AC_ERR_HSM;\n\t\taction |= ATA_EH_RESET;\n\t}\n\tif (serror & SERR_INTERNAL) {\n\t\terr_mask |= AC_ERR_SYSTEM;\n\t\taction |= ATA_EH_RESET;\n\t}\n\n\t/* Determine whether a hotplug event has occurred.  Both\n\t * SError.N/X are considered hotplug events for enabled or\n\t * host links.  For disabled PMP links, only N bit is\n\t * considered as X bit is left at 1 for link plugging.\n\t */\n\tif (link->lpm_policy > ATA_LPM_MAX_POWER)\n\t\thotplug_mask = 0;\t/* hotplug doesn't work w/ LPM */\n\telse if (!(link->flags & ATA_LFLAG_DISABLED) || ata_is_host_link(link))\n\t\thotplug_mask = SERR_PHYRDY_CHG | SERR_DEV_XCHG;\n\telse\n\t\thotplug_mask = SERR_PHYRDY_CHG;\n\n\tif (serror & hotplug_mask)\n\t\tata_ehi_hotplugged(&ehc->i);\n\n\tehc->i.err_mask |= err_mask;\n\tehc->i.action |= action;\n}\n\n/**\n *\tata_eh_analyze_tf - analyze taskfile of a failed qc\n *\t@qc: qc to analyze\n *\t@tf: Taskfile registers to analyze\n *\n *\tAnalyze taskfile of @qc and further determine cause of\n *\tfailure.  This function also requests ATAPI sense data if\n *\tavailable.\n *\n *\tLOCKING:\n *\tKernel thread context (may sleep).\n *\n *\tRETURNS:\n *\tDetermined recovery action\n */\nstatic unsigned int ata_eh_analyze_tf(struct ata_queued_cmd *qc,\n\t\t\t\t      const struct ata_taskfile *tf)\n{\n\tunsigned int tmp, action = 0;\n\tu8 stat = tf->command, err = tf->feature;\n\n\tif ((stat & (ATA_BUSY | ATA_DRQ | ATA_DRDY)) != ATA_DRDY) {\n\t\tqc->err_mask |= AC_ERR_HSM;\n\t\treturn ATA_EH_RESET;\n\t}\n\n\tif (stat & (ATA_ERR | ATA_DF)) {\n\t\tqc->err_mask |= AC_ERR_DEV;\n\t\t/*\n\t\t * Sense data reporting does not work if the\n\t\t * device fault bit is set.\n\t\t */\n\t\tif (stat & ATA_DF)\n\t\t\tstat &= ~ATA_SENSE;\n\t} else {\n\t\treturn 0;\n\t}\n\n\tswitch (qc->dev->class) {\n\tcase ATA_DEV_ZAC:\n\t\tif (stat & ATA_SENSE)\n\t\t\tata_eh_request_sense(qc, qc->scsicmd);\n\t\tfallthrough;\n\tcase ATA_DEV_ATA:\n\t\tif (err & ATA_ICRC)\n\t\t\tqc->err_mask |= AC_ERR_ATA_BUS;\n\t\tif (err & (ATA_UNC | ATA_AMNF))\n\t\t\tqc->err_mask |= AC_ERR_MEDIA;\n\t\tif (err & ATA_IDNF)\n\t\t\tqc->err_mask |= AC_ERR_INVALID;\n\t\tbreak;\n\n\tcase ATA_DEV_ATAPI:\n\t\tif (!(qc->ap->pflags & ATA_PFLAG_FROZEN)) {\n\t\t\ttmp = atapi_eh_request_sense(qc->dev,\n\t\t\t\t\t\tqc->scsicmd->sense_buffer,\n\t\t\t\t\t\tqc->result_tf.feature >> 4);\n\t\t\tif (!tmp)\n\t\t\t\tqc->flags |= ATA_QCFLAG_SENSE_VALID;\n\t\t\telse\n\t\t\t\tqc->err_mask |= tmp;\n\t\t}\n\t}\n\n\tif (qc->flags & ATA_QCFLAG_SENSE_VALID) {\n\t\tint ret = scsi_check_sense(qc->scsicmd);\n\t\t/*\n\t\t * SUCCESS here means that the sense code could be\n\t\t * evaluated and should be passed to the upper layers\n\t\t * for correct evaluation.\n\t\t * FAILED means the sense code could not be interpreted\n\t\t * and the device would need to be reset.\n\t\t * NEEDS_RETRY and ADD_TO_MLQUEUE means that the\n\t\t * command would need to be retried.\n\t\t */\n\t\tif (ret == NEEDS_RETRY || ret == ADD_TO_MLQUEUE) {\n\t\t\tqc->flags |= ATA_QCFLAG_RETRY;\n\t\t\tqc->err_mask |= AC_ERR_OTHER;\n\t\t} else if (ret != SUCCESS) {\n\t\t\tqc->err_mask |= AC_ERR_HSM;\n\t\t}\n\t}\n\tif (qc->err_mask & (AC_ERR_HSM | AC_ERR_TIMEOUT | AC_ERR_ATA_BUS))\n\t\taction |= ATA_EH_RESET;\n\n\treturn action;\n}\n\nstatic int ata_eh_categorize_error(unsigned int eflags, unsigned int err_mask,\n\t\t\t\t   int *xfer_ok)\n{\n\tint base = 0;\n\n\tif (!(eflags & ATA_EFLAG_DUBIOUS_XFER))\n\t\t*xfer_ok = 1;\n\n\tif (!*xfer_ok)\n\t\tbase = ATA_ECAT_DUBIOUS_NONE;\n\n\tif (err_mask & AC_ERR_ATA_BUS)\n\t\treturn base + ATA_ECAT_ATA_BUS;\n\n\tif (err_mask & AC_ERR_TIMEOUT)\n\t\treturn base + ATA_ECAT_TOUT_HSM;\n\n\tif (eflags & ATA_EFLAG_IS_IO) {\n\t\tif (err_mask & AC_ERR_HSM)\n\t\t\treturn base + ATA_ECAT_TOUT_HSM;\n\t\tif ((err_mask &\n\t\t     (AC_ERR_DEV|AC_ERR_MEDIA|AC_ERR_INVALID)) == AC_ERR_DEV)\n\t\t\treturn base + ATA_ECAT_UNK_DEV;\n\t}\n\n\treturn 0;\n}\n\nstruct speed_down_verdict_arg {\n\tu64 since;\n\tint xfer_ok;\n\tint nr_errors[ATA_ECAT_NR];\n};\n\nstatic int speed_down_verdict_cb(struct ata_ering_entry *ent, void *void_arg)\n{\n\tstruct speed_down_verdict_arg *arg = void_arg;\n\tint cat;\n\n\tif ((ent->eflags & ATA_EFLAG_OLD_ER) || (ent->timestamp < arg->since))\n\t\treturn -1;\n\n\tcat = ata_eh_categorize_error(ent->eflags, ent->err_mask,\n\t\t\t\t      &arg->xfer_ok);\n\targ->nr_errors[cat]++;\n\n\treturn 0;\n}\n\n/**\n *\tata_eh_speed_down_verdict - Determine speed down verdict\n *\t@dev: Device of interest\n *\n *\tThis function examines error ring of @dev and determines\n *\twhether NCQ needs to be turned off, transfer speed should be\n *\tstepped down, or falling back to PIO is necessary.\n *\n *\tECAT_ATA_BUS\t: ATA_BUS error for any command\n *\n *\tECAT_TOUT_HSM\t: TIMEOUT for any command or HSM violation for\n *\t\t\t  IO commands\n *\n *\tECAT_UNK_DEV\t: Unknown DEV error for IO commands\n *\n *\tECAT_DUBIOUS_*\t: Identical to above three but occurred while\n *\t\t\t  data transfer hasn't been verified.\n *\n *\tVerdicts are\n *\n *\tNCQ_OFF\t\t: Turn off NCQ.\n *\n *\tSPEED_DOWN\t: Speed down transfer speed but don't fall back\n *\t\t\t  to PIO.\n *\n *\tFALLBACK_TO_PIO\t: Fall back to PIO.\n *\n *\tEven if multiple verdicts are returned, only one action is\n *\ttaken per error.  An action triggered by non-DUBIOUS errors\n *\tclears ering, while one triggered by DUBIOUS_* errors doesn't.\n *\tThis is to expedite speed down decisions right after device is\n *\tinitially configured.\n *\n *\tThe following are speed down rules.  #1 and #2 deal with\n *\tDUBIOUS errors.\n *\n *\t1. If more than one DUBIOUS_ATA_BUS or DUBIOUS_TOUT_HSM errors\n *\t   occurred during last 5 mins, SPEED_DOWN and FALLBACK_TO_PIO.\n *\n *\t2. If more than one DUBIOUS_TOUT_HSM or DUBIOUS_UNK_DEV errors\n *\t   occurred during last 5 mins, NCQ_OFF.\n *\n *\t3. If more than 8 ATA_BUS, TOUT_HSM or UNK_DEV errors\n *\t   occurred during last 5 mins, FALLBACK_TO_PIO\n *\n *\t4. If more than 3 TOUT_HSM or UNK_DEV errors occurred\n *\t   during last 10 mins, NCQ_OFF.\n *\n *\t5. If more than 3 ATA_BUS or TOUT_HSM errors, or more than 6\n *\t   UNK_DEV errors occurred during last 10 mins, SPEED_DOWN.\n *\n *\tLOCKING:\n *\tInherited from caller.\n *\n *\tRETURNS:\n *\tOR of ATA_EH_SPDN_* flags.\n */\nstatic unsigned int ata_eh_speed_down_verdict(struct ata_device *dev)\n{\n\tconst u64 j5mins = 5LLU * 60 * HZ, j10mins = 10LLU * 60 * HZ;\n\tu64 j64 = get_jiffies_64();\n\tstruct speed_down_verdict_arg arg;\n\tunsigned int verdict = 0;\n\n\t/* scan past 5 mins of error history */\n\tmemset(&arg, 0, sizeof(arg));\n\targ.since = j64 - min(j64, j5mins);\n\tata_ering_map(&dev->ering, speed_down_verdict_cb, &arg);\n\n\tif (arg.nr_errors[ATA_ECAT_DUBIOUS_ATA_BUS] +\n\t    arg.nr_errors[ATA_ECAT_DUBIOUS_TOUT_HSM] > 1)\n\t\tverdict |= ATA_EH_SPDN_SPEED_DOWN |\n\t\t\tATA_EH_SPDN_FALLBACK_TO_PIO | ATA_EH_SPDN_KEEP_ERRORS;\n\n\tif (arg.nr_errors[ATA_ECAT_DUBIOUS_TOUT_HSM] +\n\t    arg.nr_errors[ATA_ECAT_DUBIOUS_UNK_DEV] > 1)\n\t\tverdict |= ATA_EH_SPDN_NCQ_OFF | ATA_EH_SPDN_KEEP_ERRORS;\n\n\tif (arg.nr_errors[ATA_ECAT_ATA_BUS] +\n\t    arg.nr_errors[ATA_ECAT_TOUT_HSM] +\n\t    arg.nr_errors[ATA_ECAT_UNK_DEV] > 6)\n\t\tverdict |= ATA_EH_SPDN_FALLBACK_TO_PIO;\n\n\t/* scan past 10 mins of error history */\n\tmemset(&arg, 0, sizeof(arg));\n\targ.since = j64 - min(j64, j10mins);\n\tata_ering_map(&dev->ering, speed_down_verdict_cb, &arg);\n\n\tif (arg.nr_errors[ATA_ECAT_TOUT_HSM] +\n\t    arg.nr_errors[ATA_ECAT_UNK_DEV] > 3)\n\t\tverdict |= ATA_EH_SPDN_NCQ_OFF;\n\n\tif (arg.nr_errors[ATA_ECAT_ATA_BUS] +\n\t    arg.nr_errors[ATA_ECAT_TOUT_HSM] > 3 ||\n\t    arg.nr_errors[ATA_ECAT_UNK_DEV] > 6)\n\t\tverdict |= ATA_EH_SPDN_SPEED_DOWN;\n\n\treturn verdict;\n}\n\n/**\n *\tata_eh_speed_down - record error and speed down if necessary\n *\t@dev: Failed device\n *\t@eflags: mask of ATA_EFLAG_* flags\n *\t@err_mask: err_mask of the error\n *\n *\tRecord error and examine error history to determine whether\n *\tadjusting transmission speed is necessary.  It also sets\n *\ttransmission limits appropriately if such adjustment is\n *\tnecessary.\n *\n *\tLOCKING:\n *\tKernel thread context (may sleep).\n *\n *\tRETURNS:\n *\tDetermined recovery action.\n */\nstatic unsigned int ata_eh_speed_down(struct ata_device *dev,\n\t\t\t\tunsigned int eflags, unsigned int err_mask)\n{\n\tstruct ata_link *link = ata_dev_phys_link(dev);\n\tint xfer_ok = 0;\n\tunsigned int verdict;\n\tunsigned int action = 0;\n\n\t/* don't bother if Cat-0 error */\n\tif (ata_eh_categorize_error(eflags, err_mask, &xfer_ok) == 0)\n\t\treturn 0;\n\n\t/* record error and determine whether speed down is necessary */\n\tata_ering_record(&dev->ering, eflags, err_mask);\n\tverdict = ata_eh_speed_down_verdict(dev);\n\n\t/* turn off NCQ? */\n\tif ((verdict & ATA_EH_SPDN_NCQ_OFF) &&\n\t    (dev->flags & (ATA_DFLAG_PIO | ATA_DFLAG_NCQ |\n\t\t\t   ATA_DFLAG_NCQ_OFF)) == ATA_DFLAG_NCQ) {\n\t\tdev->flags |= ATA_DFLAG_NCQ_OFF;\n\t\tata_dev_warn(dev, \"NCQ disabled due to excessive errors\\n\");\n\t\tgoto done;\n\t}\n\n\t/* speed down? */\n\tif (verdict & ATA_EH_SPDN_SPEED_DOWN) {\n\t\t/* speed down SATA link speed if possible */\n\t\tif (sata_down_spd_limit(link, 0) == 0) {\n\t\t\taction |= ATA_EH_RESET;\n\t\t\tgoto done;\n\t\t}\n\n\t\t/* lower transfer mode */\n\t\tif (dev->spdn_cnt < 2) {\n\t\t\tstatic const int dma_dnxfer_sel[] =\n\t\t\t\t{ ATA_DNXFER_DMA, ATA_DNXFER_40C };\n\t\t\tstatic const int pio_dnxfer_sel[] =\n\t\t\t\t{ ATA_DNXFER_PIO, ATA_DNXFER_FORCE_PIO0 };\n\t\t\tint sel;\n\n\t\t\tif (dev->xfer_shift != ATA_SHIFT_PIO)\n\t\t\t\tsel = dma_dnxfer_sel[dev->spdn_cnt];\n\t\t\telse\n\t\t\t\tsel = pio_dnxfer_sel[dev->spdn_cnt];\n\n\t\t\tdev->spdn_cnt++;\n\n\t\t\tif (ata_down_xfermask_limit(dev, sel) == 0) {\n\t\t\t\taction |= ATA_EH_RESET;\n\t\t\t\tgoto done;\n\t\t\t}\n\t\t}\n\t}\n\n\t/* Fall back to PIO?  Slowing down to PIO is meaningless for\n\t * SATA ATA devices.  Consider it only for PATA and SATAPI.\n\t */\n\tif ((verdict & ATA_EH_SPDN_FALLBACK_TO_PIO) && (dev->spdn_cnt >= 2) &&\n\t    (link->ap->cbl != ATA_CBL_SATA || dev->class == ATA_DEV_ATAPI) &&\n\t    (dev->xfer_shift != ATA_SHIFT_PIO)) {\n\t\tif (ata_down_xfermask_limit(dev, ATA_DNXFER_FORCE_PIO) == 0) {\n\t\t\tdev->spdn_cnt = 0;\n\t\t\taction |= ATA_EH_RESET;\n\t\t\tgoto done;\n\t\t}\n\t}\n\n\treturn 0;\n done:\n\t/* device has been slowed down, blow error history */\n\tif (!(verdict & ATA_EH_SPDN_KEEP_ERRORS))\n\t\tata_ering_clear(&dev->ering);\n\treturn action;\n}\n\n/**\n *\tata_eh_worth_retry - analyze error and decide whether to retry\n *\t@qc: qc to possibly retry\n *\n *\tLook at the cause of the error and decide if a retry\n * \tmight be useful or not.  We don't want to retry media errors\n *\tbecause the drive itself has probably already taken 10-30 seconds\n *\tdoing its own internal retries before reporting the failure.\n */\nstatic inline int ata_eh_worth_retry(struct ata_queued_cmd *qc)\n{\n\tif (qc->err_mask & AC_ERR_MEDIA)\n\t\treturn 0;\t/* don't retry media errors */\n\tif (qc->flags & ATA_QCFLAG_IO)\n\t\treturn 1;\t/* otherwise retry anything from fs stack */\n\tif (qc->err_mask & AC_ERR_INVALID)\n\t\treturn 0;\t/* don't retry these */\n\treturn qc->err_mask != AC_ERR_DEV;  /* retry if not dev error */\n}\n\n/**\n *      ata_eh_quiet - check if we need to be quiet about a command error\n *      @qc: qc to check\n *\n *      Look at the qc flags anbd its scsi command request flags to determine\n *      if we need to be quiet about the command failure.\n */\nstatic inline bool ata_eh_quiet(struct ata_queued_cmd *qc)\n{\n\tif (qc->scsicmd &&\n\t    qc->scsicmd->request->rq_flags & RQF_QUIET)\n\t\tqc->flags |= ATA_QCFLAG_QUIET;\n\treturn qc->flags & ATA_QCFLAG_QUIET;\n}\n\n/**\n *\tata_eh_link_autopsy - analyze error and determine recovery action\n *\t@link: host link to perform autopsy on\n *\n *\tAnalyze why @link failed and determine which recovery actions\n *\tare needed.  This function also sets more detailed AC_ERR_*\n *\tvalues and fills sense data for ATAPI CHECK SENSE.\n *\n *\tLOCKING:\n *\tKernel thread context (may sleep).\n */\nstatic void ata_eh_link_autopsy(struct ata_link *link)\n{\n\tstruct ata_port *ap = link->ap;\n\tstruct ata_eh_context *ehc = &link->eh_context;\n\tstruct ata_queued_cmd *qc;\n\tstruct ata_device *dev;\n\tunsigned int all_err_mask = 0, eflags = 0;\n\tint tag, nr_failed = 0, nr_quiet = 0;\n\tu32 serror;\n\tint rc;\n\n\tDPRINTK(\"ENTER\\n\");\n\n\tif (ehc->i.flags & ATA_EHI_NO_AUTOPSY)\n\t\treturn;\n\n\t/* obtain and analyze SError */\n\trc = sata_scr_read(link, SCR_ERROR, &serror);\n\tif (rc == 0) {\n\t\tehc->i.serror |= serror;\n\t\tata_eh_analyze_serror(link);\n\t} else if (rc != -EOPNOTSUPP) {\n\t\t/* SError read failed, force reset and probing */\n\t\tehc->i.probe_mask |= ATA_ALL_DEVICES;\n\t\tehc->i.action |= ATA_EH_RESET;\n\t\tehc->i.err_mask |= AC_ERR_OTHER;\n\t}\n\n\t/* analyze NCQ failure */\n\tata_eh_analyze_ncq_error(link);\n\n\t/* any real error trumps AC_ERR_OTHER */\n\tif (ehc->i.err_mask & ~AC_ERR_OTHER)\n\t\tehc->i.err_mask &= ~AC_ERR_OTHER;\n\n\tall_err_mask |= ehc->i.err_mask;\n\n\tata_qc_for_each_raw(ap, qc, tag) {\n\t\tif (!(qc->flags & ATA_QCFLAG_FAILED) ||\n\t\t    ata_dev_phys_link(qc->dev) != link)\n\t\t\tcontinue;\n\n\t\t/* inherit upper level err_mask */\n\t\tqc->err_mask |= ehc->i.err_mask;\n\n\t\t/* analyze TF */\n\t\tehc->i.action |= ata_eh_analyze_tf(qc, &qc->result_tf);\n\n\t\t/* DEV errors are probably spurious in case of ATA_BUS error */\n\t\tif (qc->err_mask & AC_ERR_ATA_BUS)\n\t\t\tqc->err_mask &= ~(AC_ERR_DEV | AC_ERR_MEDIA |\n\t\t\t\t\t  AC_ERR_INVALID);\n\n\t\t/* any real error trumps unknown error */\n\t\tif (qc->err_mask & ~AC_ERR_OTHER)\n\t\t\tqc->err_mask &= ~AC_ERR_OTHER;\n\n\t\t/*\n\t\t * SENSE_VALID trumps dev/unknown error and revalidation. Upper\n\t\t * layers will determine whether the command is worth retrying\n\t\t * based on the sense data and device class/type. Otherwise,\n\t\t * determine directly if the command is worth retrying using its\n\t\t * error mask and flags.\n\t\t */\n\t\tif (qc->flags & ATA_QCFLAG_SENSE_VALID)\n\t\t\tqc->err_mask &= ~(AC_ERR_DEV | AC_ERR_OTHER);\n\t\telse if (ata_eh_worth_retry(qc))\n\t\t\tqc->flags |= ATA_QCFLAG_RETRY;\n\n\t\t/* accumulate error info */\n\t\tehc->i.dev = qc->dev;\n\t\tall_err_mask |= qc->err_mask;\n\t\tif (qc->flags & ATA_QCFLAG_IO)\n\t\t\teflags |= ATA_EFLAG_IS_IO;\n\t\ttrace_ata_eh_link_autopsy_qc(qc);\n\n\t\t/* Count quiet errors */\n\t\tif (ata_eh_quiet(qc))\n\t\t\tnr_quiet++;\n\t\tnr_failed++;\n\t}\n\n\t/* If all failed commands requested silence, then be quiet */\n\tif (nr_quiet == nr_failed)\n\t\tehc->i.flags |= ATA_EHI_QUIET;\n\n\t/* enforce default EH actions */\n\tif (ap->pflags & ATA_PFLAG_FROZEN ||\n\t    all_err_mask & (AC_ERR_HSM | AC_ERR_TIMEOUT))\n\t\tehc->i.action |= ATA_EH_RESET;\n\telse if (((eflags & ATA_EFLAG_IS_IO) && all_err_mask) ||\n\t\t (!(eflags & ATA_EFLAG_IS_IO) && (all_err_mask & ~AC_ERR_DEV)))\n\t\tehc->i.action |= ATA_EH_REVALIDATE;\n\n\t/* If we have offending qcs and the associated failed device,\n\t * perform per-dev EH action only on the offending device.\n\t */\n\tif (ehc->i.dev) {\n\t\tehc->i.dev_action[ehc->i.dev->devno] |=\n\t\t\tehc->i.action & ATA_EH_PERDEV_MASK;\n\t\tehc->i.action &= ~ATA_EH_PERDEV_MASK;\n\t}\n\n\t/* propagate timeout to host link */\n\tif ((all_err_mask & AC_ERR_TIMEOUT) && !ata_is_host_link(link))\n\t\tap->link.eh_context.i.err_mask |= AC_ERR_TIMEOUT;\n\n\t/* record error and consider speeding down */\n\tdev = ehc->i.dev;\n\tif (!dev && ((ata_link_max_devices(link) == 1 &&\n\t\t      ata_dev_enabled(link->device))))\n\t    dev = link->device;\n\n\tif (dev) {\n\t\tif (dev->flags & ATA_DFLAG_DUBIOUS_XFER)\n\t\t\teflags |= ATA_EFLAG_DUBIOUS_XFER;\n\t\tehc->i.action |= ata_eh_speed_down(dev, eflags, all_err_mask);\n\t\ttrace_ata_eh_link_autopsy(dev, ehc->i.action, all_err_mask);\n\t}\n\tDPRINTK(\"EXIT\\n\");\n}\n\n/**\n *\tata_eh_autopsy - analyze error and determine recovery action\n *\t@ap: host port to perform autopsy on\n *\n *\tAnalyze all links of @ap and determine why they failed and\n *\twhich recovery actions are needed.\n *\n *\tLOCKING:\n *\tKernel thread context (may sleep).\n */\nvoid ata_eh_autopsy(struct ata_port *ap)\n{\n\tstruct ata_link *link;\n\n\tata_for_each_link(link, ap, EDGE)\n\t\tata_eh_link_autopsy(link);\n\n\t/* Handle the frigging slave link.  Autopsy is done similarly\n\t * but actions and flags are transferred over to the master\n\t * link and handled from there.\n\t */\n\tif (ap->slave_link) {\n\t\tstruct ata_eh_context *mehc = &ap->link.eh_context;\n\t\tstruct ata_eh_context *sehc = &ap->slave_link->eh_context;\n\n\t\t/* transfer control flags from master to slave */\n\t\tsehc->i.flags |= mehc->i.flags & ATA_EHI_TO_SLAVE_MASK;\n\n\t\t/* perform autopsy on the slave link */\n\t\tata_eh_link_autopsy(ap->slave_link);\n\n\t\t/* transfer actions from slave to master and clear slave */\n\t\tata_eh_about_to_do(ap->slave_link, NULL, ATA_EH_ALL_ACTIONS);\n\t\tmehc->i.action\t\t|= sehc->i.action;\n\t\tmehc->i.dev_action[1]\t|= sehc->i.dev_action[1];\n\t\tmehc->i.flags\t\t|= sehc->i.flags;\n\t\tata_eh_done(ap->slave_link, NULL, ATA_EH_ALL_ACTIONS);\n\t}\n\n\t/* Autopsy of fanout ports can affect host link autopsy.\n\t * Perform host link autopsy last.\n\t */\n\tif (sata_pmp_attached(ap))\n\t\tata_eh_link_autopsy(&ap->link);\n}\n\n/**\n *\tata_get_cmd_descript - get description for ATA command\n *\t@command: ATA command code to get description for\n *\n *\tReturn a textual description of the given command, or NULL if the\n *\tcommand is not known.\n *\n *\tLOCKING:\n *\tNone\n */\nconst char *ata_get_cmd_descript(u8 command)\n{\n#ifdef CONFIG_ATA_VERBOSE_ERROR\n\tstatic const struct\n\t{\n\t\tu8 command;\n\t\tconst char *text;\n\t} cmd_descr[] = {\n\t\t{ ATA_CMD_DEV_RESET,\t\t\"DEVICE RESET\" },\n\t\t{ ATA_CMD_CHK_POWER,\t\t\"CHECK POWER MODE\" },\n\t\t{ ATA_CMD_STANDBY,\t\t\"STANDBY\" },\n\t\t{ ATA_CMD_IDLE,\t\t\t\"IDLE\" },\n\t\t{ ATA_CMD_EDD,\t\t\t\"EXECUTE DEVICE DIAGNOSTIC\" },\n\t\t{ ATA_CMD_DOWNLOAD_MICRO,\t\"DOWNLOAD MICROCODE\" },\n\t\t{ ATA_CMD_DOWNLOAD_MICRO_DMA,\t\"DOWNLOAD MICROCODE DMA\" },\n\t\t{ ATA_CMD_NOP,\t\t\t\"NOP\" },\n\t\t{ ATA_CMD_FLUSH,\t\t\"FLUSH CACHE\" },\n\t\t{ ATA_CMD_FLUSH_EXT,\t\t\"FLUSH CACHE EXT\" },\n\t\t{ ATA_CMD_ID_ATA,\t\t\"IDENTIFY DEVICE\" },\n\t\t{ ATA_CMD_ID_ATAPI,\t\t\"IDENTIFY PACKET DEVICE\" },\n\t\t{ ATA_CMD_SERVICE,\t\t\"SERVICE\" },\n\t\t{ ATA_CMD_READ,\t\t\t\"READ DMA\" },\n\t\t{ ATA_CMD_READ_EXT,\t\t\"READ DMA EXT\" },\n\t\t{ ATA_CMD_READ_QUEUED,\t\t\"READ DMA QUEUED\" },\n\t\t{ ATA_CMD_READ_STREAM_EXT,\t\"READ STREAM EXT\" },\n\t\t{ ATA_CMD_READ_STREAM_DMA_EXT,  \"READ STREAM DMA EXT\" },\n\t\t{ ATA_CMD_WRITE,\t\t\"WRITE DMA\" },\n\t\t{ ATA_CMD_WRITE_EXT,\t\t\"WRITE DMA EXT\" },\n\t\t{ ATA_CMD_WRITE_QUEUED,\t\t\"WRITE DMA QUEUED EXT\" },\n\t\t{ ATA_CMD_WRITE_STREAM_EXT,\t\"WRITE STREAM EXT\" },\n\t\t{ ATA_CMD_WRITE_STREAM_DMA_EXT, \"WRITE STREAM DMA EXT\" },\n\t\t{ ATA_CMD_WRITE_FUA_EXT,\t\"WRITE DMA FUA EXT\" },\n\t\t{ ATA_CMD_WRITE_QUEUED_FUA_EXT, \"WRITE DMA QUEUED FUA EXT\" },\n\t\t{ ATA_CMD_FPDMA_READ,\t\t\"READ FPDMA QUEUED\" },\n\t\t{ ATA_CMD_FPDMA_WRITE,\t\t\"WRITE FPDMA QUEUED\" },\n\t\t{ ATA_CMD_FPDMA_SEND,\t\t\"SEND FPDMA QUEUED\" },\n\t\t{ ATA_CMD_FPDMA_RECV,\t\t\"RECEIVE FPDMA QUEUED\" },\n\t\t{ ATA_CMD_PIO_READ,\t\t\"READ SECTOR(S)\" },\n\t\t{ ATA_CMD_PIO_READ_EXT,\t\t\"READ SECTOR(S) EXT\" },\n\t\t{ ATA_CMD_PIO_WRITE,\t\t\"WRITE SECTOR(S)\" },\n\t\t{ ATA_CMD_PIO_WRITE_EXT,\t\"WRITE SECTOR(S) EXT\" },\n\t\t{ ATA_CMD_READ_MULTI,\t\t\"READ MULTIPLE\" },\n\t\t{ ATA_CMD_READ_MULTI_EXT,\t\"READ MULTIPLE EXT\" },\n\t\t{ ATA_CMD_WRITE_MULTI,\t\t\"WRITE MULTIPLE\" },\n\t\t{ ATA_CMD_WRITE_MULTI_EXT,\t\"WRITE MULTIPLE EXT\" },\n\t\t{ ATA_CMD_WRITE_MULTI_FUA_EXT,\t\"WRITE MULTIPLE FUA EXT\" },\n\t\t{ ATA_CMD_SET_FEATURES,\t\t\"SET FEATURES\" },\n\t\t{ ATA_CMD_SET_MULTI,\t\t\"SET MULTIPLE MODE\" },\n\t\t{ ATA_CMD_VERIFY,\t\t\"READ VERIFY SECTOR(S)\" },\n\t\t{ ATA_CMD_VERIFY_EXT,\t\t\"READ VERIFY SECTOR(S) EXT\" },\n\t\t{ ATA_CMD_WRITE_UNCORR_EXT,\t\"WRITE UNCORRECTABLE EXT\" },\n\t\t{ ATA_CMD_STANDBYNOW1,\t\t\"STANDBY IMMEDIATE\" },\n\t\t{ ATA_CMD_IDLEIMMEDIATE,\t\"IDLE IMMEDIATE\" },\n\t\t{ ATA_CMD_SLEEP,\t\t\"SLEEP\" },\n\t\t{ ATA_CMD_INIT_DEV_PARAMS,\t\"INITIALIZE DEVICE PARAMETERS\" },\n\t\t{ ATA_CMD_READ_NATIVE_MAX,\t\"READ NATIVE MAX ADDRESS\" },\n\t\t{ ATA_CMD_READ_NATIVE_MAX_EXT,\t\"READ NATIVE MAX ADDRESS EXT\" },\n\t\t{ ATA_CMD_SET_MAX,\t\t\"SET MAX ADDRESS\" },\n\t\t{ ATA_CMD_SET_MAX_EXT,\t\t\"SET MAX ADDRESS EXT\" },\n\t\t{ ATA_CMD_READ_LOG_EXT,\t\t\"READ LOG EXT\" },\n\t\t{ ATA_CMD_WRITE_LOG_EXT,\t\"WRITE LOG EXT\" },\n\t\t{ ATA_CMD_READ_LOG_DMA_EXT,\t\"READ LOG DMA EXT\" },\n\t\t{ ATA_CMD_WRITE_LOG_DMA_EXT,\t\"WRITE LOG DMA EXT\" },\n\t\t{ ATA_CMD_TRUSTED_NONDATA,\t\"TRUSTED NON-DATA\" },\n\t\t{ ATA_CMD_TRUSTED_RCV,\t\t\"TRUSTED RECEIVE\" },\n\t\t{ ATA_CMD_TRUSTED_RCV_DMA,\t\"TRUSTED RECEIVE DMA\" },\n\t\t{ ATA_CMD_TRUSTED_SND,\t\t\"TRUSTED SEND\" },\n\t\t{ ATA_CMD_TRUSTED_SND_DMA,\t\"TRUSTED SEND DMA\" },\n\t\t{ ATA_CMD_PMP_READ,\t\t\"READ BUFFER\" },\n\t\t{ ATA_CMD_PMP_READ_DMA,\t\t\"READ BUFFER DMA\" },\n\t\t{ ATA_CMD_PMP_WRITE,\t\t\"WRITE BUFFER\" },\n\t\t{ ATA_CMD_PMP_WRITE_DMA,\t\"WRITE BUFFER DMA\" },\n\t\t{ ATA_CMD_CONF_OVERLAY,\t\t\"DEVICE CONFIGURATION OVERLAY\" },\n\t\t{ ATA_CMD_SEC_SET_PASS,\t\t\"SECURITY SET PASSWORD\" },\n\t\t{ ATA_CMD_SEC_UNLOCK,\t\t\"SECURITY UNLOCK\" },\n\t\t{ ATA_CMD_SEC_ERASE_PREP,\t\"SECURITY ERASE PREPARE\" },\n\t\t{ ATA_CMD_SEC_ERASE_UNIT,\t\"SECURITY ERASE UNIT\" },\n\t\t{ ATA_CMD_SEC_FREEZE_LOCK,\t\"SECURITY FREEZE LOCK\" },\n\t\t{ ATA_CMD_SEC_DISABLE_PASS,\t\"SECURITY DISABLE PASSWORD\" },\n\t\t{ ATA_CMD_CONFIG_STREAM,\t\"CONFIGURE STREAM\" },\n\t\t{ ATA_CMD_SMART,\t\t\"SMART\" },\n\t\t{ ATA_CMD_MEDIA_LOCK,\t\t\"DOOR LOCK\" },\n\t\t{ ATA_CMD_MEDIA_UNLOCK,\t\t\"DOOR UNLOCK\" },\n\t\t{ ATA_CMD_DSM,\t\t\t\"DATA SET MANAGEMENT\" },\n\t\t{ ATA_CMD_CHK_MED_CRD_TYP,\t\"CHECK MEDIA CARD TYPE\" },\n\t\t{ ATA_CMD_CFA_REQ_EXT_ERR,\t\"CFA REQUEST EXTENDED ERROR\" },\n\t\t{ ATA_CMD_CFA_WRITE_NE,\t\t\"CFA WRITE SECTORS WITHOUT ERASE\" },\n\t\t{ ATA_CMD_CFA_TRANS_SECT,\t\"CFA TRANSLATE SECTOR\" },\n\t\t{ ATA_CMD_CFA_ERASE,\t\t\"CFA ERASE SECTORS\" },\n\t\t{ ATA_CMD_CFA_WRITE_MULT_NE,\t\"CFA WRITE MULTIPLE WITHOUT ERASE\" },\n\t\t{ ATA_CMD_REQ_SENSE_DATA,\t\"REQUEST SENSE DATA EXT\" },\n\t\t{ ATA_CMD_SANITIZE_DEVICE,\t\"SANITIZE DEVICE\" },\n\t\t{ ATA_CMD_ZAC_MGMT_IN,\t\t\"ZAC MANAGEMENT IN\" },\n\t\t{ ATA_CMD_ZAC_MGMT_OUT,\t\t\"ZAC MANAGEMENT OUT\" },\n\t\t{ ATA_CMD_READ_LONG,\t\t\"READ LONG (with retries)\" },\n\t\t{ ATA_CMD_READ_LONG_ONCE,\t\"READ LONG (without retries)\" },\n\t\t{ ATA_CMD_WRITE_LONG,\t\t\"WRITE LONG (with retries)\" },\n\t\t{ ATA_CMD_WRITE_LONG_ONCE,\t\"WRITE LONG (without retries)\" },\n\t\t{ ATA_CMD_RESTORE,\t\t\"RECALIBRATE\" },\n\t\t{ 0,\t\t\t\tNULL } /* terminate list */\n\t};\n\n\tunsigned int i;\n\tfor (i = 0; cmd_descr[i].text; i++)\n\t\tif (cmd_descr[i].command == command)\n\t\t\treturn cmd_descr[i].text;\n#endif\n\n\treturn NULL;\n}\nEXPORT_SYMBOL_GPL(ata_get_cmd_descript);\n\n/**\n *\tata_eh_link_report - report error handling to user\n *\t@link: ATA link EH is going on\n *\n *\tReport EH to user.\n *\n *\tLOCKING:\n *\tNone.\n */\nstatic void ata_eh_link_report(struct ata_link *link)\n{\n\tstruct ata_port *ap = link->ap;\n\tstruct ata_eh_context *ehc = &link->eh_context;\n\tstruct ata_queued_cmd *qc;\n\tconst char *frozen, *desc;\n\tchar tries_buf[6] = \"\";\n\tint tag, nr_failed = 0;\n\n\tif (ehc->i.flags & ATA_EHI_QUIET)\n\t\treturn;\n\n\tdesc = NULL;\n\tif (ehc->i.desc[0] != '\\0')\n\t\tdesc = ehc->i.desc;\n\n\tata_qc_for_each_raw(ap, qc, tag) {\n\t\tif (!(qc->flags & ATA_QCFLAG_FAILED) ||\n\t\t    ata_dev_phys_link(qc->dev) != link ||\n\t\t    ((qc->flags & ATA_QCFLAG_QUIET) &&\n\t\t     qc->err_mask == AC_ERR_DEV))\n\t\t\tcontinue;\n\t\tif (qc->flags & ATA_QCFLAG_SENSE_VALID && !qc->err_mask)\n\t\t\tcontinue;\n\n\t\tnr_failed++;\n\t}\n\n\tif (!nr_failed && !ehc->i.err_mask)\n\t\treturn;\n\n\tfrozen = \"\";\n\tif (ap->pflags & ATA_PFLAG_FROZEN)\n\t\tfrozen = \" frozen\";\n\n\tif (ap->eh_tries < ATA_EH_MAX_TRIES)\n\t\tsnprintf(tries_buf, sizeof(tries_buf), \" t%d\",\n\t\t\t ap->eh_tries);\n\n\tif (ehc->i.dev) {\n\t\tata_dev_err(ehc->i.dev, \"exception Emask 0x%x \"\n\t\t\t    \"SAct 0x%x SErr 0x%x action 0x%x%s%s\\n\",\n\t\t\t    ehc->i.err_mask, link->sactive, ehc->i.serror,\n\t\t\t    ehc->i.action, frozen, tries_buf);\n\t\tif (desc)\n\t\t\tata_dev_err(ehc->i.dev, \"%s\\n\", desc);\n\t} else {\n\t\tata_link_err(link, \"exception Emask 0x%x \"\n\t\t\t     \"SAct 0x%x SErr 0x%x action 0x%x%s%s\\n\",\n\t\t\t     ehc->i.err_mask, link->sactive, ehc->i.serror,\n\t\t\t     ehc->i.action, frozen, tries_buf);\n\t\tif (desc)\n\t\t\tata_link_err(link, \"%s\\n\", desc);\n\t}\n\n#ifdef CONFIG_ATA_VERBOSE_ERROR\n\tif (ehc->i.serror)\n\t\tata_link_err(link,\n\t\t  \"SError: { %s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s}\\n\",\n\t\t  ehc->i.serror & SERR_DATA_RECOVERED ? \"RecovData \" : \"\",\n\t\t  ehc->i.serror & SERR_COMM_RECOVERED ? \"RecovComm \" : \"\",\n\t\t  ehc->i.serror & SERR_DATA ? \"UnrecovData \" : \"\",\n\t\t  ehc->i.serror & SERR_PERSISTENT ? \"Persist \" : \"\",\n\t\t  ehc->i.serror & SERR_PROTOCOL ? \"Proto \" : \"\",\n\t\t  ehc->i.serror & SERR_INTERNAL ? \"HostInt \" : \"\",\n\t\t  ehc->i.serror & SERR_PHYRDY_CHG ? \"PHYRdyChg \" : \"\",\n\t\t  ehc->i.serror & SERR_PHY_INT_ERR ? \"PHYInt \" : \"\",\n\t\t  ehc->i.serror & SERR_COMM_WAKE ? \"CommWake \" : \"\",\n\t\t  ehc->i.serror & SERR_10B_8B_ERR ? \"10B8B \" : \"\",\n\t\t  ehc->i.serror & SERR_DISPARITY ? \"Dispar \" : \"\",\n\t\t  ehc->i.serror & SERR_CRC ? \"BadCRC \" : \"\",\n\t\t  ehc->i.serror & SERR_HANDSHAKE ? \"Handshk \" : \"\",\n\t\t  ehc->i.serror & SERR_LINK_SEQ_ERR ? \"LinkSeq \" : \"\",\n\t\t  ehc->i.serror & SERR_TRANS_ST_ERROR ? \"TrStaTrns \" : \"\",\n\t\t  ehc->i.serror & SERR_UNRECOG_FIS ? \"UnrecFIS \" : \"\",\n\t\t  ehc->i.serror & SERR_DEV_XCHG ? \"DevExch \" : \"\");\n#endif\n\n\tata_qc_for_each_raw(ap, qc, tag) {\n\t\tstruct ata_taskfile *cmd = &qc->tf, *res = &qc->result_tf;\n\t\tchar data_buf[20] = \"\";\n\t\tchar cdb_buf[70] = \"\";\n\n\t\tif (!(qc->flags & ATA_QCFLAG_FAILED) ||\n\t\t    ata_dev_phys_link(qc->dev) != link || !qc->err_mask)\n\t\t\tcontinue;\n\n\t\tif (qc->dma_dir != DMA_NONE) {\n\t\t\tstatic const char *dma_str[] = {\n\t\t\t\t[DMA_BIDIRECTIONAL]\t= \"bidi\",\n\t\t\t\t[DMA_TO_DEVICE]\t\t= \"out\",\n\t\t\t\t[DMA_FROM_DEVICE]\t= \"in\",\n\t\t\t};\n\t\t\tconst char *prot_str = NULL;\n\n\t\t\tswitch (qc->tf.protocol) {\n\t\t\tcase ATA_PROT_UNKNOWN:\n\t\t\t\tprot_str = \"unknown\";\n\t\t\t\tbreak;\n\t\t\tcase ATA_PROT_NODATA:\n\t\t\t\tprot_str = \"nodata\";\n\t\t\t\tbreak;\n\t\t\tcase ATA_PROT_PIO:\n\t\t\t\tprot_str = \"pio\";\n\t\t\t\tbreak;\n\t\t\tcase ATA_PROT_DMA:\n\t\t\t\tprot_str = \"dma\";\n\t\t\t\tbreak;\n\t\t\tcase ATA_PROT_NCQ:\n\t\t\t\tprot_str = \"ncq dma\";\n\t\t\t\tbreak;\n\t\t\tcase ATA_PROT_NCQ_NODATA:\n\t\t\t\tprot_str = \"ncq nodata\";\n\t\t\t\tbreak;\n\t\t\tcase ATAPI_PROT_NODATA:\n\t\t\t\tprot_str = \"nodata\";\n\t\t\t\tbreak;\n\t\t\tcase ATAPI_PROT_PIO:\n\t\t\t\tprot_str = \"pio\";\n\t\t\t\tbreak;\n\t\t\tcase ATAPI_PROT_DMA:\n\t\t\t\tprot_str = \"dma\";\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tsnprintf(data_buf, sizeof(data_buf), \" %s %u %s\",\n\t\t\t\t prot_str, qc->nbytes, dma_str[qc->dma_dir]);\n\t\t}\n\n\t\tif (ata_is_atapi(qc->tf.protocol)) {\n\t\t\tconst u8 *cdb = qc->cdb;\n\t\t\tsize_t cdb_len = qc->dev->cdb_len;\n\n\t\t\tif (qc->scsicmd) {\n\t\t\t\tcdb = qc->scsicmd->cmnd;\n\t\t\t\tcdb_len = qc->scsicmd->cmd_len;\n\t\t\t}\n\t\t\t__scsi_format_command(cdb_buf, sizeof(cdb_buf),\n\t\t\t\t\t      cdb, cdb_len);\n\t\t} else {\n\t\t\tconst char *descr = ata_get_cmd_descript(cmd->command);\n\t\t\tif (descr)\n\t\t\t\tata_dev_err(qc->dev, \"failed command: %s\\n\",\n\t\t\t\t\t    descr);\n\t\t}\n\n\t\tata_dev_err(qc->dev,\n\t\t\t\"cmd %02x/%02x:%02x:%02x:%02x:%02x/%02x:%02x:%02x:%02x:%02x/%02x \"\n\t\t\t\"tag %d%s\\n         %s\"\n\t\t\t\"res %02x/%02x:%02x:%02x:%02x:%02x/%02x:%02x:%02x:%02x:%02x/%02x \"\n\t\t\t\"Emask 0x%x (%s)%s\\n\",\n\t\t\tcmd->command, cmd->feature, cmd->nsect,\n\t\t\tcmd->lbal, cmd->lbam, cmd->lbah,\n\t\t\tcmd->hob_feature, cmd->hob_nsect,\n\t\t\tcmd->hob_lbal, cmd->hob_lbam, cmd->hob_lbah,\n\t\t\tcmd->device, qc->tag, data_buf, cdb_buf,\n\t\t\tres->command, res->feature, res->nsect,\n\t\t\tres->lbal, res->lbam, res->lbah,\n\t\t\tres->hob_feature, res->hob_nsect,\n\t\t\tres->hob_lbal, res->hob_lbam, res->hob_lbah,\n\t\t\tres->device, qc->err_mask, ata_err_string(qc->err_mask),\n\t\t\tqc->err_mask & AC_ERR_NCQ ? \" <F>\" : \"\");\n\n#ifdef CONFIG_ATA_VERBOSE_ERROR\n\t\tif (res->command & (ATA_BUSY | ATA_DRDY | ATA_DF | ATA_DRQ |\n\t\t\t\t    ATA_SENSE | ATA_ERR)) {\n\t\t\tif (res->command & ATA_BUSY)\n\t\t\t\tata_dev_err(qc->dev, \"status: { Busy }\\n\");\n\t\t\telse\n\t\t\t\tata_dev_err(qc->dev, \"status: { %s%s%s%s%s}\\n\",\n\t\t\t\t  res->command & ATA_DRDY ? \"DRDY \" : \"\",\n\t\t\t\t  res->command & ATA_DF ? \"DF \" : \"\",\n\t\t\t\t  res->command & ATA_DRQ ? \"DRQ \" : \"\",\n\t\t\t\t  res->command & ATA_SENSE ? \"SENSE \" : \"\",\n\t\t\t\t  res->command & ATA_ERR ? \"ERR \" : \"\");\n\t\t}\n\n\t\tif (cmd->command != ATA_CMD_PACKET &&\n\t\t    (res->feature & (ATA_ICRC | ATA_UNC | ATA_AMNF |\n\t\t\t\t     ATA_IDNF | ATA_ABORTED)))\n\t\t\tata_dev_err(qc->dev, \"error: { %s%s%s%s%s}\\n\",\n\t\t\t  res->feature & ATA_ICRC ? \"ICRC \" : \"\",\n\t\t\t  res->feature & ATA_UNC ? \"UNC \" : \"\",\n\t\t\t  res->feature & ATA_AMNF ? \"AMNF \" : \"\",\n\t\t\t  res->feature & ATA_IDNF ? \"IDNF \" : \"\",\n\t\t\t  res->feature & ATA_ABORTED ? \"ABRT \" : \"\");\n#endif\n\t}\n}\n\n/**\n *\tata_eh_report - report error handling to user\n *\t@ap: ATA port to report EH about\n *\n *\tReport EH to user.\n *\n *\tLOCKING:\n *\tNone.\n */\nvoid ata_eh_report(struct ata_port *ap)\n{\n\tstruct ata_link *link;\n\n\tata_for_each_link(link, ap, HOST_FIRST)\n\t\tata_eh_link_report(link);\n}\n\nstatic int ata_do_reset(struct ata_link *link, ata_reset_fn_t reset,\n\t\t\tunsigned int *classes, unsigned long deadline,\n\t\t\tbool clear_classes)\n{\n\tstruct ata_device *dev;\n\n\tif (clear_classes)\n\t\tata_for_each_dev(dev, link, ALL)\n\t\t\tclasses[dev->devno] = ATA_DEV_UNKNOWN;\n\n\treturn reset(link, classes, deadline);\n}\n\nstatic int ata_eh_followup_srst_needed(struct ata_link *link, int rc)\n{\n\tif ((link->flags & ATA_LFLAG_NO_SRST) || ata_link_offline(link))\n\t\treturn 0;\n\tif (rc == -EAGAIN)\n\t\treturn 1;\n\tif (sata_pmp_supported(link->ap) && ata_is_host_link(link))\n\t\treturn 1;\n\treturn 0;\n}\n\nint ata_eh_reset(struct ata_link *link, int classify,\n\t\t ata_prereset_fn_t prereset, ata_reset_fn_t softreset,\n\t\t ata_reset_fn_t hardreset, ata_postreset_fn_t postreset)\n{\n\tstruct ata_port *ap = link->ap;\n\tstruct ata_link *slave = ap->slave_link;\n\tstruct ata_eh_context *ehc = &link->eh_context;\n\tstruct ata_eh_context *sehc = slave ? &slave->eh_context : NULL;\n\tunsigned int *classes = ehc->classes;\n\tunsigned int lflags = link->flags;\n\tint verbose = !(ehc->i.flags & ATA_EHI_QUIET);\n\tint max_tries = 0, try = 0;\n\tstruct ata_link *failed_link;\n\tstruct ata_device *dev;\n\tunsigned long deadline, now;\n\tata_reset_fn_t reset;\n\tunsigned long flags;\n\tu32 sstatus;\n\tint nr_unknown, rc;\n\n\t/*\n\t * Prepare to reset\n\t */\n\twhile (ata_eh_reset_timeouts[max_tries] != ULONG_MAX)\n\t\tmax_tries++;\n\tif (link->flags & ATA_LFLAG_RST_ONCE)\n\t\tmax_tries = 1;\n\tif (link->flags & ATA_LFLAG_NO_HRST)\n\t\thardreset = NULL;\n\tif (link->flags & ATA_LFLAG_NO_SRST)\n\t\tsoftreset = NULL;\n\n\t/* make sure each reset attempt is at least COOL_DOWN apart */\n\tif (ehc->i.flags & ATA_EHI_DID_RESET) {\n\t\tnow = jiffies;\n\t\tWARN_ON(time_after(ehc->last_reset, now));\n\t\tdeadline = ata_deadline(ehc->last_reset,\n\t\t\t\t\tATA_EH_RESET_COOL_DOWN);\n\t\tif (time_before(now, deadline))\n\t\t\tschedule_timeout_uninterruptible(deadline - now);\n\t}\n\n\tspin_lock_irqsave(ap->lock, flags);\n\tap->pflags |= ATA_PFLAG_RESETTING;\n\tspin_unlock_irqrestore(ap->lock, flags);\n\n\tata_eh_about_to_do(link, NULL, ATA_EH_RESET);\n\n\tata_for_each_dev(dev, link, ALL) {\n\t\t/* If we issue an SRST then an ATA drive (not ATAPI)\n\t\t * may change configuration and be in PIO0 timing. If\n\t\t * we do a hard reset (or are coming from power on)\n\t\t * this is true for ATA or ATAPI. Until we've set a\n\t\t * suitable controller mode we should not touch the\n\t\t * bus as we may be talking too fast.\n\t\t */\n\t\tdev->pio_mode = XFER_PIO_0;\n\t\tdev->dma_mode = 0xff;\n\n\t\t/* If the controller has a pio mode setup function\n\t\t * then use it to set the chipset to rights. Don't\n\t\t * touch the DMA setup as that will be dealt with when\n\t\t * configuring devices.\n\t\t */\n\t\tif (ap->ops->set_piomode)\n\t\t\tap->ops->set_piomode(ap, dev);\n\t}\n\n\t/* prefer hardreset */\n\treset = NULL;\n\tehc->i.action &= ~ATA_EH_RESET;\n\tif (hardreset) {\n\t\treset = hardreset;\n\t\tehc->i.action |= ATA_EH_HARDRESET;\n\t} else if (softreset) {\n\t\treset = softreset;\n\t\tehc->i.action |= ATA_EH_SOFTRESET;\n\t}\n\n\tif (prereset) {\n\t\tunsigned long deadline = ata_deadline(jiffies,\n\t\t\t\t\t\t      ATA_EH_PRERESET_TIMEOUT);\n\n\t\tif (slave) {\n\t\t\tsehc->i.action &= ~ATA_EH_RESET;\n\t\t\tsehc->i.action |= ehc->i.action;\n\t\t}\n\n\t\trc = prereset(link, deadline);\n\n\t\t/* If present, do prereset on slave link too.  Reset\n\t\t * is skipped iff both master and slave links report\n\t\t * -ENOENT or clear ATA_EH_RESET.\n\t\t */\n\t\tif (slave && (rc == 0 || rc == -ENOENT)) {\n\t\t\tint tmp;\n\n\t\t\ttmp = prereset(slave, deadline);\n\t\t\tif (tmp != -ENOENT)\n\t\t\t\trc = tmp;\n\n\t\t\tehc->i.action |= sehc->i.action;\n\t\t}\n\n\t\tif (rc) {\n\t\t\tif (rc == -ENOENT) {\n\t\t\t\tata_link_dbg(link, \"port disabled--ignoring\\n\");\n\t\t\t\tehc->i.action &= ~ATA_EH_RESET;\n\n\t\t\t\tata_for_each_dev(dev, link, ALL)\n\t\t\t\t\tclasses[dev->devno] = ATA_DEV_NONE;\n\n\t\t\t\trc = 0;\n\t\t\t} else\n\t\t\t\tata_link_err(link,\n\t\t\t\t\t     \"prereset failed (errno=%d)\\n\",\n\t\t\t\t\t     rc);\n\t\t\tgoto out;\n\t\t}\n\n\t\t/* prereset() might have cleared ATA_EH_RESET.  If so,\n\t\t * bang classes, thaw and return.\n\t\t */\n\t\tif (reset && !(ehc->i.action & ATA_EH_RESET)) {\n\t\t\tata_for_each_dev(dev, link, ALL)\n\t\t\t\tclasses[dev->devno] = ATA_DEV_NONE;\n\t\t\tif ((ap->pflags & ATA_PFLAG_FROZEN) &&\n\t\t\t    ata_is_host_link(link))\n\t\t\t\tata_eh_thaw_port(ap);\n\t\t\trc = 0;\n\t\t\tgoto out;\n\t\t}\n\t}\n\n retry:\n\t/*\n\t * Perform reset\n\t */\n\tif (ata_is_host_link(link))\n\t\tata_eh_freeze_port(ap);\n\n\tdeadline = ata_deadline(jiffies, ata_eh_reset_timeouts[try++]);\n\n\tif (reset) {\n\t\tif (verbose)\n\t\t\tata_link_info(link, \"%s resetting link\\n\",\n\t\t\t\t      reset == softreset ? \"soft\" : \"hard\");\n\n\t\t/* mark that this EH session started with reset */\n\t\tehc->last_reset = jiffies;\n\t\tif (reset == hardreset)\n\t\t\tehc->i.flags |= ATA_EHI_DID_HARDRESET;\n\t\telse\n\t\t\tehc->i.flags |= ATA_EHI_DID_SOFTRESET;\n\n\t\trc = ata_do_reset(link, reset, classes, deadline, true);\n\t\tif (rc && rc != -EAGAIN) {\n\t\t\tfailed_link = link;\n\t\t\tgoto fail;\n\t\t}\n\n\t\t/* hardreset slave link if existent */\n\t\tif (slave && reset == hardreset) {\n\t\t\tint tmp;\n\n\t\t\tif (verbose)\n\t\t\t\tata_link_info(slave, \"hard resetting link\\n\");\n\n\t\t\tata_eh_about_to_do(slave, NULL, ATA_EH_RESET);\n\t\t\ttmp = ata_do_reset(slave, reset, classes, deadline,\n\t\t\t\t\t   false);\n\t\t\tswitch (tmp) {\n\t\t\tcase -EAGAIN:\n\t\t\t\trc = -EAGAIN;\n\t\t\tcase 0:\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tfailed_link = slave;\n\t\t\t\trc = tmp;\n\t\t\t\tgoto fail;\n\t\t\t}\n\t\t}\n\n\t\t/* perform follow-up SRST if necessary */\n\t\tif (reset == hardreset &&\n\t\t    ata_eh_followup_srst_needed(link, rc)) {\n\t\t\treset = softreset;\n\n\t\t\tif (!reset) {\n\t\t\t\tata_link_err(link,\n\t     \"follow-up softreset required but no softreset available\\n\");\n\t\t\t\tfailed_link = link;\n\t\t\t\trc = -EINVAL;\n\t\t\t\tgoto fail;\n\t\t\t}\n\n\t\t\tata_eh_about_to_do(link, NULL, ATA_EH_RESET);\n\t\t\trc = ata_do_reset(link, reset, classes, deadline, true);\n\t\t\tif (rc) {\n\t\t\t\tfailed_link = link;\n\t\t\t\tgoto fail;\n\t\t\t}\n\t\t}\n\t} else {\n\t\tif (verbose)\n\t\t\tata_link_info(link,\n\t\"no reset method available, skipping reset\\n\");\n\t\tif (!(lflags & ATA_LFLAG_ASSUME_CLASS))\n\t\t\tlflags |= ATA_LFLAG_ASSUME_ATA;\n\t}\n\n\t/*\n\t * Post-reset processing\n\t */\n\tata_for_each_dev(dev, link, ALL) {\n\t\t/* After the reset, the device state is PIO 0 and the\n\t\t * controller state is undefined.  Reset also wakes up\n\t\t * drives from sleeping mode.\n\t\t */\n\t\tdev->pio_mode = XFER_PIO_0;\n\t\tdev->flags &= ~ATA_DFLAG_SLEEPING;\n\n\t\tif (ata_phys_link_offline(ata_dev_phys_link(dev)))\n\t\t\tcontinue;\n\n\t\t/* apply class override */\n\t\tif (lflags & ATA_LFLAG_ASSUME_ATA)\n\t\t\tclasses[dev->devno] = ATA_DEV_ATA;\n\t\telse if (lflags & ATA_LFLAG_ASSUME_SEMB)\n\t\t\tclasses[dev->devno] = ATA_DEV_SEMB_UNSUP;\n\t}\n\n\t/* record current link speed */\n\tif (sata_scr_read(link, SCR_STATUS, &sstatus) == 0)\n\t\tlink->sata_spd = (sstatus >> 4) & 0xf;\n\tif (slave && sata_scr_read(slave, SCR_STATUS, &sstatus) == 0)\n\t\tslave->sata_spd = (sstatus >> 4) & 0xf;\n\n\t/* thaw the port */\n\tif (ata_is_host_link(link))\n\t\tata_eh_thaw_port(ap);\n\n\t/* postreset() should clear hardware SError.  Although SError\n\t * is cleared during link resume, clearing SError here is\n\t * necessary as some PHYs raise hotplug events after SRST.\n\t * This introduces race condition where hotplug occurs between\n\t * reset and here.  This race is mediated by cross checking\n\t * link onlineness and classification result later.\n\t */\n\tif (postreset) {\n\t\tpostreset(link, classes);\n\t\tif (slave)\n\t\t\tpostreset(slave, classes);\n\t}\n\n\t/*\n\t * Some controllers can't be frozen very well and may set spurious\n\t * error conditions during reset.  Clear accumulated error\n\t * information and re-thaw the port if frozen.  As reset is the\n\t * final recovery action and we cross check link onlineness against\n\t * device classification later, no hotplug event is lost by this.\n\t */\n\tspin_lock_irqsave(link->ap->lock, flags);\n\tmemset(&link->eh_info, 0, sizeof(link->eh_info));\n\tif (slave)\n\t\tmemset(&slave->eh_info, 0, sizeof(link->eh_info));\n\tap->pflags &= ~ATA_PFLAG_EH_PENDING;\n\tspin_unlock_irqrestore(link->ap->lock, flags);\n\n\tif (ap->pflags & ATA_PFLAG_FROZEN)\n\t\tata_eh_thaw_port(ap);\n\n\t/*\n\t * Make sure onlineness and classification result correspond.\n\t * Hotplug could have happened during reset and some\n\t * controllers fail to wait while a drive is spinning up after\n\t * being hotplugged causing misdetection.  By cross checking\n\t * link on/offlineness and classification result, those\n\t * conditions can be reliably detected and retried.\n\t */\n\tnr_unknown = 0;\n\tata_for_each_dev(dev, link, ALL) {\n\t\tif (ata_phys_link_online(ata_dev_phys_link(dev))) {\n\t\t\tif (classes[dev->devno] == ATA_DEV_UNKNOWN) {\n\t\t\t\tata_dev_dbg(dev, \"link online but device misclassified\\n\");\n\t\t\t\tclasses[dev->devno] = ATA_DEV_NONE;\n\t\t\t\tnr_unknown++;\n\t\t\t}\n\t\t} else if (ata_phys_link_offline(ata_dev_phys_link(dev))) {\n\t\t\tif (ata_class_enabled(classes[dev->devno]))\n\t\t\t\tata_dev_dbg(dev,\n\t\t\t\t\t    \"link offline, clearing class %d to NONE\\n\",\n\t\t\t\t\t    classes[dev->devno]);\n\t\t\tclasses[dev->devno] = ATA_DEV_NONE;\n\t\t} else if (classes[dev->devno] == ATA_DEV_UNKNOWN) {\n\t\t\tata_dev_dbg(dev,\n\t\t\t\t    \"link status unknown, clearing UNKNOWN to NONE\\n\");\n\t\t\tclasses[dev->devno] = ATA_DEV_NONE;\n\t\t}\n\t}\n\n\tif (classify && nr_unknown) {\n\t\tif (try < max_tries) {\n\t\t\tata_link_warn(link,\n\t\t\t\t      \"link online but %d devices misclassified, retrying\\n\",\n\t\t\t\t      nr_unknown);\n\t\t\tfailed_link = link;\n\t\t\trc = -EAGAIN;\n\t\t\tgoto fail;\n\t\t}\n\t\tata_link_warn(link,\n\t\t\t      \"link online but %d devices misclassified, \"\n\t\t\t      \"device detection might fail\\n\", nr_unknown);\n\t}\n\n\t/* reset successful, schedule revalidation */\n\tata_eh_done(link, NULL, ATA_EH_RESET);\n\tif (slave)\n\t\tata_eh_done(slave, NULL, ATA_EH_RESET);\n\tehc->last_reset = jiffies;\t\t/* update to completion time */\n\tehc->i.action |= ATA_EH_REVALIDATE;\n\tlink->lpm_policy = ATA_LPM_UNKNOWN;\t/* reset LPM state */\n\n\trc = 0;\n out:\n\t/* clear hotplug flag */\n\tehc->i.flags &= ~ATA_EHI_HOTPLUGGED;\n\tif (slave)\n\t\tsehc->i.flags &= ~ATA_EHI_HOTPLUGGED;\n\n\tspin_lock_irqsave(ap->lock, flags);\n\tap->pflags &= ~ATA_PFLAG_RESETTING;\n\tspin_unlock_irqrestore(ap->lock, flags);\n\n\treturn rc;\n\n fail:\n\t/* if SCR isn't accessible on a fan-out port, PMP needs to be reset */\n\tif (!ata_is_host_link(link) &&\n\t    sata_scr_read(link, SCR_STATUS, &sstatus))\n\t\trc = -ERESTART;\n\n\tif (try >= max_tries) {\n\t\t/*\n\t\t * Thaw host port even if reset failed, so that the port\n\t\t * can be retried on the next phy event.  This risks\n\t\t * repeated EH runs but seems to be a better tradeoff than\n\t\t * shutting down a port after a botched hotplug attempt.\n\t\t */\n\t\tif (ata_is_host_link(link))\n\t\t\tata_eh_thaw_port(ap);\n\t\tgoto out;\n\t}\n\n\tnow = jiffies;\n\tif (time_before(now, deadline)) {\n\t\tunsigned long delta = deadline - now;\n\n\t\tata_link_warn(failed_link,\n\t\t\t\"reset failed (errno=%d), retrying in %u secs\\n\",\n\t\t\trc, DIV_ROUND_UP(jiffies_to_msecs(delta), 1000));\n\n\t\tata_eh_release(ap);\n\t\twhile (delta)\n\t\t\tdelta = schedule_timeout_uninterruptible(delta);\n\t\tata_eh_acquire(ap);\n\t}\n\n\t/*\n\t * While disks spinup behind PMP, some controllers fail sending SRST.\n\t * They need to be reset - as well as the PMP - before retrying.\n\t */\n\tif (rc == -ERESTART) {\n\t\tif (ata_is_host_link(link))\n\t\t\tata_eh_thaw_port(ap);\n\t\tgoto out;\n\t}\n\n\tif (try == max_tries - 1) {\n\t\tsata_down_spd_limit(link, 0);\n\t\tif (slave)\n\t\t\tsata_down_spd_limit(slave, 0);\n\t} else if (rc == -EPIPE)\n\t\tsata_down_spd_limit(failed_link, 0);\n\n\tif (hardreset)\n\t\treset = hardreset;\n\tgoto retry;\n}\n\nstatic inline void ata_eh_pull_park_action(struct ata_port *ap)\n{\n\tstruct ata_link *link;\n\tstruct ata_device *dev;\n\tunsigned long flags;\n\n\t/*\n\t * This function can be thought of as an extended version of\n\t * ata_eh_about_to_do() specially crafted to accommodate the\n\t * requirements of ATA_EH_PARK handling. Since the EH thread\n\t * does not leave the do {} while () loop in ata_eh_recover as\n\t * long as the timeout for a park request to *one* device on\n\t * the port has not expired, and since we still want to pick\n\t * up park requests to other devices on the same port or\n\t * timeout updates for the same device, we have to pull\n\t * ATA_EH_PARK actions from eh_info into eh_context.i\n\t * ourselves at the beginning of each pass over the loop.\n\t *\n\t * Additionally, all write accesses to &ap->park_req_pending\n\t * through reinit_completion() (see below) or complete_all()\n\t * (see ata_scsi_park_store()) are protected by the host lock.\n\t * As a result we have that park_req_pending.done is zero on\n\t * exit from this function, i.e. when ATA_EH_PARK actions for\n\t * *all* devices on port ap have been pulled into the\n\t * respective eh_context structs. If, and only if,\n\t * park_req_pending.done is non-zero by the time we reach\n\t * wait_for_completion_timeout(), another ATA_EH_PARK action\n\t * has been scheduled for at least one of the devices on port\n\t * ap and we have to cycle over the do {} while () loop in\n\t * ata_eh_recover() again.\n\t */\n\n\tspin_lock_irqsave(ap->lock, flags);\n\treinit_completion(&ap->park_req_pending);\n\tata_for_each_link(link, ap, EDGE) {\n\t\tata_for_each_dev(dev, link, ALL) {\n\t\t\tstruct ata_eh_info *ehi = &link->eh_info;\n\n\t\t\tlink->eh_context.i.dev_action[dev->devno] |=\n\t\t\t\tehi->dev_action[dev->devno] & ATA_EH_PARK;\n\t\t\tata_eh_clear_action(link, dev, ehi, ATA_EH_PARK);\n\t\t}\n\t}\n\tspin_unlock_irqrestore(ap->lock, flags);\n}\n\nstatic void ata_eh_park_issue_cmd(struct ata_device *dev, int park)\n{\n\tstruct ata_eh_context *ehc = &dev->link->eh_context;\n\tstruct ata_taskfile tf;\n\tunsigned int err_mask;\n\n\tata_tf_init(dev, &tf);\n\tif (park) {\n\t\tehc->unloaded_mask |= 1 << dev->devno;\n\t\ttf.command = ATA_CMD_IDLEIMMEDIATE;\n\t\ttf.feature = 0x44;\n\t\ttf.lbal = 0x4c;\n\t\ttf.lbam = 0x4e;\n\t\ttf.lbah = 0x55;\n\t} else {\n\t\tehc->unloaded_mask &= ~(1 << dev->devno);\n\t\ttf.command = ATA_CMD_CHK_POWER;\n\t}\n\n\ttf.flags |= ATA_TFLAG_DEVICE | ATA_TFLAG_ISADDR;\n\ttf.protocol = ATA_PROT_NODATA;\n\terr_mask = ata_exec_internal(dev, &tf, NULL, DMA_NONE, NULL, 0, 0);\n\tif (park && (err_mask || tf.lbal != 0xc4)) {\n\t\tata_dev_err(dev, \"head unload failed!\\n\");\n\t\tehc->unloaded_mask &= ~(1 << dev->devno);\n\t}\n}\n\nstatic int ata_eh_revalidate_and_attach(struct ata_link *link,\n\t\t\t\t\tstruct ata_device **r_failed_dev)\n{\n\tstruct ata_port *ap = link->ap;\n\tstruct ata_eh_context *ehc = &link->eh_context;\n\tstruct ata_device *dev;\n\tunsigned int new_mask = 0;\n\tunsigned long flags;\n\tint rc = 0;\n\n\tDPRINTK(\"ENTER\\n\");\n\n\t/* For PATA drive side cable detection to work, IDENTIFY must\n\t * be done backwards such that PDIAG- is released by the slave\n\t * device before the master device is identified.\n\t */\n\tata_for_each_dev(dev, link, ALL_REVERSE) {\n\t\tunsigned int action = ata_eh_dev_action(dev);\n\t\tunsigned int readid_flags = 0;\n\n\t\tif (ehc->i.flags & ATA_EHI_DID_RESET)\n\t\t\treadid_flags |= ATA_READID_POSTRESET;\n\n\t\tif ((action & ATA_EH_REVALIDATE) && ata_dev_enabled(dev)) {\n\t\t\tWARN_ON(dev->class == ATA_DEV_PMP);\n\n\t\t\tif (ata_phys_link_offline(ata_dev_phys_link(dev))) {\n\t\t\t\trc = -EIO;\n\t\t\t\tgoto err;\n\t\t\t}\n\n\t\t\tata_eh_about_to_do(link, dev, ATA_EH_REVALIDATE);\n\t\t\trc = ata_dev_revalidate(dev, ehc->classes[dev->devno],\n\t\t\t\t\t\treadid_flags);\n\t\t\tif (rc)\n\t\t\t\tgoto err;\n\n\t\t\tata_eh_done(link, dev, ATA_EH_REVALIDATE);\n\n\t\t\t/* Configuration may have changed, reconfigure\n\t\t\t * transfer mode.\n\t\t\t */\n\t\t\tehc->i.flags |= ATA_EHI_SETMODE;\n\n\t\t\t/* schedule the scsi_rescan_device() here */\n\t\t\tschedule_work(&(ap->scsi_rescan_task));\n\t\t} else if (dev->class == ATA_DEV_UNKNOWN &&\n\t\t\t   ehc->tries[dev->devno] &&\n\t\t\t   ata_class_enabled(ehc->classes[dev->devno])) {\n\t\t\t/* Temporarily set dev->class, it will be\n\t\t\t * permanently set once all configurations are\n\t\t\t * complete.  This is necessary because new\n\t\t\t * device configuration is done in two\n\t\t\t * separate loops.\n\t\t\t */\n\t\t\tdev->class = ehc->classes[dev->devno];\n\n\t\t\tif (dev->class == ATA_DEV_PMP)\n\t\t\t\trc = sata_pmp_attach(dev);\n\t\t\telse\n\t\t\t\trc = ata_dev_read_id(dev, &dev->class,\n\t\t\t\t\t\t     readid_flags, dev->id);\n\n\t\t\t/* read_id might have changed class, store and reset */\n\t\t\tehc->classes[dev->devno] = dev->class;\n\t\t\tdev->class = ATA_DEV_UNKNOWN;\n\n\t\t\tswitch (rc) {\n\t\t\tcase 0:\n\t\t\t\t/* clear error info accumulated during probe */\n\t\t\t\tata_ering_clear(&dev->ering);\n\t\t\t\tnew_mask |= 1 << dev->devno;\n\t\t\t\tbreak;\n\t\t\tcase -ENOENT:\n\t\t\t\t/* IDENTIFY was issued to non-existent\n\t\t\t\t * device.  No need to reset.  Just\n\t\t\t\t * thaw and ignore the device.\n\t\t\t\t */\n\t\t\t\tata_eh_thaw_port(ap);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tgoto err;\n\t\t\t}\n\t\t}\n\t}\n\n\t/* PDIAG- should have been released, ask cable type if post-reset */\n\tif ((ehc->i.flags & ATA_EHI_DID_RESET) && ata_is_host_link(link)) {\n\t\tif (ap->ops->cable_detect)\n\t\t\tap->cbl = ap->ops->cable_detect(ap);\n\t\tata_force_cbl(ap);\n\t}\n\n\t/* Configure new devices forward such that user doesn't see\n\t * device detection messages backwards.\n\t */\n\tata_for_each_dev(dev, link, ALL) {\n\t\tif (!(new_mask & (1 << dev->devno)))\n\t\t\tcontinue;\n\n\t\tdev->class = ehc->classes[dev->devno];\n\n\t\tif (dev->class == ATA_DEV_PMP)\n\t\t\tcontinue;\n\n\t\tehc->i.flags |= ATA_EHI_PRINTINFO;\n\t\trc = ata_dev_configure(dev);\n\t\tehc->i.flags &= ~ATA_EHI_PRINTINFO;\n\t\tif (rc) {\n\t\t\tdev->class = ATA_DEV_UNKNOWN;\n\t\t\tgoto err;\n\t\t}\n\n\t\tspin_lock_irqsave(ap->lock, flags);\n\t\tap->pflags |= ATA_PFLAG_SCSI_HOTPLUG;\n\t\tspin_unlock_irqrestore(ap->lock, flags);\n\n\t\t/* new device discovered, configure xfermode */\n\t\tehc->i.flags |= ATA_EHI_SETMODE;\n\t}\n\n\treturn 0;\n\n err:\n\t*r_failed_dev = dev;\n\tDPRINTK(\"EXIT rc=%d\\n\", rc);\n\treturn rc;\n}\n\n/**\n *\tata_set_mode - Program timings and issue SET FEATURES - XFER\n *\t@link: link on which timings will be programmed\n *\t@r_failed_dev: out parameter for failed device\n *\n *\tSet ATA device disk transfer mode (PIO3, UDMA6, etc.).  If\n *\tata_set_mode() fails, pointer to the failing device is\n *\treturned in @r_failed_dev.\n *\n *\tLOCKING:\n *\tPCI/etc. bus probe sem.\n *\n *\tRETURNS:\n *\t0 on success, negative errno otherwise\n */\nint ata_set_mode(struct ata_link *link, struct ata_device **r_failed_dev)\n{\n\tstruct ata_port *ap = link->ap;\n\tstruct ata_device *dev;\n\tint rc;\n\n\t/* if data transfer is verified, clear DUBIOUS_XFER on ering top */\n\tata_for_each_dev(dev, link, ENABLED) {\n\t\tif (!(dev->flags & ATA_DFLAG_DUBIOUS_XFER)) {\n\t\t\tstruct ata_ering_entry *ent;\n\n\t\t\tent = ata_ering_top(&dev->ering);\n\t\t\tif (ent)\n\t\t\t\tent->eflags &= ~ATA_EFLAG_DUBIOUS_XFER;\n\t\t}\n\t}\n\n\t/* has private set_mode? */\n\tif (ap->ops->set_mode)\n\t\trc = ap->ops->set_mode(link, r_failed_dev);\n\telse\n\t\trc = ata_do_set_mode(link, r_failed_dev);\n\n\t/* if transfer mode has changed, set DUBIOUS_XFER on device */\n\tata_for_each_dev(dev, link, ENABLED) {\n\t\tstruct ata_eh_context *ehc = &link->eh_context;\n\t\tu8 saved_xfer_mode = ehc->saved_xfer_mode[dev->devno];\n\t\tu8 saved_ncq = !!(ehc->saved_ncq_enabled & (1 << dev->devno));\n\n\t\tif (dev->xfer_mode != saved_xfer_mode ||\n\t\t    ata_ncq_enabled(dev) != saved_ncq)\n\t\t\tdev->flags |= ATA_DFLAG_DUBIOUS_XFER;\n\t}\n\n\treturn rc;\n}\n\n/**\n *\tatapi_eh_clear_ua - Clear ATAPI UNIT ATTENTION after reset\n *\t@dev: ATAPI device to clear UA for\n *\n *\tResets and other operations can make an ATAPI device raise\n *\tUNIT ATTENTION which causes the next operation to fail.  This\n *\tfunction clears UA.\n *\n *\tLOCKING:\n *\tEH context (may sleep).\n *\n *\tRETURNS:\n *\t0 on success, -errno on failure.\n */\nstatic int atapi_eh_clear_ua(struct ata_device *dev)\n{\n\tint i;\n\n\tfor (i = 0; i < ATA_EH_UA_TRIES; i++) {\n\t\tu8 *sense_buffer = dev->link->ap->sector_buf;\n\t\tu8 sense_key = 0;\n\t\tunsigned int err_mask;\n\n\t\terr_mask = atapi_eh_tur(dev, &sense_key);\n\t\tif (err_mask != 0 && err_mask != AC_ERR_DEV) {\n\t\t\tata_dev_warn(dev,\n\t\t\t\t     \"TEST_UNIT_READY failed (err_mask=0x%x)\\n\",\n\t\t\t\t     err_mask);\n\t\t\treturn -EIO;\n\t\t}\n\n\t\tif (!err_mask || sense_key != UNIT_ATTENTION)\n\t\t\treturn 0;\n\n\t\terr_mask = atapi_eh_request_sense(dev, sense_buffer, sense_key);\n\t\tif (err_mask) {\n\t\t\tata_dev_warn(dev, \"failed to clear \"\n\t\t\t\t\"UNIT ATTENTION (err_mask=0x%x)\\n\", err_mask);\n\t\t\treturn -EIO;\n\t\t}\n\t}\n\n\tata_dev_warn(dev, \"UNIT ATTENTION persists after %d tries\\n\",\n\t\t     ATA_EH_UA_TRIES);\n\n\treturn 0;\n}\n\n/**\n *\tata_eh_maybe_retry_flush - Retry FLUSH if necessary\n *\t@dev: ATA device which may need FLUSH retry\n *\n *\tIf @dev failed FLUSH, it needs to be reported upper layer\n *\timmediately as it means that @dev failed to remap and already\n *\tlost at least a sector and further FLUSH retrials won't make\n *\tany difference to the lost sector.  However, if FLUSH failed\n *\tfor other reasons, for example transmission error, FLUSH needs\n *\tto be retried.\n *\n *\tThis function determines whether FLUSH failure retry is\n *\tnecessary and performs it if so.\n *\n *\tRETURNS:\n *\t0 if EH can continue, -errno if EH needs to be repeated.\n */\nstatic int ata_eh_maybe_retry_flush(struct ata_device *dev)\n{\n\tstruct ata_link *link = dev->link;\n\tstruct ata_port *ap = link->ap;\n\tstruct ata_queued_cmd *qc;\n\tstruct ata_taskfile tf;\n\tunsigned int err_mask;\n\tint rc = 0;\n\n\t/* did flush fail for this device? */\n\tif (!ata_tag_valid(link->active_tag))\n\t\treturn 0;\n\n\tqc = __ata_qc_from_tag(ap, link->active_tag);\n\tif (qc->dev != dev || (qc->tf.command != ATA_CMD_FLUSH_EXT &&\n\t\t\t       qc->tf.command != ATA_CMD_FLUSH))\n\t\treturn 0;\n\n\t/* if the device failed it, it should be reported to upper layers */\n\tif (qc->err_mask & AC_ERR_DEV)\n\t\treturn 0;\n\n\t/* flush failed for some other reason, give it another shot */\n\tata_tf_init(dev, &tf);\n\n\ttf.command = qc->tf.command;\n\ttf.flags |= ATA_TFLAG_DEVICE;\n\ttf.protocol = ATA_PROT_NODATA;\n\n\tata_dev_warn(dev, \"retrying FLUSH 0x%x Emask 0x%x\\n\",\n\t\t       tf.command, qc->err_mask);\n\n\terr_mask = ata_exec_internal(dev, &tf, NULL, DMA_NONE, NULL, 0, 0);\n\tif (!err_mask) {\n\t\t/*\n\t\t * FLUSH is complete but there's no way to\n\t\t * successfully complete a failed command from EH.\n\t\t * Making sure retry is allowed at least once and\n\t\t * retrying it should do the trick - whatever was in\n\t\t * the cache is already on the platter and this won't\n\t\t * cause infinite loop.\n\t\t */\n\t\tqc->scsicmd->allowed = max(qc->scsicmd->allowed, 1);\n\t} else {\n\t\tata_dev_warn(dev, \"FLUSH failed Emask 0x%x\\n\",\n\t\t\t       err_mask);\n\t\trc = -EIO;\n\n\t\t/* if device failed it, report it to upper layers */\n\t\tif (err_mask & AC_ERR_DEV) {\n\t\t\tqc->err_mask |= AC_ERR_DEV;\n\t\t\tqc->result_tf = tf;\n\t\t\tif (!(ap->pflags & ATA_PFLAG_FROZEN))\n\t\t\t\trc = 0;\n\t\t}\n\t}\n\treturn rc;\n}\n\n/**\n *\tata_eh_set_lpm - configure SATA interface power management\n *\t@link: link to configure power management\n *\t@policy: the link power management policy\n *\t@r_failed_dev: out parameter for failed device\n *\n *\tEnable SATA Interface power management.  This will enable\n *\tDevice Interface Power Management (DIPM) for min_power and\n *\tmedium_power_with_dipm policies, and then call driver specific\n *\tcallbacks for enabling Host Initiated Power management.\n *\n *\tLOCKING:\n *\tEH context.\n *\n *\tRETURNS:\n *\t0 on success, -errno on failure.\n */\nstatic int ata_eh_set_lpm(struct ata_link *link, enum ata_lpm_policy policy,\n\t\t\t  struct ata_device **r_failed_dev)\n{\n\tstruct ata_port *ap = ata_is_host_link(link) ? link->ap : NULL;\n\tstruct ata_eh_context *ehc = &link->eh_context;\n\tstruct ata_device *dev, *link_dev = NULL, *lpm_dev = NULL;\n\tenum ata_lpm_policy old_policy = link->lpm_policy;\n\tbool no_dipm = link->ap->flags & ATA_FLAG_NO_DIPM;\n\tunsigned int hints = ATA_LPM_EMPTY | ATA_LPM_HIPM;\n\tunsigned int err_mask;\n\tint rc;\n\n\t/* if the link or host doesn't do LPM, noop */\n\tif (!IS_ENABLED(CONFIG_SATA_HOST) ||\n\t    (link->flags & ATA_LFLAG_NO_LPM) || (ap && !ap->ops->set_lpm))\n\t\treturn 0;\n\n\t/*\n\t * DIPM is enabled only for MIN_POWER as some devices\n\t * misbehave when the host NACKs transition to SLUMBER.  Order\n\t * device and link configurations such that the host always\n\t * allows DIPM requests.\n\t */\n\tata_for_each_dev(dev, link, ENABLED) {\n\t\tbool hipm = ata_id_has_hipm(dev->id);\n\t\tbool dipm = ata_id_has_dipm(dev->id) && !no_dipm;\n\n\t\t/* find the first enabled and LPM enabled devices */\n\t\tif (!link_dev)\n\t\t\tlink_dev = dev;\n\n\t\tif (!lpm_dev && (hipm || dipm))\n\t\t\tlpm_dev = dev;\n\n\t\thints &= ~ATA_LPM_EMPTY;\n\t\tif (!hipm)\n\t\t\thints &= ~ATA_LPM_HIPM;\n\n\t\t/* disable DIPM before changing link config */\n\t\tif (policy < ATA_LPM_MED_POWER_WITH_DIPM && dipm) {\n\t\t\terr_mask = ata_dev_set_feature(dev,\n\t\t\t\t\tSETFEATURES_SATA_DISABLE, SATA_DIPM);\n\t\t\tif (err_mask && err_mask != AC_ERR_DEV) {\n\t\t\t\tata_dev_warn(dev,\n\t\t\t\t\t     \"failed to disable DIPM, Emask 0x%x\\n\",\n\t\t\t\t\t     err_mask);\n\t\t\t\trc = -EIO;\n\t\t\t\tgoto fail;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (ap) {\n\t\trc = ap->ops->set_lpm(link, policy, hints);\n\t\tif (!rc && ap->slave_link)\n\t\t\trc = ap->ops->set_lpm(ap->slave_link, policy, hints);\n\t} else\n\t\trc = sata_pmp_set_lpm(link, policy, hints);\n\n\t/*\n\t * Attribute link config failure to the first (LPM) enabled\n\t * device on the link.\n\t */\n\tif (rc) {\n\t\tif (rc == -EOPNOTSUPP) {\n\t\t\tlink->flags |= ATA_LFLAG_NO_LPM;\n\t\t\treturn 0;\n\t\t}\n\t\tdev = lpm_dev ? lpm_dev : link_dev;\n\t\tgoto fail;\n\t}\n\n\t/*\n\t * Low level driver acked the transition.  Issue DIPM command\n\t * with the new policy set.\n\t */\n\tlink->lpm_policy = policy;\n\tif (ap && ap->slave_link)\n\t\tap->slave_link->lpm_policy = policy;\n\n\t/* host config updated, enable DIPM if transitioning to MIN_POWER */\n\tata_for_each_dev(dev, link, ENABLED) {\n\t\tif (policy >= ATA_LPM_MED_POWER_WITH_DIPM && !no_dipm &&\n\t\t    ata_id_has_dipm(dev->id)) {\n\t\t\terr_mask = ata_dev_set_feature(dev,\n\t\t\t\t\tSETFEATURES_SATA_ENABLE, SATA_DIPM);\n\t\t\tif (err_mask && err_mask != AC_ERR_DEV) {\n\t\t\t\tata_dev_warn(dev,\n\t\t\t\t\t\"failed to enable DIPM, Emask 0x%x\\n\",\n\t\t\t\t\terr_mask);\n\t\t\t\trc = -EIO;\n\t\t\t\tgoto fail;\n\t\t\t}\n\t\t}\n\t}\n\n\tlink->last_lpm_change = jiffies;\n\tlink->flags |= ATA_LFLAG_CHANGED;\n\n\treturn 0;\n\nfail:\n\t/* restore the old policy */\n\tlink->lpm_policy = old_policy;\n\tif (ap && ap->slave_link)\n\t\tap->slave_link->lpm_policy = old_policy;\n\n\t/* if no device or only one more chance is left, disable LPM */\n\tif (!dev || ehc->tries[dev->devno] <= 2) {\n\t\tata_link_warn(link, \"disabling LPM on the link\\n\");\n\t\tlink->flags |= ATA_LFLAG_NO_LPM;\n\t}\n\tif (r_failed_dev)\n\t\t*r_failed_dev = dev;\n\treturn rc;\n}\n\nint ata_link_nr_enabled(struct ata_link *link)\n{\n\tstruct ata_device *dev;\n\tint cnt = 0;\n\n\tata_for_each_dev(dev, link, ENABLED)\n\t\tcnt++;\n\treturn cnt;\n}\n\nstatic int ata_link_nr_vacant(struct ata_link *link)\n{\n\tstruct ata_device *dev;\n\tint cnt = 0;\n\n\tata_for_each_dev(dev, link, ALL)\n\t\tif (dev->class == ATA_DEV_UNKNOWN)\n\t\t\tcnt++;\n\treturn cnt;\n}\n\nstatic int ata_eh_skip_recovery(struct ata_link *link)\n{\n\tstruct ata_port *ap = link->ap;\n\tstruct ata_eh_context *ehc = &link->eh_context;\n\tstruct ata_device *dev;\n\n\t/* skip disabled links */\n\tif (link->flags & ATA_LFLAG_DISABLED)\n\t\treturn 1;\n\n\t/* skip if explicitly requested */\n\tif (ehc->i.flags & ATA_EHI_NO_RECOVERY)\n\t\treturn 1;\n\n\t/* thaw frozen port and recover failed devices */\n\tif ((ap->pflags & ATA_PFLAG_FROZEN) || ata_link_nr_enabled(link))\n\t\treturn 0;\n\n\t/* reset at least once if reset is requested */\n\tif ((ehc->i.action & ATA_EH_RESET) &&\n\t    !(ehc->i.flags & ATA_EHI_DID_RESET))\n\t\treturn 0;\n\n\t/* skip if class codes for all vacant slots are ATA_DEV_NONE */\n\tata_for_each_dev(dev, link, ALL) {\n\t\tif (dev->class == ATA_DEV_UNKNOWN &&\n\t\t    ehc->classes[dev->devno] != ATA_DEV_NONE)\n\t\t\treturn 0;\n\t}\n\n\treturn 1;\n}\n\nstatic int ata_count_probe_trials_cb(struct ata_ering_entry *ent, void *void_arg)\n{\n\tu64 interval = msecs_to_jiffies(ATA_EH_PROBE_TRIAL_INTERVAL);\n\tu64 now = get_jiffies_64();\n\tint *trials = void_arg;\n\n\tif ((ent->eflags & ATA_EFLAG_OLD_ER) ||\n\t    (ent->timestamp < now - min(now, interval)))\n\t\treturn -1;\n\n\t(*trials)++;\n\treturn 0;\n}\n\nstatic int ata_eh_schedule_probe(struct ata_device *dev)\n{\n\tstruct ata_eh_context *ehc = &dev->link->eh_context;\n\tstruct ata_link *link = ata_dev_phys_link(dev);\n\tint trials = 0;\n\n\tif (!(ehc->i.probe_mask & (1 << dev->devno)) ||\n\t    (ehc->did_probe_mask & (1 << dev->devno)))\n\t\treturn 0;\n\n\tata_eh_detach_dev(dev);\n\tata_dev_init(dev);\n\tehc->did_probe_mask |= (1 << dev->devno);\n\tehc->i.action |= ATA_EH_RESET;\n\tehc->saved_xfer_mode[dev->devno] = 0;\n\tehc->saved_ncq_enabled &= ~(1 << dev->devno);\n\n\t/* the link maybe in a deep sleep, wake it up */\n\tif (link->lpm_policy > ATA_LPM_MAX_POWER) {\n\t\tif (ata_is_host_link(link))\n\t\t\tlink->ap->ops->set_lpm(link, ATA_LPM_MAX_POWER,\n\t\t\t\t\t       ATA_LPM_EMPTY);\n\t\telse\n\t\t\tsata_pmp_set_lpm(link, ATA_LPM_MAX_POWER,\n\t\t\t\t\t ATA_LPM_EMPTY);\n\t}\n\n\t/* Record and count probe trials on the ering.  The specific\n\t * error mask used is irrelevant.  Because a successful device\n\t * detection clears the ering, this count accumulates only if\n\t * there are consecutive failed probes.\n\t *\n\t * If the count is equal to or higher than ATA_EH_PROBE_TRIALS\n\t * in the last ATA_EH_PROBE_TRIAL_INTERVAL, link speed is\n\t * forced to 1.5Gbps.\n\t *\n\t * This is to work around cases where failed link speed\n\t * negotiation results in device misdetection leading to\n\t * infinite DEVXCHG or PHRDY CHG events.\n\t */\n\tata_ering_record(&dev->ering, 0, AC_ERR_OTHER);\n\tata_ering_map(&dev->ering, ata_count_probe_trials_cb, &trials);\n\n\tif (trials > ATA_EH_PROBE_TRIALS)\n\t\tsata_down_spd_limit(link, 1);\n\n\treturn 1;\n}\n\nstatic int ata_eh_handle_dev_fail(struct ata_device *dev, int err)\n{\n\tstruct ata_eh_context *ehc = &dev->link->eh_context;\n\n\t/* -EAGAIN from EH routine indicates retry without prejudice.\n\t * The requester is responsible for ensuring forward progress.\n\t */\n\tif (err != -EAGAIN)\n\t\tehc->tries[dev->devno]--;\n\n\tswitch (err) {\n\tcase -ENODEV:\n\t\t/* device missing or wrong IDENTIFY data, schedule probing */\n\t\tehc->i.probe_mask |= (1 << dev->devno);\n\t\tfallthrough;\n\tcase -EINVAL:\n\t\t/* give it just one more chance */\n\t\tehc->tries[dev->devno] = min(ehc->tries[dev->devno], 1);\n\t\tfallthrough;\n\tcase -EIO:\n\t\tif (ehc->tries[dev->devno] == 1) {\n\t\t\t/* This is the last chance, better to slow\n\t\t\t * down than lose it.\n\t\t\t */\n\t\t\tsata_down_spd_limit(ata_dev_phys_link(dev), 0);\n\t\t\tif (dev->pio_mode > XFER_PIO_0)\n\t\t\t\tata_down_xfermask_limit(dev, ATA_DNXFER_PIO);\n\t\t}\n\t}\n\n\tif (ata_dev_enabled(dev) && !ehc->tries[dev->devno]) {\n\t\t/* disable device if it has used up all its chances */\n\t\tata_dev_disable(dev);\n\n\t\t/* detach if offline */\n\t\tif (ata_phys_link_offline(ata_dev_phys_link(dev)))\n\t\t\tata_eh_detach_dev(dev);\n\n\t\t/* schedule probe if necessary */\n\t\tif (ata_eh_schedule_probe(dev)) {\n\t\t\tehc->tries[dev->devno] = ATA_EH_DEV_TRIES;\n\t\t\tmemset(ehc->cmd_timeout_idx[dev->devno], 0,\n\t\t\t       sizeof(ehc->cmd_timeout_idx[dev->devno]));\n\t\t}\n\n\t\treturn 1;\n\t} else {\n\t\tehc->i.action |= ATA_EH_RESET;\n\t\treturn 0;\n\t}\n}\n\n/**\n *\tata_eh_recover - recover host port after error\n *\t@ap: host port to recover\n *\t@prereset: prereset method (can be NULL)\n *\t@softreset: softreset method (can be NULL)\n *\t@hardreset: hardreset method (can be NULL)\n *\t@postreset: postreset method (can be NULL)\n *\t@r_failed_link: out parameter for failed link\n *\n *\tThis is the alpha and omega, eum and yang, heart and soul of\n *\tlibata exception handling.  On entry, actions required to\n *\trecover each link and hotplug requests are recorded in the\n *\tlink's eh_context.  This function executes all the operations\n *\twith appropriate retrials and fallbacks to resurrect failed\n *\tdevices, detach goners and greet newcomers.\n *\n *\tLOCKING:\n *\tKernel thread context (may sleep).\n *\n *\tRETURNS:\n *\t0 on success, -errno on failure.\n */\nint ata_eh_recover(struct ata_port *ap, ata_prereset_fn_t prereset,\n\t\t   ata_reset_fn_t softreset, ata_reset_fn_t hardreset,\n\t\t   ata_postreset_fn_t postreset,\n\t\t   struct ata_link **r_failed_link)\n{\n\tstruct ata_link *link;\n\tstruct ata_device *dev;\n\tint rc, nr_fails;\n\tunsigned long flags, deadline;\n\n\tDPRINTK(\"ENTER\\n\");\n\n\t/* prep for recovery */\n\tata_for_each_link(link, ap, EDGE) {\n\t\tstruct ata_eh_context *ehc = &link->eh_context;\n\n\t\t/* re-enable link? */\n\t\tif (ehc->i.action & ATA_EH_ENABLE_LINK) {\n\t\t\tata_eh_about_to_do(link, NULL, ATA_EH_ENABLE_LINK);\n\t\t\tspin_lock_irqsave(ap->lock, flags);\n\t\t\tlink->flags &= ~ATA_LFLAG_DISABLED;\n\t\t\tspin_unlock_irqrestore(ap->lock, flags);\n\t\t\tata_eh_done(link, NULL, ATA_EH_ENABLE_LINK);\n\t\t}\n\n\t\tata_for_each_dev(dev, link, ALL) {\n\t\t\tif (link->flags & ATA_LFLAG_NO_RETRY)\n\t\t\t\tehc->tries[dev->devno] = 1;\n\t\t\telse\n\t\t\t\tehc->tries[dev->devno] = ATA_EH_DEV_TRIES;\n\n\t\t\t/* collect port action mask recorded in dev actions */\n\t\t\tehc->i.action |= ehc->i.dev_action[dev->devno] &\n\t\t\t\t\t ~ATA_EH_PERDEV_MASK;\n\t\t\tehc->i.dev_action[dev->devno] &= ATA_EH_PERDEV_MASK;\n\n\t\t\t/* process hotplug request */\n\t\t\tif (dev->flags & ATA_DFLAG_DETACH)\n\t\t\t\tata_eh_detach_dev(dev);\n\n\t\t\t/* schedule probe if necessary */\n\t\t\tif (!ata_dev_enabled(dev))\n\t\t\t\tata_eh_schedule_probe(dev);\n\t\t}\n\t}\n\n retry:\n\trc = 0;\n\n\t/* if UNLOADING, finish immediately */\n\tif (ap->pflags & ATA_PFLAG_UNLOADING)\n\t\tgoto out;\n\n\t/* prep for EH */\n\tata_for_each_link(link, ap, EDGE) {\n\t\tstruct ata_eh_context *ehc = &link->eh_context;\n\n\t\t/* skip EH if possible. */\n\t\tif (ata_eh_skip_recovery(link))\n\t\t\tehc->i.action = 0;\n\n\t\tata_for_each_dev(dev, link, ALL)\n\t\t\tehc->classes[dev->devno] = ATA_DEV_UNKNOWN;\n\t}\n\n\t/* reset */\n\tata_for_each_link(link, ap, EDGE) {\n\t\tstruct ata_eh_context *ehc = &link->eh_context;\n\n\t\tif (!(ehc->i.action & ATA_EH_RESET))\n\t\t\tcontinue;\n\n\t\trc = ata_eh_reset(link, ata_link_nr_vacant(link),\n\t\t\t\t  prereset, softreset, hardreset, postreset);\n\t\tif (rc) {\n\t\t\tata_link_err(link, \"reset failed, giving up\\n\");\n\t\t\tgoto out;\n\t\t}\n\t}\n\n\tdo {\n\t\tunsigned long now;\n\n\t\t/*\n\t\t * clears ATA_EH_PARK in eh_info and resets\n\t\t * ap->park_req_pending\n\t\t */\n\t\tata_eh_pull_park_action(ap);\n\n\t\tdeadline = jiffies;\n\t\tata_for_each_link(link, ap, EDGE) {\n\t\t\tata_for_each_dev(dev, link, ALL) {\n\t\t\t\tstruct ata_eh_context *ehc = &link->eh_context;\n\t\t\t\tunsigned long tmp;\n\n\t\t\t\tif (dev->class != ATA_DEV_ATA &&\n\t\t\t\t    dev->class != ATA_DEV_ZAC)\n\t\t\t\t\tcontinue;\n\t\t\t\tif (!(ehc->i.dev_action[dev->devno] &\n\t\t\t\t      ATA_EH_PARK))\n\t\t\t\t\tcontinue;\n\t\t\t\ttmp = dev->unpark_deadline;\n\t\t\t\tif (time_before(deadline, tmp))\n\t\t\t\t\tdeadline = tmp;\n\t\t\t\telse if (time_before_eq(tmp, jiffies))\n\t\t\t\t\tcontinue;\n\t\t\t\tif (ehc->unloaded_mask & (1 << dev->devno))\n\t\t\t\t\tcontinue;\n\n\t\t\t\tata_eh_park_issue_cmd(dev, 1);\n\t\t\t}\n\t\t}\n\n\t\tnow = jiffies;\n\t\tif (time_before_eq(deadline, now))\n\t\t\tbreak;\n\n\t\tata_eh_release(ap);\n\t\tdeadline = wait_for_completion_timeout(&ap->park_req_pending,\n\t\t\t\t\t\t       deadline - now);\n\t\tata_eh_acquire(ap);\n\t} while (deadline);\n\tata_for_each_link(link, ap, EDGE) {\n\t\tata_for_each_dev(dev, link, ALL) {\n\t\t\tif (!(link->eh_context.unloaded_mask &\n\t\t\t      (1 << dev->devno)))\n\t\t\t\tcontinue;\n\n\t\t\tata_eh_park_issue_cmd(dev, 0);\n\t\t\tata_eh_done(link, dev, ATA_EH_PARK);\n\t\t}\n\t}\n\n\t/* the rest */\n\tnr_fails = 0;\n\tata_for_each_link(link, ap, PMP_FIRST) {\n\t\tstruct ata_eh_context *ehc = &link->eh_context;\n\n\t\tif (sata_pmp_attached(ap) && ata_is_host_link(link))\n\t\t\tgoto config_lpm;\n\n\t\t/* revalidate existing devices and attach new ones */\n\t\trc = ata_eh_revalidate_and_attach(link, &dev);\n\t\tif (rc)\n\t\t\tgoto rest_fail;\n\n\t\t/* if PMP got attached, return, pmp EH will take care of it */\n\t\tif (link->device->class == ATA_DEV_PMP) {\n\t\t\tehc->i.action = 0;\n\t\t\treturn 0;\n\t\t}\n\n\t\t/* configure transfer mode if necessary */\n\t\tif (ehc->i.flags & ATA_EHI_SETMODE) {\n\t\t\trc = ata_set_mode(link, &dev);\n\t\t\tif (rc)\n\t\t\t\tgoto rest_fail;\n\t\t\tehc->i.flags &= ~ATA_EHI_SETMODE;\n\t\t}\n\n\t\t/* If reset has been issued, clear UA to avoid\n\t\t * disrupting the current users of the device.\n\t\t */\n\t\tif (ehc->i.flags & ATA_EHI_DID_RESET) {\n\t\t\tata_for_each_dev(dev, link, ALL) {\n\t\t\t\tif (dev->class != ATA_DEV_ATAPI)\n\t\t\t\t\tcontinue;\n\t\t\t\trc = atapi_eh_clear_ua(dev);\n\t\t\t\tif (rc)\n\t\t\t\t\tgoto rest_fail;\n\t\t\t\tif (zpodd_dev_enabled(dev))\n\t\t\t\t\tzpodd_post_poweron(dev);\n\t\t\t}\n\t\t}\n\n\t\t/* retry flush if necessary */\n\t\tata_for_each_dev(dev, link, ALL) {\n\t\t\tif (dev->class != ATA_DEV_ATA &&\n\t\t\t    dev->class != ATA_DEV_ZAC)\n\t\t\t\tcontinue;\n\t\t\trc = ata_eh_maybe_retry_flush(dev);\n\t\t\tif (rc)\n\t\t\t\tgoto rest_fail;\n\t\t}\n\n\tconfig_lpm:\n\t\t/* configure link power saving */\n\t\tif (link->lpm_policy != ap->target_lpm_policy) {\n\t\t\trc = ata_eh_set_lpm(link, ap->target_lpm_policy, &dev);\n\t\t\tif (rc)\n\t\t\t\tgoto rest_fail;\n\t\t}\n\n\t\t/* this link is okay now */\n\t\tehc->i.flags = 0;\n\t\tcontinue;\n\n\trest_fail:\n\t\tnr_fails++;\n\t\tif (dev)\n\t\t\tata_eh_handle_dev_fail(dev, rc);\n\n\t\tif (ap->pflags & ATA_PFLAG_FROZEN) {\n\t\t\t/* PMP reset requires working host port.\n\t\t\t * Can't retry if it's frozen.\n\t\t\t */\n\t\t\tif (sata_pmp_attached(ap))\n\t\t\t\tgoto out;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (nr_fails)\n\t\tgoto retry;\n\n out:\n\tif (rc && r_failed_link)\n\t\t*r_failed_link = link;\n\n\tDPRINTK(\"EXIT, rc=%d\\n\", rc);\n\treturn rc;\n}\n\n/**\n *\tata_eh_finish - finish up EH\n *\t@ap: host port to finish EH for\n *\n *\tRecovery is complete.  Clean up EH states and retry or finish\n *\tfailed qcs.\n *\n *\tLOCKING:\n *\tNone.\n */\nvoid ata_eh_finish(struct ata_port *ap)\n{\n\tstruct ata_queued_cmd *qc;\n\tint tag;\n\n\t/* retry or finish qcs */\n\tata_qc_for_each_raw(ap, qc, tag) {\n\t\tif (!(qc->flags & ATA_QCFLAG_FAILED))\n\t\t\tcontinue;\n\n\t\tif (qc->err_mask) {\n\t\t\t/* FIXME: Once EH migration is complete,\n\t\t\t * generate sense data in this function,\n\t\t\t * considering both err_mask and tf.\n\t\t\t */\n\t\t\tif (qc->flags & ATA_QCFLAG_RETRY)\n\t\t\t\tata_eh_qc_retry(qc);\n\t\t\telse\n\t\t\t\tata_eh_qc_complete(qc);\n\t\t} else {\n\t\t\tif (qc->flags & ATA_QCFLAG_SENSE_VALID) {\n\t\t\t\tata_eh_qc_complete(qc);\n\t\t\t} else {\n\t\t\t\t/* feed zero TF to sense generation */\n\t\t\t\tmemset(&qc->result_tf, 0, sizeof(qc->result_tf));\n\t\t\t\tata_eh_qc_retry(qc);\n\t\t\t}\n\t\t}\n\t}\n\n\t/* make sure nr_active_links is zero after EH */\n\tWARN_ON(ap->nr_active_links);\n\tap->nr_active_links = 0;\n}\n\n/**\n *\tata_do_eh - do standard error handling\n *\t@ap: host port to handle error for\n *\n *\t@prereset: prereset method (can be NULL)\n *\t@softreset: softreset method (can be NULL)\n *\t@hardreset: hardreset method (can be NULL)\n *\t@postreset: postreset method (can be NULL)\n *\n *\tPerform standard error handling sequence.\n *\n *\tLOCKING:\n *\tKernel thread context (may sleep).\n */\nvoid ata_do_eh(struct ata_port *ap, ata_prereset_fn_t prereset,\n\t       ata_reset_fn_t softreset, ata_reset_fn_t hardreset,\n\t       ata_postreset_fn_t postreset)\n{\n\tstruct ata_device *dev;\n\tint rc;\n\n\tata_eh_autopsy(ap);\n\tata_eh_report(ap);\n\n\trc = ata_eh_recover(ap, prereset, softreset, hardreset, postreset,\n\t\t\t    NULL);\n\tif (rc) {\n\t\tata_for_each_dev(dev, &ap->link, ALL)\n\t\t\tata_dev_disable(dev);\n\t}\n\n\tata_eh_finish(ap);\n}\n\n/**\n *\tata_std_error_handler - standard error handler\n *\t@ap: host port to handle error for\n *\n *\tStandard error handler\n *\n *\tLOCKING:\n *\tKernel thread context (may sleep).\n */\nvoid ata_std_error_handler(struct ata_port *ap)\n{\n\tstruct ata_port_operations *ops = ap->ops;\n\tata_reset_fn_t hardreset = ops->hardreset;\n\n\t/* ignore built-in hardreset if SCR access is not available */\n\tif (hardreset == sata_std_hardreset && !sata_scr_valid(&ap->link))\n\t\thardreset = NULL;\n\n\tata_do_eh(ap, ops->prereset, ops->softreset, hardreset, ops->postreset);\n}\nEXPORT_SYMBOL_GPL(ata_std_error_handler);\n\n#ifdef CONFIG_PM\n/**\n *\tata_eh_handle_port_suspend - perform port suspend operation\n *\t@ap: port to suspend\n *\n *\tSuspend @ap.\n *\n *\tLOCKING:\n *\tKernel thread context (may sleep).\n */\nstatic void ata_eh_handle_port_suspend(struct ata_port *ap)\n{\n\tunsigned long flags;\n\tint rc = 0;\n\tstruct ata_device *dev;\n\n\t/* are we suspending? */\n\tspin_lock_irqsave(ap->lock, flags);\n\tif (!(ap->pflags & ATA_PFLAG_PM_PENDING) ||\n\t    ap->pm_mesg.event & PM_EVENT_RESUME) {\n\t\tspin_unlock_irqrestore(ap->lock, flags);\n\t\treturn;\n\t}\n\tspin_unlock_irqrestore(ap->lock, flags);\n\n\tWARN_ON(ap->pflags & ATA_PFLAG_SUSPENDED);\n\n\t/*\n\t * If we have a ZPODD attached, check its zero\n\t * power ready status before the port is frozen.\n\t * Only needed for runtime suspend.\n\t */\n\tif (PMSG_IS_AUTO(ap->pm_mesg)) {\n\t\tata_for_each_dev(dev, &ap->link, ENABLED) {\n\t\t\tif (zpodd_dev_enabled(dev))\n\t\t\t\tzpodd_on_suspend(dev);\n\t\t}\n\t}\n\n\t/* tell ACPI we're suspending */\n\trc = ata_acpi_on_suspend(ap);\n\tif (rc)\n\t\tgoto out;\n\n\t/* suspend */\n\tata_eh_freeze_port(ap);\n\n\tif (ap->ops->port_suspend)\n\t\trc = ap->ops->port_suspend(ap, ap->pm_mesg);\n\n\tata_acpi_set_state(ap, ap->pm_mesg);\n out:\n\t/* update the flags */\n\tspin_lock_irqsave(ap->lock, flags);\n\n\tap->pflags &= ~ATA_PFLAG_PM_PENDING;\n\tif (rc == 0)\n\t\tap->pflags |= ATA_PFLAG_SUSPENDED;\n\telse if (ap->pflags & ATA_PFLAG_FROZEN)\n\t\tata_port_schedule_eh(ap);\n\n\tspin_unlock_irqrestore(ap->lock, flags);\n\n\treturn;\n}\n\n/**\n *\tata_eh_handle_port_resume - perform port resume operation\n *\t@ap: port to resume\n *\n *\tResume @ap.\n *\n *\tLOCKING:\n *\tKernel thread context (may sleep).\n */\nstatic void ata_eh_handle_port_resume(struct ata_port *ap)\n{\n\tstruct ata_link *link;\n\tstruct ata_device *dev;\n\tunsigned long flags;\n\n\t/* are we resuming? */\n\tspin_lock_irqsave(ap->lock, flags);\n\tif (!(ap->pflags & ATA_PFLAG_PM_PENDING) ||\n\t    !(ap->pm_mesg.event & PM_EVENT_RESUME)) {\n\t\tspin_unlock_irqrestore(ap->lock, flags);\n\t\treturn;\n\t}\n\tspin_unlock_irqrestore(ap->lock, flags);\n\n\tWARN_ON(!(ap->pflags & ATA_PFLAG_SUSPENDED));\n\n\t/*\n\t * Error timestamps are in jiffies which doesn't run while\n\t * suspended and PHY events during resume isn't too uncommon.\n\t * When the two are combined, it can lead to unnecessary speed\n\t * downs if the machine is suspended and resumed repeatedly.\n\t * Clear error history.\n\t */\n\tata_for_each_link(link, ap, HOST_FIRST)\n\t\tata_for_each_dev(dev, link, ALL)\n\t\t\tata_ering_clear(&dev->ering);\n\n\tata_acpi_set_state(ap, ap->pm_mesg);\n\n\tif (ap->ops->port_resume)\n\t\tap->ops->port_resume(ap);\n\n\t/* tell ACPI that we're resuming */\n\tata_acpi_on_resume(ap);\n\n\t/* update the flags */\n\tspin_lock_irqsave(ap->lock, flags);\n\tap->pflags &= ~(ATA_PFLAG_PM_PENDING | ATA_PFLAG_SUSPENDED);\n\tspin_unlock_irqrestore(ap->lock, flags);\n}\n#endif /* CONFIG_PM */\n"}}, "reports": [{"events": [{"location": {"col": 0, "file": 0, "line": 2814}, "message": "parse error: turning off implications after 60 seconds"}], "macros": [], "notes": [], "path": "/src/drivers/ata/libata-eh.c", "reportHash": "d976edc162c67dafc5fb3d7134e47a6c", "checkerName": "smatch.smatch_implied", "reviewStatus": null, "severity": "UNSPECIFIED"}]};
      window.onload = function() {
        if (!browserCompatible) {
          setNonCompatibleBrowserMessage();
        } else {
          BugViewer.init(data.files, data.reports);
          BugViewer.create();
          BugViewer.initByUrl();
        }
      };
    </script>
  </head>
  <body>
  <div class="container">
    <div id="content">
      <div id="side-bar">
        <div class="header">
          <a href="index.html" class="button">&#8249; Return to List</a>
        </div>
        <div id="report-nav">
          <div class="header">Reports</div>
        </div>
      </div>
      <div id="editor-wrapper">
        <div class="header">
          <div id="file">
            <span class="label">File:</span>
            <span id="file-path"></span>
          </div>
          <div id="checker">
            <span class="label">Checker name:</span>
            <span id="checker-name"></span>
          </div>
          <div id="review-status-wrapper">
            <span class="label">Review status:</span>
            <span id="review-status"></span>
          </div>
        </div>
        <div id="editor"></div>
      </div>
    </div>
  </div>
  </body>
</html>
