<!DOCTYPE html>
<html>
  <head>
    <title>Plist HTML Viewer</title>

    <meta charset="UTF-8">

    <style type="text/css">
      .CodeMirror{font-family:monospace;height:300px;color:#000;direction:ltr}.CodeMirror-lines{padding:4px 0}.CodeMirror pre{padding:0 4px}.CodeMirror-gutter-filler,.CodeMirror-scrollbar-filler{background-color:#fff}.CodeMirror-gutters{border-right:1px solid #ddd;background-color:#f7f7f7;white-space:nowrap}.CodeMirror-linenumber{padding:0 3px 0 5px;min-width:20px;text-align:right;color:#999;white-space:nowrap}.CodeMirror-guttermarker{color:#000}.CodeMirror-guttermarker-subtle{color:#999}.CodeMirror-cursor{border-left:1px solid #000;border-right:none;width:0}.CodeMirror div.CodeMirror-secondarycursor{border-left:1px solid silver}.cm-fat-cursor .CodeMirror-cursor{width:auto;border:0!important;background:#7e7}.cm-fat-cursor div.CodeMirror-cursors{z-index:1}.cm-animate-fat-cursor{width:auto;border:0;-webkit-animation:blink 1.06s steps(1) infinite;-moz-animation:blink 1.06s steps(1) infinite;animation:blink 1.06s steps(1) infinite;background-color:#7e7}@-moz-keyframes blink{50%{background-color:transparent}}@-webkit-keyframes blink{50%{background-color:transparent}}@keyframes blink{50%{background-color:transparent}}.cm-tab{display:inline-block;text-decoration:inherit}.CodeMirror-rulers{position:absolute;left:0;right:0;top:-50px;bottom:-20px;overflow:hidden}.CodeMirror-ruler{border-left:1px solid #ccc;top:0;bottom:0;position:absolute}.cm-s-default .cm-header{color:#00f}.cm-s-default .cm-quote{color:#090}.cm-negative{color:#d44}.cm-positive{color:#292}.cm-header,.cm-strong{font-weight:700}.cm-em{font-style:italic}.cm-link{text-decoration:underline}.cm-strikethrough{text-decoration:line-through}.cm-s-default .cm-keyword{color:#708}.cm-s-default .cm-atom{color:#219}.cm-s-default .cm-number{color:#164}.cm-s-default .cm-def{color:#00f}.cm-s-default .cm-variable-2{color:#05a}.cm-s-default .cm-type,.cm-s-default .cm-variable-3{color:#085}.cm-s-default .cm-comment{color:#a50}.cm-s-default .cm-string{color:#a11}.cm-s-default .cm-string-2{color:#f50}.cm-s-default .cm-meta{color:#555}.cm-s-default .cm-qualifier{color:#555}.cm-s-default .cm-builtin{color:#30a}.cm-s-default .cm-bracket{color:#997}.cm-s-default .cm-tag{color:#170}.cm-s-default .cm-attribute{color:#00c}.cm-s-default .cm-hr{color:#999}.cm-s-default .cm-link{color:#00c}.cm-s-default .cm-error{color:red}.cm-invalidchar{color:red}.CodeMirror-composing{border-bottom:2px solid}div.CodeMirror span.CodeMirror-matchingbracket{color:#0f0}div.CodeMirror span.CodeMirror-nonmatchingbracket{color:#f22}.CodeMirror-matchingtag{background:rgba(255,150,0,.3)}.CodeMirror-activeline-background{background:#e8f2ff}.CodeMirror{position:relative;overflow:hidden;background:#fff}.CodeMirror-scroll{overflow:scroll!important;margin-bottom:-30px;margin-right:-30px;padding-bottom:30px;height:100%;outline:0;position:relative}.CodeMirror-sizer{position:relative;border-right:30px solid transparent}.CodeMirror-gutter-filler,.CodeMirror-hscrollbar,.CodeMirror-scrollbar-filler,.CodeMirror-vscrollbar{position:absolute;z-index:6;display:none}.CodeMirror-vscrollbar{right:0;top:0;overflow-x:hidden;overflow-y:scroll}.CodeMirror-hscrollbar{bottom:0;left:0;overflow-y:hidden;overflow-x:scroll}.CodeMirror-scrollbar-filler{right:0;bottom:0}.CodeMirror-gutter-filler{left:0;bottom:0}.CodeMirror-gutters{position:absolute;left:0;top:0;min-height:100%;z-index:3}.CodeMirror-gutter{white-space:normal;height:100%;display:inline-block;vertical-align:top;margin-bottom:-30px}.CodeMirror-gutter-wrapper{position:absolute;z-index:4;background:0 0!important;border:none!important}.CodeMirror-gutter-background{position:absolute;top:0;bottom:0;z-index:4}.CodeMirror-gutter-elt{position:absolute;cursor:default;z-index:4}.CodeMirror-gutter-wrapper ::selection{background-color:transparent}.CodeMirror-gutter-wrapper ::-moz-selection{background-color:transparent}.CodeMirror-lines{cursor:text;min-height:1px}.CodeMirror pre{-moz-border-radius:0;-webkit-border-radius:0;border-radius:0;border-width:0;background:0 0;font-family:inherit;font-size:inherit;margin:0;white-space:pre;word-wrap:normal;line-height:inherit;color:inherit;z-index:2;position:relative;overflow:visible;-webkit-tap-highlight-color:transparent;-webkit-font-variant-ligatures:contextual;font-variant-ligatures:contextual}.CodeMirror-wrap pre{word-wrap:break-word;white-space:pre-wrap;word-break:normal}.CodeMirror-linebackground{position:absolute;left:0;right:0;top:0;bottom:0;z-index:0}.CodeMirror-linewidget{position:relative;z-index:2;overflow:auto}.CodeMirror-rtl pre{direction:rtl}.CodeMirror-code{outline:0}.CodeMirror-gutter,.CodeMirror-gutters,.CodeMirror-linenumber,.CodeMirror-scroll,.CodeMirror-sizer{-moz-box-sizing:content-box;box-sizing:content-box}.CodeMirror-measure{position:absolute;width:100%;height:0;overflow:hidden;visibility:hidden}.CodeMirror-cursor{position:absolute;pointer-events:none}.CodeMirror-measure pre{position:static}div.CodeMirror-cursors{visibility:hidden;position:relative;z-index:3}div.CodeMirror-dragcursors{visibility:visible}.CodeMirror-focused div.CodeMirror-cursors{visibility:visible}.CodeMirror-selected{background:#d9d9d9}.CodeMirror-focused .CodeMirror-selected{background:#d7d4f0}.CodeMirror-crosshair{cursor:crosshair}.CodeMirror-line::selection,.CodeMirror-line>span::selection,.CodeMirror-line>span>span::selection{background:#d7d4f0}.CodeMirror-line::-moz-selection,.CodeMirror-line>span::-moz-selection,.CodeMirror-line>span>span::-moz-selection{background:#d7d4f0}.cm-searching{background-color:#ffa;background-color:rgba(255,255,0,.4)}.cm-force-border{padding-right:.1px}@media print{.CodeMirror div.CodeMirror-cursors{visibility:hidden}}.cm-tab-wrap-hack:after{content:''}span.CodeMirror-selectedtext{background:0 0}
/*# sourceMappingURL=codemirror.min.css.map */

      .severity-low {
  background-color: #669603;
}

.severity-low:after {
  content : 'L';
}

.severity-unspecified {
  background-color: #666666;
}

.severity-unspecified:after {
  content : 'U';
}

.severity-style {
  background-color: #9932cc;
}

.severity-style:after {
  content : 'S';
}

.severity-medium {
  background-color: #a9d323;
  color: black;
}

.severity-medium:after {
  content : 'M';
}

.severity-high {
  background-color: #ffa800;
}

.severity-high:after {
  content : 'H';
}

.severity-critical {
  background-color: #e92625;
}

.severity-critical:after {
  content : 'C';
}

i[class*="severity-"] {
  line-height: normal;
  text-transform: capitalize;
  font-size: 0.8em;
  font-weight: bold;
  color: white;
  display: inline-block;
  width: 16px;
  height: 16px;
  text-align: center;
  font-family: sans-serif;
}

      html, body {
  width: 100%;
  height: 100%;
  padding: 0px;
  margin: 0px;
}

div.container {
  padding: 10px;
}

#content {
  height: 100%;
  display: block;
  overflow: hidden;
}

#content > div {
  margin: 10px;
  overflow: hidden;
  border: 1px solid #ddd;
  border-radius: 3px;
  overflow: hidden;
  height: 97%;
}

.button {
  background-color: #f1f1f1;
  text-decoration: none;
  display: inline-block;
  padding: 8px 16px;
  color: black;
  cursor: pointer;
}

.button:hover {
  background-color: #ddd;
  color: black;
}

.review-status {
  color: white;
  text-align: center;
}

.review-status-confirmed {
  background-color: #e92625;
}

.review-status-false-positive {
  background-color: grey;
}

.review-status-intentional {
  background-color: #669603;
}

      div.container {
  width: 100%;
  height: 100%;
  padding: 0px;
}

#editor-wrapper {
  margin: 10px;
}

#side-bar {
  float: left;
  width: 260px;
  margin: 0px;
}

#report-nav ul {
  list-style-type: none;
  padding: 0;
  margin: 0;
  overflow-y: auto;
  height: 100%;
}

#report-nav ul > li {
  padding: .4em;
  background-color: #fff;
  border-bottom: 1px solid rgba(0,0,0,.125);
  text-align: left;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

#report-nav ul > li.active {
  background-color: #427ea9;
  color: white;
}

#report-nav ul > li:hover {
  background-color: #427ea9;
  color: white;
  cursor: pointer;
}

#report-nav ul a {
  text-decoration: none;
}

#report-nav i[class*="severity-"] {
  margin-right: 5px;
}

.header {
  border-bottom: 1px solid lightgrey;
  font-family: monospace;
  padding: 10px;
  background-color: #fafbfc;
  border-bottom: 1px solid #e1e4e8;
  border-top-left-radius: 2px;
  border-top-right-radius: 2px;
}

#report-nav .header {
  font-weight: bold;
}

#editor-wrapper .header > div {
  padding-top: 2px;
}

#file-path,
#checker-name {
  color: #195ea2;
}

#review-status {
  padding: 0px 5px;
}

#file-path {
  font-family: monospace;
}

.check-msg {
  display: inline-block;
  padding: 3px 6px;
  margin: 1px;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
  border-radius: 5px;
}

.check-msg.info {
  color: #00546f;
  background-color: #bfdfe9;
  border: 1px solid #87a8b3;
}

.check-msg.error {
  background-color: #f2dede;
  color: #a94442;
  border: 1px solid #ebcccc;
}

.check-msg.macro {
  background-color: #d7dac2;
  color: #4f5c6d;
  border: 1px solid #d7dac2;
}

.check-msg.note {
  background-color: #d7d7d7;
  color: #4f5c6d;
  border: 1px solid #bfbfbf;
}

.check-msg.current {
  border: 2px dashed #3692ff;
}

.check-msg .tag {
  padding: 1px 5px;
  text-align: center;
  border-radius: 2px;
  margin-right: 5px;
  text-decoration: inherit;
}

.check-msg .tag.macro {
  background-color: #83876a;
  color: white;
  text-transform: capitalize;
}

.check-msg .tag.note {
  background-color: #9299a1;
  color: white;
  text-transform: capitalize;
}

.checker-enum {
  color: white;
  padding: 1px 5px;
  text-align: center;
  border-radius: 25px;
  margin-right: 5px;
  text-decoration: inherit;
}

.checker-enum.info {
  background-color: #427ea9;
}

.checker-enum.error {
  background-color: #a94442;
}

.arrow {
  border: solid black;
  border-width: 0 3px 3px 0;
  display: inline-block;
  padding: 3px;
  cursor: pointer;
  margin: 0px 5px;
}

.arrow:hover {
  border: solid #437ea8;
  border-width: 0 3px 3px 0;
}

.left-arrow {
  transform: rotate(135deg);
  -webkit-transform: rotate(135deg);
}

.right-arrow {
  transform: rotate(-45deg);
  -webkit-transform: rotate(-45deg);
}

    </style>

    <script type="text/javascript">
      function setNonCompatibleBrowserMessage() {
  document.body.innerHTML =
    '<h2 style="margin-left: 20px;">Your browser is not compatible with CodeChecker Viewer!</h2> \
     <p style="margin-left: 20px;">The version required for the following browsers are:</p> \
     <ul style="margin-left: 20px;"> \
     <li>Internet Explorer: version 9 or newer</li> \
     <li>Firefox: version 22.0 or newer</li> \
     </ul>';
}

// http://stackoverflow.com/questions/5916900/how-can-you-detect-the-version-of-a-browser
var browserVersion = (function(){
  var ua = navigator.userAgent, tem,
    M = ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];

  if (/trident/i.test(M[1])) {
    tem = /\brv[ :]+(\d+)/g.exec(ua) || [];
    return 'IE ' + (tem[1] || '');
  }

  if (M[1] === 'Chrome') {
    tem = ua.match(/\b(OPR|Edge)\/(\d+)/);
    if (tem != null) return tem.slice(1).join(' ').replace('OPR', 'Opera');
  }

  M = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, '-?'];
  if ((tem = ua.match(/version\/(\d+)/i)) != null) M.splice(1, 1, tem[1]);
    return M.join(' ');
})();

var pos = browserVersion.indexOf(' ');
var browser = browserVersion.substr(0, pos);
var version = parseInt(browserVersion.substr(pos + 1));

var browserCompatible
  = browser === 'Firefox'
  ? version >= 22
  : browser === 'IE'
  ? version >= 9
  : true;


      /* MIT License

Copyright (C) 2017 by Marijn Haverbeke <marijnh@gmail.com> and others

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
 */
      !function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.CodeMirror=t()}(this,function(){"use strict";function e(e){return new RegExp("(^|\\s)"+e+"(?:$|\\s)\\s*")}function t(e){for(var t=e.childNodes.length;t>0;--t)e.removeChild(e.firstChild);return e}function r(e,r){return t(e).appendChild(r)}function n(e,t,r,n){var i=document.createElement(e);if(r&&(i.className=r),n&&(i.style.cssText=n),"string"==typeof t)i.appendChild(document.createTextNode(t));else if(t)for(var o=0;o<t.length;++o)i.appendChild(t[o]);return i}function i(e,t,r,i){var o=n(e,t,r,i);return o.setAttribute("role","presentation"),o}function o(e,t){if(3==t.nodeType&&(t=t.parentNode),e.contains)return e.contains(t);do{if(11==t.nodeType&&(t=t.host),t==e)return!0}while(t=t.parentNode)}function l(){var e;try{e=document.activeElement}catch(t){e=document.body||null}for(;e&&e.shadowRoot&&e.shadowRoot.activeElement;)e=e.shadowRoot.activeElement;return e}function s(t,r){var n=t.className;e(r).test(n)||(t.className+=(n?" ":"")+r)}function a(t,r){for(var n=t.split(" "),i=0;i<n.length;i++)n[i]&&!e(n[i]).test(r)&&(r+=" "+n[i]);return r}function u(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t)}}function c(e,t,r){t||(t={});for(var n in e)!e.hasOwnProperty(n)||!1===r&&t.hasOwnProperty(n)||(t[n]=e[n]);return t}function f(e,t,r,n,i){null==t&&-1==(t=e.search(/[^\s\u00a0]/))&&(t=e.length);for(var o=n||0,l=i||0;;){var s=e.indexOf("\t",o);if(s<0||s>=t)return l+(t-o);l+=s-o,l+=r-l%r,o=s+1}}function h(e,t){for(var r=0;r<e.length;++r)if(e[r]==t)return r;return-1}function d(e,t,r){for(var n=0,i=0;;){var o=e.indexOf("\t",n);-1==o&&(o=e.length);var l=o-n;if(o==e.length||i+l>=t)return n+Math.min(l,t-i);if(i+=o-n,i+=r-i%r,n=o+1,i>=t)return n}}function p(e){for(;Kl.length<=e;)Kl.push(g(Kl)+" ");return Kl[e]}function g(e){return e[e.length-1]}function v(e,t){for(var r=[],n=0;n<e.length;n++)r[n]=t(e[n],n);return r}function m(e,t,r){for(var n=0,i=r(t);n<e.length&&r(e[n])<=i;)n++;e.splice(n,0,t)}function y(){}function b(e,t){var r;return Object.create?r=Object.create(e):(y.prototype=e,r=new y),t&&c(t,r),r}function w(e){return/\w/.test(e)||e>""&&(e.toUpperCase()!=e.toLowerCase()||jl.test(e))}function x(e,t){return t?!!(t.source.indexOf("\\w")>-1&&w(e))||t.test(e):w(e)}function C(e){for(var t in e)if(e.hasOwnProperty(t)&&e[t])return!1;return!0}function S(e){return e.charCodeAt(0)>=768&&Xl.test(e)}function L(e,t,r){for(;(r<0?t>0:t<e.length)&&S(e.charAt(t));)t+=r;return t}function k(e,t,r){for(var n=t>r?-1:1;;){if(t==r)return t;var i=(t+r)/2,o=n<0?Math.ceil(i):Math.floor(i);if(o==t)return e(o)?t:r;e(o)?r=o:t=o+n}}function T(e,t,r){var o=this;this.input=r,o.scrollbarFiller=n("div",null,"CodeMirror-scrollbar-filler"),o.scrollbarFiller.setAttribute("cm-not-content","true"),o.gutterFiller=n("div",null,"CodeMirror-gutter-filler"),o.gutterFiller.setAttribute("cm-not-content","true"),o.lineDiv=i("div",null,"CodeMirror-code"),o.selectionDiv=n("div",null,null,"position: relative; z-index: 1"),o.cursorDiv=n("div",null,"CodeMirror-cursors"),o.measure=n("div",null,"CodeMirror-measure"),o.lineMeasure=n("div",null,"CodeMirror-measure"),o.lineSpace=i("div",[o.measure,o.lineMeasure,o.selectionDiv,o.cursorDiv,o.lineDiv],null,"position: relative; outline: none");var l=i("div",[o.lineSpace],"CodeMirror-lines");o.mover=n("div",[l],null,"position: relative"),o.sizer=n("div",[o.mover],"CodeMirror-sizer"),o.sizerWidth=null,o.heightForcer=n("div",null,null,"position: absolute; height: "+Rl+"px; width: 1px;"),o.gutters=n("div",null,"CodeMirror-gutters"),o.lineGutter=null,o.scroller=n("div",[o.sizer,o.heightForcer,o.gutters],"CodeMirror-scroll"),o.scroller.setAttribute("tabIndex","-1"),o.wrapper=n("div",[o.scrollbarFiller,o.gutterFiller,o.scroller],"CodeMirror"),gl&&vl<8&&(o.gutters.style.zIndex=-1,o.scroller.style.paddingRight=0),ml||fl&&Tl||(o.scroller.draggable=!0),e&&(e.appendChild?e.appendChild(o.wrapper):e(o.wrapper)),o.viewFrom=o.viewTo=t.first,o.reportedViewFrom=o.reportedViewTo=t.first,o.view=[],o.renderedView=null,o.externalMeasured=null,o.viewOffset=0,o.lastWrapHeight=o.lastWrapWidth=0,o.updateLineNumbers=null,o.nativeBarWidth=o.barHeight=o.barWidth=0,o.scrollbarsClipped=!1,o.lineNumWidth=o.lineNumInnerWidth=o.lineNumChars=null,o.alignWidgets=!1,o.cachedCharWidth=o.cachedTextHeight=o.cachedPaddingH=null,o.maxLine=null,o.maxLineLength=0,o.maxLineChanged=!1,o.wheelDX=o.wheelDY=o.wheelStartX=o.wheelStartY=null,o.shift=!1,o.selForContextMenu=null,o.activeTouch=null,r.init(o)}function M(e,t){if((t-=e.first)<0||t>=e.size)throw new Error("There is no line "+(t+e.first)+" in the document.");for(var r=e;!r.lines;)for(var n=0;;++n){var i=r.children[n],o=i.chunkSize();if(t<o){r=i;break}t-=o}return r.lines[t]}function N(e,t,r){var n=[],i=t.line;return e.iter(t.line,r.line+1,function(e){var o=e.text;i==r.line&&(o=o.slice(0,r.ch)),i==t.line&&(o=o.slice(t.ch)),n.push(o),++i}),n}function O(e,t,r){var n=[];return e.iter(t,r,function(e){n.push(e.text)}),n}function A(e,t){var r=t-e.height;if(r)for(var n=e;n;n=n.parent)n.height+=r}function W(e){if(null==e.parent)return null;for(var t=e.parent,r=h(t.lines,e),n=t.parent;n;t=n,n=n.parent)for(var i=0;n.children[i]!=t;++i)r+=n.children[i].chunkSize();return r+t.first}function D(e,t){var r=e.first;e:do{for(var n=0;n<e.children.length;++n){var i=e.children[n],o=i.height;if(t<o){e=i;continue e}t-=o,r+=i.chunkSize()}return r}while(!e.lines);for(var l=0;l<e.lines.length;++l){var s=e.lines[l].height;if(t<s)break;t-=s}return r+l}function H(e,t){return t>=e.first&&t<e.first+e.size}function F(e,t){return String(e.lineNumberFormatter(t+e.firstLineNumber))}function E(e,t,r){if(void 0===r&&(r=null),!(this instanceof E))return new E(e,t,r);this.line=e,this.ch=t,this.sticky=r}function P(e,t){return e.line-t.line||e.ch-t.ch}function I(e,t){return e.sticky==t.sticky&&0==P(e,t)}function z(e){return E(e.line,e.ch)}function R(e,t){return P(e,t)<0?t:e}function B(e,t){return P(e,t)<0?e:t}function G(e,t){return Math.max(e.first,Math.min(t,e.first+e.size-1))}function U(e,t){if(t.line<e.first)return E(e.first,0);var r=e.first+e.size-1;return t.line>r?E(r,M(e,r).text.length):V(t,M(e,t.line).text.length)}function V(e,t){var r=e.ch;return null==r||r>t?E(e.line,t):r<0?E(e.line,0):e}function K(e,t){for(var r=[],n=0;n<t.length;n++)r[n]=U(e,t[n]);return r}function j(){Yl=!0}function X(){_l=!0}function Y(e,t,r){this.marker=e,this.from=t,this.to=r}function _(e,t){if(e)for(var r=0;r<e.length;++r){var n=e[r];if(n.marker==t)return n}}function $(e,t){for(var r,n=0;n<e.length;++n)e[n]!=t&&(r||(r=[])).push(e[n]);return r}function q(e,t){e.markedSpans=e.markedSpans?e.markedSpans.concat([t]):[t],t.marker.attachLine(e)}function Z(e,t,r){var n;if(e)for(var i=0;i<e.length;++i){var o=e[i],l=o.marker;if(null==o.from||(l.inclusiveLeft?o.from<=t:o.from<t)||o.from==t&&"bookmark"==l.type&&(!r||!o.marker.insertLeft)){var s=null==o.to||(l.inclusiveRight?o.to>=t:o.to>t);(n||(n=[])).push(new Y(l,o.from,s?null:o.to))}}return n}function Q(e,t,r){var n;if(e)for(var i=0;i<e.length;++i){var o=e[i],l=o.marker;if(null==o.to||(l.inclusiveRight?o.to>=t:o.to>t)||o.from==t&&"bookmark"==l.type&&(!r||o.marker.insertLeft)){var s=null==o.from||(l.inclusiveLeft?o.from<=t:o.from<t);(n||(n=[])).push(new Y(l,s?null:o.from-t,null==o.to?null:o.to-t))}}return n}function J(e,t){if(t.full)return null;var r=H(e,t.from.line)&&M(e,t.from.line).markedSpans,n=H(e,t.to.line)&&M(e,t.to.line).markedSpans;if(!r&&!n)return null;var i=t.from.ch,o=t.to.ch,l=0==P(t.from,t.to),s=Z(r,i,l),a=Q(n,o,l),u=1==t.text.length,c=g(t.text).length+(u?i:0);if(s)for(var f=0;f<s.length;++f){var h=s[f];if(null==h.to){var d=_(a,h.marker);d?u&&(h.to=null==d.to?null:d.to+c):h.to=i}}if(a)for(var p=0;p<a.length;++p){var v=a[p];null!=v.to&&(v.to+=c),null==v.from?_(s,v.marker)||(v.from=c,u&&(s||(s=[])).push(v)):(v.from+=c,u&&(s||(s=[])).push(v))}s&&(s=ee(s)),a&&a!=s&&(a=ee(a));var m=[s];if(!u){var y,b=t.text.length-2;if(b>0&&s)for(var w=0;w<s.length;++w)null==s[w].to&&(y||(y=[])).push(new Y(s[w].marker,null,null));for(var x=0;x<b;++x)m.push(y);m.push(a)}return m}function ee(e){for(var t=0;t<e.length;++t){var r=e[t];null!=r.from&&r.from==r.to&&!1!==r.marker.clearWhenEmpty&&e.splice(t--,1)}return e.length?e:null}function te(e,t,r){var n=null;if(e.iter(t.line,r.line+1,function(e){if(e.markedSpans)for(var t=0;t<e.markedSpans.length;++t){var r=e.markedSpans[t].marker;!r.readOnly||n&&-1!=h(n,r)||(n||(n=[])).push(r)}}),!n)return null;for(var i=[{from:t,to:r}],o=0;o<n.length;++o)for(var l=n[o],s=l.find(0),a=0;a<i.length;++a){var u=i[a];if(!(P(u.to,s.from)<0||P(u.from,s.to)>0)){var c=[a,1],f=P(u.from,s.from),d=P(u.to,s.to);(f<0||!l.inclusiveLeft&&!f)&&c.push({from:u.from,to:s.from}),(d>0||!l.inclusiveRight&&!d)&&c.push({from:s.to,to:u.to}),i.splice.apply(i,c),a+=c.length-3}}return i}function re(e){var t=e.markedSpans;if(t){for(var r=0;r<t.length;++r)t[r].marker.detachLine(e);e.markedSpans=null}}function ne(e,t){if(t){for(var r=0;r<t.length;++r)t[r].marker.attachLine(e);e.markedSpans=t}}function ie(e){return e.inclusiveLeft?-1:0}function oe(e){return e.inclusiveRight?1:0}function le(e,t){var r=e.lines.length-t.lines.length;if(0!=r)return r;var n=e.find(),i=t.find(),o=P(n.from,i.from)||ie(e)-ie(t);if(o)return-o;var l=P(n.to,i.to)||oe(e)-oe(t);return l||t.id-e.id}function se(e,t){var r,n=_l&&e.markedSpans;if(n)for(var i=void 0,o=0;o<n.length;++o)(i=n[o]).marker.collapsed&&null==(t?i.from:i.to)&&(!r||le(r,i.marker)<0)&&(r=i.marker);return r}function ae(e){return se(e,!0)}function ue(e){return se(e,!1)}function ce(e,t,r,n,i){var o=M(e,t),l=_l&&o.markedSpans;if(l)for(var s=0;s<l.length;++s){var a=l[s];if(a.marker.collapsed){var u=a.marker.find(0),c=P(u.from,r)||ie(a.marker)-ie(i),f=P(u.to,n)||oe(a.marker)-oe(i);if(!(c>=0&&f<=0||c<=0&&f>=0)&&(c<=0&&(a.marker.inclusiveRight&&i.inclusiveLeft?P(u.to,r)>=0:P(u.to,r)>0)||c>=0&&(a.marker.inclusiveRight&&i.inclusiveLeft?P(u.from,n)<=0:P(u.from,n)<0)))return!0}}}function fe(e){for(var t;t=ae(e);)e=t.find(-1,!0).line;return e}function he(e){for(var t;t=ue(e);)e=t.find(1,!0).line;return e}function de(e){for(var t,r;t=ue(e);)e=t.find(1,!0).line,(r||(r=[])).push(e);return r}function pe(e,t){var r=M(e,t),n=fe(r);return r==n?t:W(n)}function ge(e,t){if(t>e.lastLine())return t;var r,n=M(e,t);if(!ve(e,n))return t;for(;r=ue(n);)n=r.find(1,!0).line;return W(n)+1}function ve(e,t){var r=_l&&t.markedSpans;if(r)for(var n=void 0,i=0;i<r.length;++i)if((n=r[i]).marker.collapsed){if(null==n.from)return!0;if(!n.marker.widgetNode&&0==n.from&&n.marker.inclusiveLeft&&me(e,t,n))return!0}}function me(e,t,r){if(null==r.to){var n=r.marker.find(1,!0);return me(e,n.line,_(n.line.markedSpans,r.marker))}if(r.marker.inclusiveRight&&r.to==t.text.length)return!0;for(var i=void 0,o=0;o<t.markedSpans.length;++o)if((i=t.markedSpans[o]).marker.collapsed&&!i.marker.widgetNode&&i.from==r.to&&(null==i.to||i.to!=r.from)&&(i.marker.inclusiveLeft||r.marker.inclusiveRight)&&me(e,t,i))return!0}function ye(e){for(var t=0,r=(e=fe(e)).parent,n=0;n<r.lines.length;++n){var i=r.lines[n];if(i==e)break;t+=i.height}for(var o=r.parent;o;r=o,o=r.parent)for(var l=0;l<o.children.length;++l){var s=o.children[l];if(s==r)break;t+=s.height}return t}function be(e){if(0==e.height)return 0;for(var t,r=e.text.length,n=e;t=ae(n);){var i=t.find(0,!0);n=i.from.line,r+=i.from.ch-i.to.ch}for(n=e;t=ue(n);){var o=t.find(0,!0);r-=n.text.length-o.from.ch,r+=(n=o.to.line).text.length-o.to.ch}return r}function we(e){var t=e.display,r=e.doc;t.maxLine=M(r,r.first),t.maxLineLength=be(t.maxLine),t.maxLineChanged=!0,r.iter(function(e){var r=be(e);r>t.maxLineLength&&(t.maxLineLength=r,t.maxLine=e)})}function xe(e,t,r,n){if(!e)return n(t,r,"ltr",0);for(var i=!1,o=0;o<e.length;++o){var l=e[o];(l.from<r&&l.to>t||t==r&&l.to==t)&&(n(Math.max(l.from,t),Math.min(l.to,r),1==l.level?"rtl":"ltr",o),i=!0)}i||n(t,r,"ltr")}function Ce(e,t,r){var n;$l=null;for(var i=0;i<e.length;++i){var o=e[i];if(o.from<t&&o.to>t)return i;o.to==t&&(o.from!=o.to&&"before"==r?n=i:$l=i),o.from==t&&(o.from!=o.to&&"before"!=r?n=i:$l=i)}return null!=n?n:$l}function Se(e,t){var r=e.order;return null==r&&(r=e.order=ql(e.text,t)),r}function Le(e,t){return e._handlers&&e._handlers[t]||Zl}function ke(e,t,r){if(e.removeEventListener)e.removeEventListener(t,r,!1);else if(e.detachEvent)e.detachEvent("on"+t,r);else{var n=e._handlers,i=n&&n[t];if(i){var o=h(i,r);o>-1&&(n[t]=i.slice(0,o).concat(i.slice(o+1)))}}}function Te(e,t){var r=Le(e,t);if(r.length)for(var n=Array.prototype.slice.call(arguments,2),i=0;i<r.length;++i)r[i].apply(null,n)}function Me(e,t,r){return"string"==typeof t&&(t={type:t,preventDefault:function(){this.defaultPrevented=!0}}),Te(e,r||t.type,e,t),He(t)||t.codemirrorIgnore}function Ne(e){var t=e._handlers&&e._handlers.cursorActivity;if(t)for(var r=e.curOp.cursorActivityHandlers||(e.curOp.cursorActivityHandlers=[]),n=0;n<t.length;++n)-1==h(r,t[n])&&r.push(t[n])}function Oe(e,t){return Le(e,t).length>0}function Ae(e){e.prototype.on=function(e,t){Ql(this,e,t)},e.prototype.off=function(e,t){ke(this,e,t)}}function We(e){e.preventDefault?e.preventDefault():e.returnValue=!1}function De(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}function He(e){return null!=e.defaultPrevented?e.defaultPrevented:0==e.returnValue}function Fe(e){We(e),De(e)}function Ee(e){return e.target||e.srcElement}function Pe(e){var t=e.which;return null==t&&(1&e.button?t=1:2&e.button?t=3:4&e.button&&(t=2)),Ml&&e.ctrlKey&&1==t&&(t=3),t}function Ie(e){if(null==Il){var t=n("span","​");r(e,n("span",[t,document.createTextNode("x")])),0!=e.firstChild.offsetHeight&&(Il=t.offsetWidth<=1&&t.offsetHeight>2&&!(gl&&vl<8))}var i=Il?n("span","​"):n("span"," ",null,"display: inline-block; width: 1px; margin-right: -1px");return i.setAttribute("cm-text",""),i}function ze(e){if(null!=zl)return zl;var n=r(e,document.createTextNode("AخA")),i=Wl(n,0,1).getBoundingClientRect(),o=Wl(n,1,2).getBoundingClientRect();return t(e),!(!i||i.left==i.right)&&(zl=o.right-i.right<3)}function Re(e){if(null!=ns)return ns;var t=r(e,n("span","x")),i=t.getBoundingClientRect(),o=Wl(t,0,1).getBoundingClientRect();return ns=Math.abs(i.left-o.left)>1}function Be(e,t){arguments.length>2&&(t.dependencies=Array.prototype.slice.call(arguments,2)),is[e]=t}function Ge(e){if("string"==typeof e&&os.hasOwnProperty(e))e=os[e];else if(e&&"string"==typeof e.name&&os.hasOwnProperty(e.name)){var t=os[e.name];"string"==typeof t&&(t={name:t}),(e=b(t,e)).name=t.name}else{if("string"==typeof e&&/^[\w\-]+\/[\w\-]+\+xml$/.test(e))return Ge("application/xml");if("string"==typeof e&&/^[\w\-]+\/[\w\-]+\+json$/.test(e))return Ge("application/json")}return"string"==typeof e?{name:e}:e||{name:"null"}}function Ue(e,t){t=Ge(t);var r=is[t.name];if(!r)return Ue(e,"text/plain");var n=r(e,t);if(ls.hasOwnProperty(t.name)){var i=ls[t.name];for(var o in i)i.hasOwnProperty(o)&&(n.hasOwnProperty(o)&&(n["_"+o]=n[o]),n[o]=i[o])}if(n.name=t.name,t.helperType&&(n.helperType=t.helperType),t.modeProps)for(var l in t.modeProps)n[l]=t.modeProps[l];return n}function Ve(e,t){c(t,ls.hasOwnProperty(e)?ls[e]:ls[e]={})}function Ke(e,t){if(!0===t)return t;if(e.copyState)return e.copyState(t);var r={};for(var n in t){var i=t[n];i instanceof Array&&(i=i.concat([])),r[n]=i}return r}function je(e,t){for(var r;e.innerMode&&(r=e.innerMode(t))&&r.mode!=e;)t=r.state,e=r.mode;return r||{mode:e,state:t}}function Xe(e,t,r){return!e.startState||e.startState(t,r)}function Ye(e,t,r,n){var i=[e.state.modeGen],o={};tt(e,t.text,e.doc.mode,r,function(e,t){return i.push(e,t)},o,n);for(var l=r.state,s=0;s<e.state.overlays.length;++s)!function(n){var l=e.state.overlays[n],s=1,a=0;r.state=!0,tt(e,t.text,l.mode,r,function(e,t){for(var r=s;a<e;){var n=i[s];n>e&&i.splice(s,1,e,i[s+1],n),s+=2,a=Math.min(e,n)}if(t)if(l.opaque)i.splice(r,s-r,e,"overlay "+t),s=r+2;else for(;r<s;r+=2){var o=i[r+1];i[r+1]=(o?o+" ":"")+"overlay "+t}},o)}(s);return r.state=l,{styles:i,classes:o.bgClass||o.textClass?o:null}}function _e(e,t,r){if(!t.styles||t.styles[0]!=e.state.modeGen){var n=$e(e,W(t)),i=t.text.length>e.options.maxHighlightLength&&Ke(e.doc.mode,n.state),o=Ye(e,t,n);i&&(n.state=i),t.stateAfter=n.save(!i),t.styles=o.styles,o.classes?t.styleClasses=o.classes:t.styleClasses&&(t.styleClasses=null),r===e.doc.highlightFrontier&&(e.doc.modeFrontier=Math.max(e.doc.modeFrontier,++e.doc.highlightFrontier))}return t.styles}function $e(e,t,r){var n=e.doc,i=e.display;if(!n.mode.startState)return new us(n,!0,t);var o=rt(e,t,r),l=o>n.first&&M(n,o-1).stateAfter,s=l?us.fromSaved(n,l,o):new us(n,Xe(n.mode),o);return n.iter(o,t,function(r){qe(e,r.text,s);var n=s.line;r.stateAfter=n==t-1||n%5==0||n>=i.viewFrom&&n<i.viewTo?s.save():null,s.nextLine()}),r&&(n.modeFrontier=s.line),s}function qe(e,t,r,n){var i=e.doc.mode,o=new ss(t,e.options.tabSize,r);for(o.start=o.pos=n||0,""==t&&Ze(i,r.state);!o.eol();)Qe(i,o,r.state),o.start=o.pos}function Ze(e,t){if(e.blankLine)return e.blankLine(t);if(e.innerMode){var r=je(e,t);return r.mode.blankLine?r.mode.blankLine(r.state):void 0}}function Qe(e,t,r,n){for(var i=0;i<10;i++){n&&(n[0]=je(e,r).mode);var o=e.token(t,r);if(t.pos>t.start)return o}throw new Error("Mode "+e.name+" failed to advance stream.")}function Je(e,t,r,n){var i,o,l=e.doc,s=l.mode,a=M(l,(t=U(l,t)).line),u=$e(e,t.line,r),c=new ss(a.text,e.options.tabSize,u);for(n&&(o=[]);(n||c.pos<t.ch)&&!c.eol();)c.start=c.pos,i=Qe(s,c,u.state),n&&o.push(new cs(c,i,Ke(l.mode,u.state)));return n?o:new cs(c,i,u.state)}function et(e,t){if(e)for(;;){var r=e.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!r)break;e=e.slice(0,r.index)+e.slice(r.index+r[0].length);var n=r[1]?"bgClass":"textClass";null==t[n]?t[n]=r[2]:new RegExp("(?:^|s)"+r[2]+"(?:$|s)").test(t[n])||(t[n]+=" "+r[2])}return e}function tt(e,t,r,n,i,o,l){var s=r.flattenSpans;null==s&&(s=e.options.flattenSpans);var a,u=0,c=null,f=new ss(t,e.options.tabSize,n),h=e.options.addModeClass&&[null];for(""==t&&et(Ze(r,n.state),o);!f.eol();){if(f.pos>e.options.maxHighlightLength?(s=!1,l&&qe(e,t,n,f.pos),f.pos=t.length,a=null):a=et(Qe(r,f,n.state,h),o),h){var d=h[0].name;d&&(a="m-"+(a?d+" "+a:d))}if(!s||c!=a){for(;u<f.start;)i(u=Math.min(f.start,u+5e3),c);c=a}f.start=f.pos}for(;u<f.pos;){var p=Math.min(f.pos,u+5e3);i(p,c),u=p}}function rt(e,t,r){for(var n,i,o=e.doc,l=r?-1:t-(e.doc.mode.innerMode?1e3:100),s=t;s>l;--s){if(s<=o.first)return o.first;var a=M(o,s-1),u=a.stateAfter;if(u&&(!r||s+(u instanceof as?u.lookAhead:0)<=o.modeFrontier))return s;var c=f(a.text,null,e.options.tabSize);(null==i||n>c)&&(i=s-1,n=c)}return i}function nt(e,t){if(e.modeFrontier=Math.min(e.modeFrontier,t),!(e.highlightFrontier<t-10)){for(var r=e.first,n=t-1;n>r;n--){var i=M(e,n).stateAfter;if(i&&(!(i instanceof as)||n+i.lookAhead<t)){r=n+1;break}}e.highlightFrontier=Math.min(e.highlightFrontier,r)}}function it(e,t,r,n){e.text=t,e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null),null!=e.order&&(e.order=null),re(e),ne(e,r);var i=n?n(e):1;i!=e.height&&A(e,i)}function ot(e){e.parent=null,re(e)}function lt(e,t){if(!e||/^\s*$/.test(e))return null;var r=t.addModeClass?ps:ds;return r[e]||(r[e]=e.replace(/\S+/g,"cm-$&"))}function st(e,t){var r=i("span",null,null,ml?"padding-right: .1px":null),n={pre:i("pre",[r],"CodeMirror-line"),content:r,col:0,pos:0,cm:e,trailingSpace:!1,splitSpaces:(gl||ml)&&e.getOption("lineWrapping")};t.measure={};for(var o=0;o<=(t.rest?t.rest.length:0);o++){var l=o?t.rest[o-1]:t.line,s=void 0;n.pos=0,n.addToken=ut,ze(e.display.measure)&&(s=Se(l,e.doc.direction))&&(n.addToken=ft(n.addToken,s)),n.map=[],dt(l,n,_e(e,l,t!=e.display.externalMeasured&&W(l))),l.styleClasses&&(l.styleClasses.bgClass&&(n.bgClass=a(l.styleClasses.bgClass,n.bgClass||"")),l.styleClasses.textClass&&(n.textClass=a(l.styleClasses.textClass,n.textClass||""))),0==n.map.length&&n.map.push(0,0,n.content.appendChild(Ie(e.display.measure))),0==o?(t.measure.map=n.map,t.measure.cache={}):((t.measure.maps||(t.measure.maps=[])).push(n.map),(t.measure.caches||(t.measure.caches=[])).push({}))}if(ml){var u=n.content.lastChild;(/\bcm-tab\b/.test(u.className)||u.querySelector&&u.querySelector(".cm-tab"))&&(n.content.className="cm-tab-wrap-hack")}return Te(e,"renderLine",e,t.line,n.pre),n.pre.className&&(n.textClass=a(n.pre.className,n.textClass||"")),n}function at(e){var t=n("span","•","cm-invalidchar");return t.title="\\u"+e.charCodeAt(0).toString(16),t.setAttribute("aria-label",t.title),t}function ut(e,t,r,i,o,l,s){if(t){var a,u=e.splitSpaces?ct(t,e.trailingSpace):t,c=e.cm.state.specialChars,f=!1;if(c.test(t)){a=document.createDocumentFragment();for(var h=0;;){c.lastIndex=h;var d=c.exec(t),g=d?d.index-h:t.length-h;if(g){var v=document.createTextNode(u.slice(h,h+g));gl&&vl<9?a.appendChild(n("span",[v])):a.appendChild(v),e.map.push(e.pos,e.pos+g,v),e.col+=g,e.pos+=g}if(!d)break;h+=g+1;var m=void 0;if("\t"==d[0]){var y=e.cm.options.tabSize,b=y-e.col%y;(m=a.appendChild(n("span",p(b),"cm-tab"))).setAttribute("role","presentation"),m.setAttribute("cm-text","\t"),e.col+=b}else"\r"==d[0]||"\n"==d[0]?((m=a.appendChild(n("span","\r"==d[0]?"␍":"␤","cm-invalidchar"))).setAttribute("cm-text",d[0]),e.col+=1):((m=e.cm.options.specialCharPlaceholder(d[0])).setAttribute("cm-text",d[0]),gl&&vl<9?a.appendChild(n("span",[m])):a.appendChild(m),e.col+=1);e.map.push(e.pos,e.pos+1,m),e.pos++}}else e.col+=t.length,a=document.createTextNode(u),e.map.push(e.pos,e.pos+t.length,a),gl&&vl<9&&(f=!0),e.pos+=t.length;if(e.trailingSpace=32==u.charCodeAt(t.length-1),r||i||o||f||s){var w=r||"";i&&(w+=i),o&&(w+=o);var x=n("span",[a],w,s);return l&&(x.title=l),e.content.appendChild(x)}e.content.appendChild(a)}}function ct(e,t){if(e.length>1&&!/  /.test(e))return e;for(var r=t,n="",i=0;i<e.length;i++){var o=e.charAt(i);" "!=o||!r||i!=e.length-1&&32!=e.charCodeAt(i+1)||(o=" "),n+=o,r=" "==o}return n}function ft(e,t){return function(r,n,i,o,l,s,a){i=i?i+" cm-force-border":"cm-force-border";for(var u=r.pos,c=u+n.length;;){for(var f=void 0,h=0;h<t.length&&!((f=t[h]).to>u&&f.from<=u);h++);if(f.to>=c)return e(r,n,i,o,l,s,a);e(r,n.slice(0,f.to-u),i,o,null,s,a),o=null,n=n.slice(f.to-u),u=f.to}}}function ht(e,t,r,n){var i=!n&&r.widgetNode;i&&e.map.push(e.pos,e.pos+t,i),!n&&e.cm.display.input.needsContentAttribute&&(i||(i=e.content.appendChild(document.createElement("span"))),i.setAttribute("cm-marker",r.id)),i&&(e.cm.display.input.setUneditable(i),e.content.appendChild(i)),e.pos+=t,e.trailingSpace=!1}function dt(e,t,r){var n=e.markedSpans,i=e.text,o=0;if(n)for(var l,s,a,u,c,f,h,d=i.length,p=0,g=1,v="",m=0;;){if(m==p){a=u=c=f=s="",h=null,m=1/0;for(var y=[],b=void 0,w=0;w<n.length;++w){var x=n[w],C=x.marker;"bookmark"==C.type&&x.from==p&&C.widgetNode?y.push(C):x.from<=p&&(null==x.to||x.to>p||C.collapsed&&x.to==p&&x.from==p)?(null!=x.to&&x.to!=p&&m>x.to&&(m=x.to,u=""),C.className&&(a+=" "+C.className),C.css&&(s=(s?s+";":"")+C.css),C.startStyle&&x.from==p&&(c+=" "+C.startStyle),C.endStyle&&x.to==m&&(b||(b=[])).push(C.endStyle,x.to),C.title&&!f&&(f=C.title),C.collapsed&&(!h||le(h.marker,C)<0)&&(h=x)):x.from>p&&m>x.from&&(m=x.from)}if(b)for(var S=0;S<b.length;S+=2)b[S+1]==m&&(u+=" "+b[S]);if(!h||h.from==p)for(var L=0;L<y.length;++L)ht(t,0,y[L]);if(h&&(h.from||0)==p){if(ht(t,(null==h.to?d+1:h.to)-p,h.marker,null==h.from),null==h.to)return;h.to==p&&(h=!1)}}if(p>=d)break;for(var k=Math.min(d,m);;){if(v){var T=p+v.length;if(!h){var M=T>k?v.slice(0,k-p):v;t.addToken(t,M,l?l+a:a,c,p+M.length==m?u:"",f,s)}if(T>=k){v=v.slice(k-p),p=k;break}p=T,c=""}v=i.slice(o,o=r[g++]),l=lt(r[g++],t.cm.options)}}else for(var N=1;N<r.length;N+=2)t.addToken(t,i.slice(o,o=r[N]),lt(r[N+1],t.cm.options))}function pt(e,t,r){this.line=t,this.rest=de(t),this.size=this.rest?W(g(this.rest))-r+1:1,this.node=this.text=null,this.hidden=ve(e,t)}function gt(e,t,r){for(var n,i=[],o=t;o<r;o=n){var l=new pt(e.doc,M(e.doc,o),o);n=o+l.size,i.push(l)}return i}function vt(e){gs?gs.ops.push(e):e.ownsGroup=gs={ops:[e],delayedCallbacks:[]}}function mt(e){var t=e.delayedCallbacks,r=0;do{for(;r<t.length;r++)t[r].call(null);for(var n=0;n<e.ops.length;n++){var i=e.ops[n];if(i.cursorActivityHandlers)for(;i.cursorActivityCalled<i.cursorActivityHandlers.length;)i.cursorActivityHandlers[i.cursorActivityCalled++].call(null,i.cm)}}while(r<t.length)}function yt(e,t){var r=e.ownsGroup;if(r)try{mt(r)}finally{gs=null,t(r)}}function bt(e,t){var r=Le(e,t);if(r.length){var n,i=Array.prototype.slice.call(arguments,2);gs?n=gs.delayedCallbacks:vs?n=vs:(n=vs=[],setTimeout(wt,0));for(var o=0;o<r.length;++o)!function(e){n.push(function(){return r[e].apply(null,i)})}(o)}}function wt(){var e=vs;vs=null;for(var t=0;t<e.length;++t)e[t]()}function xt(e,t,r,n){for(var i=0;i<t.changes.length;i++){var o=t.changes[i];"text"==o?kt(e,t):"gutter"==o?Mt(e,t,r,n):"class"==o?Tt(e,t):"widget"==o&&Nt(e,t,n)}t.changes=null}function Ct(e){return e.node==e.text&&(e.node=n("div",null,null,"position: relative"),e.text.parentNode&&e.text.parentNode.replaceChild(e.node,e.text),e.node.appendChild(e.text),gl&&vl<8&&(e.node.style.zIndex=2)),e.node}function St(e,t){var r=t.bgClass?t.bgClass+" "+(t.line.bgClass||""):t.line.bgClass;if(r&&(r+=" CodeMirror-linebackground"),t.background)r?t.background.className=r:(t.background.parentNode.removeChild(t.background),t.background=null);else if(r){var i=Ct(t);t.background=i.insertBefore(n("div",null,r),i.firstChild),e.display.input.setUneditable(t.background)}}function Lt(e,t){var r=e.display.externalMeasured;return r&&r.line==t.line?(e.display.externalMeasured=null,t.measure=r.measure,r.built):st(e,t)}function kt(e,t){var r=t.text.className,n=Lt(e,t);t.text==t.node&&(t.node=n.pre),t.text.parentNode.replaceChild(n.pre,t.text),t.text=n.pre,n.bgClass!=t.bgClass||n.textClass!=t.textClass?(t.bgClass=n.bgClass,t.textClass=n.textClass,Tt(e,t)):r&&(t.text.className=r)}function Tt(e,t){St(e,t),t.line.wrapClass?Ct(t).className=t.line.wrapClass:t.node!=t.text&&(t.node.className="");var r=t.textClass?t.textClass+" "+(t.line.textClass||""):t.line.textClass;t.text.className=r||""}function Mt(e,t,r,i){if(t.gutter&&(t.node.removeChild(t.gutter),t.gutter=null),t.gutterBackground&&(t.node.removeChild(t.gutterBackground),t.gutterBackground=null),t.line.gutterClass){var o=Ct(t);t.gutterBackground=n("div",null,"CodeMirror-gutter-background "+t.line.gutterClass,"left: "+(e.options.fixedGutter?i.fixedPos:-i.gutterTotalWidth)+"px; width: "+i.gutterTotalWidth+"px"),e.display.input.setUneditable(t.gutterBackground),o.insertBefore(t.gutterBackground,t.text)}var l=t.line.gutterMarkers;if(e.options.lineNumbers||l){var s=Ct(t),a=t.gutter=n("div",null,"CodeMirror-gutter-wrapper","left: "+(e.options.fixedGutter?i.fixedPos:-i.gutterTotalWidth)+"px");if(e.display.input.setUneditable(a),s.insertBefore(a,t.text),t.line.gutterClass&&(a.className+=" "+t.line.gutterClass),!e.options.lineNumbers||l&&l["CodeMirror-linenumbers"]||(t.lineNumber=a.appendChild(n("div",F(e.options,r),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+i.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+e.display.lineNumInnerWidth+"px"))),l)for(var u=0;u<e.options.gutters.length;++u){var c=e.options.gutters[u],f=l.hasOwnProperty(c)&&l[c];f&&a.appendChild(n("div",[f],"CodeMirror-gutter-elt","left: "+i.gutterLeft[c]+"px; width: "+i.gutterWidth[c]+"px"))}}}function Nt(e,t,r){t.alignable&&(t.alignable=null);for(var n=t.node.firstChild,i=void 0;n;n=i)i=n.nextSibling,"CodeMirror-linewidget"==n.className&&t.node.removeChild(n);At(e,t,r)}function Ot(e,t,r,n){var i=Lt(e,t);return t.text=t.node=i.pre,i.bgClass&&(t.bgClass=i.bgClass),i.textClass&&(t.textClass=i.textClass),Tt(e,t),Mt(e,t,r,n),At(e,t,n),t.node}function At(e,t,r){if(Wt(e,t.line,t,r,!0),t.rest)for(var n=0;n<t.rest.length;n++)Wt(e,t.rest[n],t,r,!1)}function Wt(e,t,r,i,o){if(t.widgets)for(var l=Ct(r),s=0,a=t.widgets;s<a.length;++s){var u=a[s],c=n("div",[u.node],"CodeMirror-linewidget");u.handleMouseEvents||c.setAttribute("cm-ignore-events","true"),Dt(u,c,r,i),e.display.input.setUneditable(c),o&&u.above?l.insertBefore(c,r.gutter||r.text):l.appendChild(c),bt(u,"redraw")}}function Dt(e,t,r,n){if(e.noHScroll){(r.alignable||(r.alignable=[])).push(t);var i=n.wrapperWidth;t.style.left=n.fixedPos+"px",e.coverGutter||(i-=n.gutterTotalWidth,t.style.paddingLeft=n.gutterTotalWidth+"px"),t.style.width=i+"px"}e.coverGutter&&(t.style.zIndex=5,t.style.position="relative",e.noHScroll||(t.style.marginLeft=-n.gutterTotalWidth+"px"))}function Ht(e){if(null!=e.height)return e.height;var t=e.doc.cm;if(!t)return 0;if(!o(document.body,e.node)){var i="position: relative;";e.coverGutter&&(i+="margin-left: -"+t.display.gutters.offsetWidth+"px;"),e.noHScroll&&(i+="width: "+t.display.wrapper.clientWidth+"px;"),r(t.display.measure,n("div",[e.node],null,i))}return e.height=e.node.parentNode.offsetHeight}function Ft(e,t){for(var r=Ee(t);r!=e.wrapper;r=r.parentNode)if(!r||1==r.nodeType&&"true"==r.getAttribute("cm-ignore-events")||r.parentNode==e.sizer&&r!=e.mover)return!0}function Et(e){return e.lineSpace.offsetTop}function Pt(e){return e.mover.offsetHeight-e.lineSpace.offsetHeight}function It(e){if(e.cachedPaddingH)return e.cachedPaddingH;var t=r(e.measure,n("pre","x")),i=window.getComputedStyle?window.getComputedStyle(t):t.currentStyle,o={left:parseInt(i.paddingLeft),right:parseInt(i.paddingRight)};return isNaN(o.left)||isNaN(o.right)||(e.cachedPaddingH=o),o}function zt(e){return Rl-e.display.nativeBarWidth}function Rt(e){return e.display.scroller.clientWidth-zt(e)-e.display.barWidth}function Bt(e){return e.display.scroller.clientHeight-zt(e)-e.display.barHeight}function Gt(e,t,r){var n=e.options.lineWrapping,i=n&&Rt(e);if(!t.measure.heights||n&&t.measure.width!=i){var o=t.measure.heights=[];if(n){t.measure.width=i;for(var l=t.text.firstChild.getClientRects(),s=0;s<l.length-1;s++){var a=l[s],u=l[s+1];Math.abs(a.bottom-u.bottom)>2&&o.push((a.bottom+u.top)/2-r.top)}}o.push(r.bottom-r.top)}}function Ut(e,t,r){if(e.line==t)return{map:e.measure.map,cache:e.measure.cache};for(var n=0;n<e.rest.length;n++)if(e.rest[n]==t)return{map:e.measure.maps[n],cache:e.measure.caches[n]};for(var i=0;i<e.rest.length;i++)if(W(e.rest[i])>r)return{map:e.measure.maps[i],cache:e.measure.caches[i],before:!0}}function Vt(e,t){var n=W(t=fe(t)),i=e.display.externalMeasured=new pt(e.doc,t,n);i.lineN=n;var o=i.built=st(e,i);return i.text=o.pre,r(e.display.lineMeasure,o.pre),i}function Kt(e,t,r,n){return Yt(e,Xt(e,t),r,n)}function jt(e,t){if(t>=e.display.viewFrom&&t<e.display.viewTo)return e.display.view[Lr(e,t)];var r=e.display.externalMeasured;return r&&t>=r.lineN&&t<r.lineN+r.size?r:void 0}function Xt(e,t){var r=W(t),n=jt(e,r);n&&!n.text?n=null:n&&n.changes&&(xt(e,n,r,br(e)),e.curOp.forceUpdate=!0),n||(n=Vt(e,t));var i=Ut(n,t,r);return{line:t,view:n,rect:null,map:i.map,cache:i.cache,before:i.before,hasHeights:!1}}function Yt(e,t,r,n,i){t.before&&(r=-1);var o,l=r+(n||"");return t.cache.hasOwnProperty(l)?o=t.cache[l]:(t.rect||(t.rect=t.view.text.getBoundingClientRect()),t.hasHeights||(Gt(e,t.view,t.rect),t.hasHeights=!0),(o=qt(e,t,r,n)).bogus||(t.cache[l]=o)),{left:o.left,right:o.right,top:i?o.rtop:o.top,bottom:i?o.rbottom:o.bottom}}function _t(e,t,r){for(var n,i,o,l,s,a,u=0;u<e.length;u+=3)if(s=e[u],a=e[u+1],t<s?(i=0,o=1,l="left"):t<a?o=(i=t-s)+1:(u==e.length-3||t==a&&e[u+3]>t)&&(i=(o=a-s)-1,t>=a&&(l="right")),null!=i){if(n=e[u+2],s==a&&r==(n.insertLeft?"left":"right")&&(l=r),"left"==r&&0==i)for(;u&&e[u-2]==e[u-3]&&e[u-1].insertLeft;)n=e[2+(u-=3)],l="left";if("right"==r&&i==a-s)for(;u<e.length-3&&e[u+3]==e[u+4]&&!e[u+5].insertLeft;)n=e[(u+=3)+2],l="right";break}return{node:n,start:i,end:o,collapse:l,coverStart:s,coverEnd:a}}function $t(e,t){var r=ms;if("left"==t)for(var n=0;n<e.length&&(r=e[n]).left==r.right;n++);else for(var i=e.length-1;i>=0&&(r=e[i]).left==r.right;i--);return r}function qt(e,t,r,n){var i,o=_t(t.map,r,n),l=o.node,s=o.start,a=o.end,u=o.collapse;if(3==l.nodeType){for(var c=0;c<4;c++){for(;s&&S(t.line.text.charAt(o.coverStart+s));)--s;for(;o.coverStart+a<o.coverEnd&&S(t.line.text.charAt(o.coverStart+a));)++a;if((i=gl&&vl<9&&0==s&&a==o.coverEnd-o.coverStart?l.parentNode.getBoundingClientRect():$t(Wl(l,s,a).getClientRects(),n)).left||i.right||0==s)break;a=s,s-=1,u="right"}gl&&vl<11&&(i=Zt(e.display.measure,i))}else{s>0&&(u=n="right");var f;i=e.options.lineWrapping&&(f=l.getClientRects()).length>1?f["right"==n?f.length-1:0]:l.getBoundingClientRect()}if(gl&&vl<9&&!s&&(!i||!i.left&&!i.right)){var h=l.parentNode.getClientRects()[0];i=h?{left:h.left,right:h.left+yr(e.display),top:h.top,bottom:h.bottom}:ms}for(var d=i.top-t.rect.top,p=i.bottom-t.rect.top,g=(d+p)/2,v=t.view.measure.heights,m=0;m<v.length-1&&!(g<v[m]);m++);var y=m?v[m-1]:0,b=v[m],w={left:("right"==u?i.right:i.left)-t.rect.left,right:("left"==u?i.left:i.right)-t.rect.left,top:y,bottom:b};return i.left||i.right||(w.bogus=!0),e.options.singleCursorHeightPerLine||(w.rtop=d,w.rbottom=p),w}function Zt(e,t){if(!window.screen||null==screen.logicalXDPI||screen.logicalXDPI==screen.deviceXDPI||!Re(e))return t;var r=screen.logicalXDPI/screen.deviceXDPI,n=screen.logicalYDPI/screen.deviceYDPI;return{left:t.left*r,right:t.right*r,top:t.top*n,bottom:t.bottom*n}}function Qt(e){if(e.measure&&(e.measure.cache={},e.measure.heights=null,e.rest))for(var t=0;t<e.rest.length;t++)e.measure.caches[t]={}}function Jt(e){e.display.externalMeasure=null,t(e.display.lineMeasure);for(var r=0;r<e.display.view.length;r++)Qt(e.display.view[r])}function er(e){Jt(e),e.display.cachedCharWidth=e.display.cachedTextHeight=e.display.cachedPaddingH=null,e.options.lineWrapping||(e.display.maxLineChanged=!0),e.display.lineNumChars=null}function tr(){return bl&&kl?-(document.body.getBoundingClientRect().left-parseInt(getComputedStyle(document.body).marginLeft)):window.pageXOffset||(document.documentElement||document.body).scrollLeft}function rr(){return bl&&kl?-(document.body.getBoundingClientRect().top-parseInt(getComputedStyle(document.body).marginTop)):window.pageYOffset||(document.documentElement||document.body).scrollTop}function nr(e){var t=0;if(e.widgets)for(var r=0;r<e.widgets.length;++r)e.widgets[r].above&&(t+=Ht(e.widgets[r]));return t}function ir(e,t,r,n,i){if(!i){var o=nr(t);r.top+=o,r.bottom+=o}if("line"==n)return r;n||(n="local");var l=ye(t);if("local"==n?l+=Et(e.display):l-=e.display.viewOffset,"page"==n||"window"==n){var s=e.display.lineSpace.getBoundingClientRect();l+=s.top+("window"==n?0:rr());var a=s.left+("window"==n?0:tr());r.left+=a,r.right+=a}return r.top+=l,r.bottom+=l,r}function or(e,t,r){if("div"==r)return t;var n=t.left,i=t.top;if("page"==r)n-=tr(),i-=rr();else if("local"==r||!r){var o=e.display.sizer.getBoundingClientRect();n+=o.left,i+=o.top}var l=e.display.lineSpace.getBoundingClientRect();return{left:n-l.left,top:i-l.top}}function lr(e,t,r,n,i){return n||(n=M(e.doc,t.line)),ir(e,n,Kt(e,n,t.ch,i),r)}function sr(e,t,r,n,i,o){function l(t,l){var s=Yt(e,i,t,l?"right":"left",o);return l?s.left=s.right:s.right=s.left,ir(e,n,s,r)}function s(e,t,r){var n=1==a[t].level;return l(r?e-1:e,n!=r)}n=n||M(e.doc,t.line),i||(i=Xt(e,n));var a=Se(n,e.doc.direction),u=t.ch,c=t.sticky;if(u>=n.text.length?(u=n.text.length,c="before"):u<=0&&(u=0,c="after"),!a)return l("before"==c?u-1:u,"before"==c);var f=Ce(a,u,c),h=$l,d=s(u,f,"before"==c);return null!=h&&(d.other=s(u,h,"before"!=c)),d}function ar(e,t){var r=0;t=U(e.doc,t),e.options.lineWrapping||(r=yr(e.display)*t.ch);var n=M(e.doc,t.line),i=ye(n)+Et(e.display);return{left:r,right:r,top:i,bottom:i+n.height}}function ur(e,t,r,n,i){var o=E(e,t,r);return o.xRel=i,n&&(o.outside=!0),o}function cr(e,t,r){var n=e.doc;if((r+=e.display.viewOffset)<0)return ur(n.first,0,null,!0,-1);var i=D(n,r),o=n.first+n.size-1;if(i>o)return ur(n.first+n.size-1,M(n,o).text.length,null,!0,1);t<0&&(t=0);for(var l=M(n,i);;){var s=pr(e,l,i,t,r),a=ue(l),u=a&&a.find(0,!0);if(!a||!(s.ch>u.from.ch||s.ch==u.from.ch&&s.xRel>0))return s;i=W(l=u.to.line)}}function fr(e,t,r,n){n-=nr(t);var i=t.text.length,o=k(function(t){return Yt(e,r,t-1).bottom<=n},i,0);return i=k(function(t){return Yt(e,r,t).top>n},o,i),{begin:o,end:i}}function hr(e,t,r,n){return r||(r=Xt(e,t)),fr(e,t,r,ir(e,t,Yt(e,r,n),"line").top)}function dr(e,t,r,n){return!(e.bottom<=r)&&(e.top>r||(n?e.left:e.right)>t)}function pr(e,t,r,n,i){i-=ye(t);var o=Xt(e,t),l=nr(t),s=0,a=t.text.length,u=!0,c=Se(t,e.doc.direction);if(c){var f=(e.options.lineWrapping?vr:gr)(e,t,r,o,c,n,i);s=(u=1!=f.level)?f.from:f.to-1,a=u?f.to:f.from-1}var h,d,p=null,g=null,v=k(function(t){var r=Yt(e,o,t);return r.top+=l,r.bottom+=l,!!dr(r,n,i,!1)&&(r.top<=i&&r.left<=n&&(p=t,g=r),!0)},s,a),m=!1;if(g){var y=n-g.left<g.right-n,b=y==u;v=p+(b?0:1),d=b?"after":"before",h=y?g.left:g.right}else{u||v!=a&&v!=s||v++,d=0==v?"after":v==t.text.length?"before":Yt(e,o,v-(u?1:0)).bottom+l<=i==u?"after":"before";var w=sr(e,E(r,v,d),"line",t,o);h=w.left,m=i<w.top||i>=w.bottom}return v=L(t.text,v,1),ur(r,v,d,m,n-h)}function gr(e,t,r,n,i,o,l){var s=k(function(s){var a=i[s],u=1!=a.level;return dr(sr(e,E(r,u?a.to:a.from,u?"before":"after"),"line",t,n),o,l,!0)},0,i.length-1),a=i[s];if(s>0){var u=1!=a.level,c=sr(e,E(r,u?a.from:a.to,u?"after":"before"),"line",t,n);dr(c,o,l,!0)&&c.top>l&&(a=i[s-1])}return a}function vr(e,t,r,n,i,o,l){for(var s=fr(e,t,n,l),a=s.begin,u=s.end,c=null,f=null,h=0;h<i.length;h++){var d=i[h];if(!(d.from>=u||d.to<=a)){var p=Yt(e,n,1!=d.level?Math.min(u,d.to)-1:Math.max(a,d.from)).right,g=p<o?o-p+1e9:p-o;(!c||f>g)&&(c=d,f=g)}}return c||(c=i[i.length-1]),c.from<a&&(c={from:a,to:c.to,level:c.level}),c.to>u&&(c={from:c.from,to:u,level:c.level}),c}function mr(e){if(null!=e.cachedTextHeight)return e.cachedTextHeight;if(null==hs){hs=n("pre");for(var i=0;i<49;++i)hs.appendChild(document.createTextNode("x")),hs.appendChild(n("br"));hs.appendChild(document.createTextNode("x"))}r(e.measure,hs);var o=hs.offsetHeight/50;return o>3&&(e.cachedTextHeight=o),t(e.measure),o||1}function yr(e){if(null!=e.cachedCharWidth)return e.cachedCharWidth;var t=n("span","xxxxxxxxxx"),i=n("pre",[t]);r(e.measure,i);var o=t.getBoundingClientRect(),l=(o.right-o.left)/10;return l>2&&(e.cachedCharWidth=l),l||10}function br(e){for(var t=e.display,r={},n={},i=t.gutters.clientLeft,o=t.gutters.firstChild,l=0;o;o=o.nextSibling,++l)r[e.options.gutters[l]]=o.offsetLeft+o.clientLeft+i,n[e.options.gutters[l]]=o.clientWidth;return{fixedPos:wr(t),gutterTotalWidth:t.gutters.offsetWidth,gutterLeft:r,gutterWidth:n,wrapperWidth:t.wrapper.clientWidth}}function wr(e){return e.scroller.getBoundingClientRect().left-e.sizer.getBoundingClientRect().left}function xr(e){var t=mr(e.display),r=e.options.lineWrapping,n=r&&Math.max(5,e.display.scroller.clientWidth/yr(e.display)-3);return function(i){if(ve(e.doc,i))return 0;var o=0;if(i.widgets)for(var l=0;l<i.widgets.length;l++)i.widgets[l].height&&(o+=i.widgets[l].height);return r?o+(Math.ceil(i.text.length/n)||1)*t:o+t}}function Cr(e){var t=e.doc,r=xr(e);t.iter(function(e){var t=r(e);t!=e.height&&A(e,t)})}function Sr(e,t,r,n){var i=e.display;if(!r&&"true"==Ee(t).getAttribute("cm-not-content"))return null;var o,l,s=i.lineSpace.getBoundingClientRect();try{o=t.clientX-s.left,l=t.clientY-s.top}catch(t){return null}var a,u=cr(e,o,l);if(n&&1==u.xRel&&(a=M(e.doc,u.line).text).length==u.ch){var c=f(a,a.length,e.options.tabSize)-a.length;u=E(u.line,Math.max(0,Math.round((o-It(e.display).left)/yr(e.display))-c))}return u}function Lr(e,t){if(t>=e.display.viewTo)return null;if((t-=e.display.viewFrom)<0)return null;for(var r=e.display.view,n=0;n<r.length;n++)if((t-=r[n].size)<0)return n}function kr(e){e.display.input.showSelection(e.display.input.prepareSelection())}function Tr(e,t){void 0===t&&(t=!0);for(var r=e.doc,n={},i=n.cursors=document.createDocumentFragment(),o=n.selection=document.createDocumentFragment(),l=0;l<r.sel.ranges.length;l++)if(t||l!=r.sel.primIndex){var s=r.sel.ranges[l];if(!(s.from().line>=e.display.viewTo||s.to().line<e.display.viewFrom)){var a=s.empty();(a||e.options.showCursorWhenSelecting)&&Mr(e,s.head,i),a||Or(e,s,o)}}return n}function Mr(e,t,r){var i=sr(e,t,"div",null,null,!e.options.singleCursorHeightPerLine),o=r.appendChild(n("div"," ","CodeMirror-cursor"));if(o.style.left=i.left+"px",o.style.top=i.top+"px",o.style.height=Math.max(0,i.bottom-i.top)*e.options.cursorHeight+"px",i.other){var l=r.appendChild(n("div"," ","CodeMirror-cursor CodeMirror-secondarycursor"));l.style.display="",l.style.left=i.other.left+"px",l.style.top=i.other.top+"px",l.style.height=.85*(i.other.bottom-i.other.top)+"px"}}function Nr(e,t){return e.top-t.top||e.left-t.left}function Or(e,t,r){function i(e,t,r,i){t<0&&(t=0),t=Math.round(t),i=Math.round(i),a.appendChild(n("div",null,"CodeMirror-selected","position: absolute; left: "+e+"px;\n                             top: "+t+"px; width: "+(null==r?f-e:r)+"px;\n                             height: "+(i-t)+"px"))}function o(t,r,n){function o(r,n){return lr(e,E(t,r),"div",u,n)}var l,a,u=M(s,t),h=u.text.length,d=Se(u,s.direction);return xe(d,r||0,null==n?h:n,function(t,s,p,g){var v=o(t,"ltr"==p?"left":"right"),m=o(s-1,"ltr"==p?"right":"left");if("ltr"==p){var y=null==r&&0==t?c:v.left,b=null==n&&s==h?f:m.right;m.top-v.top<=3?i(y,m.top,b-y,m.bottom):(i(y,v.top,null,v.bottom),v.bottom<m.top&&i(c,v.bottom,null,m.top),i(c,m.top,m.right,m.bottom))}else if(t<s){var w=null==r&&0==t?f:v.right,x=null==n&&s==h?c:m.left;if(m.top-v.top<=3)i(x,m.top,w-x,m.bottom);else{var C=c;if(g){var S=hr(e,u,null,t).end;C=o(S-(/\s/.test(u.text.charAt(S-1))?2:1),"left").left}i(C,v.top,w-C,v.bottom),v.bottom<m.top&&i(c,v.bottom,null,m.top);var L=null;d.length,L=o(hr(e,u,null,s).begin,"right").right-x,i(x,m.top,L,m.bottom)}}(!l||Nr(v,l)<0)&&(l=v),Nr(m,l)<0&&(l=m),(!a||Nr(v,a)<0)&&(a=v),Nr(m,a)<0&&(a=m)}),{start:l,end:a}}var l=e.display,s=e.doc,a=document.createDocumentFragment(),u=It(e.display),c=u.left,f=Math.max(l.sizerWidth,Rt(e)-l.sizer.offsetLeft)-u.right,h=t.from(),d=t.to();if(h.line==d.line)o(h.line,h.ch,d.ch);else{var p=M(s,h.line),g=M(s,d.line),v=fe(p)==fe(g),m=o(h.line,h.ch,v?p.text.length+1:null).end,y=o(d.line,v?0:null,d.ch).start;v&&(m.top<y.top-2?(i(m.right,m.top,null,m.bottom),i(c,y.top,y.left,y.bottom)):i(m.right,m.top,y.left-m.right,m.bottom)),m.bottom<y.top&&i(c,m.bottom,null,y.top)}r.appendChild(a)}function Ar(e){if(e.state.focused){var t=e.display;clearInterval(t.blinker);var r=!0;t.cursorDiv.style.visibility="",e.options.cursorBlinkRate>0?t.blinker=setInterval(function(){return t.cursorDiv.style.visibility=(r=!r)?"":"hidden"},e.options.cursorBlinkRate):e.options.cursorBlinkRate<0&&(t.cursorDiv.style.visibility="hidden")}}function Wr(e){e.state.focused||(e.display.input.focus(),Hr(e))}function Dr(e){e.state.delayingBlurEvent=!0,setTimeout(function(){e.state.delayingBlurEvent&&(e.state.delayingBlurEvent=!1,Fr(e))},100)}function Hr(e,t){e.state.delayingBlurEvent&&(e.state.delayingBlurEvent=!1),"nocursor"!=e.options.readOnly&&(e.state.focused||(Te(e,"focus",e,t),e.state.focused=!0,s(e.display.wrapper,"CodeMirror-focused"),e.curOp||e.display.selForContextMenu==e.doc.sel||(e.display.input.reset(),ml&&setTimeout(function(){return e.display.input.reset(!0)},20)),e.display.input.receivedFocus()),Ar(e))}function Fr(e,t){e.state.delayingBlurEvent||(e.state.focused&&(Te(e,"blur",e,t),e.state.focused=!1,Fl(e.display.wrapper,"CodeMirror-focused")),clearInterval(e.display.blinker),setTimeout(function(){e.state.focused||(e.display.shift=!1)},150))}function Er(e){for(var t=e.display,r=t.lineDiv.offsetTop,n=0;n<t.view.length;n++){var i=t.view[n],o=void 0;if(!i.hidden){if(gl&&vl<8){var l=i.node.offsetTop+i.node.offsetHeight;o=l-r,r=l}else{var s=i.node.getBoundingClientRect();o=s.bottom-s.top}var a=i.line.height-o;if(o<2&&(o=mr(t)),(a>.005||a<-.005)&&(A(i.line,o),Pr(i.line),i.rest))for(var u=0;u<i.rest.length;u++)Pr(i.rest[u])}}}function Pr(e){if(e.widgets)for(var t=0;t<e.widgets.length;++t)e.widgets[t].height=e.widgets[t].node.parentNode.offsetHeight}function Ir(e,t,r){var n=r&&null!=r.top?Math.max(0,r.top):e.scroller.scrollTop;n=Math.floor(n-Et(e));var i=r&&null!=r.bottom?r.bottom:n+e.wrapper.clientHeight,o=D(t,n),l=D(t,i);if(r&&r.ensure){var s=r.ensure.from.line,a=r.ensure.to.line;s<o?(o=s,l=D(t,ye(M(t,s))+e.wrapper.clientHeight)):Math.min(a,t.lastLine())>=l&&(o=D(t,ye(M(t,a))-e.wrapper.clientHeight),l=a)}return{from:o,to:Math.max(l,o+1)}}function zr(e){var t=e.display,r=t.view;if(t.alignWidgets||t.gutters.firstChild&&e.options.fixedGutter){for(var n=wr(t)-t.scroller.scrollLeft+e.doc.scrollLeft,i=t.gutters.offsetWidth,o=n+"px",l=0;l<r.length;l++)if(!r[l].hidden){e.options.fixedGutter&&(r[l].gutter&&(r[l].gutter.style.left=o),r[l].gutterBackground&&(r[l].gutterBackground.style.left=o));var s=r[l].alignable;if(s)for(var a=0;a<s.length;a++)s[a].style.left=o}e.options.fixedGutter&&(t.gutters.style.left=n+i+"px")}}function Rr(e){if(!e.options.lineNumbers)return!1;var t=e.doc,r=F(e.options,t.first+t.size-1),i=e.display;if(r.length!=i.lineNumChars){var o=i.measure.appendChild(n("div",[n("div",r)],"CodeMirror-linenumber CodeMirror-gutter-elt")),l=o.firstChild.offsetWidth,s=o.offsetWidth-l;return i.lineGutter.style.width="",i.lineNumInnerWidth=Math.max(l,i.lineGutter.offsetWidth-s)+1,i.lineNumWidth=i.lineNumInnerWidth+s,i.lineNumChars=i.lineNumInnerWidth?r.length:-1,i.lineGutter.style.width=i.lineNumWidth+"px",Wn(e),!0}return!1}function Br(e,t){if(!Me(e,"scrollCursorIntoView")){var r=e.display,i=r.sizer.getBoundingClientRect(),o=null;if(t.top+i.top<0?o=!0:t.bottom+i.top>(window.innerHeight||document.documentElement.clientHeight)&&(o=!1),null!=o&&!Sl){var l=n("div","​",null,"position: absolute;\n                         top: "+(t.top-r.viewOffset-Et(e.display))+"px;\n                         height: "+(t.bottom-t.top+zt(e)+r.barHeight)+"px;\n                         left: "+t.left+"px; width: "+Math.max(2,t.right-t.left)+"px;");e.display.lineSpace.appendChild(l),l.scrollIntoView(o),e.display.lineSpace.removeChild(l)}}}function Gr(e,t,r,n){null==n&&(n=0);var i;e.options.lineWrapping||t!=r||(r="before"==(t=t.ch?E(t.line,"before"==t.sticky?t.ch-1:t.ch,"after"):t).sticky?E(t.line,t.ch+1,"before"):t);for(var o=0;o<5;o++){var l=!1,s=sr(e,t),a=r&&r!=t?sr(e,r):s,u=Vr(e,i={left:Math.min(s.left,a.left),top:Math.min(s.top,a.top)-n,right:Math.max(s.left,a.left),bottom:Math.max(s.bottom,a.bottom)+n}),c=e.doc.scrollTop,f=e.doc.scrollLeft;if(null!=u.scrollTop&&(qr(e,u.scrollTop),Math.abs(e.doc.scrollTop-c)>1&&(l=!0)),null!=u.scrollLeft&&(Qr(e,u.scrollLeft),Math.abs(e.doc.scrollLeft-f)>1&&(l=!0)),!l)break}return i}function Ur(e,t){var r=Vr(e,t);null!=r.scrollTop&&qr(e,r.scrollTop),null!=r.scrollLeft&&Qr(e,r.scrollLeft)}function Vr(e,t){var r=e.display,n=mr(e.display);t.top<0&&(t.top=0);var i=e.curOp&&null!=e.curOp.scrollTop?e.curOp.scrollTop:r.scroller.scrollTop,o=Bt(e),l={};t.bottom-t.top>o&&(t.bottom=t.top+o);var s=e.doc.height+Pt(r),a=t.top<n,u=t.bottom>s-n;if(t.top<i)l.scrollTop=a?0:t.top;else if(t.bottom>i+o){var c=Math.min(t.top,(u?s:t.bottom)-o);c!=i&&(l.scrollTop=c)}var f=e.curOp&&null!=e.curOp.scrollLeft?e.curOp.scrollLeft:r.scroller.scrollLeft,h=Rt(e)-(e.options.fixedGutter?r.gutters.offsetWidth:0),d=t.right-t.left>h;return d&&(t.right=t.left+h),t.left<10?l.scrollLeft=0:t.left<f?l.scrollLeft=Math.max(0,t.left-(d?0:10)):t.right>h+f-3&&(l.scrollLeft=t.right+(d?0:10)-h),l}function Kr(e,t){null!=t&&(_r(e),e.curOp.scrollTop=(null==e.curOp.scrollTop?e.doc.scrollTop:e.curOp.scrollTop)+t)}function jr(e){_r(e);var t=e.getCursor();e.curOp.scrollToPos={from:t,to:t,margin:e.options.cursorScrollMargin}}function Xr(e,t,r){null==t&&null==r||_r(e),null!=t&&(e.curOp.scrollLeft=t),null!=r&&(e.curOp.scrollTop=r)}function Yr(e,t){_r(e),e.curOp.scrollToPos=t}function _r(e){var t=e.curOp.scrollToPos;t&&(e.curOp.scrollToPos=null,$r(e,ar(e,t.from),ar(e,t.to),t.margin))}function $r(e,t,r,n){var i=Vr(e,{left:Math.min(t.left,r.left),top:Math.min(t.top,r.top)-n,right:Math.max(t.right,r.right),bottom:Math.max(t.bottom,r.bottom)+n});Xr(e,i.scrollLeft,i.scrollTop)}function qr(e,t){Math.abs(e.doc.scrollTop-t)<2||(fl||On(e,{top:t}),Zr(e,t,!0),fl&&On(e),Cn(e,100))}function Zr(e,t,r){t=Math.min(e.display.scroller.scrollHeight-e.display.scroller.clientHeight,t),(e.display.scroller.scrollTop!=t||r)&&(e.doc.scrollTop=t,e.display.scrollbars.setScrollTop(t),e.display.scroller.scrollTop!=t&&(e.display.scroller.scrollTop=t))}function Qr(e,t,r,n){t=Math.min(t,e.display.scroller.scrollWidth-e.display.scroller.clientWidth),(r?t==e.doc.scrollLeft:Math.abs(e.doc.scrollLeft-t)<2)&&!n||(e.doc.scrollLeft=t,zr(e),e.display.scroller.scrollLeft!=t&&(e.display.scroller.scrollLeft=t),e.display.scrollbars.setScrollLeft(t))}function Jr(e){var t=e.display,r=t.gutters.offsetWidth,n=Math.round(e.doc.height+Pt(e.display));return{clientHeight:t.scroller.clientHeight,viewHeight:t.wrapper.clientHeight,scrollWidth:t.scroller.scrollWidth,clientWidth:t.scroller.clientWidth,viewWidth:t.wrapper.clientWidth,barLeft:e.options.fixedGutter?r:0,docHeight:n,scrollHeight:n+zt(e)+t.barHeight,nativeBarWidth:t.nativeBarWidth,gutterWidth:r}}function en(e,t){t||(t=Jr(e));var r=e.display.barWidth,n=e.display.barHeight;tn(e,t);for(var i=0;i<4&&r!=e.display.barWidth||n!=e.display.barHeight;i++)r!=e.display.barWidth&&e.options.lineWrapping&&Er(e),tn(e,Jr(e)),r=e.display.barWidth,n=e.display.barHeight}function tn(e,t){var r=e.display,n=r.scrollbars.update(t);r.sizer.style.paddingRight=(r.barWidth=n.right)+"px",r.sizer.style.paddingBottom=(r.barHeight=n.bottom)+"px",r.heightForcer.style.borderBottom=n.bottom+"px solid transparent",n.right&&n.bottom?(r.scrollbarFiller.style.display="block",r.scrollbarFiller.style.height=n.bottom+"px",r.scrollbarFiller.style.width=n.right+"px"):r.scrollbarFiller.style.display="",n.bottom&&e.options.coverGutterNextToScrollbar&&e.options.fixedGutter?(r.gutterFiller.style.display="block",r.gutterFiller.style.height=n.bottom+"px",r.gutterFiller.style.width=t.gutterWidth+"px"):r.gutterFiller.style.display=""}function rn(e){e.display.scrollbars&&(e.display.scrollbars.clear(),e.display.scrollbars.addClass&&Fl(e.display.wrapper,e.display.scrollbars.addClass)),e.display.scrollbars=new ws[e.options.scrollbarStyle](function(t){e.display.wrapper.insertBefore(t,e.display.scrollbarFiller),Ql(t,"mousedown",function(){e.state.focused&&setTimeout(function(){return e.display.input.focus()},0)}),t.setAttribute("cm-not-content","true")},function(t,r){"horizontal"==r?Qr(e,t):qr(e,t)},e),e.display.scrollbars.addClass&&s(e.display.wrapper,e.display.scrollbars.addClass)}function nn(e){e.curOp={cm:e,viewChanged:!1,startHeight:e.doc.height,forceUpdate:!1,updateInput:null,typing:!1,changeObjs:null,cursorActivityHandlers:null,cursorActivityCalled:0,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,focus:!1,id:++xs},vt(e.curOp)}function on(e){yt(e.curOp,function(e){for(var t=0;t<e.ops.length;t++)e.ops[t].cm.curOp=null;ln(e)})}function ln(e){for(var t=e.ops,r=0;r<t.length;r++)sn(t[r]);for(var n=0;n<t.length;n++)an(t[n]);for(var i=0;i<t.length;i++)un(t[i]);for(var o=0;o<t.length;o++)cn(t[o]);for(var l=0;l<t.length;l++)fn(t[l])}function sn(e){var t=e.cm,r=t.display;Ln(t),e.updateMaxLine&&we(t),e.mustUpdate=e.viewChanged||e.forceUpdate||null!=e.scrollTop||e.scrollToPos&&(e.scrollToPos.from.line<r.viewFrom||e.scrollToPos.to.line>=r.viewTo)||r.maxLineChanged&&t.options.lineWrapping,e.update=e.mustUpdate&&new Cs(t,e.mustUpdate&&{top:e.scrollTop,ensure:e.scrollToPos},e.forceUpdate)}function an(e){e.updatedDisplay=e.mustUpdate&&Mn(e.cm,e.update)}function un(e){var t=e.cm,r=t.display;e.updatedDisplay&&Er(t),e.barMeasure=Jr(t),r.maxLineChanged&&!t.options.lineWrapping&&(e.adjustWidthTo=Kt(t,r.maxLine,r.maxLine.text.length).left+3,t.display.sizerWidth=e.adjustWidthTo,e.barMeasure.scrollWidth=Math.max(r.scroller.clientWidth,r.sizer.offsetLeft+e.adjustWidthTo+zt(t)+t.display.barWidth),e.maxScrollLeft=Math.max(0,r.sizer.offsetLeft+e.adjustWidthTo-Rt(t))),(e.updatedDisplay||e.selectionChanged)&&(e.preparedSelection=r.input.prepareSelection())}function cn(e){var t=e.cm;null!=e.adjustWidthTo&&(t.display.sizer.style.minWidth=e.adjustWidthTo+"px",e.maxScrollLeft<t.doc.scrollLeft&&Qr(t,Math.min(t.display.scroller.scrollLeft,e.maxScrollLeft),!0),t.display.maxLineChanged=!1);var r=e.focus&&e.focus==l();e.preparedSelection&&t.display.input.showSelection(e.preparedSelection,r),(e.updatedDisplay||e.startHeight!=t.doc.height)&&en(t,e.barMeasure),e.updatedDisplay&&Dn(t,e.barMeasure),e.selectionChanged&&Ar(t),t.state.focused&&e.updateInput&&t.display.input.reset(e.typing),r&&Wr(e.cm)}function fn(e){var t=e.cm,r=t.display,n=t.doc;e.updatedDisplay&&Nn(t,e.update),null==r.wheelStartX||null==e.scrollTop&&null==e.scrollLeft&&!e.scrollToPos||(r.wheelStartX=r.wheelStartY=null),null!=e.scrollTop&&Zr(t,e.scrollTop,e.forceScroll),null!=e.scrollLeft&&Qr(t,e.scrollLeft,!0,!0),e.scrollToPos&&Br(t,Gr(t,U(n,e.scrollToPos.from),U(n,e.scrollToPos.to),e.scrollToPos.margin));var i=e.maybeHiddenMarkers,o=e.maybeUnhiddenMarkers;if(i)for(var l=0;l<i.length;++l)i[l].lines.length||Te(i[l],"hide");if(o)for(var s=0;s<o.length;++s)o[s].lines.length&&Te(o[s],"unhide");r.wrapper.offsetHeight&&(n.scrollTop=t.display.scroller.scrollTop),e.changeObjs&&Te(t,"changes",t,e.changeObjs),e.update&&e.update.finish()}function hn(e,t){if(e.curOp)return t();nn(e);try{return t()}finally{on(e)}}function dn(e,t){return function(){if(e.curOp)return t.apply(e,arguments);nn(e);try{return t.apply(e,arguments)}finally{on(e)}}}function pn(e){return function(){if(this.curOp)return e.apply(this,arguments);nn(this);try{return e.apply(this,arguments)}finally{on(this)}}}function gn(e){return function(){var t=this.cm;if(!t||t.curOp)return e.apply(this,arguments);nn(t);try{return e.apply(this,arguments)}finally{on(t)}}}function vn(e,t,r,n){null==t&&(t=e.doc.first),null==r&&(r=e.doc.first+e.doc.size),n||(n=0);var i=e.display;if(n&&r<i.viewTo&&(null==i.updateLineNumbers||i.updateLineNumbers>t)&&(i.updateLineNumbers=t),e.curOp.viewChanged=!0,t>=i.viewTo)_l&&pe(e.doc,t)<i.viewTo&&yn(e);else if(r<=i.viewFrom)_l&&ge(e.doc,r+n)>i.viewFrom?yn(e):(i.viewFrom+=n,i.viewTo+=n);else if(t<=i.viewFrom&&r>=i.viewTo)yn(e);else if(t<=i.viewFrom){var o=bn(e,r,r+n,1);o?(i.view=i.view.slice(o.index),i.viewFrom=o.lineN,i.viewTo+=n):yn(e)}else if(r>=i.viewTo){var l=bn(e,t,t,-1);l?(i.view=i.view.slice(0,l.index),i.viewTo=l.lineN):yn(e)}else{var s=bn(e,t,t,-1),a=bn(e,r,r+n,1);s&&a?(i.view=i.view.slice(0,s.index).concat(gt(e,s.lineN,a.lineN)).concat(i.view.slice(a.index)),i.viewTo+=n):yn(e)}var u=i.externalMeasured;u&&(r<u.lineN?u.lineN+=n:t<u.lineN+u.size&&(i.externalMeasured=null))}function mn(e,t,r){e.curOp.viewChanged=!0;var n=e.display,i=e.display.externalMeasured;if(i&&t>=i.lineN&&t<i.lineN+i.size&&(n.externalMeasured=null),!(t<n.viewFrom||t>=n.viewTo)){var o=n.view[Lr(e,t)];if(null!=o.node){var l=o.changes||(o.changes=[]);-1==h(l,r)&&l.push(r)}}}function yn(e){e.display.viewFrom=e.display.viewTo=e.doc.first,e.display.view=[],e.display.viewOffset=0}function bn(e,t,r,n){var i,o=Lr(e,t),l=e.display.view;if(!_l||r==e.doc.first+e.doc.size)return{index:o,lineN:r};for(var s=e.display.viewFrom,a=0;a<o;a++)s+=l[a].size;if(s!=t){if(n>0){if(o==l.length-1)return null;i=s+l[o].size-t,o++}else i=s-t;t+=i,r+=i}for(;pe(e.doc,r)!=r;){if(o==(n<0?0:l.length-1))return null;r+=n*l[o-(n<0?1:0)].size,o+=n}return{index:o,lineN:r}}function wn(e,t,r){var n=e.display;0==n.view.length||t>=n.viewTo||r<=n.viewFrom?(n.view=gt(e,t,r),n.viewFrom=t):(n.viewFrom>t?n.view=gt(e,t,n.viewFrom).concat(n.view):n.viewFrom<t&&(n.view=n.view.slice(Lr(e,t))),n.viewFrom=t,n.viewTo<r?n.view=n.view.concat(gt(e,n.viewTo,r)):n.viewTo>r&&(n.view=n.view.slice(0,Lr(e,r)))),n.viewTo=r}function xn(e){for(var t=e.display.view,r=0,n=0;n<t.length;n++){var i=t[n];i.hidden||i.node&&!i.changes||++r}return r}function Cn(e,t){e.doc.highlightFrontier<e.display.viewTo&&e.state.highlight.set(t,u(Sn,e))}function Sn(e){var t=e.doc;if(!(t.highlightFrontier>=e.display.viewTo)){var r=+new Date+e.options.workTime,n=$e(e,t.highlightFrontier),i=[];t.iter(n.line,Math.min(t.first+t.size,e.display.viewTo+500),function(o){if(n.line>=e.display.viewFrom){var l=o.styles,s=o.text.length>e.options.maxHighlightLength?Ke(t.mode,n.state):null,a=Ye(e,o,n,!0);s&&(n.state=s),o.styles=a.styles;var u=o.styleClasses,c=a.classes;c?o.styleClasses=c:u&&(o.styleClasses=null);for(var f=!l||l.length!=o.styles.length||u!=c&&(!u||!c||u.bgClass!=c.bgClass||u.textClass!=c.textClass),h=0;!f&&h<l.length;++h)f=l[h]!=o.styles[h];f&&i.push(n.line),o.stateAfter=n.save(),n.nextLine()}else o.text.length<=e.options.maxHighlightLength&&qe(e,o.text,n),o.stateAfter=n.line%5==0?n.save():null,n.nextLine();if(+new Date>r)return Cn(e,e.options.workDelay),!0}),t.highlightFrontier=n.line,t.modeFrontier=Math.max(t.modeFrontier,n.line),i.length&&hn(e,function(){for(var t=0;t<i.length;t++)mn(e,i[t],"text")})}}function Ln(e){var t=e.display;!t.scrollbarsClipped&&t.scroller.offsetWidth&&(t.nativeBarWidth=t.scroller.offsetWidth-t.scroller.clientWidth,t.heightForcer.style.height=zt(e)+"px",t.sizer.style.marginBottom=-t.nativeBarWidth+"px",t.sizer.style.borderRightWidth=zt(e)+"px",t.scrollbarsClipped=!0)}function kn(e){if(e.hasFocus())return null;var t=l();if(!t||!o(e.display.lineDiv,t))return null;var r={activeElt:t};if(window.getSelection){var n=window.getSelection();n.anchorNode&&n.extend&&o(e.display.lineDiv,n.anchorNode)&&(r.anchorNode=n.anchorNode,r.anchorOffset=n.anchorOffset,r.focusNode=n.focusNode,r.focusOffset=n.focusOffset)}return r}function Tn(e){if(e&&e.activeElt&&e.activeElt!=l()&&(e.activeElt.focus(),e.anchorNode&&o(document.body,e.anchorNode)&&o(document.body,e.focusNode))){var t=window.getSelection(),r=document.createRange();r.setEnd(e.anchorNode,e.anchorOffset),r.collapse(!1),t.removeAllRanges(),t.addRange(r),t.extend(e.focusNode,e.focusOffset)}}function Mn(e,r){var n=e.display,i=e.doc;if(r.editorIsHidden)return yn(e),!1;if(!r.force&&r.visible.from>=n.viewFrom&&r.visible.to<=n.viewTo&&(null==n.updateLineNumbers||n.updateLineNumbers>=n.viewTo)&&n.renderedView==n.view&&0==xn(e))return!1;Rr(e)&&(yn(e),r.dims=br(e));var o=i.first+i.size,l=Math.max(r.visible.from-e.options.viewportMargin,i.first),s=Math.min(o,r.visible.to+e.options.viewportMargin);n.viewFrom<l&&l-n.viewFrom<20&&(l=Math.max(i.first,n.viewFrom)),n.viewTo>s&&n.viewTo-s<20&&(s=Math.min(o,n.viewTo)),_l&&(l=pe(e.doc,l),s=ge(e.doc,s));var a=l!=n.viewFrom||s!=n.viewTo||n.lastWrapHeight!=r.wrapperHeight||n.lastWrapWidth!=r.wrapperWidth;wn(e,l,s),n.viewOffset=ye(M(e.doc,n.viewFrom)),e.display.mover.style.top=n.viewOffset+"px";var u=xn(e);if(!a&&0==u&&!r.force&&n.renderedView==n.view&&(null==n.updateLineNumbers||n.updateLineNumbers>=n.viewTo))return!1;var c=kn(e);return u>4&&(n.lineDiv.style.display="none"),An(e,n.updateLineNumbers,r.dims),u>4&&(n.lineDiv.style.display=""),n.renderedView=n.view,Tn(c),t(n.cursorDiv),t(n.selectionDiv),n.gutters.style.height=n.sizer.style.minHeight=0,a&&(n.lastWrapHeight=r.wrapperHeight,n.lastWrapWidth=r.wrapperWidth,Cn(e,400)),n.updateLineNumbers=null,!0}function Nn(e,t){for(var r=t.viewport,n=!0;(n&&e.options.lineWrapping&&t.oldDisplayWidth!=Rt(e)||(r&&null!=r.top&&(r={top:Math.min(e.doc.height+Pt(e.display)-Bt(e),r.top)}),t.visible=Ir(e.display,e.doc,r),!(t.visible.from>=e.display.viewFrom&&t.visible.to<=e.display.viewTo)))&&Mn(e,t);n=!1){Er(e);var i=Jr(e);kr(e),en(e,i),Dn(e,i),t.force=!1}t.signal(e,"update",e),e.display.viewFrom==e.display.reportedViewFrom&&e.display.viewTo==e.display.reportedViewTo||(t.signal(e,"viewportChange",e,e.display.viewFrom,e.display.viewTo),e.display.reportedViewFrom=e.display.viewFrom,e.display.reportedViewTo=e.display.viewTo)}function On(e,t){var r=new Cs(e,t);if(Mn(e,r)){Er(e),Nn(e,r);var n=Jr(e);kr(e),en(e,n),Dn(e,n),r.finish()}}function An(e,r,n){function i(t){var r=t.nextSibling;return ml&&Ml&&e.display.currentWheelTarget==t?t.style.display="none":t.parentNode.removeChild(t),r}for(var o=e.display,l=e.options.lineNumbers,s=o.lineDiv,a=s.firstChild,u=o.view,c=o.viewFrom,f=0;f<u.length;f++){var d=u[f];if(d.hidden);else if(d.node&&d.node.parentNode==s){for(;a!=d.node;)a=i(a);var p=l&&null!=r&&r<=c&&d.lineNumber;d.changes&&(h(d.changes,"gutter")>-1&&(p=!1),xt(e,d,c,n)),p&&(t(d.lineNumber),d.lineNumber.appendChild(document.createTextNode(F(e.options,c)))),a=d.node.nextSibling}else{var g=Ot(e,d,c,n);s.insertBefore(g,a)}c+=d.size}for(;a;)a=i(a)}function Wn(e){var t=e.display.gutters.offsetWidth;e.display.sizer.style.marginLeft=t+"px"}function Dn(e,t){e.display.sizer.style.minHeight=t.docHeight+"px",e.display.heightForcer.style.top=t.docHeight+"px",e.display.gutters.style.height=t.docHeight+e.display.barHeight+zt(e)+"px"}function Hn(e){var r=e.display.gutters,i=e.options.gutters;t(r);for(var o=0;o<i.length;++o){var l=i[o],s=r.appendChild(n("div",null,"CodeMirror-gutter "+l));"CodeMirror-linenumbers"==l&&(e.display.lineGutter=s,s.style.width=(e.display.lineNumWidth||1)+"px")}r.style.display=o?"":"none",Wn(e)}function Fn(e){var t=h(e.gutters,"CodeMirror-linenumbers");-1==t&&e.lineNumbers?e.gutters=e.gutters.concat(["CodeMirror-linenumbers"]):t>-1&&!e.lineNumbers&&(e.gutters=e.gutters.slice(0),e.gutters.splice(t,1))}function En(e){var t=e.wheelDeltaX,r=e.wheelDeltaY;return null==t&&e.detail&&e.axis==e.HORIZONTAL_AXIS&&(t=e.detail),null==r&&e.detail&&e.axis==e.VERTICAL_AXIS?r=e.detail:null==r&&(r=e.wheelDelta),{x:t,y:r}}function Pn(e){var t=En(e);return t.x*=Ls,t.y*=Ls,t}function In(e,t){var r=En(t),n=r.x,i=r.y,o=e.display,l=o.scroller,s=l.scrollWidth>l.clientWidth,a=l.scrollHeight>l.clientHeight;if(n&&s||i&&a){if(i&&Ml&&ml)e:for(var u=t.target,c=o.view;u!=l;u=u.parentNode)for(var f=0;f<c.length;f++)if(c[f].node==u){e.display.currentWheelTarget=u;break e}if(n&&!fl&&!wl&&null!=Ls)return i&&a&&qr(e,Math.max(0,l.scrollTop+i*Ls)),Qr(e,Math.max(0,l.scrollLeft+n*Ls)),(!i||i&&a)&&We(t),void(o.wheelStartX=null);if(i&&null!=Ls){var h=i*Ls,d=e.doc.scrollTop,p=d+o.wrapper.clientHeight;h<0?d=Math.max(0,d+h-50):p=Math.min(e.doc.height,p+h+50),On(e,{top:d,bottom:p})}Ss<20&&(null==o.wheelStartX?(o.wheelStartX=l.scrollLeft,o.wheelStartY=l.scrollTop,o.wheelDX=n,o.wheelDY=i,setTimeout(function(){if(null!=o.wheelStartX){var e=l.scrollLeft-o.wheelStartX,t=l.scrollTop-o.wheelStartY,r=t&&o.wheelDY&&t/o.wheelDY||e&&o.wheelDX&&e/o.wheelDX;o.wheelStartX=o.wheelStartY=null,r&&(Ls=(Ls*Ss+r)/(Ss+1),++Ss)}},200)):(o.wheelDX+=n,o.wheelDY+=i))}}function zn(e,t){var r=e[t];e.sort(function(e,t){return P(e.from(),t.from())}),t=h(e,r);for(var n=1;n<e.length;n++){var i=e[n],o=e[n-1];if(P(o.to(),i.from())>=0){var l=B(o.from(),i.from()),s=R(o.to(),i.to()),a=o.empty()?i.from()==i.head:o.from()==o.head;n<=t&&--t,e.splice(--n,2,new Ts(a?s:l,a?l:s))}}return new ks(e,t)}function Rn(e,t){return new ks([new Ts(e,t||e)],0)}function Bn(e){return e.text?E(e.from.line+e.text.length-1,g(e.text).length+(1==e.text.length?e.from.ch:0)):e.to}function Gn(e,t){if(P(e,t.from)<0)return e;if(P(e,t.to)<=0)return Bn(t);var r=e.line+t.text.length-(t.to.line-t.from.line)-1,n=e.ch;return e.line==t.to.line&&(n+=Bn(t).ch-t.to.ch),E(r,n)}function Un(e,t){for(var r=[],n=0;n<e.sel.ranges.length;n++){var i=e.sel.ranges[n];r.push(new Ts(Gn(i.anchor,t),Gn(i.head,t)))}return zn(r,e.sel.primIndex)}function Vn(e,t,r){return e.line==t.line?E(r.line,e.ch-t.ch+r.ch):E(r.line+(e.line-t.line),e.ch)}function Kn(e,t,r){for(var n=[],i=E(e.first,0),o=i,l=0;l<t.length;l++){var s=t[l],a=Vn(s.from,i,o),u=Vn(Bn(s),i,o);if(i=s.to,o=u,"around"==r){var c=e.sel.ranges[l],f=P(c.head,c.anchor)<0;n[l]=new Ts(f?u:a,f?a:u)}else n[l]=new Ts(a,a)}return new ks(n,e.sel.primIndex)}function jn(e){e.doc.mode=Ue(e.options,e.doc.modeOption),Xn(e)}function Xn(e){e.doc.iter(function(e){e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null)}),e.doc.modeFrontier=e.doc.highlightFrontier=e.doc.first,Cn(e,100),e.state.modeGen++,e.curOp&&vn(e)}function Yn(e,t){return 0==t.from.ch&&0==t.to.ch&&""==g(t.text)&&(!e.cm||e.cm.options.wholeLineUpdateBefore)}function _n(e,t,r,n){function i(e){return r?r[e]:null}function o(e,r,i){it(e,r,i,n),bt(e,"change",e,t)}function l(e,t){for(var r=[],o=e;o<t;++o)r.push(new fs(u[o],i(o),n));return r}var s=t.from,a=t.to,u=t.text,c=M(e,s.line),f=M(e,a.line),h=g(u),d=i(u.length-1),p=a.line-s.line;if(t.full)e.insert(0,l(0,u.length)),e.remove(u.length,e.size-u.length);else if(Yn(e,t)){var v=l(0,u.length-1);o(f,f.text,d),p&&e.remove(s.line,p),v.length&&e.insert(s.line,v)}else if(c==f)if(1==u.length)o(c,c.text.slice(0,s.ch)+h+c.text.slice(a.ch),d);else{var m=l(1,u.length-1);m.push(new fs(h+c.text.slice(a.ch),d,n)),o(c,c.text.slice(0,s.ch)+u[0],i(0)),e.insert(s.line+1,m)}else if(1==u.length)o(c,c.text.slice(0,s.ch)+u[0]+f.text.slice(a.ch),i(0)),e.remove(s.line+1,p);else{o(c,c.text.slice(0,s.ch)+u[0],i(0)),o(f,h+f.text.slice(a.ch),d);var y=l(1,u.length-1);p>1&&e.remove(s.line+1,p-1),e.insert(s.line+1,y)}bt(e,"change",e,t)}function $n(e,t,r){function n(e,i,o){if(e.linked)for(var l=0;l<e.linked.length;++l){var s=e.linked[l];if(s.doc!=i){var a=o&&s.sharedHist;r&&!a||(t(s.doc,a),n(s.doc,e,a))}}}n(e,null,!0)}function qn(e,t){if(t.cm)throw new Error("This document is already in use.");e.doc=t,t.cm=e,Cr(e),jn(e),Zn(e),e.options.lineWrapping||we(e),e.options.mode=t.modeOption,vn(e)}function Zn(e){("rtl"==e.doc.direction?s:Fl)(e.display.lineDiv,"CodeMirror-rtl")}function Qn(e){hn(e,function(){Zn(e),vn(e)})}function Jn(e){this.done=[],this.undone=[],this.undoDepth=1/0,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=e||1}function ei(e,t){var r={from:z(t.from),to:Bn(t),text:N(e,t.from,t.to)};return si(e,r,t.from.line,t.to.line+1),$n(e,function(e){return si(e,r,t.from.line,t.to.line+1)},!0),r}function ti(e){for(;e.length&&g(e).ranges;)e.pop()}function ri(e,t){return t?(ti(e.done),g(e.done)):e.done.length&&!g(e.done).ranges?g(e.done):e.done.length>1&&!e.done[e.done.length-2].ranges?(e.done.pop(),g(e.done)):void 0}function ni(e,t,r,n){var i=e.history;i.undone.length=0;var o,l,s=+new Date;if((i.lastOp==n||i.lastOrigin==t.origin&&t.origin&&("+"==t.origin.charAt(0)&&e.cm&&i.lastModTime>s-e.cm.options.historyEventDelay||"*"==t.origin.charAt(0)))&&(o=ri(i,i.lastOp==n)))l=g(o.changes),0==P(t.from,t.to)&&0==P(t.from,l.to)?l.to=Bn(t):o.changes.push(ei(e,t));else{var a=g(i.done);for(a&&a.ranges||li(e.sel,i.done),o={changes:[ei(e,t)],generation:i.generation},i.done.push(o);i.done.length>i.undoDepth;)i.done.shift(),i.done[0].ranges||i.done.shift()}i.done.push(r),i.generation=++i.maxGeneration,i.lastModTime=i.lastSelTime=s,i.lastOp=i.lastSelOp=n,i.lastOrigin=i.lastSelOrigin=t.origin,l||Te(e,"historyAdded")}function ii(e,t,r,n){var i=t.charAt(0);return"*"==i||"+"==i&&r.ranges.length==n.ranges.length&&r.somethingSelected()==n.somethingSelected()&&new Date-e.history.lastSelTime<=(e.cm?e.cm.options.historyEventDelay:500)}function oi(e,t,r,n){var i=e.history,o=n&&n.origin;r==i.lastSelOp||o&&i.lastSelOrigin==o&&(i.lastModTime==i.lastSelTime&&i.lastOrigin==o||ii(e,o,g(i.done),t))?i.done[i.done.length-1]=t:li(t,i.done),i.lastSelTime=+new Date,i.lastSelOrigin=o,i.lastSelOp=r,n&&!1!==n.clearRedo&&ti(i.undone)}function li(e,t){var r=g(t);r&&r.ranges&&r.equals(e)||t.push(e)}function si(e,t,r,n){var i=t["spans_"+e.id],o=0;e.iter(Math.max(e.first,r),Math.min(e.first+e.size,n),function(r){r.markedSpans&&((i||(i=t["spans_"+e.id]={}))[o]=r.markedSpans),++o})}function ai(e){if(!e)return null;for(var t,r=0;r<e.length;++r)e[r].marker.explicitlyCleared?t||(t=e.slice(0,r)):t&&t.push(e[r]);return t?t.length?t:null:e}function ui(e,t){var r=t["spans_"+e.id];if(!r)return null;for(var n=[],i=0;i<t.text.length;++i)n.push(ai(r[i]));return n}function ci(e,t){var r=ui(e,t),n=J(e,t);if(!r)return n;if(!n)return r;for(var i=0;i<r.length;++i){var o=r[i],l=n[i];if(o&&l)e:for(var s=0;s<l.length;++s){for(var a=l[s],u=0;u<o.length;++u)if(o[u].marker==a.marker)continue e;o.push(a)}else l&&(r[i]=l)}return r}function fi(e,t,r){for(var n=[],i=0;i<e.length;++i){var o=e[i];if(o.ranges)n.push(r?ks.prototype.deepCopy.call(o):o);else{var l=o.changes,s=[];n.push({changes:s});for(var a=0;a<l.length;++a){var u=l[a],c=void 0;if(s.push({from:u.from,to:u.to,text:u.text}),t)for(var f in u)(c=f.match(/^spans_(\d+)$/))&&h(t,Number(c[1]))>-1&&(g(s)[f]=u[f],delete u[f])}}}return n}function hi(e,t,r,n){if(n){var i=e.anchor;if(r){var o=P(t,i)<0;o!=P(r,i)<0?(i=t,t=r):o!=P(t,r)<0&&(t=r)}return new Ts(i,t)}return new Ts(r||t,t)}function di(e,t,r,n,i){null==i&&(i=e.cm&&(e.cm.display.shift||e.extend)),bi(e,new ks([hi(e.sel.primary(),t,r,i)],0),n)}function pi(e,t,r){for(var n=[],i=e.cm&&(e.cm.display.shift||e.extend),o=0;o<e.sel.ranges.length;o++)n[o]=hi(e.sel.ranges[o],t[o],null,i);bi(e,zn(n,e.sel.primIndex),r)}function gi(e,t,r,n){var i=e.sel.ranges.slice(0);i[t]=r,bi(e,zn(i,e.sel.primIndex),n)}function vi(e,t,r,n){bi(e,Rn(t,r),n)}function mi(e,t,r){var n={ranges:t.ranges,update:function(t){var r=this;this.ranges=[];for(var n=0;n<t.length;n++)r.ranges[n]=new Ts(U(e,t[n].anchor),U(e,t[n].head))},origin:r&&r.origin};return Te(e,"beforeSelectionChange",e,n),e.cm&&Te(e.cm,"beforeSelectionChange",e.cm,n),n.ranges!=t.ranges?zn(n.ranges,n.ranges.length-1):t}function yi(e,t,r){var n=e.history.done,i=g(n);i&&i.ranges?(n[n.length-1]=t,wi(e,t,r)):bi(e,t,r)}function bi(e,t,r){wi(e,t,r),oi(e,e.sel,e.cm?e.cm.curOp.id:NaN,r)}function wi(e,t,r){(Oe(e,"beforeSelectionChange")||e.cm&&Oe(e.cm,"beforeSelectionChange"))&&(t=mi(e,t,r)),xi(e,Si(e,t,r&&r.bias||(P(t.primary().head,e.sel.primary().head)<0?-1:1),!0)),r&&!1===r.scroll||!e.cm||jr(e.cm)}function xi(e,t){t.equals(e.sel)||(e.sel=t,e.cm&&(e.cm.curOp.updateInput=e.cm.curOp.selectionChanged=!0,Ne(e.cm)),bt(e,"cursorActivity",e))}function Ci(e){xi(e,Si(e,e.sel,null,!1))}function Si(e,t,r,n){for(var i,o=0;o<t.ranges.length;o++){var l=t.ranges[o],s=t.ranges.length==e.sel.ranges.length&&e.sel.ranges[o],a=ki(e,l.anchor,s&&s.anchor,r,n),u=ki(e,l.head,s&&s.head,r,n);(i||a!=l.anchor||u!=l.head)&&(i||(i=t.ranges.slice(0,o)),i[o]=new Ts(a,u))}return i?zn(i,t.primIndex):t}function Li(e,t,r,n,i){var o=M(e,t.line);if(o.markedSpans)for(var l=0;l<o.markedSpans.length;++l){var s=o.markedSpans[l],a=s.marker;if((null==s.from||(a.inclusiveLeft?s.from<=t.ch:s.from<t.ch))&&(null==s.to||(a.inclusiveRight?s.to>=t.ch:s.to>t.ch))){if(i&&(Te(a,"beforeCursorEnter"),a.explicitlyCleared)){if(o.markedSpans){--l;continue}break}if(!a.atomic)continue;if(r){var u=a.find(n<0?1:-1),c=void 0;if((n<0?a.inclusiveRight:a.inclusiveLeft)&&(u=Ti(e,u,-n,u&&u.line==t.line?o:null)),u&&u.line==t.line&&(c=P(u,r))&&(n<0?c<0:c>0))return Li(e,u,t,n,i)}var f=a.find(n<0?-1:1);return(n<0?a.inclusiveLeft:a.inclusiveRight)&&(f=Ti(e,f,n,f.line==t.line?o:null)),f?Li(e,f,t,n,i):null}}return t}function ki(e,t,r,n,i){var o=n||1,l=Li(e,t,r,o,i)||!i&&Li(e,t,r,o,!0)||Li(e,t,r,-o,i)||!i&&Li(e,t,r,-o,!0);return l||(e.cantEdit=!0,E(e.first,0))}function Ti(e,t,r,n){return r<0&&0==t.ch?t.line>e.first?U(e,E(t.line-1)):null:r>0&&t.ch==(n||M(e,t.line)).text.length?t.line<e.first+e.size-1?E(t.line+1,0):null:new E(t.line,t.ch+r)}function Mi(e){e.setSelection(E(e.firstLine(),0),E(e.lastLine()),Gl)}function Ni(e,t,r){var n={canceled:!1,from:t.from,to:t.to,text:t.text,origin:t.origin,cancel:function(){return n.canceled=!0}};return r&&(n.update=function(t,r,i,o){t&&(n.from=U(e,t)),r&&(n.to=U(e,r)),i&&(n.text=i),void 0!==o&&(n.origin=o)}),Te(e,"beforeChange",e,n),e.cm&&Te(e.cm,"beforeChange",e.cm,n),n.canceled?null:{from:n.from,to:n.to,text:n.text,origin:n.origin}}function Oi(e,t,r){if(e.cm){if(!e.cm.curOp)return dn(e.cm,Oi)(e,t,r);if(e.cm.state.suppressEdits)return}if(!(Oe(e,"beforeChange")||e.cm&&Oe(e.cm,"beforeChange"))||(t=Ni(e,t,!0))){var n=Yl&&!r&&te(e,t.from,t.to);if(n)for(var i=n.length-1;i>=0;--i)Ai(e,{from:n[i].from,to:n[i].to,text:i?[""]:t.text,origin:t.origin});else Ai(e,t)}}function Ai(e,t){if(1!=t.text.length||""!=t.text[0]||0!=P(t.from,t.to)){var r=Un(e,t);ni(e,t,r,e.cm?e.cm.curOp.id:NaN),Hi(e,t,r,J(e,t));var n=[];$n(e,function(e,r){r||-1!=h(n,e.history)||(zi(e.history,t),n.push(e.history)),Hi(e,t,null,J(e,t))})}}function Wi(e,t,r){if(!e.cm||!e.cm.state.suppressEdits||r){for(var n,i=e.history,o=e.sel,l="undo"==t?i.done:i.undone,s="undo"==t?i.undone:i.done,a=0;a<l.length&&(n=l[a],r?!n.ranges||n.equals(e.sel):n.ranges);a++);if(a!=l.length){for(i.lastOrigin=i.lastSelOrigin=null;(n=l.pop()).ranges;){if(li(n,s),r&&!n.equals(e.sel))return void bi(e,n,{clearRedo:!1});o=n}var u=[];li(o,s),s.push({changes:u,generation:i.generation}),i.generation=n.generation||++i.maxGeneration;for(var c=Oe(e,"beforeChange")||e.cm&&Oe(e.cm,"beforeChange"),f=n.changes.length-1;f>=0;--f){var d=function(r){var i=n.changes[r];if(i.origin=t,c&&!Ni(e,i,!1))return l.length=0,{};u.push(ei(e,i));var o=r?Un(e,i):g(l);Hi(e,i,o,ci(e,i)),!r&&e.cm&&e.cm.scrollIntoView({from:i.from,to:Bn(i)});var s=[];$n(e,function(e,t){t||-1!=h(s,e.history)||(zi(e.history,i),s.push(e.history)),Hi(e,i,null,ci(e,i))})}(f);if(d)return d.v}}}}function Di(e,t){if(0!=t&&(e.first+=t,e.sel=new ks(v(e.sel.ranges,function(e){return new Ts(E(e.anchor.line+t,e.anchor.ch),E(e.head.line+t,e.head.ch))}),e.sel.primIndex),e.cm)){vn(e.cm,e.first,e.first-t,t);for(var r=e.cm.display,n=r.viewFrom;n<r.viewTo;n++)mn(e.cm,n,"gutter")}}function Hi(e,t,r,n){if(e.cm&&!e.cm.curOp)return dn(e.cm,Hi)(e,t,r,n);if(t.to.line<e.first)Di(e,t.text.length-1-(t.to.line-t.from.line));else if(!(t.from.line>e.lastLine())){if(t.from.line<e.first){var i=t.text.length-1-(e.first-t.from.line);Di(e,i),t={from:E(e.first,0),to:E(t.to.line+i,t.to.ch),text:[g(t.text)],origin:t.origin}}var o=e.lastLine();t.to.line>o&&(t={from:t.from,to:E(o,M(e,o).text.length),text:[t.text[0]],origin:t.origin}),t.removed=N(e,t.from,t.to),r||(r=Un(e,t)),e.cm?Fi(e.cm,t,n):_n(e,t,n),wi(e,r,Gl)}}function Fi(e,t,r){var n=e.doc,i=e.display,o=t.from,l=t.to,s=!1,a=o.line;e.options.lineWrapping||(a=W(fe(M(n,o.line))),n.iter(a,l.line+1,function(e){if(e==i.maxLine)return s=!0,!0})),n.sel.contains(t.from,t.to)>-1&&Ne(e),_n(n,t,r,xr(e)),e.options.lineWrapping||(n.iter(a,o.line+t.text.length,function(e){var t=be(e);t>i.maxLineLength&&(i.maxLine=e,i.maxLineLength=t,i.maxLineChanged=!0,s=!1)}),s&&(e.curOp.updateMaxLine=!0)),nt(n,o.line),Cn(e,400);var u=t.text.length-(l.line-o.line)-1;t.full?vn(e):o.line!=l.line||1!=t.text.length||Yn(e.doc,t)?vn(e,o.line,l.line+1,u):mn(e,o.line,"text");var c=Oe(e,"changes"),f=Oe(e,"change");if(f||c){var h={from:o,to:l,text:t.text,removed:t.removed,origin:t.origin};f&&bt(e,"change",e,h),c&&(e.curOp.changeObjs||(e.curOp.changeObjs=[])).push(h)}e.display.selForContextMenu=null}function Ei(e,t,r,n,i){if(n||(n=r),P(n,r)<0){var o;r=(o=[n,r])[0],n=o[1]}"string"==typeof t&&(t=e.splitLines(t)),Oi(e,{from:r,to:n,text:t,origin:i})}function Pi(e,t,r,n){r<e.line?e.line+=n:t<e.line&&(e.line=t,e.ch=0)}function Ii(e,t,r,n){for(var i=0;i<e.length;++i){var o=e[i],l=!0;if(o.ranges){o.copied||((o=e[i]=o.deepCopy()).copied=!0);for(var s=0;s<o.ranges.length;s++)Pi(o.ranges[s].anchor,t,r,n),Pi(o.ranges[s].head,t,r,n)}else{for(var a=0;a<o.changes.length;++a){var u=o.changes[a];if(r<u.from.line)u.from=E(u.from.line+n,u.from.ch),u.to=E(u.to.line+n,u.to.ch);else if(t<=u.to.line){l=!1;break}}l||(e.splice(0,i+1),i=0)}}}function zi(e,t){var r=t.from.line,n=t.to.line,i=t.text.length-(n-r)-1;Ii(e.done,r,n,i),Ii(e.undone,r,n,i)}function Ri(e,t,r,n){var i=t,o=t;return"number"==typeof t?o=M(e,G(e,t)):i=W(t),null==i?null:(n(o,i)&&e.cm&&mn(e.cm,i,r),o)}function Bi(e){var t=this;this.lines=e,this.parent=null;for(var r=0,n=0;n<e.length;++n)e[n].parent=t,r+=e[n].height;this.height=r}function Gi(e){var t=this;this.children=e;for(var r=0,n=0,i=0;i<e.length;++i){var o=e[i];r+=o.chunkSize(),n+=o.height,o.parent=t}this.size=r,this.height=n,this.parent=null}function Ui(e,t,r){ye(t)<(e.curOp&&e.curOp.scrollTop||e.doc.scrollTop)&&Kr(e,r)}function Vi(e,t,r,n){var i=new Ms(e,r,n),o=e.cm;return o&&i.noHScroll&&(o.display.alignWidgets=!0),Ri(e,t,"widget",function(t){var r=t.widgets||(t.widgets=[]);if(null==i.insertAt?r.push(i):r.splice(Math.min(r.length-1,Math.max(0,i.insertAt)),0,i),i.line=t,o&&!ve(e,t)){var n=ye(t)<e.scrollTop;A(t,t.height+Ht(i)),n&&Kr(o,i.height),o.curOp.forceUpdate=!0}return!0}),bt(o,"lineWidgetAdded",o,i,"number"==typeof t?t:W(t)),i}function Ki(e,t,r,n,o){if(n&&n.shared)return ji(e,t,r,n,o);if(e.cm&&!e.cm.curOp)return dn(e.cm,Ki)(e,t,r,n,o);var l=new Os(e,o),s=P(t,r);if(n&&c(n,l,!1),s>0||0==s&&!1!==l.clearWhenEmpty)return l;if(l.replacedWith&&(l.collapsed=!0,l.widgetNode=i("span",[l.replacedWith],"CodeMirror-widget"),n.handleMouseEvents||l.widgetNode.setAttribute("cm-ignore-events","true"),n.insertLeft&&(l.widgetNode.insertLeft=!0)),l.collapsed){if(ce(e,t.line,t,r,l)||t.line!=r.line&&ce(e,r.line,t,r,l))throw new Error("Inserting collapsed marker partially overlapping an existing one");X()}l.addToHistory&&ni(e,{from:t,to:r,origin:"markText"},e.sel,NaN);var a,u=t.line,f=e.cm;if(e.iter(u,r.line+1,function(e){f&&l.collapsed&&!f.options.lineWrapping&&fe(e)==f.display.maxLine&&(a=!0),l.collapsed&&u!=t.line&&A(e,0),q(e,new Y(l,u==t.line?t.ch:null,u==r.line?r.ch:null)),++u}),l.collapsed&&e.iter(t.line,r.line+1,function(t){ve(e,t)&&A(t,0)}),l.clearOnEnter&&Ql(l,"beforeCursorEnter",function(){return l.clear()}),l.readOnly&&(j(),(e.history.done.length||e.history.undone.length)&&e.clearHistory()),l.collapsed&&(l.id=++Ns,l.atomic=!0),f){if(a&&(f.curOp.updateMaxLine=!0),l.collapsed)vn(f,t.line,r.line+1);else if(l.className||l.title||l.startStyle||l.endStyle||l.css)for(var h=t.line;h<=r.line;h++)mn(f,h,"text");l.atomic&&Ci(f.doc),bt(f,"markerAdded",f,l)}return l}function ji(e,t,r,n,i){(n=c(n)).shared=!1;var o=[Ki(e,t,r,n,i)],l=o[0],s=n.widgetNode;return $n(e,function(e){s&&(n.widgetNode=s.cloneNode(!0)),o.push(Ki(e,U(e,t),U(e,r),n,i));for(var a=0;a<e.linked.length;++a)if(e.linked[a].isParent)return;l=g(o)}),new As(o,l)}function Xi(e){return e.findMarks(E(e.first,0),e.clipPos(E(e.lastLine())),function(e){return e.parent})}function Yi(e,t){for(var r=0;r<t.length;r++){var n=t[r],i=n.find(),o=e.clipPos(i.from),l=e.clipPos(i.to);if(P(o,l)){var s=Ki(e,o,l,n.primary,n.primary.type);n.markers.push(s),s.parent=n}}}function _i(e){for(var t=0;t<e.length;t++)!function(t){var r=e[t],n=[r.primary.doc];$n(r.primary.doc,function(e){return n.push(e)});for(var i=0;i<r.markers.length;i++){var o=r.markers[i];-1==h(n,o.doc)&&(o.parent=null,r.markers.splice(i--,1))}}(t)}function $i(e){var t=this;if(Qi(t),!Me(t,e)&&!Ft(t.display,e)){We(e),gl&&(Hs=+new Date);var r=Sr(t,e,!0),n=e.dataTransfer.files;if(r&&!t.isReadOnly())if(n&&n.length&&window.FileReader&&window.File)for(var i=n.length,o=Array(i),l=0,s=0;s<i;++s)!function(e,n){if(!t.options.allowDropFileTypes||-1!=h(t.options.allowDropFileTypes,e.type)){var s=new FileReader;s.onload=dn(t,function(){var e=s.result;if(/[\x00-\x08\x0e-\x1f]{2}/.test(e)&&(e=""),o[n]=e,++l==i){var a={from:r=U(t.doc,r),to:r,text:t.doc.splitLines(o.join(t.doc.lineSeparator())),origin:"paste"};Oi(t.doc,a),yi(t.doc,Rn(r,Bn(a)))}}),s.readAsText(e)}}(n[s],s);else{if(t.state.draggingText&&t.doc.sel.contains(r)>-1)return t.state.draggingText(e),void setTimeout(function(){return t.display.input.focus()},20);try{var a=e.dataTransfer.getData("Text");if(a){var u;if(t.state.draggingText&&!t.state.draggingText.copy&&(u=t.listSelections()),wi(t.doc,Rn(r,r)),u)for(var c=0;c<u.length;++c)Ei(t.doc,"",u[c].anchor,u[c].head,"drag");t.replaceSelection(a,"around","paste"),t.display.input.focus()}}catch(e){}}}}function qi(e,t){if(gl&&(!e.state.draggingText||+new Date-Hs<100))Fe(t);else if(!Me(e,t)&&!Ft(e.display,t)&&(t.dataTransfer.setData("Text",e.getSelection()),t.dataTransfer.effectAllowed="copyMove",t.dataTransfer.setDragImage&&!xl)){var r=n("img",null,null,"position: fixed; left: 0; top: 0;");r.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",wl&&(r.width=r.height=1,e.display.wrapper.appendChild(r),r._top=r.offsetTop),t.dataTransfer.setDragImage(r,0,0),wl&&r.parentNode.removeChild(r)}}function Zi(e,t){var i=Sr(e,t);if(i){var o=document.createDocumentFragment();Mr(e,i,o),e.display.dragCursor||(e.display.dragCursor=n("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),e.display.lineSpace.insertBefore(e.display.dragCursor,e.display.cursorDiv)),r(e.display.dragCursor,o)}}function Qi(e){e.display.dragCursor&&(e.display.lineSpace.removeChild(e.display.dragCursor),e.display.dragCursor=null)}function Ji(e){if(document.getElementsByClassName)for(var t=document.getElementsByClassName("CodeMirror"),r=0;r<t.length;r++){var n=t[r].CodeMirror;n&&e(n)}}function eo(){Fs||(to(),Fs=!0)}function to(){var e;Ql(window,"resize",function(){null==e&&(e=setTimeout(function(){e=null,Ji(ro)},100))}),Ql(window,"blur",function(){return Ji(Fr)})}function ro(e){var t=e.display;t.lastWrapHeight==t.wrapper.clientHeight&&t.lastWrapWidth==t.wrapper.clientWidth||(t.cachedCharWidth=t.cachedTextHeight=t.cachedPaddingH=null,t.scrollbarsClipped=!1,e.setSize())}function no(e){var t=e.split(/-(?!$)/);e=t[t.length-1];for(var r,n,i,o,l=0;l<t.length-1;l++){var s=t[l];if(/^(cmd|meta|m)$/i.test(s))o=!0;else if(/^a(lt)?$/i.test(s))r=!0;else if(/^(c|ctrl|control)$/i.test(s))n=!0;else{if(!/^s(hift)?$/i.test(s))throw new Error("Unrecognized modifier name: "+s);i=!0}}return r&&(e="Alt-"+e),n&&(e="Ctrl-"+e),o&&(e="Cmd-"+e),i&&(e="Shift-"+e),e}function io(e){var t={};for(var r in e)if(e.hasOwnProperty(r)){var n=e[r];if(/^(name|fallthrough|(de|at)tach)$/.test(r))continue;if("..."==n){delete e[r];continue}for(var i=v(r.split(" "),no),o=0;o<i.length;o++){var l=void 0,s=void 0;o==i.length-1?(s=i.join(" "),l=n):(s=i.slice(0,o+1).join(" "),l="...");var a=t[s];if(a){if(a!=l)throw new Error("Inconsistent bindings for "+s)}else t[s]=l}delete e[r]}for(var u in t)e[u]=t[u];return e}function oo(e,t,r,n){var i=(t=uo(t)).call?t.call(e,n):t[e];if(!1===i)return"nothing";if("..."===i)return"multi";if(null!=i&&r(i))return"handled";if(t.fallthrough){if("[object Array]"!=Object.prototype.toString.call(t.fallthrough))return oo(e,t.fallthrough,r,n);for(var o=0;o<t.fallthrough.length;o++){var l=oo(e,t.fallthrough[o],r,n);if(l)return l}}}function lo(e){var t="string"==typeof e?e:Es[e.keyCode];return"Ctrl"==t||"Alt"==t||"Shift"==t||"Mod"==t}function so(e,t,r){var n=e;return t.altKey&&"Alt"!=n&&(e="Alt-"+e),(Dl?t.metaKey:t.ctrlKey)&&"Ctrl"!=n&&(e="Ctrl-"+e),(Dl?t.ctrlKey:t.metaKey)&&"Cmd"!=n&&(e="Cmd-"+e),!r&&t.shiftKey&&"Shift"!=n&&(e="Shift-"+e),e}function ao(e,t){if(wl&&34==e.keyCode&&e.char)return!1;var r=Es[e.keyCode];return null!=r&&!e.altGraphKey&&so(r,e,t)}function uo(e){return"string"==typeof e?Rs[e]:e}function co(e,t){for(var r=e.doc.sel.ranges,n=[],i=0;i<r.length;i++){for(var o=t(r[i]);n.length&&P(o.from,g(n).to)<=0;){var l=n.pop();if(P(l.from,o.from)<0){o.from=l.from;break}}n.push(o)}hn(e,function(){for(var t=n.length-1;t>=0;t--)Ei(e.doc,"",n[t].from,n[t].to,"+delete");jr(e)})}function fo(e,t,r){var n=L(e.text,t+r,r);return n<0||n>e.text.length?null:n}function ho(e,t,r){var n=fo(e,t.ch,r);return null==n?null:new E(t.line,n,r<0?"after":"before")}function po(e,t,r,n,i){if(e){var o=Se(r,t.doc.direction);if(o){var l,s=i<0?g(o):o[0],a=i<0==(1==s.level)?"after":"before";if(s.level>0){var u=Xt(t,r);l=i<0?r.text.length-1:0;var c=Yt(t,u,l).top;l=k(function(e){return Yt(t,u,e).top==c},i<0==(1==s.level)?s.from:s.to-1,l),"before"==a&&(l=fo(r,l,1))}else l=i<0?s.to:s.from;return new E(n,l,a)}}return new E(n,i<0?r.text.length:0,i<0?"before":"after")}function go(e,t,r,n){var i=Se(t,e.doc.direction);if(!i)return ho(t,r,n);r.ch>=t.text.length?(r.ch=t.text.length,r.sticky="before"):r.ch<=0&&(r.ch=0,r.sticky="after");var o=Ce(i,r.ch,r.sticky),l=i[o];if("ltr"==e.doc.direction&&l.level%2==0&&(n>0?l.to>r.ch:l.from<r.ch))return ho(t,r,n);var s,a=function(e,r){return fo(t,e instanceof E?e.ch:e,r)},u=function(r){return e.options.lineWrapping?(s=s||Xt(e,t),hr(e,t,s,r)):{begin:0,end:t.text.length}},c=u("before"==r.sticky?a(r,-1):r.ch);if("rtl"==e.doc.direction||1==l.level){var f=1==l.level==n<0,h=a(r,f?1:-1);if(null!=h&&(f?h<=l.to&&h<=c.end:h>=l.from&&h>=c.begin)){var d=f?"before":"after";return new E(r.line,h,d)}}var p=function(e,t,n){for(var o=function(e,t){return t?new E(r.line,a(e,1),"before"):new E(r.line,e,"after")};e>=0&&e<i.length;e+=t){var l=i[e],s=t>0==(1!=l.level),u=s?n.begin:a(n.end,-1);if(l.from<=u&&u<l.to)return o(u,s);if(u=s?l.from:a(l.to,-1),n.begin<=u&&u<n.end)return o(u,s)}},g=p(o+n,n,c);if(g)return g;var v=n>0?c.end:a(c.begin,-1);return null==v||n>0&&v==t.text.length||!(g=p(n>0?0:i.length-1,n,u(v)))?null:g}function vo(e,t){var r=M(e.doc,t),n=fe(r);return n!=r&&(t=W(n)),po(!0,e,n,t,1)}function mo(e,t){var r=M(e.doc,t),n=he(r);return n!=r&&(t=W(n)),po(!0,e,r,t,-1)}function yo(e,t){var r=vo(e,t.line),n=M(e.doc,r.line),i=Se(n,e.doc.direction);if(!i||0==i[0].level){var o=Math.max(0,n.text.search(/\S/)),l=t.line==r.line&&t.ch<=o&&t.ch;return E(r.line,l?0:o,r.sticky)}return r}function bo(e,t,r){if("string"==typeof t&&!(t=Bs[t]))return!1;e.display.input.ensurePolled();var n=e.display.shift,i=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),r&&(e.display.shift=!1),i=t(e)!=Bl}finally{e.display.shift=n,e.state.suppressEdits=!1}return i}function wo(e,t,r){for(var n=0;n<e.state.keyMaps.length;n++){var i=oo(t,e.state.keyMaps[n],r,e);if(i)return i}return e.options.extraKeys&&oo(t,e.options.extraKeys,r,e)||oo(t,e.options.keyMap,r,e)}function xo(e,t,r,n){var i=e.state.keySeq;if(i){if(lo(t))return"handled";Gs.set(50,function(){e.state.keySeq==i&&(e.state.keySeq=null,e.display.input.reset())}),t=i+" "+t}var o=wo(e,t,n);return"multi"==o&&(e.state.keySeq=t),"handled"==o&&bt(e,"keyHandled",e,t,r),"handled"!=o&&"multi"!=o||(We(r),Ar(e)),i&&!o&&/\'$/.test(t)?(We(r),!0):!!o}function Co(e,t){var r=ao(t,!0);return!!r&&(t.shiftKey&&!e.state.keySeq?xo(e,"Shift-"+r,t,function(t){return bo(e,t,!0)})||xo(e,r,t,function(t){if("string"==typeof t?/^go[A-Z]/.test(t):t.motion)return bo(e,t)}):xo(e,r,t,function(t){return bo(e,t)}))}function So(e,t,r){return xo(e,"'"+r+"'",t,function(t){return bo(e,t,!0)})}function Lo(e){var t=this;if(t.curOp.focus=l(),!Me(t,e)){gl&&vl<11&&27==e.keyCode&&(e.returnValue=!1);var r=e.keyCode;t.display.shift=16==r||e.shiftKey;var n=Co(t,e);wl&&(Us=n?r:null,!n&&88==r&&!rs&&(Ml?e.metaKey:e.ctrlKey)&&t.replaceSelection("",null,"cut")),18!=r||/\bCodeMirror-crosshair\b/.test(t.display.lineDiv.className)||ko(t)}}function ko(e){function t(e){18!=e.keyCode&&e.altKey||(Fl(r,"CodeMirror-crosshair"),ke(document,"keyup",t),ke(document,"mouseover",t))}var r=e.display.lineDiv;s(r,"CodeMirror-crosshair"),Ql(document,"keyup",t),Ql(document,"mouseover",t)}function To(e){16==e.keyCode&&(this.doc.sel.shift=!1),Me(this,e)}function Mo(e){var t=this;if(!(Ft(t.display,e)||Me(t,e)||e.ctrlKey&&!e.altKey||Ml&&e.metaKey)){var r=e.keyCode,n=e.charCode;if(wl&&r==Us)return Us=null,void We(e);if(!wl||e.which&&!(e.which<10)||!Co(t,e)){var i=String.fromCharCode(null==n?r:n);"\b"!=i&&(So(t,e,i)||t.display.input.onKeyPress(e))}}}function No(e,t){var r=+new Date;return js&&js.compare(r,e,t)?(Ks=js=null,"triple"):Ks&&Ks.compare(r,e,t)?(js=new Vs(r,e,t),Ks=null,"double"):(Ks=new Vs(r,e,t),js=null,"single")}function Oo(e){var t=this,r=t.display;if(!(Me(t,e)||r.activeTouch&&r.input.supportsTouch()))if(r.input.ensurePolled(),r.shift=e.shiftKey,Ft(r,e))ml||(r.scroller.draggable=!1,setTimeout(function(){return r.scroller.draggable=!0},100));else if(!zo(t,e)){var n=Sr(t,e),i=Pe(e),o=n?No(n,i):"single";window.focus(),1==i&&t.state.selectingText&&t.state.selectingText(e),n&&Ao(t,i,n,o,e)||(1==i?n?Do(t,n,o,e):Ee(e)==r.scroller&&We(e):2==i?(n&&di(t.doc,n),setTimeout(function(){return r.input.focus()},20)):3==i&&(Hl?Ro(t,e):Dr(t)))}}function Ao(e,t,r,n,i){var o="Click";return"double"==n?o="Double"+o:"triple"==n&&(o="Triple"+o),o=(1==t?"Left":2==t?"Middle":"Right")+o,xo(e,so(o,i),i,function(t){if("string"==typeof t&&(t=Bs[t]),!t)return!1;var n=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),n=t(e,r)!=Bl}finally{e.state.suppressEdits=!1}return n})}function Wo(e,t,r){var n=e.getOption("configureMouse"),i=n?n(e,t,r):{};if(null==i.unit){var o=Nl?r.shiftKey&&r.metaKey:r.altKey;i.unit=o?"rectangle":"single"==t?"char":"double"==t?"word":"line"}return(null==i.extend||e.doc.extend)&&(i.extend=e.doc.extend||r.shiftKey),null==i.addNew&&(i.addNew=Ml?r.metaKey:r.ctrlKey),null==i.moveOnDrag&&(i.moveOnDrag=!(Ml?r.altKey:r.ctrlKey)),i}function Do(e,t,r,n){gl?setTimeout(u(Wr,e),0):e.curOp.focus=l();var i,o=Wo(e,r,n),s=e.doc.sel;e.options.dragDrop&&Jl&&!e.isReadOnly()&&"single"==r&&(i=s.contains(t))>-1&&(P((i=s.ranges[i]).from(),t)<0||t.xRel>0)&&(P(i.to(),t)>0||t.xRel<0)?Ho(e,n,t,o):Eo(e,n,t,o)}function Ho(e,t,r,n){var i=e.display,o=!1,l=dn(e,function(t){ml&&(i.scroller.draggable=!1),e.state.draggingText=!1,ke(document,"mouseup",l),ke(document,"mousemove",s),ke(i.scroller,"dragstart",a),ke(i.scroller,"drop",l),o||(We(t),n.addNew||di(e.doc,r,null,null,n.extend),ml||gl&&9==vl?setTimeout(function(){document.body.focus(),i.input.focus()},20):i.input.focus())}),s=function(e){o=o||Math.abs(t.clientX-e.clientX)+Math.abs(t.clientY-e.clientY)>=10},a=function(){return o=!0};ml&&(i.scroller.draggable=!0),e.state.draggingText=l,l.copy=!n.moveOnDrag,i.scroller.dragDrop&&i.scroller.dragDrop(),Ql(document,"mouseup",l),Ql(document,"mousemove",s),Ql(i.scroller,"dragstart",a),Ql(i.scroller,"drop",l),Dr(e),setTimeout(function(){return i.input.focus()},20)}function Fo(e,t,r){if("char"==r)return new Ts(t,t);if("word"==r)return e.findWordAt(t);if("line"==r)return new Ts(E(t.line,0),U(e.doc,E(t.line+1,0)));var n=r(e,t);return new Ts(n.from,n.to)}function Eo(e,t,r,n){function i(t){if(0!=P(m,t))if(m=t,"rectangle"==n.unit){for(var i=[],o=e.options.tabSize,l=f(M(u,r.line).text,r.ch,o),s=f(M(u,t.line).text,t.ch,o),a=Math.min(l,s),g=Math.max(l,s),v=Math.min(r.line,t.line),y=Math.min(e.lastLine(),Math.max(r.line,t.line));v<=y;v++){var b=M(u,v).text,w=d(b,a,o);a==g?i.push(new Ts(E(v,w),E(v,w))):b.length>w&&i.push(new Ts(E(v,w),E(v,d(b,g,o))))}i.length||i.push(new Ts(r,r)),bi(u,zn(p.ranges.slice(0,h).concat(i),h),{origin:"*mouse",scroll:!1}),e.scrollIntoView(t)}else{var x,C=c,S=Fo(e,t,n.unit),L=C.anchor;P(S.anchor,L)>0?(x=S.head,L=B(C.from(),S.anchor)):(x=S.anchor,L=R(C.to(),S.head));var k=p.ranges.slice(0);k[h]=Po(e,new Ts(U(u,L),x)),bi(u,zn(k,h),Ul)}}function o(t){var r=++b,s=Sr(e,t,!0,"rectangle"==n.unit);if(s)if(0!=P(s,m)){e.curOp.focus=l(),i(s);var c=Ir(a,u);(s.line>=c.to||s.line<c.from)&&setTimeout(dn(e,function(){b==r&&o(t)}),150)}else{var f=t.clientY<y.top?-20:t.clientY>y.bottom?20:0;f&&setTimeout(dn(e,function(){b==r&&(a.scroller.scrollTop+=f,o(t))}),50)}}function s(t){e.state.selectingText=!1,b=1/0,We(t),a.input.focus(),ke(document,"mousemove",w),ke(document,"mouseup",x),u.history.lastSelOrigin=null}var a=e.display,u=e.doc;We(t);var c,h,p=u.sel,g=p.ranges;if(n.addNew&&!n.extend?(h=u.sel.contains(r),c=h>-1?g[h]:new Ts(r,r)):(c=u.sel.primary(),h=u.sel.primIndex),"rectangle"==n.unit)n.addNew||(c=new Ts(r,r)),r=Sr(e,t,!0,!0),h=-1;else{var v=Fo(e,r,n.unit);c=n.extend?hi(c,v.anchor,v.head,n.extend):v}n.addNew?-1==h?(h=g.length,bi(u,zn(g.concat([c]),h),{scroll:!1,origin:"*mouse"})):g.length>1&&g[h].empty()&&"char"==n.unit&&!n.extend?(bi(u,zn(g.slice(0,h).concat(g.slice(h+1)),0),{scroll:!1,origin:"*mouse"}),p=u.sel):gi(u,h,c,Ul):(h=0,bi(u,new ks([c],0),Ul),p=u.sel);var m=r,y=a.wrapper.getBoundingClientRect(),b=0,w=dn(e,function(e){Pe(e)?o(e):s(e)}),x=dn(e,s);e.state.selectingText=x,Ql(document,"mousemove",w),Ql(document,"mouseup",x)}function Po(e,t){var r=t.anchor,n=t.head,i=M(e.doc,r.line);if(0==P(r,n)&&r.sticky==n.sticky)return t;var o=Se(i);if(!o)return t;var l=Ce(o,r.ch,r.sticky),s=o[l];if(s.from!=r.ch&&s.to!=r.ch)return t;var a=l+(s.from==r.ch==(1!=s.level)?0:1);if(0==a||a==o.length)return t;var u;if(n.line!=r.line)u=(n.line-r.line)*("ltr"==e.doc.direction?1:-1)>0;else{var c=Ce(o,n.ch,n.sticky),f=c-l||(n.ch-r.ch)*(1==s.level?-1:1);u=c==a-1||c==a?f<0:f>0}var h=o[a+(u?-1:0)],d=u==(1==h.level),p=d?h.from:h.to,g=d?"after":"before";return r.ch==p&&r.sticky==g?t:new Ts(new E(r.line,p,g),n)}function Io(e,t,r,n){var i,o;if(t.touches)i=t.touches[0].clientX,o=t.touches[0].clientY;else try{i=t.clientX,o=t.clientY}catch(t){return!1}if(i>=Math.floor(e.display.gutters.getBoundingClientRect().right))return!1;n&&We(t);var l=e.display,s=l.lineDiv.getBoundingClientRect();if(o>s.bottom||!Oe(e,r))return He(t);o-=s.top-l.viewOffset;for(var a=0;a<e.options.gutters.length;++a){var u=l.gutters.childNodes[a];if(u&&u.getBoundingClientRect().right>=i)return Te(e,r,e,D(e.doc,o),e.options.gutters[a],t),He(t)}}function zo(e,t){return Io(e,t,"gutterClick",!0)}function Ro(e,t){Ft(e.display,t)||Bo(e,t)||Me(e,t,"contextmenu")||e.display.input.onContextMenu(t)}function Bo(e,t){return!!Oe(e,"gutterContextMenu")&&Io(e,t,"gutterContextMenu",!1)}function Go(e){e.display.wrapper.className=e.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+e.options.theme.replace(/(^|\s)\s*/g," cm-s-"),er(e)}function Uo(e){Hn(e),vn(e),zr(e)}function Vo(e,t,r){if(!t!=!(r&&r!=Xs)){var n=e.display.dragFunctions,i=t?Ql:ke;i(e.display.scroller,"dragstart",n.start),i(e.display.scroller,"dragenter",n.enter),i(e.display.scroller,"dragover",n.over),i(e.display.scroller,"dragleave",n.leave),i(e.display.scroller,"drop",n.drop)}}function Ko(e){e.options.lineWrapping?(s(e.display.wrapper,"CodeMirror-wrap"),e.display.sizer.style.minWidth="",e.display.sizerWidth=null):(Fl(e.display.wrapper,"CodeMirror-wrap"),we(e)),Cr(e),vn(e),er(e),setTimeout(function(){return en(e)},100)}function jo(e,t){var r=this;if(!(this instanceof jo))return new jo(e,t);this.options=t=t?c(t):{},c(Ys,t,!1),Fn(t);var n=t.value;"string"==typeof n&&(n=new Ds(n,t.mode,null,t.lineSeparator,t.direction)),this.doc=n;var i=new jo.inputStyles[t.inputStyle](this),o=this.display=new T(e,n,i);o.wrapper.CodeMirror=this,Hn(this),Go(this),t.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),rn(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,delayingBlurEvent:!1,focused:!1,suppressEdits:!1,pasteIncoming:!1,cutIncoming:!1,selectingText:!1,draggingText:!1,highlight:new Pl,keySeq:null,specialChars:null},t.autofocus&&!Tl&&o.input.focus(),gl&&vl<11&&setTimeout(function(){return r.display.input.reset(!0)},20),Xo(this),eo(),nn(this),this.curOp.forceUpdate=!0,qn(this,n),t.autofocus&&!Tl||this.hasFocus()?setTimeout(u(Hr,this),20):Fr(this);for(var l in _s)_s.hasOwnProperty(l)&&_s[l](r,t[l],Xs);Rr(this),t.finishInit&&t.finishInit(this);for(var s=0;s<$s.length;++s)$s[s](r);on(this),ml&&t.lineWrapping&&"optimizelegibility"==getComputedStyle(o.lineDiv).textRendering&&(o.lineDiv.style.textRendering="auto")}function Xo(e){function t(){i.activeTouch&&(o=setTimeout(function(){return i.activeTouch=null},1e3),(l=i.activeTouch).end=+new Date)}function r(e){if(1!=e.touches.length)return!1;var t=e.touches[0];return t.radiusX<=1&&t.radiusY<=1}function n(e,t){if(null==t.left)return!0;var r=t.left-e.left,n=t.top-e.top;return r*r+n*n>400}var i=e.display;Ql(i.scroller,"mousedown",dn(e,Oo)),gl&&vl<11?Ql(i.scroller,"dblclick",dn(e,function(t){if(!Me(e,t)){var r=Sr(e,t);if(r&&!zo(e,t)&&!Ft(e.display,t)){We(t);var n=e.findWordAt(r);di(e.doc,n.anchor,n.head)}}})):Ql(i.scroller,"dblclick",function(t){return Me(e,t)||We(t)}),Hl||Ql(i.scroller,"contextmenu",function(t){return Ro(e,t)});var o,l={end:0};Ql(i.scroller,"touchstart",function(t){if(!Me(e,t)&&!r(t)&&!zo(e,t)){i.input.ensurePolled(),clearTimeout(o);var n=+new Date;i.activeTouch={start:n,moved:!1,prev:n-l.end<=300?l:null},1==t.touches.length&&(i.activeTouch.left=t.touches[0].pageX,i.activeTouch.top=t.touches[0].pageY)}}),Ql(i.scroller,"touchmove",function(){i.activeTouch&&(i.activeTouch.moved=!0)}),Ql(i.scroller,"touchend",function(r){var o=i.activeTouch;if(o&&!Ft(i,r)&&null!=o.left&&!o.moved&&new Date-o.start<300){var l,s=e.coordsChar(i.activeTouch,"page");l=!o.prev||n(o,o.prev)?new Ts(s,s):!o.prev.prev||n(o,o.prev.prev)?e.findWordAt(s):new Ts(E(s.line,0),U(e.doc,E(s.line+1,0))),e.setSelection(l.anchor,l.head),e.focus(),We(r)}t()}),Ql(i.scroller,"touchcancel",t),Ql(i.scroller,"scroll",function(){i.scroller.clientHeight&&(qr(e,i.scroller.scrollTop),Qr(e,i.scroller.scrollLeft,!0),Te(e,"scroll",e))}),Ql(i.scroller,"mousewheel",function(t){return In(e,t)}),Ql(i.scroller,"DOMMouseScroll",function(t){return In(e,t)}),Ql(i.wrapper,"scroll",function(){return i.wrapper.scrollTop=i.wrapper.scrollLeft=0}),i.dragFunctions={enter:function(t){Me(e,t)||Fe(t)},over:function(t){Me(e,t)||(Zi(e,t),Fe(t))},start:function(t){return qi(e,t)},drop:dn(e,$i),leave:function(t){Me(e,t)||Qi(e)}};var s=i.input.getField();Ql(s,"keyup",function(t){return To.call(e,t)}),Ql(s,"keydown",dn(e,Lo)),Ql(s,"keypress",dn(e,Mo)),Ql(s,"focus",function(t){return Hr(e,t)}),Ql(s,"blur",function(t){return Fr(e,t)})}function Yo(e,t,r,n){var i,o=e.doc;null==r&&(r="add"),"smart"==r&&(o.mode.indent?i=$e(e,t).state:r="prev");var l=e.options.tabSize,s=M(o,t),a=f(s.text,null,l);s.stateAfter&&(s.stateAfter=null);var u,c=s.text.match(/^\s*/)[0];if(n||/\S/.test(s.text)){if("smart"==r&&((u=o.mode.indent(i,s.text.slice(c.length),s.text))==Bl||u>150)){if(!n)return;r="prev"}}else u=0,r="not";"prev"==r?u=t>o.first?f(M(o,t-1).text,null,l):0:"add"==r?u=a+e.options.indentUnit:"subtract"==r?u=a-e.options.indentUnit:"number"==typeof r&&(u=a+r),u=Math.max(0,u);var h="",d=0;if(e.options.indentWithTabs)for(var g=Math.floor(u/l);g;--g)d+=l,h+="\t";if(d<u&&(h+=p(u-d)),h!=c)return Ei(o,h,E(t,0),E(t,c.length),"+input"),s.stateAfter=null,!0;for(var v=0;v<o.sel.ranges.length;v++){var m=o.sel.ranges[v];if(m.head.line==t&&m.head.ch<c.length){var y=E(t,c.length);gi(o,v,new Ts(y,y));break}}}function _o(e){qs=e}function $o(e,t,r,n,i){var o=e.doc;e.display.shift=!1,n||(n=o.sel);var l=e.state.pasteIncoming||"paste"==i,s=es(t),a=null;if(l&&n.ranges.length>1)if(qs&&qs.text.join("\n")==t){if(n.ranges.length%qs.text.length==0){a=[];for(var u=0;u<qs.text.length;u++)a.push(o.splitLines(qs.text[u]))}}else s.length==n.ranges.length&&e.options.pasteLinesPerSelection&&(a=v(s,function(e){return[e]}));for(var c,f=n.ranges.length-1;f>=0;f--){var h=n.ranges[f],d=h.from(),p=h.to();h.empty()&&(r&&r>0?d=E(d.line,d.ch-r):e.state.overwrite&&!l?p=E(p.line,Math.min(M(o,p.line).text.length,p.ch+g(s).length)):qs&&qs.lineWise&&qs.text.join("\n")==t&&(d=p=E(d.line,0))),c=e.curOp.updateInput;var m={from:d,to:p,text:a?a[f%a.length]:s,origin:i||(l?"paste":e.state.cutIncoming?"cut":"+input")};Oi(e.doc,m),bt(e,"inputRead",e,m)}t&&!l&&Zo(e,t),jr(e),e.curOp.updateInput=c,e.curOp.typing=!0,e.state.pasteIncoming=e.state.cutIncoming=!1}function qo(e,t){var r=e.clipboardData&&e.clipboardData.getData("Text");if(r)return e.preventDefault(),t.isReadOnly()||t.options.disableInput||hn(t,function(){return $o(t,r,0,null,"paste")}),!0}function Zo(e,t){if(e.options.electricChars&&e.options.smartIndent)for(var r=e.doc.sel,n=r.ranges.length-1;n>=0;n--){var i=r.ranges[n];if(!(i.head.ch>100||n&&r.ranges[n-1].head.line==i.head.line)){var o=e.getModeAt(i.head),l=!1;if(o.electricChars){for(var s=0;s<o.electricChars.length;s++)if(t.indexOf(o.electricChars.charAt(s))>-1){l=Yo(e,i.head.line,"smart");break}}else o.electricInput&&o.electricInput.test(M(e.doc,i.head.line).text.slice(0,i.head.ch))&&(l=Yo(e,i.head.line,"smart"));l&&bt(e,"electricInput",e,i.head.line)}}}function Qo(e){for(var t=[],r=[],n=0;n<e.doc.sel.ranges.length;n++){var i=e.doc.sel.ranges[n].head.line,o={anchor:E(i,0),head:E(i+1,0)};r.push(o),t.push(e.getRange(o.anchor,o.head))}return{text:t,ranges:r}}function Jo(e,t){e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!!t)}function el(){var e=n("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; outline: none"),t=n("div",[e],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return ml?e.style.width="1000px":e.setAttribute("wrap","off"),Ll&&(e.style.border="1px solid black"),Jo(e),t}function tl(e,t,r,n,i){function o(){var n=t.line+r;return!(n<e.first||n>=e.first+e.size)&&(t=new E(n,t.ch,t.sticky),u=M(e,n))}function l(n){var l;if(null==(l=i?go(e.cm,u,t,r):ho(u,t,r))){if(n||!o())return!1;t=po(i,e.cm,u,t.line,r)}else t=l;return!0}var s=t,a=r,u=M(e,t.line);if("char"==n)l();else if("column"==n)l(!0);else if("word"==n||"group"==n)for(var c=null,f="group"==n,h=e.cm&&e.cm.getHelper(t,"wordChars"),d=!0;!(r<0)||l(!d);d=!1){var p=u.text.charAt(t.ch)||"\n",g=x(p,h)?"w":f&&"\n"==p?"n":!f||/\s/.test(p)?null:"p";if(!f||d||g||(g="s"),c&&c!=g){r<0&&(r=1,l(),t.sticky="after");break}if(g&&(c=g),r>0&&!l(!d))break}var v=ki(e,t,s,a,!0);return I(s,v)&&(v.hitSide=!0),v}function rl(e,t,r,n){var i,o=e.doc,l=t.left;if("page"==n){var s=Math.min(e.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight),a=Math.max(s-.5*mr(e.display),3);i=(r>0?t.bottom:t.top)+r*a}else"line"==n&&(i=r>0?t.bottom+3:t.top-3);for(var u;(u=cr(e,l,i)).outside;){if(r<0?i<=0:i>=o.height){u.hitSide=!0;break}i+=5*r}return u}function nl(e,t){var r=jt(e,t.line);if(!r||r.hidden)return null;var n=M(e.doc,t.line),i=Ut(r,n,t.line),o=Se(n,e.doc.direction),l="left";o&&(l=Ce(o,t.ch)%2?"right":"left");var s=_t(i.map,t.ch,l);return s.offset="right"==s.collapse?s.end:s.start,s}function il(e){for(var t=e;t;t=t.parentNode)if(/CodeMirror-gutter-wrapper/.test(t.className))return!0;return!1}function ol(e,t){return t&&(e.bad=!0),e}function ll(e,t,r,n,i){function o(e){return function(t){return t.id==e}}function l(){c&&(u+=f,c=!1)}function s(e){e&&(l(),u+=e)}function a(t){if(1==t.nodeType){var r=t.getAttribute("cm-text");if(null!=r)return void s(r||t.textContent.replace(/\u200b/g,""));var u,h=t.getAttribute("cm-marker");if(h){var d=e.findMarks(E(n,0),E(i+1,0),o(+h));return void(d.length&&(u=d[0].find(0))&&s(N(e.doc,u.from,u.to).join(f)))}if("false"==t.getAttribute("contenteditable"))return;var p=/^(pre|div|p)$/i.test(t.nodeName);p&&l();for(var g=0;g<t.childNodes.length;g++)a(t.childNodes[g]);p&&(c=!0)}else 3==t.nodeType&&s(t.nodeValue)}for(var u="",c=!1,f=e.doc.lineSeparator();a(t),t!=r;)t=t.nextSibling;return u}function sl(e,t,r){var n;if(t==e.display.lineDiv){if(!(n=e.display.lineDiv.childNodes[r]))return ol(e.clipPos(E(e.display.viewTo-1)),!0);t=null,r=0}else for(n=t;;n=n.parentNode){if(!n||n==e.display.lineDiv)return null;if(n.parentNode&&n.parentNode==e.display.lineDiv)break}for(var i=0;i<e.display.view.length;i++){var o=e.display.view[i];if(o.node==n)return al(o,t,r)}}function al(e,t,r){function n(t,r,n){for(var i=-1;i<(f?f.length:0);i++)for(var o=i<0?c.map:f[i],l=0;l<o.length;l+=3){var s=o[l+2];if(s==t||s==r){var a=W(i<0?e.line:e.rest[i]),u=o[l]+n;return(n<0||s!=t)&&(u=o[l+(n?1:0)]),E(a,u)}}}var i=e.text.firstChild,l=!1;if(!t||!o(i,t))return ol(E(W(e.line),0),!0);if(t==i&&(l=!0,t=i.childNodes[r],r=0,!t)){var s=e.rest?g(e.rest):e.line;return ol(E(W(s),s.text.length),l)}var a=3==t.nodeType?t:null,u=t;for(a||1!=t.childNodes.length||3!=t.firstChild.nodeType||(a=t.firstChild,r&&(r=a.nodeValue.length));u.parentNode!=i;)u=u.parentNode;var c=e.measure,f=c.maps,h=n(a,u,r);if(h)return ol(h,l);for(var d=u.nextSibling,p=a?a.nodeValue.length-r:0;d;d=d.nextSibling){if(h=n(d,d.firstChild,0))return ol(E(h.line,h.ch-p),l);p+=d.textContent.length}for(var v=u.previousSibling,m=r;v;v=v.previousSibling){if(h=n(v,v.firstChild,-1))return ol(E(h.line,h.ch+m),l);m+=v.textContent.length}}var ul=navigator.userAgent,cl=navigator.platform,fl=/gecko\/\d/i.test(ul),hl=/MSIE \d/.test(ul),dl=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(ul),pl=/Edge\/(\d+)/.exec(ul),gl=hl||dl||pl,vl=gl&&(hl?document.documentMode||6:+(pl||dl)[1]),ml=!pl&&/WebKit\//.test(ul),yl=ml&&/Qt\/\d+\.\d+/.test(ul),bl=!pl&&/Chrome\//.test(ul),wl=/Opera\//.test(ul),xl=/Apple Computer/.test(navigator.vendor),Cl=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(ul),Sl=/PhantomJS/.test(ul),Ll=!pl&&/AppleWebKit/.test(ul)&&/Mobile\/\w+/.test(ul),kl=/Android/.test(ul),Tl=Ll||kl||/webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(ul),Ml=Ll||/Mac/.test(cl),Nl=/\bCrOS\b/.test(ul),Ol=/win/i.test(cl),Al=wl&&ul.match(/Version\/(\d*\.\d*)/);Al&&(Al=Number(Al[1])),Al&&Al>=15&&(wl=!1,ml=!0);var Wl,Dl=Ml&&(yl||wl&&(null==Al||Al<12.11)),Hl=fl||gl&&vl>=9,Fl=function(t,r){var n=t.className,i=e(r).exec(n);if(i){var o=n.slice(i.index+i[0].length);t.className=n.slice(0,i.index)+(o?i[1]+o:"")}};Wl=document.createRange?function(e,t,r,n){var i=document.createRange();return i.setEnd(n||e,r),i.setStart(e,t),i}:function(e,t,r){var n=document.body.createTextRange();try{n.moveToElementText(e.parentNode)}catch(e){return n}return n.collapse(!0),n.moveEnd("character",r),n.moveStart("character",t),n};var El=function(e){e.select()};Ll?El=function(e){e.selectionStart=0,e.selectionEnd=e.value.length}:gl&&(El=function(e){try{e.select()}catch(e){}});var Pl=function(){this.id=null};Pl.prototype.set=function(e,t){clearTimeout(this.id),this.id=setTimeout(t,e)};var Il,zl,Rl=30,Bl={toString:function(){return"CodeMirror.Pass"}},Gl={scroll:!1},Ul={origin:"*mouse"},Vl={origin:"+move"},Kl=[""],jl=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/,Xl=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/,Yl=!1,_l=!1,$l=null,ql=function(){function e(e){return e<=247?r.charAt(e):1424<=e&&e<=1524?"R":1536<=e&&e<=1785?n.charAt(e-1536):1774<=e&&e<=2220?"r":8192<=e&&e<=8203?"w":8204==e?"b":"L"}function t(e,t,r){this.level=e,this.from=t,this.to=r}var r="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",n="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111",i=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,o=/[stwN]/,l=/[LRr]/,s=/[Lb1n]/,a=/[1n]/;return function(r,n){var u="ltr"==n?"L":"R";if(0==r.length||"ltr"==n&&!i.test(r))return!1;for(var c=r.length,f=[],h=0;h<c;++h)f.push(e(r.charCodeAt(h)));for(var d=0,p=u;d<c;++d){var v=f[d];"m"==v?f[d]=p:p=v}for(var m=0,y=u;m<c;++m){var b=f[m];"1"==b&&"r"==y?f[m]="n":l.test(b)&&(y=b,"r"==b&&(f[m]="R"))}for(var w=1,x=f[0];w<c-1;++w){var C=f[w];"+"==C&&"1"==x&&"1"==f[w+1]?f[w]="1":","!=C||x!=f[w+1]||"1"!=x&&"n"!=x||(f[w]=x),x=C}for(var S=0;S<c;++S){var L=f[S];if(","==L)f[S]="N";else if("%"==L){var k=void 0;for(k=S+1;k<c&&"%"==f[k];++k);for(var T=S&&"!"==f[S-1]||k<c&&"1"==f[k]?"1":"N",M=S;M<k;++M)f[M]=T;S=k-1}}for(var N=0,O=u;N<c;++N){var A=f[N];"L"==O&&"1"==A?f[N]="L":l.test(A)&&(O=A)}for(var W=0;W<c;++W)if(o.test(f[W])){var D=void 0;for(D=W+1;D<c&&o.test(f[D]);++D);for(var H="L"==(W?f[W-1]:u),F=H==("L"==(D<c?f[D]:u))?H?"L":"R":u,E=W;E<D;++E)f[E]=F;W=D-1}for(var P,I=[],z=0;z<c;)if(s.test(f[z])){var R=z;for(++z;z<c&&s.test(f[z]);++z);I.push(new t(0,R,z))}else{var B=z,G=I.length;for(++z;z<c&&"L"!=f[z];++z);for(var U=B;U<z;)if(a.test(f[U])){B<U&&I.splice(G,0,new t(1,B,U));var V=U;for(++U;U<z&&a.test(f[U]);++U);I.splice(G,0,new t(2,V,U)),B=U}else++U;B<z&&I.splice(G,0,new t(1,B,z))}return 1==I[0].level&&(P=r.match(/^\s+/))&&(I[0].from=P[0].length,I.unshift(new t(0,0,P[0].length))),1==g(I).level&&(P=r.match(/\s+$/))&&(g(I).to-=P[0].length,I.push(new t(0,c-P[0].length,c))),"rtl"==n?I.reverse():I}}(),Zl=[],Ql=function(e,t,r){if(e.addEventListener)e.addEventListener(t,r,!1);else if(e.attachEvent)e.attachEvent("on"+t,r);else{var n=e._handlers||(e._handlers={});n[t]=(n[t]||Zl).concat(r)}},Jl=function(){if(gl&&vl<9)return!1;var e=n("div");return"draggable"in e||"dragDrop"in e}(),es=3!="\n\nb".split(/\n/).length?function(e){for(var t=0,r=[],n=e.length;t<=n;){var i=e.indexOf("\n",t);-1==i&&(i=e.length);var o=e.slice(t,"\r"==e.charAt(i-1)?i-1:i),l=o.indexOf("\r");-1!=l?(r.push(o.slice(0,l)),t+=l+1):(r.push(o),t=i+1)}return r}:function(e){return e.split(/\r\n?|\n/)},ts=window.getSelection?function(e){try{return e.selectionStart!=e.selectionEnd}catch(e){return!1}}:function(e){var t;try{t=e.ownerDocument.selection.createRange()}catch(e){}return!(!t||t.parentElement()!=e)&&0!=t.compareEndPoints("StartToEnd",t)},rs=function(){var e=n("div");return"oncopy"in e||(e.setAttribute("oncopy","return;"),"function"==typeof e.oncopy)}(),ns=null,is={},os={},ls={},ss=function(e,t,r){this.pos=this.start=0,this.string=e,this.tabSize=t||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0,this.lineOracle=r};ss.prototype.eol=function(){return this.pos>=this.string.length},ss.prototype.sol=function(){return this.pos==this.lineStart},ss.prototype.peek=function(){return this.string.charAt(this.pos)||void 0},ss.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},ss.prototype.eat=function(e){var t=this.string.charAt(this.pos);if("string"==typeof e?t==e:t&&(e.test?e.test(t):e(t)))return++this.pos,t},ss.prototype.eatWhile=function(e){for(var t=this.pos;this.eat(e););return this.pos>t},ss.prototype.eatSpace=function(){for(var e=this,t=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++e.pos;return this.pos>t},ss.prototype.skipToEnd=function(){this.pos=this.string.length},ss.prototype.skipTo=function(e){var t=this.string.indexOf(e,this.pos);if(t>-1)return this.pos=t,!0},ss.prototype.backUp=function(e){this.pos-=e},ss.prototype.column=function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=f(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?f(this.string,this.lineStart,this.tabSize):0)},ss.prototype.indentation=function(){return f(this.string,null,this.tabSize)-(this.lineStart?f(this.string,this.lineStart,this.tabSize):0)},ss.prototype.match=function(e,t,r){if("string"!=typeof e){var n=this.string.slice(this.pos).match(e);return n&&n.index>0?null:(n&&!1!==t&&(this.pos+=n[0].length),n)}var i=function(e){return r?e.toLowerCase():e};if(i(this.string.substr(this.pos,e.length))==i(e))return!1!==t&&(this.pos+=e.length),!0},ss.prototype.current=function(){return this.string.slice(this.start,this.pos)},ss.prototype.hideFirstChars=function(e,t){this.lineStart+=e;try{return t()}finally{this.lineStart-=e}},ss.prototype.lookAhead=function(e){var t=this.lineOracle;return t&&t.lookAhead(e)};var as=function(e,t){this.state=e,this.lookAhead=t},us=function(e,t,r,n){this.state=t,this.doc=e,this.line=r,this.maxLookAhead=n||0};us.prototype.lookAhead=function(e){var t=this.doc.getLine(this.line+e);return null!=t&&e>this.maxLookAhead&&(this.maxLookAhead=e),t},us.prototype.nextLine=function(){this.line++,this.maxLookAhead>0&&this.maxLookAhead--},us.fromSaved=function(e,t,r){return t instanceof as?new us(e,Ke(e.mode,t.state),r,t.lookAhead):new us(e,Ke(e.mode,t),r)},us.prototype.save=function(e){var t=!1!==e?Ke(this.doc.mode,this.state):this.state;return this.maxLookAhead>0?new as(t,this.maxLookAhead):t};var cs=function(e,t,r){this.start=e.start,this.end=e.pos,this.string=e.current(),this.type=t||null,this.state=r},fs=function(e,t,r){this.text=e,ne(this,t),this.height=r?r(this):1};fs.prototype.lineNo=function(){return W(this)},Ae(fs);var hs,ds={},ps={},gs=null,vs=null,ms={left:0,right:0,top:0,bottom:0},ys=function(e,t,r){this.cm=r;var i=this.vert=n("div",[n("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),o=this.horiz=n("div",[n("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");e(i),e(o),Ql(i,"scroll",function(){i.clientHeight&&t(i.scrollTop,"vertical")}),Ql(o,"scroll",function(){o.clientWidth&&t(o.scrollLeft,"horizontal")}),this.checkedZeroWidth=!1,gl&&vl<8&&(this.horiz.style.minHeight=this.vert.style.minWidth="18px")};ys.prototype.update=function(e){var t=e.scrollWidth>e.clientWidth+1,r=e.scrollHeight>e.clientHeight+1,n=e.nativeBarWidth;if(r){this.vert.style.display="block",this.vert.style.bottom=t?n+"px":"0";var i=e.viewHeight-(t?n:0);this.vert.firstChild.style.height=Math.max(0,e.scrollHeight-e.clientHeight+i)+"px"}else this.vert.style.display="",this.vert.firstChild.style.height="0";if(t){this.horiz.style.display="block",this.horiz.style.right=r?n+"px":"0",this.horiz.style.left=e.barLeft+"px";var o=e.viewWidth-e.barLeft-(r?n:0);this.horiz.firstChild.style.width=Math.max(0,e.scrollWidth-e.clientWidth+o)+"px"}else this.horiz.style.display="",this.horiz.firstChild.style.width="0";return!this.checkedZeroWidth&&e.clientHeight>0&&(0==n&&this.zeroWidthHack(),this.checkedZeroWidth=!0),{right:r?n:0,bottom:t?n:0}},ys.prototype.setScrollLeft=function(e){this.horiz.scrollLeft!=e&&(this.horiz.scrollLeft=e),this.disableHoriz&&this.enableZeroWidthBar(this.horiz,this.disableHoriz,"horiz")},ys.prototype.setScrollTop=function(e){this.vert.scrollTop!=e&&(this.vert.scrollTop=e),this.disableVert&&this.enableZeroWidthBar(this.vert,this.disableVert,"vert")},ys.prototype.zeroWidthHack=function(){var e=Ml&&!Cl?"12px":"18px";this.horiz.style.height=this.vert.style.width=e,this.horiz.style.pointerEvents=this.vert.style.pointerEvents="none",this.disableHoriz=new Pl,this.disableVert=new Pl},ys.prototype.enableZeroWidthBar=function(e,t,r){function n(){var i=e.getBoundingClientRect();("vert"==r?document.elementFromPoint(i.right-1,(i.top+i.bottom)/2):document.elementFromPoint((i.right+i.left)/2,i.bottom-1))!=e?e.style.pointerEvents="none":t.set(1e3,n)}e.style.pointerEvents="auto",t.set(1e3,n)},ys.prototype.clear=function(){var e=this.horiz.parentNode;e.removeChild(this.horiz),e.removeChild(this.vert)};var bs=function(){};bs.prototype.update=function(){return{bottom:0,right:0}},bs.prototype.setScrollLeft=function(){},bs.prototype.setScrollTop=function(){},bs.prototype.clear=function(){};var ws={native:ys,null:bs},xs=0,Cs=function(e,t,r){var n=e.display;this.viewport=t,this.visible=Ir(n,e.doc,t),this.editorIsHidden=!n.wrapper.offsetWidth,this.wrapperHeight=n.wrapper.clientHeight,this.wrapperWidth=n.wrapper.clientWidth,this.oldDisplayWidth=Rt(e),this.force=r,this.dims=br(e),this.events=[]};Cs.prototype.signal=function(e,t){Oe(e,t)&&this.events.push(arguments)},Cs.prototype.finish=function(){for(var e=this,t=0;t<this.events.length;t++)Te.apply(null,e.events[t])};var Ss=0,Ls=null;gl?Ls=-.53:fl?Ls=15:bl?Ls=-.7:xl&&(Ls=-1/3);var ks=function(e,t){this.ranges=e,this.primIndex=t};ks.prototype.primary=function(){return this.ranges[this.primIndex]},ks.prototype.equals=function(e){var t=this;if(e==this)return!0;if(e.primIndex!=this.primIndex||e.ranges.length!=this.ranges.length)return!1;for(var r=0;r<this.ranges.length;r++){var n=t.ranges[r],i=e.ranges[r];if(!I(n.anchor,i.anchor)||!I(n.head,i.head))return!1}return!0},ks.prototype.deepCopy=function(){for(var e=this,t=[],r=0;r<this.ranges.length;r++)t[r]=new Ts(z(e.ranges[r].anchor),z(e.ranges[r].head));return new ks(t,this.primIndex)},ks.prototype.somethingSelected=function(){for(var e=this,t=0;t<this.ranges.length;t++)if(!e.ranges[t].empty())return!0;return!1},ks.prototype.contains=function(e,t){var r=this;t||(t=e);for(var n=0;n<this.ranges.length;n++){var i=r.ranges[n];if(P(t,i.from())>=0&&P(e,i.to())<=0)return n}return-1};var Ts=function(e,t){this.anchor=e,this.head=t};Ts.prototype.from=function(){return B(this.anchor,this.head)},Ts.prototype.to=function(){return R(this.anchor,this.head)},Ts.prototype.empty=function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch},Bi.prototype={chunkSize:function(){return this.lines.length},removeInner:function(e,t){for(var r=this,n=e,i=e+t;n<i;++n){var o=r.lines[n];r.height-=o.height,ot(o),bt(o,"delete")}this.lines.splice(e,t)},collapse:function(e){e.push.apply(e,this.lines)},insertInner:function(e,t,r){var n=this;this.height+=r,this.lines=this.lines.slice(0,e).concat(t).concat(this.lines.slice(e));for(var i=0;i<t.length;++i)t[i].parent=n},iterN:function(e,t,r){for(var n=this,i=e+t;e<i;++e)if(r(n.lines[e]))return!0}},Gi.prototype={chunkSize:function(){return this.size},removeInner:function(e,t){var r=this;this.size-=t;for(var n=0;n<this.children.length;++n){var i=r.children[n],o=i.chunkSize();if(e<o){var l=Math.min(t,o-e),s=i.height;if(i.removeInner(e,l),r.height-=s-i.height,o==l&&(r.children.splice(n--,1),i.parent=null),0==(t-=l))break;e=0}else e-=o}if(this.size-t<25&&(this.children.length>1||!(this.children[0]instanceof Bi))){var a=[];this.collapse(a),this.children=[new Bi(a)],this.children[0].parent=this}},collapse:function(e){for(var t=this,r=0;r<this.children.length;++r)t.children[r].collapse(e)},insertInner:function(e,t,r){var n=this;this.size+=t.length,this.height+=r;for(var i=0;i<this.children.length;++i){var o=n.children[i],l=o.chunkSize();if(e<=l){if(o.insertInner(e,t,r),o.lines&&o.lines.length>50){for(var s=o.lines.length%25+25,a=s;a<o.lines.length;){var u=new Bi(o.lines.slice(a,a+=25));o.height-=u.height,n.children.splice(++i,0,u),u.parent=n}o.lines=o.lines.slice(0,s),n.maybeSpill()}break}e-=l}},maybeSpill:function(){if(!(this.children.length<=10)){var e=this;do{var t=new Gi(e.children.splice(e.children.length-5,5));if(e.parent){e.size-=t.size,e.height-=t.height;var r=h(e.parent.children,e);e.parent.children.splice(r+1,0,t)}else{var n=new Gi(e.children);n.parent=e,e.children=[n,t],e=n}t.parent=e.parent}while(e.children.length>10);e.parent.maybeSpill()}},iterN:function(e,t,r){for(var n=this,i=0;i<this.children.length;++i){var o=n.children[i],l=o.chunkSize();if(e<l){var s=Math.min(t,l-e);if(o.iterN(e,s,r))return!0;if(0==(t-=s))break;e=0}else e-=l}}};var Ms=function(e,t,r){var n=this;if(r)for(var i in r)r.hasOwnProperty(i)&&(n[i]=r[i]);this.doc=e,this.node=t};Ms.prototype.clear=function(){var e=this,t=this.doc.cm,r=this.line.widgets,n=this.line,i=W(n);if(null!=i&&r){for(var o=0;o<r.length;++o)r[o]==e&&r.splice(o--,1);r.length||(n.widgets=null);var l=Ht(this);A(n,Math.max(0,n.height-l)),t&&(hn(t,function(){Ui(t,n,-l),mn(t,i,"widget")}),bt(t,"lineWidgetCleared",t,this,i))}},Ms.prototype.changed=function(){var e=this,t=this.height,r=this.doc.cm,n=this.line;this.height=null;var i=Ht(this)-t;i&&(A(n,n.height+i),r&&hn(r,function(){r.curOp.forceUpdate=!0,Ui(r,n,i),bt(r,"lineWidgetChanged",r,e,W(n))}))},Ae(Ms);var Ns=0,Os=function(e,t){this.lines=[],this.type=t,this.doc=e,this.id=++Ns};Os.prototype.clear=function(){var e=this;if(!this.explicitlyCleared){var t=this.doc.cm,r=t&&!t.curOp;if(r&&nn(t),Oe(this,"clear")){var n=this.find();n&&bt(this,"clear",n.from,n.to)}for(var i=null,o=null,l=0;l<this.lines.length;++l){var s=e.lines[l],a=_(s.markedSpans,e);t&&!e.collapsed?mn(t,W(s),"text"):t&&(null!=a.to&&(o=W(s)),null!=a.from&&(i=W(s))),s.markedSpans=$(s.markedSpans,a),null==a.from&&e.collapsed&&!ve(e.doc,s)&&t&&A(s,mr(t.display))}if(t&&this.collapsed&&!t.options.lineWrapping)for(var u=0;u<this.lines.length;++u){var c=fe(e.lines[u]),f=be(c);f>t.display.maxLineLength&&(t.display.maxLine=c,t.display.maxLineLength=f,t.display.maxLineChanged=!0)}null!=i&&t&&this.collapsed&&vn(t,i,o+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,t&&Ci(t.doc)),t&&bt(t,"markerCleared",t,this,i,o),r&&on(t),this.parent&&this.parent.clear()}},Os.prototype.find=function(e,t){var r=this;null==e&&"bookmark"==this.type&&(e=1);for(var n,i,o=0;o<this.lines.length;++o){var l=r.lines[o],s=_(l.markedSpans,r);if(null!=s.from&&(n=E(t?l:W(l),s.from),-1==e))return n;if(null!=s.to&&(i=E(t?l:W(l),s.to),1==e))return i}return n&&{from:n,to:i}},Os.prototype.changed=function(){var e=this,t=this.find(-1,!0),r=this,n=this.doc.cm;t&&n&&hn(n,function(){var i=t.line,o=W(t.line),l=jt(n,o);if(l&&(Qt(l),n.curOp.selectionChanged=n.curOp.forceUpdate=!0),n.curOp.updateMaxLine=!0,!ve(r.doc,i)&&null!=r.height){var s=r.height;r.height=null;var a=Ht(r)-s;a&&A(i,i.height+a)}bt(n,"markerChanged",n,e)})},Os.prototype.attachLine=function(e){if(!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;t.maybeHiddenMarkers&&-1!=h(t.maybeHiddenMarkers,this)||(t.maybeUnhiddenMarkers||(t.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(e)},Os.prototype.detachLine=function(e){if(this.lines.splice(h(this.lines,e),1),!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;(t.maybeHiddenMarkers||(t.maybeHiddenMarkers=[])).push(this)}},Ae(Os);var As=function(e,t){var r=this;this.markers=e,this.primary=t;for(var n=0;n<e.length;++n)e[n].parent=r};As.prototype.clear=function(){var e=this;if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var t=0;t<this.markers.length;++t)e.markers[t].clear();bt(this,"clear")}},As.prototype.find=function(e,t){return this.primary.find(e,t)},Ae(As);var Ws=0,Ds=function(e,t,r,n,i){if(!(this instanceof Ds))return new Ds(e,t,r,n,i);null==r&&(r=0),Gi.call(this,[new Bi([new fs("",null)])]),this.first=r,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=r;var o=E(r,0);this.sel=Rn(o),this.history=new Jn(null),this.id=++Ws,this.modeOption=t,this.lineSep=n,this.direction="rtl"==i?"rtl":"ltr",this.extend=!1,"string"==typeof e&&(e=this.splitLines(e)),_n(this,{from:o,to:o,text:e}),bi(this,Rn(o),Gl)};Ds.prototype=b(Gi.prototype,{constructor:Ds,iter:function(e,t,r){r?this.iterN(e-this.first,t-e,r):this.iterN(this.first,this.first+this.size,e)},insert:function(e,t){for(var r=0,n=0;n<t.length;++n)r+=t[n].height;this.insertInner(e-this.first,t,r)},remove:function(e,t){this.removeInner(e-this.first,t)},getValue:function(e){var t=O(this,this.first,this.first+this.size);return!1===e?t:t.join(e||this.lineSeparator())},setValue:gn(function(e){var t=E(this.first,0),r=this.first+this.size-1;Oi(this,{from:t,to:E(r,M(this,r).text.length),text:this.splitLines(e),origin:"setValue",full:!0},!0),this.cm&&Xr(this.cm,0,0),bi(this,Rn(t),Gl)}),replaceRange:function(e,t,r,n){Ei(this,e,t=U(this,t),r=r?U(this,r):t,n)},getRange:function(e,t,r){var n=N(this,U(this,e),U(this,t));return!1===r?n:n.join(r||this.lineSeparator())},getLine:function(e){var t=this.getLineHandle(e);return t&&t.text},getLineHandle:function(e){if(H(this,e))return M(this,e)},getLineNumber:function(e){return W(e)},getLineHandleVisualStart:function(e){return"number"==typeof e&&(e=M(this,e)),fe(e)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(e){return U(this,e)},getCursor:function(e){var t=this.sel.primary();return null==e||"head"==e?t.head:"anchor"==e?t.anchor:"end"==e||"to"==e||!1===e?t.to():t.from()},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:gn(function(e,t,r){vi(this,U(this,"number"==typeof e?E(e,t||0):e),null,r)}),setSelection:gn(function(e,t,r){vi(this,U(this,e),U(this,t||e),r)}),extendSelection:gn(function(e,t,r){di(this,U(this,e),t&&U(this,t),r)}),extendSelections:gn(function(e,t){pi(this,K(this,e),t)}),extendSelectionsBy:gn(function(e,t){pi(this,K(this,v(this.sel.ranges,e)),t)}),setSelections:gn(function(e,t,r){var n=this;if(e.length){for(var i=[],o=0;o<e.length;o++)i[o]=new Ts(U(n,e[o].anchor),U(n,e[o].head));null==t&&(t=Math.min(e.length-1,this.sel.primIndex)),bi(this,zn(i,t),r)}}),addSelection:gn(function(e,t,r){var n=this.sel.ranges.slice(0);n.push(new Ts(U(this,e),U(this,t||e))),bi(this,zn(n,n.length-1),r)}),getSelection:function(e){for(var t,r=this,n=this.sel.ranges,i=0;i<n.length;i++){var o=N(r,n[i].from(),n[i].to());t=t?t.concat(o):o}return!1===e?t:t.join(e||this.lineSeparator())},getSelections:function(e){for(var t=this,r=[],n=this.sel.ranges,i=0;i<n.length;i++){var o=N(t,n[i].from(),n[i].to());!1!==e&&(o=o.join(e||t.lineSeparator())),r[i]=o}return r},replaceSelection:function(e,t,r){for(var n=[],i=0;i<this.sel.ranges.length;i++)n[i]=e;this.replaceSelections(n,t,r||"+input")},replaceSelections:gn(function(e,t,r){for(var n=this,i=[],o=this.sel,l=0;l<o.ranges.length;l++){var s=o.ranges[l];i[l]={from:s.from(),to:s.to(),text:n.splitLines(e[l]),origin:r}}for(var a=t&&"end"!=t&&Kn(this,i,t),u=i.length-1;u>=0;u--)Oi(n,i[u]);a?yi(this,a):this.cm&&jr(this.cm)}),undo:gn(function(){Wi(this,"undo")}),redo:gn(function(){Wi(this,"redo")}),undoSelection:gn(function(){Wi(this,"undo",!0)}),redoSelection:gn(function(){Wi(this,"redo",!0)}),setExtending:function(e){this.extend=e},getExtending:function(){return this.extend},historySize:function(){for(var e=this.history,t=0,r=0,n=0;n<e.done.length;n++)e.done[n].ranges||++t;for(var i=0;i<e.undone.length;i++)e.undone[i].ranges||++r;return{undo:t,redo:r}},clearHistory:function(){this.history=new Jn(this.history.maxGeneration)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(e){return e&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(e){return this.history.generation==(e||this.cleanGeneration)},getHistory:function(){return{done:fi(this.history.done),undone:fi(this.history.undone)}},setHistory:function(e){var t=this.history=new Jn(this.history.maxGeneration);t.done=fi(e.done.slice(0),null,!0),t.undone=fi(e.undone.slice(0),null,!0)},setGutterMarker:gn(function(e,t,r){return Ri(this,e,"gutter",function(e){var n=e.gutterMarkers||(e.gutterMarkers={});return n[t]=r,!r&&C(n)&&(e.gutterMarkers=null),!0})}),clearGutter:gn(function(e){var t=this;this.iter(function(r){r.gutterMarkers&&r.gutterMarkers[e]&&Ri(t,r,"gutter",function(){return r.gutterMarkers[e]=null,C(r.gutterMarkers)&&(r.gutterMarkers=null),!0})})}),lineInfo:function(e){var t;if("number"==typeof e){if(!H(this,e))return null;if(t=e,!(e=M(this,e)))return null}else if(null==(t=W(e)))return null;return{line:t,handle:e,text:e.text,gutterMarkers:e.gutterMarkers,textClass:e.textClass,bgClass:e.bgClass,wrapClass:e.wrapClass,widgets:e.widgets}},addLineClass:gn(function(t,r,n){return Ri(this,t,"gutter"==r?"gutter":"class",function(t){var i="text"==r?"textClass":"background"==r?"bgClass":"gutter"==r?"gutterClass":"wrapClass";if(t[i]){if(e(n).test(t[i]))return!1;t[i]+=" "+n}else t[i]=n;return!0})}),removeLineClass:gn(function(t,r,n){return Ri(this,t,"gutter"==r?"gutter":"class",function(t){var i="text"==r?"textClass":"background"==r?"bgClass":"gutter"==r?"gutterClass":"wrapClass",o=t[i];if(!o)return!1;if(null==n)t[i]=null;else{var l=o.match(e(n));if(!l)return!1;var s=l.index+l[0].length;t[i]=o.slice(0,l.index)+(l.index&&s!=o.length?" ":"")+o.slice(s)||null}return!0})}),addLineWidget:gn(function(e,t,r){return Vi(this,e,t,r)}),removeLineWidget:function(e){e.clear()},markText:function(e,t,r){return Ki(this,U(this,e),U(this,t),r,r&&r.type||"range")},setBookmark:function(e,t){var r={replacedWith:t&&(null==t.nodeType?t.widget:t),insertLeft:t&&t.insertLeft,clearWhenEmpty:!1,shared:t&&t.shared,handleMouseEvents:t&&t.handleMouseEvents};return e=U(this,e),Ki(this,e,e,r,"bookmark")},findMarksAt:function(e){var t=[],r=M(this,(e=U(this,e)).line).markedSpans;if(r)for(var n=0;n<r.length;++n){var i=r[n];(null==i.from||i.from<=e.ch)&&(null==i.to||i.to>=e.ch)&&t.push(i.marker.parent||i.marker)}return t},findMarks:function(e,t,r){e=U(this,e),t=U(this,t);var n=[],i=e.line;return this.iter(e.line,t.line+1,function(o){var l=o.markedSpans;if(l)for(var s=0;s<l.length;s++){var a=l[s];null!=a.to&&i==e.line&&e.ch>=a.to||null==a.from&&i!=e.line||null!=a.from&&i==t.line&&a.from>=t.ch||r&&!r(a.marker)||n.push(a.marker.parent||a.marker)}++i}),n},getAllMarks:function(){var e=[];return this.iter(function(t){var r=t.markedSpans;if(r)for(var n=0;n<r.length;++n)null!=r[n].from&&e.push(r[n].marker)}),e},posFromIndex:function(e){var t,r=this.first,n=this.lineSeparator().length;return this.iter(function(i){var o=i.text.length+n;if(o>e)return t=e,!0;e-=o,++r}),U(this,E(r,t))},indexFromPos:function(e){var t=(e=U(this,e)).ch;if(e.line<this.first||e.ch<0)return 0;var r=this.lineSeparator().length;return this.iter(this.first,e.line,function(e){t+=e.text.length+r}),t},copy:function(e){var t=new Ds(O(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return t.scrollTop=this.scrollTop,t.scrollLeft=this.scrollLeft,t.sel=this.sel,t.extend=!1,e&&(t.history.undoDepth=this.history.undoDepth,t.setHistory(this.getHistory())),t},linkedDoc:function(e){e||(e={});var t=this.first,r=this.first+this.size;null!=e.from&&e.from>t&&(t=e.from),null!=e.to&&e.to<r&&(r=e.to);var n=new Ds(O(this,t,r),e.mode||this.modeOption,t,this.lineSep,this.direction);return e.sharedHist&&(n.history=this.history),(this.linked||(this.linked=[])).push({doc:n,sharedHist:e.sharedHist}),n.linked=[{doc:this,isParent:!0,sharedHist:e.sharedHist}],Yi(n,Xi(this)),n},unlinkDoc:function(e){var t=this;if(e instanceof jo&&(e=e.doc),this.linked)for(var r=0;r<this.linked.length;++r)if(t.linked[r].doc==e){t.linked.splice(r,1),e.unlinkDoc(t),_i(Xi(t));break}if(e.history==this.history){var n=[e.id];$n(e,function(e){return n.push(e.id)},!0),e.history=new Jn(null),e.history.done=fi(this.history.done,n),e.history.undone=fi(this.history.undone,n)}},iterLinkedDocs:function(e){$n(this,e)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(e){return this.lineSep?e.split(this.lineSep):es(e)},lineSeparator:function(){return this.lineSep||"\n"},setDirection:gn(function(e){"rtl"!=e&&(e="ltr"),e!=this.direction&&(this.direction=e,this.iter(function(e){return e.order=null}),this.cm&&Qn(this.cm))})}),Ds.prototype.eachLine=Ds.prototype.iter;for(var Hs=0,Fs=!1,Es={3:"Enter",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",106:"*",107:"=",109:"-",110:".",111:"/",127:"Delete",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},Ps=0;Ps<10;Ps++)Es[Ps+48]=Es[Ps+96]=String(Ps);for(var Is=65;Is<=90;Is++)Es[Is]=String.fromCharCode(Is);for(var zs=1;zs<=12;zs++)Es[zs+111]=Es[zs+63235]="F"+zs;var Rs={};Rs.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},Rs.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Up":"goLineUp","Ctrl-Down":"goLineDown","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},Rs.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Alt-F":"goWordRight","Alt-B":"goWordLeft","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-D":"delWordAfter","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars","Ctrl-O":"openLine"},Rs.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Home":"goDocStart","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineLeft","Cmd-Right":"goLineRight","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delWrappedLineLeft","Cmd-Delete":"delWrappedLineRight","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd",fallthrough:["basic","emacsy"]},Rs.default=Ml?Rs.macDefault:Rs.pcDefault;var Bs={selectAll:Mi,singleSelection:function(e){return e.setSelection(e.getCursor("anchor"),e.getCursor("head"),Gl)},killLine:function(e){return co(e,function(t){if(t.empty()){var r=M(e.doc,t.head.line).text.length;return t.head.ch==r&&t.head.line<e.lastLine()?{from:t.head,to:E(t.head.line+1,0)}:{from:t.head,to:E(t.head.line,r)}}return{from:t.from(),to:t.to()}})},deleteLine:function(e){return co(e,function(t){return{from:E(t.from().line,0),to:U(e.doc,E(t.to().line+1,0))}})},delLineLeft:function(e){return co(e,function(e){return{from:E(e.from().line,0),to:e.from()}})},delWrappedLineLeft:function(e){return co(e,function(t){var r=e.charCoords(t.head,"div").top+5;return{from:e.coordsChar({left:0,top:r},"div"),to:t.from()}})},delWrappedLineRight:function(e){return co(e,function(t){var r=e.charCoords(t.head,"div").top+5,n=e.coordsChar({left:e.display.lineDiv.offsetWidth+100,top:r},"div");return{from:t.from(),to:n}})},undo:function(e){return e.undo()},redo:function(e){return e.redo()},undoSelection:function(e){return e.undoSelection()},redoSelection:function(e){return e.redoSelection()},goDocStart:function(e){return e.extendSelection(E(e.firstLine(),0))},goDocEnd:function(e){return e.extendSelection(E(e.lastLine()))},goLineStart:function(e){return e.extendSelectionsBy(function(t){return vo(e,t.head.line)},{origin:"+move",bias:1})},goLineStartSmart:function(e){return e.extendSelectionsBy(function(t){return yo(e,t.head)},{origin:"+move",bias:1})},goLineEnd:function(e){return e.extendSelectionsBy(function(t){return mo(e,t.head.line)},{origin:"+move",bias:-1})},goLineRight:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5;return e.coordsChar({left:e.display.lineDiv.offsetWidth+100,top:r},"div")},Vl)},goLineLeft:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5;return e.coordsChar({left:0,top:r},"div")},Vl)},goLineLeftSmart:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5,n=e.coordsChar({left:0,top:r},"div");return n.ch<e.getLine(n.line).search(/\S/)?yo(e,t.head):n},Vl)},goLineUp:function(e){return e.moveV(-1,"line")},goLineDown:function(e){return e.moveV(1,"line")},goPageUp:function(e){return e.moveV(-1,"page")},goPageDown:function(e){return e.moveV(1,"page")},goCharLeft:function(e){return e.moveH(-1,"char")},goCharRight:function(e){return e.moveH(1,"char")},goColumnLeft:function(e){return e.moveH(-1,"column")},goColumnRight:function(e){return e.moveH(1,"column")},goWordLeft:function(e){return e.moveH(-1,"word")},goGroupRight:function(e){return e.moveH(1,"group")},goGroupLeft:function(e){return e.moveH(-1,"group")},goWordRight:function(e){return e.moveH(1,"word")},delCharBefore:function(e){return e.deleteH(-1,"char")},delCharAfter:function(e){return e.deleteH(1,"char")},delWordBefore:function(e){return e.deleteH(-1,"word")},delWordAfter:function(e){return e.deleteH(1,"word")},delGroupBefore:function(e){return e.deleteH(-1,"group")},delGroupAfter:function(e){return e.deleteH(1,"group")},indentAuto:function(e){return e.indentSelection("smart")},indentMore:function(e){return e.indentSelection("add")},indentLess:function(e){return e.indentSelection("subtract")},insertTab:function(e){return e.replaceSelection("\t")},insertSoftTab:function(e){for(var t=[],r=e.listSelections(),n=e.options.tabSize,i=0;i<r.length;i++){var o=r[i].from(),l=f(e.getLine(o.line),o.ch,n);t.push(p(n-l%n))}e.replaceSelections(t)},defaultTab:function(e){e.somethingSelected()?e.indentSelection("add"):e.execCommand("insertTab")},transposeChars:function(e){return hn(e,function(){for(var t=e.listSelections(),r=[],n=0;n<t.length;n++)if(t[n].empty()){var i=t[n].head,o=M(e.doc,i.line).text;if(o)if(i.ch==o.length&&(i=new E(i.line,i.ch-1)),i.ch>0)i=new E(i.line,i.ch+1),e.replaceRange(o.charAt(i.ch-1)+o.charAt(i.ch-2),E(i.line,i.ch-2),i,"+transpose");else if(i.line>e.doc.first){var l=M(e.doc,i.line-1).text;l&&(i=new E(i.line,1),e.replaceRange(o.charAt(0)+e.doc.lineSeparator()+l.charAt(l.length-1),E(i.line-1,l.length-1),i,"+transpose"))}r.push(new Ts(i,i))}e.setSelections(r)})},newlineAndIndent:function(e){return hn(e,function(){for(var t=e.listSelections(),r=t.length-1;r>=0;r--)e.replaceRange(e.doc.lineSeparator(),t[r].anchor,t[r].head,"+input");t=e.listSelections();for(var n=0;n<t.length;n++)e.indentLine(t[n].from().line,null,!0);jr(e)})},openLine:function(e){return e.replaceSelection("\n","start")},toggleOverwrite:function(e){return e.toggleOverwrite()}},Gs=new Pl,Us=null,Vs=function(e,t,r){this.time=e,this.pos=t,this.button=r};Vs.prototype.compare=function(e,t,r){return this.time+400>e&&0==P(t,this.pos)&&r==this.button};var Ks,js,Xs={toString:function(){return"CodeMirror.Init"}},Ys={},_s={};jo.defaults=Ys,jo.optionHandlers=_s;var $s=[];jo.defineInitHook=function(e){return $s.push(e)};var qs=null,Zs=function(e){this.cm=e,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new Pl,this.composing=null,this.gracePeriod=!1,this.readDOMTimeout=null};Zs.prototype.init=function(e){function t(e){if(!Me(i,e)){if(i.somethingSelected())_o({lineWise:!1,text:i.getSelections()}),"cut"==e.type&&i.replaceSelection("",null,"cut");else{if(!i.options.lineWiseCopyCut)return;var t=Qo(i);_o({lineWise:!0,text:t.text}),"cut"==e.type&&i.operation(function(){i.setSelections(t.ranges,0,Gl),i.replaceSelection("",null,"cut")})}if(e.clipboardData){e.clipboardData.clearData();var r=qs.text.join("\n");if(e.clipboardData.setData("Text",r),e.clipboardData.getData("Text")==r)return void e.preventDefault()}var l=el(),s=l.firstChild;i.display.lineSpace.insertBefore(l,i.display.lineSpace.firstChild),s.value=qs.text.join("\n");var a=document.activeElement;El(s),setTimeout(function(){i.display.lineSpace.removeChild(l),a.focus(),a==o&&n.showPrimarySelection()},50)}}var r=this,n=this,i=n.cm,o=n.div=e.lineDiv;Jo(o,i.options.spellcheck),Ql(o,"paste",function(e){Me(i,e)||qo(e,i)||vl<=11&&setTimeout(dn(i,function(){return r.updateFromDOM()}),20)}),Ql(o,"compositionstart",function(e){r.composing={data:e.data,done:!1}}),Ql(o,"compositionupdate",function(e){r.composing||(r.composing={data:e.data,done:!1})}),Ql(o,"compositionend",function(e){r.composing&&(e.data!=r.composing.data&&r.readFromDOMSoon(),r.composing.done=!0)}),Ql(o,"touchstart",function(){return n.forceCompositionEnd()}),Ql(o,"input",function(){r.composing||r.readFromDOMSoon()}),Ql(o,"copy",t),Ql(o,"cut",t)},Zs.prototype.prepareSelection=function(){var e=Tr(this.cm,!1);return e.focus=this.cm.state.focused,e},Zs.prototype.showSelection=function(e,t){e&&this.cm.display.view.length&&((e.focus||t)&&this.showPrimarySelection(),this.showMultipleSelections(e))},Zs.prototype.showPrimarySelection=function(){var e=window.getSelection(),t=this.cm,r=t.doc.sel.primary(),n=r.from(),i=r.to();if(t.display.viewTo==t.display.viewFrom||n.line>=t.display.viewTo||i.line<t.display.viewFrom)e.removeAllRanges();else{var o=sl(t,e.anchorNode,e.anchorOffset),l=sl(t,e.focusNode,e.focusOffset);if(!o||o.bad||!l||l.bad||0!=P(B(o,l),n)||0!=P(R(o,l),i)){var s=t.display.view,a=n.line>=t.display.viewFrom&&nl(t,n)||{node:s[0].measure.map[2],offset:0},u=i.line<t.display.viewTo&&nl(t,i);if(!u){var c=s[s.length-1].measure,f=c.maps?c.maps[c.maps.length-1]:c.map;u={node:f[f.length-1],offset:f[f.length-2]-f[f.length-3]}}if(a&&u){var h,d=e.rangeCount&&e.getRangeAt(0);try{h=Wl(a.node,a.offset,u.offset,u.node)}catch(e){}h&&(!fl&&t.state.focused?(e.collapse(a.node,a.offset),h.collapsed||(e.removeAllRanges(),e.addRange(h))):(e.removeAllRanges(),e.addRange(h)),d&&null==e.anchorNode?e.addRange(d):fl&&this.startGracePeriod()),this.rememberSelection()}else e.removeAllRanges()}}},Zs.prototype.startGracePeriod=function(){var e=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout(function(){e.gracePeriod=!1,e.selectionChanged()&&e.cm.operation(function(){return e.cm.curOp.selectionChanged=!0})},20)},Zs.prototype.showMultipleSelections=function(e){r(this.cm.display.cursorDiv,e.cursors),r(this.cm.display.selectionDiv,e.selection)},Zs.prototype.rememberSelection=function(){var e=window.getSelection();this.lastAnchorNode=e.anchorNode,this.lastAnchorOffset=e.anchorOffset,this.lastFocusNode=e.focusNode,this.lastFocusOffset=e.focusOffset},Zs.prototype.selectionInEditor=function(){var e=window.getSelection();if(!e.rangeCount)return!1;var t=e.getRangeAt(0).commonAncestorContainer;return o(this.div,t)},Zs.prototype.focus=function(){"nocursor"!=this.cm.options.readOnly&&(this.selectionInEditor()||this.showSelection(this.prepareSelection(),!0),this.div.focus())},Zs.prototype.blur=function(){this.div.blur()},Zs.prototype.getField=function(){return this.div},Zs.prototype.supportsTouch=function(){return!0},Zs.prototype.receivedFocus=function(){function e(){t.cm.state.focused&&(t.pollSelection(),t.polling.set(t.cm.options.pollInterval,e))}var t=this;this.selectionInEditor()?this.pollSelection():hn(this.cm,function(){return t.cm.curOp.selectionChanged=!0}),this.polling.set(this.cm.options.pollInterval,e)},Zs.prototype.selectionChanged=function(){var e=window.getSelection();return e.anchorNode!=this.lastAnchorNode||e.anchorOffset!=this.lastAnchorOffset||e.focusNode!=this.lastFocusNode||e.focusOffset!=this.lastFocusOffset},Zs.prototype.pollSelection=function(){if(null==this.readDOMTimeout&&!this.gracePeriod&&this.selectionChanged()){var e=window.getSelection(),t=this.cm;if(kl&&bl&&this.cm.options.gutters.length&&il(e.anchorNode))return this.cm.triggerOnKeyDown({type:"keydown",keyCode:8,preventDefault:Math.abs}),this.blur(),void this.focus();if(!this.composing){this.rememberSelection();var r=sl(t,e.anchorNode,e.anchorOffset),n=sl(t,e.focusNode,e.focusOffset);r&&n&&hn(t,function(){bi(t.doc,Rn(r,n),Gl),(r.bad||n.bad)&&(t.curOp.selectionChanged=!0)})}}},Zs.prototype.pollContent=function(){null!=this.readDOMTimeout&&(clearTimeout(this.readDOMTimeout),this.readDOMTimeout=null);var e=this.cm,t=e.display,r=e.doc.sel.primary(),n=r.from(),i=r.to();if(0==n.ch&&n.line>e.firstLine()&&(n=E(n.line-1,M(e.doc,n.line-1).length)),i.ch==M(e.doc,i.line).text.length&&i.line<e.lastLine()&&(i=E(i.line+1,0)),n.line<t.viewFrom||i.line>t.viewTo-1)return!1;var o,l,s;n.line==t.viewFrom||0==(o=Lr(e,n.line))?(l=W(t.view[0].line),s=t.view[0].node):(l=W(t.view[o].line),s=t.view[o-1].node.nextSibling);var a,u,c=Lr(e,i.line);if(c==t.view.length-1?(a=t.viewTo-1,u=t.lineDiv.lastChild):(a=W(t.view[c+1].line)-1,u=t.view[c+1].node.previousSibling),!s)return!1;for(var f=e.doc.splitLines(ll(e,s,u,l,a)),h=N(e.doc,E(l,0),E(a,M(e.doc,a).text.length));f.length>1&&h.length>1;)if(g(f)==g(h))f.pop(),h.pop(),a--;else{if(f[0]!=h[0])break;f.shift(),h.shift(),l++}for(var d=0,p=0,v=f[0],m=h[0],y=Math.min(v.length,m.length);d<y&&v.charCodeAt(d)==m.charCodeAt(d);)++d;for(var b=g(f),w=g(h),x=Math.min(b.length-(1==f.length?d:0),w.length-(1==h.length?d:0));p<x&&b.charCodeAt(b.length-p-1)==w.charCodeAt(w.length-p-1);)++p;if(1==f.length&&1==h.length&&l==n.line)for(;d&&d>n.ch&&b.charCodeAt(b.length-p-1)==w.charCodeAt(w.length-p-1);)d--,p++;f[f.length-1]=b.slice(0,b.length-p).replace(/^\u200b+/,""),f[0]=f[0].slice(d).replace(/\u200b+$/,"");var C=E(l,d),S=E(a,h.length?g(h).length-p:0);return f.length>1||f[0]||P(C,S)?(Ei(e.doc,f,C,S,"+input"),!0):void 0},Zs.prototype.ensurePolled=function(){this.forceCompositionEnd()},Zs.prototype.reset=function(){this.forceCompositionEnd()},Zs.prototype.forceCompositionEnd=function(){this.composing&&(clearTimeout(this.readDOMTimeout),this.composing=null,this.updateFromDOM(),this.div.blur(),this.div.focus())},Zs.prototype.readFromDOMSoon=function(){var e=this;null==this.readDOMTimeout&&(this.readDOMTimeout=setTimeout(function(){if(e.readDOMTimeout=null,e.composing){if(!e.composing.done)return;e.composing=null}e.updateFromDOM()},80))},Zs.prototype.updateFromDOM=function(){var e=this;!this.cm.isReadOnly()&&this.pollContent()||hn(this.cm,function(){return vn(e.cm)})},Zs.prototype.setUneditable=function(e){e.contentEditable="false"},Zs.prototype.onKeyPress=function(e){0!=e.charCode&&(e.preventDefault(),this.cm.isReadOnly()||dn(this.cm,$o)(this.cm,String.fromCharCode(null==e.charCode?e.keyCode:e.charCode),0))},Zs.prototype.readOnlyChanged=function(e){this.div.contentEditable=String("nocursor"!=e)},Zs.prototype.onContextMenu=function(){},Zs.prototype.resetPosition=function(){},Zs.prototype.needsContentAttribute=!0;var Qs=function(e){this.cm=e,this.prevInput="",this.pollingFast=!1,this.polling=new Pl,this.hasSelection=!1,this.composing=null};Qs.prototype.init=function(e){function t(e){if(!Me(i,e)){if(i.somethingSelected())_o({lineWise:!1,text:i.getSelections()});else{if(!i.options.lineWiseCopyCut)return;var t=Qo(i);_o({lineWise:!0,text:t.text}),"cut"==e.type?i.setSelections(t.ranges,null,Gl):(n.prevInput="",l.value=t.text.join("\n"),El(l))}"cut"==e.type&&(i.state.cutIncoming=!0)}}var r=this,n=this,i=this.cm,o=this.wrapper=el(),l=this.textarea=o.firstChild;e.wrapper.insertBefore(o,e.wrapper.firstChild),Ll&&(l.style.width="0px"),Ql(l,"input",function(){gl&&vl>=9&&r.hasSelection&&(r.hasSelection=null),n.poll()}),Ql(l,"paste",function(e){Me(i,e)||qo(e,i)||(i.state.pasteIncoming=!0,n.fastPoll())}),Ql(l,"cut",t),Ql(l,"copy",t),Ql(e.scroller,"paste",function(t){Ft(e,t)||Me(i,t)||(i.state.pasteIncoming=!0,n.focus())}),Ql(e.lineSpace,"selectstart",function(t){Ft(e,t)||We(t)}),Ql(l,"compositionstart",function(){var e=i.getCursor("from");n.composing&&n.composing.range.clear(),n.composing={start:e,range:i.markText(e,i.getCursor("to"),{className:"CodeMirror-composing"})}}),Ql(l,"compositionend",function(){n.composing&&(n.poll(),n.composing.range.clear(),n.composing=null)})},Qs.prototype.prepareSelection=function(){var e=this.cm,t=e.display,r=e.doc,n=Tr(e);if(e.options.moveInputWithCursor){var i=sr(e,r.sel.primary().head,"div"),o=t.wrapper.getBoundingClientRect(),l=t.lineDiv.getBoundingClientRect();n.teTop=Math.max(0,Math.min(t.wrapper.clientHeight-10,i.top+l.top-o.top)),n.teLeft=Math.max(0,Math.min(t.wrapper.clientWidth-10,i.left+l.left-o.left))}return n},Qs.prototype.showSelection=function(e){var t=this.cm.display;r(t.cursorDiv,e.cursors),r(t.selectionDiv,e.selection),null!=e.teTop&&(this.wrapper.style.top=e.teTop+"px",this.wrapper.style.left=e.teLeft+"px")},Qs.prototype.reset=function(e){if(!this.contextMenuPending&&!this.composing){var t=this.cm;if(t.somethingSelected()){this.prevInput="";var r=t.getSelection();this.textarea.value=r,t.state.focused&&El(this.textarea),gl&&vl>=9&&(this.hasSelection=r)}else e||(this.prevInput=this.textarea.value="",gl&&vl>=9&&(this.hasSelection=null))}},Qs.prototype.getField=function(){return this.textarea},Qs.prototype.supportsTouch=function(){return!1},Qs.prototype.focus=function(){if("nocursor"!=this.cm.options.readOnly&&(!Tl||l()!=this.textarea))try{this.textarea.focus()}catch(e){}},Qs.prototype.blur=function(){this.textarea.blur()},Qs.prototype.resetPosition=function(){this.wrapper.style.top=this.wrapper.style.left=0},Qs.prototype.receivedFocus=function(){this.slowPoll()},Qs.prototype.slowPoll=function(){var e=this;this.pollingFast||this.polling.set(this.cm.options.pollInterval,function(){e.poll(),e.cm.state.focused&&e.slowPoll()})},Qs.prototype.fastPoll=function(){function e(){r.poll()||t?(r.pollingFast=!1,r.slowPoll()):(t=!0,r.polling.set(60,e))}var t=!1,r=this;r.pollingFast=!0,r.polling.set(20,e)},Qs.prototype.poll=function(){var e=this,t=this.cm,r=this.textarea,n=this.prevInput;if(this.contextMenuPending||!t.state.focused||ts(r)&&!n&&!this.composing||t.isReadOnly()||t.options.disableInput||t.state.keySeq)return!1;var i=r.value;if(i==n&&!t.somethingSelected())return!1;if(gl&&vl>=9&&this.hasSelection===i||Ml&&/[\uf700-\uf7ff]/.test(i))return t.display.input.reset(),!1;if(t.doc.sel==t.display.selForContextMenu){var o=i.charCodeAt(0);if(8203!=o||n||(n="​"),8666==o)return this.reset(),this.cm.execCommand("undo")}for(var l=0,s=Math.min(n.length,i.length);l<s&&n.charCodeAt(l)==i.charCodeAt(l);)++l;return hn(t,function(){$o(t,i.slice(l),n.length-l,null,e.composing?"*compose":null),i.length>1e3||i.indexOf("\n")>-1?r.value=e.prevInput="":e.prevInput=i,e.composing&&(e.composing.range.clear(),e.composing.range=t.markText(e.composing.start,t.getCursor("to"),{className:"CodeMirror-composing"}))}),!0},Qs.prototype.ensurePolled=function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},Qs.prototype.onKeyPress=function(){gl&&vl>=9&&(this.hasSelection=null),this.fastPoll()},Qs.prototype.onContextMenu=function(e){function t(){if(null!=l.selectionStart){var e=i.somethingSelected(),t="​"+(e?l.value:"");l.value="⇚",l.value=t,n.prevInput=e?"":"​",l.selectionStart=1,l.selectionEnd=t.length,o.selForContextMenu=i.doc.sel}}function r(){if(n.contextMenuPending=!1,n.wrapper.style.cssText=c,l.style.cssText=u,gl&&vl<9&&o.scrollbars.setScrollTop(o.scroller.scrollTop=a),null!=l.selectionStart){(!gl||gl&&vl<9)&&t();var e=0,r=function(){o.selForContextMenu==i.doc.sel&&0==l.selectionStart&&l.selectionEnd>0&&"​"==n.prevInput?dn(i,Mi)(i):e++<10?o.detectingSelectAll=setTimeout(r,500):(o.selForContextMenu=null,o.input.reset())};o.detectingSelectAll=setTimeout(r,200)}}var n=this,i=n.cm,o=i.display,l=n.textarea,s=Sr(i,e),a=o.scroller.scrollTop;if(s&&!wl){i.options.resetSelectionOnContextMenu&&-1==i.doc.sel.contains(s)&&dn(i,bi)(i.doc,Rn(s),Gl);var u=l.style.cssText,c=n.wrapper.style.cssText;n.wrapper.style.cssText="position: absolute";var f=n.wrapper.getBoundingClientRect();l.style.cssText="position: absolute; width: 30px; height: 30px;\n      top: "+(e.clientY-f.top-5)+"px; left: "+(e.clientX-f.left-5)+"px;\n      z-index: 1000; background: "+(gl?"rgba(255, 255, 255, .05)":"transparent")+";\n      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);";var h;if(ml&&(h=window.scrollY),o.input.focus(),ml&&window.scrollTo(null,h),o.input.reset(),i.somethingSelected()||(l.value=n.prevInput=" "),n.contextMenuPending=!0,o.selForContextMenu=i.doc.sel,clearTimeout(o.detectingSelectAll),gl&&vl>=9&&t(),Hl){Fe(e);var d=function(){ke(window,"mouseup",d),setTimeout(r,20)};Ql(window,"mouseup",d)}else setTimeout(r,50)}},Qs.prototype.readOnlyChanged=function(e){e||this.reset(),this.textarea.disabled="nocursor"==e},Qs.prototype.setUneditable=function(){},Qs.prototype.needsContentAttribute=!1,function(e){function t(t,n,i,o){e.defaults[t]=n,i&&(r[t]=o?function(e,t,r){r!=Xs&&i(e,t,r)}:i)}var r=e.optionHandlers;e.defineOption=t,e.Init=Xs,t("value","",function(e,t){return e.setValue(t)},!0),t("mode",null,function(e,t){e.doc.modeOption=t,jn(e)},!0),t("indentUnit",2,jn,!0),t("indentWithTabs",!1),t("smartIndent",!0),t("tabSize",4,function(e){Xn(e),er(e),vn(e)},!0),t("lineSeparator",null,function(e,t){if(e.doc.lineSep=t,t){var r=[],n=e.doc.first;e.doc.iter(function(e){for(var i=0;;){var o=e.text.indexOf(t,i);if(-1==o)break;i=o+t.length,r.push(E(n,o))}n++});for(var i=r.length-1;i>=0;i--)Ei(e.doc,t,r[i],E(r[i].line,r[i].ch+t.length))}}),t("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b-\u200f\u2028\u2029\ufeff]/g,function(e,t,r){e.state.specialChars=new RegExp(t.source+(t.test("\t")?"":"|\t"),"g"),r!=Xs&&e.refresh()}),t("specialCharPlaceholder",at,function(e){return e.refresh()},!0),t("electricChars",!0),t("inputStyle",Tl?"contenteditable":"textarea",function(){throw new Error("inputStyle can not (yet) be changed in a running editor")},!0),t("spellcheck",!1,function(e,t){return e.getInputField().spellcheck=t},!0),t("rtlMoveVisually",!Ol),t("wholeLineUpdateBefore",!0),t("theme","default",function(e){Go(e),Uo(e)},!0),t("keyMap","default",function(e,t,r){var n=uo(t),i=r!=Xs&&uo(r);i&&i.detach&&i.detach(e,n),n.attach&&n.attach(e,i||null)}),t("extraKeys",null),t("configureMouse",null),t("lineWrapping",!1,Ko,!0),t("gutters",[],function(e){Fn(e.options),Uo(e)},!0),t("fixedGutter",!0,function(e,t){e.display.gutters.style.left=t?wr(e.display)+"px":"0",e.refresh()},!0),t("coverGutterNextToScrollbar",!1,function(e){return en(e)},!0),t("scrollbarStyle","native",function(e){rn(e),en(e),e.display.scrollbars.setScrollTop(e.doc.scrollTop),e.display.scrollbars.setScrollLeft(e.doc.scrollLeft)},!0),t("lineNumbers",!1,function(e){Fn(e.options),Uo(e)},!0),t("firstLineNumber",1,Uo,!0),t("lineNumberFormatter",function(e){return e},Uo,!0),t("showCursorWhenSelecting",!1,kr,!0),t("resetSelectionOnContextMenu",!0),t("lineWiseCopyCut",!0),t("pasteLinesPerSelection",!0),t("readOnly",!1,function(e,t){"nocursor"==t&&(Fr(e),e.display.input.blur()),e.display.input.readOnlyChanged(t)}),t("disableInput",!1,function(e,t){t||e.display.input.reset()},!0),t("dragDrop",!0,Vo),t("allowDropFileTypes",null),t("cursorBlinkRate",530),t("cursorScrollMargin",0),t("cursorHeight",1,kr,!0),t("singleCursorHeightPerLine",!0,kr,!0),t("workTime",100),t("workDelay",100),t("flattenSpans",!0,Xn,!0),t("addModeClass",!1,Xn,!0),t("pollInterval",100),t("undoDepth",200,function(e,t){return e.doc.history.undoDepth=t}),t("historyEventDelay",1250),t("viewportMargin",10,function(e){return e.refresh()},!0),t("maxHighlightLength",1e4,Xn,!0),t("moveInputWithCursor",!0,function(e,t){t||e.display.input.resetPosition()}),t("tabindex",null,function(e,t){return e.display.input.getField().tabIndex=t||""}),t("autofocus",null),t("direction","ltr",function(e,t){return e.doc.setDirection(t)},!0)}(jo),function(e){var t=e.optionHandlers,r=e.helpers={};e.prototype={constructor:e,focus:function(){window.focus(),this.display.input.focus()},setOption:function(e,r){var n=this.options,i=n[e];n[e]==r&&"mode"!=e||(n[e]=r,t.hasOwnProperty(e)&&dn(this,t[e])(this,r,i),Te(this,"optionChange",this,e))},getOption:function(e){return this.options[e]},getDoc:function(){return this.doc},addKeyMap:function(e,t){this.state.keyMaps[t?"push":"unshift"](uo(e))},removeKeyMap:function(e){for(var t=this.state.keyMaps,r=0;r<t.length;++r)if(t[r]==e||t[r].name==e)return t.splice(r,1),!0},addOverlay:pn(function(t,r){var n=t.token?t:e.getMode(this.options,t);if(n.startState)throw new Error("Overlays may not be stateful.");m(this.state.overlays,{mode:n,modeSpec:t,opaque:r&&r.opaque,priority:r&&r.priority||0},function(e){return e.priority}),this.state.modeGen++,vn(this)}),removeOverlay:pn(function(e){for(var t=this,r=this.state.overlays,n=0;n<r.length;++n){var i=r[n].modeSpec;if(i==e||"string"==typeof e&&i.name==e)return r.splice(n,1),t.state.modeGen++,void vn(t)}}),indentLine:pn(function(e,t,r){"string"!=typeof t&&"number"!=typeof t&&(t=null==t?this.options.smartIndent?"smart":"prev":t?"add":"subtract"),H(this.doc,e)&&Yo(this,e,t,r)}),indentSelection:pn(function(e){for(var t=this,r=this.doc.sel.ranges,n=-1,i=0;i<r.length;i++){var o=r[i];if(o.empty())o.head.line>n&&(Yo(t,o.head.line,e,!0),n=o.head.line,i==t.doc.sel.primIndex&&jr(t));else{var l=o.from(),s=o.to(),a=Math.max(n,l.line);n=Math.min(t.lastLine(),s.line-(s.ch?0:1))+1;for(var u=a;u<n;++u)Yo(t,u,e);var c=t.doc.sel.ranges;0==l.ch&&r.length==c.length&&c[i].from().ch>0&&gi(t.doc,i,new Ts(l,c[i].to()),Gl)}}}),getTokenAt:function(e,t){return Je(this,e,t)},getLineTokens:function(e,t){return Je(this,E(e),t,!0)},getTokenTypeAt:function(e){e=U(this.doc,e);var t,r=_e(this,M(this.doc,e.line)),n=0,i=(r.length-1)/2,o=e.ch;if(0==o)t=r[2];else for(;;){var l=n+i>>1;if((l?r[2*l-1]:0)>=o)i=l;else{if(!(r[2*l+1]<o)){t=r[2*l+2];break}n=l+1}}var s=t?t.indexOf("overlay "):-1;return s<0?t:0==s?null:t.slice(0,s-1)},getModeAt:function(t){var r=this.doc.mode;return r.innerMode?e.innerMode(r,this.getTokenAt(t).state).mode:r},getHelper:function(e,t){return this.getHelpers(e,t)[0]},getHelpers:function(e,t){var n=this,i=[];if(!r.hasOwnProperty(t))return i;var o=r[t],l=this.getModeAt(e);if("string"==typeof l[t])o[l[t]]&&i.push(o[l[t]]);else if(l[t])for(var s=0;s<l[t].length;s++){var a=o[l[t][s]];a&&i.push(a)}else l.helperType&&o[l.helperType]?i.push(o[l.helperType]):o[l.name]&&i.push(o[l.name]);for(var u=0;u<o._global.length;u++){var c=o._global[u];c.pred(l,n)&&-1==h(i,c.val)&&i.push(c.val)}return i},getStateAfter:function(e,t){var r=this.doc;return e=G(r,null==e?r.first+r.size-1:e),$e(this,e+1,t).state},cursorCoords:function(e,t){var r,n=this.doc.sel.primary();return r=null==e?n.head:"object"==typeof e?U(this.doc,e):e?n.from():n.to(),sr(this,r,t||"page")},charCoords:function(e,t){return lr(this,U(this.doc,e),t||"page")},coordsChar:function(e,t){return e=or(this,e,t||"page"),cr(this,e.left,e.top)},lineAtHeight:function(e,t){return e=or(this,{top:e,left:0},t||"page").top,D(this.doc,e+this.display.viewOffset)},heightAtLine:function(e,t,r){var n,i=!1;if("number"==typeof e){var o=this.doc.first+this.doc.size-1;e<this.doc.first?e=this.doc.first:e>o&&(e=o,i=!0),n=M(this.doc,e)}else n=e;return ir(this,n,{top:0,left:0},t||"page",r||i).top+(i?this.doc.height-ye(n):0)},defaultTextHeight:function(){return mr(this.display)},defaultCharWidth:function(){return yr(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(e,t,r,n,i){var o=this.display,l=(e=sr(this,U(this.doc,e))).bottom,s=e.left;if(t.style.position="absolute",t.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(t),o.sizer.appendChild(t),"over"==n)l=e.top;else if("above"==n||"near"==n){var a=Math.max(o.wrapper.clientHeight,this.doc.height),u=Math.max(o.sizer.clientWidth,o.lineSpace.clientWidth);("above"==n||e.bottom+t.offsetHeight>a)&&e.top>t.offsetHeight?l=e.top-t.offsetHeight:e.bottom+t.offsetHeight<=a&&(l=e.bottom),s+t.offsetWidth>u&&(s=u-t.offsetWidth)}t.style.top=l+"px",t.style.left=t.style.right="","right"==i?(s=o.sizer.clientWidth-t.offsetWidth,t.style.right="0px"):("left"==i?s=0:"middle"==i&&(s=(o.sizer.clientWidth-t.offsetWidth)/2),t.style.left=s+"px"),r&&Ur(this,{left:s,top:l,right:s+t.offsetWidth,bottom:l+t.offsetHeight})},triggerOnKeyDown:pn(Lo),triggerOnKeyPress:pn(Mo),triggerOnKeyUp:To,triggerOnMouseDown:pn(Oo),execCommand:function(e){if(Bs.hasOwnProperty(e))return Bs[e].call(null,this)},triggerElectric:pn(function(e){Zo(this,e)}),findPosH:function(e,t,r,n){var i=this,o=1;t<0&&(o=-1,t=-t);for(var l=U(this.doc,e),s=0;s<t&&!(l=tl(i.doc,l,o,r,n)).hitSide;++s);return l},moveH:pn(function(e,t){var r=this;this.extendSelectionsBy(function(n){return r.display.shift||r.doc.extend||n.empty()?tl(r.doc,n.head,e,t,r.options.rtlMoveVisually):e<0?n.from():n.to()},Vl)}),deleteH:pn(function(e,t){var r=this.doc.sel,n=this.doc;r.somethingSelected()?n.replaceSelection("",null,"+delete"):co(this,function(r){var i=tl(n,r.head,e,t,!1);return e<0?{from:i,to:r.head}:{from:r.head,to:i}})}),findPosV:function(e,t,r,n){var i=this,o=1,l=n;t<0&&(o=-1,t=-t);for(var s=U(this.doc,e),a=0;a<t;++a){var u=sr(i,s,"div");if(null==l?l=u.left:u.left=l,(s=rl(i,u,o,r)).hitSide)break}return s},moveV:pn(function(e,t){var r=this,n=this.doc,i=[],o=!this.display.shift&&!n.extend&&n.sel.somethingSelected();if(n.extendSelectionsBy(function(l){if(o)return e<0?l.from():l.to();var s=sr(r,l.head,"div");null!=l.goalColumn&&(s.left=l.goalColumn),i.push(s.left);var a=rl(r,s,e,t);return"page"==t&&l==n.sel.primary()&&Kr(r,lr(r,a,"div").top-s.top),a},Vl),i.length)for(var l=0;l<n.sel.ranges.length;l++)n.sel.ranges[l].goalColumn=i[l]}),findWordAt:function(e){var t=M(this.doc,e.line).text,r=e.ch,n=e.ch;if(t){var i=this.getHelper(e,"wordChars");"before"!=e.sticky&&n!=t.length||!r?++n:--r;for(var o=t.charAt(r),l=x(o,i)?function(e){return x(e,i)}:/\s/.test(o)?function(e){return/\s/.test(e)}:function(e){return!/\s/.test(e)&&!x(e)};r>0&&l(t.charAt(r-1));)--r;for(;n<t.length&&l(t.charAt(n));)++n}return new Ts(E(e.line,r),E(e.line,n))},toggleOverwrite:function(e){null!=e&&e==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?s(this.display.cursorDiv,"CodeMirror-overwrite"):Fl(this.display.cursorDiv,"CodeMirror-overwrite"),Te(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==l()},isReadOnly:function(){return!(!this.options.readOnly&&!this.doc.cantEdit)},scrollTo:pn(function(e,t){Xr(this,e,t)}),getScrollInfo:function(){var e=this.display.scroller;return{left:e.scrollLeft,top:e.scrollTop,height:e.scrollHeight-zt(this)-this.display.barHeight,width:e.scrollWidth-zt(this)-this.display.barWidth,clientHeight:Bt(this),clientWidth:Rt(this)}},scrollIntoView:pn(function(e,t){null==e?(e={from:this.doc.sel.primary().head,to:null},null==t&&(t=this.options.cursorScrollMargin)):"number"==typeof e?e={from:E(e,0),to:null}:null==e.from&&(e={from:e,to:null}),e.to||(e.to=e.from),e.margin=t||0,null!=e.from.line?Yr(this,e):$r(this,e.from,e.to,e.margin)}),setSize:pn(function(e,t){var r=this,n=function(e){return"number"==typeof e||/^\d+$/.test(String(e))?e+"px":e};null!=e&&(this.display.wrapper.style.width=n(e)),null!=t&&(this.display.wrapper.style.height=n(t)),this.options.lineWrapping&&Jt(this);var i=this.display.viewFrom;this.doc.iter(i,this.display.viewTo,function(e){if(e.widgets)for(var t=0;t<e.widgets.length;t++)if(e.widgets[t].noHScroll){mn(r,i,"widget");break}++i}),this.curOp.forceUpdate=!0,Te(this,"refresh",this)}),operation:function(e){return hn(this,e)},startOperation:function(){return nn(this)},endOperation:function(){return on(this)},refresh:pn(function(){var e=this.display.cachedTextHeight;vn(this),this.curOp.forceUpdate=!0,er(this),Xr(this,this.doc.scrollLeft,this.doc.scrollTop),Wn(this),(null==e||Math.abs(e-mr(this.display))>.5)&&Cr(this),Te(this,"refresh",this)}),swapDoc:pn(function(e){var t=this.doc;return t.cm=null,qn(this,e),er(this),this.display.input.reset(),Xr(this,e.scrollLeft,e.scrollTop),this.curOp.forceScroll=!0,bt(this,"swapDoc",this,t),t}),getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},Ae(e),e.registerHelper=function(t,n,i){r.hasOwnProperty(t)||(r[t]=e[t]={_global:[]}),r[t][n]=i},e.registerGlobalHelper=function(t,n,i,o){e.registerHelper(t,n,o),r[t]._global.push({pred:i,val:o})}}(jo);var Js="iter insert remove copy getEditor constructor".split(" ");for(var ea in Ds.prototype)Ds.prototype.hasOwnProperty(ea)&&h(Js,ea)<0&&(jo.prototype[ea]=function(e){return function(){return e.apply(this.doc,arguments)}}(Ds.prototype[ea]));return Ae(Ds),jo.inputStyles={textarea:Qs,contenteditable:Zs},jo.defineMode=function(e){jo.defaults.mode||"null"==e||(jo.defaults.mode=e),Be.apply(this,arguments)},jo.defineMIME=function(e,t){os[e]=t},jo.defineMode("null",function(){return{token:function(e){return e.skipToEnd()}}}),jo.defineMIME("text/plain","null"),jo.defineExtension=function(e,t){jo.prototype[e]=t},jo.defineDocExtension=function(e,t){Ds.prototype[e]=t},jo.fromTextArea=function(e,t){function r(){e.value=a.getValue()}if(t=t?c(t):{},t.value=e.value,!t.tabindex&&e.tabIndex&&(t.tabindex=e.tabIndex),!t.placeholder&&e.placeholder&&(t.placeholder=e.placeholder),null==t.autofocus){var n=l();t.autofocus=n==e||null!=e.getAttribute("autofocus")&&n==document.body}var i;if(e.form&&(Ql(e.form,"submit",r),!t.leaveSubmitMethodAlone)){var o=e.form;i=o.submit;try{var s=o.submit=function(){r(),o.submit=i,o.submit(),o.submit=s}}catch(e){}}t.finishInit=function(t){t.save=r,t.getTextArea=function(){return e},t.toTextArea=function(){t.toTextArea=isNaN,r(),e.parentNode.removeChild(t.getWrapperElement()),e.style.display="",e.form&&(ke(e.form,"submit",r),"function"==typeof e.form.submit&&(e.form.submit=i))}},e.style.display="none";var a=jo(function(t){return e.parentNode.insertBefore(t,e.nextSibling)},t);return a},function(e){e.off=ke,e.on=Ql,e.wheelEventPixels=Pn,e.Doc=Ds,e.splitLines=es,e.countColumn=f,e.findColumn=d,e.isWordChar=w,e.Pass=Bl,e.signal=Te,e.Line=fs,e.changeEnd=Bn,e.scrollbarModel=ws,e.Pos=E,e.cmpPos=P,e.modes=is,e.mimeModes=os,e.resolveMode=Ge,e.getMode=Ue,e.modeExtensions=ls,e.extendMode=Ve,e.copyState=Ke,e.startState=Xe,e.innerMode=je,e.commands=Bs,e.keyMap=Rs,e.keyName=ao,e.isModifierKey=lo,e.lookupKey=oo,e.normalizeKeyMap=io,e.StringStream=ss,e.SharedTextMarker=As,e.TextMarker=Os,e.LineWidget=Ms,e.e_preventDefault=We,e.e_stopPropagation=De,e.e_stop=Fe,e.addClass=s,e.contains=o,e.rmClass=Fl,e.keyNames=Es}(jo),jo.version="5.30.0",jo});
      !function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){"use strict";function t(e,t,n,r,o,a){this.indented=e,this.column=t,this.type=n,this.info=r,this.align=o,this.prev=a}function n(e,n,r,o){var a=e.indented;return e.context&&"statement"==e.context.type&&"statement"!=r&&(a=e.context.indented),e.context=new t(a,n,r,o,null,e.context)}function r(e){var t=e.context.type;return")"!=t&&"]"!=t&&"}"!=t||(e.indented=e.context.indented),e.context=e.context.prev}function o(e,t,n){return"variable"==t.prevToken||"type"==t.prevToken||(!!/\S(?:[^- ]>|[*\]])\s*$|\*$/.test(e.string.slice(0,n))||(!(!t.typeAtEndOfLine||e.column()!=e.indentation())||void 0))}function a(e){for(;;){if(!e||"top"==e.type)return!0;if("}"==e.type&&"namespace"!=e.prev.info)return!1;e=e.prev}}function i(e){for(var t={},n=e.split(" "),r=0;r<n.length;++r)t[n[r]]=!0;return t}function l(e,t){return"function"==typeof e?e(t):e.propertyIsEnumerable(t)}function s(e,t){if(!t.startOfLine)return!1;for(var n,r=null;n=e.peek();){if("\\"==n&&e.match(/^.$/)){r=s;break}if("/"==n&&e.match(/^\/[\/\*]/,!1))break;e.next()}return t.tokenize=r,"meta"}function c(e,t){return"type"==t.prevToken&&"type"}function u(e){return e.eatWhile(/[\w\.']/),"number"}function d(e,t){if(e.backUp(1),e.match(/(R|u8R|uR|UR|LR)/)){var n=e.match(/"([^\s\\()]{0,16})\(/);return!!n&&(t.cpp11RawStringDelim=n[1],t.tokenize=m,m(e,t))}return e.match(/(u8|u|U|L)/)?!!e.match(/["']/,!1)&&"string":(e.next(),!1)}function f(e){var t=/(\w+)::~?(\w+)$/.exec(e);return t&&t[1]==t[2]}function p(e,t){for(var n;null!=(n=e.next());)if('"'==n&&!e.eat('"')){t.tokenize=null;break}return"string"}function m(e,t){var n=t.cpp11RawStringDelim.replace(/[^\w\s]/g,"\\$&");return e.match(new RegExp(".*?\\)"+n+'"'))?t.tokenize=null:e.skipToEnd(),"string"}function h(t,n){function r(e){if(e)for(var t in e)e.hasOwnProperty(t)&&o.push(t)}"string"==typeof t&&(t=[t]);var o=[];r(n.keywords),r(n.types),r(n.builtin),r(n.atoms),o.length&&(n.helperType=t[0],e.registerHelper("hintWords",t[0],o));for(var a=0;a<t.length;++a)e.defineMIME(t[a],n)}function g(e,t){for(var n=!1;!e.eol();){if(!n&&e.match('"""')){t.tokenize=null;break}n="\\"==e.next()&&!n}return"string"}function y(e){return function(t,n){for(var r,o=!1,a=!1;!t.eol();){if(!e&&!o&&t.match('"')){a=!0;break}if(e&&t.match('"""')){a=!0;break}r=t.next(),!o&&"$"==r&&t.match("{")&&t.skipTo("}"),o=!o&&"\\"==r&&!e}return!a&&e||(n.tokenize=null),"string"}}function x(e){return function(t,n){for(var r,o=!1,a=!1;!t.eol();){if(!o&&t.match('"')&&("single"==e||t.match('""'))){a=!0;break}if(!o&&t.match("``")){w=x(e),a=!0;break}r=t.next(),o="single"==e&&!o&&"\\"==r}return a&&(n.tokenize=null),"string"}}e.defineMode("clike",function(i,s){function c(e,t){var n=e.next();if(S[n]){var r=S[n](e,t);if(!1!==r)return r}if('"'==n||"'"==n)return t.tokenize=u(n),t.tokenize(e,t);if(D.test(n))return p=n,null;if(L.test(n)){if(e.backUp(1),e.match(I))return"number";e.next()}if("/"==n){if(e.eat("*"))return t.tokenize=d,d(e,t);if(e.eat("/"))return e.skipToEnd(),"comment"}if(F.test(n)){for(;!e.match(/^\/[\/*]/,!1)&&e.eat(F););return"operator"}if(e.eatWhile(z),P)for(;e.match(P);)e.eatWhile(z);var o=e.current();return l(x,o)?(l(w,o)&&(p="newstatement"),l(v,o)&&(m=!0),"keyword"):l(b,o)?"type":l(k,o)?(l(w,o)&&(p="newstatement"),"builtin"):l(_,o)?"atom":"variable"}function u(e){return function(t,n){for(var r,o=!1,a=!1;null!=(r=t.next());){if(r==e&&!o){a=!0;break}o=!o&&"\\"==r}return(a||!o&&!C)&&(n.tokenize=null),"string"}}function d(e,t){for(var n,r=!1;n=e.next();){if("/"==n&&r){t.tokenize=null;break}r="*"==n}return"comment"}function f(e,t){s.typeFirstDefinitions&&e.eol()&&a(t.context)&&(t.typeAtEndOfLine=o(e,t,e.pos))}var p,m,h=i.indentUnit,g=s.statementIndentUnit||h,y=s.dontAlignCalls,x=s.keywords||{},b=s.types||{},k=s.builtin||{},w=s.blockKeywords||{},v=s.defKeywords||{},_=s.atoms||{},S=s.hooks||{},C=s.multiLineStrings,T=!1!==s.indentStatements,M=!1!==s.indentSwitch,P=s.namespaceSeparator,D=s.isPunctuationChar||/[\[\]{}\(\),;\:\.]/,L=s.numberStart||/[\d\.]/,I=s.number||/^(?:0x[a-f\d]+|0b[01]+|(?:\d+\.?\d*|\.\d+)(?:e[-+]?\d+)?)(u|ll?|l|f)?/i,F=s.isOperatorChar||/[+\-*&%=<>!?|\/]/,z=s.isIdentifierChar||/[\w\$_\xa1-\uffff]/;return{startState:function(e){return{tokenize:null,context:new t((e||0)-h,0,"top",null,!1),indented:0,startOfLine:!0,prevToken:null}},token:function(e,t){var i=t.context;if(e.sol()&&(null==i.align&&(i.align=!1),t.indented=e.indentation(),t.startOfLine=!0),e.eatSpace())return f(e,t),null;p=m=null;var l=(t.tokenize||c)(e,t);if("comment"==l||"meta"==l)return l;if(null==i.align&&(i.align=!0),";"==p||":"==p||","==p&&e.match(/^\s*(?:\/\/.*)?$/,!1))for(;"statement"==t.context.type;)r(t);else if("{"==p)n(t,e.column(),"}");else if("["==p)n(t,e.column(),"]");else if("("==p)n(t,e.column(),")");else if("}"==p){for(;"statement"==i.type;)i=r(t);for("}"==i.type&&(i=r(t));"statement"==i.type;)i=r(t)}else p==i.type?r(t):T&&(("}"==i.type||"top"==i.type)&&";"!=p||"statement"==i.type&&"newstatement"==p)&&n(t,e.column(),"statement",e.current());if("variable"==l&&("def"==t.prevToken||s.typeFirstDefinitions&&o(e,t,e.start)&&a(t.context)&&e.match(/^\s*\(/,!1))&&(l="def"),S.token){var u=S.token(e,t,l);void 0!==u&&(l=u)}return"def"==l&&!1===s.styleDefs&&(l="variable"),t.startOfLine=!1,t.prevToken=m?"def":l||p,f(e,t),l},indent:function(t,n){if(t.tokenize!=c&&null!=t.tokenize||t.typeAtEndOfLine)return e.Pass;var r=t.context,o=n&&n.charAt(0);if("statement"==r.type&&"}"==o&&(r=r.prev),s.dontIndentStatements)for(;"statement"==r.type&&s.dontIndentStatements.test(r.info);)r=r.prev;if(S.indent){var a=S.indent(t,r,n);if("number"==typeof a)return a}var i=o==r.type,l=r.prev&&"switch"==r.prev.info;if(s.allmanIndentation&&/[{(]/.test(o)){for(;"top"!=r.type&&"}"!=r.type;)r=r.prev;return r.indented}return"statement"==r.type?r.indented+("{"==o?0:g):!r.align||y&&")"==r.type?")"!=r.type||i?r.indented+(i?0:h)+(i||!l||/^(?:case|default)\b/.test(n)?0:h):r.indented+g:r.column+(i?0:1)},electricInput:M?/^\s*(?:case .*?:|default:|\{\}?|\})$/:/^\s*[{}]$/,blockCommentStart:"/*",blockCommentEnd:"*/",lineComment:"//",fold:"brace"}});var b="auto if break case register continue return default do sizeof static else struct switch extern typedef union for goto while enum const volatile",k="int long char short double float unsigned signed void size_t ptrdiff_t";h(["text/x-csrc","text/x-c","text/x-chdr"],{name:"clike",keywords:i(b),types:i(k+" bool _Complex _Bool float_t double_t intptr_t intmax_t int8_t int16_t int32_t int64_t uintptr_t uintmax_t uint8_t uint16_t uint32_t uint64_t"),blockKeywords:i("case do else for if switch while struct"),defKeywords:i("struct"),typeFirstDefinitions:!0,atoms:i("null true false"),hooks:{"#":s,"*":c},modeProps:{fold:["brace","include"]}}),h(["text/x-c++src","text/x-c++hdr"],{name:"clike",keywords:i(b+" asm dynamic_cast namespace reinterpret_cast try explicit new static_cast typeid catch operator template typename class friend private this using const_cast inline public throw virtual delete mutable protected alignas alignof constexpr decltype nullptr noexcept thread_local final static_assert override"),types:i(k+" bool wchar_t"),blockKeywords:i("catch class do else finally for if struct switch try while"),defKeywords:i("class namespace struct enum union"),typeFirstDefinitions:!0,atoms:i("true false null"),dontIndentStatements:/^template$/,isIdentifierChar:/[\w\$_~\xa1-\uffff]/,hooks:{"#":s,"*":c,u:d,U:d,L:d,R:d,0:u,1:u,2:u,3:u,4:u,5:u,6:u,7:u,8:u,9:u,token:function(e,t,n){if("variable"==n&&"("==e.peek()&&(";"==t.prevToken||null==t.prevToken||"}"==t.prevToken)&&f(e.current()))return"def"}},namespaceSeparator:"::",modeProps:{fold:["brace","include"]}}),h("text/x-java",{name:"clike",keywords:i("abstract assert break case catch class const continue default do else enum extends final finally float for goto if implements import instanceof interface native new package private protected public return static strictfp super switch synchronized this throw throws transient try volatile while @interface"),types:i("byte short int long float double boolean char void Boolean Byte Character Double Float Integer Long Number Object Short String StringBuffer StringBuilder Void"),blockKeywords:i("catch class do else finally for if switch try while"),defKeywords:i("class interface package enum @interface"),typeFirstDefinitions:!0,atoms:i("true false null"),number:/^(?:0x[a-f\d_]+|0b[01_]+|(?:[\d_]+\.?\d*|\.\d+)(?:e[-+]?[\d_]+)?)(u|ll?|l|f)?/i,hooks:{"@":function(e){return!e.match("interface",!1)&&(e.eatWhile(/[\w\$_]/),"meta")}},modeProps:{fold:["brace","import"]}}),h("text/x-csharp",{name:"clike",keywords:i("abstract as async await base break case catch checked class const continue default delegate do else enum event explicit extern finally fixed for foreach goto if implicit in interface internal is lock namespace new operator out override params private protected public readonly ref return sealed sizeof stackalloc static struct switch this throw try typeof unchecked unsafe using virtual void volatile while add alias ascending descending dynamic from get global group into join let orderby partial remove select set value var yield"),types:i("Action Boolean Byte Char DateTime DateTimeOffset Decimal Double Func Guid Int16 Int32 Int64 Object SByte Single String Task TimeSpan UInt16 UInt32 UInt64 bool byte char decimal double short int long object sbyte float string ushort uint ulong"),blockKeywords:i("catch class do else finally for foreach if struct switch try while"),defKeywords:i("class interface namespace struct var"),typeFirstDefinitions:!0,atoms:i("true false null"),hooks:{"@":function(e,t){return e.eat('"')?(t.tokenize=p,p(e,t)):(e.eatWhile(/[\w\$_]/),"meta")}}}),h("text/x-scala",{name:"clike",keywords:i("abstract case catch class def do else extends final finally for forSome if implicit import lazy match new null object override package private protected return sealed super this throw trait try type val var while with yield _ assert assume require print println printf readLine readBoolean readByte readShort readChar readInt readLong readFloat readDouble"),types:i("AnyVal App Application Array BufferedIterator BigDecimal BigInt Char Console Either Enumeration Equiv Error Exception Fractional Function IndexedSeq Int Integral Iterable Iterator List Map Numeric Nil NotNull Option Ordered Ordering PartialFunction PartialOrdering Product Proxy Range Responder Seq Serializable Set Specializable Stream StringBuilder StringContext Symbol Throwable Traversable TraversableOnce Tuple Unit Vector Boolean Byte Character CharSequence Class ClassLoader Cloneable Comparable Compiler Double Exception Float Integer Long Math Number Object Package Pair Process Runtime Runnable SecurityManager Short StackTraceElement StrictMath String StringBuffer System Thread ThreadGroup ThreadLocal Throwable Triple Void"),multiLineStrings:!0,blockKeywords:i("catch class enum do else finally for forSome if match switch try while"),defKeywords:i("class enum def object package trait type val var"),atoms:i("true false null"),indentStatements:!1,indentSwitch:!1,isOperatorChar:/[+\-*&%=<>!?|\/#:@]/,hooks:{"@":function(e){return e.eatWhile(/[\w\$_]/),"meta"},'"':function(e,t){return!!e.match('""')&&(t.tokenize=g,t.tokenize(e,t))},"'":function(e){return e.eatWhile(/[\w\$_\xa1-\uffff]/),"atom"},"=":function(e,n){var r=n.context;return!("}"!=r.type||!r.align||!e.eat(">"))&&(n.context=new t(r.indented,r.column,r.type,r.info,null,r.prev),"operator")}},modeProps:{closeBrackets:{triples:'"'}}}),h("text/x-kotlin",{name:"clike",keywords:i("package as typealias class interface this super val var fun for is in This throw return break continue object if else while do try when !in !is as? file import where by get set abstract enum open inner override private public internal protected catch finally out final vararg reified dynamic companion constructor init sealed field property receiver param sparam lateinit data inline noinline tailrec external annotation crossinline const operator infix suspend"),types:i("Boolean Byte Character CharSequence Class ClassLoader Cloneable Comparable Compiler Double Exception Float Integer Long Math Number Object Package Pair Process Runtime Runnable SecurityManager Short StackTraceElement StrictMath String StringBuffer System Thread ThreadGroup ThreadLocal Throwable Triple Void"),intendSwitch:!1,indentStatements:!1,multiLineStrings:!0,number:/^(?:0x[a-f\d_]+|0b[01_]+|(?:[\d_]+\.?\d*|\.\d+)(?:e[-+]?[\d_]+)?)(u|ll?|l|f)?/i,blockKeywords:i("catch class do else finally for if where try while enum"),defKeywords:i("class val var object package interface fun"),atoms:i("true false null this"),hooks:{'"':function(e,t){return t.tokenize=y(e.match('""')),t.tokenize(e,t)}},modeProps:{closeBrackets:{triples:'"'}}}),h(["x-shader/x-vertex","x-shader/x-fragment"],{name:"clike",keywords:i("sampler1D sampler2D sampler3D samplerCube sampler1DShadow sampler2DShadow const attribute uniform varying break continue discard return for while do if else struct in out inout"),types:i("float int bool void vec2 vec3 vec4 ivec2 ivec3 ivec4 bvec2 bvec3 bvec4 mat2 mat3 mat4"),blockKeywords:i("for while do if else struct"),builtin:i("radians degrees sin cos tan asin acos atan pow exp log exp2 sqrt inversesqrt abs sign floor ceil fract mod min max clamp mix step smoothstep length distance dot cross normalize ftransform faceforward reflect refract matrixCompMult lessThan lessThanEqual greaterThan greaterThanEqual equal notEqual any all not texture1D texture1DProj texture1DLod texture1DProjLod texture2D texture2DProj texture2DLod texture2DProjLod texture3D texture3DProj texture3DLod texture3DProjLod textureCube textureCubeLod shadow1D shadow2D shadow1DProj shadow2DProj shadow1DLod shadow2DLod shadow1DProjLod shadow2DProjLod dFdx dFdy fwidth noise1 noise2 noise3 noise4"),atoms:i("true false gl_FragColor gl_SecondaryColor gl_Normal gl_Vertex gl_MultiTexCoord0 gl_MultiTexCoord1 gl_MultiTexCoord2 gl_MultiTexCoord3 gl_MultiTexCoord4 gl_MultiTexCoord5 gl_MultiTexCoord6 gl_MultiTexCoord7 gl_FogCoord gl_PointCoord gl_Position gl_PointSize gl_ClipVertex gl_FrontColor gl_BackColor gl_FrontSecondaryColor gl_BackSecondaryColor gl_TexCoord gl_FogFragCoord gl_FragCoord gl_FrontFacing gl_FragData gl_FragDepth gl_ModelViewMatrix gl_ProjectionMatrix gl_ModelViewProjectionMatrix gl_TextureMatrix gl_NormalMatrix gl_ModelViewMatrixInverse gl_ProjectionMatrixInverse gl_ModelViewProjectionMatrixInverse gl_TexureMatrixTranspose gl_ModelViewMatrixInverseTranspose gl_ProjectionMatrixInverseTranspose gl_ModelViewProjectionMatrixInverseTranspose gl_TextureMatrixInverseTranspose gl_NormalScale gl_DepthRange gl_ClipPlane gl_Point gl_FrontMaterial gl_BackMaterial gl_LightSource gl_LightModel gl_FrontLightModelProduct gl_BackLightModelProduct gl_TextureColor gl_EyePlaneS gl_EyePlaneT gl_EyePlaneR gl_EyePlaneQ gl_FogParameters gl_MaxLights gl_MaxClipPlanes gl_MaxTextureUnits gl_MaxTextureCoords gl_MaxVertexAttribs gl_MaxVertexUniformComponents gl_MaxVaryingFloats gl_MaxVertexTextureImageUnits gl_MaxTextureImageUnits gl_MaxFragmentUniformComponents gl_MaxCombineTextureImageUnits gl_MaxDrawBuffers"),indentSwitch:!1,hooks:{"#":s},modeProps:{fold:["brace","include"]}}),h("text/x-nesc",{name:"clike",keywords:i(b+"as atomic async call command component components configuration event generic implementation includes interface module new norace nx_struct nx_union post provides signal task uses abstract extends"),types:i(k),blockKeywords:i("case do else for if switch while struct"),atoms:i("null true false"),hooks:{"#":s},modeProps:{fold:["brace","include"]}}),h("text/x-objectivec",{name:"clike",keywords:i(b+"inline restrict _Bool _Complex _Imaginary BOOL Class bycopy byref id IMP in inout nil oneway out Protocol SEL self super atomic nonatomic retain copy readwrite readonly"),types:i(k),atoms:i("YES NO NULL NILL ON OFF true false"),hooks:{"@":function(e){return e.eatWhile(/[\w\$]/),"keyword"},"#":s,indent:function(e,t,n){if("statement"==t.type&&/^@\w/.test(n))return t.indented}},modeProps:{fold:"brace"}}),h("text/x-squirrel",{name:"clike",keywords:i("base break clone continue const default delete enum extends function in class foreach local resume return this throw typeof yield constructor instanceof static"),types:i(k),blockKeywords:i("case catch class else for foreach if switch try while"),defKeywords:i("function local class"),typeFirstDefinitions:!0,atoms:i("true false null"),hooks:{"#":s},modeProps:{fold:["brace","include"]}});var w=null;h("text/x-ceylon",{name:"clike",keywords:i("abstracts alias assembly assert assign break case catch class continue dynamic else exists extends finally for function given if import in interface is let module new nonempty object of out outer package return satisfies super switch then this throw try value void while"),types:function(e){var t=e.charAt(0);return t===t.toUpperCase()&&t!==t.toLowerCase()},blockKeywords:i("case catch class dynamic else finally for function if interface module new object switch try while"),defKeywords:i("class dynamic function interface module object package value"),builtin:i("abstract actual aliased annotation by default deprecated doc final formal late license native optional sealed see serializable shared suppressWarnings tagged throws variable"),isPunctuationChar:/[\[\]{}\(\),;\:\.`]/,isOperatorChar:/[+\-*&%=<>!?|^~:\/]/,numberStart:/[\d#$]/,number:/^(?:#[\da-fA-F_]+|\$[01_]+|[\d_]+[kMGTPmunpf]?|[\d_]+\.[\d_]+(?:[eE][-+]?\d+|[kMGTPmunpf]|)|)/i,multiLineStrings:!0,typeFirstDefinitions:!0,atoms:i("true false null larger smaller equal empty finished"),indentSwitch:!1,styleDefs:!1,hooks:{"@":function(e){return e.eatWhile(/[\w\$_]/),"meta"},'"':function(e,t){return t.tokenize=x(e.match('""')?"triple":"single"),t.tokenize(e,t)},"`":function(e,t){return!(!w||!e.match("`"))&&(t.tokenize=w,w=null,t.tokenize(e,t))},"'":function(e){return e.eatWhile(/[\w\$_\xa1-\uffff]/),"atom"},token:function(e,t,n){if(("variable"==n||"type"==n)&&"."==t.prevToken)return"variable-2"}},modeProps:{fold:["brace","import"],closeBrackets:{triples:'"'}}})});
      // -------------------------------------------------------------------------
//  Part of the CodeChecker project, under the Apache License v2.0 with
//  LLVM Exceptions. See LICENSE for license information.
//  SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
// -------------------------------------------------------------------------

var BugViewer = {
  _files : [],
  _reports : [],
  _lineWidgets : [],
  _navigationMenuItems : [],
  _sourceFileData : null,
  _currentReport : null,
  _lastBugEvent  : null,

  init : function (files, reports) {
    this._files = files;
    this._reports = reports;

    this.initEscapeChars();
  },

  initEscapeChars : function () {
    this.escapeChars = {
      ' ' : 'nbsp',
      '<' : 'lt',
      '>' : 'gt',
      '"' : 'quot',
      '&' : 'amp'
    };

    var regexString = '[';
    for (var key in this.escapeChars) {
      regexString += key;
    }
    regexString += ']';

    this.escapeRegExp = new RegExp( regexString, 'g');
  },

  escapeHTML : function (str) {
    var that = this;

    return str.replace(this.escapeRegExp, function (m) {
      return '&' + that.escapeChars[m] + ';';
    });
  },

  initByUrl : function () {
    if (!this._reports) return;

    var state = {};
    window.location.hash.substr(1).split('&').forEach(function (s) {
      var parts = s.split('=');
      state[parts[0]] = parts[1];
    });

    for (var key in this._reports) {
      var report = this._reports[key];
      if (report.reportHash === state['reportHash']) {
        this.navigate(report);
        return;
      }
    }

    this.navigate(this._reports[0]);
  },

  create : function () {
    this._content = document.getElementById('editor-wrapper');
    this._filepath = document.getElementById('file-path');
    this._checkerName = document.getElementById('checker-name');
    this._reviewStatusWrapper =
      document.getElementById('review-status-wrapper');
    this._reviewStatus = document.getElementById('review-status');
    this._editor = document.getElementById('editor');

    this._codeMirror = CodeMirror(this._editor, {
      mode: 'text/x-c++src',
      matchBrackets : true,
      lineNumbers : true,
      readOnly : true,
      foldGutter : true,
      extraKeys : {},
      viewportMargin : 100
    });

    this._createNavigationMenu();
  },

  navigate : function (report, item) {
    if (!item) {
      var items = this._navigationMenuItems.filter(function (navItem) {
        return navItem.report.reportHash === report.reportHash;
      });

      if (!items.length) return;

      item = items[0].widget;
    }

    this._selectedReport.classList.remove('active');
    this._selectedReport = item;
    this._selectedReport.classList.add('active');
    this.setReport(report);
  },

  _createNavigationMenu : function () {
    var that = this;

    var nav = document.getElementById('report-nav');
    var list = document.createElement('ul');
    this._reports.forEach(function (report) {
      var events = report['events'];
      var lastBugEvent = events[events.length - 1];
      var item = document.createElement('li');

      var severity = document.createElement('i');
      severity.className = 'severity-' + report.severity.toLowerCase();

      item.appendChild(severity);
      item.appendChild(document.createTextNode(lastBugEvent.message));

      item.addEventListener('click', function () {
        that.navigate(report, item);
      })
      list.appendChild(item);
      that._navigationMenuItems.push({ report : report, widget : item });
    });

    if (!this._selectedReport && list.childNodes.length) {
      this._selectedReport = list.childNodes[0];
      this._selectedReport.classList.add('active');
    }

    nav.appendChild(list);
  },

  setReport : function (report) {
    this._currentReport = report;
    var events = report['events'];
    var lastBugEvent = events[events.length - 1];
    this.setCurrentBugEvent(lastBugEvent, events.length - 1);
    this.setCheckerName(report.checkerName);
    this.setReviewStatus(report.reviewStatus);

    window.location.hash = '#reportHash=' + report.reportHash;
  },

  setCurrentBugEvent : function (event, idx) {
    this._currentBugEvent = event;
    this.setSourceFileData(this._files[event.location.file]);
    this.drawBugPath();

    this.jumpTo(event.location.line, 0);
    this.highlightBugEvent(event, idx);
  },

  highlightBugEvent : function (event, idx) {
    this._lineWidgets.forEach(function (widget) {
      var lineIdx = widget.node.getAttribute('idx');
      if (parseInt(lineIdx) === idx) {
        widget.node.classList.add('current');
      }
    });
  },

  setCheckerName : function (checkerName) {
    this._checkerName.innerHTML = checkerName;
  },

  setReviewStatus : function (status) {
    if (status) {
      var className =
        'review-status-' + status.toLowerCase().split(' ').join('-');
      this._reviewStatus.className = "review-status " + className;

      this._reviewStatus.innerHTML = status;
      this._reviewStatusWrapper.style.display = 'block';
    } else {
      this._reviewStatusWrapper.style.display = 'none';
    }
  },

  setSourceFileData : function (file) {
    if (this._sourceFileData && file.id === this._sourceFileData.id) {
      return;
    }

    this._sourceFileData = file;
    this._filepath.innerHTML = file.path;
    this._codeMirror.doc.setValue(file.content);
    this._refresh();
  },

  _refresh : function () {
    var that = this;
    setTimeout(function () {
      var fullHeight = parseInt(that._content.clientHeight);
      var headerHeight = that._filepath.clientHeight;

      that._codeMirror.setSize('auto', fullHeight - headerHeight);
      that._codeMirror.refresh();
    }, 200);
  },

  clearBubbles : function () {
    this._lineWidgets.forEach(function (widget) { widget.clear(); });
    this._lineWidgets = [];
  },

  getMessage : function (event, kind) {
    if (kind === 'macro') {
      var name = 'macro expansion' + (event.name ? ': ' + event.name : '');

      return '<span class="tag macro">' + name + '</span>'
        + this.escapeHTML(event.expansion).replace(/(?:\r\n|\r|\n)/g, '<br>');
    } else if (kind === 'note') {
      return '<span class="tag note">note</span>'
        +  this.escapeHTML(event.message).replace(/(?:\r\n|\r|\n)/g, '<br>');
    }
  },

  addExtraPathEvents : function (events, kind) {
    var that = this;

    if (!events) {
      return;
    }

    events.forEach(function (event) {
      if (event.location.file !== that._currentBugEvent.location.file) {
        return;
      }

      var left =
        that._codeMirror.defaultCharWidth() * event.location.col + 'px';

      var element = document.createElement('div');
      element.setAttribute('style', 'margin-left: ' + left);
      element.setAttribute('class', 'check-msg ' + kind);

      var msg = document.createElement('span');
      msg.innerHTML = that.getMessage(event, kind);
      element.appendChild(msg);

      that._lineWidgets.push(that._codeMirror.addLineWidget(
        event.location.line - 1, element));
    });
  },

  drawBugPath : function () {
    var that = this;

    this.clearBubbles();

    this.addExtraPathEvents(this._currentReport.macros, 'macro');
    this.addExtraPathEvents(this._currentReport.notes, 'note');

    // Processing bug path events.
    var currentEvents = this._currentReport.events;
    currentEvents.forEach(function (event, step) {
      if (event.location.file !== that._currentBugEvent.location.file)
        return;

      var left =
        that._codeMirror.defaultCharWidth() * event.location.col + 'px';
      var type = step === currentEvents.length - 1 ? 'error' : 'info';

      var element = document.createElement('div');
      element.setAttribute('style', 'margin-left: ' + left);
      element.setAttribute('class', 'check-msg ' + type);
      element.setAttribute('idx', step);

      var enumeration = document.createElement('span');
      enumeration.setAttribute('class', 'checker-enum ' + type);
      enumeration.innerHTML = step + 1;

      if (currentEvents.length > 1)
        element.appendChild(enumeration);

      var prevBugEvent = step - 1;
      if (step > 0) {
        var prevBug = document.createElement('span');
        prevBug.setAttribute('class', 'arrow left-arrow');
        prevBug.addEventListener('click', function () {
          var event = currentEvents[prevBugEvent];
          that.setCurrentBugEvent(event, prevBugEvent);
        });
        element.appendChild(prevBug);
      }

      var msg = document.createElement('span');
      msg.innerHTML = that.escapeHTML(event.message)
        .replace(/(?:\r\n|\r|\n)/g, '<br>');

      element.appendChild(msg);

      var nextBugEvent = step + 1;
      if (nextBugEvent < currentEvents.length) {
        var nextBug = document.createElement('span');
        nextBug.setAttribute('class', 'arrow right-arrow');
        nextBug.addEventListener('click', function () {
          var event = currentEvents[nextBugEvent];
          that.setCurrentBugEvent(event, nextBugEvent);
        });
        element.appendChild(nextBug);
      }


      that._lineWidgets.push(that._codeMirror.addLineWidget(
        event.location.line - 1, element));
    });
  },

  jumpTo : function (line, column) {
    var that = this;

    setTimeout(function () {
      var selPosPixel
        = that._codeMirror.charCoords({ line : line, ch : column }, 'local');
      var editorSize = {
        width  : that._editor.clientWidth,
        height : that._editor.clientHeight
      };

      that._codeMirror.scrollIntoView({
        top    : selPosPixel.top - 100,
        bottom : selPosPixel.top + editorSize.height - 150,
        left   : selPosPixel.left < editorSize.width - 100
               ? 0
               : selPosPixel.left - 50,
        right  : selPosPixel.left < editorSize.width - 100
               ? 10
               : selPosPixel.left + editorSize.width - 100
      });
    }, 0);
  }
}


      var data = {"files": {"0": {"id": 0, "path": "/src/drivers/net/ethernet/broadcom/bnx2x/bnx2x_cmn.c", "content": "/* bnx2x_cmn.c: QLogic Everest network driver.\n *\n * Copyright (c) 2007-2013 Broadcom Corporation\n * Copyright (c) 2014 QLogic Corporation\n * All rights reserved\n *\n * This program is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation.\n *\n * Maintained by: Ariel Elior <ariel.elior@qlogic.com>\n * Written by: Eliezer Tamir\n * Based on code from Michael Chan's bnx2 driver\n * UDP CSUM errata workaround by Arik Gendelman\n * Slowpath and fastpath rework by Vladislav Zolotarov\n * Statistics and Link management by Yitchak Gertner\n *\n */\n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/etherdevice.h>\n#include <linux/if_vlan.h>\n#include <linux/interrupt.h>\n#include <linux/ip.h>\n#include <linux/crash_dump.h>\n#include <net/tcp.h>\n#include <net/ipv6.h>\n#include <net/ip6_checksum.h>\n#include <linux/prefetch.h>\n#include \"bnx2x_cmn.h\"\n#include \"bnx2x_init.h\"\n#include \"bnx2x_sp.h\"\n\nstatic void bnx2x_free_fp_mem_cnic(struct bnx2x *bp);\nstatic int bnx2x_alloc_fp_mem_cnic(struct bnx2x *bp);\nstatic int bnx2x_alloc_fp_mem(struct bnx2x *bp);\nstatic int bnx2x_poll(struct napi_struct *napi, int budget);\n\nstatic void bnx2x_add_all_napi_cnic(struct bnx2x *bp)\n{\n\tint i;\n\n\t/* Add NAPI objects */\n\tfor_each_rx_queue_cnic(bp, i) {\n\t\tnetif_napi_add(bp->dev, &bnx2x_fp(bp, i, napi),\n\t\t\t       bnx2x_poll, NAPI_POLL_WEIGHT);\n\t}\n}\n\nstatic void bnx2x_add_all_napi(struct bnx2x *bp)\n{\n\tint i;\n\n\t/* Add NAPI objects */\n\tfor_each_eth_queue(bp, i) {\n\t\tnetif_napi_add(bp->dev, &bnx2x_fp(bp, i, napi),\n\t\t\t       bnx2x_poll, NAPI_POLL_WEIGHT);\n\t}\n}\n\nstatic int bnx2x_calc_num_queues(struct bnx2x *bp)\n{\n\tint nq = bnx2x_num_queues ? : netif_get_num_default_rss_queues();\n\n\t/* Reduce memory usage in kdump environment by using only one queue */\n\tif (is_kdump_kernel())\n\t\tnq = 1;\n\n\tnq = clamp(nq, 1, BNX2X_MAX_QUEUES(bp));\n\treturn nq;\n}\n\n/**\n * bnx2x_move_fp - move content of the fastpath structure.\n *\n * @bp:\t\tdriver handle\n * @from:\tsource FP index\n * @to:\t\tdestination FP index\n *\n * Makes sure the contents of the bp->fp[to].napi is kept\n * intact. This is done by first copying the napi struct from\n * the target to the source, and then mem copying the entire\n * source onto the target. Update txdata pointers and related\n * content.\n */\nstatic inline void bnx2x_move_fp(struct bnx2x *bp, int from, int to)\n{\n\tstruct bnx2x_fastpath *from_fp = &bp->fp[from];\n\tstruct bnx2x_fastpath *to_fp = &bp->fp[to];\n\tstruct bnx2x_sp_objs *from_sp_objs = &bp->sp_objs[from];\n\tstruct bnx2x_sp_objs *to_sp_objs = &bp->sp_objs[to];\n\tstruct bnx2x_fp_stats *from_fp_stats = &bp->fp_stats[from];\n\tstruct bnx2x_fp_stats *to_fp_stats = &bp->fp_stats[to];\n\tint old_max_eth_txqs, new_max_eth_txqs;\n\tint old_txdata_index = 0, new_txdata_index = 0;\n\tstruct bnx2x_agg_info *old_tpa_info = to_fp->tpa_info;\n\n\t/* Copy the NAPI object as it has been already initialized */\n\tfrom_fp->napi = to_fp->napi;\n\n\t/* Move bnx2x_fastpath contents */\n\tmemcpy(to_fp, from_fp, sizeof(*to_fp));\n\tto_fp->index = to;\n\n\t/* Retain the tpa_info of the original `to' version as we don't want\n\t * 2 FPs to contain the same tpa_info pointer.\n\t */\n\tto_fp->tpa_info = old_tpa_info;\n\n\t/* move sp_objs contents as well, as their indices match fp ones */\n\tmemcpy(to_sp_objs, from_sp_objs, sizeof(*to_sp_objs));\n\n\t/* move fp_stats contents as well, as their indices match fp ones */\n\tmemcpy(to_fp_stats, from_fp_stats, sizeof(*to_fp_stats));\n\n\t/* Update txdata pointers in fp and move txdata content accordingly:\n\t * Each fp consumes 'max_cos' txdata structures, so the index should be\n\t * decremented by max_cos x delta.\n\t */\n\n\told_max_eth_txqs = BNX2X_NUM_ETH_QUEUES(bp) * (bp)->max_cos;\n\tnew_max_eth_txqs = (BNX2X_NUM_ETH_QUEUES(bp) - from + to) *\n\t\t\t\t(bp)->max_cos;\n\tif (from == FCOE_IDX(bp)) {\n\t\told_txdata_index = old_max_eth_txqs + FCOE_TXQ_IDX_OFFSET;\n\t\tnew_txdata_index = new_max_eth_txqs + FCOE_TXQ_IDX_OFFSET;\n\t}\n\n\tmemcpy(&bp->bnx2x_txq[new_txdata_index],\n\t       &bp->bnx2x_txq[old_txdata_index],\n\t       sizeof(struct bnx2x_fp_txdata));\n\tto_fp->txdata_ptr[0] = &bp->bnx2x_txq[new_txdata_index];\n}\n\n/**\n * bnx2x_fill_fw_str - Fill buffer with FW version string.\n *\n * @bp:        driver handle\n * @buf:       character buffer to fill with the fw name\n * @buf_len:   length of the above buffer\n *\n */\nvoid bnx2x_fill_fw_str(struct bnx2x *bp, char *buf, size_t buf_len)\n{\n\tif (IS_PF(bp)) {\n\t\tu8 phy_fw_ver[PHY_FW_VER_LEN];\n\n\t\tphy_fw_ver[0] = '\\0';\n\t\tbnx2x_get_ext_phy_fw_version(&bp->link_params,\n\t\t\t\t\t     phy_fw_ver, PHY_FW_VER_LEN);\n\t\tstrlcpy(buf, bp->fw_ver, buf_len);\n\t\tsnprintf(buf + strlen(bp->fw_ver), 32 - strlen(bp->fw_ver),\n\t\t\t \"bc %d.%d.%d%s%s\",\n\t\t\t (bp->common.bc_ver & 0xff0000) >> 16,\n\t\t\t (bp->common.bc_ver & 0xff00) >> 8,\n\t\t\t (bp->common.bc_ver & 0xff),\n\t\t\t ((phy_fw_ver[0] != '\\0') ? \" phy \" : \"\"), phy_fw_ver);\n\t} else {\n\t\tbnx2x_vf_fill_fw_str(bp, buf, buf_len);\n\t}\n}\n\n/**\n * bnx2x_shrink_eth_fp - guarantees fastpath structures stay intact\n *\n * @bp:\tdriver handle\n * @delta:\tnumber of eth queues which were not allocated\n */\nstatic void bnx2x_shrink_eth_fp(struct bnx2x *bp, int delta)\n{\n\tint i, cos, old_eth_num = BNX2X_NUM_ETH_QUEUES(bp);\n\n\t/* Queue pointer cannot be re-set on an fp-basis, as moving pointer\n\t * backward along the array could cause memory to be overridden\n\t */\n\tfor (cos = 1; cos < bp->max_cos; cos++) {\n\t\tfor (i = 0; i < old_eth_num - delta; i++) {\n\t\t\tstruct bnx2x_fastpath *fp = &bp->fp[i];\n\t\t\tint new_idx = cos * (old_eth_num - delta) + i;\n\n\t\t\tmemcpy(&bp->bnx2x_txq[new_idx], fp->txdata_ptr[cos],\n\t\t\t       sizeof(struct bnx2x_fp_txdata));\n\t\t\tfp->txdata_ptr[cos] = &bp->bnx2x_txq[new_idx];\n\t\t}\n\t}\n}\n\nint bnx2x_load_count[2][3] = { {0} }; /* per-path: 0-common, 1-port0, 2-port1 */\n\n/* free skb in the packet ring at pos idx\n * return idx of last bd freed\n */\nstatic u16 bnx2x_free_tx_pkt(struct bnx2x *bp, struct bnx2x_fp_txdata *txdata,\n\t\t\t     u16 idx, unsigned int *pkts_compl,\n\t\t\t     unsigned int *bytes_compl)\n{\n\tstruct sw_tx_bd *tx_buf = &txdata->tx_buf_ring[idx];\n\tstruct eth_tx_start_bd *tx_start_bd;\n\tstruct eth_tx_bd *tx_data_bd;\n\tstruct sk_buff *skb = tx_buf->skb;\n\tu16 bd_idx = TX_BD(tx_buf->first_bd), new_cons;\n\tint nbd;\n\tu16 split_bd_len = 0;\n\n\t/* prefetch skb end pointer to speedup dev_kfree_skb() */\n\tprefetch(&skb->end);\n\n\tDP(NETIF_MSG_TX_DONE, \"fp[%d]: pkt_idx %d  buff @(%p)->skb %p\\n\",\n\t   txdata->txq_index, idx, tx_buf, skb);\n\n\ttx_start_bd = &txdata->tx_desc_ring[bd_idx].start_bd;\n\n\tnbd = le16_to_cpu(tx_start_bd->nbd) - 1;\n#ifdef BNX2X_STOP_ON_ERROR\n\tif ((nbd - 1) > (MAX_SKB_FRAGS + 2)) {\n\t\tBNX2X_ERR(\"BAD nbd!\\n\");\n\t\tbnx2x_panic();\n\t}\n#endif\n\tnew_cons = nbd + tx_buf->first_bd;\n\n\t/* Get the next bd */\n\tbd_idx = TX_BD(NEXT_TX_IDX(bd_idx));\n\n\t/* Skip a parse bd... */\n\t--nbd;\n\tbd_idx = TX_BD(NEXT_TX_IDX(bd_idx));\n\n\tif (tx_buf->flags & BNX2X_HAS_SECOND_PBD) {\n\t\t/* Skip second parse bd... */\n\t\t--nbd;\n\t\tbd_idx = TX_BD(NEXT_TX_IDX(bd_idx));\n\t}\n\n\t/* TSO headers+data bds share a common mapping. See bnx2x_tx_split() */\n\tif (tx_buf->flags & BNX2X_TSO_SPLIT_BD) {\n\t\ttx_data_bd = &txdata->tx_desc_ring[bd_idx].reg_bd;\n\t\tsplit_bd_len = BD_UNMAP_LEN(tx_data_bd);\n\t\t--nbd;\n\t\tbd_idx = TX_BD(NEXT_TX_IDX(bd_idx));\n\t}\n\n\t/* unmap first bd */\n\tdma_unmap_single(&bp->pdev->dev, BD_UNMAP_ADDR(tx_start_bd),\n\t\t\t BD_UNMAP_LEN(tx_start_bd) + split_bd_len,\n\t\t\t DMA_TO_DEVICE);\n\n\t/* now free frags */\n\twhile (nbd > 0) {\n\n\t\ttx_data_bd = &txdata->tx_desc_ring[bd_idx].reg_bd;\n\t\tdma_unmap_page(&bp->pdev->dev, BD_UNMAP_ADDR(tx_data_bd),\n\t\t\t       BD_UNMAP_LEN(tx_data_bd), DMA_TO_DEVICE);\n\t\tif (--nbd)\n\t\t\tbd_idx = TX_BD(NEXT_TX_IDX(bd_idx));\n\t}\n\n\t/* release skb */\n\tWARN_ON(!skb);\n\tif (likely(skb)) {\n\t\t(*pkts_compl)++;\n\t\t(*bytes_compl) += skb->len;\n\t\tdev_kfree_skb_any(skb);\n\t}\n\n\ttx_buf->first_bd = 0;\n\ttx_buf->skb = NULL;\n\n\treturn new_cons;\n}\n\nint bnx2x_tx_int(struct bnx2x *bp, struct bnx2x_fp_txdata *txdata)\n{\n\tstruct netdev_queue *txq;\n\tu16 hw_cons, sw_cons, bd_cons = txdata->tx_bd_cons;\n\tunsigned int pkts_compl = 0, bytes_compl = 0;\n\n#ifdef BNX2X_STOP_ON_ERROR\n\tif (unlikely(bp->panic))\n\t\treturn -1;\n#endif\n\n\ttxq = netdev_get_tx_queue(bp->dev, txdata->txq_index);\n\thw_cons = le16_to_cpu(*txdata->tx_cons_sb);\n\tsw_cons = txdata->tx_pkt_cons;\n\n\t/* Ensure subsequent loads occur after hw_cons */\n\tsmp_rmb();\n\n\twhile (sw_cons != hw_cons) {\n\t\tu16 pkt_cons;\n\n\t\tpkt_cons = TX_BD(sw_cons);\n\n\t\tDP(NETIF_MSG_TX_DONE,\n\t\t   \"queue[%d]: hw_cons %u  sw_cons %u  pkt_cons %u\\n\",\n\t\t   txdata->txq_index, hw_cons, sw_cons, pkt_cons);\n\n\t\tbd_cons = bnx2x_free_tx_pkt(bp, txdata, pkt_cons,\n\t\t\t\t\t    &pkts_compl, &bytes_compl);\n\n\t\tsw_cons++;\n\t}\n\n\tnetdev_tx_completed_queue(txq, pkts_compl, bytes_compl);\n\n\ttxdata->tx_pkt_cons = sw_cons;\n\ttxdata->tx_bd_cons = bd_cons;\n\n\t/* Need to make the tx_bd_cons update visible to start_xmit()\n\t * before checking for netif_tx_queue_stopped().  Without the\n\t * memory barrier, there is a small possibility that\n\t * start_xmit() will miss it and cause the queue to be stopped\n\t * forever.\n\t * On the other hand we need an rmb() here to ensure the proper\n\t * ordering of bit testing in the following\n\t * netif_tx_queue_stopped(txq) call.\n\t */\n\tsmp_mb();\n\n\tif (unlikely(netif_tx_queue_stopped(txq))) {\n\t\t/* Taking tx_lock() is needed to prevent re-enabling the queue\n\t\t * while it's empty. This could have happen if rx_action() gets\n\t\t * suspended in bnx2x_tx_int() after the condition before\n\t\t * netif_tx_wake_queue(), while tx_action (bnx2x_start_xmit()):\n\t\t *\n\t\t * stops the queue->sees fresh tx_bd_cons->releases the queue->\n\t\t * sends some packets consuming the whole queue again->\n\t\t * stops the queue\n\t\t */\n\n\t\t__netif_tx_lock(txq, smp_processor_id());\n\n\t\tif ((netif_tx_queue_stopped(txq)) &&\n\t\t    (bp->state == BNX2X_STATE_OPEN) &&\n\t\t    (bnx2x_tx_avail(bp, txdata) >= MAX_DESC_PER_TX_PKT))\n\t\t\tnetif_tx_wake_queue(txq);\n\n\t\t__netif_tx_unlock(txq);\n\t}\n\treturn 0;\n}\n\nstatic inline void bnx2x_update_last_max_sge(struct bnx2x_fastpath *fp,\n\t\t\t\t\t     u16 idx)\n{\n\tu16 last_max = fp->last_max_sge;\n\n\tif (SUB_S16(idx, last_max) > 0)\n\t\tfp->last_max_sge = idx;\n}\n\nstatic inline void bnx2x_update_sge_prod(struct bnx2x_fastpath *fp,\n\t\t\t\t\t u16 sge_len,\n\t\t\t\t\t struct eth_end_agg_rx_cqe *cqe)\n{\n\tstruct bnx2x *bp = fp->bp;\n\tu16 last_max, last_elem, first_elem;\n\tu16 delta = 0;\n\tu16 i;\n\n\tif (!sge_len)\n\t\treturn;\n\n\t/* First mark all used pages */\n\tfor (i = 0; i < sge_len; i++)\n\t\tBIT_VEC64_CLEAR_BIT(fp->sge_mask,\n\t\t\tRX_SGE(le16_to_cpu(cqe->sgl_or_raw_data.sgl[i])));\n\n\tDP(NETIF_MSG_RX_STATUS, \"fp_cqe->sgl[%d] = %d\\n\",\n\t   sge_len - 1, le16_to_cpu(cqe->sgl_or_raw_data.sgl[sge_len - 1]));\n\n\t/* Here we assume that the last SGE index is the biggest */\n\tprefetch((void *)(fp->sge_mask));\n\tbnx2x_update_last_max_sge(fp,\n\t\tle16_to_cpu(cqe->sgl_or_raw_data.sgl[sge_len - 1]));\n\n\tlast_max = RX_SGE(fp->last_max_sge);\n\tlast_elem = last_max >> BIT_VEC64_ELEM_SHIFT;\n\tfirst_elem = RX_SGE(fp->rx_sge_prod) >> BIT_VEC64_ELEM_SHIFT;\n\n\t/* If ring is not full */\n\tif (last_elem + 1 != first_elem)\n\t\tlast_elem++;\n\n\t/* Now update the prod */\n\tfor (i = first_elem; i != last_elem; i = NEXT_SGE_MASK_ELEM(i)) {\n\t\tif (likely(fp->sge_mask[i]))\n\t\t\tbreak;\n\n\t\tfp->sge_mask[i] = BIT_VEC64_ELEM_ONE_MASK;\n\t\tdelta += BIT_VEC64_ELEM_SZ;\n\t}\n\n\tif (delta > 0) {\n\t\tfp->rx_sge_prod += delta;\n\t\t/* clear page-end entries */\n\t\tbnx2x_clear_sge_mask_next_elems(fp);\n\t}\n\n\tDP(NETIF_MSG_RX_STATUS,\n\t   \"fp->last_max_sge = %d  fp->rx_sge_prod = %d\\n\",\n\t   fp->last_max_sge, fp->rx_sge_prod);\n}\n\n/* Get Toeplitz hash value in the skb using the value from the\n * CQE (calculated by HW).\n */\nstatic u32 bnx2x_get_rxhash(const struct bnx2x *bp,\n\t\t\t    const struct eth_fast_path_rx_cqe *cqe,\n\t\t\t    enum pkt_hash_types *rxhash_type)\n{\n\t/* Get Toeplitz hash from CQE */\n\tif ((bp->dev->features & NETIF_F_RXHASH) &&\n\t    (cqe->status_flags & ETH_FAST_PATH_RX_CQE_RSS_HASH_FLG)) {\n\t\tenum eth_rss_hash_type htype;\n\n\t\thtype = cqe->status_flags & ETH_FAST_PATH_RX_CQE_RSS_HASH_TYPE;\n\t\t*rxhash_type = ((htype == TCP_IPV4_HASH_TYPE) ||\n\t\t\t\t(htype == TCP_IPV6_HASH_TYPE)) ?\n\t\t\t       PKT_HASH_TYPE_L4 : PKT_HASH_TYPE_L3;\n\n\t\treturn le32_to_cpu(cqe->rss_hash_result);\n\t}\n\t*rxhash_type = PKT_HASH_TYPE_NONE;\n\treturn 0;\n}\n\nstatic void bnx2x_tpa_start(struct bnx2x_fastpath *fp, u16 queue,\n\t\t\t    u16 cons, u16 prod,\n\t\t\t    struct eth_fast_path_rx_cqe *cqe)\n{\n\tstruct bnx2x *bp = fp->bp;\n\tstruct sw_rx_bd *cons_rx_buf = &fp->rx_buf_ring[cons];\n\tstruct sw_rx_bd *prod_rx_buf = &fp->rx_buf_ring[prod];\n\tstruct eth_rx_bd *prod_bd = &fp->rx_desc_ring[prod];\n\tdma_addr_t mapping;\n\tstruct bnx2x_agg_info *tpa_info = &fp->tpa_info[queue];\n\tstruct sw_rx_bd *first_buf = &tpa_info->first_buf;\n\n\t/* print error if current state != stop */\n\tif (tpa_info->tpa_state != BNX2X_TPA_STOP)\n\t\tBNX2X_ERR(\"start of bin not in stop [%d]\\n\", queue);\n\n\t/* Try to map an empty data buffer from the aggregation info  */\n\tmapping = dma_map_single(&bp->pdev->dev,\n\t\t\t\t first_buf->data + NET_SKB_PAD,\n\t\t\t\t fp->rx_buf_size, DMA_FROM_DEVICE);\n\t/*\n\t *  ...if it fails - move the skb from the consumer to the producer\n\t *  and set the current aggregation state as ERROR to drop it\n\t *  when TPA_STOP arrives.\n\t */\n\n\tif (unlikely(dma_mapping_error(&bp->pdev->dev, mapping))) {\n\t\t/* Move the BD from the consumer to the producer */\n\t\tbnx2x_reuse_rx_data(fp, cons, prod);\n\t\ttpa_info->tpa_state = BNX2X_TPA_ERROR;\n\t\treturn;\n\t}\n\n\t/* move empty data from pool to prod */\n\tprod_rx_buf->data = first_buf->data;\n\tdma_unmap_addr_set(prod_rx_buf, mapping, mapping);\n\t/* point prod_bd to new data */\n\tprod_bd->addr_hi = cpu_to_le32(U64_HI(mapping));\n\tprod_bd->addr_lo = cpu_to_le32(U64_LO(mapping));\n\n\t/* move partial skb from cons to pool (don't unmap yet) */\n\t*first_buf = *cons_rx_buf;\n\n\t/* mark bin state as START */\n\ttpa_info->parsing_flags =\n\t\tle16_to_cpu(cqe->pars_flags.flags);\n\ttpa_info->vlan_tag = le16_to_cpu(cqe->vlan_tag);\n\ttpa_info->tpa_state = BNX2X_TPA_START;\n\ttpa_info->len_on_bd = le16_to_cpu(cqe->len_on_bd);\n\ttpa_info->placement_offset = cqe->placement_offset;\n\ttpa_info->rxhash = bnx2x_get_rxhash(bp, cqe, &tpa_info->rxhash_type);\n\tif (fp->mode == TPA_MODE_GRO) {\n\t\tu16 gro_size = le16_to_cpu(cqe->pkt_len_or_gro_seg_len);\n\t\ttpa_info->full_page = SGE_PAGES / gro_size * gro_size;\n\t\ttpa_info->gro_size = gro_size;\n\t}\n\n#ifdef BNX2X_STOP_ON_ERROR\n\tfp->tpa_queue_used |= (1 << queue);\n\tDP(NETIF_MSG_RX_STATUS, \"fp->tpa_queue_used = 0x%llx\\n\",\n\t   fp->tpa_queue_used);\n#endif\n}\n\n/* Timestamp option length allowed for TPA aggregation:\n *\n *\t\tnop nop kind length echo val\n */\n#define TPA_TSTAMP_OPT_LEN\t12\n/**\n * bnx2x_set_gro_params - compute GRO values\n *\n * @skb:\t\tpacket skb\n * @parsing_flags:\tparsing flags from the START CQE\n * @len_on_bd:\t\ttotal length of the first packet for the\n *\t\t\taggregation.\n * @pkt_len:\t\tlength of all segments\n * @num_of_coalesced_segs: count of segments\n *\n * Approximate value of the MSS for this aggregation calculated using\n * the first packet of it.\n * Compute number of aggregated segments, and gso_type.\n */\nstatic void bnx2x_set_gro_params(struct sk_buff *skb, u16 parsing_flags,\n\t\t\t\t u16 len_on_bd, unsigned int pkt_len,\n\t\t\t\t u16 num_of_coalesced_segs)\n{\n\t/* TPA aggregation won't have either IP options or TCP options\n\t * other than timestamp or IPv6 extension headers.\n\t */\n\tu16 hdrs_len = ETH_HLEN + sizeof(struct tcphdr);\n\n\tif (GET_FLAG(parsing_flags, PARSING_FLAGS_OVER_ETHERNET_PROTOCOL) ==\n\t    PRS_FLAG_OVERETH_IPV6) {\n\t\thdrs_len += sizeof(struct ipv6hdr);\n\t\tskb_shinfo(skb)->gso_type = SKB_GSO_TCPV6;\n\t} else {\n\t\thdrs_len += sizeof(struct iphdr);\n\t\tskb_shinfo(skb)->gso_type = SKB_GSO_TCPV4;\n\t}\n\n\t/* Check if there was a TCP timestamp, if there is it's will\n\t * always be 12 bytes length: nop nop kind length echo val.\n\t *\n\t * Otherwise FW would close the aggregation.\n\t */\n\tif (parsing_flags & PARSING_FLAGS_TIME_STAMP_EXIST_FLAG)\n\t\thdrs_len += TPA_TSTAMP_OPT_LEN;\n\n\tskb_shinfo(skb)->gso_size = len_on_bd - hdrs_len;\n\n\t/* tcp_gro_complete() will copy NAPI_GRO_CB(skb)->count\n\t * to skb_shinfo(skb)->gso_segs\n\t */\n\tNAPI_GRO_CB(skb)->count = num_of_coalesced_segs;\n}\n\nstatic int bnx2x_alloc_rx_sge(struct bnx2x *bp, struct bnx2x_fastpath *fp,\n\t\t\t      u16 index, gfp_t gfp_mask)\n{\n\tstruct sw_rx_page *sw_buf = &fp->rx_page_ring[index];\n\tstruct eth_rx_sge *sge = &fp->rx_sge_ring[index];\n\tstruct bnx2x_alloc_pool *pool = &fp->page_pool;\n\tdma_addr_t mapping;\n\n\tif (!pool->page) {\n\t\tpool->page = alloc_pages(gfp_mask, PAGES_PER_SGE_SHIFT);\n\t\tif (unlikely(!pool->page))\n\t\t\treturn -ENOMEM;\n\n\t\tpool->offset = 0;\n\t}\n\n\tmapping = dma_map_page(&bp->pdev->dev, pool->page,\n\t\t\t       pool->offset, SGE_PAGE_SIZE, DMA_FROM_DEVICE);\n\tif (unlikely(dma_mapping_error(&bp->pdev->dev, mapping))) {\n\t\tBNX2X_ERR(\"Can't map sge\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tsw_buf->page = pool->page;\n\tsw_buf->offset = pool->offset;\n\n\tdma_unmap_addr_set(sw_buf, mapping, mapping);\n\n\tsge->addr_hi = cpu_to_le32(U64_HI(mapping));\n\tsge->addr_lo = cpu_to_le32(U64_LO(mapping));\n\n\tpool->offset += SGE_PAGE_SIZE;\n\tif (PAGE_SIZE - pool->offset >= SGE_PAGE_SIZE)\n\t\tget_page(pool->page);\n\telse\n\t\tpool->page = NULL;\n\treturn 0;\n}\n\nstatic int bnx2x_fill_frag_skb(struct bnx2x *bp, struct bnx2x_fastpath *fp,\n\t\t\t       struct bnx2x_agg_info *tpa_info,\n\t\t\t       u16 pages,\n\t\t\t       struct sk_buff *skb,\n\t\t\t       struct eth_end_agg_rx_cqe *cqe,\n\t\t\t       u16 cqe_idx)\n{\n\tstruct sw_rx_page *rx_pg, old_rx_pg;\n\tu32 i, frag_len, frag_size;\n\tint err, j, frag_id = 0;\n\tu16 len_on_bd = tpa_info->len_on_bd;\n\tu16 full_page = 0, gro_size = 0;\n\n\tfrag_size = le16_to_cpu(cqe->pkt_len) - len_on_bd;\n\n\tif (fp->mode == TPA_MODE_GRO) {\n\t\tgro_size = tpa_info->gro_size;\n\t\tfull_page = tpa_info->full_page;\n\t}\n\n\t/* This is needed in order to enable forwarding support */\n\tif (frag_size)\n\t\tbnx2x_set_gro_params(skb, tpa_info->parsing_flags, len_on_bd,\n\t\t\t\t     le16_to_cpu(cqe->pkt_len),\n\t\t\t\t     le16_to_cpu(cqe->num_of_coalesced_segs));\n\n#ifdef BNX2X_STOP_ON_ERROR\n\tif (pages > min_t(u32, 8, MAX_SKB_FRAGS) * SGE_PAGES) {\n\t\tBNX2X_ERR(\"SGL length is too long: %d. CQE index is %d\\n\",\n\t\t\t  pages, cqe_idx);\n\t\tBNX2X_ERR(\"cqe->pkt_len = %d\\n\", cqe->pkt_len);\n\t\tbnx2x_panic();\n\t\treturn -EINVAL;\n\t}\n#endif\n\n\t/* Run through the SGL and compose the fragmented skb */\n\tfor (i = 0, j = 0; i < pages; i += PAGES_PER_SGE, j++) {\n\t\tu16 sge_idx = RX_SGE(le16_to_cpu(cqe->sgl_or_raw_data.sgl[j]));\n\n\t\t/* FW gives the indices of the SGE as if the ring is an array\n\t\t   (meaning that \"next\" element will consume 2 indices) */\n\t\tif (fp->mode == TPA_MODE_GRO)\n\t\t\tfrag_len = min_t(u32, frag_size, (u32)full_page);\n\t\telse /* LRO */\n\t\t\tfrag_len = min_t(u32, frag_size, (u32)SGE_PAGES);\n\n\t\trx_pg = &fp->rx_page_ring[sge_idx];\n\t\told_rx_pg = *rx_pg;\n\n\t\t/* If we fail to allocate a substitute page, we simply stop\n\t\t   where we are and drop the whole packet */\n\t\terr = bnx2x_alloc_rx_sge(bp, fp, sge_idx, GFP_ATOMIC);\n\t\tif (unlikely(err)) {\n\t\t\tbnx2x_fp_qstats(bp, fp)->rx_skb_alloc_failed++;\n\t\t\treturn err;\n\t\t}\n\n\t\tdma_unmap_page(&bp->pdev->dev,\n\t\t\t       dma_unmap_addr(&old_rx_pg, mapping),\n\t\t\t       SGE_PAGE_SIZE, DMA_FROM_DEVICE);\n\t\t/* Add one frag and update the appropriate fields in the skb */\n\t\tif (fp->mode == TPA_MODE_LRO)\n\t\t\tskb_fill_page_desc(skb, j, old_rx_pg.page,\n\t\t\t\t\t   old_rx_pg.offset, frag_len);\n\t\telse { /* GRO */\n\t\t\tint rem;\n\t\t\tint offset = 0;\n\t\t\tfor (rem = frag_len; rem > 0; rem -= gro_size) {\n\t\t\t\tint len = rem > gro_size ? gro_size : rem;\n\t\t\t\tskb_fill_page_desc(skb, frag_id++,\n\t\t\t\t\t\t   old_rx_pg.page,\n\t\t\t\t\t\t   old_rx_pg.offset + offset,\n\t\t\t\t\t\t   len);\n\t\t\t\tif (offset)\n\t\t\t\t\tget_page(old_rx_pg.page);\n\t\t\t\toffset += len;\n\t\t\t}\n\t\t}\n\n\t\tskb->data_len += frag_len;\n\t\tskb->truesize += SGE_PAGES;\n\t\tskb->len += frag_len;\n\n\t\tfrag_size -= frag_len;\n\t}\n\n\treturn 0;\n}\n\nstatic void bnx2x_frag_free(const struct bnx2x_fastpath *fp, void *data)\n{\n\tif (fp->rx_frag_size)\n\t\tskb_free_frag(data);\n\telse\n\t\tkfree(data);\n}\n\nstatic void *bnx2x_frag_alloc(const struct bnx2x_fastpath *fp, gfp_t gfp_mask)\n{\n\tif (fp->rx_frag_size) {\n\t\t/* GFP_KERNEL allocations are used only during initialization */\n\t\tif (unlikely(gfpflags_allow_blocking(gfp_mask)))\n\t\t\treturn (void *)__get_free_page(gfp_mask);\n\n\t\treturn napi_alloc_frag(fp->rx_frag_size);\n\t}\n\n\treturn kmalloc(fp->rx_buf_size + NET_SKB_PAD, gfp_mask);\n}\n\n#ifdef CONFIG_INET\nstatic void bnx2x_gro_ip_csum(struct bnx2x *bp, struct sk_buff *skb)\n{\n\tconst struct iphdr *iph = ip_hdr(skb);\n\tstruct tcphdr *th;\n\n\tskb_set_transport_header(skb, sizeof(struct iphdr));\n\tth = tcp_hdr(skb);\n\n\tth->check = ~tcp_v4_check(skb->len - skb_transport_offset(skb),\n\t\t\t\t  iph->saddr, iph->daddr, 0);\n}\n\nstatic void bnx2x_gro_ipv6_csum(struct bnx2x *bp, struct sk_buff *skb)\n{\n\tstruct ipv6hdr *iph = ipv6_hdr(skb);\n\tstruct tcphdr *th;\n\n\tskb_set_transport_header(skb, sizeof(struct ipv6hdr));\n\tth = tcp_hdr(skb);\n\n\tth->check = ~tcp_v6_check(skb->len - skb_transport_offset(skb),\n\t\t\t\t  &iph->saddr, &iph->daddr, 0);\n}\n\nstatic void bnx2x_gro_csum(struct bnx2x *bp, struct sk_buff *skb,\n\t\t\t    void (*gro_func)(struct bnx2x*, struct sk_buff*))\n{\n\tskb_reset_network_header(skb);\n\tgro_func(bp, skb);\n\ttcp_gro_complete(skb);\n}\n#endif\n\nstatic void bnx2x_gro_receive(struct bnx2x *bp, struct bnx2x_fastpath *fp,\n\t\t\t       struct sk_buff *skb)\n{\n#ifdef CONFIG_INET\n\tif (skb_shinfo(skb)->gso_size) {\n\t\tswitch (be16_to_cpu(skb->protocol)) {\n\t\tcase ETH_P_IP:\n\t\t\tbnx2x_gro_csum(bp, skb, bnx2x_gro_ip_csum);\n\t\t\tbreak;\n\t\tcase ETH_P_IPV6:\n\t\t\tbnx2x_gro_csum(bp, skb, bnx2x_gro_ipv6_csum);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tnetdev_WARN_ONCE(bp->dev,\n\t\t\t\t\t \"Error: FW GRO supports only IPv4/IPv6, not 0x%04x\\n\",\n\t\t\t\t\t be16_to_cpu(skb->protocol));\n\t\t}\n\t}\n#endif\n\tskb_record_rx_queue(skb, fp->rx_queue);\n\tnapi_gro_receive(&fp->napi, skb);\n}\n\nstatic void bnx2x_tpa_stop(struct bnx2x *bp, struct bnx2x_fastpath *fp,\n\t\t\t   struct bnx2x_agg_info *tpa_info,\n\t\t\t   u16 pages,\n\t\t\t   struct eth_end_agg_rx_cqe *cqe,\n\t\t\t   u16 cqe_idx)\n{\n\tstruct sw_rx_bd *rx_buf = &tpa_info->first_buf;\n\tu8 pad = tpa_info->placement_offset;\n\tu16 len = tpa_info->len_on_bd;\n\tstruct sk_buff *skb = NULL;\n\tu8 *new_data, *data = rx_buf->data;\n\tu8 old_tpa_state = tpa_info->tpa_state;\n\n\ttpa_info->tpa_state = BNX2X_TPA_STOP;\n\n\t/* If we there was an error during the handling of the TPA_START -\n\t * drop this aggregation.\n\t */\n\tif (old_tpa_state == BNX2X_TPA_ERROR)\n\t\tgoto drop;\n\n\t/* Try to allocate the new data */\n\tnew_data = bnx2x_frag_alloc(fp, GFP_ATOMIC);\n\t/* Unmap skb in the pool anyway, as we are going to change\n\t   pool entry status to BNX2X_TPA_STOP even if new skb allocation\n\t   fails. */\n\tdma_unmap_single(&bp->pdev->dev, dma_unmap_addr(rx_buf, mapping),\n\t\t\t fp->rx_buf_size, DMA_FROM_DEVICE);\n\tif (likely(new_data))\n\t\tskb = build_skb(data, fp->rx_frag_size);\n\n\tif (likely(skb)) {\n#ifdef BNX2X_STOP_ON_ERROR\n\t\tif (pad + len > fp->rx_buf_size) {\n\t\t\tBNX2X_ERR(\"skb_put is about to fail...  pad %d  len %d  rx_buf_size %d\\n\",\n\t\t\t\t  pad, len, fp->rx_buf_size);\n\t\t\tbnx2x_panic();\n\t\t\treturn;\n\t\t}\n#endif\n\n\t\tskb_reserve(skb, pad + NET_SKB_PAD);\n\t\tskb_put(skb, len);\n\t\tskb_set_hash(skb, tpa_info->rxhash, tpa_info->rxhash_type);\n\n\t\tskb->protocol = eth_type_trans(skb, bp->dev);\n\t\tskb->ip_summed = CHECKSUM_UNNECESSARY;\n\n\t\tif (!bnx2x_fill_frag_skb(bp, fp, tpa_info, pages,\n\t\t\t\t\t skb, cqe, cqe_idx)) {\n\t\t\tif (tpa_info->parsing_flags & PARSING_FLAGS_VLAN)\n\t\t\t\t__vlan_hwaccel_put_tag(skb, htons(ETH_P_8021Q), tpa_info->vlan_tag);\n\t\t\tbnx2x_gro_receive(bp, fp, skb);\n\t\t} else {\n\t\t\tDP(NETIF_MSG_RX_STATUS,\n\t\t\t   \"Failed to allocate new pages - dropping packet!\\n\");\n\t\t\tdev_kfree_skb_any(skb);\n\t\t}\n\n\t\t/* put new data in bin */\n\t\trx_buf->data = new_data;\n\n\t\treturn;\n\t}\n\tif (new_data)\n\t\tbnx2x_frag_free(fp, new_data);\ndrop:\n\t/* drop the packet and keep the buffer in the bin */\n\tDP(NETIF_MSG_RX_STATUS,\n\t   \"Failed to allocate or map a new skb - dropping packet!\\n\");\n\tbnx2x_fp_stats(bp, fp)->eth_q_stats.rx_skb_alloc_failed++;\n}\n\nstatic int bnx2x_alloc_rx_data(struct bnx2x *bp, struct bnx2x_fastpath *fp,\n\t\t\t       u16 index, gfp_t gfp_mask)\n{\n\tu8 *data;\n\tstruct sw_rx_bd *rx_buf = &fp->rx_buf_ring[index];\n\tstruct eth_rx_bd *rx_bd = &fp->rx_desc_ring[index];\n\tdma_addr_t mapping;\n\n\tdata = bnx2x_frag_alloc(fp, gfp_mask);\n\tif (unlikely(data == NULL))\n\t\treturn -ENOMEM;\n\n\tmapping = dma_map_single(&bp->pdev->dev, data + NET_SKB_PAD,\n\t\t\t\t fp->rx_buf_size,\n\t\t\t\t DMA_FROM_DEVICE);\n\tif (unlikely(dma_mapping_error(&bp->pdev->dev, mapping))) {\n\t\tbnx2x_frag_free(fp, data);\n\t\tBNX2X_ERR(\"Can't map rx data\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\trx_buf->data = data;\n\tdma_unmap_addr_set(rx_buf, mapping, mapping);\n\n\trx_bd->addr_hi = cpu_to_le32(U64_HI(mapping));\n\trx_bd->addr_lo = cpu_to_le32(U64_LO(mapping));\n\n\treturn 0;\n}\n\nstatic\nvoid bnx2x_csum_validate(struct sk_buff *skb, union eth_rx_cqe *cqe,\n\t\t\t\t struct bnx2x_fastpath *fp,\n\t\t\t\t struct bnx2x_eth_q_stats *qstats)\n{\n\t/* Do nothing if no L4 csum validation was done.\n\t * We do not check whether IP csum was validated. For IPv4 we assume\n\t * that if the card got as far as validating the L4 csum, it also\n\t * validated the IP csum. IPv6 has no IP csum.\n\t */\n\tif (cqe->fast_path_cqe.status_flags &\n\t    ETH_FAST_PATH_RX_CQE_L4_XSUM_NO_VALIDATION_FLG)\n\t\treturn;\n\n\t/* If L4 validation was done, check if an error was found. */\n\n\tif (cqe->fast_path_cqe.type_error_flags &\n\t    (ETH_FAST_PATH_RX_CQE_IP_BAD_XSUM_FLG |\n\t     ETH_FAST_PATH_RX_CQE_L4_BAD_XSUM_FLG))\n\t\tqstats->hw_csum_err++;\n\telse\n\t\tskb->ip_summed = CHECKSUM_UNNECESSARY;\n}\n\nstatic int bnx2x_rx_int(struct bnx2x_fastpath *fp, int budget)\n{\n\tstruct bnx2x *bp = fp->bp;\n\tu16 bd_cons, bd_prod, bd_prod_fw, comp_ring_cons;\n\tu16 sw_comp_cons, sw_comp_prod;\n\tint rx_pkt = 0;\n\tunion eth_rx_cqe *cqe;\n\tstruct eth_fast_path_rx_cqe *cqe_fp;\n\n#ifdef BNX2X_STOP_ON_ERROR\n\tif (unlikely(bp->panic))\n\t\treturn 0;\n#endif\n\tif (budget <= 0)\n\t\treturn rx_pkt;\n\n\tbd_cons = fp->rx_bd_cons;\n\tbd_prod = fp->rx_bd_prod;\n\tbd_prod_fw = bd_prod;\n\tsw_comp_cons = fp->rx_comp_cons;\n\tsw_comp_prod = fp->rx_comp_prod;\n\n\tcomp_ring_cons = RCQ_BD(sw_comp_cons);\n\tcqe = &fp->rx_comp_ring[comp_ring_cons];\n\tcqe_fp = &cqe->fast_path_cqe;\n\n\tDP(NETIF_MSG_RX_STATUS,\n\t   \"queue[%d]: sw_comp_cons %u\\n\", fp->index, sw_comp_cons);\n\n\twhile (BNX2X_IS_CQE_COMPLETED(cqe_fp)) {\n\t\tstruct sw_rx_bd *rx_buf = NULL;\n\t\tstruct sk_buff *skb;\n\t\tu8 cqe_fp_flags;\n\t\tenum eth_rx_cqe_type cqe_fp_type;\n\t\tu16 len, pad, queue;\n\t\tu8 *data;\n\t\tu32 rxhash;\n\t\tenum pkt_hash_types rxhash_type;\n\n#ifdef BNX2X_STOP_ON_ERROR\n\t\tif (unlikely(bp->panic))\n\t\t\treturn 0;\n#endif\n\n\t\tbd_prod = RX_BD(bd_prod);\n\t\tbd_cons = RX_BD(bd_cons);\n\n\t\t/* A rmb() is required to ensure that the CQE is not read\n\t\t * before it is written by the adapter DMA.  PCI ordering\n\t\t * rules will make sure the other fields are written before\n\t\t * the marker at the end of struct eth_fast_path_rx_cqe\n\t\t * but without rmb() a weakly ordered processor can process\n\t\t * stale data.  Without the barrier TPA state-machine might\n\t\t * enter inconsistent state and kernel stack might be\n\t\t * provided with incorrect packet description - these lead\n\t\t * to various kernel crashed.\n\t\t */\n\t\trmb();\n\n\t\tcqe_fp_flags = cqe_fp->type_error_flags;\n\t\tcqe_fp_type = cqe_fp_flags & ETH_FAST_PATH_RX_CQE_TYPE;\n\n\t\tDP(NETIF_MSG_RX_STATUS,\n\t\t   \"CQE type %x  err %x  status %x  queue %x  vlan %x  len %u\\n\",\n\t\t   CQE_TYPE(cqe_fp_flags),\n\t\t   cqe_fp_flags, cqe_fp->status_flags,\n\t\t   le32_to_cpu(cqe_fp->rss_hash_result),\n\t\t   le16_to_cpu(cqe_fp->vlan_tag),\n\t\t   le16_to_cpu(cqe_fp->pkt_len_or_gro_seg_len));\n\n\t\t/* is this a slowpath msg? */\n\t\tif (unlikely(CQE_TYPE_SLOW(cqe_fp_type))) {\n\t\t\tbnx2x_sp_event(fp, cqe);\n\t\t\tgoto next_cqe;\n\t\t}\n\n\t\trx_buf = &fp->rx_buf_ring[bd_cons];\n\t\tdata = rx_buf->data;\n\n\t\tif (!CQE_TYPE_FAST(cqe_fp_type)) {\n\t\t\tstruct bnx2x_agg_info *tpa_info;\n\t\t\tu16 frag_size, pages;\n#ifdef BNX2X_STOP_ON_ERROR\n\t\t\t/* sanity check */\n\t\t\tif (fp->mode == TPA_MODE_DISABLED &&\n\t\t\t    (CQE_TYPE_START(cqe_fp_type) ||\n\t\t\t     CQE_TYPE_STOP(cqe_fp_type)))\n\t\t\t\tBNX2X_ERR(\"START/STOP packet while TPA disabled, type %x\\n\",\n\t\t\t\t\t  CQE_TYPE(cqe_fp_type));\n#endif\n\n\t\t\tif (CQE_TYPE_START(cqe_fp_type)) {\n\t\t\t\tu16 queue = cqe_fp->queue_index;\n\t\t\t\tDP(NETIF_MSG_RX_STATUS,\n\t\t\t\t   \"calling tpa_start on queue %d\\n\",\n\t\t\t\t   queue);\n\n\t\t\t\tbnx2x_tpa_start(fp, queue,\n\t\t\t\t\t\tbd_cons, bd_prod,\n\t\t\t\t\t\tcqe_fp);\n\n\t\t\t\tgoto next_rx;\n\t\t\t}\n\t\t\tqueue = cqe->end_agg_cqe.queue_index;\n\t\t\ttpa_info = &fp->tpa_info[queue];\n\t\t\tDP(NETIF_MSG_RX_STATUS,\n\t\t\t   \"calling tpa_stop on queue %d\\n\",\n\t\t\t   queue);\n\n\t\t\tfrag_size = le16_to_cpu(cqe->end_agg_cqe.pkt_len) -\n\t\t\t\t    tpa_info->len_on_bd;\n\n\t\t\tif (fp->mode == TPA_MODE_GRO)\n\t\t\t\tpages = (frag_size + tpa_info->full_page - 1) /\n\t\t\t\t\t tpa_info->full_page;\n\t\t\telse\n\t\t\t\tpages = SGE_PAGE_ALIGN(frag_size) >>\n\t\t\t\t\tSGE_PAGE_SHIFT;\n\n\t\t\tbnx2x_tpa_stop(bp, fp, tpa_info, pages,\n\t\t\t\t       &cqe->end_agg_cqe, comp_ring_cons);\n#ifdef BNX2X_STOP_ON_ERROR\n\t\t\tif (bp->panic)\n\t\t\t\treturn 0;\n#endif\n\n\t\t\tbnx2x_update_sge_prod(fp, pages, &cqe->end_agg_cqe);\n\t\t\tgoto next_cqe;\n\t\t}\n\t\t/* non TPA */\n\t\tlen = le16_to_cpu(cqe_fp->pkt_len_or_gro_seg_len);\n\t\tpad = cqe_fp->placement_offset;\n\t\tdma_sync_single_for_cpu(&bp->pdev->dev,\n\t\t\t\t\tdma_unmap_addr(rx_buf, mapping),\n\t\t\t\t\tpad + RX_COPY_THRESH,\n\t\t\t\t\tDMA_FROM_DEVICE);\n\t\tpad += NET_SKB_PAD;\n\t\tprefetch(data + pad); /* speedup eth_type_trans() */\n\t\t/* is this an error packet? */\n\t\tif (unlikely(cqe_fp_flags & ETH_RX_ERROR_FALGS)) {\n\t\t\tDP(NETIF_MSG_RX_ERR | NETIF_MSG_RX_STATUS,\n\t\t\t   \"ERROR  flags %x  rx packet %u\\n\",\n\t\t\t   cqe_fp_flags, sw_comp_cons);\n\t\t\tbnx2x_fp_qstats(bp, fp)->rx_err_discard_pkt++;\n\t\t\tgoto reuse_rx;\n\t\t}\n\n\t\t/* Since we don't have a jumbo ring\n\t\t * copy small packets if mtu > 1500\n\t\t */\n\t\tif ((bp->dev->mtu > ETH_MAX_PACKET_SIZE) &&\n\t\t    (len <= RX_COPY_THRESH)) {\n\t\t\tskb = napi_alloc_skb(&fp->napi, len);\n\t\t\tif (skb == NULL) {\n\t\t\t\tDP(NETIF_MSG_RX_ERR | NETIF_MSG_RX_STATUS,\n\t\t\t\t   \"ERROR  packet dropped because of alloc failure\\n\");\n\t\t\t\tbnx2x_fp_qstats(bp, fp)->rx_skb_alloc_failed++;\n\t\t\t\tgoto reuse_rx;\n\t\t\t}\n\t\t\tmemcpy(skb->data, data + pad, len);\n\t\t\tbnx2x_reuse_rx_data(fp, bd_cons, bd_prod);\n\t\t} else {\n\t\t\tif (likely(bnx2x_alloc_rx_data(bp, fp, bd_prod,\n\t\t\t\t\t\t       GFP_ATOMIC) == 0)) {\n\t\t\t\tdma_unmap_single(&bp->pdev->dev,\n\t\t\t\t\t\t dma_unmap_addr(rx_buf, mapping),\n\t\t\t\t\t\t fp->rx_buf_size,\n\t\t\t\t\t\t DMA_FROM_DEVICE);\n\t\t\t\tskb = build_skb(data, fp->rx_frag_size);\n\t\t\t\tif (unlikely(!skb)) {\n\t\t\t\t\tbnx2x_frag_free(fp, data);\n\t\t\t\t\tbnx2x_fp_qstats(bp, fp)->\n\t\t\t\t\t\t\trx_skb_alloc_failed++;\n\t\t\t\t\tgoto next_rx;\n\t\t\t\t}\n\t\t\t\tskb_reserve(skb, pad);\n\t\t\t} else {\n\t\t\t\tDP(NETIF_MSG_RX_ERR | NETIF_MSG_RX_STATUS,\n\t\t\t\t   \"ERROR  packet dropped because of alloc failure\\n\");\n\t\t\t\tbnx2x_fp_qstats(bp, fp)->rx_skb_alloc_failed++;\nreuse_rx:\n\t\t\t\tbnx2x_reuse_rx_data(fp, bd_cons, bd_prod);\n\t\t\t\tgoto next_rx;\n\t\t\t}\n\t\t}\n\n\t\tskb_put(skb, len);\n\t\tskb->protocol = eth_type_trans(skb, bp->dev);\n\n\t\t/* Set Toeplitz hash for a none-LRO skb */\n\t\trxhash = bnx2x_get_rxhash(bp, cqe_fp, &rxhash_type);\n\t\tskb_set_hash(skb, rxhash, rxhash_type);\n\n\t\tskb_checksum_none_assert(skb);\n\n\t\tif (bp->dev->features & NETIF_F_RXCSUM)\n\t\t\tbnx2x_csum_validate(skb, cqe, fp,\n\t\t\t\t\t    bnx2x_fp_qstats(bp, fp));\n\n\t\tskb_record_rx_queue(skb, fp->rx_queue);\n\n\t\t/* Check if this packet was timestamped */\n\t\tif (unlikely(cqe->fast_path_cqe.type_error_flags &\n\t\t\t     (1 << ETH_FAST_PATH_RX_CQE_PTP_PKT_SHIFT)))\n\t\t\tbnx2x_set_rx_ts(bp, skb);\n\n\t\tif (le16_to_cpu(cqe_fp->pars_flags.flags) &\n\t\t    PARSING_FLAGS_VLAN)\n\t\t\t__vlan_hwaccel_put_tag(skb, htons(ETH_P_8021Q),\n\t\t\t\t\t       le16_to_cpu(cqe_fp->vlan_tag));\n\n\t\tnapi_gro_receive(&fp->napi, skb);\nnext_rx:\n\t\trx_buf->data = NULL;\n\n\t\tbd_cons = NEXT_RX_IDX(bd_cons);\n\t\tbd_prod = NEXT_RX_IDX(bd_prod);\n\t\tbd_prod_fw = NEXT_RX_IDX(bd_prod_fw);\n\t\trx_pkt++;\nnext_cqe:\n\t\tsw_comp_prod = NEXT_RCQ_IDX(sw_comp_prod);\n\t\tsw_comp_cons = NEXT_RCQ_IDX(sw_comp_cons);\n\n\t\t/* mark CQE as free */\n\t\tBNX2X_SEED_CQE(cqe_fp);\n\n\t\tif (rx_pkt == budget)\n\t\t\tbreak;\n\n\t\tcomp_ring_cons = RCQ_BD(sw_comp_cons);\n\t\tcqe = &fp->rx_comp_ring[comp_ring_cons];\n\t\tcqe_fp = &cqe->fast_path_cqe;\n\t} /* while */\n\n\tfp->rx_bd_cons = bd_cons;\n\tfp->rx_bd_prod = bd_prod_fw;\n\tfp->rx_comp_cons = sw_comp_cons;\n\tfp->rx_comp_prod = sw_comp_prod;\n\n\t/* Update producers */\n\tbnx2x_update_rx_prod(bp, fp, bd_prod_fw, sw_comp_prod,\n\t\t\t     fp->rx_sge_prod);\n\n\treturn rx_pkt;\n}\n\nstatic irqreturn_t bnx2x_msix_fp_int(int irq, void *fp_cookie)\n{\n\tstruct bnx2x_fastpath *fp = fp_cookie;\n\tstruct bnx2x *bp = fp->bp;\n\tu8 cos;\n\n\tDP(NETIF_MSG_INTR,\n\t   \"got an MSI-X interrupt on IDX:SB [fp %d fw_sd %d igusb %d]\\n\",\n\t   fp->index, fp->fw_sb_id, fp->igu_sb_id);\n\n\tbnx2x_ack_sb(bp, fp->igu_sb_id, USTORM_ID, 0, IGU_INT_DISABLE, 0);\n\n#ifdef BNX2X_STOP_ON_ERROR\n\tif (unlikely(bp->panic))\n\t\treturn IRQ_HANDLED;\n#endif\n\n\t/* Handle Rx and Tx according to MSI-X vector */\n\tfor_each_cos_in_tx_queue(fp, cos)\n\t\tprefetch(fp->txdata_ptr[cos]->tx_cons_sb);\n\n\tprefetch(&fp->sb_running_index[SM_RX_ID]);\n\tnapi_schedule_irqoff(&bnx2x_fp(bp, fp->index, napi));\n\n\treturn IRQ_HANDLED;\n}\n\n/* HW Lock for shared dual port PHYs */\nvoid bnx2x_acquire_phy_lock(struct bnx2x *bp)\n{\n\tmutex_lock(&bp->port.phy_mutex);\n\n\tbnx2x_acquire_hw_lock(bp, HW_LOCK_RESOURCE_MDIO);\n}\n\nvoid bnx2x_release_phy_lock(struct bnx2x *bp)\n{\n\tbnx2x_release_hw_lock(bp, HW_LOCK_RESOURCE_MDIO);\n\n\tmutex_unlock(&bp->port.phy_mutex);\n}\n\n/* calculates MF speed according to current linespeed and MF configuration */\nu16 bnx2x_get_mf_speed(struct bnx2x *bp)\n{\n\tu16 line_speed = bp->link_vars.line_speed;\n\tif (IS_MF(bp)) {\n\t\tu16 maxCfg = bnx2x_extract_max_cfg(bp,\n\t\t\t\t\t\t   bp->mf_config[BP_VN(bp)]);\n\n\t\t/* Calculate the current MAX line speed limit for the MF\n\t\t * devices\n\t\t */\n\t\tif (IS_MF_PERCENT_BW(bp))\n\t\t\tline_speed = (line_speed * maxCfg) / 100;\n\t\telse { /* SD mode */\n\t\t\tu16 vn_max_rate = maxCfg * 100;\n\n\t\t\tif (vn_max_rate < line_speed)\n\t\t\t\tline_speed = vn_max_rate;\n\t\t}\n\t}\n\n\treturn line_speed;\n}\n\n/**\n * bnx2x_fill_report_data - fill link report data to report\n *\n * @bp:\t\tdriver handle\n * @data:\tlink state to update\n *\n * It uses a none-atomic bit operations because is called under the mutex.\n */\nstatic void bnx2x_fill_report_data(struct bnx2x *bp,\n\t\t\t\t   struct bnx2x_link_report_data *data)\n{\n\tmemset(data, 0, sizeof(*data));\n\n\tif (IS_PF(bp)) {\n\t\t/* Fill the report data: effective line speed */\n\t\tdata->line_speed = bnx2x_get_mf_speed(bp);\n\n\t\t/* Link is down */\n\t\tif (!bp->link_vars.link_up || (bp->flags & MF_FUNC_DIS))\n\t\t\t__set_bit(BNX2X_LINK_REPORT_LINK_DOWN,\n\t\t\t\t  &data->link_report_flags);\n\n\t\tif (!BNX2X_NUM_ETH_QUEUES(bp))\n\t\t\t__set_bit(BNX2X_LINK_REPORT_LINK_DOWN,\n\t\t\t\t  &data->link_report_flags);\n\n\t\t/* Full DUPLEX */\n\t\tif (bp->link_vars.duplex == DUPLEX_FULL)\n\t\t\t__set_bit(BNX2X_LINK_REPORT_FD,\n\t\t\t\t  &data->link_report_flags);\n\n\t\t/* Rx Flow Control is ON */\n\t\tif (bp->link_vars.flow_ctrl & BNX2X_FLOW_CTRL_RX)\n\t\t\t__set_bit(BNX2X_LINK_REPORT_RX_FC_ON,\n\t\t\t\t  &data->link_report_flags);\n\n\t\t/* Tx Flow Control is ON */\n\t\tif (bp->link_vars.flow_ctrl & BNX2X_FLOW_CTRL_TX)\n\t\t\t__set_bit(BNX2X_LINK_REPORT_TX_FC_ON,\n\t\t\t\t  &data->link_report_flags);\n\t} else { /* VF */\n\t\t*data = bp->vf_link_vars;\n\t}\n}\n\n/**\n * bnx2x_link_report - report link status to OS.\n *\n * @bp:\t\tdriver handle\n *\n * Calls the __bnx2x_link_report() under the same locking scheme\n * as a link/PHY state managing code to ensure a consistent link\n * reporting.\n */\n\nvoid bnx2x_link_report(struct bnx2x *bp)\n{\n\tbnx2x_acquire_phy_lock(bp);\n\t__bnx2x_link_report(bp);\n\tbnx2x_release_phy_lock(bp);\n}\n\n/**\n * __bnx2x_link_report - report link status to OS.\n *\n * @bp:\t\tdriver handle\n *\n * None atomic implementation.\n * Should be called under the phy_lock.\n */\nvoid __bnx2x_link_report(struct bnx2x *bp)\n{\n\tstruct bnx2x_link_report_data cur_data;\n\n\tif (bp->force_link_down) {\n\t\tbp->link_vars.link_up = 0;\n\t\treturn;\n\t}\n\n\t/* reread mf_cfg */\n\tif (IS_PF(bp) && !CHIP_IS_E1(bp))\n\t\tbnx2x_read_mf_cfg(bp);\n\n\t/* Read the current link report info */\n\tbnx2x_fill_report_data(bp, &cur_data);\n\n\t/* Don't report link down or exactly the same link status twice */\n\tif (!memcmp(&cur_data, &bp->last_reported_link, sizeof(cur_data)) ||\n\t    (test_bit(BNX2X_LINK_REPORT_LINK_DOWN,\n\t\t      &bp->last_reported_link.link_report_flags) &&\n\t     test_bit(BNX2X_LINK_REPORT_LINK_DOWN,\n\t\t      &cur_data.link_report_flags)))\n\t\treturn;\n\n\tbp->link_cnt++;\n\n\t/* We are going to report a new link parameters now -\n\t * remember the current data for the next time.\n\t */\n\tmemcpy(&bp->last_reported_link, &cur_data, sizeof(cur_data));\n\n\t/* propagate status to VFs */\n\tif (IS_PF(bp))\n\t\tbnx2x_iov_link_update(bp);\n\n\tif (test_bit(BNX2X_LINK_REPORT_LINK_DOWN,\n\t\t     &cur_data.link_report_flags)) {\n\t\tnetif_carrier_off(bp->dev);\n\t\tnetdev_err(bp->dev, \"NIC Link is Down\\n\");\n\t\treturn;\n\t} else {\n\t\tconst char *duplex;\n\t\tconst char *flow;\n\n\t\tnetif_carrier_on(bp->dev);\n\n\t\tif (test_and_clear_bit(BNX2X_LINK_REPORT_FD,\n\t\t\t\t       &cur_data.link_report_flags))\n\t\t\tduplex = \"full\";\n\t\telse\n\t\t\tduplex = \"half\";\n\n\t\t/* Handle the FC at the end so that only these flags would be\n\t\t * possibly set. This way we may easily check if there is no FC\n\t\t * enabled.\n\t\t */\n\t\tif (cur_data.link_report_flags) {\n\t\t\tif (test_bit(BNX2X_LINK_REPORT_RX_FC_ON,\n\t\t\t\t     &cur_data.link_report_flags)) {\n\t\t\t\tif (test_bit(BNX2X_LINK_REPORT_TX_FC_ON,\n\t\t\t\t     &cur_data.link_report_flags))\n\t\t\t\t\tflow = \"ON - receive & transmit\";\n\t\t\t\telse\n\t\t\t\t\tflow = \"ON - receive\";\n\t\t\t} else {\n\t\t\t\tflow = \"ON - transmit\";\n\t\t\t}\n\t\t} else {\n\t\t\tflow = \"none\";\n\t\t}\n\t\tnetdev_info(bp->dev, \"NIC Link is Up, %d Mbps %s duplex, Flow control: %s\\n\",\n\t\t\t    cur_data.line_speed, duplex, flow);\n\t}\n}\n\nstatic void bnx2x_set_next_page_sgl(struct bnx2x_fastpath *fp)\n{\n\tint i;\n\n\tfor (i = 1; i <= NUM_RX_SGE_PAGES; i++) {\n\t\tstruct eth_rx_sge *sge;\n\n\t\tsge = &fp->rx_sge_ring[RX_SGE_CNT * i - 2];\n\t\tsge->addr_hi =\n\t\t\tcpu_to_le32(U64_HI(fp->rx_sge_mapping +\n\t\t\tBCM_PAGE_SIZE*(i % NUM_RX_SGE_PAGES)));\n\n\t\tsge->addr_lo =\n\t\t\tcpu_to_le32(U64_LO(fp->rx_sge_mapping +\n\t\t\tBCM_PAGE_SIZE*(i % NUM_RX_SGE_PAGES)));\n\t}\n}\n\nstatic void bnx2x_free_tpa_pool(struct bnx2x *bp,\n\t\t\t\tstruct bnx2x_fastpath *fp, int last)\n{\n\tint i;\n\n\tfor (i = 0; i < last; i++) {\n\t\tstruct bnx2x_agg_info *tpa_info = &fp->tpa_info[i];\n\t\tstruct sw_rx_bd *first_buf = &tpa_info->first_buf;\n\t\tu8 *data = first_buf->data;\n\n\t\tif (data == NULL) {\n\t\t\tDP(NETIF_MSG_IFDOWN, \"tpa bin %d empty on free\\n\", i);\n\t\t\tcontinue;\n\t\t}\n\t\tif (tpa_info->tpa_state == BNX2X_TPA_START)\n\t\t\tdma_unmap_single(&bp->pdev->dev,\n\t\t\t\t\t dma_unmap_addr(first_buf, mapping),\n\t\t\t\t\t fp->rx_buf_size, DMA_FROM_DEVICE);\n\t\tbnx2x_frag_free(fp, data);\n\t\tfirst_buf->data = NULL;\n\t}\n}\n\nvoid bnx2x_init_rx_rings_cnic(struct bnx2x *bp)\n{\n\tint j;\n\n\tfor_each_rx_queue_cnic(bp, j) {\n\t\tstruct bnx2x_fastpath *fp = &bp->fp[j];\n\n\t\tfp->rx_bd_cons = 0;\n\n\t\t/* Activate BD ring */\n\t\t/* Warning!\n\t\t * this will generate an interrupt (to the TSTORM)\n\t\t * must only be done after chip is initialized\n\t\t */\n\t\tbnx2x_update_rx_prod(bp, fp, fp->rx_bd_prod, fp->rx_comp_prod,\n\t\t\t\t     fp->rx_sge_prod);\n\t}\n}\n\nvoid bnx2x_init_rx_rings(struct bnx2x *bp)\n{\n\tint func = BP_FUNC(bp);\n\tu16 ring_prod;\n\tint i, j;\n\n\t/* Allocate TPA resources */\n\tfor_each_eth_queue(bp, j) {\n\t\tstruct bnx2x_fastpath *fp = &bp->fp[j];\n\n\t\tDP(NETIF_MSG_IFUP,\n\t\t   \"mtu %d  rx_buf_size %d\\n\", bp->dev->mtu, fp->rx_buf_size);\n\n\t\tif (fp->mode != TPA_MODE_DISABLED) {\n\t\t\t/* Fill the per-aggregation pool */\n\t\t\tfor (i = 0; i < MAX_AGG_QS(bp); i++) {\n\t\t\t\tstruct bnx2x_agg_info *tpa_info =\n\t\t\t\t\t&fp->tpa_info[i];\n\t\t\t\tstruct sw_rx_bd *first_buf =\n\t\t\t\t\t&tpa_info->first_buf;\n\n\t\t\t\tfirst_buf->data =\n\t\t\t\t\tbnx2x_frag_alloc(fp, GFP_KERNEL);\n\t\t\t\tif (!first_buf->data) {\n\t\t\t\t\tBNX2X_ERR(\"Failed to allocate TPA skb pool for queue[%d] - disabling TPA on this queue!\\n\",\n\t\t\t\t\t\t  j);\n\t\t\t\t\tbnx2x_free_tpa_pool(bp, fp, i);\n\t\t\t\t\tfp->mode = TPA_MODE_DISABLED;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tdma_unmap_addr_set(first_buf, mapping, 0);\n\t\t\t\ttpa_info->tpa_state = BNX2X_TPA_STOP;\n\t\t\t}\n\n\t\t\t/* \"next page\" elements initialization */\n\t\t\tbnx2x_set_next_page_sgl(fp);\n\n\t\t\t/* set SGEs bit mask */\n\t\t\tbnx2x_init_sge_ring_bit_mask(fp);\n\n\t\t\t/* Allocate SGEs and initialize the ring elements */\n\t\t\tfor (i = 0, ring_prod = 0;\n\t\t\t     i < MAX_RX_SGE_CNT*NUM_RX_SGE_PAGES; i++) {\n\n\t\t\t\tif (bnx2x_alloc_rx_sge(bp, fp, ring_prod,\n\t\t\t\t\t\t       GFP_KERNEL) < 0) {\n\t\t\t\t\tBNX2X_ERR(\"was only able to allocate %d rx sges\\n\",\n\t\t\t\t\t\t  i);\n\t\t\t\t\tBNX2X_ERR(\"disabling TPA for queue[%d]\\n\",\n\t\t\t\t\t\t  j);\n\t\t\t\t\t/* Cleanup already allocated elements */\n\t\t\t\t\tbnx2x_free_rx_sge_range(bp, fp,\n\t\t\t\t\t\t\t\tring_prod);\n\t\t\t\t\tbnx2x_free_tpa_pool(bp, fp,\n\t\t\t\t\t\t\t    MAX_AGG_QS(bp));\n\t\t\t\t\tfp->mode = TPA_MODE_DISABLED;\n\t\t\t\t\tring_prod = 0;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tring_prod = NEXT_SGE_IDX(ring_prod);\n\t\t\t}\n\n\t\t\tfp->rx_sge_prod = ring_prod;\n\t\t}\n\t}\n\n\tfor_each_eth_queue(bp, j) {\n\t\tstruct bnx2x_fastpath *fp = &bp->fp[j];\n\n\t\tfp->rx_bd_cons = 0;\n\n\t\t/* Activate BD ring */\n\t\t/* Warning!\n\t\t * this will generate an interrupt (to the TSTORM)\n\t\t * must only be done after chip is initialized\n\t\t */\n\t\tbnx2x_update_rx_prod(bp, fp, fp->rx_bd_prod, fp->rx_comp_prod,\n\t\t\t\t     fp->rx_sge_prod);\n\n\t\tif (j != 0)\n\t\t\tcontinue;\n\n\t\tif (CHIP_IS_E1(bp)) {\n\t\t\tREG_WR(bp, BAR_USTRORM_INTMEM +\n\t\t\t       USTORM_MEM_WORKAROUND_ADDRESS_OFFSET(func),\n\t\t\t       U64_LO(fp->rx_comp_mapping));\n\t\t\tREG_WR(bp, BAR_USTRORM_INTMEM +\n\t\t\t       USTORM_MEM_WORKAROUND_ADDRESS_OFFSET(func) + 4,\n\t\t\t       U64_HI(fp->rx_comp_mapping));\n\t\t}\n\t}\n}\n\nstatic void bnx2x_free_tx_skbs_queue(struct bnx2x_fastpath *fp)\n{\n\tu8 cos;\n\tstruct bnx2x *bp = fp->bp;\n\n\tfor_each_cos_in_tx_queue(fp, cos) {\n\t\tstruct bnx2x_fp_txdata *txdata = fp->txdata_ptr[cos];\n\t\tunsigned pkts_compl = 0, bytes_compl = 0;\n\n\t\tu16 sw_prod = txdata->tx_pkt_prod;\n\t\tu16 sw_cons = txdata->tx_pkt_cons;\n\n\t\twhile (sw_cons != sw_prod) {\n\t\t\tbnx2x_free_tx_pkt(bp, txdata, TX_BD(sw_cons),\n\t\t\t\t\t  &pkts_compl, &bytes_compl);\n\t\t\tsw_cons++;\n\t\t}\n\n\t\tnetdev_tx_reset_queue(\n\t\t\tnetdev_get_tx_queue(bp->dev,\n\t\t\t\t\t    txdata->txq_index));\n\t}\n}\n\nstatic void bnx2x_free_tx_skbs_cnic(struct bnx2x *bp)\n{\n\tint i;\n\n\tfor_each_tx_queue_cnic(bp, i) {\n\t\tbnx2x_free_tx_skbs_queue(&bp->fp[i]);\n\t}\n}\n\nstatic void bnx2x_free_tx_skbs(struct bnx2x *bp)\n{\n\tint i;\n\n\tfor_each_eth_queue(bp, i) {\n\t\tbnx2x_free_tx_skbs_queue(&bp->fp[i]);\n\t}\n}\n\nstatic void bnx2x_free_rx_bds(struct bnx2x_fastpath *fp)\n{\n\tstruct bnx2x *bp = fp->bp;\n\tint i;\n\n\t/* ring wasn't allocated */\n\tif (fp->rx_buf_ring == NULL)\n\t\treturn;\n\n\tfor (i = 0; i < NUM_RX_BD; i++) {\n\t\tstruct sw_rx_bd *rx_buf = &fp->rx_buf_ring[i];\n\t\tu8 *data = rx_buf->data;\n\n\t\tif (data == NULL)\n\t\t\tcontinue;\n\t\tdma_unmap_single(&bp->pdev->dev,\n\t\t\t\t dma_unmap_addr(rx_buf, mapping),\n\t\t\t\t fp->rx_buf_size, DMA_FROM_DEVICE);\n\n\t\trx_buf->data = NULL;\n\t\tbnx2x_frag_free(fp, data);\n\t}\n}\n\nstatic void bnx2x_free_rx_skbs_cnic(struct bnx2x *bp)\n{\n\tint j;\n\n\tfor_each_rx_queue_cnic(bp, j) {\n\t\tbnx2x_free_rx_bds(&bp->fp[j]);\n\t}\n}\n\nstatic void bnx2x_free_rx_skbs(struct bnx2x *bp)\n{\n\tint j;\n\n\tfor_each_eth_queue(bp, j) {\n\t\tstruct bnx2x_fastpath *fp = &bp->fp[j];\n\n\t\tbnx2x_free_rx_bds(fp);\n\n\t\tif (fp->mode != TPA_MODE_DISABLED)\n\t\t\tbnx2x_free_tpa_pool(bp, fp, MAX_AGG_QS(bp));\n\t}\n}\n\nstatic void bnx2x_free_skbs_cnic(struct bnx2x *bp)\n{\n\tbnx2x_free_tx_skbs_cnic(bp);\n\tbnx2x_free_rx_skbs_cnic(bp);\n}\n\nvoid bnx2x_free_skbs(struct bnx2x *bp)\n{\n\tbnx2x_free_tx_skbs(bp);\n\tbnx2x_free_rx_skbs(bp);\n}\n\nvoid bnx2x_update_max_mf_config(struct bnx2x *bp, u32 value)\n{\n\t/* load old values */\n\tu32 mf_cfg = bp->mf_config[BP_VN(bp)];\n\n\tif (value != bnx2x_extract_max_cfg(bp, mf_cfg)) {\n\t\t/* leave all but MAX value */\n\t\tmf_cfg &= ~FUNC_MF_CFG_MAX_BW_MASK;\n\n\t\t/* set new MAX value */\n\t\tmf_cfg |= (value << FUNC_MF_CFG_MAX_BW_SHIFT)\n\t\t\t\t& FUNC_MF_CFG_MAX_BW_MASK;\n\n\t\tbnx2x_fw_command(bp, DRV_MSG_CODE_SET_MF_BW, mf_cfg);\n\t}\n}\n\n/**\n * bnx2x_free_msix_irqs - free previously requested MSI-X IRQ vectors\n *\n * @bp:\t\tdriver handle\n * @nvecs:\tnumber of vectors to be released\n */\nstatic void bnx2x_free_msix_irqs(struct bnx2x *bp, int nvecs)\n{\n\tint i, offset = 0;\n\n\tif (nvecs == offset)\n\t\treturn;\n\n\t/* VFs don't have a default SB */\n\tif (IS_PF(bp)) {\n\t\tfree_irq(bp->msix_table[offset].vector, bp->dev);\n\t\tDP(NETIF_MSG_IFDOWN, \"released sp irq (%d)\\n\",\n\t\t   bp->msix_table[offset].vector);\n\t\toffset++;\n\t}\n\n\tif (CNIC_SUPPORT(bp)) {\n\t\tif (nvecs == offset)\n\t\t\treturn;\n\t\toffset++;\n\t}\n\n\tfor_each_eth_queue(bp, i) {\n\t\tif (nvecs == offset)\n\t\t\treturn;\n\t\tDP(NETIF_MSG_IFDOWN, \"about to release fp #%d->%d irq\\n\",\n\t\t   i, bp->msix_table[offset].vector);\n\n\t\tfree_irq(bp->msix_table[offset++].vector, &bp->fp[i]);\n\t}\n}\n\nvoid bnx2x_free_irq(struct bnx2x *bp)\n{\n\tif (bp->flags & USING_MSIX_FLAG &&\n\t    !(bp->flags & USING_SINGLE_MSIX_FLAG)) {\n\t\tint nvecs = BNX2X_NUM_ETH_QUEUES(bp) + CNIC_SUPPORT(bp);\n\n\t\t/* vfs don't have a default status block */\n\t\tif (IS_PF(bp))\n\t\t\tnvecs++;\n\n\t\tbnx2x_free_msix_irqs(bp, nvecs);\n\t} else {\n\t\tfree_irq(bp->dev->irq, bp->dev);\n\t}\n}\n\nint bnx2x_enable_msix(struct bnx2x *bp)\n{\n\tint msix_vec = 0, i, rc;\n\n\t/* VFs don't have a default status block */\n\tif (IS_PF(bp)) {\n\t\tbp->msix_table[msix_vec].entry = msix_vec;\n\t\tBNX2X_DEV_INFO(\"msix_table[0].entry = %d (slowpath)\\n\",\n\t\t\t       bp->msix_table[0].entry);\n\t\tmsix_vec++;\n\t}\n\n\t/* Cnic requires an msix vector for itself */\n\tif (CNIC_SUPPORT(bp)) {\n\t\tbp->msix_table[msix_vec].entry = msix_vec;\n\t\tBNX2X_DEV_INFO(\"msix_table[%d].entry = %d (CNIC)\\n\",\n\t\t\t       msix_vec, bp->msix_table[msix_vec].entry);\n\t\tmsix_vec++;\n\t}\n\n\t/* We need separate vectors for ETH queues only (not FCoE) */\n\tfor_each_eth_queue(bp, i) {\n\t\tbp->msix_table[msix_vec].entry = msix_vec;\n\t\tBNX2X_DEV_INFO(\"msix_table[%d].entry = %d (fastpath #%u)\\n\",\n\t\t\t       msix_vec, msix_vec, i);\n\t\tmsix_vec++;\n\t}\n\n\tDP(BNX2X_MSG_SP, \"about to request enable msix with %d vectors\\n\",\n\t   msix_vec);\n\n\trc = pci_enable_msix_range(bp->pdev, &bp->msix_table[0],\n\t\t\t\t   BNX2X_MIN_MSIX_VEC_CNT(bp), msix_vec);\n\t/*\n\t * reconfigure number of tx/rx queues according to available\n\t * MSI-X vectors\n\t */\n\tif (rc == -ENOSPC) {\n\t\t/* Get by with single vector */\n\t\trc = pci_enable_msix_range(bp->pdev, &bp->msix_table[0], 1, 1);\n\t\tif (rc < 0) {\n\t\t\tBNX2X_DEV_INFO(\"Single MSI-X is not attainable rc %d\\n\",\n\t\t\t\t       rc);\n\t\t\tgoto no_msix;\n\t\t}\n\n\t\tBNX2X_DEV_INFO(\"Using single MSI-X vector\\n\");\n\t\tbp->flags |= USING_SINGLE_MSIX_FLAG;\n\n\t\tBNX2X_DEV_INFO(\"set number of queues to 1\\n\");\n\t\tbp->num_ethernet_queues = 1;\n\t\tbp->num_queues = bp->num_ethernet_queues + bp->num_cnic_queues;\n\t} else if (rc < 0) {\n\t\tBNX2X_DEV_INFO(\"MSI-X is not attainable rc %d\\n\", rc);\n\t\tgoto no_msix;\n\t} else if (rc < msix_vec) {\n\t\t/* how less vectors we will have? */\n\t\tint diff = msix_vec - rc;\n\n\t\tBNX2X_DEV_INFO(\"Trying to use less MSI-X vectors: %d\\n\", rc);\n\n\t\t/*\n\t\t * decrease number of queues by number of unallocated entries\n\t\t */\n\t\tbp->num_ethernet_queues -= diff;\n\t\tbp->num_queues = bp->num_ethernet_queues + bp->num_cnic_queues;\n\n\t\tBNX2X_DEV_INFO(\"New queue configuration set: %d\\n\",\n\t\t\t       bp->num_queues);\n\t}\n\n\tbp->flags |= USING_MSIX_FLAG;\n\n\treturn 0;\n\nno_msix:\n\t/* fall to INTx if not enough memory */\n\tif (rc == -ENOMEM)\n\t\tbp->flags |= DISABLE_MSI_FLAG;\n\n\treturn rc;\n}\n\nstatic int bnx2x_req_msix_irqs(struct bnx2x *bp)\n{\n\tint i, rc, offset = 0;\n\n\t/* no default status block for vf */\n\tif (IS_PF(bp)) {\n\t\trc = request_irq(bp->msix_table[offset++].vector,\n\t\t\t\t bnx2x_msix_sp_int, 0,\n\t\t\t\t bp->dev->name, bp->dev);\n\t\tif (rc) {\n\t\t\tBNX2X_ERR(\"request sp irq failed\\n\");\n\t\t\treturn -EBUSY;\n\t\t}\n\t}\n\n\tif (CNIC_SUPPORT(bp))\n\t\toffset++;\n\n\tfor_each_eth_queue(bp, i) {\n\t\tstruct bnx2x_fastpath *fp = &bp->fp[i];\n\t\tsnprintf(fp->name, sizeof(fp->name), \"%s-fp-%d\",\n\t\t\t bp->dev->name, i);\n\n\t\trc = request_irq(bp->msix_table[offset].vector,\n\t\t\t\t bnx2x_msix_fp_int, 0, fp->name, fp);\n\t\tif (rc) {\n\t\t\tBNX2X_ERR(\"request fp #%d irq (%d) failed  rc %d\\n\", i,\n\t\t\t      bp->msix_table[offset].vector, rc);\n\t\t\tbnx2x_free_msix_irqs(bp, offset);\n\t\t\treturn -EBUSY;\n\t\t}\n\n\t\toffset++;\n\t}\n\n\ti = BNX2X_NUM_ETH_QUEUES(bp);\n\tif (IS_PF(bp)) {\n\t\toffset = 1 + CNIC_SUPPORT(bp);\n\t\tnetdev_info(bp->dev,\n\t\t\t    \"using MSI-X  IRQs: sp %d  fp[%d] %d ... fp[%d] %d\\n\",\n\t\t\t    bp->msix_table[0].vector,\n\t\t\t    0, bp->msix_table[offset].vector,\n\t\t\t    i - 1, bp->msix_table[offset + i - 1].vector);\n\t} else {\n\t\toffset = CNIC_SUPPORT(bp);\n\t\tnetdev_info(bp->dev,\n\t\t\t    \"using MSI-X  IRQs: fp[%d] %d ... fp[%d] %d\\n\",\n\t\t\t    0, bp->msix_table[offset].vector,\n\t\t\t    i - 1, bp->msix_table[offset + i - 1].vector);\n\t}\n\treturn 0;\n}\n\nint bnx2x_enable_msi(struct bnx2x *bp)\n{\n\tint rc;\n\n\trc = pci_enable_msi(bp->pdev);\n\tif (rc) {\n\t\tBNX2X_DEV_INFO(\"MSI is not attainable\\n\");\n\t\treturn -1;\n\t}\n\tbp->flags |= USING_MSI_FLAG;\n\n\treturn 0;\n}\n\nstatic int bnx2x_req_irq(struct bnx2x *bp)\n{\n\tunsigned long flags;\n\tunsigned int irq;\n\n\tif (bp->flags & (USING_MSI_FLAG | USING_MSIX_FLAG))\n\t\tflags = 0;\n\telse\n\t\tflags = IRQF_SHARED;\n\n\tif (bp->flags & USING_MSIX_FLAG)\n\t\tirq = bp->msix_table[0].vector;\n\telse\n\t\tirq = bp->pdev->irq;\n\n\treturn request_irq(irq, bnx2x_interrupt, flags, bp->dev->name, bp->dev);\n}\n\nstatic int bnx2x_setup_irqs(struct bnx2x *bp)\n{\n\tint rc = 0;\n\tif (bp->flags & USING_MSIX_FLAG &&\n\t    !(bp->flags & USING_SINGLE_MSIX_FLAG)) {\n\t\trc = bnx2x_req_msix_irqs(bp);\n\t\tif (rc)\n\t\t\treturn rc;\n\t} else {\n\t\trc = bnx2x_req_irq(bp);\n\t\tif (rc) {\n\t\t\tBNX2X_ERR(\"IRQ request failed  rc %d, aborting\\n\", rc);\n\t\t\treturn rc;\n\t\t}\n\t\tif (bp->flags & USING_MSI_FLAG) {\n\t\t\tbp->dev->irq = bp->pdev->irq;\n\t\t\tnetdev_info(bp->dev, \"using MSI IRQ %d\\n\",\n\t\t\t\t    bp->dev->irq);\n\t\t}\n\t\tif (bp->flags & USING_MSIX_FLAG) {\n\t\t\tbp->dev->irq = bp->msix_table[0].vector;\n\t\t\tnetdev_info(bp->dev, \"using MSIX IRQ %d\\n\",\n\t\t\t\t    bp->dev->irq);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic void bnx2x_napi_enable_cnic(struct bnx2x *bp)\n{\n\tint i;\n\n\tfor_each_rx_queue_cnic(bp, i) {\n\t\tnapi_enable(&bnx2x_fp(bp, i, napi));\n\t}\n}\n\nstatic void bnx2x_napi_enable(struct bnx2x *bp)\n{\n\tint i;\n\n\tfor_each_eth_queue(bp, i) {\n\t\tnapi_enable(&bnx2x_fp(bp, i, napi));\n\t}\n}\n\nstatic void bnx2x_napi_disable_cnic(struct bnx2x *bp)\n{\n\tint i;\n\n\tfor_each_rx_queue_cnic(bp, i) {\n\t\tnapi_disable(&bnx2x_fp(bp, i, napi));\n\t}\n}\n\nstatic void bnx2x_napi_disable(struct bnx2x *bp)\n{\n\tint i;\n\n\tfor_each_eth_queue(bp, i) {\n\t\tnapi_disable(&bnx2x_fp(bp, i, napi));\n\t}\n}\n\nvoid bnx2x_netif_start(struct bnx2x *bp)\n{\n\tif (netif_running(bp->dev)) {\n\t\tbnx2x_napi_enable(bp);\n\t\tif (CNIC_LOADED(bp))\n\t\t\tbnx2x_napi_enable_cnic(bp);\n\t\tbnx2x_int_enable(bp);\n\t\tif (bp->state == BNX2X_STATE_OPEN)\n\t\t\tnetif_tx_wake_all_queues(bp->dev);\n\t}\n}\n\nvoid bnx2x_netif_stop(struct bnx2x *bp, int disable_hw)\n{\n\tbnx2x_int_disable_sync(bp, disable_hw);\n\tbnx2x_napi_disable(bp);\n\tif (CNIC_LOADED(bp))\n\t\tbnx2x_napi_disable_cnic(bp);\n}\n\nu16 bnx2x_select_queue(struct net_device *dev, struct sk_buff *skb,\n\t\t       struct net_device *sb_dev)\n{\n\tstruct bnx2x *bp = netdev_priv(dev);\n\n\tif (CNIC_LOADED(bp) && !NO_FCOE(bp)) {\n\t\tstruct ethhdr *hdr = (struct ethhdr *)skb->data;\n\t\tu16 ether_type = ntohs(hdr->h_proto);\n\n\t\t/* Skip VLAN tag if present */\n\t\tif (ether_type == ETH_P_8021Q) {\n\t\t\tstruct vlan_ethhdr *vhdr =\n\t\t\t\t(struct vlan_ethhdr *)skb->data;\n\n\t\t\tether_type = ntohs(vhdr->h_vlan_encapsulated_proto);\n\t\t}\n\n\t\t/* If ethertype is FCoE or FIP - use FCoE ring */\n\t\tif ((ether_type == ETH_P_FCOE) || (ether_type == ETH_P_FIP))\n\t\t\treturn bnx2x_fcoe_tx(bp, txq_index);\n\t}\n\n\t/* select a non-FCoE queue */\n\treturn netdev_pick_tx(dev, skb, NULL) %\n\t\t\t(BNX2X_NUM_ETH_QUEUES(bp) * bp->max_cos);\n}\n\nvoid bnx2x_set_num_queues(struct bnx2x *bp)\n{\n\t/* RSS queues */\n\tbp->num_ethernet_queues = bnx2x_calc_num_queues(bp);\n\n\t/* override in STORAGE SD modes */\n\tif (IS_MF_STORAGE_ONLY(bp))\n\t\tbp->num_ethernet_queues = 1;\n\n\t/* Add special queues */\n\tbp->num_cnic_queues = CNIC_SUPPORT(bp); /* For FCOE */\n\tbp->num_queues = bp->num_ethernet_queues + bp->num_cnic_queues;\n\n\tBNX2X_DEV_INFO(\"set number of queues to %d\\n\", bp->num_queues);\n}\n\n/**\n * bnx2x_set_real_num_queues - configure netdev->real_num_[tx,rx]_queues\n *\n * @bp:\t\tDriver handle\n * @include_cnic: handle cnic case\n *\n * We currently support for at most 16 Tx queues for each CoS thus we will\n * allocate a multiple of 16 for ETH L2 rings according to the value of the\n * bp->max_cos.\n *\n * If there is an FCoE L2 queue the appropriate Tx queue will have the next\n * index after all ETH L2 indices.\n *\n * If the actual number of Tx queues (for each CoS) is less than 16 then there\n * will be the holes at the end of each group of 16 ETh L2 indices (0..15,\n * 16..31,...) with indices that are not coupled with any real Tx queue.\n *\n * The proper configuration of skb->queue_mapping is handled by\n * bnx2x_select_queue() and __skb_tx_hash().\n *\n * bnx2x_setup_tc() takes care of the proper TC mappings so that __skb_tx_hash()\n * will return a proper Tx index if TC is enabled (netdev->num_tc > 0).\n */\nstatic int bnx2x_set_real_num_queues(struct bnx2x *bp, int include_cnic)\n{\n\tint rc, tx, rx;\n\n\ttx = BNX2X_NUM_ETH_QUEUES(bp) * bp->max_cos;\n\trx = BNX2X_NUM_ETH_QUEUES(bp);\n\n/* account for fcoe queue */\n\tif (include_cnic && !NO_FCOE(bp)) {\n\t\trx++;\n\t\ttx++;\n\t}\n\n\trc = netif_set_real_num_tx_queues(bp->dev, tx);\n\tif (rc) {\n\t\tBNX2X_ERR(\"Failed to set real number of Tx queues: %d\\n\", rc);\n\t\treturn rc;\n\t}\n\trc = netif_set_real_num_rx_queues(bp->dev, rx);\n\tif (rc) {\n\t\tBNX2X_ERR(\"Failed to set real number of Rx queues: %d\\n\", rc);\n\t\treturn rc;\n\t}\n\n\tDP(NETIF_MSG_IFUP, \"Setting real num queues to (tx, rx) (%d, %d)\\n\",\n\t\t\t  tx, rx);\n\n\treturn rc;\n}\n\nstatic void bnx2x_set_rx_buf_size(struct bnx2x *bp)\n{\n\tint i;\n\n\tfor_each_queue(bp, i) {\n\t\tstruct bnx2x_fastpath *fp = &bp->fp[i];\n\t\tu32 mtu;\n\n\t\t/* Always use a mini-jumbo MTU for the FCoE L2 ring */\n\t\tif (IS_FCOE_IDX(i))\n\t\t\t/*\n\t\t\t * Although there are no IP frames expected to arrive to\n\t\t\t * this ring we still want to add an\n\t\t\t * IP_HEADER_ALIGNMENT_PADDING to prevent a buffer\n\t\t\t * overrun attack.\n\t\t\t */\n\t\t\tmtu = BNX2X_FCOE_MINI_JUMBO_MTU;\n\t\telse\n\t\t\tmtu = bp->dev->mtu;\n\t\tfp->rx_buf_size = BNX2X_FW_RX_ALIGN_START +\n\t\t\t\t  IP_HEADER_ALIGNMENT_PADDING +\n\t\t\t\t  ETH_OVERHEAD +\n\t\t\t\t  mtu +\n\t\t\t\t  BNX2X_FW_RX_ALIGN_END;\n\t\tfp->rx_buf_size = SKB_DATA_ALIGN(fp->rx_buf_size);\n\t\t/* Note : rx_buf_size doesn't take into account NET_SKB_PAD */\n\t\tif (fp->rx_buf_size + NET_SKB_PAD <= PAGE_SIZE)\n\t\t\tfp->rx_frag_size = fp->rx_buf_size + NET_SKB_PAD;\n\t\telse\n\t\t\tfp->rx_frag_size = 0;\n\t}\n}\n\nstatic int bnx2x_init_rss(struct bnx2x *bp)\n{\n\tint i;\n\tu8 num_eth_queues = BNX2X_NUM_ETH_QUEUES(bp);\n\n\t/* Prepare the initial contents for the indirection table if RSS is\n\t * enabled\n\t */\n\tfor (i = 0; i < sizeof(bp->rss_conf_obj.ind_table); i++)\n\t\tbp->rss_conf_obj.ind_table[i] =\n\t\t\tbp->fp->cl_id +\n\t\t\tethtool_rxfh_indir_default(i, num_eth_queues);\n\n\t/*\n\t * For 57710 and 57711 SEARCHER configuration (rss_keys) is\n\t * per-port, so if explicit configuration is needed , do it only\n\t * for a PMF.\n\t *\n\t * For 57712 and newer on the other hand it's a per-function\n\t * configuration.\n\t */\n\treturn bnx2x_config_rss_eth(bp, bp->port.pmf || !CHIP_IS_E1x(bp));\n}\n\nint bnx2x_rss(struct bnx2x *bp, struct bnx2x_rss_config_obj *rss_obj,\n\t      bool config_hash, bool enable)\n{\n\tstruct bnx2x_config_rss_params params = {NULL};\n\n\t/* Although RSS is meaningless when there is a single HW queue we\n\t * still need it enabled in order to have HW Rx hash generated.\n\t *\n\t * if (!is_eth_multi(bp))\n\t *      bp->multi_mode = ETH_RSS_MODE_DISABLED;\n\t */\n\n\tparams.rss_obj = rss_obj;\n\n\t__set_bit(RAMROD_COMP_WAIT, &params.ramrod_flags);\n\n\tif (enable) {\n\t\t__set_bit(BNX2X_RSS_MODE_REGULAR, &params.rss_flags);\n\n\t\t/* RSS configuration */\n\t\t__set_bit(BNX2X_RSS_IPV4, &params.rss_flags);\n\t\t__set_bit(BNX2X_RSS_IPV4_TCP, &params.rss_flags);\n\t\t__set_bit(BNX2X_RSS_IPV6, &params.rss_flags);\n\t\t__set_bit(BNX2X_RSS_IPV6_TCP, &params.rss_flags);\n\t\tif (rss_obj->udp_rss_v4)\n\t\t\t__set_bit(BNX2X_RSS_IPV4_UDP, &params.rss_flags);\n\t\tif (rss_obj->udp_rss_v6)\n\t\t\t__set_bit(BNX2X_RSS_IPV6_UDP, &params.rss_flags);\n\n\t\tif (!CHIP_IS_E1x(bp)) {\n\t\t\t/* valid only for TUNN_MODE_VXLAN tunnel mode */\n\t\t\t__set_bit(BNX2X_RSS_IPV4_VXLAN, &params.rss_flags);\n\t\t\t__set_bit(BNX2X_RSS_IPV6_VXLAN, &params.rss_flags);\n\n\t\t\t/* valid only for TUNN_MODE_GRE tunnel mode */\n\t\t\t__set_bit(BNX2X_RSS_TUNN_INNER_HDRS, &params.rss_flags);\n\t\t}\n\t} else {\n\t\t__set_bit(BNX2X_RSS_MODE_DISABLED, &params.rss_flags);\n\t}\n\n\t/* Hash bits */\n\tparams.rss_result_mask = MULTI_MASK;\n\n\tmemcpy(params.ind_table, rss_obj->ind_table, sizeof(params.ind_table));\n\n\tif (config_hash) {\n\t\t/* RSS keys */\n\t\tnetdev_rss_key_fill(params.rss_key, T_ETH_RSS_KEY * 4);\n\t\t__set_bit(BNX2X_RSS_SET_SRCH, &params.rss_flags);\n\t}\n\n\tif (IS_PF(bp))\n\t\treturn bnx2x_config_rss(bp, &params);\n\telse\n\t\treturn bnx2x_vfpf_config_rss(bp, &params);\n}\n\nstatic int bnx2x_init_hw(struct bnx2x *bp, u32 load_code)\n{\n\tstruct bnx2x_func_state_params func_params = {NULL};\n\n\t/* Prepare parameters for function state transitions */\n\t__set_bit(RAMROD_COMP_WAIT, &func_params.ramrod_flags);\n\n\tfunc_params.f_obj = &bp->func_obj;\n\tfunc_params.cmd = BNX2X_F_CMD_HW_INIT;\n\n\tfunc_params.params.hw_init.load_phase = load_code;\n\n\treturn bnx2x_func_state_change(bp, &func_params);\n}\n\n/*\n * Cleans the object that have internal lists without sending\n * ramrods. Should be run when interrupts are disabled.\n */\nvoid bnx2x_squeeze_objects(struct bnx2x *bp)\n{\n\tint rc;\n\tunsigned long ramrod_flags = 0, vlan_mac_flags = 0;\n\tstruct bnx2x_mcast_ramrod_params rparam = {NULL};\n\tstruct bnx2x_vlan_mac_obj *mac_obj = &bp->sp_objs->mac_obj;\n\n\t/***************** Cleanup MACs' object first *************************/\n\n\t/* Wait for completion of requested */\n\t__set_bit(RAMROD_COMP_WAIT, &ramrod_flags);\n\t/* Perform a dry cleanup */\n\t__set_bit(RAMROD_DRV_CLR_ONLY, &ramrod_flags);\n\n\t/* Clean ETH primary MAC */\n\t__set_bit(BNX2X_ETH_MAC, &vlan_mac_flags);\n\trc = mac_obj->delete_all(bp, &bp->sp_objs->mac_obj, &vlan_mac_flags,\n\t\t\t\t &ramrod_flags);\n\tif (rc != 0)\n\t\tBNX2X_ERR(\"Failed to clean ETH MACs: %d\\n\", rc);\n\n\t/* Cleanup UC list */\n\tvlan_mac_flags = 0;\n\t__set_bit(BNX2X_UC_LIST_MAC, &vlan_mac_flags);\n\trc = mac_obj->delete_all(bp, mac_obj, &vlan_mac_flags,\n\t\t\t\t &ramrod_flags);\n\tif (rc != 0)\n\t\tBNX2X_ERR(\"Failed to clean UC list MACs: %d\\n\", rc);\n\n\t/***************** Now clean mcast object *****************************/\n\trparam.mcast_obj = &bp->mcast_obj;\n\t__set_bit(RAMROD_DRV_CLR_ONLY, &rparam.ramrod_flags);\n\n\t/* Add a DEL command... - Since we're doing a driver cleanup only,\n\t * we take a lock surrounding both the initial send and the CONTs,\n\t * as we don't want a true completion to disrupt us in the middle.\n\t */\n\tnetif_addr_lock_bh(bp->dev);\n\trc = bnx2x_config_mcast(bp, &rparam, BNX2X_MCAST_CMD_DEL);\n\tif (rc < 0)\n\t\tBNX2X_ERR(\"Failed to add a new DEL command to a multi-cast object: %d\\n\",\n\t\t\t  rc);\n\n\t/* ...and wait until all pending commands are cleared */\n\trc = bnx2x_config_mcast(bp, &rparam, BNX2X_MCAST_CMD_CONT);\n\twhile (rc != 0) {\n\t\tif (rc < 0) {\n\t\t\tBNX2X_ERR(\"Failed to clean multi-cast object: %d\\n\",\n\t\t\t\t  rc);\n\t\t\tnetif_addr_unlock_bh(bp->dev);\n\t\t\treturn;\n\t\t}\n\n\t\trc = bnx2x_config_mcast(bp, &rparam, BNX2X_MCAST_CMD_CONT);\n\t}\n\tnetif_addr_unlock_bh(bp->dev);\n}\n\n#ifndef BNX2X_STOP_ON_ERROR\n#define LOAD_ERROR_EXIT(bp, label) \\\n\tdo { \\\n\t\t(bp)->state = BNX2X_STATE_ERROR; \\\n\t\tgoto label; \\\n\t} while (0)\n\n#define LOAD_ERROR_EXIT_CNIC(bp, label) \\\n\tdo { \\\n\t\tbp->cnic_loaded = false; \\\n\t\tgoto label; \\\n\t} while (0)\n#else /*BNX2X_STOP_ON_ERROR*/\n#define LOAD_ERROR_EXIT(bp, label) \\\n\tdo { \\\n\t\t(bp)->state = BNX2X_STATE_ERROR; \\\n\t\t(bp)->panic = 1; \\\n\t\treturn -EBUSY; \\\n\t} while (0)\n#define LOAD_ERROR_EXIT_CNIC(bp, label) \\\n\tdo { \\\n\t\tbp->cnic_loaded = false; \\\n\t\t(bp)->panic = 1; \\\n\t\treturn -EBUSY; \\\n\t} while (0)\n#endif /*BNX2X_STOP_ON_ERROR*/\n\nstatic void bnx2x_free_fw_stats_mem(struct bnx2x *bp)\n{\n\tBNX2X_PCI_FREE(bp->fw_stats, bp->fw_stats_mapping,\n\t\t       bp->fw_stats_data_sz + bp->fw_stats_req_sz);\n\treturn;\n}\n\nstatic int bnx2x_alloc_fw_stats_mem(struct bnx2x *bp)\n{\n\tint num_groups, vf_headroom = 0;\n\tint is_fcoe_stats = NO_FCOE(bp) ? 0 : 1;\n\n\t/* number of queues for statistics is number of eth queues + FCoE */\n\tu8 num_queue_stats = BNX2X_NUM_ETH_QUEUES(bp) + is_fcoe_stats;\n\n\t/* Total number of FW statistics requests =\n\t * 1 for port stats + 1 for PF stats + potential 2 for FCoE (fcoe proper\n\t * and fcoe l2 queue) stats + num of queues (which includes another 1\n\t * for fcoe l2 queue if applicable)\n\t */\n\tbp->fw_stats_num = 2 + is_fcoe_stats + num_queue_stats;\n\n\t/* vf stats appear in the request list, but their data is allocated by\n\t * the VFs themselves. We don't include them in the bp->fw_stats_num as\n\t * it is used to determine where to place the vf stats queries in the\n\t * request struct\n\t */\n\tif (IS_SRIOV(bp))\n\t\tvf_headroom = bnx2x_vf_headroom(bp);\n\n\t/* Request is built from stats_query_header and an array of\n\t * stats_query_cmd_group each of which contains\n\t * STATS_QUERY_CMD_COUNT rules. The real number or requests is\n\t * configured in the stats_query_header.\n\t */\n\tnum_groups =\n\t\t(((bp->fw_stats_num + vf_headroom) / STATS_QUERY_CMD_COUNT) +\n\t\t (((bp->fw_stats_num + vf_headroom) % STATS_QUERY_CMD_COUNT) ?\n\t\t 1 : 0));\n\n\tDP(BNX2X_MSG_SP, \"stats fw_stats_num %d, vf headroom %d, num_groups %d\\n\",\n\t   bp->fw_stats_num, vf_headroom, num_groups);\n\tbp->fw_stats_req_sz = sizeof(struct stats_query_header) +\n\t\tnum_groups * sizeof(struct stats_query_cmd_group);\n\n\t/* Data for statistics requests + stats_counter\n\t * stats_counter holds per-STORM counters that are incremented\n\t * when STORM has finished with the current request.\n\t * memory for FCoE offloaded statistics are counted anyway,\n\t * even if they will not be sent.\n\t * VF stats are not accounted for here as the data of VF stats is stored\n\t * in memory allocated by the VF, not here.\n\t */\n\tbp->fw_stats_data_sz = sizeof(struct per_port_stats) +\n\t\tsizeof(struct per_pf_stats) +\n\t\tsizeof(struct fcoe_statistics_params) +\n\t\tsizeof(struct per_queue_stats) * num_queue_stats +\n\t\tsizeof(struct stats_counter);\n\n\tbp->fw_stats = BNX2X_PCI_ALLOC(&bp->fw_stats_mapping,\n\t\t\t\t       bp->fw_stats_data_sz + bp->fw_stats_req_sz);\n\tif (!bp->fw_stats)\n\t\tgoto alloc_mem_err;\n\n\t/* Set shortcuts */\n\tbp->fw_stats_req = (struct bnx2x_fw_stats_req *)bp->fw_stats;\n\tbp->fw_stats_req_mapping = bp->fw_stats_mapping;\n\tbp->fw_stats_data = (struct bnx2x_fw_stats_data *)\n\t\t((u8 *)bp->fw_stats + bp->fw_stats_req_sz);\n\tbp->fw_stats_data_mapping = bp->fw_stats_mapping +\n\t\tbp->fw_stats_req_sz;\n\n\tDP(BNX2X_MSG_SP, \"statistics request base address set to %x %x\\n\",\n\t   U64_HI(bp->fw_stats_req_mapping),\n\t   U64_LO(bp->fw_stats_req_mapping));\n\tDP(BNX2X_MSG_SP, \"statistics data base address set to %x %x\\n\",\n\t   U64_HI(bp->fw_stats_data_mapping),\n\t   U64_LO(bp->fw_stats_data_mapping));\n\treturn 0;\n\nalloc_mem_err:\n\tbnx2x_free_fw_stats_mem(bp);\n\tBNX2X_ERR(\"Can't allocate FW stats memory\\n\");\n\treturn -ENOMEM;\n}\n\n/* send load request to mcp and analyze response */\nstatic int bnx2x_nic_load_request(struct bnx2x *bp, u32 *load_code)\n{\n\tu32 param;\n\n\t/* init fw_seq */\n\tbp->fw_seq =\n\t\t(SHMEM_RD(bp, func_mb[BP_FW_MB_IDX(bp)].drv_mb_header) &\n\t\t DRV_MSG_SEQ_NUMBER_MASK);\n\tBNX2X_DEV_INFO(\"fw_seq 0x%08x\\n\", bp->fw_seq);\n\n\t/* Get current FW pulse sequence */\n\tbp->fw_drv_pulse_wr_seq =\n\t\t(SHMEM_RD(bp, func_mb[BP_FW_MB_IDX(bp)].drv_pulse_mb) &\n\t\t DRV_PULSE_SEQ_MASK);\n\tBNX2X_DEV_INFO(\"drv_pulse 0x%x\\n\", bp->fw_drv_pulse_wr_seq);\n\n\tparam = DRV_MSG_CODE_LOAD_REQ_WITH_LFA;\n\n\tif (IS_MF_SD(bp) && bnx2x_port_after_undi(bp))\n\t\tparam |= DRV_MSG_CODE_LOAD_REQ_FORCE_LFA;\n\n\t/* load request */\n\t(*load_code) = bnx2x_fw_command(bp, DRV_MSG_CODE_LOAD_REQ, param);\n\n\t/* if mcp fails to respond we must abort */\n\tif (!(*load_code)) {\n\t\tBNX2X_ERR(\"MCP response failure, aborting\\n\");\n\t\treturn -EBUSY;\n\t}\n\n\t/* If mcp refused (e.g. other port is in diagnostic mode) we\n\t * must abort\n\t */\n\tif ((*load_code) == FW_MSG_CODE_DRV_LOAD_REFUSED) {\n\t\tBNX2X_ERR(\"MCP refused load request, aborting\\n\");\n\t\treturn -EBUSY;\n\t}\n\treturn 0;\n}\n\n/* check whether another PF has already loaded FW to chip. In\n * virtualized environments a pf from another VM may have already\n * initialized the device including loading FW\n */\nint bnx2x_compare_fw_ver(struct bnx2x *bp, u32 load_code, bool print_err)\n{\n\t/* is another pf loaded on this engine? */\n\tif (load_code != FW_MSG_CODE_DRV_LOAD_COMMON_CHIP &&\n\t    load_code != FW_MSG_CODE_DRV_LOAD_COMMON) {\n\t\t/* build my FW version dword */\n\t\tu32 my_fw = (BCM_5710_FW_MAJOR_VERSION) +\n\t\t\t(BCM_5710_FW_MINOR_VERSION << 8) +\n\t\t\t(BCM_5710_FW_REVISION_VERSION << 16) +\n\t\t\t(BCM_5710_FW_ENGINEERING_VERSION << 24);\n\n\t\t/* read loaded FW from chip */\n\t\tu32 loaded_fw = REG_RD(bp, XSEM_REG_PRAM);\n\n\t\tDP(BNX2X_MSG_SP, \"loaded fw %x, my fw %x\\n\",\n\t\t   loaded_fw, my_fw);\n\n\t\t/* abort nic load if version mismatch */\n\t\tif (my_fw != loaded_fw) {\n\t\t\tif (print_err)\n\t\t\t\tBNX2X_ERR(\"bnx2x with FW %x was already loaded which mismatches my %x FW. Aborting\\n\",\n\t\t\t\t\t  loaded_fw, my_fw);\n\t\t\telse\n\t\t\t\tBNX2X_DEV_INFO(\"bnx2x with FW %x was already loaded which mismatches my %x FW, possibly due to MF UNDI\\n\",\n\t\t\t\t\t       loaded_fw, my_fw);\n\t\t\treturn -EBUSY;\n\t\t}\n\t}\n\treturn 0;\n}\n\n/* returns the \"mcp load_code\" according to global load_count array */\nstatic int bnx2x_nic_load_no_mcp(struct bnx2x *bp, int port)\n{\n\tint path = BP_PATH(bp);\n\n\tDP(NETIF_MSG_IFUP, \"NO MCP - load counts[%d]      %d, %d, %d\\n\",\n\t   path, bnx2x_load_count[path][0], bnx2x_load_count[path][1],\n\t   bnx2x_load_count[path][2]);\n\tbnx2x_load_count[path][0]++;\n\tbnx2x_load_count[path][1 + port]++;\n\tDP(NETIF_MSG_IFUP, \"NO MCP - new load counts[%d]  %d, %d, %d\\n\",\n\t   path, bnx2x_load_count[path][0], bnx2x_load_count[path][1],\n\t   bnx2x_load_count[path][2]);\n\tif (bnx2x_load_count[path][0] == 1)\n\t\treturn FW_MSG_CODE_DRV_LOAD_COMMON;\n\telse if (bnx2x_load_count[path][1 + port] == 1)\n\t\treturn FW_MSG_CODE_DRV_LOAD_PORT;\n\telse\n\t\treturn FW_MSG_CODE_DRV_LOAD_FUNCTION;\n}\n\n/* mark PMF if applicable */\nstatic void bnx2x_nic_load_pmf(struct bnx2x *bp, u32 load_code)\n{\n\tif ((load_code == FW_MSG_CODE_DRV_LOAD_COMMON) ||\n\t    (load_code == FW_MSG_CODE_DRV_LOAD_COMMON_CHIP) ||\n\t    (load_code == FW_MSG_CODE_DRV_LOAD_PORT)) {\n\t\tbp->port.pmf = 1;\n\t\t/* We need the barrier to ensure the ordering between the\n\t\t * writing to bp->port.pmf here and reading it from the\n\t\t * bnx2x_periodic_task().\n\t\t */\n\t\tsmp_mb();\n\t} else {\n\t\tbp->port.pmf = 0;\n\t}\n\n\tDP(NETIF_MSG_LINK, \"pmf %d\\n\", bp->port.pmf);\n}\n\nstatic void bnx2x_nic_load_afex_dcc(struct bnx2x *bp, int load_code)\n{\n\tif (((load_code == FW_MSG_CODE_DRV_LOAD_COMMON) ||\n\t     (load_code == FW_MSG_CODE_DRV_LOAD_COMMON_CHIP)) &&\n\t    (bp->common.shmem2_base)) {\n\t\tif (SHMEM2_HAS(bp, dcc_support))\n\t\t\tSHMEM2_WR(bp, dcc_support,\n\t\t\t\t  (SHMEM_DCC_SUPPORT_DISABLE_ENABLE_PF_TLV |\n\t\t\t\t   SHMEM_DCC_SUPPORT_BANDWIDTH_ALLOCATION_TLV));\n\t\tif (SHMEM2_HAS(bp, afex_driver_support))\n\t\t\tSHMEM2_WR(bp, afex_driver_support,\n\t\t\t\t  SHMEM_AFEX_SUPPORTED_VERSION_ONE);\n\t}\n\n\t/* Set AFEX default VLAN tag to an invalid value */\n\tbp->afex_def_vlan_tag = -1;\n}\n\n/**\n * bnx2x_bz_fp - zero content of the fastpath structure.\n *\n * @bp:\t\tdriver handle\n * @index:\tfastpath index to be zeroed\n *\n * Makes sure the contents of the bp->fp[index].napi is kept\n * intact.\n */\nstatic void bnx2x_bz_fp(struct bnx2x *bp, int index)\n{\n\tstruct bnx2x_fastpath *fp = &bp->fp[index];\n\tint cos;\n\tstruct napi_struct orig_napi = fp->napi;\n\tstruct bnx2x_agg_info *orig_tpa_info = fp->tpa_info;\n\n\t/* bzero bnx2x_fastpath contents */\n\tif (fp->tpa_info)\n\t\tmemset(fp->tpa_info, 0, ETH_MAX_AGGREGATION_QUEUES_E1H_E2 *\n\t\t       sizeof(struct bnx2x_agg_info));\n\tmemset(fp, 0, sizeof(*fp));\n\n\t/* Restore the NAPI object as it has been already initialized */\n\tfp->napi = orig_napi;\n\tfp->tpa_info = orig_tpa_info;\n\tfp->bp = bp;\n\tfp->index = index;\n\tif (IS_ETH_FP(fp))\n\t\tfp->max_cos = bp->max_cos;\n\telse\n\t\t/* Special queues support only one CoS */\n\t\tfp->max_cos = 1;\n\n\t/* Init txdata pointers */\n\tif (IS_FCOE_FP(fp))\n\t\tfp->txdata_ptr[0] = &bp->bnx2x_txq[FCOE_TXQ_IDX(bp)];\n\tif (IS_ETH_FP(fp))\n\t\tfor_each_cos_in_tx_queue(fp, cos)\n\t\t\tfp->txdata_ptr[cos] = &bp->bnx2x_txq[cos *\n\t\t\t\tBNX2X_NUM_ETH_QUEUES(bp) + index];\n\n\t/* set the tpa flag for each queue. The tpa flag determines the queue\n\t * minimal size so it must be set prior to queue memory allocation\n\t */\n\tif (bp->dev->features & NETIF_F_LRO)\n\t\tfp->mode = TPA_MODE_LRO;\n\telse if (bp->dev->features & NETIF_F_GRO_HW)\n\t\tfp->mode = TPA_MODE_GRO;\n\telse\n\t\tfp->mode = TPA_MODE_DISABLED;\n\n\t/* We don't want TPA if it's disabled in bp\n\t * or if this is an FCoE L2 ring.\n\t */\n\tif (bp->disable_tpa || IS_FCOE_FP(fp))\n\t\tfp->mode = TPA_MODE_DISABLED;\n}\n\nvoid bnx2x_set_os_driver_state(struct bnx2x *bp, u32 state)\n{\n\tu32 cur;\n\n\tif (!IS_MF_BD(bp) || !SHMEM2_HAS(bp, os_driver_state) || IS_VF(bp))\n\t\treturn;\n\n\tcur = SHMEM2_RD(bp, os_driver_state[BP_FW_MB_IDX(bp)]);\n\tDP(NETIF_MSG_IFUP, \"Driver state %08x-->%08x\\n\",\n\t   cur, state);\n\n\tSHMEM2_WR(bp, os_driver_state[BP_FW_MB_IDX(bp)], state);\n}\n\nint bnx2x_load_cnic(struct bnx2x *bp)\n{\n\tint i, rc, port = BP_PORT(bp);\n\n\tDP(NETIF_MSG_IFUP, \"Starting CNIC-related load\\n\");\n\n\tmutex_init(&bp->cnic_mutex);\n\n\tif (IS_PF(bp)) {\n\t\trc = bnx2x_alloc_mem_cnic(bp);\n\t\tif (rc) {\n\t\t\tBNX2X_ERR(\"Unable to allocate bp memory for cnic\\n\");\n\t\t\tLOAD_ERROR_EXIT_CNIC(bp, load_error_cnic0);\n\t\t}\n\t}\n\n\trc = bnx2x_alloc_fp_mem_cnic(bp);\n\tif (rc) {\n\t\tBNX2X_ERR(\"Unable to allocate memory for cnic fps\\n\");\n\t\tLOAD_ERROR_EXIT_CNIC(bp, load_error_cnic0);\n\t}\n\n\t/* Update the number of queues with the cnic queues */\n\trc = bnx2x_set_real_num_queues(bp, 1);\n\tif (rc) {\n\t\tBNX2X_ERR(\"Unable to set real_num_queues including cnic\\n\");\n\t\tLOAD_ERROR_EXIT_CNIC(bp, load_error_cnic0);\n\t}\n\n\t/* Add all CNIC NAPI objects */\n\tbnx2x_add_all_napi_cnic(bp);\n\tDP(NETIF_MSG_IFUP, \"cnic napi added\\n\");\n\tbnx2x_napi_enable_cnic(bp);\n\n\trc = bnx2x_init_hw_func_cnic(bp);\n\tif (rc)\n\t\tLOAD_ERROR_EXIT_CNIC(bp, load_error_cnic1);\n\n\tbnx2x_nic_init_cnic(bp);\n\n\tif (IS_PF(bp)) {\n\t\t/* Enable Timer scan */\n\t\tREG_WR(bp, TM_REG_EN_LINEAR0_TIMER + port*4, 1);\n\n\t\t/* setup cnic queues */\n\t\tfor_each_cnic_queue(bp, i) {\n\t\t\trc = bnx2x_setup_queue(bp, &bp->fp[i], 0);\n\t\t\tif (rc) {\n\t\t\t\tBNX2X_ERR(\"Queue setup failed\\n\");\n\t\t\t\tLOAD_ERROR_EXIT(bp, load_error_cnic2);\n\t\t\t}\n\t\t}\n\t}\n\n\t/* Initialize Rx filter. */\n\tbnx2x_set_rx_mode_inner(bp);\n\n\t/* re-read iscsi info */\n\tbnx2x_get_iscsi_info(bp);\n\tbnx2x_setup_cnic_irq_info(bp);\n\tbnx2x_setup_cnic_info(bp);\n\tbp->cnic_loaded = true;\n\tif (bp->state == BNX2X_STATE_OPEN)\n\t\tbnx2x_cnic_notify(bp, CNIC_CTL_START_CMD);\n\n\tDP(NETIF_MSG_IFUP, \"Ending successfully CNIC-related load\\n\");\n\n\treturn 0;\n\n#ifndef BNX2X_STOP_ON_ERROR\nload_error_cnic2:\n\t/* Disable Timer scan */\n\tREG_WR(bp, TM_REG_EN_LINEAR0_TIMER + port*4, 0);\n\nload_error_cnic1:\n\tbnx2x_napi_disable_cnic(bp);\n\t/* Update the number of queues without the cnic queues */\n\tif (bnx2x_set_real_num_queues(bp, 0))\n\t\tBNX2X_ERR(\"Unable to set real_num_queues not including cnic\\n\");\nload_error_cnic0:\n\tBNX2X_ERR(\"CNIC-related load failed\\n\");\n\tbnx2x_free_fp_mem_cnic(bp);\n\tbnx2x_free_mem_cnic(bp);\n\treturn rc;\n#endif /* ! BNX2X_STOP_ON_ERROR */\n}\n\n/* must be called with rtnl_lock */\nint bnx2x_nic_load(struct bnx2x *bp, int load_mode)\n{\n\tint port = BP_PORT(bp);\n\tint i, rc = 0, load_code = 0;\n\n\tDP(NETIF_MSG_IFUP, \"Starting NIC load\\n\");\n\tDP(NETIF_MSG_IFUP,\n\t   \"CNIC is %s\\n\", CNIC_ENABLED(bp) ? \"enabled\" : \"disabled\");\n\n#ifdef BNX2X_STOP_ON_ERROR\n\tif (unlikely(bp->panic)) {\n\t\tBNX2X_ERR(\"Can't load NIC when there is panic\\n\");\n\t\treturn -EPERM;\n\t}\n#endif\n\n\tbp->state = BNX2X_STATE_OPENING_WAIT4_LOAD;\n\n\t/* zero the structure w/o any lock, before SP handler is initialized */\n\tmemset(&bp->last_reported_link, 0, sizeof(bp->last_reported_link));\n\t__set_bit(BNX2X_LINK_REPORT_LINK_DOWN,\n\t\t&bp->last_reported_link.link_report_flags);\n\n\tif (IS_PF(bp))\n\t\t/* must be called before memory allocation and HW init */\n\t\tbnx2x_ilt_set_info(bp);\n\n\t/*\n\t * Zero fastpath structures preserving invariants like napi, which are\n\t * allocated only once, fp index, max_cos, bp pointer.\n\t * Also set fp->mode and txdata_ptr.\n\t */\n\tDP(NETIF_MSG_IFUP, \"num queues: %d\", bp->num_queues);\n\tfor_each_queue(bp, i)\n\t\tbnx2x_bz_fp(bp, i);\n\tmemset(bp->bnx2x_txq, 0, (BNX2X_MAX_RSS_COUNT(bp) * BNX2X_MULTI_TX_COS +\n\t\t\t\t  bp->num_cnic_queues) *\n\t\t\t\t  sizeof(struct bnx2x_fp_txdata));\n\n\tbp->fcoe_init = false;\n\n\t/* Set the receive queues buffer size */\n\tbnx2x_set_rx_buf_size(bp);\n\n\tif (IS_PF(bp)) {\n\t\trc = bnx2x_alloc_mem(bp);\n\t\tif (rc) {\n\t\t\tBNX2X_ERR(\"Unable to allocate bp memory\\n\");\n\t\t\treturn rc;\n\t\t}\n\t}\n\n\t/* need to be done after alloc mem, since it's self adjusting to amount\n\t * of memory available for RSS queues\n\t */\n\trc = bnx2x_alloc_fp_mem(bp);\n\tif (rc) {\n\t\tBNX2X_ERR(\"Unable to allocate memory for fps\\n\");\n\t\tLOAD_ERROR_EXIT(bp, load_error0);\n\t}\n\n\t/* Allocated memory for FW statistics  */\n\tif (bnx2x_alloc_fw_stats_mem(bp))\n\t\tLOAD_ERROR_EXIT(bp, load_error0);\n\n\t/* request pf to initialize status blocks */\n\tif (IS_VF(bp)) {\n\t\trc = bnx2x_vfpf_init(bp);\n\t\tif (rc)\n\t\t\tLOAD_ERROR_EXIT(bp, load_error0);\n\t}\n\n\t/* As long as bnx2x_alloc_mem() may possibly update\n\t * bp->num_queues, bnx2x_set_real_num_queues() should always\n\t * come after it. At this stage cnic queues are not counted.\n\t */\n\trc = bnx2x_set_real_num_queues(bp, 0);\n\tif (rc) {\n\t\tBNX2X_ERR(\"Unable to set real_num_queues\\n\");\n\t\tLOAD_ERROR_EXIT(bp, load_error0);\n\t}\n\n\t/* configure multi cos mappings in kernel.\n\t * this configuration may be overridden by a multi class queue\n\t * discipline or by a dcbx negotiation result.\n\t */\n\tbnx2x_setup_tc(bp->dev, bp->max_cos);\n\n\t/* Add all NAPI objects */\n\tbnx2x_add_all_napi(bp);\n\tDP(NETIF_MSG_IFUP, \"napi added\\n\");\n\tbnx2x_napi_enable(bp);\n\n\tif (IS_PF(bp)) {\n\t\t/* set pf load just before approaching the MCP */\n\t\tbnx2x_set_pf_load(bp);\n\n\t\t/* if mcp exists send load request and analyze response */\n\t\tif (!BP_NOMCP(bp)) {\n\t\t\t/* attempt to load pf */\n\t\t\trc = bnx2x_nic_load_request(bp, &load_code);\n\t\t\tif (rc)\n\t\t\t\tLOAD_ERROR_EXIT(bp, load_error1);\n\n\t\t\t/* what did mcp say? */\n\t\t\trc = bnx2x_compare_fw_ver(bp, load_code, true);\n\t\t\tif (rc) {\n\t\t\t\tbnx2x_fw_command(bp, DRV_MSG_CODE_LOAD_DONE, 0);\n\t\t\t\tLOAD_ERROR_EXIT(bp, load_error2);\n\t\t\t}\n\t\t} else {\n\t\t\tload_code = bnx2x_nic_load_no_mcp(bp, port);\n\t\t}\n\n\t\t/* mark pmf if applicable */\n\t\tbnx2x_nic_load_pmf(bp, load_code);\n\n\t\t/* Init Function state controlling object */\n\t\tbnx2x__init_func_obj(bp);\n\n\t\t/* Initialize HW */\n\t\trc = bnx2x_init_hw(bp, load_code);\n\t\tif (rc) {\n\t\t\tBNX2X_ERR(\"HW init failed, aborting\\n\");\n\t\t\tbnx2x_fw_command(bp, DRV_MSG_CODE_LOAD_DONE, 0);\n\t\t\tLOAD_ERROR_EXIT(bp, load_error2);\n\t\t}\n\t}\n\n\tbnx2x_pre_irq_nic_init(bp);\n\n\t/* Connect to IRQs */\n\trc = bnx2x_setup_irqs(bp);\n\tif (rc) {\n\t\tBNX2X_ERR(\"setup irqs failed\\n\");\n\t\tif (IS_PF(bp))\n\t\t\tbnx2x_fw_command(bp, DRV_MSG_CODE_LOAD_DONE, 0);\n\t\tLOAD_ERROR_EXIT(bp, load_error2);\n\t}\n\n\t/* Init per-function objects */\n\tif (IS_PF(bp)) {\n\t\t/* Setup NIC internals and enable interrupts */\n\t\tbnx2x_post_irq_nic_init(bp, load_code);\n\n\t\tbnx2x_init_bp_objs(bp);\n\t\tbnx2x_iov_nic_init(bp);\n\n\t\t/* Set AFEX default VLAN tag to an invalid value */\n\t\tbp->afex_def_vlan_tag = -1;\n\t\tbnx2x_nic_load_afex_dcc(bp, load_code);\n\t\tbp->state = BNX2X_STATE_OPENING_WAIT4_PORT;\n\t\trc = bnx2x_func_start(bp);\n\t\tif (rc) {\n\t\t\tBNX2X_ERR(\"Function start failed!\\n\");\n\t\t\tbnx2x_fw_command(bp, DRV_MSG_CODE_LOAD_DONE, 0);\n\n\t\t\tLOAD_ERROR_EXIT(bp, load_error3);\n\t\t}\n\n\t\t/* Send LOAD_DONE command to MCP */\n\t\tif (!BP_NOMCP(bp)) {\n\t\t\tload_code = bnx2x_fw_command(bp,\n\t\t\t\t\t\t     DRV_MSG_CODE_LOAD_DONE, 0);\n\t\t\tif (!load_code) {\n\t\t\t\tBNX2X_ERR(\"MCP response failure, aborting\\n\");\n\t\t\t\trc = -EBUSY;\n\t\t\t\tLOAD_ERROR_EXIT(bp, load_error3);\n\t\t\t}\n\t\t}\n\n\t\t/* initialize FW coalescing state machines in RAM */\n\t\tbnx2x_update_coalesce(bp);\n\t}\n\n\t/* setup the leading queue */\n\trc = bnx2x_setup_leading(bp);\n\tif (rc) {\n\t\tBNX2X_ERR(\"Setup leading failed!\\n\");\n\t\tLOAD_ERROR_EXIT(bp, load_error3);\n\t}\n\n\t/* set up the rest of the queues */\n\tfor_each_nondefault_eth_queue(bp, i) {\n\t\tif (IS_PF(bp))\n\t\t\trc = bnx2x_setup_queue(bp, &bp->fp[i], false);\n\t\telse /* VF */\n\t\t\trc = bnx2x_vfpf_setup_q(bp, &bp->fp[i], false);\n\t\tif (rc) {\n\t\t\tBNX2X_ERR(\"Queue %d setup failed\\n\", i);\n\t\t\tLOAD_ERROR_EXIT(bp, load_error3);\n\t\t}\n\t}\n\n\t/* setup rss */\n\trc = bnx2x_init_rss(bp);\n\tif (rc) {\n\t\tBNX2X_ERR(\"PF RSS init failed\\n\");\n\t\tLOAD_ERROR_EXIT(bp, load_error3);\n\t}\n\n\t/* Now when Clients are configured we are ready to work */\n\tbp->state = BNX2X_STATE_OPEN;\n\n\t/* Configure a ucast MAC */\n\tif (IS_PF(bp))\n\t\trc = bnx2x_set_eth_mac(bp, true);\n\telse /* vf */\n\t\trc = bnx2x_vfpf_config_mac(bp, bp->dev->dev_addr, bp->fp->index,\n\t\t\t\t\t   true);\n\tif (rc) {\n\t\tBNX2X_ERR(\"Setting Ethernet MAC failed\\n\");\n\t\tLOAD_ERROR_EXIT(bp, load_error3);\n\t}\n\n\tif (IS_PF(bp) && bp->pending_max) {\n\t\tbnx2x_update_max_mf_config(bp, bp->pending_max);\n\t\tbp->pending_max = 0;\n\t}\n\n\tbp->force_link_down = false;\n\tif (bp->port.pmf) {\n\t\trc = bnx2x_initial_phy_init(bp, load_mode);\n\t\tif (rc)\n\t\t\tLOAD_ERROR_EXIT(bp, load_error3);\n\t}\n\tbp->link_params.feature_config_flags &= ~FEATURE_CONFIG_BOOT_FROM_SAN;\n\n\t/* Start fast path */\n\n\t/* Re-configure vlan filters */\n\trc = bnx2x_vlan_reconfigure_vid(bp);\n\tif (rc)\n\t\tLOAD_ERROR_EXIT(bp, load_error3);\n\n\t/* Initialize Rx filter. */\n\tbnx2x_set_rx_mode_inner(bp);\n\n\tif (bp->flags & PTP_SUPPORTED) {\n\t\tbnx2x_register_phc(bp);\n\t\tbnx2x_init_ptp(bp);\n\t\tbnx2x_configure_ptp_filters(bp);\n\t}\n\t/* Start Tx */\n\tswitch (load_mode) {\n\tcase LOAD_NORMAL:\n\t\t/* Tx queue should be only re-enabled */\n\t\tnetif_tx_wake_all_queues(bp->dev);\n\t\tbreak;\n\n\tcase LOAD_OPEN:\n\t\tnetif_tx_start_all_queues(bp->dev);\n\t\tsmp_mb__after_atomic();\n\t\tbreak;\n\n\tcase LOAD_DIAG:\n\tcase LOAD_LOOPBACK_EXT:\n\t\tbp->state = BNX2X_STATE_DIAG;\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\tif (bp->port.pmf)\n\t\tbnx2x_update_drv_flags(bp, 1 << DRV_FLAGS_PORT_MASK, 0);\n\telse\n\t\tbnx2x__link_status_update(bp);\n\n\t/* start the timer */\n\tmod_timer(&bp->timer, jiffies + bp->current_interval);\n\n\tif (CNIC_ENABLED(bp))\n\t\tbnx2x_load_cnic(bp);\n\n\tif (IS_PF(bp))\n\t\tbnx2x_schedule_sp_rtnl(bp, BNX2X_SP_RTNL_GET_DRV_VERSION, 0);\n\n\tif (IS_PF(bp) && SHMEM2_HAS(bp, drv_capabilities_flag)) {\n\t\t/* mark driver is loaded in shmem2 */\n\t\tu32 val;\n\t\tval = SHMEM2_RD(bp, drv_capabilities_flag[BP_FW_MB_IDX(bp)]);\n\t\tval &= ~DRV_FLAGS_MTU_MASK;\n\t\tval |= (bp->dev->mtu << DRV_FLAGS_MTU_SHIFT);\n\t\tSHMEM2_WR(bp, drv_capabilities_flag[BP_FW_MB_IDX(bp)],\n\t\t\t  val | DRV_FLAGS_CAPABILITIES_LOADED_SUPPORTED |\n\t\t\t  DRV_FLAGS_CAPABILITIES_LOADED_L2);\n\t}\n\n\t/* Wait for all pending SP commands to complete */\n\tif (IS_PF(bp) && !bnx2x_wait_sp_comp(bp, ~0x0UL)) {\n\t\tBNX2X_ERR(\"Timeout waiting for SP elements to complete\\n\");\n\t\tbnx2x_nic_unload(bp, UNLOAD_CLOSE, false);\n\t\treturn -EBUSY;\n\t}\n\n\t/* Update driver data for On-Chip MFW dump. */\n\tif (IS_PF(bp))\n\t\tbnx2x_update_mfw_dump(bp);\n\n\t/* If PMF - send ADMIN DCBX msg to MFW to initiate DCBX FSM */\n\tif (bp->port.pmf && (bp->state != BNX2X_STATE_DIAG))\n\t\tbnx2x_dcbx_init(bp, false);\n\n\tif (!IS_MF_SD_STORAGE_PERSONALITY_ONLY(bp))\n\t\tbnx2x_set_os_driver_state(bp, OS_DRIVER_STATE_ACTIVE);\n\n\tDP(NETIF_MSG_IFUP, \"Ending successfully NIC load\\n\");\n\n\treturn 0;\n\n#ifndef BNX2X_STOP_ON_ERROR\nload_error3:\n\tif (IS_PF(bp)) {\n\t\tbnx2x_int_disable_sync(bp, 1);\n\n\t\t/* Clean queueable objects */\n\t\tbnx2x_squeeze_objects(bp);\n\t}\n\n\t/* Free SKBs, SGEs, TPA pool and driver internals */\n\tbnx2x_free_skbs(bp);\n\tfor_each_rx_queue(bp, i)\n\t\tbnx2x_free_rx_sge_range(bp, bp->fp + i, NUM_RX_SGE);\n\n\t/* Release IRQs */\n\tbnx2x_free_irq(bp);\nload_error2:\n\tif (IS_PF(bp) && !BP_NOMCP(bp)) {\n\t\tbnx2x_fw_command(bp, DRV_MSG_CODE_UNLOAD_REQ_WOL_MCP, 0);\n\t\tbnx2x_fw_command(bp, DRV_MSG_CODE_UNLOAD_DONE, 0);\n\t}\n\n\tbp->port.pmf = 0;\nload_error1:\n\tbnx2x_napi_disable(bp);\n\tbnx2x_del_all_napi(bp);\n\n\t/* clear pf_load status, as it was already set */\n\tif (IS_PF(bp))\n\t\tbnx2x_clear_pf_load(bp);\nload_error0:\n\tbnx2x_free_fw_stats_mem(bp);\n\tbnx2x_free_fp_mem(bp);\n\tbnx2x_free_mem(bp);\n\n\treturn rc;\n#endif /* ! BNX2X_STOP_ON_ERROR */\n}\n\nint bnx2x_drain_tx_queues(struct bnx2x *bp)\n{\n\tu8 rc = 0, cos, i;\n\n\t/* Wait until tx fastpath tasks complete */\n\tfor_each_tx_queue(bp, i) {\n\t\tstruct bnx2x_fastpath *fp = &bp->fp[i];\n\n\t\tfor_each_cos_in_tx_queue(fp, cos)\n\t\t\trc = bnx2x_clean_tx_queue(bp, fp->txdata_ptr[cos]);\n\t\tif (rc)\n\t\t\treturn rc;\n\t}\n\treturn 0;\n}\n\n/* must be called with rtnl_lock */\nint bnx2x_nic_unload(struct bnx2x *bp, int unload_mode, bool keep_link)\n{\n\tint i;\n\tbool global = false;\n\n\tDP(NETIF_MSG_IFUP, \"Starting NIC unload\\n\");\n\n\tif (!IS_MF_SD_STORAGE_PERSONALITY_ONLY(bp))\n\t\tbnx2x_set_os_driver_state(bp, OS_DRIVER_STATE_DISABLED);\n\n\t/* mark driver is unloaded in shmem2 */\n\tif (IS_PF(bp) && SHMEM2_HAS(bp, drv_capabilities_flag)) {\n\t\tu32 val;\n\t\tval = SHMEM2_RD(bp, drv_capabilities_flag[BP_FW_MB_IDX(bp)]);\n\t\tSHMEM2_WR(bp, drv_capabilities_flag[BP_FW_MB_IDX(bp)],\n\t\t\t  val & ~DRV_FLAGS_CAPABILITIES_LOADED_L2);\n\t}\n\n\tif (IS_PF(bp) && bp->recovery_state != BNX2X_RECOVERY_DONE &&\n\t    (bp->state == BNX2X_STATE_CLOSED ||\n\t     bp->state == BNX2X_STATE_ERROR)) {\n\t\t/* We can get here if the driver has been unloaded\n\t\t * during parity error recovery and is either waiting for a\n\t\t * leader to complete or for other functions to unload and\n\t\t * then ifdown has been issued. In this case we want to\n\t\t * unload and let other functions to complete a recovery\n\t\t * process.\n\t\t */\n\t\tbp->recovery_state = BNX2X_RECOVERY_DONE;\n\t\tbp->is_leader = 0;\n\t\tbnx2x_release_leader_lock(bp);\n\t\tsmp_mb();\n\n\t\tDP(NETIF_MSG_IFDOWN, \"Releasing a leadership...\\n\");\n\t\tBNX2X_ERR(\"Can't unload in closed or error state\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t/* Nothing to do during unload if previous bnx2x_nic_load()\n\t * have not completed successfully - all resources are released.\n\t *\n\t * we can get here only after unsuccessful ndo_* callback, during which\n\t * dev->IFF_UP flag is still on.\n\t */\n\tif (bp->state == BNX2X_STATE_CLOSED || bp->state == BNX2X_STATE_ERROR)\n\t\treturn 0;\n\n\t/* It's important to set the bp->state to the value different from\n\t * BNX2X_STATE_OPEN and only then stop the Tx. Otherwise bnx2x_tx_int()\n\t * may restart the Tx from the NAPI context (see bnx2x_tx_int()).\n\t */\n\tbp->state = BNX2X_STATE_CLOSING_WAIT4_HALT;\n\tsmp_mb();\n\n\t/* indicate to VFs that the PF is going down */\n\tbnx2x_iov_channel_down(bp);\n\n\tif (CNIC_LOADED(bp))\n\t\tbnx2x_cnic_notify(bp, CNIC_CTL_STOP_CMD);\n\n\t/* Stop Tx */\n\tbnx2x_tx_disable(bp);\n\tnetdev_reset_tc(bp->dev);\n\n\tbp->rx_mode = BNX2X_RX_MODE_NONE;\n\n\tdel_timer_sync(&bp->timer);\n\n\tif (IS_PF(bp) && !BP_NOMCP(bp)) {\n\t\t/* Set ALWAYS_ALIVE bit in shmem */\n\t\tbp->fw_drv_pulse_wr_seq |= DRV_PULSE_ALWAYS_ALIVE;\n\t\tbnx2x_drv_pulse(bp);\n\t\tbnx2x_stats_handle(bp, STATS_EVENT_STOP);\n\t\tbnx2x_save_statistics(bp);\n\t}\n\n\t/* wait till consumers catch up with producers in all queues.\n\t * If we're recovering, FW can't write to host so no reason\n\t * to wait for the queues to complete all Tx.\n\t */\n\tif (unload_mode != UNLOAD_RECOVERY)\n\t\tbnx2x_drain_tx_queues(bp);\n\n\t/* if VF indicate to PF this function is going down (PF will delete sp\n\t * elements and clear initializations\n\t */\n\tif (IS_VF(bp)) {\n\t\tbnx2x_clear_vlan_info(bp);\n\t\tbnx2x_vfpf_close_vf(bp);\n\t} else if (unload_mode != UNLOAD_RECOVERY) {\n\t\t/* if this is a normal/close unload need to clean up chip*/\n\t\tbnx2x_chip_cleanup(bp, unload_mode, keep_link);\n\t} else {\n\t\t/* Send the UNLOAD_REQUEST to the MCP */\n\t\tbnx2x_send_unload_req(bp, unload_mode);\n\n\t\t/* Prevent transactions to host from the functions on the\n\t\t * engine that doesn't reset global blocks in case of global\n\t\t * attention once global blocks are reset and gates are opened\n\t\t * (the engine which leader will perform the recovery\n\t\t * last).\n\t\t */\n\t\tif (!CHIP_IS_E1x(bp))\n\t\t\tbnx2x_pf_disable(bp);\n\n\t\t/* Disable HW interrupts, NAPI */\n\t\tbnx2x_netif_stop(bp, 1);\n\t\t/* Delete all NAPI objects */\n\t\tbnx2x_del_all_napi(bp);\n\t\tif (CNIC_LOADED(bp))\n\t\t\tbnx2x_del_all_napi_cnic(bp);\n\t\t/* Release IRQs */\n\t\tbnx2x_free_irq(bp);\n\n\t\t/* Report UNLOAD_DONE to MCP */\n\t\tbnx2x_send_unload_done(bp, false);\n\t}\n\n\t/*\n\t * At this stage no more interrupts will arrive so we may safely clean\n\t * the queueable objects here in case they failed to get cleaned so far.\n\t */\n\tif (IS_PF(bp))\n\t\tbnx2x_squeeze_objects(bp);\n\n\t/* There should be no more pending SP commands at this stage */\n\tbp->sp_state = 0;\n\n\tbp->port.pmf = 0;\n\n\t/* clear pending work in rtnl task */\n\tbp->sp_rtnl_state = 0;\n\tsmp_mb();\n\n\t/* Free SKBs, SGEs, TPA pool and driver internals */\n\tbnx2x_free_skbs(bp);\n\tif (CNIC_LOADED(bp))\n\t\tbnx2x_free_skbs_cnic(bp);\n\tfor_each_rx_queue(bp, i)\n\t\tbnx2x_free_rx_sge_range(bp, bp->fp + i, NUM_RX_SGE);\n\n\tbnx2x_free_fp_mem(bp);\n\tif (CNIC_LOADED(bp))\n\t\tbnx2x_free_fp_mem_cnic(bp);\n\n\tif (IS_PF(bp)) {\n\t\tif (CNIC_LOADED(bp))\n\t\t\tbnx2x_free_mem_cnic(bp);\n\t}\n\tbnx2x_free_mem(bp);\n\n\tbp->state = BNX2X_STATE_CLOSED;\n\tbp->cnic_loaded = false;\n\n\t/* Clear driver version indication in shmem */\n\tif (IS_PF(bp) && !BP_NOMCP(bp))\n\t\tbnx2x_update_mng_version(bp);\n\n\t/* Check if there are pending parity attentions. If there are - set\n\t * RECOVERY_IN_PROGRESS.\n\t */\n\tif (IS_PF(bp) && bnx2x_chk_parity_attn(bp, &global, false)) {\n\t\tbnx2x_set_reset_in_progress(bp);\n\n\t\t/* Set RESET_IS_GLOBAL if needed */\n\t\tif (global)\n\t\t\tbnx2x_set_reset_global(bp);\n\t}\n\n\t/* The last driver must disable a \"close the gate\" if there is no\n\t * parity attention or \"process kill\" pending.\n\t */\n\tif (IS_PF(bp) &&\n\t    !bnx2x_clear_pf_load(bp) &&\n\t    bnx2x_reset_is_done(bp, BP_PATH(bp)))\n\t\tbnx2x_disable_close_the_gate(bp);\n\n\tDP(NETIF_MSG_IFUP, \"Ending NIC unload\\n\");\n\n\treturn 0;\n}\n\nint bnx2x_set_power_state(struct bnx2x *bp, pci_power_t state)\n{\n\tu16 pmcsr;\n\n\t/* If there is no power capability, silently succeed */\n\tif (!bp->pdev->pm_cap) {\n\t\tBNX2X_DEV_INFO(\"No power capability. Breaking.\\n\");\n\t\treturn 0;\n\t}\n\n\tpci_read_config_word(bp->pdev, bp->pdev->pm_cap + PCI_PM_CTRL, &pmcsr);\n\n\tswitch (state) {\n\tcase PCI_D0:\n\t\tpci_write_config_word(bp->pdev, bp->pdev->pm_cap + PCI_PM_CTRL,\n\t\t\t\t      ((pmcsr & ~PCI_PM_CTRL_STATE_MASK) |\n\t\t\t\t       PCI_PM_CTRL_PME_STATUS));\n\n\t\tif (pmcsr & PCI_PM_CTRL_STATE_MASK)\n\t\t\t/* delay required during transition out of D3hot */\n\t\t\tmsleep(20);\n\t\tbreak;\n\n\tcase PCI_D3hot:\n\t\t/* If there are other clients above don't\n\t\t   shut down the power */\n\t\tif (atomic_read(&bp->pdev->enable_cnt) != 1)\n\t\t\treturn 0;\n\t\t/* Don't shut down the power for emulation and FPGA */\n\t\tif (CHIP_REV_IS_SLOW(bp))\n\t\t\treturn 0;\n\n\t\tpmcsr &= ~PCI_PM_CTRL_STATE_MASK;\n\t\tpmcsr |= 3;\n\n\t\tif (bp->wol)\n\t\t\tpmcsr |= PCI_PM_CTRL_PME_ENABLE;\n\n\t\tpci_write_config_word(bp->pdev, bp->pdev->pm_cap + PCI_PM_CTRL,\n\t\t\t\t      pmcsr);\n\n\t\t/* No more memory access after this point until\n\t\t* device is brought back to D0.\n\t\t*/\n\t\tbreak;\n\n\tdefault:\n\t\tdev_err(&bp->pdev->dev, \"Can't support state = %d\\n\", state);\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\n/*\n * net_device service functions\n */\nstatic int bnx2x_poll(struct napi_struct *napi, int budget)\n{\n\tstruct bnx2x_fastpath *fp = container_of(napi, struct bnx2x_fastpath,\n\t\t\t\t\t\t napi);\n\tstruct bnx2x *bp = fp->bp;\n\tint rx_work_done;\n\tu8 cos;\n\n#ifdef BNX2X_STOP_ON_ERROR\n\tif (unlikely(bp->panic)) {\n\t\tnapi_complete(napi);\n\t\treturn 0;\n\t}\n#endif\n\tfor_each_cos_in_tx_queue(fp, cos)\n\t\tif (bnx2x_tx_queue_has_work(fp->txdata_ptr[cos]))\n\t\t\tbnx2x_tx_int(bp, fp->txdata_ptr[cos]);\n\n\trx_work_done = (bnx2x_has_rx_work(fp)) ? bnx2x_rx_int(fp, budget) : 0;\n\n\tif (rx_work_done < budget) {\n\t\t/* No need to update SB for FCoE L2 ring as long as\n\t\t * it's connected to the default SB and the SB\n\t\t * has been updated when NAPI was scheduled.\n\t\t */\n\t\tif (IS_FCOE_FP(fp)) {\n\t\t\tnapi_complete_done(napi, rx_work_done);\n\t\t} else {\n\t\t\tbnx2x_update_fpsb_idx(fp);\n\t\t\t/* bnx2x_has_rx_work() reads the status block,\n\t\t\t * thus we need to ensure that status block indices\n\t\t\t * have been actually read (bnx2x_update_fpsb_idx)\n\t\t\t * prior to this check (bnx2x_has_rx_work) so that\n\t\t\t * we won't write the \"newer\" value of the status block\n\t\t\t * to IGU (if there was a DMA right after\n\t\t\t * bnx2x_has_rx_work and if there is no rmb, the memory\n\t\t\t * reading (bnx2x_update_fpsb_idx) may be postponed\n\t\t\t * to right before bnx2x_ack_sb). In this case there\n\t\t\t * will never be another interrupt until there is\n\t\t\t * another update of the status block, while there\n\t\t\t * is still unhandled work.\n\t\t\t */\n\t\t\trmb();\n\n\t\t\tif (!(bnx2x_has_rx_work(fp) || bnx2x_has_tx_work(fp))) {\n\t\t\t\tif (napi_complete_done(napi, rx_work_done)) {\n\t\t\t\t\t/* Re-enable interrupts */\n\t\t\t\t\tDP(NETIF_MSG_RX_STATUS,\n\t\t\t\t\t   \"Update index to %d\\n\", fp->fp_hc_idx);\n\t\t\t\t\tbnx2x_ack_sb(bp, fp->igu_sb_id, USTORM_ID,\n\t\t\t\t\t\t     le16_to_cpu(fp->fp_hc_idx),\n\t\t\t\t\t\t     IGU_INT_ENABLE, 1);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\trx_work_done = budget;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn rx_work_done;\n}\n\n/* we split the first BD into headers and data BDs\n * to ease the pain of our fellow microcode engineers\n * we use one mapping for both BDs\n */\nstatic u16 bnx2x_tx_split(struct bnx2x *bp,\n\t\t\t  struct bnx2x_fp_txdata *txdata,\n\t\t\t  struct sw_tx_bd *tx_buf,\n\t\t\t  struct eth_tx_start_bd **tx_bd, u16 hlen,\n\t\t\t  u16 bd_prod)\n{\n\tstruct eth_tx_start_bd *h_tx_bd = *tx_bd;\n\tstruct eth_tx_bd *d_tx_bd;\n\tdma_addr_t mapping;\n\tint old_len = le16_to_cpu(h_tx_bd->nbytes);\n\n\t/* first fix first BD */\n\th_tx_bd->nbytes = cpu_to_le16(hlen);\n\n\tDP(NETIF_MSG_TX_QUEUED,\t\"TSO split header size is %d (%x:%x)\\n\",\n\t   h_tx_bd->nbytes, h_tx_bd->addr_hi, h_tx_bd->addr_lo);\n\n\t/* now get a new data BD\n\t * (after the pbd) and fill it */\n\tbd_prod = TX_BD(NEXT_TX_IDX(bd_prod));\n\td_tx_bd = &txdata->tx_desc_ring[bd_prod].reg_bd;\n\n\tmapping = HILO_U64(le32_to_cpu(h_tx_bd->addr_hi),\n\t\t\t   le32_to_cpu(h_tx_bd->addr_lo)) + hlen;\n\n\td_tx_bd->addr_hi = cpu_to_le32(U64_HI(mapping));\n\td_tx_bd->addr_lo = cpu_to_le32(U64_LO(mapping));\n\td_tx_bd->nbytes = cpu_to_le16(old_len - hlen);\n\n\t/* this marks the BD as one that has no individual mapping */\n\ttx_buf->flags |= BNX2X_TSO_SPLIT_BD;\n\n\tDP(NETIF_MSG_TX_QUEUED,\n\t   \"TSO split data size is %d (%x:%x)\\n\",\n\t   d_tx_bd->nbytes, d_tx_bd->addr_hi, d_tx_bd->addr_lo);\n\n\t/* update tx_bd */\n\t*tx_bd = (struct eth_tx_start_bd *)d_tx_bd;\n\n\treturn bd_prod;\n}\n\n#define bswab32(b32) ((__force __le32) swab32((__force __u32) (b32)))\n#define bswab16(b16) ((__force __le16) swab16((__force __u16) (b16)))\nstatic __le16 bnx2x_csum_fix(unsigned char *t_header, u16 csum, s8 fix)\n{\n\t__sum16 tsum = (__force __sum16) csum;\n\n\tif (fix > 0)\n\t\ttsum = ~csum_fold(csum_sub((__force __wsum) csum,\n\t\t\t\t  csum_partial(t_header - fix, fix, 0)));\n\n\telse if (fix < 0)\n\t\ttsum = ~csum_fold(csum_add((__force __wsum) csum,\n\t\t\t\t  csum_partial(t_header, -fix, 0)));\n\n\treturn bswab16(tsum);\n}\n\nstatic u32 bnx2x_xmit_type(struct bnx2x *bp, struct sk_buff *skb)\n{\n\tu32 rc;\n\t__u8 prot = 0;\n\t__be16 protocol;\n\n\tif (skb->ip_summed != CHECKSUM_PARTIAL)\n\t\treturn XMIT_PLAIN;\n\n\tprotocol = vlan_get_protocol(skb);\n\tif (protocol == htons(ETH_P_IPV6)) {\n\t\trc = XMIT_CSUM_V6;\n\t\tprot = ipv6_hdr(skb)->nexthdr;\n\t} else {\n\t\trc = XMIT_CSUM_V4;\n\t\tprot = ip_hdr(skb)->protocol;\n\t}\n\n\tif (!CHIP_IS_E1x(bp) && skb->encapsulation) {\n\t\tif (inner_ip_hdr(skb)->version == 6) {\n\t\t\trc |= XMIT_CSUM_ENC_V6;\n\t\t\tif (inner_ipv6_hdr(skb)->nexthdr == IPPROTO_TCP)\n\t\t\t\trc |= XMIT_CSUM_TCP;\n\t\t} else {\n\t\t\trc |= XMIT_CSUM_ENC_V4;\n\t\t\tif (inner_ip_hdr(skb)->protocol == IPPROTO_TCP)\n\t\t\t\trc |= XMIT_CSUM_TCP;\n\t\t}\n\t}\n\tif (prot == IPPROTO_TCP)\n\t\trc |= XMIT_CSUM_TCP;\n\n\tif (skb_is_gso(skb)) {\n\t\tif (skb_is_gso_v6(skb)) {\n\t\t\trc |= (XMIT_GSO_V6 | XMIT_CSUM_TCP);\n\t\t\tif (rc & XMIT_CSUM_ENC)\n\t\t\t\trc |= XMIT_GSO_ENC_V6;\n\t\t} else {\n\t\t\trc |= (XMIT_GSO_V4 | XMIT_CSUM_TCP);\n\t\t\tif (rc & XMIT_CSUM_ENC)\n\t\t\t\trc |= XMIT_GSO_ENC_V4;\n\t\t}\n\t}\n\n\treturn rc;\n}\n\n/* VXLAN: 4 = 1 (for linear data BD) + 3 (2 for PBD and last BD) */\n#define BNX2X_NUM_VXLAN_TSO_WIN_SUB_BDS         4\n\n/* Regular: 3 = 1 (for linear data BD) + 2 (for PBD and last BD) */\n#define BNX2X_NUM_TSO_WIN_SUB_BDS               3\n\n#if (MAX_SKB_FRAGS >= MAX_FETCH_BD - BDS_PER_TX_PKT)\n/* check if packet requires linearization (packet is too fragmented)\n   no need to check fragmentation if page size > 8K (there will be no\n   violation to FW restrictions) */\nstatic int bnx2x_pkt_req_lin(struct bnx2x *bp, struct sk_buff *skb,\n\t\t\t     u32 xmit_type)\n{\n\tint first_bd_sz = 0, num_tso_win_sub = BNX2X_NUM_TSO_WIN_SUB_BDS;\n\tint to_copy = 0, hlen = 0;\n\n\tif (xmit_type & XMIT_GSO_ENC)\n\t\tnum_tso_win_sub = BNX2X_NUM_VXLAN_TSO_WIN_SUB_BDS;\n\n\tif (skb_shinfo(skb)->nr_frags >= (MAX_FETCH_BD - num_tso_win_sub)) {\n\t\tif (xmit_type & XMIT_GSO) {\n\t\t\tunsigned short lso_mss = skb_shinfo(skb)->gso_size;\n\t\t\tint wnd_size = MAX_FETCH_BD - num_tso_win_sub;\n\t\t\t/* Number of windows to check */\n\t\t\tint num_wnds = skb_shinfo(skb)->nr_frags - wnd_size;\n\t\t\tint wnd_idx = 0;\n\t\t\tint frag_idx = 0;\n\t\t\tu32 wnd_sum = 0;\n\n\t\t\t/* Headers length */\n\t\t\tif (xmit_type & XMIT_GSO_ENC)\n\t\t\t\thlen = (int)(skb_inner_transport_header(skb) -\n\t\t\t\t\t     skb->data) +\n\t\t\t\t\t     inner_tcp_hdrlen(skb);\n\t\t\telse\n\t\t\t\thlen = (int)(skb_transport_header(skb) -\n\t\t\t\t\t     skb->data) + tcp_hdrlen(skb);\n\n\t\t\t/* Amount of data (w/o headers) on linear part of SKB*/\n\t\t\tfirst_bd_sz = skb_headlen(skb) - hlen;\n\n\t\t\twnd_sum  = first_bd_sz;\n\n\t\t\t/* Calculate the first sum - it's special */\n\t\t\tfor (frag_idx = 0; frag_idx < wnd_size - 1; frag_idx++)\n\t\t\t\twnd_sum +=\n\t\t\t\t\tskb_frag_size(&skb_shinfo(skb)->frags[frag_idx]);\n\n\t\t\t/* If there was data on linear skb data - check it */\n\t\t\tif (first_bd_sz > 0) {\n\t\t\t\tif (unlikely(wnd_sum < lso_mss)) {\n\t\t\t\t\tto_copy = 1;\n\t\t\t\t\tgoto exit_lbl;\n\t\t\t\t}\n\n\t\t\t\twnd_sum -= first_bd_sz;\n\t\t\t}\n\n\t\t\t/* Others are easier: run through the frag list and\n\t\t\t   check all windows */\n\t\t\tfor (wnd_idx = 0; wnd_idx <= num_wnds; wnd_idx++) {\n\t\t\t\twnd_sum +=\n\t\t\t  skb_frag_size(&skb_shinfo(skb)->frags[wnd_idx + wnd_size - 1]);\n\n\t\t\t\tif (unlikely(wnd_sum < lso_mss)) {\n\t\t\t\t\tto_copy = 1;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\twnd_sum -=\n\t\t\t\t\tskb_frag_size(&skb_shinfo(skb)->frags[wnd_idx]);\n\t\t\t}\n\t\t} else {\n\t\t\t/* in non-LSO too fragmented packet should always\n\t\t\t   be linearized */\n\t\t\tto_copy = 1;\n\t\t}\n\t}\n\nexit_lbl:\n\tif (unlikely(to_copy))\n\t\tDP(NETIF_MSG_TX_QUEUED,\n\t\t   \"Linearization IS REQUIRED for %s packet. num_frags %d  hlen %d  first_bd_sz %d\\n\",\n\t\t   (xmit_type & XMIT_GSO) ? \"LSO\" : \"non-LSO\",\n\t\t   skb_shinfo(skb)->nr_frags, hlen, first_bd_sz);\n\n\treturn to_copy;\n}\n#endif\n\n/**\n * bnx2x_set_pbd_gso - update PBD in GSO case.\n *\n * @skb:\tpacket skb\n * @pbd:\tparse BD\n * @xmit_type:\txmit flags\n */\nstatic void bnx2x_set_pbd_gso(struct sk_buff *skb,\n\t\t\t      struct eth_tx_parse_bd_e1x *pbd,\n\t\t\t      u32 xmit_type)\n{\n\tpbd->lso_mss = cpu_to_le16(skb_shinfo(skb)->gso_size);\n\tpbd->tcp_send_seq = bswab32(tcp_hdr(skb)->seq);\n\tpbd->tcp_flags = pbd_tcp_flags(tcp_hdr(skb));\n\n\tif (xmit_type & XMIT_GSO_V4) {\n\t\tpbd->ip_id = bswab16(ip_hdr(skb)->id);\n\t\tpbd->tcp_pseudo_csum =\n\t\t\tbswab16(~csum_tcpudp_magic(ip_hdr(skb)->saddr,\n\t\t\t\t\t\t   ip_hdr(skb)->daddr,\n\t\t\t\t\t\t   0, IPPROTO_TCP, 0));\n\t} else {\n\t\tpbd->tcp_pseudo_csum =\n\t\t\tbswab16(~csum_ipv6_magic(&ipv6_hdr(skb)->saddr,\n\t\t\t\t\t\t &ipv6_hdr(skb)->daddr,\n\t\t\t\t\t\t 0, IPPROTO_TCP, 0));\n\t}\n\n\tpbd->global_data |=\n\t\tcpu_to_le16(ETH_TX_PARSE_BD_E1X_PSEUDO_CS_WITHOUT_LEN);\n}\n\n/**\n * bnx2x_set_pbd_csum_enc - update PBD with checksum and return header length\n *\n * @bp:\t\t\tdriver handle\n * @skb:\t\tpacket skb\n * @parsing_data:\tdata to be updated\n * @xmit_type:\t\txmit flags\n *\n * 57712/578xx related, when skb has encapsulation\n */\nstatic u8 bnx2x_set_pbd_csum_enc(struct bnx2x *bp, struct sk_buff *skb,\n\t\t\t\t u32 *parsing_data, u32 xmit_type)\n{\n\t*parsing_data |=\n\t\t((((u8 *)skb_inner_transport_header(skb) - skb->data) >> 1) <<\n\t\tETH_TX_PARSE_BD_E2_L4_HDR_START_OFFSET_W_SHIFT) &\n\t\tETH_TX_PARSE_BD_E2_L4_HDR_START_OFFSET_W;\n\n\tif (xmit_type & XMIT_CSUM_TCP) {\n\t\t*parsing_data |= ((inner_tcp_hdrlen(skb) / 4) <<\n\t\t\tETH_TX_PARSE_BD_E2_TCP_HDR_LENGTH_DW_SHIFT) &\n\t\t\tETH_TX_PARSE_BD_E2_TCP_HDR_LENGTH_DW;\n\n\t\treturn skb_inner_transport_header(skb) +\n\t\t\tinner_tcp_hdrlen(skb) - skb->data;\n\t}\n\n\t/* We support checksum offload for TCP and UDP only.\n\t * No need to pass the UDP header length - it's a constant.\n\t */\n\treturn skb_inner_transport_header(skb) +\n\t\tsizeof(struct udphdr) - skb->data;\n}\n\n/**\n * bnx2x_set_pbd_csum_e2 - update PBD with checksum and return header length\n *\n * @bp:\t\t\tdriver handle\n * @skb:\t\tpacket skb\n * @parsing_data:\tdata to be updated\n * @xmit_type:\t\txmit flags\n *\n * 57712/578xx related\n */\nstatic u8 bnx2x_set_pbd_csum_e2(struct bnx2x *bp, struct sk_buff *skb,\n\t\t\t\tu32 *parsing_data, u32 xmit_type)\n{\n\t*parsing_data |=\n\t\t((((u8 *)skb_transport_header(skb) - skb->data) >> 1) <<\n\t\tETH_TX_PARSE_BD_E2_L4_HDR_START_OFFSET_W_SHIFT) &\n\t\tETH_TX_PARSE_BD_E2_L4_HDR_START_OFFSET_W;\n\n\tif (xmit_type & XMIT_CSUM_TCP) {\n\t\t*parsing_data |= ((tcp_hdrlen(skb) / 4) <<\n\t\t\tETH_TX_PARSE_BD_E2_TCP_HDR_LENGTH_DW_SHIFT) &\n\t\t\tETH_TX_PARSE_BD_E2_TCP_HDR_LENGTH_DW;\n\n\t\treturn skb_transport_header(skb) + tcp_hdrlen(skb) - skb->data;\n\t}\n\t/* We support checksum offload for TCP and UDP only.\n\t * No need to pass the UDP header length - it's a constant.\n\t */\n\treturn skb_transport_header(skb) + sizeof(struct udphdr) - skb->data;\n}\n\n/* set FW indication according to inner or outer protocols if tunneled */\nstatic void bnx2x_set_sbd_csum(struct bnx2x *bp, struct sk_buff *skb,\n\t\t\t       struct eth_tx_start_bd *tx_start_bd,\n\t\t\t       u32 xmit_type)\n{\n\ttx_start_bd->bd_flags.as_bitfield |= ETH_TX_BD_FLAGS_L4_CSUM;\n\n\tif (xmit_type & (XMIT_CSUM_ENC_V6 | XMIT_CSUM_V6))\n\t\ttx_start_bd->bd_flags.as_bitfield |= ETH_TX_BD_FLAGS_IPV6;\n\n\tif (!(xmit_type & XMIT_CSUM_TCP))\n\t\ttx_start_bd->bd_flags.as_bitfield |= ETH_TX_BD_FLAGS_IS_UDP;\n}\n\n/**\n * bnx2x_set_pbd_csum - update PBD with checksum and return header length\n *\n * @bp:\t\tdriver handle\n * @skb:\tpacket skb\n * @pbd:\tparse BD to be updated\n * @xmit_type:\txmit flags\n */\nstatic u8 bnx2x_set_pbd_csum(struct bnx2x *bp, struct sk_buff *skb,\n\t\t\t     struct eth_tx_parse_bd_e1x *pbd,\n\t\t\t     u32 xmit_type)\n{\n\tu8 hlen = (skb_network_header(skb) - skb->data) >> 1;\n\n\t/* for now NS flag is not used in Linux */\n\tpbd->global_data =\n\t\tcpu_to_le16(hlen |\n\t\t\t    ((skb->protocol == cpu_to_be16(ETH_P_8021Q)) <<\n\t\t\t     ETH_TX_PARSE_BD_E1X_LLC_SNAP_EN_SHIFT));\n\n\tpbd->ip_hlen_w = (skb_transport_header(skb) -\n\t\t\tskb_network_header(skb)) >> 1;\n\n\thlen += pbd->ip_hlen_w;\n\n\t/* We support checksum offload for TCP and UDP only */\n\tif (xmit_type & XMIT_CSUM_TCP)\n\t\thlen += tcp_hdrlen(skb) / 2;\n\telse\n\t\thlen += sizeof(struct udphdr) / 2;\n\n\tpbd->total_hlen_w = cpu_to_le16(hlen);\n\thlen = hlen*2;\n\n\tif (xmit_type & XMIT_CSUM_TCP) {\n\t\tpbd->tcp_pseudo_csum = bswab16(tcp_hdr(skb)->check);\n\n\t} else {\n\t\ts8 fix = SKB_CS_OFF(skb); /* signed! */\n\n\t\tDP(NETIF_MSG_TX_QUEUED,\n\t\t   \"hlen %d  fix %d  csum before fix %x\\n\",\n\t\t   le16_to_cpu(pbd->total_hlen_w), fix, SKB_CS(skb));\n\n\t\t/* HW bug: fixup the CSUM */\n\t\tpbd->tcp_pseudo_csum =\n\t\t\tbnx2x_csum_fix(skb_transport_header(skb),\n\t\t\t\t       SKB_CS(skb), fix);\n\n\t\tDP(NETIF_MSG_TX_QUEUED, \"csum after fix %x\\n\",\n\t\t   pbd->tcp_pseudo_csum);\n\t}\n\n\treturn hlen;\n}\n\nstatic void bnx2x_update_pbds_gso_enc(struct sk_buff *skb,\n\t\t\t\t      struct eth_tx_parse_bd_e2 *pbd_e2,\n\t\t\t\t      struct eth_tx_parse_2nd_bd *pbd2,\n\t\t\t\t      u16 *global_data,\n\t\t\t\t      u32 xmit_type)\n{\n\tu16 hlen_w = 0;\n\tu8 outerip_off, outerip_len = 0;\n\n\t/* from outer IP to transport */\n\thlen_w = (skb_inner_transport_header(skb) -\n\t\t  skb_network_header(skb)) >> 1;\n\n\t/* transport len */\n\thlen_w += inner_tcp_hdrlen(skb) >> 1;\n\n\tpbd2->fw_ip_hdr_to_payload_w = hlen_w;\n\n\t/* outer IP header info */\n\tif (xmit_type & XMIT_CSUM_V4) {\n\t\tstruct iphdr *iph = ip_hdr(skb);\n\t\tu32 csum = (__force u32)(~iph->check) -\n\t\t\t   (__force u32)iph->tot_len -\n\t\t\t   (__force u32)iph->frag_off;\n\n\t\touterip_len = iph->ihl << 1;\n\n\t\tpbd2->fw_ip_csum_wo_len_flags_frag =\n\t\t\tbswab16(csum_fold((__force __wsum)csum));\n\t} else {\n\t\tpbd2->fw_ip_hdr_to_payload_w =\n\t\t\thlen_w - ((sizeof(struct ipv6hdr)) >> 1);\n\t\tpbd_e2->data.tunnel_data.flags |=\n\t\t\tETH_TUNNEL_DATA_IPV6_OUTER;\n\t}\n\n\tpbd2->tcp_send_seq = bswab32(inner_tcp_hdr(skb)->seq);\n\n\tpbd2->tcp_flags = pbd_tcp_flags(inner_tcp_hdr(skb));\n\n\t/* inner IP header info */\n\tif (xmit_type & XMIT_CSUM_ENC_V4) {\n\t\tpbd2->hw_ip_id = bswab16(inner_ip_hdr(skb)->id);\n\n\t\tpbd_e2->data.tunnel_data.pseudo_csum =\n\t\t\tbswab16(~csum_tcpudp_magic(\n\t\t\t\t\tinner_ip_hdr(skb)->saddr,\n\t\t\t\t\tinner_ip_hdr(skb)->daddr,\n\t\t\t\t\t0, IPPROTO_TCP, 0));\n\t} else {\n\t\tpbd_e2->data.tunnel_data.pseudo_csum =\n\t\t\tbswab16(~csum_ipv6_magic(\n\t\t\t\t\t&inner_ipv6_hdr(skb)->saddr,\n\t\t\t\t\t&inner_ipv6_hdr(skb)->daddr,\n\t\t\t\t\t0, IPPROTO_TCP, 0));\n\t}\n\n\touterip_off = (skb_network_header(skb) - skb->data) >> 1;\n\n\t*global_data |=\n\t\touterip_off |\n\t\t(outerip_len <<\n\t\t\tETH_TX_PARSE_2ND_BD_IP_HDR_LEN_OUTER_W_SHIFT) |\n\t\t((skb->protocol == cpu_to_be16(ETH_P_8021Q)) <<\n\t\t\tETH_TX_PARSE_2ND_BD_LLC_SNAP_EN_SHIFT);\n\n\tif (ip_hdr(skb)->protocol == IPPROTO_UDP) {\n\t\tSET_FLAG(*global_data, ETH_TX_PARSE_2ND_BD_TUNNEL_UDP_EXIST, 1);\n\t\tpbd2->tunnel_udp_hdr_start_w = skb_transport_offset(skb) >> 1;\n\t}\n}\n\nstatic inline void bnx2x_set_ipv6_ext_e2(struct sk_buff *skb, u32 *parsing_data,\n\t\t\t\t\t u32 xmit_type)\n{\n\tstruct ipv6hdr *ipv6;\n\n\tif (!(xmit_type & (XMIT_GSO_ENC_V6 | XMIT_GSO_V6)))\n\t\treturn;\n\n\tif (xmit_type & XMIT_GSO_ENC_V6)\n\t\tipv6 = inner_ipv6_hdr(skb);\n\telse /* XMIT_GSO_V6 */\n\t\tipv6 = ipv6_hdr(skb);\n\n\tif (ipv6->nexthdr == NEXTHDR_IPV6)\n\t\t*parsing_data |= ETH_TX_PARSE_BD_E2_IPV6_WITH_EXT_HDR;\n}\n\n/* called with netif_tx_lock\n * bnx2x_tx_int() runs without netif_tx_lock unless it needs to call\n * netif_wake_queue()\n */\nnetdev_tx_t bnx2x_start_xmit(struct sk_buff *skb, struct net_device *dev)\n{\n\tstruct bnx2x *bp = netdev_priv(dev);\n\n\tstruct netdev_queue *txq;\n\tstruct bnx2x_fp_txdata *txdata;\n\tstruct sw_tx_bd *tx_buf;\n\tstruct eth_tx_start_bd *tx_start_bd, *first_bd;\n\tstruct eth_tx_bd *tx_data_bd, *total_pkt_bd = NULL;\n\tstruct eth_tx_parse_bd_e1x *pbd_e1x = NULL;\n\tstruct eth_tx_parse_bd_e2 *pbd_e2 = NULL;\n\tstruct eth_tx_parse_2nd_bd *pbd2 = NULL;\n\tu32 pbd_e2_parsing_data = 0;\n\tu16 pkt_prod, bd_prod;\n\tint nbd, txq_index;\n\tdma_addr_t mapping;\n\tu32 xmit_type = bnx2x_xmit_type(bp, skb);\n\tint i;\n\tu8 hlen = 0;\n\t__le16 pkt_size = 0;\n\tstruct ethhdr *eth;\n\tu8 mac_type = UNICAST_ADDRESS;\n\n#ifdef BNX2X_STOP_ON_ERROR\n\tif (unlikely(bp->panic))\n\t\treturn NETDEV_TX_BUSY;\n#endif\n\n\ttxq_index = skb_get_queue_mapping(skb);\n\ttxq = netdev_get_tx_queue(dev, txq_index);\n\n\tBUG_ON(txq_index >= MAX_ETH_TXQ_IDX(bp) + (CNIC_LOADED(bp) ? 1 : 0));\n\n\ttxdata = &bp->bnx2x_txq[txq_index];\n\n\t/* enable this debug print to view the transmission queue being used\n\tDP(NETIF_MSG_TX_QUEUED, \"indices: txq %d, fp %d, txdata %d\\n\",\n\t   txq_index, fp_index, txdata_index); */\n\n\t/* enable this debug print to view the transmission details\n\tDP(NETIF_MSG_TX_QUEUED,\n\t   \"transmitting packet cid %d fp index %d txdata_index %d tx_data ptr %p fp pointer %p\\n\",\n\t   txdata->cid, fp_index, txdata_index, txdata, fp); */\n\n\tif (unlikely(bnx2x_tx_avail(bp, txdata) <\n\t\t\tskb_shinfo(skb)->nr_frags +\n\t\t\tBDS_PER_TX_PKT +\n\t\t\tNEXT_CNT_PER_TX_PKT(MAX_BDS_PER_TX_PKT))) {\n\t\t/* Handle special storage cases separately */\n\t\tif (txdata->tx_ring_size == 0) {\n\t\t\tstruct bnx2x_eth_q_stats *q_stats =\n\t\t\t\tbnx2x_fp_qstats(bp, txdata->parent_fp);\n\t\t\tq_stats->driver_filtered_tx_pkt++;\n\t\t\tdev_kfree_skb(skb);\n\t\t\treturn NETDEV_TX_OK;\n\t\t}\n\t\tbnx2x_fp_qstats(bp, txdata->parent_fp)->driver_xoff++;\n\t\tnetif_tx_stop_queue(txq);\n\t\tBNX2X_ERR(\"BUG! Tx ring full when queue awake!\\n\");\n\n\t\treturn NETDEV_TX_BUSY;\n\t}\n\n\tDP(NETIF_MSG_TX_QUEUED,\n\t   \"queue[%d]: SKB: summed %x  protocol %x protocol(%x,%x) gso type %x  xmit_type %x len %d\\n\",\n\t   txq_index, skb->ip_summed, skb->protocol, ipv6_hdr(skb)->nexthdr,\n\t   ip_hdr(skb)->protocol, skb_shinfo(skb)->gso_type, xmit_type,\n\t   skb->len);\n\n\teth = (struct ethhdr *)skb->data;\n\n\t/* set flag according to packet type (UNICAST_ADDRESS is default)*/\n\tif (unlikely(is_multicast_ether_addr(eth->h_dest))) {\n\t\tif (is_broadcast_ether_addr(eth->h_dest))\n\t\t\tmac_type = BROADCAST_ADDRESS;\n\t\telse\n\t\t\tmac_type = MULTICAST_ADDRESS;\n\t}\n\n#if (MAX_SKB_FRAGS >= MAX_FETCH_BD - BDS_PER_TX_PKT)\n\t/* First, check if we need to linearize the skb (due to FW\n\t   restrictions). No need to check fragmentation if page size > 8K\n\t   (there will be no violation to FW restrictions) */\n\tif (bnx2x_pkt_req_lin(bp, skb, xmit_type)) {\n\t\t/* Statistics of linearization */\n\t\tbp->lin_cnt++;\n\t\tif (skb_linearize(skb) != 0) {\n\t\t\tDP(NETIF_MSG_TX_QUEUED,\n\t\t\t   \"SKB linearization failed - silently dropping this SKB\\n\");\n\t\t\tdev_kfree_skb_any(skb);\n\t\t\treturn NETDEV_TX_OK;\n\t\t}\n\t}\n#endif\n\t/* Map skb linear data for DMA */\n\tmapping = dma_map_single(&bp->pdev->dev, skb->data,\n\t\t\t\t skb_headlen(skb), DMA_TO_DEVICE);\n\tif (unlikely(dma_mapping_error(&bp->pdev->dev, mapping))) {\n\t\tDP(NETIF_MSG_TX_QUEUED,\n\t\t   \"SKB mapping failed - silently dropping this SKB\\n\");\n\t\tdev_kfree_skb_any(skb);\n\t\treturn NETDEV_TX_OK;\n\t}\n\t/*\n\tPlease read carefully. First we use one BD which we mark as start,\n\tthen we have a parsing info BD (used for TSO or xsum),\n\tand only then we have the rest of the TSO BDs.\n\t(don't forget to mark the last one as last,\n\tand to unmap only AFTER you write to the BD ...)\n\tAnd above all, all pdb sizes are in words - NOT DWORDS!\n\t*/\n\n\t/* get current pkt produced now - advance it just before sending packet\n\t * since mapping of pages may fail and cause packet to be dropped\n\t */\n\tpkt_prod = txdata->tx_pkt_prod;\n\tbd_prod = TX_BD(txdata->tx_bd_prod);\n\n\t/* get a tx_buf and first BD\n\t * tx_start_bd may be changed during SPLIT,\n\t * but first_bd will always stay first\n\t */\n\ttx_buf = &txdata->tx_buf_ring[TX_BD(pkt_prod)];\n\ttx_start_bd = &txdata->tx_desc_ring[bd_prod].start_bd;\n\tfirst_bd = tx_start_bd;\n\n\ttx_start_bd->bd_flags.as_bitfield = ETH_TX_BD_FLAGS_START_BD;\n\n\tif (unlikely(skb_shinfo(skb)->tx_flags & SKBTX_HW_TSTAMP)) {\n\t\tif (!(bp->flags & TX_TIMESTAMPING_EN)) {\n\t\t\tbp->eth_stats.ptp_skip_tx_ts++;\n\t\t\tBNX2X_ERR(\"Tx timestamping was not enabled, this packet will not be timestamped\\n\");\n\t\t} else if (bp->ptp_tx_skb) {\n\t\t\tbp->eth_stats.ptp_skip_tx_ts++;\n\t\t\tnetdev_err_once(bp->dev,\n\t\t\t\t\t\"Device supports only a single outstanding packet to timestamp, this packet won't be timestamped\\n\");\n\t\t} else {\n\t\t\tskb_shinfo(skb)->tx_flags |= SKBTX_IN_PROGRESS;\n\t\t\t/* schedule check for Tx timestamp */\n\t\t\tbp->ptp_tx_skb = skb_get(skb);\n\t\t\tbp->ptp_tx_start = jiffies;\n\t\t\tschedule_work(&bp->ptp_task);\n\t\t}\n\t}\n\n\t/* header nbd: indirectly zero other flags! */\n\ttx_start_bd->general_data = 1 << ETH_TX_START_BD_HDR_NBDS_SHIFT;\n\n\t/* remember the first BD of the packet */\n\ttx_buf->first_bd = txdata->tx_bd_prod;\n\ttx_buf->skb = skb;\n\ttx_buf->flags = 0;\n\n\tDP(NETIF_MSG_TX_QUEUED,\n\t   \"sending pkt %u @%p  next_idx %u  bd %u @%p\\n\",\n\t   pkt_prod, tx_buf, txdata->tx_pkt_prod, bd_prod, tx_start_bd);\n\n\tif (skb_vlan_tag_present(skb)) {\n\t\ttx_start_bd->vlan_or_ethertype =\n\t\t    cpu_to_le16(skb_vlan_tag_get(skb));\n\t\ttx_start_bd->bd_flags.as_bitfield |=\n\t\t    (X_ETH_OUTBAND_VLAN << ETH_TX_BD_FLAGS_VLAN_MODE_SHIFT);\n\t} else {\n\t\t/* when transmitting in a vf, start bd must hold the ethertype\n\t\t * for fw to enforce it\n\t\t */\n\t\tu16 vlan_tci = 0;\n#ifndef BNX2X_STOP_ON_ERROR\n\t\tif (IS_VF(bp)) {\n#endif\n\t\t\t/* Still need to consider inband vlan for enforced */\n\t\t\tif (__vlan_get_tag(skb, &vlan_tci)) {\n\t\t\t\ttx_start_bd->vlan_or_ethertype =\n\t\t\t\t\tcpu_to_le16(ntohs(eth->h_proto));\n\t\t\t} else {\n\t\t\t\ttx_start_bd->bd_flags.as_bitfield |=\n\t\t\t\t\t(X_ETH_INBAND_VLAN <<\n\t\t\t\t\t ETH_TX_BD_FLAGS_VLAN_MODE_SHIFT);\n\t\t\t\ttx_start_bd->vlan_or_ethertype =\n\t\t\t\t\tcpu_to_le16(vlan_tci);\n\t\t\t}\n#ifndef BNX2X_STOP_ON_ERROR\n\t\t} else {\n\t\t\t/* used by FW for packet accounting */\n\t\t\ttx_start_bd->vlan_or_ethertype = cpu_to_le16(pkt_prod);\n\t\t}\n#endif\n\t}\n\n\tnbd = 2; /* start_bd + pbd + frags (updated when pages are mapped) */\n\n\t/* turn on parsing and get a BD */\n\tbd_prod = TX_BD(NEXT_TX_IDX(bd_prod));\n\n\tif (xmit_type & XMIT_CSUM)\n\t\tbnx2x_set_sbd_csum(bp, skb, tx_start_bd, xmit_type);\n\n\tif (!CHIP_IS_E1x(bp)) {\n\t\tpbd_e2 = &txdata->tx_desc_ring[bd_prod].parse_bd_e2;\n\t\tmemset(pbd_e2, 0, sizeof(struct eth_tx_parse_bd_e2));\n\n\t\tif (xmit_type & XMIT_CSUM_ENC) {\n\t\t\tu16 global_data = 0;\n\n\t\t\t/* Set PBD in enc checksum offload case */\n\t\t\thlen = bnx2x_set_pbd_csum_enc(bp, skb,\n\t\t\t\t\t\t      &pbd_e2_parsing_data,\n\t\t\t\t\t\t      xmit_type);\n\n\t\t\t/* turn on 2nd parsing and get a BD */\n\t\t\tbd_prod = TX_BD(NEXT_TX_IDX(bd_prod));\n\n\t\t\tpbd2 = &txdata->tx_desc_ring[bd_prod].parse_2nd_bd;\n\n\t\t\tmemset(pbd2, 0, sizeof(*pbd2));\n\n\t\t\tpbd_e2->data.tunnel_data.ip_hdr_start_inner_w =\n\t\t\t\t(skb_inner_network_header(skb) -\n\t\t\t\t skb->data) >> 1;\n\n\t\t\tif (xmit_type & XMIT_GSO_ENC)\n\t\t\t\tbnx2x_update_pbds_gso_enc(skb, pbd_e2, pbd2,\n\t\t\t\t\t\t\t  &global_data,\n\t\t\t\t\t\t\t  xmit_type);\n\n\t\t\tpbd2->global_data = cpu_to_le16(global_data);\n\n\t\t\t/* add addition parse BD indication to start BD */\n\t\t\tSET_FLAG(tx_start_bd->general_data,\n\t\t\t\t ETH_TX_START_BD_PARSE_NBDS, 1);\n\t\t\t/* set encapsulation flag in start BD */\n\t\t\tSET_FLAG(tx_start_bd->general_data,\n\t\t\t\t ETH_TX_START_BD_TUNNEL_EXIST, 1);\n\n\t\t\ttx_buf->flags |= BNX2X_HAS_SECOND_PBD;\n\n\t\t\tnbd++;\n\t\t} else if (xmit_type & XMIT_CSUM) {\n\t\t\t/* Set PBD in checksum offload case w/o encapsulation */\n\t\t\thlen = bnx2x_set_pbd_csum_e2(bp, skb,\n\t\t\t\t\t\t     &pbd_e2_parsing_data,\n\t\t\t\t\t\t     xmit_type);\n\t\t}\n\n\t\tbnx2x_set_ipv6_ext_e2(skb, &pbd_e2_parsing_data, xmit_type);\n\t\t/* Add the macs to the parsing BD if this is a vf or if\n\t\t * Tx Switching is enabled.\n\t\t */\n\t\tif (IS_VF(bp)) {\n\t\t\t/* override GRE parameters in BD */\n\t\t\tbnx2x_set_fw_mac_addr(&pbd_e2->data.mac_addr.src_hi,\n\t\t\t\t\t      &pbd_e2->data.mac_addr.src_mid,\n\t\t\t\t\t      &pbd_e2->data.mac_addr.src_lo,\n\t\t\t\t\t      eth->h_source);\n\n\t\t\tbnx2x_set_fw_mac_addr(&pbd_e2->data.mac_addr.dst_hi,\n\t\t\t\t\t      &pbd_e2->data.mac_addr.dst_mid,\n\t\t\t\t\t      &pbd_e2->data.mac_addr.dst_lo,\n\t\t\t\t\t      eth->h_dest);\n\t\t} else {\n\t\t\tif (bp->flags & TX_SWITCHING)\n\t\t\t\tbnx2x_set_fw_mac_addr(\n\t\t\t\t\t\t&pbd_e2->data.mac_addr.dst_hi,\n\t\t\t\t\t\t&pbd_e2->data.mac_addr.dst_mid,\n\t\t\t\t\t\t&pbd_e2->data.mac_addr.dst_lo,\n\t\t\t\t\t\teth->h_dest);\n#ifdef BNX2X_STOP_ON_ERROR\n\t\t\t/* Enforce security is always set in Stop on Error -\n\t\t\t * source mac should be present in the parsing BD\n\t\t\t */\n\t\t\tbnx2x_set_fw_mac_addr(&pbd_e2->data.mac_addr.src_hi,\n\t\t\t\t\t      &pbd_e2->data.mac_addr.src_mid,\n\t\t\t\t\t      &pbd_e2->data.mac_addr.src_lo,\n\t\t\t\t\t      eth->h_source);\n#endif\n\t\t}\n\n\t\tSET_FLAG(pbd_e2_parsing_data,\n\t\t\t ETH_TX_PARSE_BD_E2_ETH_ADDR_TYPE, mac_type);\n\t} else {\n\t\tu16 global_data = 0;\n\t\tpbd_e1x = &txdata->tx_desc_ring[bd_prod].parse_bd_e1x;\n\t\tmemset(pbd_e1x, 0, sizeof(struct eth_tx_parse_bd_e1x));\n\t\t/* Set PBD in checksum offload case */\n\t\tif (xmit_type & XMIT_CSUM)\n\t\t\thlen = bnx2x_set_pbd_csum(bp, skb, pbd_e1x, xmit_type);\n\n\t\tSET_FLAG(global_data,\n\t\t\t ETH_TX_PARSE_BD_E1X_ETH_ADDR_TYPE, mac_type);\n\t\tpbd_e1x->global_data |= cpu_to_le16(global_data);\n\t}\n\n\t/* Setup the data pointer of the first BD of the packet */\n\ttx_start_bd->addr_hi = cpu_to_le32(U64_HI(mapping));\n\ttx_start_bd->addr_lo = cpu_to_le32(U64_LO(mapping));\n\ttx_start_bd->nbytes = cpu_to_le16(skb_headlen(skb));\n\tpkt_size = tx_start_bd->nbytes;\n\n\tDP(NETIF_MSG_TX_QUEUED,\n\t   \"first bd @%p  addr (%x:%x)  nbytes %d  flags %x  vlan %x\\n\",\n\t   tx_start_bd, tx_start_bd->addr_hi, tx_start_bd->addr_lo,\n\t   le16_to_cpu(tx_start_bd->nbytes),\n\t   tx_start_bd->bd_flags.as_bitfield,\n\t   le16_to_cpu(tx_start_bd->vlan_or_ethertype));\n\n\tif (xmit_type & XMIT_GSO) {\n\n\t\tDP(NETIF_MSG_TX_QUEUED,\n\t\t   \"TSO packet len %d  hlen %d  total len %d  tso size %d\\n\",\n\t\t   skb->len, hlen, skb_headlen(skb),\n\t\t   skb_shinfo(skb)->gso_size);\n\n\t\ttx_start_bd->bd_flags.as_bitfield |= ETH_TX_BD_FLAGS_SW_LSO;\n\n\t\tif (unlikely(skb_headlen(skb) > hlen)) {\n\t\t\tnbd++;\n\t\t\tbd_prod = bnx2x_tx_split(bp, txdata, tx_buf,\n\t\t\t\t\t\t &tx_start_bd, hlen,\n\t\t\t\t\t\t bd_prod);\n\t\t}\n\t\tif (!CHIP_IS_E1x(bp))\n\t\t\tpbd_e2_parsing_data |=\n\t\t\t\t(skb_shinfo(skb)->gso_size <<\n\t\t\t\t ETH_TX_PARSE_BD_E2_LSO_MSS_SHIFT) &\n\t\t\t\t ETH_TX_PARSE_BD_E2_LSO_MSS;\n\t\telse\n\t\t\tbnx2x_set_pbd_gso(skb, pbd_e1x, xmit_type);\n\t}\n\n\t/* Set the PBD's parsing_data field if not zero\n\t * (for the chips newer than 57711).\n\t */\n\tif (pbd_e2_parsing_data)\n\t\tpbd_e2->parsing_data = cpu_to_le32(pbd_e2_parsing_data);\n\n\ttx_data_bd = (struct eth_tx_bd *)tx_start_bd;\n\n\t/* Handle fragmented skb */\n\tfor (i = 0; i < skb_shinfo(skb)->nr_frags; i++) {\n\t\tskb_frag_t *frag = &skb_shinfo(skb)->frags[i];\n\n\t\tmapping = skb_frag_dma_map(&bp->pdev->dev, frag, 0,\n\t\t\t\t\t   skb_frag_size(frag), DMA_TO_DEVICE);\n\t\tif (unlikely(dma_mapping_error(&bp->pdev->dev, mapping))) {\n\t\t\tunsigned int pkts_compl = 0, bytes_compl = 0;\n\n\t\t\tDP(NETIF_MSG_TX_QUEUED,\n\t\t\t   \"Unable to map page - dropping packet...\\n\");\n\n\t\t\t/* we need unmap all buffers already mapped\n\t\t\t * for this SKB;\n\t\t\t * first_bd->nbd need to be properly updated\n\t\t\t * before call to bnx2x_free_tx_pkt\n\t\t\t */\n\t\t\tfirst_bd->nbd = cpu_to_le16(nbd);\n\t\t\tbnx2x_free_tx_pkt(bp, txdata,\n\t\t\t\t\t  TX_BD(txdata->tx_pkt_prod),\n\t\t\t\t\t  &pkts_compl, &bytes_compl);\n\t\t\treturn NETDEV_TX_OK;\n\t\t}\n\n\t\tbd_prod = TX_BD(NEXT_TX_IDX(bd_prod));\n\t\ttx_data_bd = &txdata->tx_desc_ring[bd_prod].reg_bd;\n\t\tif (total_pkt_bd == NULL)\n\t\t\ttotal_pkt_bd = &txdata->tx_desc_ring[bd_prod].reg_bd;\n\n\t\ttx_data_bd->addr_hi = cpu_to_le32(U64_HI(mapping));\n\t\ttx_data_bd->addr_lo = cpu_to_le32(U64_LO(mapping));\n\t\ttx_data_bd->nbytes = cpu_to_le16(skb_frag_size(frag));\n\t\tle16_add_cpu(&pkt_size, skb_frag_size(frag));\n\t\tnbd++;\n\n\t\tDP(NETIF_MSG_TX_QUEUED,\n\t\t   \"frag %d  bd @%p  addr (%x:%x)  nbytes %d\\n\",\n\t\t   i, tx_data_bd, tx_data_bd->addr_hi, tx_data_bd->addr_lo,\n\t\t   le16_to_cpu(tx_data_bd->nbytes));\n\t}\n\n\tDP(NETIF_MSG_TX_QUEUED, \"last bd @%p\\n\", tx_data_bd);\n\n\t/* update with actual num BDs */\n\tfirst_bd->nbd = cpu_to_le16(nbd);\n\n\tbd_prod = TX_BD(NEXT_TX_IDX(bd_prod));\n\n\t/* now send a tx doorbell, counting the next BD\n\t * if the packet contains or ends with it\n\t */\n\tif (TX_BD_POFF(bd_prod) < nbd)\n\t\tnbd++;\n\n\t/* total_pkt_bytes should be set on the first data BD if\n\t * it's not an LSO packet and there is more than one\n\t * data BD. In this case pkt_size is limited by an MTU value.\n\t * However we prefer to set it for an LSO packet (while we don't\n\t * have to) in order to save some CPU cycles in a none-LSO\n\t * case, when we much more care about them.\n\t */\n\tif (total_pkt_bd != NULL)\n\t\ttotal_pkt_bd->total_pkt_bytes = pkt_size;\n\n\tif (pbd_e1x)\n\t\tDP(NETIF_MSG_TX_QUEUED,\n\t\t   \"PBD (E1X) @%p  ip_data %x  ip_hlen %u  ip_id %u  lso_mss %u  tcp_flags %x  xsum %x  seq %u  hlen %u\\n\",\n\t\t   pbd_e1x, pbd_e1x->global_data, pbd_e1x->ip_hlen_w,\n\t\t   pbd_e1x->ip_id, pbd_e1x->lso_mss, pbd_e1x->tcp_flags,\n\t\t   pbd_e1x->tcp_pseudo_csum, pbd_e1x->tcp_send_seq,\n\t\t    le16_to_cpu(pbd_e1x->total_hlen_w));\n\tif (pbd_e2)\n\t\tDP(NETIF_MSG_TX_QUEUED,\n\t\t   \"PBD (E2) @%p  dst %x %x %x src %x %x %x parsing_data %x\\n\",\n\t\t   pbd_e2,\n\t\t   pbd_e2->data.mac_addr.dst_hi,\n\t\t   pbd_e2->data.mac_addr.dst_mid,\n\t\t   pbd_e2->data.mac_addr.dst_lo,\n\t\t   pbd_e2->data.mac_addr.src_hi,\n\t\t   pbd_e2->data.mac_addr.src_mid,\n\t\t   pbd_e2->data.mac_addr.src_lo,\n\t\t   pbd_e2->parsing_data);\n\tDP(NETIF_MSG_TX_QUEUED, \"doorbell: nbd %d  bd %u\\n\", nbd, bd_prod);\n\n\tnetdev_tx_sent_queue(txq, skb->len);\n\n\tskb_tx_timestamp(skb);\n\n\ttxdata->tx_pkt_prod++;\n\t/*\n\t * Make sure that the BD data is updated before updating the producer\n\t * since FW might read the BD right after the producer is updated.\n\t * This is only applicable for weak-ordered memory model archs such\n\t * as IA-64. The following barrier is also mandatory since FW will\n\t * assumes packets must have BDs.\n\t */\n\twmb();\n\n\ttxdata->tx_db.data.prod += nbd;\n\t/* make sure descriptor update is observed by HW */\n\twmb();\n\n\tDOORBELL_RELAXED(bp, txdata->cid, txdata->tx_db.raw);\n\n\ttxdata->tx_bd_prod += nbd;\n\n\tif (unlikely(bnx2x_tx_avail(bp, txdata) < MAX_DESC_PER_TX_PKT)) {\n\t\tnetif_tx_stop_queue(txq);\n\n\t\t/* paired memory barrier is in bnx2x_tx_int(), we have to keep\n\t\t * ordering of set_bit() in netif_tx_stop_queue() and read of\n\t\t * fp->bd_tx_cons */\n\t\tsmp_mb();\n\n\t\tbnx2x_fp_qstats(bp, txdata->parent_fp)->driver_xoff++;\n\t\tif (bnx2x_tx_avail(bp, txdata) >= MAX_DESC_PER_TX_PKT)\n\t\t\tnetif_tx_wake_queue(txq);\n\t}\n\ttxdata->tx_pkt++;\n\n\treturn NETDEV_TX_OK;\n}\n\nvoid bnx2x_get_c2s_mapping(struct bnx2x *bp, u8 *c2s_map, u8 *c2s_default)\n{\n\tint mfw_vn = BP_FW_MB_IDX(bp);\n\tu32 tmp;\n\n\t/* If the shmem shouldn't affect configuration, reflect */\n\tif (!IS_MF_BD(bp)) {\n\t\tint i;\n\n\t\tfor (i = 0; i < BNX2X_MAX_PRIORITY; i++)\n\t\t\tc2s_map[i] = i;\n\t\t*c2s_default = 0;\n\n\t\treturn;\n\t}\n\n\ttmp = SHMEM2_RD(bp, c2s_pcp_map_lower[mfw_vn]);\n\ttmp = (__force u32)be32_to_cpu((__force __be32)tmp);\n\tc2s_map[0] = tmp & 0xff;\n\tc2s_map[1] = (tmp >> 8) & 0xff;\n\tc2s_map[2] = (tmp >> 16) & 0xff;\n\tc2s_map[3] = (tmp >> 24) & 0xff;\n\n\ttmp = SHMEM2_RD(bp, c2s_pcp_map_upper[mfw_vn]);\n\ttmp = (__force u32)be32_to_cpu((__force __be32)tmp);\n\tc2s_map[4] = tmp & 0xff;\n\tc2s_map[5] = (tmp >> 8) & 0xff;\n\tc2s_map[6] = (tmp >> 16) & 0xff;\n\tc2s_map[7] = (tmp >> 24) & 0xff;\n\n\ttmp = SHMEM2_RD(bp, c2s_pcp_map_default[mfw_vn]);\n\ttmp = (__force u32)be32_to_cpu((__force __be32)tmp);\n\t*c2s_default = (tmp >> (8 * mfw_vn)) & 0xff;\n}\n\n/**\n * bnx2x_setup_tc - routine to configure net_device for multi tc\n *\n * @dev: net device to configure\n * @num_tc: number of traffic classes to enable\n *\n * callback connected to the ndo_setup_tc function pointer\n */\nint bnx2x_setup_tc(struct net_device *dev, u8 num_tc)\n{\n\tstruct bnx2x *bp = netdev_priv(dev);\n\tu8 c2s_map[BNX2X_MAX_PRIORITY], c2s_def;\n\tint cos, prio, count, offset;\n\n\t/* setup tc must be called under rtnl lock */\n\tASSERT_RTNL();\n\n\t/* no traffic classes requested. Aborting */\n\tif (!num_tc) {\n\t\tnetdev_reset_tc(dev);\n\t\treturn 0;\n\t}\n\n\t/* requested to support too many traffic classes */\n\tif (num_tc > bp->max_cos) {\n\t\tBNX2X_ERR(\"support for too many traffic classes requested: %d. Max supported is %d\\n\",\n\t\t\t  num_tc, bp->max_cos);\n\t\treturn -EINVAL;\n\t}\n\n\t/* declare amount of supported traffic classes */\n\tif (netdev_set_num_tc(dev, num_tc)) {\n\t\tBNX2X_ERR(\"failed to declare %d traffic classes\\n\", num_tc);\n\t\treturn -EINVAL;\n\t}\n\n\tbnx2x_get_c2s_mapping(bp, c2s_map, &c2s_def);\n\n\t/* configure priority to traffic class mapping */\n\tfor (prio = 0; prio < BNX2X_MAX_PRIORITY; prio++) {\n\t\tint outer_prio = c2s_map[prio];\n\n\t\tnetdev_set_prio_tc_map(dev, prio, bp->prio_to_cos[outer_prio]);\n\t\tDP(BNX2X_MSG_SP | NETIF_MSG_IFUP,\n\t\t   \"mapping priority %d to tc %d\\n\",\n\t\t   outer_prio, bp->prio_to_cos[outer_prio]);\n\t}\n\n\t/* Use this configuration to differentiate tc0 from other COSes\n\t   This can be used for ets or pfc, and save the effort of setting\n\t   up a multio class queue disc or negotiating DCBX with a switch\n\tnetdev_set_prio_tc_map(dev, 0, 0);\n\tDP(BNX2X_MSG_SP, \"mapping priority %d to tc %d\\n\", 0, 0);\n\tfor (prio = 1; prio < 16; prio++) {\n\t\tnetdev_set_prio_tc_map(dev, prio, 1);\n\t\tDP(BNX2X_MSG_SP, \"mapping priority %d to tc %d\\n\", prio, 1);\n\t} */\n\n\t/* configure traffic class to transmission queue mapping */\n\tfor (cos = 0; cos < bp->max_cos; cos++) {\n\t\tcount = BNX2X_NUM_ETH_QUEUES(bp);\n\t\toffset = cos * BNX2X_NUM_NON_CNIC_QUEUES(bp);\n\t\tnetdev_set_tc_queue(dev, cos, count, offset);\n\t\tDP(BNX2X_MSG_SP | NETIF_MSG_IFUP,\n\t\t   \"mapping tc %d to offset %d count %d\\n\",\n\t\t   cos, offset, count);\n\t}\n\n\treturn 0;\n}\n\nint __bnx2x_setup_tc(struct net_device *dev, enum tc_setup_type type,\n\t\t     void *type_data)\n{\n\tstruct tc_mqprio_qopt *mqprio = type_data;\n\n\tif (type != TC_SETUP_QDISC_MQPRIO)\n\t\treturn -EOPNOTSUPP;\n\n\tmqprio->hw = TC_MQPRIO_HW_OFFLOAD_TCS;\n\n\treturn bnx2x_setup_tc(dev, mqprio->num_tc);\n}\n\n/* called with rtnl_lock */\nint bnx2x_change_mac_addr(struct net_device *dev, void *p)\n{\n\tstruct sockaddr *addr = p;\n\tstruct bnx2x *bp = netdev_priv(dev);\n\tint rc = 0;\n\n\tif (!is_valid_ether_addr(addr->sa_data)) {\n\t\tBNX2X_ERR(\"Requested MAC address is not valid\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (IS_MF_STORAGE_ONLY(bp)) {\n\t\tBNX2X_ERR(\"Can't change address on STORAGE ONLY function\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (netif_running(dev))  {\n\t\trc = bnx2x_set_eth_mac(bp, false);\n\t\tif (rc)\n\t\t\treturn rc;\n\t}\n\n\tmemcpy(dev->dev_addr, addr->sa_data, dev->addr_len);\n\n\tif (netif_running(dev))\n\t\trc = bnx2x_set_eth_mac(bp, true);\n\n\tif (IS_PF(bp) && SHMEM2_HAS(bp, curr_cfg))\n\t\tSHMEM2_WR(bp, curr_cfg, CURR_CFG_MET_OS);\n\n\treturn rc;\n}\n\nstatic void bnx2x_free_fp_mem_at(struct bnx2x *bp, int fp_index)\n{\n\tunion host_hc_status_block *sb = &bnx2x_fp(bp, fp_index, status_blk);\n\tstruct bnx2x_fastpath *fp = &bp->fp[fp_index];\n\tu8 cos;\n\n\t/* Common */\n\n\tif (IS_FCOE_IDX(fp_index)) {\n\t\tmemset(sb, 0, sizeof(union host_hc_status_block));\n\t\tfp->status_blk_mapping = 0;\n\t} else {\n\t\t/* status blocks */\n\t\tif (!CHIP_IS_E1x(bp))\n\t\t\tBNX2X_PCI_FREE(sb->e2_sb,\n\t\t\t\t       bnx2x_fp(bp, fp_index,\n\t\t\t\t\t\tstatus_blk_mapping),\n\t\t\t\t       sizeof(struct host_hc_status_block_e2));\n\t\telse\n\t\t\tBNX2X_PCI_FREE(sb->e1x_sb,\n\t\t\t\t       bnx2x_fp(bp, fp_index,\n\t\t\t\t\t\tstatus_blk_mapping),\n\t\t\t\t       sizeof(struct host_hc_status_block_e1x));\n\t}\n\n\t/* Rx */\n\tif (!skip_rx_queue(bp, fp_index)) {\n\t\tbnx2x_free_rx_bds(fp);\n\n\t\t/* fastpath rx rings: rx_buf rx_desc rx_comp */\n\t\tBNX2X_FREE(bnx2x_fp(bp, fp_index, rx_buf_ring));\n\t\tBNX2X_PCI_FREE(bnx2x_fp(bp, fp_index, rx_desc_ring),\n\t\t\t       bnx2x_fp(bp, fp_index, rx_desc_mapping),\n\t\t\t       sizeof(struct eth_rx_bd) * NUM_RX_BD);\n\n\t\tBNX2X_PCI_FREE(bnx2x_fp(bp, fp_index, rx_comp_ring),\n\t\t\t       bnx2x_fp(bp, fp_index, rx_comp_mapping),\n\t\t\t       sizeof(struct eth_fast_path_rx_cqe) *\n\t\t\t       NUM_RCQ_BD);\n\n\t\t/* SGE ring */\n\t\tBNX2X_FREE(bnx2x_fp(bp, fp_index, rx_page_ring));\n\t\tBNX2X_PCI_FREE(bnx2x_fp(bp, fp_index, rx_sge_ring),\n\t\t\t       bnx2x_fp(bp, fp_index, rx_sge_mapping),\n\t\t\t       BCM_PAGE_SIZE * NUM_RX_SGE_PAGES);\n\t}\n\n\t/* Tx */\n\tif (!skip_tx_queue(bp, fp_index)) {\n\t\t/* fastpath tx rings: tx_buf tx_desc */\n\t\tfor_each_cos_in_tx_queue(fp, cos) {\n\t\t\tstruct bnx2x_fp_txdata *txdata = fp->txdata_ptr[cos];\n\n\t\t\tDP(NETIF_MSG_IFDOWN,\n\t\t\t   \"freeing tx memory of fp %d cos %d cid %d\\n\",\n\t\t\t   fp_index, cos, txdata->cid);\n\n\t\t\tBNX2X_FREE(txdata->tx_buf_ring);\n\t\t\tBNX2X_PCI_FREE(txdata->tx_desc_ring,\n\t\t\t\ttxdata->tx_desc_mapping,\n\t\t\t\tsizeof(union eth_tx_bd_types) * NUM_TX_BD);\n\t\t}\n\t}\n\t/* end of fastpath */\n}\n\nstatic void bnx2x_free_fp_mem_cnic(struct bnx2x *bp)\n{\n\tint i;\n\tfor_each_cnic_queue(bp, i)\n\t\tbnx2x_free_fp_mem_at(bp, i);\n}\n\nvoid bnx2x_free_fp_mem(struct bnx2x *bp)\n{\n\tint i;\n\tfor_each_eth_queue(bp, i)\n\t\tbnx2x_free_fp_mem_at(bp, i);\n}\n\nstatic void set_sb_shortcuts(struct bnx2x *bp, int index)\n{\n\tunion host_hc_status_block status_blk = bnx2x_fp(bp, index, status_blk);\n\tif (!CHIP_IS_E1x(bp)) {\n\t\tbnx2x_fp(bp, index, sb_index_values) =\n\t\t\t(__le16 *)status_blk.e2_sb->sb.index_values;\n\t\tbnx2x_fp(bp, index, sb_running_index) =\n\t\t\t(__le16 *)status_blk.e2_sb->sb.running_index;\n\t} else {\n\t\tbnx2x_fp(bp, index, sb_index_values) =\n\t\t\t(__le16 *)status_blk.e1x_sb->sb.index_values;\n\t\tbnx2x_fp(bp, index, sb_running_index) =\n\t\t\t(__le16 *)status_blk.e1x_sb->sb.running_index;\n\t}\n}\n\n/* Returns the number of actually allocated BDs */\nstatic int bnx2x_alloc_rx_bds(struct bnx2x_fastpath *fp,\n\t\t\t      int rx_ring_size)\n{\n\tstruct bnx2x *bp = fp->bp;\n\tu16 ring_prod, cqe_ring_prod;\n\tint i, failure_cnt = 0;\n\n\tfp->rx_comp_cons = 0;\n\tcqe_ring_prod = ring_prod = 0;\n\n\t/* This routine is called only during fo init so\n\t * fp->eth_q_stats.rx_skb_alloc_failed = 0\n\t */\n\tfor (i = 0; i < rx_ring_size; i++) {\n\t\tif (bnx2x_alloc_rx_data(bp, fp, ring_prod, GFP_KERNEL) < 0) {\n\t\t\tfailure_cnt++;\n\t\t\tcontinue;\n\t\t}\n\t\tring_prod = NEXT_RX_IDX(ring_prod);\n\t\tcqe_ring_prod = NEXT_RCQ_IDX(cqe_ring_prod);\n\t\tWARN_ON(ring_prod <= (i - failure_cnt));\n\t}\n\n\tif (failure_cnt)\n\t\tBNX2X_ERR(\"was only able to allocate %d rx skbs on queue[%d]\\n\",\n\t\t\t  i - failure_cnt, fp->index);\n\n\tfp->rx_bd_prod = ring_prod;\n\t/* Limit the CQE producer by the CQE ring size */\n\tfp->rx_comp_prod = min_t(u16, NUM_RCQ_RINGS*RCQ_DESC_CNT,\n\t\t\t       cqe_ring_prod);\n\n\tbnx2x_fp_stats(bp, fp)->eth_q_stats.rx_skb_alloc_failed += failure_cnt;\n\n\treturn i - failure_cnt;\n}\n\nstatic void bnx2x_set_next_page_rx_cq(struct bnx2x_fastpath *fp)\n{\n\tint i;\n\n\tfor (i = 1; i <= NUM_RCQ_RINGS; i++) {\n\t\tstruct eth_rx_cqe_next_page *nextpg;\n\n\t\tnextpg = (struct eth_rx_cqe_next_page *)\n\t\t\t&fp->rx_comp_ring[RCQ_DESC_CNT * i - 1];\n\t\tnextpg->addr_hi =\n\t\t\tcpu_to_le32(U64_HI(fp->rx_comp_mapping +\n\t\t\t\t   BCM_PAGE_SIZE*(i % NUM_RCQ_RINGS)));\n\t\tnextpg->addr_lo =\n\t\t\tcpu_to_le32(U64_LO(fp->rx_comp_mapping +\n\t\t\t\t   BCM_PAGE_SIZE*(i % NUM_RCQ_RINGS)));\n\t}\n}\n\nstatic int bnx2x_alloc_fp_mem_at(struct bnx2x *bp, int index)\n{\n\tunion host_hc_status_block *sb;\n\tstruct bnx2x_fastpath *fp = &bp->fp[index];\n\tint ring_size = 0;\n\tu8 cos;\n\tint rx_ring_size = 0;\n\n\tif (!bp->rx_ring_size && IS_MF_STORAGE_ONLY(bp)) {\n\t\trx_ring_size = MIN_RX_SIZE_NONTPA;\n\t\tbp->rx_ring_size = rx_ring_size;\n\t} else if (!bp->rx_ring_size) {\n\t\trx_ring_size = MAX_RX_AVAIL/BNX2X_NUM_RX_QUEUES(bp);\n\n\t\tif (CHIP_IS_E3(bp)) {\n\t\t\tu32 cfg = SHMEM_RD(bp,\n\t\t\t\t\t   dev_info.port_hw_config[BP_PORT(bp)].\n\t\t\t\t\t   default_cfg);\n\n\t\t\t/* Decrease ring size for 1G functions */\n\t\t\tif ((cfg & PORT_HW_CFG_NET_SERDES_IF_MASK) ==\n\t\t\t    PORT_HW_CFG_NET_SERDES_IF_SGMII)\n\t\t\t\trx_ring_size /= 10;\n\t\t}\n\n\t\t/* allocate at least number of buffers required by FW */\n\t\trx_ring_size = max_t(int, bp->disable_tpa ? MIN_RX_SIZE_NONTPA :\n\t\t\t\t     MIN_RX_SIZE_TPA, rx_ring_size);\n\n\t\tbp->rx_ring_size = rx_ring_size;\n\t} else /* if rx_ring_size specified - use it */\n\t\trx_ring_size = bp->rx_ring_size;\n\n\tDP(BNX2X_MSG_SP, \"calculated rx_ring_size %d\\n\", rx_ring_size);\n\n\t/* Common */\n\tsb = &bnx2x_fp(bp, index, status_blk);\n\n\tif (!IS_FCOE_IDX(index)) {\n\t\t/* status blocks */\n\t\tif (!CHIP_IS_E1x(bp)) {\n\t\t\tsb->e2_sb = BNX2X_PCI_ALLOC(&bnx2x_fp(bp, index, status_blk_mapping),\n\t\t\t\t\t\t    sizeof(struct host_hc_status_block_e2));\n\t\t\tif (!sb->e2_sb)\n\t\t\t\tgoto alloc_mem_err;\n\t\t} else {\n\t\t\tsb->e1x_sb = BNX2X_PCI_ALLOC(&bnx2x_fp(bp, index, status_blk_mapping),\n\t\t\t\t\t\t     sizeof(struct host_hc_status_block_e1x));\n\t\t\tif (!sb->e1x_sb)\n\t\t\t\tgoto alloc_mem_err;\n\t\t}\n\t}\n\n\t/* FCoE Queue uses Default SB and doesn't ACK the SB, thus no need to\n\t * set shortcuts for it.\n\t */\n\tif (!IS_FCOE_IDX(index))\n\t\tset_sb_shortcuts(bp, index);\n\n\t/* Tx */\n\tif (!skip_tx_queue(bp, index)) {\n\t\t/* fastpath tx rings: tx_buf tx_desc */\n\t\tfor_each_cos_in_tx_queue(fp, cos) {\n\t\t\tstruct bnx2x_fp_txdata *txdata = fp->txdata_ptr[cos];\n\n\t\t\tDP(NETIF_MSG_IFUP,\n\t\t\t   \"allocating tx memory of fp %d cos %d\\n\",\n\t\t\t   index, cos);\n\n\t\t\ttxdata->tx_buf_ring = kcalloc(NUM_TX_BD,\n\t\t\t\t\t\t      sizeof(struct sw_tx_bd),\n\t\t\t\t\t\t      GFP_KERNEL);\n\t\t\tif (!txdata->tx_buf_ring)\n\t\t\t\tgoto alloc_mem_err;\n\t\t\ttxdata->tx_desc_ring = BNX2X_PCI_ALLOC(&txdata->tx_desc_mapping,\n\t\t\t\t\t\t\t       sizeof(union eth_tx_bd_types) * NUM_TX_BD);\n\t\t\tif (!txdata->tx_desc_ring)\n\t\t\t\tgoto alloc_mem_err;\n\t\t}\n\t}\n\n\t/* Rx */\n\tif (!skip_rx_queue(bp, index)) {\n\t\t/* fastpath rx rings: rx_buf rx_desc rx_comp */\n\t\tbnx2x_fp(bp, index, rx_buf_ring) =\n\t\t\tkcalloc(NUM_RX_BD, sizeof(struct sw_rx_bd), GFP_KERNEL);\n\t\tif (!bnx2x_fp(bp, index, rx_buf_ring))\n\t\t\tgoto alloc_mem_err;\n\t\tbnx2x_fp(bp, index, rx_desc_ring) =\n\t\t\tBNX2X_PCI_ALLOC(&bnx2x_fp(bp, index, rx_desc_mapping),\n\t\t\t\t\tsizeof(struct eth_rx_bd) * NUM_RX_BD);\n\t\tif (!bnx2x_fp(bp, index, rx_desc_ring))\n\t\t\tgoto alloc_mem_err;\n\n\t\t/* Seed all CQEs by 1s */\n\t\tbnx2x_fp(bp, index, rx_comp_ring) =\n\t\t\tBNX2X_PCI_FALLOC(&bnx2x_fp(bp, index, rx_comp_mapping),\n\t\t\t\t\t sizeof(struct eth_fast_path_rx_cqe) * NUM_RCQ_BD);\n\t\tif (!bnx2x_fp(bp, index, rx_comp_ring))\n\t\t\tgoto alloc_mem_err;\n\n\t\t/* SGE ring */\n\t\tbnx2x_fp(bp, index, rx_page_ring) =\n\t\t\tkcalloc(NUM_RX_SGE, sizeof(struct sw_rx_page),\n\t\t\t\tGFP_KERNEL);\n\t\tif (!bnx2x_fp(bp, index, rx_page_ring))\n\t\t\tgoto alloc_mem_err;\n\t\tbnx2x_fp(bp, index, rx_sge_ring) =\n\t\t\tBNX2X_PCI_ALLOC(&bnx2x_fp(bp, index, rx_sge_mapping),\n\t\t\t\t\tBCM_PAGE_SIZE * NUM_RX_SGE_PAGES);\n\t\tif (!bnx2x_fp(bp, index, rx_sge_ring))\n\t\t\tgoto alloc_mem_err;\n\t\t/* RX BD ring */\n\t\tbnx2x_set_next_page_rx_bd(fp);\n\n\t\t/* CQ ring */\n\t\tbnx2x_set_next_page_rx_cq(fp);\n\n\t\t/* BDs */\n\t\tring_size = bnx2x_alloc_rx_bds(fp, rx_ring_size);\n\t\tif (ring_size < rx_ring_size)\n\t\t\tgoto alloc_mem_err;\n\t}\n\n\treturn 0;\n\n/* handles low memory cases */\nalloc_mem_err:\n\tBNX2X_ERR(\"Unable to allocate full memory for queue %d (size %d)\\n\",\n\t\t\t\t\t\tindex, ring_size);\n\t/* FW will drop all packets if queue is not big enough,\n\t * In these cases we disable the queue\n\t * Min size is different for OOO, TPA and non-TPA queues\n\t */\n\tif (ring_size < (fp->mode == TPA_MODE_DISABLED ?\n\t\t\t\tMIN_RX_SIZE_NONTPA : MIN_RX_SIZE_TPA)) {\n\t\t\t/* release memory allocated for this queue */\n\t\t\tbnx2x_free_fp_mem_at(bp, index);\n\t\t\treturn -ENOMEM;\n\t}\n\treturn 0;\n}\n\nstatic int bnx2x_alloc_fp_mem_cnic(struct bnx2x *bp)\n{\n\tif (!NO_FCOE(bp))\n\t\t/* FCoE */\n\t\tif (bnx2x_alloc_fp_mem_at(bp, FCOE_IDX(bp)))\n\t\t\t/* we will fail load process instead of mark\n\t\t\t * NO_FCOE_FLAG\n\t\t\t */\n\t\t\treturn -ENOMEM;\n\n\treturn 0;\n}\n\nstatic int bnx2x_alloc_fp_mem(struct bnx2x *bp)\n{\n\tint i;\n\n\t/* 1. Allocate FP for leading - fatal if error\n\t * 2. Allocate RSS - fix number of queues if error\n\t */\n\n\t/* leading */\n\tif (bnx2x_alloc_fp_mem_at(bp, 0))\n\t\treturn -ENOMEM;\n\n\t/* RSS */\n\tfor_each_nondefault_eth_queue(bp, i)\n\t\tif (bnx2x_alloc_fp_mem_at(bp, i))\n\t\t\tbreak;\n\n\t/* handle memory failures */\n\tif (i != BNX2X_NUM_ETH_QUEUES(bp)) {\n\t\tint delta = BNX2X_NUM_ETH_QUEUES(bp) - i;\n\n\t\tWARN_ON(delta < 0);\n\t\tbnx2x_shrink_eth_fp(bp, delta);\n\t\tif (CNIC_SUPPORT(bp))\n\t\t\t/* move non eth FPs next to last eth FP\n\t\t\t * must be done in that order\n\t\t\t * FCOE_IDX < FWD_IDX < OOO_IDX\n\t\t\t */\n\n\t\t\t/* move FCoE fp even NO_FCOE_FLAG is on */\n\t\t\tbnx2x_move_fp(bp, FCOE_IDX(bp), FCOE_IDX(bp) - delta);\n\t\tbp->num_ethernet_queues -= delta;\n\t\tbp->num_queues = bp->num_ethernet_queues +\n\t\t\t\t bp->num_cnic_queues;\n\t\tBNX2X_ERR(\"Adjusted num of queues from %d to %d\\n\",\n\t\t\t  bp->num_queues + delta, bp->num_queues);\n\t}\n\n\treturn 0;\n}\n\nvoid bnx2x_free_mem_bp(struct bnx2x *bp)\n{\n\tint i;\n\n\tfor (i = 0; i < bp->fp_array_size; i++)\n\t\tkfree(bp->fp[i].tpa_info);\n\tkfree(bp->fp);\n\tkfree(bp->sp_objs);\n\tkfree(bp->fp_stats);\n\tkfree(bp->bnx2x_txq);\n\tkfree(bp->msix_table);\n\tkfree(bp->ilt);\n}\n\nint bnx2x_alloc_mem_bp(struct bnx2x *bp)\n{\n\tstruct bnx2x_fastpath *fp;\n\tstruct msix_entry *tbl;\n\tstruct bnx2x_ilt *ilt;\n\tint msix_table_size = 0;\n\tint fp_array_size, txq_array_size;\n\tint i;\n\n\t/*\n\t * The biggest MSI-X table we might need is as a maximum number of fast\n\t * path IGU SBs plus default SB (for PF only).\n\t */\n\tmsix_table_size = bp->igu_sb_cnt;\n\tif (IS_PF(bp))\n\t\tmsix_table_size++;\n\tBNX2X_DEV_INFO(\"msix_table_size %d\\n\", msix_table_size);\n\n\t/* fp array: RSS plus CNIC related L2 queues */\n\tfp_array_size = BNX2X_MAX_RSS_COUNT(bp) + CNIC_SUPPORT(bp);\n\tbp->fp_array_size = fp_array_size;\n\tBNX2X_DEV_INFO(\"fp_array_size %d\\n\", bp->fp_array_size);\n\n\tfp = kcalloc(bp->fp_array_size, sizeof(*fp), GFP_KERNEL);\n\tif (!fp)\n\t\tgoto alloc_err;\n\tfor (i = 0; i < bp->fp_array_size; i++) {\n\t\tfp[i].tpa_info =\n\t\t\tkcalloc(ETH_MAX_AGGREGATION_QUEUES_E1H_E2,\n\t\t\t\tsizeof(struct bnx2x_agg_info), GFP_KERNEL);\n\t\tif (!(fp[i].tpa_info))\n\t\t\tgoto alloc_err;\n\t}\n\n\tbp->fp = fp;\n\n\t/* allocate sp objs */\n\tbp->sp_objs = kcalloc(bp->fp_array_size, sizeof(struct bnx2x_sp_objs),\n\t\t\t      GFP_KERNEL);\n\tif (!bp->sp_objs)\n\t\tgoto alloc_err;\n\n\t/* allocate fp_stats */\n\tbp->fp_stats = kcalloc(bp->fp_array_size, sizeof(struct bnx2x_fp_stats),\n\t\t\t       GFP_KERNEL);\n\tif (!bp->fp_stats)\n\t\tgoto alloc_err;\n\n\t/* Allocate memory for the transmission queues array */\n\ttxq_array_size =\n\t\tBNX2X_MAX_RSS_COUNT(bp) * BNX2X_MULTI_TX_COS + CNIC_SUPPORT(bp);\n\tBNX2X_DEV_INFO(\"txq_array_size %d\", txq_array_size);\n\n\tbp->bnx2x_txq = kcalloc(txq_array_size, sizeof(struct bnx2x_fp_txdata),\n\t\t\t\tGFP_KERNEL);\n\tif (!bp->bnx2x_txq)\n\t\tgoto alloc_err;\n\n\t/* msix table */\n\ttbl = kcalloc(msix_table_size, sizeof(*tbl), GFP_KERNEL);\n\tif (!tbl)\n\t\tgoto alloc_err;\n\tbp->msix_table = tbl;\n\n\t/* ilt */\n\tilt = kzalloc(sizeof(*ilt), GFP_KERNEL);\n\tif (!ilt)\n\t\tgoto alloc_err;\n\tbp->ilt = ilt;\n\n\treturn 0;\nalloc_err:\n\tbnx2x_free_mem_bp(bp);\n\treturn -ENOMEM;\n}\n\nint bnx2x_reload_if_running(struct net_device *dev)\n{\n\tstruct bnx2x *bp = netdev_priv(dev);\n\n\tif (unlikely(!netif_running(dev)))\n\t\treturn 0;\n\n\tbnx2x_nic_unload(bp, UNLOAD_NORMAL, true);\n\treturn bnx2x_nic_load(bp, LOAD_NORMAL);\n}\n\nint bnx2x_get_cur_phy_idx(struct bnx2x *bp)\n{\n\tu32 sel_phy_idx = 0;\n\tif (bp->link_params.num_phys <= 1)\n\t\treturn INT_PHY;\n\n\tif (bp->link_vars.link_up) {\n\t\tsel_phy_idx = EXT_PHY1;\n\t\t/* In case link is SERDES, check if the EXT_PHY2 is the one */\n\t\tif ((bp->link_vars.link_status & LINK_STATUS_SERDES_LINK) &&\n\t\t    (bp->link_params.phy[EXT_PHY2].supported & SUPPORTED_FIBRE))\n\t\t\tsel_phy_idx = EXT_PHY2;\n\t} else {\n\n\t\tswitch (bnx2x_phy_selection(&bp->link_params)) {\n\t\tcase PORT_HW_CFG_PHY_SELECTION_HARDWARE_DEFAULT:\n\t\tcase PORT_HW_CFG_PHY_SELECTION_FIRST_PHY:\n\t\tcase PORT_HW_CFG_PHY_SELECTION_FIRST_PHY_PRIORITY:\n\t\t       sel_phy_idx = EXT_PHY1;\n\t\t       break;\n\t\tcase PORT_HW_CFG_PHY_SELECTION_SECOND_PHY:\n\t\tcase PORT_HW_CFG_PHY_SELECTION_SECOND_PHY_PRIORITY:\n\t\t       sel_phy_idx = EXT_PHY2;\n\t\t       break;\n\t\t}\n\t}\n\n\treturn sel_phy_idx;\n}\nint bnx2x_get_link_cfg_idx(struct bnx2x *bp)\n{\n\tu32 sel_phy_idx = bnx2x_get_cur_phy_idx(bp);\n\t/*\n\t * The selected activated PHY is always after swapping (in case PHY\n\t * swapping is enabled). So when swapping is enabled, we need to reverse\n\t * the configuration\n\t */\n\n\tif (bp->link_params.multi_phy_config &\n\t    PORT_HW_CFG_PHY_SWAPPED_ENABLED) {\n\t\tif (sel_phy_idx == EXT_PHY1)\n\t\t\tsel_phy_idx = EXT_PHY2;\n\t\telse if (sel_phy_idx == EXT_PHY2)\n\t\t\tsel_phy_idx = EXT_PHY1;\n\t}\n\treturn LINK_CONFIG_IDX(sel_phy_idx);\n}\n\n#ifdef NETDEV_FCOE_WWNN\nint bnx2x_fcoe_get_wwn(struct net_device *dev, u64 *wwn, int type)\n{\n\tstruct bnx2x *bp = netdev_priv(dev);\n\tstruct cnic_eth_dev *cp = &bp->cnic_eth_dev;\n\n\tswitch (type) {\n\tcase NETDEV_FCOE_WWNN:\n\t\t*wwn = HILO_U64(cp->fcoe_wwn_node_name_hi,\n\t\t\t\tcp->fcoe_wwn_node_name_lo);\n\t\tbreak;\n\tcase NETDEV_FCOE_WWPN:\n\t\t*wwn = HILO_U64(cp->fcoe_wwn_port_name_hi,\n\t\t\t\tcp->fcoe_wwn_port_name_lo);\n\t\tbreak;\n\tdefault:\n\t\tBNX2X_ERR(\"Wrong WWN type requested - %d\\n\", type);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n#endif\n\n/* called with rtnl_lock */\nint bnx2x_change_mtu(struct net_device *dev, int new_mtu)\n{\n\tstruct bnx2x *bp = netdev_priv(dev);\n\n\tif (pci_num_vf(bp->pdev)) {\n\t\tDP(BNX2X_MSG_IOV, \"VFs are enabled, can not change MTU\\n\");\n\t\treturn -EPERM;\n\t}\n\n\tif (bp->recovery_state != BNX2X_RECOVERY_DONE) {\n\t\tBNX2X_ERR(\"Can't perform change MTU during parity recovery\\n\");\n\t\treturn -EAGAIN;\n\t}\n\n\t/* This does not race with packet allocation\n\t * because the actual alloc size is\n\t * only updated as part of load\n\t */\n\tdev->mtu = new_mtu;\n\n\tif (!bnx2x_mtu_allows_gro(new_mtu))\n\t\tdev->features &= ~NETIF_F_GRO_HW;\n\n\tif (IS_PF(bp) && SHMEM2_HAS(bp, curr_cfg))\n\t\tSHMEM2_WR(bp, curr_cfg, CURR_CFG_MET_OS);\n\n\treturn bnx2x_reload_if_running(dev);\n}\n\nnetdev_features_t bnx2x_fix_features(struct net_device *dev,\n\t\t\t\t     netdev_features_t features)\n{\n\tstruct bnx2x *bp = netdev_priv(dev);\n\n\tif (pci_num_vf(bp->pdev)) {\n\t\tnetdev_features_t changed = dev->features ^ features;\n\n\t\t/* Revert the requested changes in features if they\n\t\t * would require internal reload of PF in bnx2x_set_features().\n\t\t */\n\t\tif (!(features & NETIF_F_RXCSUM) && !bp->disable_tpa) {\n\t\t\tfeatures &= ~NETIF_F_RXCSUM;\n\t\t\tfeatures |= dev->features & NETIF_F_RXCSUM;\n\t\t}\n\n\t\tif (changed & NETIF_F_LOOPBACK) {\n\t\t\tfeatures &= ~NETIF_F_LOOPBACK;\n\t\t\tfeatures |= dev->features & NETIF_F_LOOPBACK;\n\t\t}\n\t}\n\n\t/* TPA requires Rx CSUM offloading */\n\tif (!(features & NETIF_F_RXCSUM))\n\t\tfeatures &= ~NETIF_F_LRO;\n\n\tif (!(features & NETIF_F_GRO) || !bnx2x_mtu_allows_gro(dev->mtu))\n\t\tfeatures &= ~NETIF_F_GRO_HW;\n\tif (features & NETIF_F_GRO_HW)\n\t\tfeatures &= ~NETIF_F_LRO;\n\n\treturn features;\n}\n\nint bnx2x_set_features(struct net_device *dev, netdev_features_t features)\n{\n\tstruct bnx2x *bp = netdev_priv(dev);\n\tnetdev_features_t changes = features ^ dev->features;\n\tbool bnx2x_reload = false;\n\tint rc;\n\n\t/* VFs or non SRIOV PFs should be able to change loopback feature */\n\tif (!pci_num_vf(bp->pdev)) {\n\t\tif (features & NETIF_F_LOOPBACK) {\n\t\t\tif (bp->link_params.loopback_mode != LOOPBACK_BMAC) {\n\t\t\t\tbp->link_params.loopback_mode = LOOPBACK_BMAC;\n\t\t\t\tbnx2x_reload = true;\n\t\t\t}\n\t\t} else {\n\t\t\tif (bp->link_params.loopback_mode != LOOPBACK_NONE) {\n\t\t\t\tbp->link_params.loopback_mode = LOOPBACK_NONE;\n\t\t\t\tbnx2x_reload = true;\n\t\t\t}\n\t\t}\n\t}\n\n\t/* Don't care about GRO changes */\n\tchanges &= ~NETIF_F_GRO;\n\n\tif (changes)\n\t\tbnx2x_reload = true;\n\n\tif (bnx2x_reload) {\n\t\tif (bp->recovery_state == BNX2X_RECOVERY_DONE) {\n\t\t\tdev->features = features;\n\t\t\trc = bnx2x_reload_if_running(dev);\n\t\t\treturn rc ? rc : 1;\n\t\t}\n\t\t/* else: bnx2x_nic_load() will be called at end of recovery */\n\t}\n\n\treturn 0;\n}\n\nvoid bnx2x_tx_timeout(struct net_device *dev, unsigned int txqueue)\n{\n\tstruct bnx2x *bp = netdev_priv(dev);\n\n\t/* We want the information of the dump logged,\n\t * but calling bnx2x_panic() would kill all chances of recovery.\n\t */\n\tif (!bp->panic)\n#ifndef BNX2X_STOP_ON_ERROR\n\t\tbnx2x_panic_dump(bp, false);\n#else\n\t\tbnx2x_panic();\n#endif\n\n\t/* This allows the netif to be shutdown gracefully before resetting */\n\tbnx2x_schedule_sp_rtnl(bp, BNX2X_SP_RTNL_TX_TIMEOUT, 0);\n}\n\nstatic int __maybe_unused bnx2x_suspend(struct device *dev_d)\n{\n\tstruct pci_dev *pdev = to_pci_dev(dev_d);\n\tstruct net_device *dev = pci_get_drvdata(pdev);\n\tstruct bnx2x *bp;\n\n\tif (!dev) {\n\t\tdev_err(&pdev->dev, \"BAD net device from bnx2x_init_one\\n\");\n\t\treturn -ENODEV;\n\t}\n\tbp = netdev_priv(dev);\n\n\trtnl_lock();\n\n\tif (!netif_running(dev)) {\n\t\trtnl_unlock();\n\t\treturn 0;\n\t}\n\n\tnetif_device_detach(dev);\n\n\tbnx2x_nic_unload(bp, UNLOAD_CLOSE, false);\n\n\trtnl_unlock();\n\n\treturn 0;\n}\n\nstatic int __maybe_unused bnx2x_resume(struct device *dev_d)\n{\n\tstruct pci_dev *pdev = to_pci_dev(dev_d);\n\tstruct net_device *dev = pci_get_drvdata(pdev);\n\tstruct bnx2x *bp;\n\tint rc;\n\n\tif (!dev) {\n\t\tdev_err(&pdev->dev, \"BAD net device from bnx2x_init_one\\n\");\n\t\treturn -ENODEV;\n\t}\n\tbp = netdev_priv(dev);\n\n\tif (bp->recovery_state != BNX2X_RECOVERY_DONE) {\n\t\tBNX2X_ERR(\"Handling parity error recovery. Try again later\\n\");\n\t\treturn -EAGAIN;\n\t}\n\n\trtnl_lock();\n\n\tif (!netif_running(dev)) {\n\t\trtnl_unlock();\n\t\treturn 0;\n\t}\n\n\tnetif_device_attach(dev);\n\n\trc = bnx2x_nic_load(bp, LOAD_OPEN);\n\n\trtnl_unlock();\n\n\treturn rc;\n}\n\nSIMPLE_DEV_PM_OPS(bnx2x_pm_ops, bnx2x_suspend, bnx2x_resume);\n\nvoid bnx2x_set_ctx_validation(struct bnx2x *bp, struct eth_context *cxt,\n\t\t\t      u32 cid)\n{\n\tif (!cxt) {\n\t\tBNX2X_ERR(\"bad context pointer %p\\n\", cxt);\n\t\treturn;\n\t}\n\n\t/* ustorm cxt validation */\n\tcxt->ustorm_ag_context.cdu_usage =\n\t\tCDU_RSRVD_VALUE_TYPE_A(HW_CID(bp, cid),\n\t\t\tCDU_REGION_NUMBER_UCM_AG, ETH_CONNECTION_TYPE);\n\t/* xcontext validation */\n\tcxt->xstorm_ag_context.cdu_reserved =\n\t\tCDU_RSRVD_VALUE_TYPE_A(HW_CID(bp, cid),\n\t\t\tCDU_REGION_NUMBER_XCM_AG, ETH_CONNECTION_TYPE);\n}\n\nstatic void storm_memset_hc_timeout(struct bnx2x *bp, u8 port,\n\t\t\t\t    u8 fw_sb_id, u8 sb_index,\n\t\t\t\t    u8 ticks)\n{\n\tu32 addr = BAR_CSTRORM_INTMEM +\n\t\t   CSTORM_STATUS_BLOCK_DATA_TIMEOUT_OFFSET(fw_sb_id, sb_index);\n\tREG_WR8(bp, addr, ticks);\n\tDP(NETIF_MSG_IFUP,\n\t   \"port %x fw_sb_id %d sb_index %d ticks %d\\n\",\n\t   port, fw_sb_id, sb_index, ticks);\n}\n\nstatic void storm_memset_hc_disable(struct bnx2x *bp, u8 port,\n\t\t\t\t    u16 fw_sb_id, u8 sb_index,\n\t\t\t\t    u8 disable)\n{\n\tu32 enable_flag = disable ? 0 : (1 << HC_INDEX_DATA_HC_ENABLED_SHIFT);\n\tu32 addr = BAR_CSTRORM_INTMEM +\n\t\t   CSTORM_STATUS_BLOCK_DATA_FLAGS_OFFSET(fw_sb_id, sb_index);\n\tu8 flags = REG_RD8(bp, addr);\n\t/* clear and set */\n\tflags &= ~HC_INDEX_DATA_HC_ENABLED;\n\tflags |= enable_flag;\n\tREG_WR8(bp, addr, flags);\n\tDP(NETIF_MSG_IFUP,\n\t   \"port %x fw_sb_id %d sb_index %d disable %d\\n\",\n\t   port, fw_sb_id, sb_index, disable);\n}\n\nvoid bnx2x_update_coalesce_sb_index(struct bnx2x *bp, u8 fw_sb_id,\n\t\t\t\t    u8 sb_index, u8 disable, u16 usec)\n{\n\tint port = BP_PORT(bp);\n\tu8 ticks = usec / BNX2X_BTR;\n\n\tstorm_memset_hc_timeout(bp, port, fw_sb_id, sb_index, ticks);\n\n\tdisable = disable ? 1 : (usec ? 0 : 1);\n\tstorm_memset_hc_disable(bp, port, fw_sb_id, sb_index, disable);\n}\n\nvoid bnx2x_schedule_sp_rtnl(struct bnx2x *bp, enum sp_rtnl_flag flag,\n\t\t\t    u32 verbose)\n{\n\tsmp_mb__before_atomic();\n\tset_bit(flag, &bp->sp_rtnl_state);\n\tsmp_mb__after_atomic();\n\tDP((BNX2X_MSG_SP | verbose), \"Scheduling sp_rtnl task [Flag: %d]\\n\",\n\t   flag);\n\tschedule_delayed_work(&bp->sp_rtnl_task, 0);\n}\n"}}, "reports": [{"events": [{"location": {"col": 0, "file": 0, "line": 1787}, "message": "warn: potential spectre issue 'bp->msix_table' [w]"}], "macros": [], "notes": [], "path": "/src/drivers/net/ethernet/broadcom/bnx2x/bnx2x_cmn.c", "reportHash": "c1eef8e6c54cae71cd23b4f5e612ba9d", "checkerName": "smatch.check_spectre", "reviewStatus": null, "severity": "UNSPECIFIED"}, {"events": [{"location": {"col": 0, "file": 0, "line": 2485}, "message": "warn: potential spectre issue 'bp->bnx2x_txq' [r]"}], "macros": [], "notes": [], "path": "/src/drivers/net/ethernet/broadcom/bnx2x/bnx2x_cmn.c", "reportHash": "4b38e5f02a881c265705df1f570c4f9a", "checkerName": "smatch.check_spectre", "reviewStatus": null, "severity": "UNSPECIFIED"}, {"events": [{"location": {"col": 0, "file": 0, "line": 2923}, "message": "parse error: turning off implications after 60 seconds"}], "macros": [], "notes": [], "path": "/src/drivers/net/ethernet/broadcom/bnx2x/bnx2x_cmn.c", "reportHash": "e1db47ac8ffdbb7835d539d31ebf08da", "checkerName": "smatch.smatch_implied", "reviewStatus": null, "severity": "UNSPECIFIED"}, {"events": [{"location": {"col": 0, "file": 0, "line": 4351}, "message": "warn: potential spectre issue 'bp->fp' [r]"}], "macros": [], "notes": [], "path": "/src/drivers/net/ethernet/broadcom/bnx2x/bnx2x_cmn.c", "reportHash": "3c510e1a4121cdf4dab0f53f2db28245", "checkerName": "smatch.check_spectre", "reviewStatus": null, "severity": "UNSPECIFIED"}, {"events": [{"location": {"col": 0, "file": 0, "line": 4431}, "message": "warn: potential spectre issue 'bp->fp' [r]"}], "macros": [], "notes": [], "path": "/src/drivers/net/ethernet/broadcom/bnx2x/bnx2x_cmn.c", "reportHash": "52c24102946d6f40e25333088e9c4789", "checkerName": "smatch.check_spectre", "reviewStatus": null, "severity": "UNSPECIFIED"}, {"events": [{"location": {"col": 0, "file": 0, "line": 4504}, "message": "warn: potential spectre issue 'bp->fp' [r]"}], "macros": [], "notes": [], "path": "/src/drivers/net/ethernet/broadcom/bnx2x/bnx2x_cmn.c", "reportHash": "f1143e1b692e1843e59ebc5a5e836583", "checkerName": "smatch.check_spectre", "reviewStatus": null, "severity": "UNSPECIFIED"}, {"events": [{"location": {"col": 0, "file": 0, "line": 89}, "message": "warn: potential spectre issue 'bp->fp' [r]"}], "macros": [], "notes": [], "path": "/src/drivers/net/ethernet/broadcom/bnx2x/bnx2x_cmn.c", "reportHash": "7b373be35232d0a4a18cecbe0fc680b4", "checkerName": "smatch.check_spectre", "reviewStatus": null, "severity": "UNSPECIFIED"}, {"events": [{"location": {"col": 0, "file": 0, "line": 91}, "message": "warn: potential spectre issue 'bp->sp_objs' [r]"}], "macros": [], "notes": [], "path": "/src/drivers/net/ethernet/broadcom/bnx2x/bnx2x_cmn.c", "reportHash": "fb87b3faf6cbdd59f66fc3108df47ad7", "checkerName": "smatch.check_spectre", "reviewStatus": null, "severity": "UNSPECIFIED"}, {"events": [{"location": {"col": 0, "file": 0, "line": 93}, "message": "warn: potential spectre issue 'bp->fp_stats' [r]"}], "macros": [], "notes": [], "path": "/src/drivers/net/ethernet/broadcom/bnx2x/bnx2x_cmn.c", "reportHash": "896138cb701e74202977af17895dd18a", "checkerName": "smatch.check_spectre", "reviewStatus": null, "severity": "UNSPECIFIED"}, {"events": [{"location": {"col": 0, "file": 0, "line": 130}, "message": "warn: potential spectre issue 'bp->bnx2x_txq' [w]"}], "macros": [], "notes": [], "path": "/src/drivers/net/ethernet/broadcom/bnx2x/bnx2x_cmn.c", "reportHash": "9bacc6c6c8a83cf5ac6ddb223bd16d86", "checkerName": "smatch.check_spectre", "reviewStatus": null, "severity": "UNSPECIFIED"}]};
      window.onload = function() {
        if (!browserCompatible) {
          setNonCompatibleBrowserMessage();
        } else {
          BugViewer.init(data.files, data.reports);
          BugViewer.create();
          BugViewer.initByUrl();
        }
      };
    </script>
  </head>
  <body>
  <div class="container">
    <div id="content">
      <div id="side-bar">
        <div class="header">
          <a href="index.html" class="button">&#8249; Return to List</a>
        </div>
        <div id="report-nav">
          <div class="header">Reports</div>
        </div>
      </div>
      <div id="editor-wrapper">
        <div class="header">
          <div id="file">
            <span class="label">File:</span>
            <span id="file-path"></span>
          </div>
          <div id="checker">
            <span class="label">Checker name:</span>
            <span id="checker-name"></span>
          </div>
          <div id="review-status-wrapper">
            <span class="label">Review status:</span>
            <span id="review-status"></span>
          </div>
        </div>
        <div id="editor"></div>
      </div>
    </div>
  </div>
  </body>
</html>
